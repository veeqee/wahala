(function(e,g){function q(a){return(a=g.nameValue("FD."+a+".Metrics"))&&a.provider?a:null}function r(a,b,c){var d=this;return a.toString().replace(/{\(([.,a-zA-Z0-9_: \$]*)\)}/gm,function(a,e){a=e.split(",");e=t.call(d,b,a[0],c);return null!==e?(a[1]||"")+e+(a[2]||""):""})}function t(a,b,c){do{if(a){var d=g.nameValue(b,a,"_");if("undefined"!==typeof d)break}d=c.variables[b];if(!d){if(this.provider&&(d=this.provider(b),"undefined"!==typeof d))break;d=null}}while(0);null!==d&&(d=r.call(this,d,a,c));
return d}function u(a,b,c){var d={};c=a&&a.id&&this.plan.actions[a.id]||a.actionItem;var e=this;b&&(b.jquery||b instanceof Element)&&(b=m(b));c&&c.variables?g.objectForEach(c.variables,function(c,g){!0===c&&(c=t.call(e,b,g,a));if(null!==c){var f=g.split("_");2===f.length?(d[f[0]]||(d[f[0]]={}),d[f[0]][f[1]]=r.call(e,c,b,a)):console.log("[metrics.retrieveData] Invalid variable name "+g)}}):console.log("[metrics.retrieveData] Invalid action id "+(a&&a.id));w(c,d);return d}function x(){try{e._satellite&&
this.enabled?(e._satellite.pageBottom(),console.log("[metrics.firePageBottom] -\x3e page bottom fired")):console.log("** DTM CALL DISABLED ** [metrics.firePageBottom]")}catch(a){console.log("[metrics.firePageBottom] uncaught exception",a)}}function y(a,b){try{var c,d=a;"string"===typeof d&&(d=JSON.parse(d));var f=(c=d||null)&&this.plan.actions[c.id];if(f&&f.direct){d=!0;var h=c&&c.id&&this.plan.actions[c.id];switch(h&&h.filter){case "oncePerPage":d=!v[c.id];v[c.id]=!0;break;case "oncePerSession":var k=
"fd-metrics-trigger-"+c.id;d=!e.sessionStorage.getItem(k);e.sessionStorage.setItem(k,!0)}if(d)if(e._satellite&&this.enabled){var l=this.data(c,b);e.digitaldata=l;e._satellite.track(f.direct);console.log("[metrics.fireDirect] -\x3e "+f.direct,g.assign(!0,{},b),c)}else console.log("** DTM CALL DISABLED ** [metrics.fireDirect] -\x3e "+f.direct,g.assign(!0,{},b),c)}else console.log("[metrics.fireDirect] invalid action",c,f)}catch(z){console.log("[metrics.fireDirect] uncaught exception",z,a,b)}}function m(a){a=
f&&f(a);if(!a||0===a.length)return{};var b=null,c=a.attr("data-fd-metrics-data");if(c)try{b=JSON.parse(c)}catch(d){}return g.assign(m(a.parent().closest("[data-fd-metrics-data]")),b||{})}function A(){try{var a=f&&f(this).attr("data-fd-metrics-click");if(a){var b=JSON.parse(a),c=l[b.app];c?c.direct(b,this):console.log("[metrics.processMetricsClick] handler not found for "+b.app)}}catch(d){console.log("[metrics.processMetricsClick] uncaught exception",d)}}function w(a,b){if(f&&h&&!h.closed){if(a){var c=
f("\x3cdiv\x3e\x3c/div\x3e").css({backgroundColor:n?"#ccccff":"#eeeeff"}).append(f("\x3ch1\x3e\x3c/h1\x3e").text("["+(a.direct?"direct":"page")+"] "+(a.name||"")));b&&g.objectForEach(b,function(a,b){var d=!1,e=f("\x3cdl\x3e\x3c/dl\x3e");a&&g.objectForEach(a,function(a,b){e.append(f("\x3cdt\x3e\x3c/dt\x3e").text(b)).append(f("\x3cdd\x3e\x3c/dd\x3e").text(a));d=!0});d&&(c.append(f("\x3ch2\x3e\x3c/h2\x3e").text(b)),c.append(e))});h.addAction(c.get(0));h.focus();n=!n}}else h=null}if(!g.nameValue("FD.Common.Metrics.register")){var B=
g.namespace("FD.Common.Metrics"),l={},v={},p=null,h=null,n=!1,k=null,f=null;g.assign(B,{register:function(a){var b=l[a.app];if(!b){var c=q(a.app);if(!c){console.log("[metrics.registerPlan] Metrics provider missing for app "+a.app);return}b=l[a.app]={plan:a,provider:c.provider,enabled:!!e._satellite};g.assign(b,{data:u.bind(b),page:x.bind(b),direct:y.bind(b),enable:function(){b.enabled=!!e._satellite},disable:function(){b.enabled=!1}});c.handler=b;p||(p=b);k=a.handler=b;console.log("[metrics.registerPlan] Plan registered for app "+
a.app,a)}return b},initializePage:function(a){try{var b=q(a&&a.app);b?(e.digitaldata=u.call({plan:{action:{}},provider:b.provider},a),console.log("[metrics.initPage] data set -\x3e",e.digitaldata,a)):console.log("[metrics.initPage] app provider not found")}catch(c){console.log("[metrics.initPage] uncaught exception",c,a)}},plan:function(a){return(a=a?l[a]:p)&&a.plan},disable:function(){k&&k.disable()},enable:function(){k&&k.enable()},debug:function(){if(!h||h.closed)h=e.open("","fdmetricsdebugger",
"height\x3d500,width\x3d500,resizable\x3d1,scrollbars\x3d1,location\x3d0"),h.document.open(),h.document.write('\x3chtml\x3e\x3chead\x3e\x3ctitle\x3eCommon Metrics Debug Window\x3c/title\x3e\x3cstyle\x3ebody { font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif; font-size: 0.8em; margin:0; padding: 0; } h1, h2 { margin: 0 0 .3em 0; } div { padding: 0.8em; } dl { margin: 0 1em; } dt { float: left; width: 12em; font-weight: bold; } dd { margin-left: 12em; }\x3c/style\x3e\x3cscript\x3efunction addAction(action) { document.getElementsByTagName("body")[0].appendChild(action); window.scrollTo(0, document.body.scrollHeight); }\x3c/script\x3e\x3c/head\x3e\x3cbody\x3e\x3c/body\x3e\x3c/html\x3e'),
h.document.close();h.focus()},elementData:m});g.ready(function(){e._satellite||console.log("[metrics.init] DTM library not loaded at init call.");e.jQuery?(f=e.jQuery,f("body").on("click","[data-fd-metrics-click]",A)):console.log("[metrics.init] jQuery library not loaded, document metrics click handling not available")})}})(window,FD.Common);
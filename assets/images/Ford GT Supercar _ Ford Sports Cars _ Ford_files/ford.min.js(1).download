/*! Hammer.JS - v2.0.8 - 2016-04-23
 * http://hammerjs.github.io/
 *
 * Copyright (c) 2016 Jorik Tangelder;
 * Licensed under the MIT license */
!function(a,b,c,d){"use strict";function e(a,b,c){return setTimeout(j(a,c),b)}function f(a,b,c){return Array.isArray(a)?(g(a,c[b],c),!0):!1}function g(a,b,c){var e;if(a)if(a.forEach)a.forEach(b,c);else if(a.length!==d)for(e=0;e<a.length;)b.call(c,a[e],e,a),e++;else for(e in a)a.hasOwnProperty(e)&&b.call(c,a[e],e,a)}function h(b,c,d){var e="DEPRECATED METHOD: "+c+"\n"+d+" AT \n";return function(){var c=new Error("get-stack-trace"),d=c&&c.stack?c.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",f=a.console&&(a.console.warn||a.console.log);return f&&f.call(a.console,e,d),b.apply(this,arguments)}}function i(a,b,c){var d,e=b.prototype;d=a.prototype=Object.create(e),d.constructor=a,d._super=e,c&&la(d,c)}function j(a,b){return function(){return a.apply(b,arguments)}}function k(a,b){return typeof a==oa?a.apply(b?b[0]||d:d,b):a}function l(a,b){return a===d?b:a}function m(a,b,c){g(q(b),function(b){a.addEventListener(b,c,!1)})}function n(a,b,c){g(q(b),function(b){a.removeEventListener(b,c,!1)})}function o(a,b){for(;a;){if(a==b)return!0;a=a.parentNode}return!1}function p(a,b){return a.indexOf(b)>-1}function q(a){return a.trim().split(/\s+/g)}function r(a,b,c){if(a.indexOf&&!c)return a.indexOf(b);for(var d=0;d<a.length;){if(c&&a[d][c]==b||!c&&a[d]===b)return d;d++}return-1}function s(a){return Array.prototype.slice.call(a,0)}function t(a,b,c){for(var d=[],e=[],f=0;f<a.length;){var g=b?a[f][b]:a[f];r(e,g)<0&&d.push(a[f]),e[f]=g,f++}return c&&(d=b?d.sort(function(a,c){return a[b]>c[b]}):d.sort()),d}function u(a,b){for(var c,e,f=b[0].toUpperCase()+b.slice(1),g=0;g<ma.length;){if(c=ma[g],e=c?c+f:b,e in a)return e;g++}return d}function v(){return ua++}function w(b){var c=b.ownerDocument||b;return c.defaultView||c.parentWindow||a}function x(a,b){var c=this;this.manager=a,this.callback=b,this.element=a.element,this.target=a.options.inputTarget,this.domHandler=function(b){k(a.options.enable,[a])&&c.handler(b)},this.init()}function y(a){var b,c=a.options.inputClass;return new(b=c?c:xa?M:ya?P:wa?R:L)(a,z)}function z(a,b,c){var d=c.pointers.length,e=c.changedPointers.length,f=b&Ea&&d-e===0,g=b&(Ga|Ha)&&d-e===0;c.isFirst=!!f,c.isFinal=!!g,f&&(a.session={}),c.eventType=b,A(a,c),a.emit("hammer.input",c),a.recognize(c),a.session.prevInput=c}function A(a,b){var c=a.session,d=b.pointers,e=d.length;c.firstInput||(c.firstInput=D(b)),e>1&&!c.firstMultiple?c.firstMultiple=D(b):1===e&&(c.firstMultiple=!1);var f=c.firstInput,g=c.firstMultiple,h=g?g.center:f.center,i=b.center=E(d);b.timeStamp=ra(),b.deltaTime=b.timeStamp-f.timeStamp,b.angle=I(h,i),b.distance=H(h,i),B(c,b),b.offsetDirection=G(b.deltaX,b.deltaY);var j=F(b.deltaTime,b.deltaX,b.deltaY);b.overallVelocityX=j.x,b.overallVelocityY=j.y,b.overallVelocity=qa(j.x)>qa(j.y)?j.x:j.y,b.scale=g?K(g.pointers,d):1,b.rotation=g?J(g.pointers,d):0,b.maxPointers=c.prevInput?b.pointers.length>c.prevInput.maxPointers?b.pointers.length:c.prevInput.maxPointers:b.pointers.length,C(c,b);var k=a.element;o(b.srcEvent.target,k)&&(k=b.srcEvent.target),b.target=k}function B(a,b){var c=b.center,d=a.offsetDelta||{},e=a.prevDelta||{},f=a.prevInput||{};b.eventType!==Ea&&f.eventType!==Ga||(e=a.prevDelta={x:f.deltaX||0,y:f.deltaY||0},d=a.offsetDelta={x:c.x,y:c.y}),b.deltaX=e.x+(c.x-d.x),b.deltaY=e.y+(c.y-d.y)}function C(a,b){var c,e,f,g,h=a.lastInterval||b,i=b.timeStamp-h.timeStamp;if(b.eventType!=Ha&&(i>Da||h.velocity===d)){var j=b.deltaX-h.deltaX,k=b.deltaY-h.deltaY,l=F(i,j,k);e=l.x,f=l.y,c=qa(l.x)>qa(l.y)?l.x:l.y,g=G(j,k),a.lastInterval=b}else c=h.velocity,e=h.velocityX,f=h.velocityY,g=h.direction;b.velocity=c,b.velocityX=e,b.velocityY=f,b.direction=g}function D(a){for(var b=[],c=0;c<a.pointers.length;)b[c]={clientX:pa(a.pointers[c].clientX),clientY:pa(a.pointers[c].clientY)},c++;return{timeStamp:ra(),pointers:b,center:E(b),deltaX:a.deltaX,deltaY:a.deltaY}}function E(a){var b=a.length;if(1===b)return{x:pa(a[0].clientX),y:pa(a[0].clientY)};for(var c=0,d=0,e=0;b>e;)c+=a[e].clientX,d+=a[e].clientY,e++;return{x:pa(c/b),y:pa(d/b)}}function F(a,b,c){return{x:b/a||0,y:c/a||0}}function G(a,b){return a===b?Ia:qa(a)>=qa(b)?0>a?Ja:Ka:0>b?La:Ma}function H(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return Math.sqrt(d*d+e*e)}function I(a,b,c){c||(c=Qa);var d=b[c[0]]-a[c[0]],e=b[c[1]]-a[c[1]];return 180*Math.atan2(e,d)/Math.PI}function J(a,b){return I(b[1],b[0],Ra)+I(a[1],a[0],Ra)}function K(a,b){return H(b[0],b[1],Ra)/H(a[0],a[1],Ra)}function L(){this.evEl=Ta,this.evWin=Ua,this.pressed=!1,x.apply(this,arguments)}function M(){this.evEl=Xa,this.evWin=Ya,x.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}function N(){this.evTarget=$a,this.evWin=_a,this.started=!1,x.apply(this,arguments)}function O(a,b){var c=s(a.touches),d=s(a.changedTouches);return b&(Ga|Ha)&&(c=t(c.concat(d),"identifier",!0)),[c,d]}function P(){this.evTarget=bb,this.targetIds={},x.apply(this,arguments)}function Q(a,b){var c=s(a.touches),d=this.targetIds;if(b&(Ea|Fa)&&1===c.length)return d[c[0].identifier]=!0,[c,c];var e,f,g=s(a.changedTouches),h=[],i=this.target;if(f=c.filter(function(a){return o(a.target,i)}),b===Ea)for(e=0;e<f.length;)d[f[e].identifier]=!0,e++;for(e=0;e<g.length;)d[g[e].identifier]&&h.push(g[e]),b&(Ga|Ha)&&delete d[g[e].identifier],e++;return h.length?[t(f.concat(h),"identifier",!0),h]:void 0}function R(){x.apply(this,arguments);var a=j(this.handler,this);this.touch=new P(this.manager,a),this.mouse=new L(this.manager,a),this.primaryTouch=null,this.lastTouches=[]}function S(a,b){a&Ea?(this.primaryTouch=b.changedPointers[0].identifier,T.call(this,b)):a&(Ga|Ha)&&T.call(this,b)}function T(a){var b=a.changedPointers[0];if(b.identifier===this.primaryTouch){var c={x:b.clientX,y:b.clientY};this.lastTouches.push(c);var d=this.lastTouches,e=function(){var a=d.indexOf(c);a>-1&&d.splice(a,1)};setTimeout(e,cb)}}function U(a){for(var b=a.srcEvent.clientX,c=a.srcEvent.clientY,d=0;d<this.lastTouches.length;d++){var e=this.lastTouches[d],f=Math.abs(b-e.x),g=Math.abs(c-e.y);if(db>=f&&db>=g)return!0}return!1}function V(a,b){this.manager=a,this.set(b)}function W(a){if(p(a,jb))return jb;var b=p(a,kb),c=p(a,lb);return b&&c?jb:b||c?b?kb:lb:p(a,ib)?ib:hb}function X(){if(!fb)return!1;var b={},c=a.CSS&&a.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach(function(d){b[d]=c?a.CSS.supports("touch-action",d):!0}),b}function Y(a){this.options=la({},this.defaults,a||{}),this.id=v(),this.manager=null,this.options.enable=l(this.options.enable,!0),this.state=nb,this.simultaneous={},this.requireFail=[]}function Z(a){return a&sb?"cancel":a&qb?"end":a&pb?"move":a&ob?"start":""}function $(a){return a==Ma?"down":a==La?"up":a==Ja?"left":a==Ka?"right":""}function _(a,b){var c=b.manager;return c?c.get(a):a}function aa(){Y.apply(this,arguments)}function ba(){aa.apply(this,arguments),this.pX=null,this.pY=null}function ca(){aa.apply(this,arguments)}function da(){Y.apply(this,arguments),this._timer=null,this._input=null}function ea(){aa.apply(this,arguments)}function fa(){aa.apply(this,arguments)}function ga(){Y.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function ha(a,b){return b=b||{},b.recognizers=l(b.recognizers,ha.defaults.preset),new ia(a,b)}function ia(a,b){this.options=la({},ha.defaults,b||{}),this.options.inputTarget=this.options.inputTarget||a,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=a,this.input=y(this),this.touchAction=new V(this,this.options.touchAction),ja(this,!0),g(this.options.recognizers,function(a){var b=this.add(new a[0](a[1]));a[2]&&b.recognizeWith(a[2]),a[3]&&b.requireFailure(a[3])},this)}function ja(a,b){var c=a.element;if(c.style){var d;g(a.options.cssProps,function(e,f){d=u(c.style,f),b?(a.oldCssProps[d]=c.style[d],c.style[d]=e):c.style[d]=a.oldCssProps[d]||""}),b||(a.oldCssProps={})}}function ka(a,c){var d=b.createEvent("Event");d.initEvent(a,!0,!0),d.gesture=c,c.target.dispatchEvent(d)}var la,ma=["","webkit","Moz","MS","ms","o"],na=b.createElement("div"),oa="function",pa=Math.round,qa=Math.abs,ra=Date.now;la="function"!=typeof Object.assign?function(a){if(a===d||null===a)throw new TypeError("Cannot convert undefined or null to object");for(var b=Object(a),c=1;c<arguments.length;c++){var e=arguments[c];if(e!==d&&null!==e)for(var f in e)e.hasOwnProperty(f)&&(b[f]=e[f])}return b}:Object.assign;var sa=h(function(a,b,c){for(var e=Object.keys(b),f=0;f<e.length;)(!c||c&&a[e[f]]===d)&&(a[e[f]]=b[e[f]]),f++;return a},"extend","Use `assign`."),ta=h(function(a,b){return sa(a,b,!0)},"merge","Use `assign`."),ua=1,va=/mobile|tablet|ip(ad|hone|od)|android/i,wa="ontouchstart"in a,xa=u(a,"PointerEvent")!==d,ya=wa&&va.test(navigator.userAgent),za="touch",Aa="pen",Ba="mouse",Ca="kinect",Da=25,Ea=1,Fa=2,Ga=4,Ha=8,Ia=1,Ja=2,Ka=4,La=8,Ma=16,Na=Ja|Ka,Oa=La|Ma,Pa=Na|Oa,Qa=["x","y"],Ra=["clientX","clientY"];x.prototype={handler:function(){},init:function(){this.evEl&&m(this.element,this.evEl,this.domHandler),this.evTarget&&m(this.target,this.evTarget,this.domHandler),this.evWin&&m(w(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&n(this.element,this.evEl,this.domHandler),this.evTarget&&n(this.target,this.evTarget,this.domHandler),this.evWin&&n(w(this.element),this.evWin,this.domHandler)}};var Sa={mousedown:Ea,mousemove:Fa,mouseup:Ga},Ta="mousedown",Ua="mousemove mouseup";i(L,x,{handler:function(a){var b=Sa[a.type];b&Ea&&0===a.button&&(this.pressed=!0),b&Fa&&1!==a.which&&(b=Ga),this.pressed&&(b&Ga&&(this.pressed=!1),this.callback(this.manager,b,{pointers:[a],changedPointers:[a],pointerType:Ba,srcEvent:a}))}});var Va={pointerdown:Ea,pointermove:Fa,pointerup:Ga,pointercancel:Ha,pointerout:Ha},Wa={2:za,3:Aa,4:Ba,5:Ca},Xa="pointerdown",Ya="pointermove pointerup pointercancel";a.MSPointerEvent&&!a.PointerEvent&&(Xa="MSPointerDown",Ya="MSPointerMove MSPointerUp MSPointerCancel"),i(M,x,{handler:function(a){var b=this.store,c=!1,d=a.type.toLowerCase().replace("ms",""),e=Va[d],f=Wa[a.pointerType]||a.pointerType,g=f==za,h=r(b,a.pointerId,"pointerId");e&Ea&&(0===a.button||g)?0>h&&(b.push(a),h=b.length-1):e&(Ga|Ha)&&(c=!0),0>h||(b[h]=a,this.callback(this.manager,e,{pointers:b,changedPointers:[a],pointerType:f,srcEvent:a}),c&&b.splice(h,1))}});var Za={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},$a="touchstart",_a="touchstart touchmove touchend touchcancel";i(N,x,{handler:function(a){var b=Za[a.type];if(b===Ea&&(this.started=!0),this.started){var c=O.call(this,a,b);b&(Ga|Ha)&&c[0].length-c[1].length===0&&(this.started=!1),this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}}});var ab={touchstart:Ea,touchmove:Fa,touchend:Ga,touchcancel:Ha},bb="touchstart touchmove touchend touchcancel";i(P,x,{handler:function(a){var b=ab[a.type],c=Q.call(this,a,b);c&&this.callback(this.manager,b,{pointers:c[0],changedPointers:c[1],pointerType:za,srcEvent:a})}});var cb=2500,db=25;i(R,x,{handler:function(a,b,c){var d=c.pointerType==za,e=c.pointerType==Ba;if(!(e&&c.sourceCapabilities&&c.sourceCapabilities.firesTouchEvents)){if(d)S.call(this,b,c);else if(e&&U.call(this,c))return;this.callback(a,b,c)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var eb=u(na.style,"touchAction"),fb=eb!==d,gb="compute",hb="auto",ib="manipulation",jb="none",kb="pan-x",lb="pan-y",mb=X();V.prototype={set:function(a){a==gb&&(a=this.compute()),fb&&this.manager.element.style&&mb[a]&&(this.manager.element.style[eb]=a),this.actions=a.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var a=[];return g(this.manager.recognizers,function(b){k(b.options.enable,[b])&&(a=a.concat(b.getTouchAction()))}),W(a.join(" "))},preventDefaults:function(a){var b=a.srcEvent,c=a.offsetDirection;if(this.manager.session.prevented)return void b.preventDefault();var d=this.actions,e=p(d,jb)&&!mb[jb],f=p(d,lb)&&!mb[lb],g=p(d,kb)&&!mb[kb];if(e){var h=1===a.pointers.length,i=a.distance<2,j=a.deltaTime<250;if(h&&i&&j)return}return g&&f?void 0:e||f&&c&Na||g&&c&Oa?this.preventSrc(b):void 0},preventSrc:function(a){this.manager.session.prevented=!0,a.preventDefault()}};var nb=1,ob=2,pb=4,qb=8,rb=qb,sb=16,tb=32;Y.prototype={defaults:{},set:function(a){return la(this.options,a),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(a){if(f(a,"recognizeWith",this))return this;var b=this.simultaneous;return a=_(a,this),b[a.id]||(b[a.id]=a,a.recognizeWith(this)),this},dropRecognizeWith:function(a){return f(a,"dropRecognizeWith",this)?this:(a=_(a,this),delete this.simultaneous[a.id],this)},requireFailure:function(a){if(f(a,"requireFailure",this))return this;var b=this.requireFail;return a=_(a,this),-1===r(b,a)&&(b.push(a),a.requireFailure(this)),this},dropRequireFailure:function(a){if(f(a,"dropRequireFailure",this))return this;a=_(a,this);var b=r(this.requireFail,a);return b>-1&&this.requireFail.splice(b,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(a){return!!this.simultaneous[a.id]},emit:function(a){function b(b){c.manager.emit(b,a)}var c=this,d=this.state;qb>d&&b(c.options.event+Z(d)),b(c.options.event),a.additionalEvent&&b(a.additionalEvent),d>=qb&&b(c.options.event+Z(d))},tryEmit:function(a){return this.canEmit()?this.emit(a):void(this.state=tb)},canEmit:function(){for(var a=0;a<this.requireFail.length;){if(!(this.requireFail[a].state&(tb|nb)))return!1;a++}return!0},recognize:function(a){var b=la({},a);return k(this.options.enable,[this,b])?(this.state&(rb|sb|tb)&&(this.state=nb),this.state=this.process(b),void(this.state&(ob|pb|qb|sb)&&this.tryEmit(b))):(this.reset(),void(this.state=tb))},process:function(a){},getTouchAction:function(){},reset:function(){}},i(aa,Y,{defaults:{pointers:1},attrTest:function(a){var b=this.options.pointers;return 0===b||a.pointers.length===b},process:function(a){var b=this.state,c=a.eventType,d=b&(ob|pb),e=this.attrTest(a);return d&&(c&Ha||!e)?b|sb:d||e?c&Ga?b|qb:b&ob?b|pb:ob:tb}}),i(ba,aa,{defaults:{event:"pan",threshold:10,pointers:1,direction:Pa},getTouchAction:function(){var a=this.options.direction,b=[];return a&Na&&b.push(lb),a&Oa&&b.push(kb),b},directionTest:function(a){var b=this.options,c=!0,d=a.distance,e=a.direction,f=a.deltaX,g=a.deltaY;return e&b.direction||(b.direction&Na?(e=0===f?Ia:0>f?Ja:Ka,c=f!=this.pX,d=Math.abs(a.deltaX)):(e=0===g?Ia:0>g?La:Ma,c=g!=this.pY,d=Math.abs(a.deltaY))),a.direction=e,c&&d>b.threshold&&e&b.direction},attrTest:function(a){return aa.prototype.attrTest.call(this,a)&&(this.state&ob||!(this.state&ob)&&this.directionTest(a))},emit:function(a){this.pX=a.deltaX,this.pY=a.deltaY;var b=$(a.direction);b&&(a.additionalEvent=this.options.event+b),this._super.emit.call(this,a)}}),i(ca,aa,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.scale-1)>this.options.threshold||this.state&ob)},emit:function(a){if(1!==a.scale){var b=a.scale<1?"in":"out";a.additionalEvent=this.options.event+b}this._super.emit.call(this,a)}}),i(da,Y,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[hb]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime>b.time;if(this._input=a,!d||!c||a.eventType&(Ga|Ha)&&!f)this.reset();else if(a.eventType&Ea)this.reset(),this._timer=e(function(){this.state=rb,this.tryEmit()},b.time,this);else if(a.eventType&Ga)return rb;return tb},reset:function(){clearTimeout(this._timer)},emit:function(a){this.state===rb&&(a&&a.eventType&Ga?this.manager.emit(this.options.event+"up",a):(this._input.timeStamp=ra(),this.manager.emit(this.options.event,this._input)))}}),i(ea,aa,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[jb]},attrTest:function(a){return this._super.attrTest.call(this,a)&&(Math.abs(a.rotation)>this.options.threshold||this.state&ob)}}),i(fa,aa,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Na|Oa,pointers:1},getTouchAction:function(){return ba.prototype.getTouchAction.call(this)},attrTest:function(a){var b,c=this.options.direction;return c&(Na|Oa)?b=a.overallVelocity:c&Na?b=a.overallVelocityX:c&Oa&&(b=a.overallVelocityY),this._super.attrTest.call(this,a)&&c&a.offsetDirection&&a.distance>this.options.threshold&&a.maxPointers==this.options.pointers&&qa(b)>this.options.velocity&&a.eventType&Ga},emit:function(a){var b=$(a.offsetDirection);b&&this.manager.emit(this.options.event+b,a),this.manager.emit(this.options.event,a)}}),i(ga,Y,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ib]},process:function(a){var b=this.options,c=a.pointers.length===b.pointers,d=a.distance<b.threshold,f=a.deltaTime<b.time;if(this.reset(),a.eventType&Ea&&0===this.count)return this.failTimeout();if(d&&f&&c){if(a.eventType!=Ga)return this.failTimeout();var g=this.pTime?a.timeStamp-this.pTime<b.interval:!0,h=!this.pCenter||H(this.pCenter,a.center)<b.posThreshold;this.pTime=a.timeStamp,this.pCenter=a.center,h&&g?this.count+=1:this.count=1,this._input=a;var i=this.count%b.taps;if(0===i)return this.hasRequireFailures()?(this._timer=e(function(){this.state=rb,this.tryEmit()},b.interval,this),ob):rb}return tb},failTimeout:function(){return this._timer=e(function(){this.state=tb},this.options.interval,this),tb},reset:function(){clearTimeout(this._timer)},emit:function(){this.state==rb&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),ha.VERSION="2.0.8",ha.defaults={domEvents:!1,touchAction:gb,enable:!0,inputTarget:null,inputClass:null,preset:[[ea,{enable:!1}],[ca,{enable:!1},["rotate"]],[fa,{direction:Na}],[ba,{direction:Na},["swipe"]],[ga],[ga,{event:"doubletap",taps:2},["tap"]],[da]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};var ub=1,vb=2;ia.prototype={set:function(a){return la(this.options,a),a.touchAction&&this.touchAction.update(),a.inputTarget&&(this.input.destroy(),this.input.target=a.inputTarget,this.input.init()),this},stop:function(a){this.session.stopped=a?vb:ub},recognize:function(a){var b=this.session;if(!b.stopped){this.touchAction.preventDefaults(a);var c,d=this.recognizers,e=b.curRecognizer;(!e||e&&e.state&rb)&&(e=b.curRecognizer=null);for(var f=0;f<d.length;)c=d[f],b.stopped===vb||e&&c!=e&&!c.canRecognizeWith(e)?c.reset():c.recognize(a),!e&&c.state&(ob|pb|qb)&&(e=b.curRecognizer=c),f++}},get:function(a){if(a instanceof Y)return a;for(var b=this.recognizers,c=0;c<b.length;c++)if(b[c].options.event==a)return b[c];return null},add:function(a){if(f(a,"add",this))return this;var b=this.get(a.options.event);return b&&this.remove(b),this.recognizers.push(a),a.manager=this,this.touchAction.update(),a},remove:function(a){if(f(a,"remove",this))return this;if(a=this.get(a)){var b=this.recognizers,c=r(b,a);-1!==c&&(b.splice(c,1),this.touchAction.update())}return this},on:function(a,b){if(a!==d&&b!==d){var c=this.handlers;return g(q(a),function(a){c[a]=c[a]||[],c[a].push(b)}),this}},off:function(a,b){if(a!==d){var c=this.handlers;return g(q(a),function(a){b?c[a]&&c[a].splice(r(c[a],b),1):delete c[a]}),this}},emit:function(a,b){this.options.domEvents&&ka(a,b);var c=this.handlers[a]&&this.handlers[a].slice();if(c&&c.length){b.type=a,b.preventDefault=function(){b.srcEvent.preventDefault()};for(var d=0;d<c.length;)c[d](b),d++}},destroy:function(){this.element&&ja(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},la(ha,{INPUT_START:Ea,INPUT_MOVE:Fa,INPUT_END:Ga,INPUT_CANCEL:Ha,STATE_POSSIBLE:nb,STATE_BEGAN:ob,STATE_CHANGED:pb,STATE_ENDED:qb,STATE_RECOGNIZED:rb,STATE_CANCELLED:sb,STATE_FAILED:tb,DIRECTION_NONE:Ia,DIRECTION_LEFT:Ja,DIRECTION_RIGHT:Ka,DIRECTION_UP:La,DIRECTION_DOWN:Ma,DIRECTION_HORIZONTAL:Na,DIRECTION_VERTICAL:Oa,DIRECTION_ALL:Pa,Manager:ia,Input:x,TouchAction:V,TouchInput:P,MouseInput:L,PointerEventInput:M,TouchMouseInput:R,SingleTouchInput:N,Recognizer:Y,AttrRecognizer:aa,Tap:ga,Pan:ba,Swipe:fa,Pinch:ca,Rotate:ea,Press:da,on:m,off:n,each:g,merge:ta,extend:sa,assign:la,inherit:i,bindFn:j,prefixed:u});var wb="undefined"!=typeof a?a:"undefined"!=typeof self?self:{};wb.Hammer=ha,"function"==typeof define&&define.amd?define(function(){return ha}):"undefined"!=typeof module&&module.exports?module.exports=ha:a[c]=ha}(window,document,"Hammer");
//# sourceMappingURL=hammer.min.js.map

/*
 Copyright (c) 2009-2013 Petr Vostrel (http://petr.vostrel.cz/)
 Licensed under the MIT License (LICENSE.txt).

 jQuery Reel
 http://reel360.org
 Version: 1.3.0
 Updated: 2013-11-04

 Requires jQuery 1.6.2 or higher
*/
(function(k){var U=typeof define=="function"&&define.amd&&(define(["jquery"],k)||true),X=!U&&typeof module=="object"&&typeof module.exports=="object"&&(module.exports=k);!U&&!X&&k()})(function(){return jQuery.reel||function(k,U,X,s){function Bc(f){return n.instances.push(f[0])&&f}function Cc(f){return(n.instances=n.instances.not(Ca(f.attr(ka))))&&f}function Y(f){return n.instances.first().data(f)}function Dc(f){return"data:image/gif;base64,R0lGODlh"+f}function V(f){return"<"+f+"/>"}function x(f){return"."+
(f||"")}function Va(f){return f.replace(Da,n.cdn)}function Ea(f){return"url('"+$b(f)+"')"}function ac(f,j){return typeof j==tb?j[f]:j}function Fa(f,j,o){return ub(f,Ga(j,o))}function Ha(f,j){return H(f)*(j?-1:1)}function Wa(f){return f.touch||f.originalEvent.touches&&f.originalEvent.touches[0]||f}function vb(f){return f.originalEvent}function y(f){return f===s?0:typeof f==wb?f:f+"px"}function Ca(f){return"#"+f}function bc(f,j,o){for(;f.length<j;)f=o+f;return f}function xb(f){return bc(f,2,"0")}function $b(f){return encodeURI(decodeURI(f))}
function yb(f){return n.re.array.exec(f)?f.split(n.re.array):f}function Ec(f){return!f.parents(zb).length}function cc(f){return typeof f==wb?f:k.each(f,function(j,o){f[j]=o?+o:s})}function Ab(f){try{console.error("[ Reel ] "+f)}catch(j){}}if(k){var Z=k&&k().jquery.split(/\./);if(!Z||+(xb(Z[0])+xb(Z[1])+xb(Z[2]||""))<10602)return Ab("Too old jQuery library. Please upgrade your jQuery to version 1.6.2 or higher");var n=k.reel={version:"1.3.0",def:{frame:1,frames:36,loops:true,clickfree:false,draggable:true,
scrollable:true,steppable:true,throwable:true,wheelable:true,orientable:false,cw:false,revolution:s,stitched:0,directional:false,row:1,rows:0,rowlock:false,framelock:false,orbital:0,vertical:false,inversed:false,footage:6,spacing:0,horizontal:true,suffix:"-reel",image:s,images:"",path:"",preload:"fidelity",shy:false,speed:0,delay:0,timeout:2,duration:s,rebound:0.5,entry:s,opening:0,brake:0.23,velocity:0,tempo:36,laziness:6,cursor:s,hint:"",indicator:0,klass:"",preloader:2,area:s,attr:{},annotations:s,
responsive:false,graph:s,monitor:s},scan:function(){return k(x(z)+":not("+x(Bb)+" > "+x(z)+")").each(function(f,j){f=k(j);j=f.data();j.images=yb(j.images);var o={};k(x(dc)+"[data-for="+f.attr(ka)+"]").each(function(t,r){t=k(r);r=t.data();r.x=cc(yb(r.x));r.y=cc(yb(r.y));var g=t.attr(ka);r.node=t.removeData();o[g]=r});j.annotations=o;f.removeData().reel(j)})},fn:{reel:function(){var f=arguments,j=k(this),o=j.data(),t=f[0]||{},r=f[1];if(typeof t!="object")if(t.slice(0,1)==":")return j.trigger(t.slice(1),
r);else if(f.length==1)return o[t];else{if(r!==s){n.normal[t]&&(r=n.normal[t](r,o));if(o[t]===s)o[t]=r;else if(o[t]!==r)j.trigger(t+"Change",[s,o[t]=r])}return j}else{var g=k.extend({},n.def,t),K=[];j.filter(Xa).unreel().filter(function(){var h=k(this),e=g.attr,a=e.src||h.attr(ra),I=e.width||h.attr(L)||h.width();h=e.height||h.attr(D)||h.height();if(!a)return Ab("`src` attribute missing on target image");if(!I||!h)return Ab("Dimension(s) of the target image unknown");return true}).each(function(){var h=
k(this),e=function(c,d){return h.reel(c,d)&&a(c)},a=function(c){return h.data(c)},I={setup:function(){if(!(h.hasClass(z)&&h.parent().hasClass(Bb))){e(Ia,g);var c={src:h.attr(ra),width:h.attr(D)||null,height:h.attr(L)||null,style:h.attr($)||null,"class":h.attr(ec)||null},d=h.attr(g.attr).attr(ra),b=e(ka,h.attr(ka)||h.attr(ka,z+"-"+ +new Date).attr(ka)),i=k.extend({},h.data()),p=e(aa,g.images||[]),m=e(W,g.stitched),l=!p.length||m;l=e(Ya,g.responsive&&(Fc?true:!l));var q=e(fc,{}),u=g.loops,v=g.orbital,
E=g.revolution,ba=g.rows,ca=e(sa,Ga(g.footage,g.frames));e(Za,g.spacing);var Cb=e(D,+h.attr(D)||h.width()),Db=e(L,+h.attr(L)||h.height()),Gc=e(Ja,g.shy),gc=e(O,v&&ca||ba<=1&&p.length||g.frames),Hc=ba>1||v;e(Ka,ac("x",E)||m/2||Cb*2);e(Eb,!Hc?0:ac("y",E)||(ba>3?Db:Db/(5-ba)));ba=m?1:la(gc/ca);e(Fb,m-(u?0:Cb));e($a,0);b=Ca(b+g.suffix);u=h.attr(ec);u=!u?P:u+A;u=k(V(ta),{id:b.substr(1),"class":u+A+Bb+A+hc+"0"});u=h.wrap(u.addClass(g.klass)).addClass(z);K.push(Bc(u)[0]);u=u.parent().bind(I.instance);e(Gb,
p.length?P:g.image||d.replace(n.re.image,"$1"+g.suffix+".$2"));e(ab,k(V(ta),{"class":Hb}).appendTo("body"));e(La,k());e(ic,[]);e(J,null);e(B,null);e(Q,g.row);e(ua,0);e(Ib,ba);e(jc,g.rowlock);e(kc,g.framelock);e(bb,e(Ma,e(cb,0)));e(db,1/gc);e(lc,b);e(M,e(va,g.speed)<0);e(Na,false);e(ma,0);e(wa,g.vertical);e(da,0);e(xa,Ha(1,!g.cw&&!m));e(eb,{});e(ea,false);e(fb,e(Jb,0));e(gb,e(hb,0));e(Oa,false);e(Kb,false);e(fa,false);e(mc,g.brake);e(Lb,!!v);e(ga,g.tempo/(n.lazy?g.laziness:1));e(ya,-1);e(ib,-1);e(Pa,
g.annotations||u.unbind(x(Pa))&&{});e(Mb,1);e(nc,{attr:c,data:i});g.steppable||u.unbind("up.steppable");g.indicator||u.unbind(".indicator");C(P,{overflow:Nb,position:"relative"});l||C(P,{width:Cb,height:Db});l&&k.each(Ic,function(cd,oc){q[oc]=a(oc)});C(na+A+x(z),{display:Ob});C(x(Hb),{position:"fixed",left:y(-100),top:y(-100)},true);C(x(Hb)+A+Xa,{position:Qa,width:10,height:10},true);ha.bind(I.pool);h.trigger(Gc?"prepare":"setup")}},instance:{teardown:function(){var c=h.data(nc);h.parent().unbind(I.instance);
if(a(Ja))h.parent().unbind(jb,ia);else a($).remove()&&a(La).unbind(F);a(ab).empty();clearTimeout(Pb);clearTimeout(Qb);k(U).unbind(pc,qc);k(U).unbind(F);ha.unbind(I.pool);oa.unbind(ja);h.siblings().unbind(F).remove();kb();h.removeAttr("onloaded");Cc(h.unbind(F).removeData().unwrap().attr(c.attr).data(c.data));h.attr($)==P&&h.removeAttr($)},setup:function(){function c(q){return h.trigger("down",[Wa(q).clientX,Wa(q).clientY,q])&&q.give}function d(q,u){return!u||h.trigger("wheel",[u,q])&&q.give}var b=
h.parent().append(za()),i=e(La,k(g.area||b)),p=g.rows>1,m=g.cursor,l=m==rc?Jc:m||Kc;m=m==rc?Lc+A+"!important":s;C(A+x(z),{MozUserSelect:lb,WebkitUserSelect:lb,MozTransform:"translateZ(0)"});h.unbind(jb,ia);i.bind(Mc,c).bind(g.clickfree?Nc:Oc,c).bind(g.wheelable?Pc:null,d).bind(Qc,function(){return false});C(P,{cursor:Va(l)});C(x(Rb),{cursor:"wait"});C(x(mb)+na+x(mb)+" *",{cursor:Va(m||l)},true);if(a(Ya)){C(A+x(z),{width:"100%",height:Sb});k(U).bind(pc,qc)}g.hint&&i.attr("title",g.hint);g.indicator&&
b.append(Ra("x"));p&&g.indicator&&b.append(Ra("y"));g.monitor&&b.append(sc=k(V(ta),{"class":tc}))&&C(A+x(tc),{position:Qa,left:0,top:0})},preload:function(){function c(){var q=l.children(":not([src]):first");return q.attr(ra,q.data(ra))}var d=h.parent(),b=a(aa),i=!b.length,p=n.preload[g.preload]||n.preload[n.def.preload];b=i?[a(Gb)]:p(b.slice(0),g,a);e(da,i?0.5:0);var m=0,l=a(ab).empty();i=[];d.addClass(Rb);e($,a($)||k("<"+$+' type="text/css">'+C.rules.join("\n")+"</"+$+">").prependTo(Tb));e(Na,true);
h.trigger("stop");g.responsive&&Ub();for(h.trigger("resize",true);b.length;){p=n.substitute(g.path+b.shift(),a);k(V(Xa)).data(ra,p).appendTo(l).bind("load error abort",function(q){q.type!="load"&&h.trigger(q.type);return!Ec(d)&&h.trigger("preloaded")&&c()&&false});i.push(p)}setTimeout(function(){for(;++m<n.concurrent_requests;)c()},0);e(ic,i);e(Ja,false)},preloaded:function(){var c=a(aa).length||1,d=e(da,Ga(a(da)+1,c));d===1&&h.trigger("frameChange",[s,a(J)]);if(d===c){h.parent().removeClass(Rb);
h.trigger("loaded")}},loaded:function(){a(aa).length>1||h.css({backgroundImage:Ea(n.substitute(g.path+a(Gb),a))}).attr({src:Va(uc)});a(W)&&h.attr({src:Va(uc)});a(Kb)||e(ma,g.velocity||0);e(Na,false);pa=true},prepare:function(){h.css("display",Ob).parent().one(jb,ia)},opening:function(){if(!g.opening)return h.trigger("openingDone");e(fa,true);e(Vb,!a(va));var c=g.entry||g.speed,d=a(B),b=g.opening;e(B,d-c*b);e(ya,la(b*Y(ga)))},openingDone:function(){function c(b){return h.trigger("orient",[vb(b).alpha,
vb(b).beta,vb(b).gamma,b])&&b.give}e(Sa,false);e(fa,false);var d=nb+x(fa);ha.unbind(d,I.pool[d]);g.orientable&&k(U).bind(Rc,c);if(g.delay>0)Pb=setTimeout(function(){h.trigger("play")},g.delay*1E3);else h.trigger("play")},play:function(c,d){d=d?e(va,d):a(va)*Ha(1,a(M));(c=g.duration)&&e(ib,la(c*Y(ga)));e(M,d<0);d=e(Sa,!!d);e(Vb,!d);Aa()},reach:function(c,d,b){if(d!=a(J)){c=a(O);e(Q,la(d/c));var i=e(bb,a(J));d=e(Ma,d);d=e(cb,n.math.distance(i,d,c));b=H(b||a(va))*Ha(1,d<0);h.trigger("play",b)}},pause:function(){w()},
stop:function(){var c=e(Vb,true);e(Sa,!c)},down:function(c,d,b,i){function p(l){return h.trigger("pan",[Wa(l).clientX,Wa(l).clientY,l])&&l.give}function m(l){return h.trigger("up",[l])&&l.give}if(!(!g.clickfree&&i&&i.button!==s&&i.button!=Sc))if(g.draggable){e(ea,a(J));c=g.clickfree;e(ma,0);i=c?a(La):oa;ob=pb(a(Ka),d,b);w();kb();G=0;k(zb,oa).addClass(mb);i.bind(Tc+A+Uc,p).bind(Vc+A+Wc,m).bind(c?Xc:Yc,m)}},up:function(){e(ea,false);e(Oa,false);var c=g.throwable,d=H(Ta[0]+Ta[1])/60;N=e(ma,!c?0:c===
true?d:Ga(c,d))?1:0;w();kb();k(zb,oa).removeClass(mb);(g.clickfree?a(La):oa).unbind(ja)},pan:function(c,d,b,i){if(g.draggable&&Ua){Ua=false;w();c=g.rows;var p=g.orbital,m=!a(Oa)&&c<=1&&!p&&g.scrollable,l={x:d-ob.x,y:b-ob.y},q={x:H(l.x),y:H(l.y)};if(i&&m&&q.x<q.y)return i.give=true;if(q.x>0||q.y>0){i&&(i.give=false);G=ub(q.x,q.y);ob={x:d,y:b};i=a(Ka);m=a(eb);q=a(wa);if(!a(kc)){var u=e(B,vc(q?b-m.y:d-m.x,a(fb),i,a(gb),a(hb),a(xa),q?b-m.y:d-m.x));e(Oa,a(Oa)||a(J)!=a(ea));(l=wc(q?l.y:l.x||0))&&e(M,l<
0)}if(p&&a(Lb)){e(wa,H(b-m.y)>H(d-m.x));m=pb(i,d,b)}if(c>1&&!a(jc)){c=a(Eb);p=a(Jb);l=-p*c;e(ua,n.math.envelope(b-m.y,p,c,l,l+c,-1))}!(u%1)&&!g.loops&&pb(i,d,b)}}},wheel:function(c,d,b){if(d){qb=true;c=la(qa.sqrt(H(d))/2);c=Ha(c,d>0);d=0.0833*a(Ka);pb(d);c&&e(M,c<0);e(ma,0);e(B,vc(c,a(fb),d,a(gb),a(hb),a(xa)));b&&b.preventDefault();b&&(b.give=false);w();h.trigger("up",[b])}},orient:function(c,d){if(!(!Ua||R)){xc=true;c=d/360;fraction=e(B,+(g.stitched||g.cw?1-c:c).toFixed(2));Ua=false}},fractionChange:function(c,
d,b){if(d===s){c=1+rb(b/a(db));d=g.rows>1;b=g.orbital;e(Lb,!!b&&(c<=b||c>=a(sa)-b+2));if(d)c+=(a(Q)-1)*a(O);e(J,c)}},tierChange:function(c,d,b){if(d===s){c=e(Q,S(Wb(b,1,g.rows)));d=a(O);b=a(J)%d||d;e(J,b+c*d-d)}},rowChange:function(c,d,b){d===s&&Xb(ua,s,b,g.rows)},frameChange:function(c,d,b){if(d===s){this.className=this.className.replace(n.re.frame_klass,hc+b);c=a(O);d=g.rows;var i=g.path,p=b%c||c,m=((b-p)/c+1-1)/(d-1),l=a(Q);!d?a(ua):Xb(ua,m,l,d);var q=Xb(B,s,p,c),u=a(sa);if(g.orbital&&a(wa)){b=
g.inversed?u+1-b:b;b+=u}var v=a(W);c=a(aa);if(!c.length||v){p=a(Za);var E=a(D);m=a(L);if(v){b=e($a,S(Wb(q,0,a(Fb)))%v);d=d<=1?0:(m+p)*(d-l);b=[y(-b),y(-d)];c=c.length>1&&c[l-1];d=n.substitute(i+c,a);c&&h.css("backgroundImage").search(d)<0&&h.css({backgroundImage:Ea(d)})}else{i=g.horizontal;l=b%u-1;l=l<0?u-1:l;b=rb((b-0.1)/u);b+=d>1?0:a(M)?0:!g.directional?0:a(Ib);b=b*((i?m:E)+p);d=l*((i?E:m)+p);b=c.length?[0,0]:i?[y(-d),y(-b)]:[y(-b),y(-d)]}h.css({backgroundPosition:b.join(A)})}else{a(Ya)&&Ub();a(da)&&
h.attr({src:$b(n.substitute(i+c[b-1],a))})}}},"frameChange.reach":function(c,d,b){if(!(!a(Ma)||d!==s)){c=n.math.distance(a(bb),b,a(O));if(H(c)>=H(a(cb))){e(J,e(Ma));e(Ma,e(cb,e(bb,0)));h.trigger("stop")}}},"imageChange imagesChange":function(){h.trigger("preload")},"fractionChange.indicator":function(c,d,b){if(g.indicator&&d===s){c=g.indicator;var i=g.orbital;d=i&&a(wa)?a(L):a(D);i=i?a(sa):g.images.length||a(O);i=la(d/i);d-=i;b=S(Wb(b,0,d));b=!g.cw||a(W)?b:d-b;Ra.$x.css(a(wa)?{left:0,top:y(b),bottom:Sb,
width:c,height:i}:{bottom:0,left:y(b),top:Sb,width:i,height:c})}},"tierChange.indicator":function(c,d,b){if(g.rows>1&&g.indicator&&d===s){var i=a(L);c=g.indicator;d=la(i/g.rows);i-=d;b=S(b*i);Ra.$y.css({left:0,top:b,width:c,height:d})}},"setup.annotations":function(){var c=h.parent();k.each(a(Pa),function(d,b){var i=typeof b.node==wb?k(b.node):b.node||{};i=i.jquery?i:k(V(ta),i);i=i.attr({id:d}).addClass(dc);var p=b.image?k(V(Xa),b.image):k(),m=b.link?k(V("a"),b.link).click(function(){h.trigger("up.annotations",
{target:m})}):k();C(Ca(d),{display:lb,position:Qa},true);b.image||b.link&&i.append(m);b.link||b.image&&i.append(p);b.link&&b.image&&i.append(m.append(p));i.appendTo(c)})},"prepare.annotations":function(){k.each(a(Pa),function(c){k(Ca(c)).hide()})},"frameChange.annotations":function(c,d){if(!(!a(da)||d!==s)){var b=a(D),i=a(W),p=a($a);k.each(a(Pa),function(m,l){m=k(Ca(m));var q=l.start||1,u=l.end,v=v||a(J),E=v-1,ba=l.at?l.at[E]=="+":false;E=l.at?E:E-q+1;v=typeof l.x!=tb?l.x:l.x[E];var ca=typeof l.y!=
tb?l.y:l.y[E];l=v!==s&&ca!==s&&(l.at?ba:E>=0&&(!u||E<=u-q));if(i){q=v>i-b&&p>=0&&p<b;v=!(v<b&&p>i-b)?v:v+i;v=!q?v:v-i;v-=p}if(a(Ya)){q=a(Mb);v=v&&v*q;ca=ca&&ca*q}v={display:l?Ob:lb,left:y(v),top:y(ca)};m.css(v)})}},"up.annotations":function(c,d){if(!(G>10||qb)){c=k(d.target);(c.is("a")?c:c.parents("a")).attr("href")&&(G=10)}},"up.steppable":function(){G||qb||h.trigger(a(eb).x-h.offset().left>0.5*a(D)?"stepRight":"stepLeft")},"stepLeft stepRight":function(){w()},stepLeft:function(){e(M,false);e(B,
a(B)-a(db)*a(xa))},stepRight:function(){e(M,true);e(B,a(B)+a(db)*a(xa))},stepUp:function(){e(Q,a(Q)-1)},stepDown:function(){e(Q,a(Q)+1)},resize:function(c,d){if(!(a(Na)&&!d)){var b=a(W),i=a(Za);c=a(L);var p=!a(aa).length||b,m=g.rows||1;b=a(aa).length?!b?s:y(b)+A+y(c):b&&y(b)+A+y((c+i)*m-i)||y((a(D)+i)*a(sa)-i)+A+y((c+i)*a(Ib)*m*(g.directional?2:1)-i);h.css({height:p?y(c):null,backgroundSize:b||null});d||h.trigger("imagesChange")}},"setup.fu":function(){e(J,g.frame+(a(Q)-1)*a(O));h.trigger("preload")},
"wheel.fu":function(){qb=false},"clean.fu":function(){h.trigger("teardown")},"loaded.fu":function(){h.trigger("opening")}},pool:{"tick.reel.preload":function(){if(!(!(pa||a(Na))||a(Ja))){var c=a(D),d=Zc(za.$.css(D)),b=a(aa).length||1,i=S(1/b*a(da)*c);za.$.css({width:d+(i-d)/3+1});if(a(da)===b&&d>c-1){pa=false;za.$.fadeOut(300,function(){za.$.css({opacity:1,width:0})})}}},"tick.reel":function(c){if(!a(Ja)){var d=a(ma),b=Y(ga),i=g.monitor;if(!(!n.intense&&$c())){if(N){d=d-a(mc)/b*N;d=e(ma,d>0.1?d:(N=
R=0))}i&&sc.text(a(i));d&&N++;R&&R++;wc(0);Ua=true;if(R&&!d)return T(c);if(a(ea))return T(c,w());if(!(a(ya)>0)){if(!g.loops&&g.rebound){!R&&!(a(B)%1)?Yb++:(Yb=0);Yb>=g.rebound*1E3/b&&e(M,!a(M))}c=a(xa)*Ha(1,a(M));b=a(ib);d=(!a(Sa)||xc||!b?d:H(a(va))+d)/Y(ga);e(B,a(B)-d*c);b=!g.duration?b:b>0&&e(ib,b-1);!b&&a(Sa)&&h.trigger("stop")}}}},"tick.reel.opening":function(){if(a(fa)){var c=(g.entry||g.speed)/Y(ga)*(g.cw?-1:1),d=e(ya,a(ya)-1);e(B,a(B)+c);d||h.trigger("openingDone")}}}},pa=false,T=function(c,
d){return c.stopImmediatePropagation()||d},ia=function(){h.trigger("setup")},R,N=0,Aa=function(){return R=0},w=function(){clearTimeout(Pb);ha.unbind(nb+x(fa),I.pool[nb+x(fa)]);e(ya,0);e(Kb,true);return R=-g.timeout*Y(ga)},G=0,qb=false,xc=false,sc=k(),za=function(){C(A+x(yc),{position:Qa,left:0,bottom:0,height:g.preloader,overflow:Nb,backgroundColor:"#000"});return za.$=k(V(ta),{"class":yc})},Ra=function(c){C(A+x(zc)+x(c),{position:Qa,width:0,height:0,overflow:Nb,backgroundColor:"#000"});return Ra["$"+
c]=k(V(ta),{"class":zc+A+c})},C=function(c,d,b){function i(p){var m=[];k.each(p,function(l,q){m.push(l.replace(/([A-Z])/g,"-$1").toLowerCase()+":"+y(q)+";")});return"{"+m.join(P)+"}"}b=b?P:a(lc);c=c.replace(/^/,b).replace(na,na+b);return C.rules.push(c+i(d))&&d},$c=function(){var c=a(L),d=a(D),b=h[0].getBoundingClientRect();return b.top<-c||b.left<-d||b.right>d+k(U).width()||b.bottom>c+k(U).height()},Yb=0,ob={x:0,y:0},wc=function(c){return Ta.push(c)&&Ta.shift()&&c},kb=function(){return Ta=[0,0]},
Ta=kb(),vc=g.graph||n.math[g.loops?"hatch":"envelope"],qc=function(){clearTimeout(Qb);Qb=setTimeout(Ub,n.resize_gauge)},Ub=function(){if(h.width()!=a(D)){var c=a(fc),d=e(Mb,h.width()/c.width);k.each(c,function(b,i){e(b,S(i*d))});h.trigger("resize")}},Pb,Qb,pb=function(c,d,b){var i=e(fb,a(B));e(Jb,a(ua));var p=g.loops;e(gb,p?0:-i*c);e(hb,p?c:c-i*c);return d!==s&&e(eb,{x:d,y:b})||s},Ua=true,Xb=function(c,d,b,i){if(i){var p=a(c)||0;b=d!==s?d:(b-1)/(i-1);b=c!=B?b:Ga(b,0.9999);return d=+H(p-b).toFixed(8)>=
+(1/(i-1)).toFixed(8)?e(c,b):d||p}},oa=ha;try{if(ha[0]!=top.document)oa=ha.add(top.document)}catch(dd){}top===self?k():function(c){k("iframe",oa.last()).each(function(){try{if(k(this).contents().find(Tb).html()==k(Tb).html())return(c=k(this))&&false}catch(d){}});return c}();C.rules=[];I.setup()});sb=sb||function h(){var e=+new Date,a=Y(ga);if(!a)return sb=null;ha.trigger(nb);n.cost=(+new Date+n.cost-e)/2;return sb=setTimeout(h,ub(4,1E3/a-n.cost))}();return k(K)}},unreel:function(){return this.trigger("teardown")}},
re:{image:/^(.*)\.(jpg|jpeg|png|gif)\??.*$/i,ua:[/(msie|opera|firefox|chrome|safari)[ \/:]([\d.]+)/i,/(webkit)\/([\d.]+)/i,/(mozilla)\/([\d.]+)/i],array:/ *, */,lazy_agent:/\(iphone|ipod|android|fennec|blackberry/i,frame_klass:/frame-\d+/,substitution:/(@([A-Z]))/g,no_match:/^(undefined|)$/,sequence:/(^[^#|]*([#]+)[^#|]*)($|[|]([0-9]+)\.\.([0-9]+))($|[|]([0-9]+)$)/},cdn:"http://code.vostrel.net/",math:{envelope:function(f,j,o,t,r,g){return j+Fa(t,r,-f*g)/o},hatch:function(f,j,o,t,r,g){f=(f<t?r:0)+
f%r;f=j+-f*g/o;return f-rb(f)},interpolate:function(f,j,o){return j+f*(o-j)},distance:function(f,j,o){var t=o/2;f=j-f;return f<-t?f+o:f>t?f-o:f}},preload:{fidelity:function(f,j,o){function t(e,a,I){function pa(G){for(;!(G>=1&&G<=N);)G+=G<1?+N:-N;return h[I+G]||(h[I+G]=!!T.push(G))}if(!e.length)return[];var T=[],ia=4*a,R=j.frame,N=e.length;a=true;for(var Aa=N/ia,w=0;w<ia;w++)pa(R+S(w*Aa));for(;Aa>1;){w=0;ia=T.length;Aa/=2;for(a=!a;w<ia;w++)pa(T[w]+(a?1:-1)*S(Aa))}for(w=0;w<=N;w++)pa(w);for(w=0;w<T.length;w++)T[w]=
e[T[w]-1];return T}var r=j.orbital,g=r?2:j.rows||1,K=r?o(sa):o(O);o=(j.row-1)*K;r=[].concat(f);var h=new Array(f.length+1);f=g<2?[]:r.slice(o,o+K);return t(f,1,o).concat(t(r,g,0))},linear:function(f){return f}},substitute:function(f,j){return f.replace(n.re.substitution,function(o,t,r){return typeof n.substitutes[r]=="function"?n.substitutes[r](j):Ac[r]?j(Ac[r]):t})},substitutes:{T:function(){return+new Date}},normal:{fraction:function(f,j){if(f===null)return f;return j[Ia].loops?f-rb(f):Fa(0,1,f)},
tier:function(f){if(f===null)return f;return Fa(0,1,f)},row:function(f,j){if(f===null)return f;return S(Fa(1,j[Ia].rows,f))},frame:function(f,j){if(f===null)return f;var o=j[Ia];j=j[O]*(o.orbital?2:o.rows||1);f=S(o.loops?f%j||j:Fa(1,j,f));return f<0?f+j:f},images:function(f,j){var o=n.re.sequence.exec(f);return!o?f:n.sequence(o,j[Ia])}},sequence:function(f,j){if(f.length<=1)return j.images;var o=[],t=j.orbital,r=f[1],g=f[2],K=f[4];K=n.re.no_match.test(K+P)?1:+K;var h=t?2:j.rows||1;j=t?j.footage:j.stitched?
1:j.frames;h=+(f[5]||h*j)-K;f=+f[7]||1;for(j=0;j<=h;){o.push(r.replace(g,bc(K+j+P,g.length,"0")));j+=f}return o},instances:k(),leader:Y,resize_gauge:300,concurrent_requests:4,cost:0},ha=k(X);X=navigator.userAgent;var Ba=n.re.ua[0].exec(X)||n.re.ua[1].exec(X)||n.re.ua[2].exec(X);Z=+Ba[2].split(".").slice(0,2).join(".");Ba=Ba[1]=="MSIE";var ad=!(Ba&&Z<8),Fc=!(Ba&&Z<9),sb,z="reel",Bb=z+"-overlay",Hb=z+"-cache",zc=z+"-indicator",yc=z+"-preloader",tc=z+"-monitor",dc=z+"-annotation",mb=z+"-panning",Rb=
z+"-loading",hc="frame-",qa=Math,S=qa.round,rb=qa.floor,la=qa.ceil,Ga=qa.min,ub=qa.max,H=qa.abs,Zc=parseInt,Wb=n.math.interpolate,Pa="annotations",La="area",Sb="auto",nc="backup",M="backwards",db="bit",mc="brake",ab="cache",ic=ab+"d",Lb="center",ec="class",jb="click",ea=jb+"ed",eb=ea+"_location",fb=ea+"_on",Jb=ea+"_tier",xa="cwish",bb="departure",Ma="destination",cb="distance",sa="footage",B="fraction",J="frame",kc="framelock",O="frames",L="height",hb="hi",Nb="hidden",Gb="image",aa="images",gb="lo",
Na="loading",fa="opening",ya=fa+"_ticks",Ia="options",Sa="playing",da="preloaded",Mb="ratio",Oa="reeling",Kb="reeled",Ya="responsive",Ka="revolution",Eb="revolution_y",Q="row",jc="rowlock",Ib="rows",Ja="shy",Za="spacing",va="speed",ra="src",lc="stage",W="stitched",$a=W+"_shift",Fb=W+"_travel",Vb="stopped",$="style",ga="tempo",ib="ticks",ua="tier",fc="truescale",ma="velocity",wa="vertical",D="width",F=x(z),ja=x("pan")+F,Rc="deviceorientation"+F,Qc="dragstart"+F,Oc="mousedown"+F,Nc="mouseenter"+F,Xc=
"mouseleave"+ja,Uc="mousemove"+ja,Yc="mouseup"+ja,Pc="mousewheel"+F,nb="tick"+F,Wc="touchcancel"+ja,Vc="touchend"+ja,Mc="touchstart"+F,Tc="touchmove"+ja,pc="resize"+F,P="",A=" ",na=",",Qa="absolute",Ob="block",Da="@CDN@",ta="div",rc="hand",Tb="head",zb="html",ka="id",Xa="img",Zb="jquery."+z,lb="none",tb="object",wb="string",Ic=[D,L,Za,Ka,Eb,W,$a,Fb],Ac={W:D,H:L},uc=ad?Dc("CAAIAIAAAAAAAAAAACH5BAEAAAAALAAAAAAIAAgAAAIHhI+py+1dAAA7"):Da+"blank.gif",Kc=Ea(Da+Zb+".cur")+na+"move",Jc=Ea(Da+Zb+"-drag.cur")+
na+"move",Lc=Ea(Da+Zb+"-drag-down.cur")+na+"move";n.lazy=n.re.lazy_agent.test(X);var Sc=Ba&&Z<9?1:0,bd=k.cleanData;k.cleanData=function(f){k(f).each(function(){k(this).triggerHandler("clean")});return bd.apply(this,arguments)};k.extend(k.fn,n.fn)&&k(n.scan);return n}}(jQuery,window,document)});

/* inclusion of authentication.js from /services/js/authentication/authentication.js */

function AXZAuthenticator(rawCookie) {
    var debug = function(key, value) {
        // console.log(key + ' ' + value);
    }

    function trim(str, chars) {
        return ltrim(rtrim(str, chars), chars);
    }

    function ltrim(str, chars) {
        chars = chars || "\\s";
        return str.replace(new RegExp("^[" + chars + "]+", "g"), "");
    }

    function rtrim(str, chars) {
        chars = chars || "\\s";
        return str.replace(new RegExp("[" + chars + "]+$", "g"), "");
    }

    /*
     * Provides a convenient way to override the cookie for test cases
     */
    if (!rawCookie) {
        rawCookie = document.cookie;
    }

    var AUTHENTICATION_COOKIE_NAME = "AXZAuthCookie";
    var getAllCookies = function() {
        var allCookies = new Object();

        var ca = rawCookie.split(';');
        for ( var i = 0; i < ca.length; i++) {
            var c = ca[i];

            var cookieName = trim(c.substring(0, c.indexOf("=")));
            var cookieValue = trim(c.substring(c.indexOf("=") + 1, c.length));
            cookieValue = cookieValue.replace(/\"/g, "");
            debug(cookieName, cookieValue);
            allCookies[cookieName] = cookieValue;
        }
        return allCookies;
    };

    var authCookie = (function() {
        var cookie = getAllCookies()[AUTHENTICATION_COOKIE_NAME];
        if (cookie && cookie.length > 20) {
            return cookie;
        }
    })();

    debug('authCookie', authCookie);

    var AZ_PLAN = "AZ";
    var FNX_PLAN = "FNX";
    var PRX_PLAN = "PRX";
    var SPX_PLAN = "SPX";
    var MSRP = "MSRP";
    var INVALID_PLAN = "Invalid Plan Identifier";

    /**
     * Constants for various plan types
     */
    this.AZ_PLAN = AZ_PLAN;
    this.FNX_PLAN = FNX_PLAN;
    this.PRX_PLAN = PRX_PLAN;
    this.SPX_PLAN = SPX_PLAN;
    this.MSRP = MSRP;
    this.INVALID_PLAN = INVALID_PLAN;

    /*
     * This function get the Plan Identifier
     */
    this.getPlanTypeForServices = function() {
        if (authCookie) {
            var planIdentifier = authCookie.substr(0, 10);
            var arrPlanIdentifier = planIdentifier.split("");
            var planCharIndex = parseInt(arrPlanIdentifier[0]);
            if (!this.validateCheckSum(arrPlanIdentifier, planCharIndex)) {
                return this.INVALID_PLAN;
            }
            if (arrPlanIdentifier[planCharIndex] === '1') {
                return this.AZ_PLAN;
            } else if (arrPlanIdentifier[planCharIndex] === '2') {
                return this.FNX_PLAN;
            } else if (arrPlanIdentifier[planCharIndex] === '3') {
                return this.PRX_PLAN;
            } else if (arrPlanIdentifier[planCharIndex] === '4') {
                return this.SPX_PLAN;
            } else {
                return MSRP;
            }
        } else {
            return MSRP;
        }
    }

    this.validateCheckSum = function(arrPlanIdentifier, planCharIndex) {
        var palnNum = parseInt(arrPlanIdentifier[planCharIndex]);
        var sum = 0;
        for (i = 0; i < arrPlanIdentifier.length; i++) {
            if (0 == i || planCharIndex == i)
                continue;
            sum += parseInt(arrPlanIdentifier[i])
        }
        var mod = sum % 10;
        var expectedMod = (planCharIndex + palnNum) % 10;
        if (expectedMod != mod) {
            return false;
        }

        return true;
    }

    /*
     * This is the only public method exposed by this object. The planType
     * parameter can be passed AS-IS to the services.
     */
    this.getPlanType = function() {
        return this.getPlanTypeForServices();
    }

    this.getPlanTypeForDisplay = function() {
        var planType = this.getPlanTypeForServices();
        if (planType === this.AZ_PLAN) {
            return 'A/Z Plan';
        } else if (planType === this.FNX_PLAN || planType === this.PRX_PLAN
            || planType === this.SPX_PLAN) {
            return 'X Plan';
        } else if (planType == this.INVALID_PLAN) {
            return 'Invalid Plan';
        } else {
            return 'MSRP';
        }
    };
}

function ThirdPartyAuthenticator() {
    // Save and Share js
    // BSR integration updates
    var context = FD.Brand.Context;
    var CDR_PROFILE_COOKIE_NAME = (context && context.settings && context.settings.env === 'prod') ? "cdrProfile" : "cdrProfile_qa";
    //var CDR_PROFILE_COOKIE_NAME = "cdrProfile_qa";
    var ACCESSTOKEN_COOKIE_NAME = "accessToken";
    var PROFILE_ID_COOKIE_NAME = "cdrprofileid";
    var PROVIDER_COOKIE_NAME = "cdrprofileprovider";
    var CREATION_STATUS_COOKIE_NAME = "profilecreationstatus";
    var CONSUMER_ID_COOKIE_NAME = "consumerId";
    var TIMESTAMP_COOKIE_NAME = "timestamp";
    var LHSESSIONID_COOKIE_NAME = "lhSessionId";
    var DOMAIN_NAME = ".ford.com";
    var COOKIE_PATH = "/";
    var POPUP_FEATURES = "height=250,width=400,status=no,location=no,toolbar=no,directories=no,menubar=no";
    var POPUP_NAME = "versataPopUp";

    this.getAuthWindow = function(redirectUrl) {
        url = '/debug/thirdparty.jsp?redirectUrl=' + redirectUrl/*
         * document.location.host +
         * '/debug/redirect.jsp'
         */;
        features = POPUP_FEATURES;
        window[POPUP_NAME] = open(url, '', features);
    };
    this.popupCallback = function() {
        window[POPUP_NAME].close();
    };
    this.logoutUser = function() {
        deleteCookie(CDR_PROFILE_COOKIE_NAME, COOKIE_PATH, getDomainName());
        //deleteCookie(PROFILE_ID_COOKIE_NAME, COOKIE_PATH, getDomainName());
        //deleteCookie(PROVIDER_COOKIE_NAME, COOKIE_PATH, getDomainName());
        //deleteCookie(CREATION_STATUS_COOKIE_NAME, COOKIE_PATH, getDomainName());
    };

    function getCDRProfileCookie() {
        var start = document.cookie.indexOf(CDR_PROFILE_COOKIE_NAME + "=");
        var len = start + CDR_PROFILE_COOKIE_NAME.length + 1;
        if ((!start) && (CDR_PROFILE_COOKIE_NAME != document.cookie.substring(0, CDR_PROFILE_COOKIE_NAME.length))) {
            return null;
        }

        if (start == -1)
            return null;

        var end = document.cookie.indexOf(";", len);
        if (end == -1)
            end = document.cookie.length;

        return(unescape(document.cookie.substring(len, end)));
    }

    function getCookie(name) {
        //Get the cdrProfile cookie
        var cdrProfileCookieValue = getCDRProfileCookie();

        if(cdrProfileCookieValue == null || cdrProfileCookieValue == "" || cdrProfileCookieValue == "null") {
            return null;
        }
        if(name == CDR_PROFILE_COOKIE_NAME) {
            return unescape(cdrProfileCookieValue);
        }
        var start1 = cdrProfileCookieValue.indexOf(name + "=");
        var len1 = start1 + name.length + 1;
        if ((!start1) && (name != cdrProfileCookieValue.substring(0, name.length))) {
            return null;
        }
        if (start1 == -1)
            return null;
        var end1 = cdrProfileCookieValue.indexOf("|", len1);
        if (end1 == -1)
            end1 = cdrProfileCookieValue.length;
        return unescape(cdrProfileCookieValue.substring(len1, end1));
    }

    function deleteCookie(name, path, domain) {
        if (getCookie(name))
            document.cookie = name + "=" + ((path) ? ";path=" + path : "")
                + ((domain) ? ";domain=" + domain : "")
                + ";expires=Thu, 01-Jan-1970 00:00:01 GMT";
    }
    function getDomainName() {
        var domainName = document.location.host;
        var urlParts;
        if (domainName.indexOf(".", 0) > 0) {
            domainName = domainName.split(":")[0];
            urlParts = domainName.split(".");
            domainName = "." + urlParts[urlParts.length - 2] + "."
                + urlParts[urlParts.length - 1];
        } else {
            domainName = ".ford.com";
        }
        return domainName;
    }
    this.getUserId = function() {
        return getCookie(PROFILE_ID_COOKIE_NAME);
    };
    this.getAccessToken = function() {
        return getCookie(ACCESSTOKEN_COOKIE_NAME);
    };
    this.getProvider = function() {
        return getCookie(PROVIDER_COOKIE_NAME);
    };
    this.getProfileStatus = function() {
        return getCookie(CREATION_STATUS_COOKIE_NAME);
    };
    this.getConsumerId = function() {
        return getCookie(CONSUMER_ID_COOKIE_NAME);
    };
    this.getTimestamp = function() {
        return getCookie(TIMESTAMP_COOKIE_NAME);
    };
    this.getLHSessionId = function() {
        return getCookie(LHSESSIONID_COOKIE_NAME);
    };

}
;(function(win, $) {
    'use strict';

    if(!FD.Brand.Ext) {
        // save internal reference to our version of lodash
        var lodash = _.noConflict();
        FD.Brand.lodash = lodash;
        // if lodash not previously defined, define it so other applications loading lodash from pantry can use it
        if (lodash.isUndefined(window._)) {
            window._ = lodash;
        }
    } else {
        FD.Brand.lodash = FD.Brand.Ext.util.lodash;
    }

    $(init);

    //////

    function init() {
        $('html').addClass('fgx-brand-' + FD.Brand.Context.make);

        if(($('body').hasClass('cq-wcm-preview') || $('body').hasClass('cq-wcm-edit') || $('body').hasClass('cq-wcm-design')) && (FD.Brand.Context.settings && !FD.Brand.Context.settings.syn)){
            $('body').addClass('fgx-pantry-bootstrap');
            $('body').addClass('fgx-brand-css');
        }

        FD.Brand.initComponent('body');
        if(FD.Brand.Angular) {
            FD.Brand.Angular.bootstrap();
        }

    }

})(window, jQuery);

(function($) {

    // jQuery extension to find matching elements including the current element
    $.fn.findAll = function(selector) {
        var result = this.find(selector);
        return (this.is(selector)) ?
            result.add(this) : result;
    };

})(jQuery);


/*global FD*/
(function(win, $, _, brand, context) {

    // utility library
    _.extend(brand.namespace('FD.Brand.Util', win), {
        addMoreLink: addMoreLink,
        updateMoreLink: updateMoreLink,
        moreLessInit: moreLessInit,
        ctaHover: ctaHover,
        swapColors: swapColors,
        currentBreakpoint: currentBreakpoint,
        currentBreakpointXS: currentBreakpointWithXS,
        log: log,
        toArray: toArray,
        objPath: objPath,
        objPathAsArray: objPathAsArray,
        inViewport: inViewport,
        cookie: {
            get: getCookie,
            set: setCookie,
            remove: removeCookie
        },
        parameters: {
            encode: encodeParameters,
            decode: decodeParameters
        },
        url: {
            queryString: queryString,
            loadAsScript: loadScript,
            loadAsStyle: loadStyle,
            extension: extension,
            protocol: protocol,
            prepend: prependToUrl,
            urlObject: urlObject,
            allowScript: allowScript
        },
        dateTime: {
            longFormat: longDateFormat
        },
        env: {
            browser: getBrowserInfo,
            geoLocation: function() {
                return _hasGeoLocation;
            },
            touch: function() {
                return _touchEnabled;
            }
        },
        images: {
            load: loadImages,
            renditionUrl: getRenditionUrl,
            stripRenditionUrl: stripRenditionUrl,
            renderPicture: renderPicture,
            defaultSource: retrieveDefaultSource,
            currentSource: getCurrentSource
        },
        video: {
            addRefTag: addRefTag,
            loadVideos: loadVideos,
            loadVideosInViewport: loadVideosInViewport
        },
        accordion: {
            update: updateAccordion
        },
        carousel: {
            swipe: carouselSwipe
        },
        distance: {
            betweenCoords: getDistanceBetweenCoords
        },
        window: {
            scrollTo: windowScrollTo
        },
        htmlString: {
            encode: encodeHtml,
            decode: decodeHtml
        },
        str: {
            firstInstance: retrieveFirstInstance,
            toObject: convertToObject,
            trimFromEnd: trimFromEnd
        },
        vdm: {
            displayName: getVdmDisplayName
        },
        mainNav: {
            get: getMainNav,
            setFullWidth: setFullWidthMainNav
        },
        debounce: debounce
    });

    var _mbpEl = null,
        _hasGeoLocation = false,
        _touchEnabled = (('ontouchstart' in win) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0)),
        _mainNavData = {
            Ford: {
                selectors: '.fordMainNavigation',
                currentCls: 'fordMainNavigation',
                $el: null
            },
            Lincoln: {
                selectors: '.lincolnMainNavigation',
                currentCls: 'lincolnMainNavigation',
                $el: null
            }
        }[(context && context.make) || 'Ford'],
        _mainNavSelectors = _mainNavData.selectors;

    _mbpEl = document.querySelector('.mbp-test');
    if(!_mbpEl) {
        _mbpEl = document.createElement('div');
        _mbpEl.classList.add('mbp-test');
        document.body.appendChild(_mbpEl);
    }

    _hasGeoLocation = false;
    if (window.navigator.geolocation) {
        if(window.navigator.permissions && window.navigator.permissions.query) {
            // check permission to handle Chrome ver 50+ which disables geolocation on HTTP
            window.navigator.permissions.query({
                name:'geolocation'
            }).then(function(p) {
                if(p.state !== 'denied') {
                    _hasGeoLocation = true;
                }
            })
        } else {
            // permissions API not available on IE, but geo locate should be available if detected
            // but only if we're https
            if (protocol().get() === 'https://') {
                _hasGeoLocation = true;
            }
        }
    }
    
    // focusout listener for custom dropdown elements
    $('body').on('focusout', '[data-fgx-dd-close-on-focusout]', dropdownCloseOnFocusOut);
    function dropdownCloseOnFocusOut(ev) {
        window.setTimeout(function(){
            var $active = $(document.activeElement);
            if ($active.closest('.fgx-custom-select').length <= 0) {
                // we know we're off any dropdown, close any that are open
                $('.fgx-custom-select[aria-expanded="true"] .fgx-custom-select-container').removeClass('shown');
                $('.fgx-custom-select[aria-expanded="true"] .fgx-custom-select-dropdown').removeClass('shown');
                $('.fgx-custom-select[aria-expanded="true"]').attr('aria-expanded', 'false');
            } else {
                var $dropdown = $active.closest('.fgx-custom-select');
                var $listElements = $('li', $dropdown);
                var activeId = $active.attr('id');
                var matchFound = false;
                if ($active.attr("class") !== 'fgx-custom-list-options' && activeId !== $dropdown.attr('id')) {
                    $listElements.each(function(){
                        $li = $(this);
                        if (activeId === $li.attr('id')) {
                            matchFound = true;
                        }
                    });
                    if (!matchFound) {
                        // we're not on an options list or the original dropdown and we got here so none of our <li> ids match...close this dropdown.
                        $('.fgx-custom-select[aria-expanded="true"] .fgx-custom-select-container').removeClass('shown');
                        $('.fgx-custom-select[aria-expanded="true"] .fgx-custom-select-dropdown').removeClass('shown');
                        $('.fgx-custom-select[aria-expanded="true"]').attr('aria-expanded', 'false');
                    }
                }
            }
        }, 250);
    }


    /**
     * @param content - The content to search through
     * @param charLimit - The original character limit
     * @returns a new character limit to be used
     * Check if we are in the middle of an html tag with the current charLimit
     *
     */
    function checkForHtml(content, charLimit) {
        var initial = content.substr(0, charLimit);
        var inTag = false;
        var addToEnd = 0; //Number of characters needed to get out of current html tag.
        var firstOpen = initial.indexOf('<');

        //Now check for an opening tag in the initial section
        if(firstOpen >= 0) {
            // if loop through the characters starting from the end, then we can
            // look for both a '<' and '>'. If we come across a '<' without
            // seeing a '>' first, then we are in a tag. If we are in a tag, then
            // we need to get out of it before continuing.
            for(var i = (charLimit - 1); i > 0; i--) {
                if(initial[i] === '<') {
                    inTag = true;
                    break;
                } else if(initial[i] === '>') {
                    inTag = false;
                    break;
                }
            }
            if(inTag) {
                for(var k = charLimit; k < content.length; k++) {
                    if(content[k] === '>') {
                        inTag = false;
                        addToEnd = ((k + 1) - charLimit);
                        break;
                    }
                }
                charLimit += addToEnd;
            }
        }
        return charLimit;
    }

    /**
     * @param components - The jQuery object that represents the element/component to make these updates in. (required)
     * @param charLimit - The character limit that should be allowed before the 'add more' link is added
     * @param selector - optional selector to add the 'more' link to
     *
     * Modifies the html at the given selector to add a '...more' link if the content exceeds the specified 'charLimit'.
     * This also adds the click event needed to show/hide the desired text.
     */
    function addMoreLink(components, charLimit, selector) {
        //Text should show the 'more' link if > 3 lines.
        var charLimit = charLimit || 100,
            selector = selector || '.description',
            linkSelector = selector + ' a.read_more',
            moreText = "...more",
            lessText = "...less";
        $(selector, components).each(function() {
            var content = $(this).html();
            if(content.length > charLimit) {
                charLimit = checkForHtml(content, charLimit);
                var initial = content.substr(0, charLimit),
                    hidden = content.substr(charLimit, content.length - charLimit),
                    html = "<span class='initial_desc'>" + initial + "</span><span class='more_text'>" + hidden + "</span><span><a href='#' class='read_more'>" + moreText + "</a></span>";

                $(this).html(html);
            }
        });

        $(linkSelector, components).click(function(event) {
            event.preventDefault();
            if($(this).hasClass("less")) {
                $(this).removeClass("less");
                $(this).html(moreText);
                $(this).parent().siblings('.more_text').removeClass("show-inline-force");
            } else {
                $(this).addClass("less");
                $(this).html(lessText);
                $(this).parent().siblings('.more_text').addClass("show-inline-force");
            }
        });
    }

    /**
     * @param components - The jQuery object that represents the element/component to make these updates in. (required)
     * @param charLimit - The new character limit that should be allowed before the 'add more' link is added
     * @param selector - optional selector to add the 'more' link to
     *
     * Resize the number of characters that are displayed before read_more
     */
    function updateMoreLink(components, charLimit, selector) {
        var selector = selector || '.description';
        $(selector, components).each(function() {
            var initial = $(this).children('.initial_desc').html();
            var hidden = $(this).children('.more_text').html();
            var content = initial + hidden;

            if(content.length > charLimit) {
                charLimit = checkForHtml(content, charLimit);
                $(this).find('.read_more').removeClass('hidden');
                $(this).children('.more_text').removeClass('hidden');
                initial = content.substr(0, charLimit);
                hidden = content.substr(charLimit, content.length - charLimit);
                $(this).children('.initial_desc').html(initial);
                $(this).children('.more_text').html(hidden);
            } else {
                $(this).find('.read_more').addClass('hidden');
                $(this).children('.more_text').addClass('hidden');
                $(this).children('.more_text').html('');
                $(this).children('.initial_desc').html(content);
            }
        });
    }

    function moreLessCheckHeight(actual, visible, link) {
        if(actual > visible) {
            link.find("span.mlspanless").hide();
            link.find("span.mlspanmore").show();
            link.show();
            return true;
        } else {
            link.hide();
            return false;
        }
    }

    /**
     * @param components - The jQuery object that represents the element/component to make these updates in. (required)
     * @param setupClickHandler - Boolean to indicate if the link click handler needs to be added or not. (required)
     * @param height - The height (in em) that should be allowed before the 'add more' link is added
     * @param selector - optional selector to add the 'more' link to
     *
     * Modifies the html at the given selector to show/hide a '...more' link if the content exceeds the specified height.
     * This also adds the click event needed to show/hide the desired text if the 'setupClickHandler' value is true.
     */
    function moreLessInit(components, setupClickHandler, height, lineHeight, selector) {
        var selector = selector || '.ml-wrapper',
            height = height || 3,
            //lineHeight = lineHeight || 1.15;
            lineHeight = $("html").hasClass("fgx-brand-Ford") ? (lineHeight || 1.15) : 1.6;

        height = (height * lineHeight) + "em";
        //height = height + "em";

        $(selector, components).each(function() {
            var $wrap = $(this),
                $link = $wrap.children(".mllink"),
                $content = $wrap.children(".mltext"),
                visibleHeight,
                actualHeight,
                $carouselItem;

            // If part of a carousel and its hidden, then we need to add a workaround to get the height.
            if($wrap.closest(".carousel").length === 1 && !$content.is(":visible")) {
                $carouselItem = $wrap.closest(".item");
                $carouselItem.addClass("hiddenHeight");
            }

            $content.css("height",height);
            $content.removeClass("mltext-more");
            visibleHeight = $content[0].clientHeight;
            actualHeight = $content[0].scrollHeight - 1;

            if($carouselItem && $carouselItem.hasClass("hiddenHeight")) { $carouselItem.removeClass("hiddenHeight"); }

            //Only show if height is greater - may need to add authorable buffer.
            if(!moreLessCheckHeight(actualHeight, visibleHeight, $link)) {
                $content.addClass("mltext-more");
            } else {
                $content.removeClass("mltext-more");
            }

            if(setupClickHandler) {
                $link.on("click", function() {
                    $content.toggleClass("mltext-more");
                    $link.find("span.mlspanmore").toggle();
                    $link.find("span.mlspanless").toggle();
                    return false;
                });
            }
        });
    }

    /**
     * @param elm - The jQuery object containing the set of button elements hover should be applied to.
     *
     * Setup a listener to call swapColors when the element is hovered.
     */
    function ctaHover(elm) {
    //dont want to block swapColors if .default-hover detected on Lincoln, so separate cases
        elm.each(function() {
            if ( !$('html').hasClass('fgx-brand-Lincoln') && !$(this).hasClass('default-hover') ) {
                $(this).hover(function() {
                    swapColors.call(this);
                }, function() {
                    swapColors.call(this);
                });
            }
        });
    }

    /**
     * Swap the backgroundColor and the textColor
     * This needs to be called using .call so 'this' gets set properly.
     */
    function swapColors() {
        var currBackground = $(this).css('backgroundColor'),
            currColor = $(this).css('color');
        $(this).css('color', currBackground);
        $(this).css('backgroundColor', currColor);
    }


    /**
     * get the uiBreakpoint
     */
    function currentBreakpoint() {

        _mbpWdth = _mbpEl.offsetWidth;

        if(_mbpWdth < 768) {
            return 'gux-bkpt-sm';
        } else if (_mbpWdth < 992) {
            return 'gux-bkpt-med';
        } else if (_mbpWdth < 1200) {
            return 'gux-bkpt-lg';
        } else {
            return 'gux-bkpt-xlg';
        }

    }

    /**
     * get the uiBreakpoint with extra small as an option to distinguish between mobile breakpoints
     */
    function currentBreakpointWithXS() {
        _mbpWdth = _mbpEl.offsetWidth;

        if(_mbpWdth < 480) {
            return 'gux-bkpt-xs';
        } else if(_mbpWdth < 768) {
            return 'gux-bkpt-sm';
        } else if (_mbpWdth < 992) {
            return 'gux-bkpt-med';
        } else if (_mbpWdth < 1200) {
            return 'gux-bkpt-lg';
        } else {
            return 'gux-bkpt-xlg';
        }
    }

    /**
     * Return cookie value
     * @param name
     * @param decode
     * @returns {*}
     */
    function getCookie(name, decode) {
        var val = null;
        _.each((document.cookie || '').split('; '), function(ck) {
            var p = ck.indexOf('=');
            if(ck.substring(0, p) === name) {
                val = ck.substring(p + 1);
                if(decode) {
                    val = decodeURIComponent(val);
                }
                return false;
            }
        });
        return val;
    }

    /**
     * Set cookie value
     * @param name
     * @param value
     * @param opt { expires: Date, path: String, domain: String, secure: Boolean, encodeValue: Boolean }
     */
    function setCookie(name, value, opt) {
        var ck = [ encodeURIComponent(name), '=', (opt.encodeValue) ? encodeURIComponent(value) : value],
            dt;
        if(opt.expires) {
            if(!_.isDate(opt.expires)) {
                var dt = new Date();
                dt.setTime(dt.getTime() + (opt.expires * 24 * 60 * 60 * 1000));
            } else {
                dt = opt.expires;
            }
            ck.push('; expires=' + dt.toUTCString());
        }
        if(opt.path) {
            ck.push('; path=' + opt.path);
        }
        if(opt.domain) {
            ck.push('; domain=' + opt.domain);
        }
        if(opt.secure) {
            ck.push('; secure');
        }
        document.cookie = ck.join('');
    }

    /**
     * Remove cookie
     * @param name
     */
    function removeCookie(name) {
        setCookie(name, null, { expires: new Date('Thu, 01 Jan 1970 00:00:00 GMT')});
    }

    /**
     * Return parameters as URI encoded query string
     * @param param
     * @param enc
     * @returns {*}
     */
    function encodeParameters(param, enc) {
        var lst = [];
        _.each(param, function(v, k) {
            lst.push(encodeURIComponent(k) + '=' + encodeURIComponent(v));
        });
        var val = lst.join('&');
        if(enc) {
            var val2 = [], j = Math.floor(Math.random() * 223 + 33);
            val2.push(String.fromCharCode(j));
            for(var i = 0; i < val.length; i++) {
                j = val.charCodeAt(i) ^ j & 255;
                val2.push(String.fromCharCode(j));
            }
            val = btoa(val2.join(''));
        }
        return val;
    }

    /**
     * Return parameters decoded from URI encoded query string
     * @param str
     * @returns {Mixed|*}
     */
    function decodeParameters(str) {
        var param = {};
        _.each((str || '').split('&'), function(kv) {
            var p = kv.indexOf('=');
            if(p >= 0) {
                param[decodeURIComponent(kv.substring(0, p))] = decodeURIComponent((kv.substring(p + 1)));
            }
        });
        return param;
    }

    /**
     * Query string parser/ builder
     * @param str
     * @returns {queryStringHelper}
     */
    function queryString(str) {
        return new queryStringHelper(decodeParameters((str || window.location.search || '').substring(1)));

        function queryStringHelper(prm) {
            var _this = this,
                _prm = prm;

            _this.add = add;
            _this.remove = remove;
            _this.asObject = asObject;
            _this.asString = asString;
            _this.addToUrl = addToUrl;

            return _this;

            /**
             * Add parameters to query string
             * If prm is an object, key/value pairs from object are added to query string parameters
             * If prm is a string it is used as the key with val as the value of the new added parameter
             * @param prm
             * @param val
             * @returns {queryStringHelper}
             */
            function add(prm, val) {
                if (_.isObject(prm)) {
                    _prm = _.extend(_prm, prm);
                } else {
                    _prm[prm] = val;
                }
                return _this;
            }

            /**
             * Remove parameters from query string
             * keys parameter can be a single string or an array of strings
             * @param keys
             * @returns {queryStringHelper}
             */
            function remove(keys) {
                _prm = _.omit(_prm, _.isArray(keys) ? keys : [keys]);
                return _this;
            }

            /**
             * Returns current list of query string parameters as object
             * @returns {*}
             */
            function asObject() {
                return _prm;
            }

            /**
             * Returns query string parameters as encoded query string
             * @returns {string}
             */
            function asString() {
                var str = encodeParameters(_prm);
                return ((str.length > 0) ? '?' : '') + str;
            }

            /**
             * Returns passed in url with the encoded query string parameters appended to it
             * @param url - url to append the query string to
             * @returns {string}
             */
            function addToUrl(url) {
                var output = '';
                if(url && typeof(url) !== 'undefined') {
                    var qsPos = url.indexOf('?');
                    var urlBase = url;
                    if(qsPos >= 0) {
                        var str = url.substring(qsPos);
                        var qs = brand.Util.url.queryString(str);
                        urlBase = url.substring(0, qsPos);
                        _this.add(qs.asObject());
                    }
                    output = urlBase + _this.asString();
                }
                return output;
            }
        }

    }

    function loadScript(src, attrs, preserveElement) {
        var head = (document.getElementsByTagName('head')[0] || document.documentElement),
            scr = document.createElement('script'),
            done = false,
            def = $.Deferred();
        scr.onload = scr.onreadystatechange = function () {
            if(!done && (!this.readyState || this.readyState == 'loaded' || this.readyState == 'complete')) {
                done = true;
                scr.onload = scr.onreadystatechange = null;
                if(head && scr.parentNode && !preserveElement) {
                    head.removeChild(scr);
                }
                scr = undefined;
                def.resolve();
            }
        };
        scr.onerror = function() {
            def.reject();
        };
        head.appendChild(scr);
        scr.setAttribute('type', 'text/javascript');
        if(attrs) {
            _.forEach(attrs, function (n, key) {
                scr.setAttribute(key, n);
            });
        }
        scr.setAttribute('src', src);
        return def.promise();
    }

    function loadStyle(src) {
        var styleLink = $('<link>').attr({
                rel: 'stylesheet',
                type: 'text/css',
                href: src
            });
        $('head').append(styleLink);
    }

    function protocol(url) {
        return new protocolHelper(url || window.location.href || '');

        function protocolHelper(url) {
            var _this = this;
            var _url = url;
            _this.get = get;
            _this.set = set;
            _this.remove = remove;
            _this.url = function() {
                return _url;
            };

            function get() {
                var r = _url.match(/^(https?:)?\/\//i);
                return r ? r[0] : '';
            }

            function set(protocol) {
                protocol = protocol || (window.location.protocol + '//');
                remove();
                _url = protocol + _url;
                return _this;
            }

            function remove() {
                _url = _url.replace(/^(https?:|)\/\//, '');
                return _this;
            }
        }
    }

    function extension(str) {
        return new extensionHelper((str || location.pathname || ''));

        function extensionHelper(prm) {
            var _this = this,
                _prm = prm;

            _this.remove = remove;
            _this.removeSpecified = removeSpecified;

            return _this;

            /**
             * Remove the extension
             * @returns {string}
             */
            function remove() {
                _prm = _prm.replace(/\.[^/.]+$/, "");
                return _prm;
            }

            /**
             * Remove the specified extension
             * The full extension needs to be passed in to work properly.
             * @param ext
             * @returns {string}
             */
            function removeSpecified(ext) {
                var pos = (_prm.length - ext.length);

                if(_prm.substr(pos) === ext) {
                    _prm = _prm.substr(0, pos);
                }

                return _prm;
            }

        }
    }

    function prependToUrl(url, str) {
        return (url.indexOf(str) !== 0) ? str + url : url;
    }

    /**
     * URL string parser/ builder
     * @param str
     * @returns {urlObjectHelper}
     */
    function urlObject(url) {
        return new urlObjectHelper((url || window.location.href || ''));

        function urlObjectHelper(url) {
            var _this = this,
                _originalUrlStr = url,
                _anchor = document.createElement('a'),
                _isSmartLink = !!(_originalUrlStr.substr(0, 2) === '#$'),
                _smartLinkBase = _originalUrlStr,
                _skipUpdate = checkSkipUpdate();

            _anchor.href = _originalUrlStr;
            if(_isSmartLink) {
                var qsPos = _originalUrlStr.indexOf('?');
                if(qsPos > -1) {
                    _smartLinkBase = _smartLinkBase.substring(0, qsPos);
                    _anchor.search = _originalUrlStr.substring(qsPos);
                } else {
                    _anchor.search = ' ';
                }
            }

            _this.isSmartLink = _isSmartLink;
            _this.skipUpdate = _skipUpdate;
            _this.getHash = getHash;
            _this.setHash = setHash;
            _this.qs = brand.Util.url.queryString(_anchor.search || ' ');
            _this.url = getUrl;
            _this.anchor = function() {
                return _anchor;
            }

            function getHash() {
                return _anchor.hash.substring(1);
            }

            function setHash(_hash, extend) {
                extend = extend || false;
                if(_hash && typeof(_hash) !== 'undefined') {
                    _anchor.hash = (extend) ? (_anchor.hash + _hash) : _hash;
                }
            }

            function getUrl() {
                if (_this.skipUpdate) {
                    return _originalUrlStr;
                }
                // Need to update the search property with the latest from the qs object in case that has been updated
                // using the qs.add functionality.
                _anchor.search = _this.qs.asString();

                // Using the anchor.href will return a fully quantified URL which will break smartLinks, so if we have a
                // smartLink we should just return the base and the queryString if one was added.
                return (_this.isSmartLink) ? (_smartLinkBase + _anchor.search) : _anchor.href;
            }

            function checkSkipUpdate() {
                return (!_isSmartLink && (_originalUrlStr.slice(0, 1) === '#' || _originalUrlStr.indexOf('javascript:void(0)') === 0));
            }

            return _this;
        }
    }

    function longDateFormat(dt) {
        var dt = dt || new Date();
        var template = {
            'en_us': '<%- MMMM %> <%- d %>, <%- y %>',
            'es_us': '<%- d %> de <%- MMMM %> de <%- y %>',
            'en_ca': '<%- MMMM %> <%- d %>, <%- y %>',
            'fr_ca': '<%- d %> <%- MMMM %> <%- y %>'
        }[context.locale];
        return (_.template(template))({
            MMMM: context.localizedMonthNames[dt.getMonth()],
            d: dt.getDate(),
            y: dt.getFullYear()
        });
    }

    function getBrowserInfo() {
        var ua = navigator.userAgent,
            tem, M = ua.match(/(android|opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
        if (/trident/i.test(M[1])) {
            tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
            return {
                name: 'IE ',
                version: (tem[1] || '')
            };
        }
        if (M[1] === 'Chrome') {
            tem = ua.match(/\bOPR\/(\d+)/)
            if (tem !== null) {
                return {
                    name: 'Opera',
                    version: tem[1]
                };
            }
        }
        M = M[2] ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
        if ((tem = ua.match(/version\/(\d+)/i)) !== null) {
            M.splice(1, 1, tem[1]);
        }
        return {
            name: M[0].toLowerCase(),
            version: parseInt(M[1],10)
        };
    }

    function log() {
        if(win.console && console.log) {
            if(console.log.apply) {
                console.log.apply(console, arguments);
            } else {
                for(var i=0; i < arguments.length; i++) {
                    console.log(arguments[i]);
                }
            }
        }
    }

    function toArray(ar) {
        return (ar == null) ? null : ($.isArray(ar) ? ar : [ ar ]);
    }

    function objPath(obj, path) {
        var p = (path || '').split('.');
        for(var i = 0; i < p.length; i++) {
            var n = p[i];
            if(n.length == 0 || typeof(obj[n]) === 'undefined') {
                return null;
            }
            obj = obj[n];
        }
        return obj;
    }

    function objPathAsArray(obj, path) {
        return toArray(objPath(obj, path) || []);
    }

    function loadImages(elm) {
        //This is needed to load the Images in the overlay on IE.

        // Only continue if picture is not supported.
        if ( win.HTMLPictureElement ) {
            return;
        }

        var imgs = getAllImages(elm),
            opts = {
                elements: imgs
            };
        win.picturefill(opts);
    }

    function getAllImages(elm) {
        // This comes from picturefill, but slightly modified to only check for images in the mediaOverlay.
        var elems = [],
            imgs = $('img', elm);

        for ( var h = 0, len = imgs.length; h < len; h++ ) {
            var currImg = imgs[ h ];

            if ( currImg.parentNode.nodeName.toUpperCase() === "PICTURE" ||
            ( currImg.getAttribute( "srcset" ) !== null ) || currImg[ "picturefill" ] && currImg[ "picturefill" ].srcset !== null ) {
                elems.push( currImg );
            }
        }
        return elems;
    }

    function getRenditionUrl(sourceUrl, rendition) {
        return sourceUrl && sourceUrl + '/jcr:content/renditions/' + (rendition || 'original' + sourceUrl.substring(sourceUrl.lastIndex('.')));
    }

    function stripRenditionUrl(url) {
        var index1 = url.indexOf("/jcr:content/renditions/"),
            index2 = url.indexOf("/_jcr_content/renditions/"),
            index = (index1 > -1) ? index1 : index2;
        if(index > -1) {
            url = url.substring(0, index);
        }
        return url;
    }

    /**
     * nullAlt - When this parameter is true, the alt tag of the image will be set to an empty string regardless of the authored value.
     */
    function renderPicture(image, view, override, nullAlt) {
        var sources = image && (view && image.views && image.views[view]) || override || image && image.sources || [];
        var $picture = $('<picture/>');
        var defaultSource = sources[0];
        _.each(sources, function(source) {
            if(source.breakpoint > 0) {
                $('<source/>')
                    .attr('data-srcset', source.src)
                    .attr('media', '(min-width: ' + source.breakpoint + 'px)')
                    .appendTo($picture);
                if(source.defaultSource) {
                    defaultSource = source;
                }
            }
        });
        if(defaultSource) {
            var _nullAlt = (nullAlt || image.altTag === '#NULL#') || false;
            $('<img/>')
                .attr('data-srcset', defaultSource.src)
                .addClass('lazyload')
                .addClass(image.className)
                .attr('alt', (!_nullAlt && image.altTag || '').trim())
                .appendTo($picture);
        }
        return $picture;
    }

    function retrieveDefaultSource(image, view, override) {
        var sources = image && (view && image.views && image.views[view]) || override || image && image.sources || [];
        var defaultSource = sources[0];
        _.each(sources, function(source) {
            if(source.breakpoint > 0 && source.defaultSource) {
                defaultSource = source;
            }
        });
        return (!_.isEmpty(defaultSource)) ? defaultSource : null;
    }

    function getCurrentSource(image, view, override) {
        var sources = image && (view && image.views && image.views[view]) || override || image && image.sources || [],
            outputSource = sources[0] || {};
        if(sources && sources.length > 1) {
            var currWidth = $(win)[0].innerWidth,
                sortedSources = _.sortBy(sources, 'breakpoint');

            _.each(sortedSources, function(source) {
                if(source.breakpoint > 0 && source.breakpoint <= currWidth) {
                    outputSource = source;
                }
            });
        }
        return outputSource;
    }

    function addRefTag(videoId) {
        return (videoId.indexOf("ref:") > -1) ? videoId : ("ref:" + videoId);
    }

    function loadVideosInViewport($videos) {
        if(!$videos || $videos.length === 0) {
            return;
        }

        $videos.each(function() {
            var $video = $(this),
                initialized = $video.attr('data-fgx-video-initialized');
            if((initialized == 'false' || !initialized) && inViewport($video) && $video.css('display') != 'none' && $video.css('visibility') != 'hidden') {
                loadVideo($video);
            }
        });
    }

    function loadVideos($videos) {
        if(!$videos || $videos.length === 0) {
            return;
        }

        $videos.each(function() {
            var $video = $(this),
                initialized = $video.attr('data-fgx-video-initialized');
            if(initialized == 'false' || !initialized) {
                loadVideo($video);
            }
        });
    }

    function loadVideo($video) {
        var src = $video.attr('src'),
            fgxSource = $video.attr('data-fgx-src');

        if(src && typeof(src) != 'undefined') {
            return;
        }

        if(fgxSource && typeof(fgxSource) != 'undefined') {
            $video.attr('src', fgxSource);
            $video.attr('data-fgx-video-initialized', 'true');
            $video[0].load();
        }
    }

    /**
     * Check if the passed in jQuery element is within the current viewport
     * @returns boolean
     */
    function inViewport(elm) {
        if(!elm || !elm.length) {
            return false;
        }

        var $win = $(win),
            vp = {
                top: $win.scrollTop(),
                left: $win.scrollLeft()
            };

        vp.bottom = vp.top + $win.height();

        var elmBorder = elm.offset();
        elmBorder.bottom = elmBorder.top + elm.outerHeight(true);

        return !((elmBorder.bottom <= vp.top) || (elmBorder.top >= vp.bottom));
    }

    /**
     * Open / Close the accordion element that is passed in as well as close any other
     * accordion elements that are currently open within the same context.
     * @param elm - The current element that is to be updated (required)
     * @param components - The context this element should be found within (required)
     * @param headingSelector - Custom selector for the heading of the accordion. Default ".accordion-heading" (optional)
     * @param contentSelector - Custom selector for the content of the accordion. Default ".accordion-content" (optional)
     * @param initialLoad - Boolean value to indicate if the updateAccordion is being called on initial page load. If so the animation will be skipped.
     */
    function updateAccordion(elm, components, headingSelector, contentSelector, initialLoad, callback) {
        var $el = elm,
            hS = headingSelector || ".accordion-heading",
            hSOpen = hS + ".open",
            cS = contentSelector || ".accordion-content",
            cSOpen = cS + ".open",
            skipAnimation = (initialLoad) ? true : false;

        if(!$el || $el.length === 0 || !components || components.length === 0) {
            return;
        }

        if ($el.hasClass('open')) {
            $el.toggleClass('open');
            $el.attr('aria-expanded', 'false');
            $el.next(cS).toggleClass('open').addClass('hidden');
        } else {
            $(hSOpen, components).removeClass('open').attr('aria-expanded', 'false');
            $(cSOpen, components).removeClass('open').addClass('hidden');
            $el.toggleClass('open');
            $el.attr('aria-expanded', 'true');

            var events = 'animationend webkitAnimationEnd MSAnimationEnd transitionend webkitTransitionEnd';

            if(skipAnimation) {
                $el.next(cS).removeClass('hidden').show().toggleClass('open');
            } else {
                $el.next(cS).removeClass('hidden').show().toggleClass('open').one(events, function(){
                    $('html, body').animate({
                    //compensate for static navbar
                    scrollTop: $el.offset().top - $('.navbar-static-top').height()
                    }, 200);
                });
            }
        }
        // call our callback if we have one
        if (typeof callback != 'undefined') {
            callback.call($el);
        }
    }

    function carouselSwipe(el, fn) {
        //var hammerTime = new Hammer(el);
        /* NZ: Note - the touchAction value below should be converted to 'pan-y' to help restrict the unintended
         * vertical scrolling that happens when trying to horizontally swipe on mobile devices.
        */
        var hammerTime = new Hammer.Manager(el, {
            touchAction: 'auto',
            domEvents: true,
            inputClass: Hammer.SUPPORT_POINTER_EVENTS ? Hammer.PointerEventInput : Hammer.TouchInput,
            recognizers: [
                [Hammer.Swipe, {
                    direction: Hammer.DIRECTION_HORIZONTAL
                }]
            ]
        });
	    hammerTime.on('dragleft swipeleft dragright swiperight', function(ev) {
	        var hasSrcEvent = !!(ev && typeof(ev) != 'undefined' && ev.srcEvent);
	        switch(ev.type) {
                case 'swipeleft':
                case 'dragleft':
                    if(hasSrcEvent) {
                        ev.srcEvent.stopPropagation();
                    }
                    fn(el, 'next', ev);
                    break;
                case 'swiperight':
                case 'dragright':
                    if(hasSrcEvent) {
                        ev.srcEvent.stopPropagation();
                    }
                    fn(el, 'prev', ev);
                    break;
            }
	    });
    }

    function getDistanceBetweenCoords(lat1, lon1, lat2, lon2, addLabel) {
        var earthR = 6371; //in km
        var dLat = deg2rad(lat2-lat1);  // deg2rad below
        var dLon = deg2rad(lon2-lon1);
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);

        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var distKm = earthR * c; // Distance in km
        var distMi = distKm * 0.621371; // Convert to mi
        var d = {
            km: distKm.toFixed(2),
            mi: distMi.toFixed(2)
        };

        if(addLabel) {
            d.km = d.km + "km";
            d.mi = d.mi + "mi";
        }
        return d;
    }

    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }

    function windowScrollTo(el, duration) {
        var $el = $(el);
        if($el.length === 0) {
            return;
        }
        var targetEl = $el.get(0);
        var startPos = window.scrollY || window.pageYOffset;
	    var stopPos = targetEl.getBoundingClientRect().top;
        var startTick = Date.now();
        function easing(t, b, c, d) {
	        if ((t /= d / 2) < 1) return -c / 2 * (Math.sqrt(1 - t * t) - 1) + b;
	        return c / 2 * (Math.sqrt(1 - (t -= 2) * t) + 1) + b;
        }
        function doScroll() {
            var elapsed = Date.now() - startTick;
            var nextPos = easing(elapsed, startPos, stopPos - startPos, duration);
            win.scrollTo(0, nextPos);
            if(elapsed >= duration) {
	            win.scrollTo(0, stopPos);
            } else {
                win.setTimeout(doScroll, 20);
            }
        }
	    win.setTimeout(doScroll, 20);
    }

    //Encode HTML entities for strings used in data attributes.
    //Based on answer here: https://stackoverflow.com/questions/1219860/html-encoding-lost-when-attribute-read-from-input-field/7124052#7124052
    function encodeHtml(str) {
        if(str === null || typeof(str) == 'undefined') {
            return '';
        }
        return str
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, "&#39;")
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function decodeHtml(str) {
        return str
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'")
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
    }

    function retrieveFirstInstance(str, delimiter) {
        var output = '',
            delim = delimiter || ';';
        if(str && typeof(str) != 'undefined') {
            var tokens = str.split(delim);
            output = (str.length > 1) ? tokens[0] : str;
        }
        return output;
    }

    /**
     * Return items within the passed in string as an object of parameters.
     * @param str - should be a string containing a list of {key}={value} pairs with a delimiter
     * @param delimiter - define the delimiter that should be used to separate each set of {key}={value} pairs within the string
     * @returns {Mixed|*}
     */
    function convertToObject(str, delimiter) {
        var param = {},
            delim = delimiter || '&';
        _.each((str || '').split(delim), function(kv) {
            var p = kv.indexOf('=');
            if(p >= 0) {
                param[kv.substring(0, p)] = (kv.substring(p + 1));
            }
        });
        return param;
    }

    /**
     * Return the string with the target value removed from the end (if the target is at the end of the string)
     * @param str - this is the original string to remove the target value from
     * @param target - this is the substring value that should be removed from the end of the passed in string (when found)
     * @returns String
     */
    function trimFromEnd(str, target) {
        if(str && target) {
            var num = target.length,
                negNum = 0 - num;

            if(str.slice(negNum) === target) {
                str = str.slice(0, str.length - num);
            }
        }
        return str;
    }

    // window.FD.Brand.Util.uiBreakpoint();

    /**
     * Check OneTrust settings to see if script category is consent is given
     * @param cat - script category
     * @returns false if category consent is not given, true otherwise
     */
    function allowScript(cat) {
        var allow = true;
        if(context.region === 'US') {
            var cookie = getCookie('OptanonConsent');
            if (cookie) {
                var groups = ((decodeParameters(cookie) || {}).groups || '').split(',');
                if (groups.indexOf(cat + ':0') >= 0) {
                    allow = false;
                }
            }
        }
        return allow;
    }

    // BRAND-15880: pass in a vehicle data object with model, year, and optionally trim defined, and return that object
    // with the displayName and displayNameShort properties defined with the values from VDM.
    function getVdmDisplayName(vehData) {
        var def = $.Deferred();
        var vdmData = {
            locale: context && context.locale || 'en_us',
            make: context && context.make,
            model: vehData.model,
            year: vehData.year
        };
        if (vehData.trim) {
            vdmData.trim = vehData.trim;
        }

        var createDisplayName = function(modelName) {
            var vehicleName = modelName || vehData.model;
            if (vehData.trim) {
                vehicleName = vehicleName + ' ' + vehData.trim;
            }
            return (context && context.language === 'fr') ? (vehicleName + ' ' + vehData.year) : (vehData.year + ' ' + vehicleName);
        };

        $.getJSON('/aemservices/brand/api/vehicle/detail', vdmData).done(function(resp) {
            if (resp) {
                vehData.displayNameShort = resp.displayNameShort || '';
                vehData.metricsName = resp.metricsName || '';
                // BRAND-15880: Do not set the displayName value here if the response type is a 'nameplate' but a trim is defined.
                // in this case, we'll try to create the proper displayName using the displayNameShort value and the year / trim
                // from the vehicle data.
                if (resp.type === 'model' || (resp.type === 'nameplate' && !vehData.trim)) {
                    vehData.displayName = resp.displayName || '';
                }
            }
            if (!vehData.displayName) {
                vehData.displayName = createDisplayName((resp.displayNameShort || ''));
            }
            def.resolve(vehData);
        }).fail(function(resp) {
            vehData.displayNameShort = '';
            vehData.metricsName = '';
            vehData.displayName = createDisplayName();
            def.resolve(vehData);
        });

        return def.promise();
    }

    // returns jQuery object with the first instance of a main navigation element.
    function getMainNav() {
        if (!_mainNavData.$el) {
            _mainNavData.$el = $(_mainNavSelectors).first();
        }
        return _mainNavData.$el;
    }

    function setFullWidthMainNav(isFW) {
        if (typeof(isFW) !== 'undefined' && isFW !== null) {
            var $nav = getMainNav();
            $nav.toggleClass('fgx-nav-full-width', !!isFW);
        }
    }

    /**
     * Debounce calls to given function
     * i.e. function is only called after no other calls are made after given wait period
     * @param fn to debounce
     * @param period in ms
     * @returns {function(): void}
     *
     * NOTE - this was ported over from the aem64 branch of Pantry. Once we merge the changes from the aem64 branches into
     * mavice-ci, it might make more sense to remove this function and update the instances that rely on it to utilize the
     * function from Pantry.
     */
    function debounce(fn, period) {
        let timeout = null;
        return function() {
            let ctx = this;
            let args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                timeout = null;
                fn.apply(ctx, args);
            }, period);
        };
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context);
/**
 * Angular page support library
 */
;(function(win, _) {
    'use strict';

    var _initialized = false;

    // setup namespace
    _.extend(FD.Brand.namespace('FD.Brand.Angular', win), {
        init: init,
        bootstrap: bootstrap
    });

    //////

    function init() {
        if(win.angular && !_initialized) {
            angular.module('fgx.components', []);
            angular.module('fgx.directives', []);
            angular.module('fgx.filters', []);
            angular.module('fgx.services', []);
            angular.module('fgx.app', [
                'ngAria',
                'ngResource',
                'ngSanitize',
                'ngAnimate',
                'fgx.components',
                'fgx.directives',
                'fgx.filters',
                'fgx.services'
            ])
            .constant('AppContext', FD.Brand.Context);

            angular.module('fgx.directives')
                .directive('fgxAccActionItem', fgxAccActionItem);

            _initialized = true;
        }
    }

    function bootstrap(element, appName) {
        if(win.angular && _initialized) {
            angular.bootstrap(element || document, [appName || 'fgx.app']);
        }
    }

    /**
     * Directive for accessibility actionable items (actionable items are activated by Enter and spacebar key press)
     * This was ported over from the BNP project, with a few slight adjustments
     */
    function fgxAccActionItem() {
        return {
            restrict: 'A',
            scope: {
                click:'&ngClick'
            },
            link: function (scope, element, attr) {
                element.bind('keydown', function(event) {
                    if(event.which === 13 || event.which === 32) {
                        //also prevent scrolldown on space click of actionable item
                        event.preventDefault();
                        event.stopPropagation();
                        //calls the ng-click and passes through the keydown event
                        //used to be default in previous angular
                        event.fromFgxAccActionItem = true;
                        scope.$apply(function(){
                            if (scope.click) {
                                scope.click({$event: event});
                            } else {
                                $(element)[0].click();
                            }
                        });
                    }
                });
            }
        };
    }

})(window, FD.Brand.lodash);
/*global FD*/
/**
 * User support library
 */
(function(win, $, _, brand, util, ctx) {

    _.extend(brand.namespace('FD.Brand.User', win), {
        location: topicFactory('location', getLocation, {
            detail: getAsyncTopic(getLocationDetail),
            setPostalCode: setPostalCode,
            setGeoPACode: setGeoPACode,
            coordinates: getLocationCoordinates
        }),
        pricing: topicFactory('pricing', getPricing),
        authentication: topicFactory('authentication', getAsyncTopic(initAuth), {
            login: function(redirectUrl) {
                //FD.Brand.Link.processLink('#$userSignIn');
                if (!redirectUrl && useAltAuthRedirect()) {
                    redirectUrl = brand.Link && brand.Link.baseUrl('profileLanding') || '';
                }
                authLogin(redirectUrl);
            },
            logout: function() {
                authLogout();
            },
            checkSession: checkAuthStatus
        }),
        fps: topicFactory('fps', getAsyncTopic(initFps), {
            get: getFps,
            set: setFps,
            notification: {
                getAll: getAllFpsNotifications
            }
        }),
        dealer: topicFactory('dealer', getAsyncTopic(getDealer), {
            setPreferred: setPreferredDealer,
            removePreferred: removePreferredDealer,
            refresh: refresh
        }),
        profile: topicFactory('profile', getAsyncTopic(getProfile))
    });

    var _locationState = null;
    var _locationDetail = null;
    var _locationCoordinates = null;
    var _pricingState = null;
    var _authenticationState = null;
    var _fpsState = null;
    var _profileState = null;
    var _dealerState = null;
    var _fpsAuthTypeMap = {
        'anon': 'CSDN-G',
        'user': 'CSDN'
    };
    var _fpsLocale = {
        'en_us': 'EN_US',
        'es_us': 'SP_US',
        'en_ca': 'EN_CA',
        'fr_ca': 'FR_CA'
    }[ctx && ctx.locale || 'en_us'];

    var _initFps = brand.User.fps.current;
    var _initAuth = brand.User.authentication.current;

    var secureServiceBaseUrl = ctx.settings['ngbsSecureUrl' + ctx.make];
    var fpsBaseUrl = ctx.settings.fpsUrl;
    var profileMpsHost = ctx.settings.clwMpsHost;

    $(init);

    //////

    function init() {
        var np = ctx.nameplate;
        if(np) {
            updateFPI({
                make: ctx.make,
                model: np.ngpModelName,
                year: np.ngpYear,
                html: false
            });
        } else {
            updateFPI({
                make: ctx.make,
                html: false
            });
        }
    }

    function topicFactory(topic, fCurrent, methods) {
        return _.extend({
            subscribe: function(callback, skipInit) {
                return subscribeTopic(topic, callback, skipInit !== true && fCurrent());
            },
            unsubscribe: unsubscribeTopic,
            current: fCurrent
        }, methods || {});
    }

    // publish/subscribe support

    var _topics = {};
    var _nextHandleId = 0;

    function publishTopic(topic, data, callback) {
        if(!_topics[topic]) {
            return false;
        }
        setTimeout(function notifyTopic() {
            _.each(callback ? [{ callback: callback }] : _topics[topic], function(subscriber) {
                try {
                    subscriber.callback(data, topic);
                } catch(ex) {
                    util.log('user.lib: error occurred publishing state topic ' + topic, data, ex);
                }
            })
        }, 0);
        return true;
    }

    function subscribeTopic(topic, callback, initialData) {
        if(!_topics[topic]) {
            _topics[topic] = []
        }
        var handle = {
            topic: topic,
            id: ++_nextHandleId
        };
        _topics[topic].push({
            handle: handle,
            callback: callback
        });
        if(initialData) {
            $.when(initialData).done(function(result) {
                publishTopic(topic, result, callback);
            });
        }
        return handle;
    }

    function unsubscribeTopic(handle) {
        _.remove(_topics[handle.topic] || [], function(subscriber) {
            return subscriber.handle.id === handle.id;
        });
    }

    // helper for topics retrieved asynchronously
    // wraps a common promise that is returned
    // deferred is passed into load function and resolved when topic is loaded
    // this makes the function reentrant without initiating multiple requests to load topic
	function getAsyncTopic(fnLoad) {
		var promise = null;
		var fn = function() {
			var def;
			if(promise === null) {
				def = $.Deferred();
				promise = def.promise();
				fnLoad(def);
			}
			return promise;
		};
		fn.$_reset = function() {
		    promise = null;
        };
		return fn;
	}

	/// Location state support

    function getLocation() {
        if(!_locationState) {
            _locationState = {};
            // read postal code from FPI cookie if available
            var val = util.cookie.get('FPI');
            if (val) {
                val = util.parameters.decode(val);
                if (val && val.zip) {
                    _locationState.postalCode = val.zip;
                    _locationState.postalCodeSource = 'FPI';
                }

                if (val && val.geoPACode) {
                    _locationState.geoPACode = val.geoPACode;
                }
            }
            // if no FPI, read postal code from userInfo cookie if available
            if (!_locationState.postalCode) {
                _.each((util.cookie.get('userInfo') || '').split(','), function (val) {
                    if (val.substr(0, 4) === 'zip=') {
                        // ensure we're pulling 6 digits for CA and only 5 for US
                        _locationState.postalCode = val.substr(4, (ctx.region === 'CA' ? 6 : 5));
                        _locationState.postalCodeSource = 'Akamai';
                    }
                });
            }
            if(ctx.region === 'CA' && (!_locationState.postalCode || !/^[ABCEGHJKLMNPRSTVXYabceghjklmnprstvxy]{1}\d{1}[A-Za-z]{1} *\d{1}[A-Za-z]{1}\d{1}$/.test(_locationState.postalCode))) {
                _locationState.postalCode = 'L6J5E4';
                _locationState.postalCodeSource = 'Default';
            }
        }
        return stateValue(_locationState);
    }

    function getLocationDetail(def) {
        if(_locationDetail) {
            def.resolve(_locationDetail);
        } else {
            FD.Brand.NgpServices.location(getLocation().postalCode).then(function(resp) {
                if(resp) {
                    if(ctx.region === 'CA') {
                        var province = resp.Provinces && resp.Provinces.Province && resp.Provinces.Province.content;
                        _locationDetail = {
                            geoKey: province,
                            province: province,
                            regions: null
                        };
                    } else {
                        _locationDetail = {
                            geoKey: resp.GeoKey,
                            state: resp.States && resp.States.State && resp.States.State.content,
                            regions: _.transform(resp.Regions.Region, function(obj, region) {
                                obj[region.type] = region.Code;
                            }, {})
                        }
                    }
                    if(_locationState.postalCode) {
                        // make dealer call to get default dealer for metrics
                        var params = {
                            make: ctx.make,
                            radius: 50,
                            minDealers: 1,
                            maxDealers: 1,
                            postalCode: _locationState.postalCode
                        };

                        if(_locationState.geoPACode) {
                            params.prefDealerPACode = _locationState.geoPACode;
                        }
                        FD.Brand.NgpServices.dealers(params).done(function(dealers) {
                            if(!dealers || dealers.length === 0) {
                                // resolve promise without adding to location detail
                                def.resolve(_locationDetail);
                            } else {
                                if(_locationDetail) {
                                    _locationDetail.paCode = (dealers[0].PACode) ? dealers[0].PACode : '';
                                }
                                def.resolve(_locationDetail);
                            }
                        });
                    }
                }
            }, function() {
                def.resolve(_locationDetail);
            });
        }
    }

    function setPostalCode(postalCode, geoPACode) {
        if(_locationState && _locationState.postalCode === 'postalCode' && _locationState === 'user') {
            return;
        }
        _locationState = _locationState || {};
        _locationState.postalCode = postalCode;
        _locationState.postalCodeSource = 'user';

        if(geoPACode) {
            _locationState.geoPACode = geoPACode;
        } else if(_locationState.geoPACode) {
            delete _locationState.geoPACode;
        }

        if(_locationDetail !== null) {
	        _locationDetail = null;
	        brand.User.location.detail.$_reset();
        }
        updateFPI({
            zip: postalCode,
            geoPACode: geoPACode || ''
        });
        publishTopic('location', getLocation())
    }


    function setGeoPACode(geoPACode) {
        _locationState = _locationState || {};
        if(geoPACode) {
            _locationState.geoPACode = geoPACode;
        } else if(_locationState.geoPACode) {
            delete _locationState.geoPACode;
        }
        updateFPI({
            geoPACode: _locationState.geoPACode || ''
        });
    }

    function getLocationCoordinates() {
        if(!_locationCoordinates) {
            _locationCoordinates = {};
            if(util.env.geoLocation()) {
                window.navigator.geolocation.getCurrentPosition(function(pos) {
                    if(pos && pos.coords) {
                        _locationCoordinates.lat = pos.coords.latitude;
                        _locationCoordinates.lon = pos.coords.longitude;
                    }
                });
            }
        }
        return stateValue(_locationCoordinates);
    }

    /// Pricing state support

    function getPricing() {
        if(!_pricingState) {
            _pricingState = {};
            // read plan type from Authenticator library
            if (ctx.region === 'CA' || _.isUndefined(win.AXZAuthenticator)) {
                _pricingState.planType = 'MSRP';
            } else {
                _pricingState.planType = (new win.AXZAuthenticator()).getPlanType();
            }
            _pricingState.pricePlan = {
                MSRP: 'MSRP',
                AZ: 'AZPLAN',
                SPX: 'XPLAN',
                FNX: 'XPLAN',
                PRX: 'XPLAN'
            }[_pricingState.planType];
        }
        return stateValue(_pricingState);
    }

    /// Authentication state support


    function initAuth(def) {

        var authApplicationId = ctx.clwApplicationId;
        var authCiClientId = ctx.ciClientId;

        var resolveState = function() {
            var fma = win.fma;
            var newState = {};
            if (fma) {
                if (fma.isAuthenticated) {
                    newState = {
                        authType: 'user',
                        accessToken: fma.CATBundle && fma.CATBundle.access_token,
                        authToken: fma.CATBundle && fma.CATBundle.cat1_token,
                        authProvider: 'owner',
                        userId: fma.CATBundle && fma.CATBundle.userId,
                        userLogin: 'login: owner'
                    };
                } else {
                    if (fma.guestUserGuid) {
                        newState = {
                            authType: 'anon',
                            authProvider: 'anonymous',
                            userId: fma.guestUserGuid,
                            userLogin: 'login: current pc'
                        };
                    }
                }
            }
            _authenticationState = _.extend({
                loaded: !!fma,
                applicationId: authApplicationId,
                ciClientId: authCiClientId,
                authType: 'none',
                userLogin: 'logged out'
            }, newState);
            def.resolve(stateValue(_authenticationState));
            util.log('user.lib: auth state', _authenticationState);
        };

        if(_authenticationState) {
            resolveState();
        } else {
            $('body').on('fma_authenticated fma_unauthenticated', resolveState);
            var settings = ctx && ctx.settings || {};
            if(!win.fma && !(settings.syn && ctx.includeFMAScriptIfSyndicated === 'exclude')) {
                var fmaDataObj = {
                    'data-fma-script': '',
                    'data-ibm-cid': authCiClientId,
                    'data-app-id': authApplicationId,
                    'data-region': 'na',
                    'data-lang': ctx.locale,
                    'data-property-key': {
                        'USFord': 'brand_ford',
                        'USLincoln': 'brand_lincoln',
                        'CAFord': 'brand_ford_ca',
                        'CALincoln': 'brand_lincoln_ca'
                    } [ctx.region + ctx.make]
                };
                // retrieve config value and, if it exists, set 'data-fs-url' attribute
                var dataFSUrl = ctx.settings.fmaDataFSUrl;
                if (typeof dataFSUrl !== 'undefined' && dataFSUrl.length > 0) {
                    fmaDataObj['data-fs-url'] = dataFSUrl;
                }
                util.url.loadAsScript(ctx.settings.fmaIncludeScript, fmaDataObj, true).done(function() {
                    if(!win.fma) {
                        util.log('user.lib: FMA library failed to initialize');
                        resolveState();
                    }
                    // loaded, will resolve in fma event handler
                }).fail(function(resp) {
                    util.log('user.lib: failed to load FMA library', resp);
                    resolveState();
                });
            }
            // if isAuthentication is defined, FMA has already determined auth state so resolve
            if(win.fma && win.fma.isAuthenticated !== undefined) {
                resolveState()
            }
        }

    }

    // TODO: check if needed
    function checkAuthStatus() {
        var def = $.Deferred();
        def.resolve(stateValue(_authenticationState));
        return def.promise();
    }

    function authLogin(redirectUrl) {
        _initAuth().done(function() {
            if(win.fma) {
                win.fma.model.config.redirectUrl = redirectUrl || win.location.href;
                win.fma.login();
            }
        });
    }

    function authLogout() {
        _initAuth().done(function() {
            if(win.fma) {
                win.fma.logout();
            }
        });
    }

    /// Profile state support

    function getProfile(def) {
        var resolveState = function() {
            def.resolve(stateValue(_profileState));
        };
        if(_profileState) {
            resolveState();
        } else {
            FD.Brand.User.authentication.current().then(function(authState) {
                if(authState && authState.authType === 'user') {
                    $.ajax({
                        url: profileMpsHost + '/api/users',
                        dataType: 'json',
                        headers: {
                            'Auth-Token': authState.authToken,
                            'Application-Id': authState.applicationId
                        }
                    }).done(function(resp) {
                        _profileState = resp && resp.profile;
                        resolveState();
                    }).fail(function(resp) {
                        util.log('user.lib: Get User Profile failed', resp);
                        resolveState();
                    });
                } else {
                    util.log('user.lib: User not logged in, no profile is available');
                    resolveState();
                }
            });
        }

    }

    /// Dealer state support

    function getDealer(def) {
        var resolveState = function() {
            def.resolve(stateValue(_dealerState));
        };
        if(_dealerState) {
            resolveState();
        } else {
            _dealerState = {};
            _initFps().done(function(fpsState) {
                if(fpsState.loaded) {
                    getFps([{
                        PreferredDealer: {
                            max: 1
                        }
                    }]).done(function (val) {
                        var lst = val && val.length > 0 && val[0].PreferredDealer;
                        if (lst) {
                            var dealerCodes = _.pluck(lst, '_paCode'),
                                location = getLocation(),
                                postalCode = (location && location.postalCode) ? location.postalCode : '';

                            if (dealerCodes.length > 0) {
                                FD.Brand.NgpServices.dealer({
                                    make: ctx.make,
                                    dealerPACode: dealerCodes[0],
                                    customerPostalCode: postalCode
                                }).done(function (dealer) {
                                    _dealerState.preferred = dealer;
                                    resolveState();
                                }).fail(resolveState);
                                return;
                            }
                        }
                        resolveState();
                    }).fail(resolveState);
                } else {
                    resolveState();
                }
            });
        }
    }

    function setPreferredDealer(dealerPaCode) {
        var def = $.Deferred();
        if(_dealerState.preferred && _dealerState.preferred.PACode === dealerPaCode) {
            def.resolve();
        } else {
	        _initFps().done(function(fpsState) {
                FD.Brand.NgpServices.dealer({
                    make: ctx.make,
                    dealerPACode: dealerPaCode
                }).done(function(dealer) {
                    if(dealer) {
                        setFps([FPS.lib.PreferredDealer(dealerPaCode, dealer.Name)]).done(function(val) {
	                        _dealerState.preferred = dealer;
                            brand.User.dealer.current.$_reset();
                            publishTopic('dealer', stateValue(_dealerState));
                            def.resolve();
                        }).fail(function() {
                            def.reject();
                        });
                    } else {
                        util.log('user.lib: no dealer found for ' + dealerPaCode);
                        def.reject();
                    }
                }).fail(function() {
                    def.reject();
                });
            });
        }
        return def.promise();
   }
   
   function removePreferredDealer(dealerPaCode) {
       var def = $.Deferred();
       if(_dealerState.preferred && _dealerState.preferred.PACode !== dealerPaCode) {
           def.resolve();
       } else {
           _initFps().done(function(fpsState) {
               FD.Brand.NgpServices.dealer({
                   make: ctx.make,
                   dealerPACode: dealerPaCode
               }).done(function(dealer) {
                   if(dealer) {
                       setFps([{PreferredDealer: { _paCode: dealerPaCode, description: dealer.Name }, metadata: { active: 'false' }}]).done(function(val) {
                           if(_dealerState.preferred) {
                               _dealerState.preferred = null;
                               brand.User.dealer.current.$_reset();
                           }
                           publishTopic('dealer', stateValue(_dealerState));
                           def.resolve();
                       }).fail(function() {
                           def.reject();
                       });
                   } else {
                       util.log('user.lib: no dealer found for ' + dealerPaCode);
                       def.reject();
                   }
               }).fail(function() {
                   def.reject();
               });
           });
       }
       return def.promise();
   }

   function refresh() {
       var preferredPaCode = function() {
           return _dealerState && _dealerState.preferred && _dealerState.preferred.PACode || '';
       };
       var paCode = preferredPaCode();
       _dealerState = null;
	   brand.User.dealer.current.$_reset();
       return brand.User.dealer.current().done(function() {
           if(preferredPaCode() !== paCode) {
               publishTopic('dealer', stateValue(_dealerState));
           }
       });
   }

    // FPS state support

    function initFps(def) {
        var resolveState = function() {
            def.resolve(stateValue(_fpsState));
        };
        var initState = function() {
            // BRAND-15757: set the locale on the FPS.config object after loading FPS.
            win.FPS.config.locale = _fpsLocale;
            _fpsState.locale = _fpsLocale;
            _fpsState.loaded = true;
            _initAuth().done(function(authState) {
                var userId = authState && authState.userId;
                //NZ - refType added as part of BRAND-13612
                var refType = _fpsAuthTypeMap[(authState && authState.authType) || ''] || '';
                if(userId && refType !== '') {
                    win.FPS.setExternalRef(refType, userId, {
                        success: function() {
                            _fpsState.externalRefType = refType;
                            _fpsState.externalRefId = userId;
                            resolveState();
                        },
                        error: function() {
                            util.log('user.lib: failed to set FPS external reference');
                            resolveState();
                        }
                    });
                } else {
                    resolveState();
                }
            });
        };
        if(_fpsState) {
            resolveState();
        } else {
            _fpsState = {
                loaded: false
            };
            if(win.FPS) {
                initState();
            } else {
                if(util.url.allowScript('6')) {
                    util.url.loadAsScript(fpsBaseUrl + '/script/' + ctx.make + ((ctx.region === 'CA') ? '/CAN' : '/USA')).done(function () {
                        if (!win.FPS) {
                            resolveState();
                            return;
                        }
                        initState();
                    }).fail(function (resp) {
                        util.log('user.lib: failed to load FPS library', resp);
                        resolveState();
                    });
                } else {
                    util.log('user.lib: FPS library not loaded due to privacy settings');
                    resolveState();
                }
            }
        }
    }

    function getFps(params) {
        var def = $.Deferred();
	    _initFps().done(function(state) {
            if(state.loaded) {
                win.FPS.get(params, {
                    success: function(values) {
                        def.resolve(values);
                    },
                    error: function(jqXHR, statusText, error) {
                        util.log('user.lib: failed to load get FPS values', error, params);
                        def.reject();
                    }
                });
            } else {
                util.log('user.lib: getFps failed, FPS library not loaded');
            }
        });
        return def.promise();
    }

    function setFps(params) {
        var def = $.Deferred();
	    _initFps().done(function(state) {
            if(state.loaded) {
                win.FPS.set(params, {
                    success: function(values) {
                        def.resolve();
                    },
                    error: function(jqXHR, statusText, error) {
                        util.log('user.lib: failed to load set FPS values', error, params);
                        def.reject();
                    }
                });
            } else {
                util.log('user.lib: setFps failed, FPS library not loaded');
            }
        });
        return def.promise();
    }

    function getAllFpsNotifications() {
        var def = $.Deferred();
        _initFps().done(function(state) {
            if (state.loaded) {
                win.FPS.Notifications.getAll({
                    success: function(resp) {
                        if (resp && resp.SavedVehicleCount) {
                            util.log('user.lib: getAllFpsNotifications, FPS call succeeded: ', resp);
                            def.resolve(resp);
                        } else {
                            util.log('user.lib: getAllFpsNotifications, FPS call succeeded, but savedVehicleCount was missing. resp is: ', resp);
                            def.reject();
                        }
                    },
                    error: function(resp) {
                        util.log('user.lib: getAllFpsNotifications, FPS call failed. resp is: ', resp);
                        def.reject();
                    }
                });
            } else {
                util.log('user.lib: getAllFpsNotifications failed, FPS library not loaded');
                def.reject();
            }
        });
        return def.promise();
    }


    function stateValue(val) {
        return _.extend({}, val);
    }

    function updateFPI(prop) {
        var ck = util.cookie.get('FPI');
        var p = (ck) ? util.parameters.decode(ck) : { };
        var domain = ctx.settings['siteCookieDomain' + ctx.make];
        p = _.assign(p, prop);

        if(p.geoPACode === '') {
            delete p.geoPACode;
        }

        util.cookie.set('FPI', util.parameters.encode(p), {
            path: '/',
            domain: ((domain || '') == '') ? null : domain,
            expires: 65
        });
    }

    function useAltAuthRedirect() {
        return (ctx && ctx.pageType === 'HomePage' && ctx.make === 'Ford' && ctx.region === 'CA');
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util, FD.Brand.Context);
/*global FD*/
(function(win, $, _, brand, settings) {

    // DIG asset support library
    _.assign(brand.namespace('FD.Brand.Dig'), {
        url: digUrl,
        resolve: digResolve
    });

    //////

    /**
     * Return global angle for given model name
     * @param m
     * @returns {*|number}
     */
    function globalAngle(m) {
        return {
                'StrippedChassis': 1,
                'F-650-750': 1,
                'Econoline Cutaway': 1
            }[m] || 4;
    }

    function tokenOffset(token) {
        var p = token.indexOf('Image[|');
        if(p === 0) return 7;
        p = token.indexOf('Config[|');
        if(p === 0) return 8;
        return null;
    }

    /**
     * Return DIG asset url
     * @param token
     * @param profile
     * @param view
     * @param angle
     * @returns {*}
     */
    function digUrl(token, profile, view, angle) {
        if(token) {
            var offset = tokenOffset(token), t;
            if(offset) {
                t = token.substr(offset).split('|');
                if(t.length > 3) {
                    return [
                        settings.digUrl,
                        encodeURIComponent(t[0]),
                        encodeURIComponent(t[1]),
                        encodeURIComponent(t[2]),
                        encodeURIComponent(profile || 'BP3TT-TILE-EXT'),
                        encodeURIComponent(token),
                        view || 'EXT',
                        angle || globalAngle(t[1]),
                        'vehicle.png'
                    ].join('/');
                }
            }
        }
        return null;
    }

    /**
     * Resolve DIG asset urls for child elements with 'data-dig-src' or 'data-dig-srcset' attributes
     * Attribute value is split by comma into parameters passed to digURL method
     * @param el
     */
    function digResolve(el) {
        var isLazy = function($el) {
            return (!$el.hasClass('fgx-not-lazy') && ($el.hasClass('lazyload') || $el.siblings('img').hasClass('lazyload')));
        };
        $('[data-dig-src]', el).each(function() {
            var $el = $(this);
            $el.attr(isLazy($el) ? 'data-src' : 'src', digUrl.apply(null, $el.attr('data-dig-src').split(','))).removeAttr('data-dig-src');
        });
        $('[data-dig-srcset]', el).each(function() {
            var $el = $(this);
            $el.attr(isLazy($el) ? 'data-srcset' : 'srcset', digUrl.apply(null, $el.attr('data-dig-srcset').split(','))).removeAttr('data-dig-srcset');
        });
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context.settings);

/*global FD*/
(function(win, $, _, brand, context, util) {
    
    // disclosures library
    _.extend(brand.namespace('FD.Brand.Disclosures', win), {
        updateDisclosures: updateDisclosures,
        popupDisclosureLinkClick: popupDisclosureLinkClick,
        showPriceTip: showPriceTip,
        setInitListener: setInitListener,
        global: {
            getData: getGlobalDisclosureData
        },
        dynamic: {
            getData: getDynamicDisclosureData
        }
    });
    
    var _disclosures = {};
    var closeLabelPrefix = (context.accessibility && context.accessibility.closeLabelPrefix) || '';
    var $tooltip = $('<div class="fgx-brand-css" role="dialog" aria-labelledby="fgx-brand-tooltipHeading" aria-describedby="fgx-brand-tooltipContent" style="display: none;"><div class="fgx-tooltip" data-dynamic-disclosure-enable>' +
        '<div class="icon icon-close fgx-tooltip-close" tabindex="0" role="button" data-fgx-keypress="true" aria-label="' + closeLabelPrefix + '"></div>' +
        //'<div class="fgx-tooltip-hdr"></div>' +
        '<h1 id="fgx-brand-tooltipHeading" class="fgx-tooltip-heading fgx-tooltip-id"></h1>' +
        '<div id="fgx-brand-tooltipContent" class="fgx-tooltip-contents"></div>' +
        '<div class="fgx-dynamic-disclosure-wrapper"></div>' +
        '</div></div>');
    var $pricetip = $('<div class="fgx-brand-css" role="dialog" aria-labelledby="fgx-brand-pricetipHeading" aria-describedby="fgx-brand-pricetipContent" style="display: none;"><div class="fgx-tooltip price-tip">' +
        '<div class="icon icon-close fgx-tooltip-close" tabindex="0" role="button" data-fgx-keypress="true" aria-label="' + closeLabelPrefix + '"></div>' +
        '<div class="fgx-tooltip-hdr"></div>' +
        '<h1 id="fgx-brand-pricetipHeading" class="fgx-tooltip-heading fgx-brand-sr-text"></h1>' +
        '<div id="fgx-brand-pricetipContent" class="fgx-tooltip-contents"></div>' +
        '</div></div>');
    var $discHeading = $tooltip.find('.fgx-tooltip-heading');
    var $discContents = $tooltip.find('.fgx-tooltip-contents');
    var $dynamicDisc = $tooltip.find('.fgx-dynamic-disclosure-wrapper');
    var $closeBtn = $tooltip.find('.fgx-tooltip-close');
    var $priceTipId = $pricetip.find('.fgx-tooltip-hdr');
    var $priceTipHeading = $pricetip.find('.fgx-tooltip-heading');
    var $priceTipContents = $pricetip.find('.fgx-tooltip-contents');
    var $priceTipCloseBtn = $pricetip.find('.fgx-tooltip-close');
    var $body = $('body');
    var removeTooltipPos = false;
    var removePricetipPos = false;
    var discHeadingPrefix = '';
    var discLabelPrefix = '';
    var dynamicDiscLabelPrefix = '';
    var focusElements = 'a:visible, [data-fgx-keypress]:visible';
    var ovr = {
        $el: $tooltip,
        hide: function() {
            $('.fgx-tooltip-close', $tooltip).trigger('click');
        },
        lastFocus: undefined
    };
    var priceTipOvr = {
        $el: $pricetip,
        hide: function() {
            $('.fgx-tooltip-close', $pricetip).trigger('click');
        },
        lastFocus: undefined
    };
    var _initialized = false;
    var _initRegistry = [];

    $(function() {
        init();
    });

    ///////

    function init() {

        _.each(context.allEnabledDisclosures, function(d) {
            var setId = d.name.replace(/\s+/g, '').toLowerCase();
            _disclosures[setId] = [];
            _.each(d.disclosures, function(disc) {
                _disclosures[setId][disc.key] = disc;
            });
        });

        discHeadingPrefix = (context.accessibility && context.accessibility.disclosureHeadingPrefix) || '';
        discLabelPrefix = (context.accessibility && context.accessibility.disclosureLabelPrefix) || '';
        dynamicDiscLabelPrefix = (context.accessibility && context.accessibility.dynamicDisclosureLabelPrefix) || '';

        // Will C. - add accessibility attributes to our disclosure <sup> items...this will add them to the tab order, 
        // classify them as 'button' items and enable our key-listener logic
        $('sup[data-vdm-disc]').each(function(){
            $el = $(this);
            $el.attr('tabindex', '0');
            $el.attr('role', 'button');
            $el.attr('data-fgx-keypress', 'true');
            $el.attr('aria-label', discLabelPrefix + ' ' + $el.text());
        });
        $('a[href^=\'#disc\']').each(function() {
            var txt = $(this).text().trim();
            $(this).attr('aria-label', dynamicDiscLabelPrefix + ' ' + txt);
        });
        
        $body
            .append($tooltip)
            .append($pricetip)
            .on('click', 'sup[data-vdm-disc]', function(ev) {
                ev.preventDefault();
                var $el = $(ev.currentTarget);
                if ($el.closest('.fordMainNavigation').length > 0) {
                    ev.stopPropagation();
                }
                var id = $el.attr('data-vdm-disc');
                hideTooltip(ev, function() {
                    var ar = (id || '').split('|');
                    var disc = (ar.length > 1) && _disclosures[ar[0].replace(/\s+/g, '').toLowerCase()][ar[1]];
                    if(disc) {
                        var discId = disc.id || '';
                        var discHeading = (discHeadingPrefix) ? (discHeadingPrefix + ' ' + discId) : discId;
                        showTooltip(discHeading, disc.detail, $el);
                    } else {
                        util.log('disclosures.lib: showTooltip invalid id : ' + id);
                    }
                });
               // postfdanalytics.tooltipOnClick();
            })
            .on('click', '.fgx-popup-tooltip', popupDisclosureLinkClick)
            .on('click', 'a[href^=\'#disc\']', dynamicDisclosureLinkClick)
            .on('click', 'button[href^=\'#disc\']', dynamicDisclosureLinkClick)
            .on('click', 'a[href^=\'#show-tooltip\']', flexTooltipLinkClick)
            .on('click', 'a[href^=\'#price-tip\']', priceTipLinkClick);

        $tooltip.on('click', 'fgx-tooltip-close', hideTooltip);
        $priceTipCloseBtn.on('click', hidePriceTip);

        _initialized = true;
        triggerInitListeners();
    }

    function hideTooltip(ev, onComplete) {
        $body.off('click', hideTooltip);
        if($tooltip.is(':visible')) {
            $tooltip.fadeOut(100, function() {
                FD.Brand.Overlay.releaseFocus(ovr);
                if (typeof onComplete != 'undefined') {
                    onComplete();
                }
            });
            if(removeTooltipPos) {
                $tooltip.find('.fgx-tooltip').css({position: ""});
                removeTooltipPos = false;
            }
            $body.removeClass('no-scroll-sm');
        } else if(onComplete){
            onComplete();
        }
    }
    
    function hidePriceTip(ev, onComplete) {
        if($pricetip.is(':visible')) {
            $pricetip.fadeOut(100, function() {
                FD.Brand.Overlay.releaseFocus(priceTipOvr);
                if (typeof onComplete != 'undefined') {
                    onComplete();
                }
            });
            if(removePricetipPos) {
                $pricetip.find('.fgx-tooltip').css({position: ""});
                removePricetipPos = false;
            }
            $body.removeClass('no-scroll-sm');
        } else if(onComplete){
            onComplete();
        }
        updateExpandedAttr(priceTipOvr.lastFocus, "false");
    }

    function showTooltip(title, detail, $el, className, role) {
        // determine whether our trigger element is nested inside another tooltip...but ensure the parent tooltip is NOT our price-tip
        var isNested = ($el.parent().closest('.fgx-tooltip-contents').length > 0 && $el.parent().closest('.price-tip').length <= 0);
        var bp = util.currentBreakpoint();
        var topOffset = 100;
        if (role === '' || typeof role === 'undefined') role = 'dialog';
        // update contents
        $discHeading.text(title || '');
        $discContents.html(detail || '\xa0');
        updateDisclosures($tooltip);

        var dynamicDiscElm = $el.closest('[data-dynamic-disclosure-enable]').find('.dynamic-disclosures');
        if(dynamicDiscElm.length) {
            $dynamicDisc.html(dynamicDiscElm.html());
        } else {
            $dynamicDisc.html('');
        }

        //$tooltip.removeClass().addClass('fgx-tooltip ' + (className || ''));
        $tooltip.removeClass().addClass('fgx-brand-css ' + (className || ''));
        removeTooltipPos = false;
        
        // assign role...if role was not passed in, this will always be 'dialog'
        $tooltip.attr('role', role);

        if(!isNested) {
            // only update our lastFocus target if we're *not* nested - we don't want to lose our place in the page.
            ovr.lastFocus = $el;
            var elPos = $el.offset();
            var top = elPos.top + $el.outerHeight();
            var winHeight = $(window).height() + $(window).scrollTop();
            $tooltip.addClass('fgx-brand-size-calc');
            var $tooltipEl = $tooltip.find('.fgx-tooltip');
            var adjustTop = ((top + $tooltipEl.outerHeight()) > winHeight);
            var left = elPos.left + $el.outerWidth() - $tooltipEl.outerWidth();

            if(bp === 'gux-bkpt-sm') {
                if(adjustTop) {
                    var diff = (top + $tooltipEl.outerHeight()) - winHeight;
                    top = elPos.top - diff;
                    //top = elPos.top - $tooltipEl.outerHeight() + topOffset;
                }
                if(top < 0) {
                    top = 25;
                    $(".fgx-tooltip").css({
                        position: "fixed"
                    });
                    removeTooltipPos = true;
                } else if(top < $(window).scrollTop()) {
                    top = $(window).scrollTop();
                }
                if(left < 0) {
                    left = 20;
                }
            } else {
                if(adjustTop) {
                    top = elPos.top - $tooltipEl.outerHeight() + topOffset;
                }
                if(left < 0) {
                    left = elPos.left;
                }
                if(top < 0) {
                    top = 25;
                } else if(top < $(window).scrollTop()) {
                    top = $(window).scrollTop();
                }
            }

            $tooltip.find('.fgx-tooltip').css({
                top: top,
                left: left
            });

            $tooltip.removeClass('fgx-brand-size-calc');

        }
        $tooltip.fadeIn(250, function() {
            FD.Brand.Overlay.trapFocus(ovr, focusElements, '.fgx-tooltip-close', ovr.lastFocus)
        });
        $body.one('click', hideTooltip);
    }
    
    function showPriceTip(title, content, $el) {
        var bp = util.currentBreakpoint();
        var topOffset = 100;
        // update contents
        $priceTipId.text(title);
        $priceTipHeading.text(title);
        $priceTipContents.html(content || '\xa0');
        updateDisclosures($pricetip);
        // NZ - set the expanded attr to false on the old 'lastFocus' element before replacing with the current one.
        // This is needed to update the expanded attr in instances where the priceTip is updated with new content without
        // the overlay closing in between.
        updateExpandedAttr(priceTipOvr.lastFocus, "false");
        // set last focus and price-tip positioning
        removePricetipPos = false;
        priceTipOvr.lastFocus = $el;
        var elPos = $el.offset();
        var top = elPos.top + $el.outerHeight();
        var winHeight = $(window).height() + $(window).scrollTop();
        $pricetip.addClass('fgx-brand-size-calc');
        var $pricetipEl = $pricetip.find('.fgx-tooltip');
        $pricetipEl.toggleClass('no-heading', !title);
        var adjustTop = ((top + $pricetipEl.outerHeight()) > winHeight);
        var left = elPos.left + $el.outerWidth() - $pricetipEl.outerWidth();

        if(bp === 'gux-bkpt-sm') {
            if(adjustTop) {
                var diff = (top + $pricetipEl.outerHeight()) - winHeight;
                top = elPos.top - diff;
                //top = elPos.top - $tooltipEl.outerHeight() + topOffset;
            }
            if(top < 0) {
                top = 25;
                $(".fgx-tooltip.price-tip").css({
                    position: "fixed"
                });
                removePricetipPos = true;
            } else if(top < $(window).scrollTop()) {
                top = $(window).scrollTop();
            }
            if(left < 0) {
                left = 20;
            }
        } else {
            if(adjustTop) {
                top = elPos.top - $pricetipEl.outerHeight() + topOffset;
            }
            if(left < 0) {
                left = elPos.left;
            }
            if(top < 0) {
                top = 25;
            } else if(top < $(window).scrollTop()) {
                top = $(window).scrollTop();
            }
        }

        $pricetip.find('.fgx-tooltip').css({
            top: top,
            left: left
        });

        $pricetip.removeClass('fgx-brand-size-calc');

        updateExpandedAttr($el, "true");
        
        $pricetip.fadeIn(250, function() {
            FD.Brand.Overlay.trapFocus(priceTipOvr, focusElements, '.fgx-tooltip-close', priceTipOvr.lastFocus)
        });
    }
    
    function popupDisclosureLinkClick(ev) {
        ev.preventDefault();
        var $el = $(ev.currentTarget);
        hideTooltip(ev, function() {
            showTooltip('', $el.find('.fgx-popup-tooltip-content').html(), $el, 'fgx-disclosure-popup');
        });
    }
    
    function dynamicDisclosureLinkClick(ev) {
        ev.preventDefault();
        var $el = $(this);
        var href = $(this).attr('href');
        if (href.indexOf('=') > -1) {
            var id = href.split('=')[1];
            var $component = $el.closest('[data-dynamic-disclosure-enable]');
            var $discEl = $component.find('[data-disclosure-id="'+ id +'"]');
            var content = $discEl.data('disclosure-content');
            var title = $discEl.data('disclosure-title');
            var cls = $discEl.data('disclosure-class');
            var cssClass = (title === '' || title === undefined) ? 'fgx-disclosure-popup' : '';
            if (cls !== '' && typeof cls !== 'undefined') {
                cssClass += (' ' + cls);
            }
            if (content !== '' && content !== undefined) {
                hideTooltip(null, function() {
                    showTooltip(title, content, $el, cssClass);
                });
            } else {
                util.log('disclosures.lib: dynamicDisclosureLinkClick link exists, but disclosure contains no content.');
            }
        } else {
            util.log('disclosures.lib: dynamicDisclosureLinkClick link is malformed...it should be formatted like: #disc=id');
        }
    }
    
    function flexTooltipLinkClick(ev) {
        ev.preventDefault();
        var $el = $(this);
        var role = $(this).data('tooltip-role');
        var content = $(this).data('tooltip-content');
        if (content !== '' && content !== undefined) {
            hideTooltip(null, function() {
                showTooltip('', content, $el, 'fgx-disclosure-popup', role);
            });
        }
    }
    
    function priceTipLinkClick(ev) {
        ev.preventDefault();
        var $el = $(this);
        var href = $(this).attr('href');
        if (href.indexOf('=') > -1) {
            var id = href.split('=')[1];
            var $component = $el.closest('[data-price-tip-enable]');
            var $discEl = $component.find('[data-price-tip-id="'+ id +'"]');
            var content = $discEl.data('price-tip-content');
            var title = $discEl.data('price-tip-title');
            var cssClass = (title === '' || title === undefined) ? 'fgx-disclosure-popup' : '';
            if (content !== '' && content !== undefined) {
                showPriceTip(title, content, $el);
            } else {
                util.log('disclosures.lib: priceTipLinkClick link exists, but price tip contains no content.');
            }
        } else {
            util.log('disclosures.lib: priceTipLinkClick link is malformed...it should be formatted like: #price-tip=id');
        }
    }
    
    /**
     * Helper method to allow accessibility attributes to be added to components via an explicit call
     * rather than relying on the logic that runs when the page is loaded.
     **/
    function updateDisclosures(components) {
        // Will C. - add accessibility attributes to our disclosure <sup> items...this will add them to the tab order, 
        // classify them as 'button' items and enable our key-listener logic
        $('sup[data-vdm-disc]', components).each(function(){
            $el = $(this);
            $el.attr('tabindex', '0');
            $el.attr('role', 'button');
            $el.attr('data-fgx-keypress', 'true');
            $el.attr('aria-label', discLabelPrefix + ' ' + $el.text());
        });
    }

    function getGlobalDisclosureData(id) {
        var ar = (id || '').split('|');
        var discKey = (ar.length > 1) && ar[0].replace(/\s+/g, '').toLowerCase();
        var disc = discKey && _disclosures[discKey] && _disclosures[discKey][ar[1]];
        return disc || null;
    }

    function getDynamicDisclosureData($el) {
        var output = null;
        if(!$el || $el.length === 0) {
            return output;
        }

        var href = $el.attr('href');
        if (href.indexOf('=') > -1) {
            var id = href.split('=')[1];
            var $component = $el.closest('[data-dynamic-disclosure-enable]');
            var $discEl = $component.find('[data-disclosure-id="'+ id +'"]');
            var content = $discEl.data('disclosure-content');
            var title = $discEl.data('disclosure-title');
            var displayId = $el.text();

            output = {
                "id": displayId,
                "key": id,
                "title": title,
                "detail": content
            };
        }

        return output;
    }

    function updateExpandedAttr($el, val) {
        if($el && $el.length > 0 && $el.is('[aria-expanded]')) {
            $el.attr('aria-expanded', val);
        }
    }

    /*
     * Helper methods to allow a component to setup a callback method that should be fired when the disclosures lib
     * is initialized. If the lib is already initialized when trying to set the listener, then the callback should just
     * be fired instantly.
     */
    function setInitListener(compId, initHandler) {
        if (_initialized) {
            fireListenerCallback({id: compId, handler: initHandler});
        } else {
            _initRegistry.push({
                id: compId,
                handler: initHandler
            });
        }
    }

    function triggerInitListeners() {
        if (_initRegistry.length > 0) {
            _initRegistry.forEach(function(item) {
                fireListenerCallback(item);
            });
        }
    }

    function fireListenerCallback(item) {
        if (item && item.handler && typeof(item.handler) === 'function') {
            try {
                item.handler();
            } catch(e) {
                console.log('An error occurred trying to fire a callback of the disclosures lib init listener for ' + item.id, e);
            }
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context, FD.Brand.Util);
/*global FD*/
/**
 * NGP Services support library
 */
(function(win, $, _, ctx, util) {
    var settings = ctx.settings;

    // setup namespace
    _.extend(FD.Brand.namespace('FD.Brand.NgpServices', win), {
        location: function(postalCode) {
            return serviceCall('/geo/PostalCodes.json', {
                postalCode: postalCode
            }, function(resp) {
                return util.objPath(resp, 'Response.PostalCode');
            });
        },
        dealers: function(prm) {
            return serviceCall('/dealer/Dealers.json', prm, function(resp) {
                return util.toArray(util.objPath(resp, 'Response.Dealer'));
            });
        },
        dealer: function(prm) {
            return serviceCall('/dealer/Details.json', prm, function(resp) {
                return util.objPath(resp, 'Response.Dealer');
            });
        },
        dealerByUrlKey: function(prm) {
            return serviceCall('/dealer/DetailsByUrlKey.json', prm, function(resp) {
                return util.objPath(resp, 'Response.Dealer');
            });
        },
        serviceLocations: function(prm) {
            return serviceCall('/dealer/ServiceLocations.json', prm, function(resp) {
                return util.toArray(util.objPath(resp, 'Response.Dealer'));
            });
        },
        dealersAndServiceLocations: function(prm) {
            return serviceCall('/dealer/DealersAndServiceLocations.json', prm, function(resp) {
                return util.toArray(util.objPath(resp, 'Response.Dealer'));
            });
        },
        dealerChatStatus: function(prm) {
            return serviceCall('/dealer/ChatStatus.json', prm, function(resp) {
                return util.objPath(resp, 'Response.DealerChatStatus');
            });
        },
        dealerReviews: function(prm) {
            return serviceCall('/dealer/Reviews.json', prm, function(resp) {
                return util.objPath(resp, 'Response.ReviewResponse');
            });
        },
        dealerSpecialties: function(prm) {
            return serviceCall('/dealer/Specialties.json', prm || {}, function(resp) {
                return util.objPath(resp, 'Response.Specialties');
            });
        },
        modelSlices: function(prm) {
            return serviceCall('/products/ModelSlices.json', prm, function(resp) {
                return util.objPath(resp, 'Response.Model');
            });
        },
        configDetail: function(prm) {
            return serviceCall('/config/Details.json', prm, function(resp) {
                return util.objPath(resp, 'Response');
            });
        },
        searchTypeAhead: function(prm) {
            var link = FD.Brand && FD.Brand.Link,
                path = link.baseUrl('ngpSearchServiceBase') + "/JSONTypeAheadServlet.do";
            return serviceCall(path, prm, function(resp) {
                return util.objPath(resp, 'DimensionSearch.0.Locations');
            }, true, true);
        },
        specialOffers: function(prm) {
            return serviceCall('/incentives/SpecialOffers.json', prm, function(resp) {
                return util.objPath(resp, 'Response.Nameplate');
            });
        },
        attributesProxy: function(method, prm, attr) {
            var param = {
                client: 'common',
                region: ctx.region,
                url: method + '?' + util.parameters.encode(prm),
                filter: attr
            };
            var host = (settings['shopUrl' + ctx.make + ctx.languageKey] ||
                settings['shopUrl' + ctx.make]);
            return $.getJSON(host + '/aemservices/common/api/attributes/proxy', param);
        },
        attributeMap: attributeMap
    });

    function serviceCall(method, prm, fn, skipCheck, fullPath) {
        return $.Deferred(function (defer) {
            prm.api_key = settings.ngpApiKey;
            var path = (fullPath) ? method : settings.ngpServiceUrl + method;
            $.getJSON(path, prm).done(function(resp) {
                if(skipCheck || checkResponse(resp)) {
                    defer.resolve(fn ? fn(resp) : resp);
                } else {
                    defer.reject();
                }
            }).fail(function(resp) {
                util.log(method + ' failed', resp);
                defer.reject(resp);
            });
        }).promise();
    }

    function fixServiceJSON(obj) {
        if($.isPlainObject(obj) || $.isArray(obj)) {
            $.each(obj, function(k, v) {
                var v = util.fixServiceJSON(v);
                obj[k] = v;
            });
            return obj;
        } else {
            if(/^[-+]?[0-9]*\.?[0-9]+$/.test(obj)) {
                return +obj;
            }
            if(/^\d\d\d\d\-\d\d\-\d\d$/.test(obj)) {
                var dt = obj.split('-');
                return new Date(dt[0], dt[1] - 1, dt[2]);
            }
            return obj;
        }
    }

    function checkResponse(resp) {
        if(resp) {
            if(resp.Response) {
                if(resp.Response.status === 'OK') {
                    return true;
                } else {
                    util.log('Service call failed [' + resp.Response.status + '] ' + resp.Response.Message);
                }
            } else {
                util.log('Service call failed - Response root missing');
            }
        } else {
            util.log('Service call failed - No response');
        }
        return false;
    }

    function attributeMap(attributeArray) {
        var map = {};
        _.each(util.toArray(attributeArray || []), function(attr) {
            if(attr.name && attr.Value) {
                map[attr.name] = attr.Value;
            }
        });
        return map;
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand.Context, FD.Brand.Util);
/*global FD*/
;(function(win, $, _, brand, util) {

    var _overlays = {};
    var activeOverlay = null;
    var $background;
    var backgroundDef = $.Deferred();
    var backgroundAvailable = backgroundDef.promise();
    var focusElements = 'a:visible, input:visible, select:visible, button:visible, [data-fgx-keypress]:visible';

    // setup namespace
    _.extend(brand.namespace('FD.Brand.Overlay', win), {
        instance: _overlays,
        register: registerOverlay,
        show: showOverlay,
        trapFocus: trapFocus,
        releaseFocus: releaseFocus
    });

    $(init);

    //////

    function init() {
        $background = $('<div style="display: none;" class="fgx-brand-css"><div class="fgx-overlay-background"></div></div>');
        $background.appendTo($('body'));
        backgroundDef.resolve();

        /*
        // The two methods below were attempts to get scrolling to be disabled on the body content on iOS devices.
        // at the moment, they are blocking *all* scrolling (even on the overlay divs) so we've removed them for now...but
        // this may be a good place to pick up on later if we want to re-open the attempts to prevent the body scrolling on iOS.
        $(document).on('touchmove', 'body.no-scroll-sm', function(ev) {
           ev.preventDefault();
        });
        document.ontouchmove = function ( event ) {
            // manually intercept touchmove event on touch devices and, if it's a phone prevent scrolling explicitly on elements 
            // (such as 'body') that have the 'no-scroll-sm' class applied to them...this is a fix for iOS.
            if (util.currentBreakpoint() === 'gux-bkpt-sm') {
                var isTouchMoveAllowed = true, target = event.target;

                while ( target !== null ) {
                    if ( target.classList && target.classList.contains( 'no-scroll-sm' ) ) {
                        isTouchMoveAllowed = false;
                        break;
                    }
                    target = target.parentNode;
                }

                if ( !isTouchMoveAllowed ) {
                    event.preventDefault();
                }
            }

        };
        */
    }

    function registerOverlay(id, element, api, focusElements) {
        var overlay = {
            id: id,
            $el: $(element),
            api: api,
            focusElements: focusElements,
            show: _.wrap(id, showOverlay),
            hide: _.wrap(id, hideOverlay)
        };
        if (!_overlays[id]) {
            _overlays[id] = overlay;
        } else {
            if(overlay.$el.length > 0) {
                _overlays[id].$el = overlay.$el;
            }
        }
        return overlay;
    }

    function showOverlay(id, focusTrapEnable, currentTarget, firstFocus) {
        var ovr = _overlays[id];
        if(ovr.api && ovr.api.show && ovr.api.show(ovr) === false) {
            return;
        }
        if(activeOverlay) {
            hideOverlay(activeOverlay);
        }
        var scroll = ovr.$el.attr('data-overlay-scroll-offset');
        if(scroll && util.currentBreakpoint() !== 'gux-bkpt-sm') {
            scroll = scroll.split(',');
            //NZ 3/22
            var topPos = 0;
            var scrollTop = $(win).scrollTop();
            if (scrollTop < (+scroll[0])) {
                topPos = (+scroll[0])-scrollTop;
            } else {
                topPos = (+scroll[1]) + scrollTop;
            }
            topPos = topPos + 'px';

            //NZ 3/22: ovr.$el.css({'top': Math.max(+scroll[0], $(win).scrollTop() + (+scroll[1])) + 'px'});
            ovr.$el.css({'top': topPos});
        } else if(util.currentBreakpoint() === 'gux-bkpt-sm') {
            ovr.$el.css({'top': 0});
        }
        backgroundAvailable.done(function() {
            $background.fadeIn(100, function() {
                $background.one('click', ovr.hide);
                ovr.$el.fadeIn(300, function(){
                    // if we have a focusTrapEnable flag, trap focus
                    if (typeof focusTrapEnable != 'undefined' && focusTrapEnable == true) {
                        var elements = (typeof ovr.focusElements != 'undefined') ? ovr.focusElements : focusElements;
                        trapFocus(ovr, elements, firstFocus, currentTarget);
                    }
                });
            });
        });
        activeOverlay = id;
        $('body').addClass('no-scroll-sm fgx-brand-ovr-open');
    }

    function hideOverlay(id) {
        var ovr = _overlays[id];
        if(ovr.api && ovr.api.hide && ovr.api.hide(ovr) === false) {
            return;
        }
        activeOverlay = null;
        $background.off('click', ovr.hide);
        ovr.$el.fadeOut(300, function() {
            $background.fadeOut(100);
            ovr.$el.css({'top': null});
        });
        releaseFocus(ovr);
        $('body').removeClass('no-scroll-sm fgx-brand-ovr-open');
    }
    
    /**
     * Trap focus in a flip, for specified links, and return focus to element that opened flip upon close
     * @param ovr - the overlay we're trapping
     * @param flipLinks - ex: 'a, .dealer-modal-close' // links to tab through selector
     * @param flipFirst - ex: 'a' // type of link for first focus selector
     * @param lastFocus - ex: $(ev.currentTarget) // target modal opened from
     */
    function trapFocus(ovr, flipLinks, flipFirst, lastFocus, stopPropagation) {
        var $flipWrapper = ovr.$el,
            linkSelectors = flipLinks,
            links = $flipWrapper.find(linkSelectors);
        
        if (typeof lastFocus != 'undefined') {
            ovr.lastFocus = lastFocus;
        }
        
        if (flipFirst != null && typeof flipFirst != 'undefined') {
            // if we explicitly pass the selector of an element to focus, focus that element
            $flipWrapper.find(flipFirst).first().focus();
        } else {
            // if not, focus our first actionable item.
            if(links && links.length > 0) {
                links[0].focus();
            }
        }
        
        $flipWrapper.on('keydown', function (e) {
            var cancel = false;
            if (e.ctrlKey || e.metaKey || e.altKey) {
                return;
            }
            switch(e.which) {
                case 27: // ESC
                    ovr.hide();
                    lastFocus.focus();
                    cancel = true;

                    if (stopPropagation) {
                        e.stopPropagation();
                    }
                    break;
                case 9: // TAB
                    // refresh our links (contents change for type-ahead results, etc...)
                    links = $flipWrapper.find(linkSelectors);
                    if (e.shiftKey) {
                        if (e.target === links[0]) {
                            links[links.length - 1].focus();
                            cancel = true;
                        }
                    } else {
                        if (e.target === links[links.length - 1]) {
                            links[0].focus();
                            cancel = true;
                        }
                    }
                    break;
            }
            if (cancel) {
                e.preventDefault();
            }
        });
    }
    
    /**
     * Release focus from a flip.
     * @param ovr - the overlay we're releasing
     * 
     */
    function releaseFocus(ovr) {
        var $flipWrapper = ovr.$el;
        $flipWrapper.off('keydown');

        // NZ - if the skipLastFocus property is set to true, then return after removing the keydown listener but before updating the focus.
        if (ovr && ovr.skipLastFocus) {
            return;
        }

        if (ovr.lastFocus && typeof ovr.lastFocus != 'undefined') {
            ovr.lastFocus.focus();
        } else {
            // if we don't have an explicitly defined element, focus on the main navigation brand logo if defined or the first link on the page otherwise.
            if($('.fordMainNavigation').length > 0) {
                $('.fordMainNavigation a.navbar-brand').focus();
            } else if($('.lincolnMainNavigation').length > 0) {
                $('.lincolnMainNavigation a.navbar-brand:visible').focus();
            } else {
                $('a').first().focus();
            }
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util);


/*global FD*/
/**
 * Pricing support library
 *
 * Dynamically loads Single Payment Calculator if not available
 * Queries DOM elements looking for pricing data attributes and substituting pricing data
 *
 */
(function(win, $, _, brand, user, util, ngp) {

    // setup namespace
    _.extend(brand.namespace('FD.Brand.Pricing', win), {
        pricingData: getPricingData,
        label: getLabel,
        refresh: refresh,
        format: formatPrice,
        show: showFlip,
        postalLink: postalLink,
        formatPriceTipData: formatPriceTipData,
        price: getPrice,
        planId: getPlanId
    });

    var FALLBACK_POSTALCODE = { US: '48120', CA: 'L6J5E4' };
    var _ctx = FD.Brand.Context;
    var _make = _ctx.make;
    var _langKey = _ctx.languageKey;
    var _spcLock = false;
    var _baseCtx = {
        make: _make,
        model: _ctx.nameplate && _ctx.nameplate.ngpModelName,
        year: _ctx.nameplate && _ctx.nameplate.ngpYear
    };
    var _baseLabels = _ctx.priceLabel;
    var _refreshList = [];
    var _pricingDataCache = {};
    var _trimCache = {};
    var _initPromise = null;
    var _nameplatePricing = brand.Context.nameplatePricing;
    var _userPricing = user.pricing.current();
    var _postalLinkPrefix = (_ctx.accessibility && _ctx.accessibility.postalCodeLabelPrefix) || '';
    var _mtxActions = null;

    user.location.subscribe(function() {
        //init().done(function() {
            util.log('context change, refreshing pricing');
            _pricingDataCache = {};
            _.each(_refreshList, function(element) {
                refresh(element, 1);
            });
            var pc = user.location.current().postalCode;
            var pcLabel = _postalLinkPrefix + ' ' + pc;
            $('[data-fgx-postal-link]').text(pc).attr('aria-label', pcLabel);
        //});
    }, true);

    // ------------------------------------------------------------------

    function init() {
        if(_initPromise !== null) {
            return _initPromise;
        }
        var def = $.Deferred();
        var initPricing = function() {
            if(win.fdcc) {
                win.fdcc.init(function() {
                    def.resolve();
                });
            } else {
                util.log('pricing - spc loader failed to initialize');
                def.reject();
            }
        };

        if(!_mtxActions) {
            _mtxActions = brand.Context && brand.Context.mtxActions;
        }

        if(!win.fdcc) {
            var path = '/aemservices/common/api/component/loader.js/golf-spc?';
            if(_ctx.settings.env !== 'local') {
                path = (_ctx.settings['shopUrl' + _ctx.make + _ctx.languageKey] ||
                        _ctx.settings['shopUrl' + _ctx.make]) + util.url.prepend(path, '/cmslibs');
            }
            if(_ctx.region === 'CA' && _ctx.languageKey === 'FR') {
                path = path.replace('loader.js', 'loader.ext.js');
            }
            util.url.loadAsScript(path +
                $.param({
                    make: _make,
                    region: _ctx.region,
                    serviceurl: _ctx.settings.ngpServiceUrl
                })).done(function() {
                    initPricing();
                }).fail(function(jqxhr, settings, error) {
                    util.log('pricing - failed to load spc loader ' + error);
                    def.reject();
                });
        } else {
            initPricing();
        }
        _initPromise = def.promise();
        return _initPromise;
    }

    function resolveConfig(cfg, flip) {
        var cfg = $.extend({
            zipcode: user.location.current().postalCode || FALLBACK_POSTALCODE[FD.Brand.Context.region],
            plantype: _userPricing.planType
        }, _baseCtx, _.pick(cfg, _.identity));
        if(!flip) {
            cfg.paymentFrequency = _ctx.paymentFrequency || 'monthly';
        }
        if(cfg.model) {
            cfg.options = (cfg.options || {});
            cfg.options.allowChangeVehicle = false;
        }
        return cfg;
    }

    function formatPrice(price) {
        if(_.isNumber(price)) {
            // TEMP: format price for FoC fr.  Ideally the format should be defined in settings
            return (_ctx.language === 'fr')
                ? price.toFixed(0).replace(/./g, function (c, i, a) {
		            return i && c !== '.' && ((a.length - i) % 3 === 0) ? ' ' + c : c;
	            }) + ' $'
                : '$' + price.toFixed(0).replace(/./g, function (c, i, a) {
                    return i && c !== '.' && ((a.length - i) % 3 === 0) ? ',' + c : c;
                });
        }
    }
    
    function formatPriceTipData(priceDetail) {
        if (priceDetail) {
            var data = priceDetail.pricingData || {};
            var incentives = priceDetail.pricingData.incentiveList;
            var planId = getPlanId(priceDetail);
            var pricingData = {
                basePrice: formatPrice(priceDetail.pricingData.basePrice),
                options: formatPrice(priceDetail.pricingData.options),
                destinationCharges: formatPrice(priceDetail.pricingData.destinationCharges),
                sellingPrice: formatPrice(priceDetail.pricingData.sellingPrice),
                totalIncentives: formatPrice(priceDetail.pricingData.incentives),
                price: formatPrice(priceDetail.pricingData.price),
                showFriendsAndNeighbors: (priceDetail.pricingData.showFriendsAndNeighbors && priceDetail.pricingData.showFriendsAndNeighbors == true),
                friendsAndNeighborsSavings: formatPrice(priceDetail.pricingData.friendsAndNeighborsSavings),
                incentives: [],
                paymentType: data.paymentType,
                planId: planId,
                planTypes: {
                    'msrp': (planId === 'msrp'),
                    'az': (planId === 'az'),
                    'x': (planId === 'x')
                }
            };
            // NZ: BRAND-17568
            if (_ctx.region === 'CA') {
                _.assign(pricingData, {
                    caDeliveryAllowance: data.caDeliveryAllowance && formatPrice(data.caDeliveryAllowance),
                    caSupplementDeliveryAllowance: data.caSupplementDeliveryAllowance && formatPrice(data.caSupplementDeliveryAllowance),
                    caEmployeePricingDiscount: data.caEmployeePricingDiscount && formatPrice(data.caEmployeePricingDiscount),
                    caAcTax: data.caAcTax && formatPrice(data.caAcTax),
                    caGreenLevy: data.caGreenLevy && formatPrice(data.caGreenLevy),
                    caSalesTax: data.caSalesTax && formatPrice(data.caSalesTax),
                    caLeasePaymentSalesTax: data.caLeasePaymentSalesTax && formatPrice(data.caLeasePaymentSalesTax),
                    totalIncentives: data.incentives && formatPrice(data.incentives),
                    tradeIn: data.tradeIn && formatPrice(data.tradeIn),
                    hasBuyPaymentType: !!(data.paymentType && data.paymentType === 'buy'),
                    hasLeasePaymentType: !!(data.paymentType && data.paymentType === 'lease')
                });
            }
            if (incentives) {
                for (var i = 0; i < incentives.length; i ++) {
                    var incentiveItem = {
                        name: incentives[i].Name,
                        disclaimer: incentives[i].Disclaimer,
                        amount: formatPrice(incentives[i].Amount),
                        offerValidRange: FD.Brand.Util.dateTime.longFormat(incentives[i].StartDate) + '-' + FD.Brand.Util.dateTime.longFormat(incentives[i].ExpiryDate)
                    }
                    pricingData.incentives.push(incentiveItem);
                }
            }
            return pricingData;
        }
    }

    function pricingAttribute($el, attributeName) {
        return $.parseJSON($el.closest('[' + attributeName + ']').attr(attributeName) || '{}');
    }

    function postalLink() {
        var pc = user.location.current().postalCode || '';
        var pcLabel = _postalLinkPrefix + ' ' + pc;
        return '<a data-fgx-postal-link href="#$postalCode" role="button" data-fgx-keypress="true" aria-label="' + pcLabel + '">' + (user.location.current().postalCode || '(Enter a Location)') + '</a>';
    }

    function viewAllOffersLink() {
        var label = 'view all offers',
            ariaLabel = '',
            mtxAction = _mtxActions && _mtxActions.viewOffersClickAction,
            mtxActionAttr = (mtxAction) ? (" data-fd-metrics-click='" + mtxAction + "'") : '';
        if(_ctx && _ctx.pricingDisclaimerLabels) {
            label = _ctx.pricingDisclaimerLabels.viewOffersLabel || 'view all offers';
            ariaLabel = _ctx.pricingDisclaimerLabels.viewOffersAriaLabel || '';
        }

        return '<a data-fgx-view-offers-link href="#$incentives" data-fgx-keypress="true" aria-label="' + ariaLabel + '"' + mtxActionAttr + '>' + label + '</a>';
    }

    function showFlip(cfg, $el) {
        var def = $.Deferred();
        init().done(function() {
            var spcCfg = resolveConfig(cfg, true);
            var trimId = cfg.trimId;
            $.when(trimId && pricingTrims(cfg)).done(function(trimData) {
                var trimDetail = trimData && trimData[(trimId || '').trim()];
                if (trimDetail) {
                    spcCfg.trim = trimDetail.token;
                }
                var currentPostalCode = user.location.current().postalCode;
                var postalFlipEvent = false;
                win.fdcc.spc.reset();
                win.fdcc.spc.show(function(resp) {
                    // check for postal code update
                    if(postalFlipEvent && resp.zipcode !== currentPostalCode) {
                        user.location.setPostalCode(resp.zipcode);
                    }
                    def.resolve(resp);
                }, spcCfg, function(eventName) {
                    if('PostalCodeEntryView' === eventName) {
                        postalFlipEvent = true;
                    }

                    var metrics = brand && brand.Metrics || {handler: { direct: function() {}}};
                    //Event handling for metrics
                    if ('FinanceTabView' === eventName) {
                        // new metrics
                        if(_mtxActions && !metrics.spcFlags.tabDisplayed('finance')) {
                            var action = (metrics.spcFlags.tabDisplayed('lease')) ? 'spcFinanceTabAdditionalViewAction' : 'spcFinanceTabViewAction';
                            metrics.handler.direct(
                                _mtxActions[action]
                            );
                            metrics.spcFlags.set('finance', true);
                        }
                    } else if ('LeaseTabView' === eventName) {
                        // new metrics
                        if(_mtxActions && !metrics.spcFlags.tabDisplayed('lease')) {
                            var action = (metrics.spcFlags.tabDisplayed('finance')) ? 'spcLeaseTabAdditionalViewAction' : 'spcLeaseTabViewAction';
                            metrics.handler.direct(
                                _mtxActions[action]
                            );
                            metrics.spcFlags.set('lease', true);
                        }
                    } else if ('FinancePrintClick' === eventName) {
                        // new metrics
                        if(_mtxActions) {
                            metrics.handler.direct(
                                _mtxActions.spcFinancePrintClickAction
                            );
                        }
                    } else if ('LeasePrintClick' === eventName) {
                        // new metrics
                        if(_mtxActions) {
                            metrics.handler.direct(
                                _mtxActions.spcLeasePrintClickAction
                            );
                        }
                    } else if ('CreditLinkClick' === eventName) {
                        // new metrics
                        if(_mtxActions) {
                            metrics.handler.direct(
                                _mtxActions.spcCreditLinkClickAction
                            );
                        }
                    } else if ('CalculatorHidden' === eventName) {
                        // new metrics
                        if(_mtxActions) {
                            metrics.handler.direct(
                                _mtxActions.spcCalculatorHiddenAction
                            );
                        }
                        metrics.spcFlags.reset();
                    }
                }, $el);

            });
        }).fail(function() {
            def.reject();
        });
        return def.promise();
    }

    /**
     * Refresh pricing templates for given element
     * @param $el
     */
    function refresh(element, noTrack) {
        var def = $.Deferred();
        var templateAttrSelector = '[data-pricing-template],[data-pricing-template-lease],[data-pricing-template-finance],[data-pricing-template-cash]';
        if(!noTrack) {
            _refreshList.push(element);
        }
        // init().done(function() {
            var elements = [];
            var templatePromises = [];
            $(templateAttrSelector, element).each(function () {
                var $el = $(this);
                var defTemp = $.Deferred();
                var templateText = $el.attr('data-pricing-template');
                var pricePlaceholderOnly = checkTemplateForPlaceholder(templateText, '{price}');
                var cfg = resolveConfig(pricingAttribute($el, 'data-pricing-context'), false);
                var trimId = $el.attr('data-pricing-trim') || cfg.trimId;
                if(!trimId && !cfg.configToken && !cfg.vin && pricePlaceholderOnly) {
                    // short circuit to use nameplate pricing
                    var pricing = _.find(_nameplatePricing, { model: cfg.model, year: cfg.year });
                    var priceValue = getPrice(pricing);
                    var price = formatPrice(priceValue);
                    var data = {
                        'price': price || '{price}'
                    };
                    var text;
                    if(templateText === '{price}') {
                        text = data.price;
                    } else {
                        var template = _.template(templateText || '',
                            {interpolate: /{([\s\S]+?)}/g});
                        text = template(data);
                    }
                    $el.html(text);
                    if(price) {
                        $el.data('pricing', {
                            price: price,
                            priceValue: priceValue
                        });
                    }
                    updateLabels($el, pricing);
                    elements.push($el);
                    defTemp.resolve();
                    return;
                }
                $.when(trimId && pricingTrims(cfg)).done(function(trimData) {
                    var trimDetail = null;
                    var spcTrimId = null;
                    // translate trim id for SPC
                    if(trimId) {
                        trimDetail = trimData && trimData[(trimId || '').trim()];
                        if(trimDetail) {
                            if(pricePlaceholderOnly) {
                                var priceValue = getPrice(trimDetail);
                                var price = formatPrice(priceValue);
                                var data = {
                                    'price': price || '{price}'
                                };
                                var text;
                                if(templateText === '{price}') {
                                    text = data.price;
                                } else {
                                    var template = _.template(templateText || '',
                                        {interpolate: /{([\s\S]+?)}/g});
                                    text = template(data);
                                }
                                $el.html(text);
                                if(price) {
                                    $el.data('pricing', {
                                        price: price,
                                        priceValue: priceValue
                                    });
                                }
                                updateLabels($el, trimDetail);
                                elements.push($el);
                                defTemp.resolve();
                                return;
                            }
                            spcTrimId = trimDetail.token;
                        } else {
                            spcTrimId = '#none#';
                            util.log('Invalid trim id ' + trimId, trimData);
                        }
                    }
                    getPricingData(cfg).done(function(result) {
                        var data;
                        var text = templateText;
                        data = (spcTrimId) ? _.find(result, {trim: spcTrimId}) : result;
                        if (_.isArray(data)) {
                            data = data[0]
                        }

                        if(data) {
                            if (useAsShownLabel($el)) {
                                data.pricingLabel = getAsShownLabel(pricingAttribute($el, 'data-pricing-labels'), data);
                            } else {
                                data.pricingLabel = getLabel(pricingAttribute($el, 'data-pricing-labels'), data);
                            }
                            templateText = templateText || $el.attr('data-pricing-template-' + data.offerType);
                            var template = _.template(templateText,
                                {interpolate: /{([\s\S]+?)}/g});
                            text = template(data);
                        }
                        $el.html(text);
                        updateLabels($el, data);
                        $el.data('pricing', data);
                        elements.push($el);
                        defTemp.resolve();
                    }).fail(function() {
                        util.log('pricing - getPricingData call failed for cfg: ', cfg);
                        // NZ - resolve the defTemp promise here so the 'done' callback of the templatePromises is properly triggered below.
                        defTemp.resolve();
                    });
                });
                templatePromises.push(defTemp.promise());
            });
            //Update the monthly prices to display if a valid postal code is set.
            $('[data-pricing-payment-toggle]', element).toggleClass('fgx-brand-hidden', !(!!user.location.current().postalCode));
            //Check that the postalCode
            $.when.apply($, templatePromises).done(function() {
                def.resolve(elements);
            });
        // }).fail(function() {
        //     // pricing not available, update with template text as placeholder
        //     var attrs = templateAttrSelector.replace(/[\[\]]/g, '').split(',');
        //     $(templateAttrSelector, element).each(function() {
        //         var $el = $(this);
        //         _.each(attrs, function(attr) {
        //             var template = $el.attr(attr);
        //             if(template) {
        //                 $el.html(template);
        //                 return false;
        //             }
        //         });
        //     });
        // });
        return def.promise();
    }
    
    function useAsShownLabel($el) {
        return ($el.closest('[data-pricing-context]').attr('data-pricing-use-as-shown') === 'true');
    }

    function getPlanId(pricing) {
        var planType = _userPricing.planType;
        if(_.isBoolean(pricing.planApplicable)) {
            return (pricing.planApplicable) ? {'MSRP': 'msrp', 'AZ': 'az'}[planType] || 'x' : 'msrp';
        } else {
            return (planType !== 'MSRP' &&
                (_userPricing.planType === 'AZ'
                    ? pricing.az && 'az'
                    : !(pricing[_userPricing.planType.toLowerCase()] === false) && pricing.x && 'x'))
                || 'msrp';
        }
    }

    function getPrice(pricing) {
        return pricing && pricing[getPlanId(pricing)];
    }

    function getLabel(labels, pricing) {
        return $.extend({}, _baseLabels, labels)[pricing && getPlanId(pricing) || 'msrp'];
    }
    
    function getAsShownLabel(labels, pricing) {
        return $.extend({}, _baseLabels, labels)[pricing && ('as-shown_' + getPlanId(pricing)) || 'as-shown_msrp'];
    }

    function updateLabels($el, pricing) {
        var labels = pricingAttribute($el, 'data-pricing-labels');
        var parentSelector = $el.attr('data-pricing-label-parent-selector');
        var $parentEl = (parentSelector && typeof(parentSelector) != 'undefined') ? $el.closest(parentSelector) : $el.parent();

        if($parentEl && $parentEl.length > 0) {
            var label = (useAsShownLabel($el)) ? getAsShownLabel(labels, pricing) : getLabel(labels, pricing);
            $parentEl.find('[data-pricing-label]').html(label);
        }
        //NZ was - $el.parent().find('[data-pricing-label]').html(getLabel(labels, pricing));
    }

    /**
     * Check if the passed in placeholder exists in the templateText, and if so, if it is the only placeholder used.
     * Will return true if the passed in placeholder is the only placeholder used within templateText. Otherwise, returns false.
    **/
    function checkTemplateForPlaceholder(templateText, placeholder) {
        var flag = false,
            ph = placeholder || '{price}';

        if(templateText && typeof(templateText) != 'undefined') {
            var res = templateText.match(/{([\s\S]+?)}/g);

            if(res) {
                var tmpFlag = true;
                _.each(res, function(item) {
                    if(item != ph) {
                        tmpFlag = false;
                    }
                });
                flag = tmpFlag;
            }
        }

        return flag;
    }

    function getPricingData(cfg) {
        var key = [cfg.make, cfg.model, cfg.year, cfg.configToken, cfg.vin].join('');
        var pricingPromise = _pricingDataCache[key];
        if(!pricingPromise) {
            if(!(cfg.make && cfg.model && cfg.year)) {
                pricingPromise = $.when(null);
            } else {
                var def = $.Deferred();
                init().done(function () {
                    // SPC is not reentrant, poll until available
                    var pollPricing = function () {
                        if (!win.fdcc.spc.isBusy() && !_spcLock) {
                            _spcLock = true;
                            ((cfg.configToken || cfg.vin) ? detail(cfg) : models(cfg)).done(function (result) {
                                _spcLock = false;
                                if (result) {
                                    def.resolve(result);
                                } else {
                                    def.reject();
                                }
                            });
                        } else {
                            setTimeout(pollPricing, 100);
                        }
                    };
                    pollPricing();
                }).fail(function() {
                    def.reject();
                });
                pricingPromise = def.promise();
            }
            _pricingDataCache[key] = pricingPromise;
        }
	    return pricingPromise;
    }

    function detail(cfg) {
        var def = $.Deferred();
        win.fdcc.spc.calculate(function (resp) {
            if (resp) {
                /* NZ: BRAND-17526 - Added basePrice to the object below. This is to support showing the BaseMSRP as the
                   starting at price when a configToken is used. (i.e. in the simple reservations component) */
                var pricing = {
                    id: resp.trimName && resp.trimName.substr(resp.model.length + 1).replace(/ /g, '').toLowerCase(),
                    trim: resp.trim,
                    trimName: resp.trimName,
                    offerType: (resp.paymentType === 'lease') ? 'lease' : ((resp.buy && resp.buy.specialApr) ? 'finance' : 'cash'),
                    price: formatPrice(resp.price),
                    priceValue: resp.price,
                    paymentType: resp.paymentType,
                    baseAsShown: formatPrice(resp.baseAsShown),
                    basePrice: formatPrice(resp.basePrice || resp.price),
                    pricingData: resp,
                    payment: formatPrice(resp.payment),
                    apr: (resp.buy && resp.buy.apr) || (resp.lease && resp.lease.apr),
                    term: (resp.buy && resp.buy.term) || (resp.lease && resp.lease.term),
                    signingAmount: formatPrice(resp.lease && resp.lease.signingAmount),
                    pricingDate: FD.Brand.Util.dateTime.longFormat(),
                    planApplicable: resp.planApplicable,
                    postalCode: postalLink(),
                    hasPostalCode: (!!user.location.current().postalCode),
                    downPayment: formatPrice(resp.downPayment),
                    incentives: formatPrice(resp.incentives),
                    viewOffersLink: viewAllOffersLink()
                };

                switch (pricing.offerType) {
                    case 'lease':
                        pricing.offerText = formatPrice(resp.payment) + '/mo ' + resp.lease.term + ' month lease';
                        break;
                    case 'finance':
                        pricing.offerText = formatPrice(resp.payment) + '/mo ' + resp.buy.term + ' month finance';
                        break;
                }
                def.resolve(pricing);
            } else {
                def.resolve(null);
            }
        }, resolveConfig(cfg, false));
        return def.promise();
    }

    function models(cfg) {
        var def = $.Deferred();
        var resolvedConfig = resolveConfig(cfg, false);
        pricingTrims(cfg).done(function(trimData) {
            // If the pricingTrims promise is resolved with a null value, then there must be something preventing the modelSlices
            // call from succeeding. When this happens, we should be able to resolve the current promise with a null value
            // without calling calculateTrimPayments.
            if (trimData === null) {
                def.resolve(null);
                return;
            }
            win.fdcc.spc.calculateTrimPayments(function(resp) {
                if (resp && resp.trimPayments) {
                    var models = _.map(resp.trimPayments, function(trim) {
                        var bestOffer = null, bestOfferType = null;
                        var ngpTrim = trimData && _.find(trimData, { token: trim.trim });
                        _.each(['lease', 'finance', 'cash'], function(offerType) {
                            var offer = trim[offerType];
                            var pmt = offer && offer.payment;
                            if(pmt && (!bestOffer || bestOffer.payment > pmt)) {
                                bestOffer = offer;
                                bestOfferType = offerType;
                            }
                        });
                        // If bestOffer still isn't set (for example, if the price values returned are all 0) then set it to
                        // an empty object. This should prevent errors from being thrown later when trying to access properties
                        // on the bestOffer object.
                        if (!bestOffer) {
                            bestOffer = {};
                        }

                        /* NZ: BRAND-17526 - Added basePrice to the modelPricing object below to keep it consistent with the
                           response from the detail call above. This is currently set to just use the same value as the price
                           attribute, so we'll need to verify the value is correct before using (if there is a time when this is needed).*/
                        var startingPrice = ngpTrim ? getPrice(ngpTrim) : bestOffer.basePrice ;
                        var modelPricing = {
                            id: trim.trimName && trim.trimName.substr(resp.model.length + 1).replace(/ /g, '').toLowerCase(),
                            trim: trim.trim,
                            trimName: trim.trimName,
                            ngpTrimName: ngpTrim && ngpTrim.ngpTrimName,
                            offer: bestOffer,
                            offerType: bestOfferType,
                            offerPrice: formatPrice(bestOffer.price),
                            offerPriceValue: bestOffer.price,
                            price: formatPrice(startingPrice),
                            basePrice: formatPrice(startingPrice),
                            priceValue: startingPrice,
                            paymentType: bestOffer.paymentType,
                            baseAsShown: formatPrice(bestOffer.baseAsShown),
                            pricingData: trim,
                            payment: formatPrice(bestOffer.payment),
                            apr: (bestOffer.buy && (bestOffer.buy.apr)) || (bestOffer.lease && bestOffer.lease.apr),
                            term: (bestOffer.buy && bestOffer.buy.term) || (bestOffer.lease && bestOffer.lease.term),
                            signingAmount: formatPrice(bestOffer.lease && bestOffer.lease.signingAmount),
                            pricingDate: FD.Brand.Util.dateTime.longFormat(),
                            postalCode: postalLink(),
                            planApplicable: bestOffer.planApplicable,
                            hasPostalCode: (!!user.location.current().postalCode),
                            downPayment: formatPrice(bestOffer && bestOffer.downPayment),
                            incentives: formatPrice(bestOffer && bestOffer.incentives),
                            viewOffersLink: viewAllOffersLink()
                        };

                        switch(bestOfferType) {
                            case 'lease':
                                modelPricing.offerText = formatPrice(bestOffer.payment) + '/mo ' + bestOffer.lease.term + ' month lease';
                                break;
                            case 'finance':
                                modelPricing.offerText = formatPrice(bestOffer.payment) + '/mo ' + bestOffer.buy.term + ' month finance';
                                break;
                        }
                        return modelPricing;
                    });
                    def.resolve(models);
                } else {
                    def.resolve(null);
                }
            }, resolvedConfig);
        });
        return def.promise();
    }

    function pricingTrims(context) {
        var defer = $.Deferred();
        var promise = defer.promise();
        if(!(context.model && context.year)) {
            defer.resolve(null);
        } else {
            var key = _.values(_.pick(context, ['model', 'year'])).join('-');
            var prm = _trimCache[key];
            if (prm) {
                if (prm.promise) {
                    promise = prm;
                } else {
                    defer.resolve(prm);
                }
            } else {
                // check session storage
                var prmJson = win.sessionStorage.getItem('fgx-pricing-trims-' + key);
                if (prmJson) {
                    prm = JSON.parse(prmJson);
                    _trimCache[key] = prm;
                    defer.resolve(prm);
                } else {
                    _trimCache[key] = promise;
                    prm = {};
                    ngp.modelSlices(_.assign({}, context, {
                        modelSliceDefiners: 'ST_Display_Trim_Names',
                        modelSliceAttributes: 'ST_Display_Trim_Names',
                        planType: _userPricing.planType,
                        appContext: 'T1'
                    })).done(function (model) {
                        _.each(util.toArray(util.objPath(model, 'ModelSlices.ModelSlice') || []), function (ms) {
                            var msAttr = ngp.attributeMap(ms.Attribute);
                            var stId = msAttr.ST_Display_Trim_Names || '';
                            var pricing = ms.Pricing;
                            var applicable = pricing.PlanApplicability;
                            var val = {
                                ngpTrimName: stId,
                                token: ms.ConfigToken,
                                msrp: parseFloat((_ctx.region === 'CA') ? pricing.StartingAtPrice : pricing.BaseMSRP)
                            };
                            if(_ctx.region !== 'CA') {
                                if (applicable.AZ === 'true') {
                                    val.az = parseFloat(pricing.BaseAZPlan);
                                }
                                val.x = parseFloat(pricing.BaseXPlan);
                                if (applicable.SPX === applicable.FNX && applicable.FNX === applicable.PRX) {
                                    if (applicable.SPX !== 'true') {
                                        delete val.x;
                                    }
                                } else {
                                    _.each(['SPX', 'FNX', 'PRX'], function (plan) {
                                        val[plan.toLowerCase()] = applicable[plan] === 'true';
                                    })
                                }
                            }
                            if (stId) {
                                prm[stId] = val;
                                prm[stId.replace(/[^A-Za-z0-9\-\_\:]/g, '').toLowerCase()] = val;
                            }
                        });
                        _trimCache[key] = prm;
                        try {
                            win.sessionStorage.setItem('fgx-pricing-trims-' + key, JSON.stringify(prm));
                        } catch (ex) {
                            
                        }
                        defer.resolve(prm);
                    }).fail(function() {
                        util.log('pricing - modelSlices call failed.');
                        defer.resolve(null);
                    });
                }
            }
        }
        return promise;
    }

} )(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.User, FD.Brand.Util, FD.Brand.NgpServices);

;(function(doc, util) {
    'use strict';

    // check for picture support
    checkPictureSupport();

    //////

    /**
     * Check for picture tag support, load polyfill if not found
     */
    function checkPictureSupport() {
        var img = doc.createElement('img');
        if(!(('srcset' in img) && ('sizes' in img))) {
            util.url.loadAsScript(
                '/cmslibs/etc/designs/brand_ford/brand/vendor/picturefill/js/picturefill.min.js',
                { 'async': '' });
        }
    }

})(document, FD.Brand.Util);
/*global FD*/
;(function(win, $, _, brand, util, ctx) {

    var initialized = false;
    var _settings = ctx && ctx.settings;
    var _globalBcpConfig = {
        'brightcoveAccountId': _settings && _settings.videoAccount,
        'brightcovePlayerId': _settings && _settings.videoPlayerKey,
        'isYoutube': false,
        'defaultFilmstripExpanded': false
    };
    var _bcpInstances = null;
    var _bcpState = null;
    var _loadBcp = getAsyncTopic(loadBcFramework);

    // setup namespace
    _.extend(brand.namespace('FD.Brand.Video', win), {
        bcp: {
            create: bcpCreatePlayer,
            resetInstance: resetBcpInstance
        },
        videoItem: {
            create: function(config) {
                return new VideoItem(config);
            }
        }
    });

    //////

    // helper for topics retrieved asynchronously
    // wraps a common promise that is returned
    // deferred is passed into load function and resolved when topic is loaded
    // this makes the function reentrant without initiating multiple requests to load topic
    function getAsyncTopic(fnLoad) {
        var promise = null;
        var fn = function() {
            var def;
            if(promise === null) {
                def = $.Deferred();
                promise = def.promise();
                fnLoad(def);
            }
            return promise;
        };
        fn.$_reset = function() {
            promise = null;
        };
        return fn;
    }

    function loadBcFramework(def) {
        var resolveState = function() {
            def.resolve(_.assign({},_bcpState));
        };
        if (_bcpState) {
            resolveState();
        } else {
            _bcpState = {
                loaded: false,
                basePath: '/cmslibs/etc/designs/brand_ford/brand/vendor/brightcove/js'
            };

            util.url.loadAsScript(_bcpState.basePath + '/bcgs_ford_player_framework.min.js').done(function() {
                _bcpState.loaded = true;

                try {
                    FordPlayer.setPageWideConfig(_globalBcpConfig);
                } catch(e) {
                    util.log("video.lib: There was an error setting the pageWideConfig");
                }

                resolveState();
            }).fail(function(resp) {
                util.log('video.lib: failed to load the brightcove plugin framework', resp);
                resolveState();
            });
        }
    }

    /*
     * Simple API to standardize some of the logic needed that may be different between the Brightcove and Youtube players.
     */
    function bcpPlayerAPIWrapper(config, framework, player) {
        var api = {};
        if(framework && player) {
            api = {
                autoplay: function () {
                    var shouldAutoplay = (util.currentBreakpoint === 'gux-bkpt-sm') ? false : true;
                    player.autoplay(shouldAutoplay);

                    player.one("play", function() {
                        player.autoplay(true);
                    });
                },
                getCurrentTime: function () {
                    // BCP Update - Standardize logic to properly handle getting the current time from both BC and YT players.
                    var cT = 0;
                    try {
                        cT = (config && config.isYoutube) ? player.getCurrentTime() : player.currentTime();
                    } catch(e) {
                        util.log("video.lib::apiWrapper.getCurrentTime - issue retrieving currentTime from player.");
                    }
                    return cT;
                },
                setConfig: function (_config) {
                    config = _.extend({}, config, _config);
                },
                setCurrentVideo: function (_currentVideo) {
                    config.currentVideo = _currentVideo;
                },
                hasFullscreen: function() {
                    // BCP Update - youtube player doesn't indicate when the fullscreen mode is entered, so we use this
                    // check to ensure the logic is only run when using a Brightcove player.
                    return !!(config && !config.isYoutube);
                },
                isFullscreen: function() {
                    var isFS = false;
                    try {
                        isFS = player.isFullscreen() || false;
                    } catch(e) {
                        util.log("video.lib::apiWrapper.isFullscreen - issue retrieving fullscreen value from player");
                    }
                    return isFS;
                }
            };
        }
        return api;
    }

    function bcpCreatePlayer(bcpConfig, brandConfig) {
        var def = $.Deferred();
        bcpInitPlayer(bcpConfig, brandConfig).then(function(playerDetail) {
            var config = _.extend({}, brandConfig, bcpConfig);
            if (playerDetail && playerDetail.playerApi) {
                playerDetail.playerApi.setConfig(config);
            }

            var obj = _.extend({}, config, playerDetail);

            if (obj && obj.bcpFramework && !obj.firstInstance) {
                // if the player has already been created before, then we need to reinitialize it with the latest config
                obj.bcpFramework.reInit(bcpConfig);
            }

            def.resolve(obj);
        }, function() {
            //Added to handle error state when player is not loaded due to privacy settings.
            def.resolve(null);
        });
        return def.promise();
    }

    function bcpInitPlayer(bcpConfig, brandConfig) {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            var instId = brandConfig && brandConfig.fgxInstanceId || '';
            if (_bcpInstances && _bcpInstances[instId] && _bcpInstances[instId].initialized) {
                _bcpInstances[instId].firstInstance = false;
                def.resolve(_bcpInstances[instId]);
            } else {
                _bcpInstances = _bcpInstances || {};
                var bcVidDetail = {};
                var _instId = instId;
                var settings = brand.Context.settings;
                var language = brand.Context.language;

                bcVidDetail.firstInstance = true;

                if (brandConfig && brandConfig.fgxSetupSlideItem) {
                    var data = {
                        typeSelector: brandConfig.slideItemClass,
                        playerWrapperId: bcpConfig.placeHolderDivId,
                        slideHeadlineId: brandConfig.slideHeadlineId
                    };
                    var $bcSlideItem = $(brandConfig.template(data));

                    $bcSlideItem.addClass('active');
                    $bcSlideItem.appendTo(brandConfig.slideContainer);
                    bcVidDetail.slideItem = $bcSlideItem;
                }

                _loadBcp().done(function(state) {
                    if (state.loaded) {
                        bcVidDetail.initialized = true;
                        bcVidDetail.bcpFramework = FordPlayer.create(bcpConfig);
                        bcVidDetail.bcpFramework.on('ready', function() {
                            bcVidDetail.player = bcVidDetail.bcpFramework.getPlayer();
                            bcVidDetail.playerApi = bcpPlayerAPIWrapper(_.assign({}, brandConfig, bcpConfig), bcVidDetail.bcpFramework, bcVidDetail.player);
                            _bcpInstances[_instId] = bcVidDetail;
                            def.resolve(_bcpInstances[_instId]);
                        });
                    } else {
                        bcVidDetail.initialized = false;
                        bcVidDetail.bcpFramework = null;
                        bcVidDetail.player = null;
                        bcVidDetail.playerApi = null;
                        _bcpInstances[_instId] = bcVidDetail;
                        def.resolve(_bcpInstances[_instId]);
                    }
                });
            }
        } else {
            util.log('video.lib: Brightcove Player Framework library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    function resetBcpInstance(id) {
        if (_bcpInstances && _bcpInstances[id]) {
            _bcpInstances[id].initialized = false;
        }
    }


    // New VideoItem Class
    function VideoItem(config) {
        this.config = _.assign({}, config || {});
        this.settings = _.assign({}, this.config.settings || {});
        this.actions = _.assign({}, this.config.actions || {});
        this.id = this.config.id || '';
        this.fgxInstanceId = this.config.fgxInstanceId || this.id;
        this.slideItem = this.config.slideItem;
        this.videoContainer = this.config.videoContainer;
        this.type = this.config.type;
        this.displayType = this.config.displayType;
        this.initialized = false;
        this.playing = false;
        this.loading = false;
        this.manuallyPaused = false;
        this.skipManualPauseUpdate = false;
        this.transitionLock = false;

        this._bcpBaseConfig = {
            'placeHolderDivId': this.config.id,
            'isYoutube': false,
            'showFilmstripToggle': !(this.config.displayType === 'inline'),
            'defaultFilmstripExpanded': false,
            'autoPlay': false
        };
        this._brandBaseConfig = {
            'fgxInstanceId': this.config.id,
            'fgxSetupSlideItem': !(this.config.displayType === 'inline')
        };

        this.bcpConfig = _.assign({}, this._bcpBaseConfig, this.config.bcpConfig || {});
        this.brandConfig = _.assign({}, this._brandBaseConfig, this.config.brandConfig || {});

        this._mtxBcpVidSegments = {
            'videoStart': {
            },
            'videoSegment25': {
                videoNamePercentageWatched: '25% complete'
            },
            'videoSegment50': {
                videoNamePercentageWatched: '50% complete'
            },
            'videoSegment75': {
                videoNamePercentageWatched: '75% complete'
            },
            'videoComplete': {
                videoNamePercentageWatched: 'video complete'
            }
        };

        this._topics = {};
        this._nextHandleId = 0;
    }

    VideoItem.prototype.autoplayBPClasses = {
        'gux-bkpt-sm': 'fgx-brand-video-autoplay-mbl',
        'gux-bkpt-med': 'fgx-brand-video-autoplay-tab',
        'gux-bkpt-lg': 'fgx-brand-video-autoplay-dsk',
        'gux-bkpt-xlg': 'fgx-brand-video-autoplay-dsk'
    };

    VideoItem.prototype.create = function(bcpConfig, brandConfig) {
        var def = $.Deferred();
        if (this.initialized) {
            def.resolve(this);
        } else {
            this.bcpConfig = _.assign({}, this.bcpConfig || {}, bcpConfig || {});
            this.brandConfig = _.assign({}, this.brandConfig || {}, brandConfig || {});
            var _this = this;

            brand.Video.bcp.create(this.bcpConfig, this.brandConfig).then(function(vConfig) {
                if(vConfig && vConfig.initialized) {
                    _this.config = _.assign({}, _this.config || {}, vConfig);
                    _this.initialized = true;
                    _this.config.bcScriptLoaded = true;

                    _this.setSettingsOnPlayer();

                    if (_this.config.bcpFramework) {
                        _this.config.bcpFramework.on('play', function() {
                            _this.playing = true;
                            _this.setManuallyPaused(false);
                            _this.publishTopic('play', {
                                topic: 'play',
                                inst: _this
                            });
                        });
                        _this.config.bcpFramework.on('pause', function() {
                            _this.playing = false;
                            _this.setManuallyPaused(true);
                            _this.publishTopic('pause', {
                                topic: 'pause',
                                inst: _this
                            });
                        });
                        _this.config.bcpFramework.on('ended', function() {
                            _this.playing = false;
                            _this.setManuallyPaused(true, true);
                            _this.publishTopic('ended', {
                                topic: 'ended',
                                inst: _this
                            });
                        });
                        _this.config.bcpFramework.on('loaded', function() {
                            _this.publishTopic('loaded', {
                                topic: 'loaded',
                                inst: _this
                            });
                        });
                        _this.config.bcpFramework.on('videoStart', function(data) {
                            _this.segmentUpdate('videoStart');
                        });
                        _this.config.bcpFramework.on('first-quartile', function(data) {
                            _this.segmentUpdate('videoSegment25');
                        });
                        _this.config.bcpFramework.on('second-quartile', function(data) {
                            _this.segmentUpdate('videoSegment50');
                        });
                        _this.config.bcpFramework.on('third-quartile', function(data) {
                            _this.segmentUpdate('videoSegment75');
                        });
                        _this.config.bcpFramework.on('fourth-quartile', function(data) {
                            _this.segmentUpdate('videoComplete');
                        });

                        if (_this.config.playerApi && _this.config.playerApi.hasFullscreen() && _this.config.player) {
                            _this.config.player.on("fullscreenchange", function() {
                                if(_this.config.playerApi) {
                                    var isFS = _this.config.playerApi.isFullscreen();
                                    if(isFS) {
                                        _this.fireMetricAction('videoExpand');
                                    }
                                }
                            });
                        }
                    }

                    def.resolve(_this);
                } else {
                    _this.config = _.assign({}, _this.brandConfig);
                    _this.config.bcScriptLoaded = false;
                    def.resolve(_this);
                }
            });
        }

        return def.promise();
    };

    VideoItem.prototype.loadInViewport = function() {
        var def = $.Deferred();
        if (this.initialized) {
            def.resolve(this);
        } else {
            var $container = $(this.videoContainer);
            //if (!this.loading && brand.Util.inViewport($container) && $container.css('display') != 'none' && $container.css('visibility') != 'hidden') {
            if (!this.loading && this.isVisible()) {
                this.loading = true;
                this.create().done(function(inst) {
                    this.loading = false;
                    if (inst && inst.initialized) {
                        $container.attr('data-fgx-inline-video-initialized', 'true');
                    }
                    def.resolve(inst);
                });
            } else {
                def.resolve(this);
            }
        }
        return def.promise();
    };

    VideoItem.prototype.loadInitialStateForBP = function() {
        this.loadInViewport().done(function(inst) {
            if (inst && inst.initialized && inst.autoplayEnabledOnBP() && inst.isVisible()) {
                inst.play(true);
            }
        });
    };

    VideoItem.prototype.getFramework = function() {
        return (this.config && this.config.bcpFramework) ? this.config.bcpFramework : null;
    };

    VideoItem.prototype.setSettingsOnPlayer = function(_settings) {
        var _this = this;
        if (_this.config.player) {
            _.forEach(((!_.isEmpty(_settings)) ? _settings : (_this.settings || {})), function(val, key) {
                if (val !== null && typeof(val) !== 'undefined') {
                    try {
                        _this.config.player[key](val);
                    } catch(e) {
                        util.log("VideoItem::setSettingsOnPlayer - error occurred setting the method on the player. {method}:{val} - ", key, ' : ', val, ' ', e);
                    }
                }
            });
        }
    };

    VideoItem.prototype.play = function(skipMPUpdate) {
        var framework = this.getFramework();
        if (framework) {
            try {
                if (this.transitionLock || this.playing) {
                    return;
                }
                if (skipMPUpdate) {
                    this.skipManualPauseUpdate = true;
                }
                framework.play();
            } catch(e) {
                brand.Util.log('VideoItem::play - error when trying to play the current video. ', e);
                this.skipManualPauseUpdate = false;
            }
        }
    };

    VideoItem.prototype.pause = function(skipMPUpdate) {
        var framework = this.getFramework();
        if (framework) {
            try {
                if (!this.playing) {
                    return;
                }
                if (skipMPUpdate) {
                    this.skipManualPauseUpdate = true;
                }
                framework.pause();
            } catch(e) {
                brand.Util.log('VideoItem::pause - error when trying to pause the current video. ', e);
                this.skipManualPauseUpdate = false;
            }
        }
    };


    VideoItem.prototype.autoplayEnabledOnBP = function() {
        var bp = brand.Util.currentBreakpoint();
        var $container = $(this.videoContainer);
        return ($container.hasClass(this.autoplayBPClasses[bp] || 'fgx-brand-video-autoplay-dsk'));
    };

    VideoItem.prototype.displayOnBP = function() {
        var bp = brand.Util.currentBreakpoint();
        return !(bp == 'gux-bkpt-sm' && this.hiddenOnMobile());
    };

    VideoItem.prototype.isVisible = function() {
        var $container = $(this.videoContainer);
        var visible = false;
        if (brand.Util.inViewport($container) && $container.is(':visible')) {
            visible = true;
        }
        return visible;
    };

    VideoItem.prototype.setTransitionLock = function(_isTransitioning) {
        this.transitionLock = _isTransitioning;
    };

    VideoItem.prototype.isTransitioning = function() {
        return this.transitionLock;
    };

    VideoItem.prototype.hiddenOnMobile = function() {
        return ($(this.videoContainer).hasClass('.hide-video-on-mobile'));
    };

    VideoItem.prototype.shownOnMobile = function() {
        return !(this.hiddenOnMobile());
    };

    VideoItem.prototype.isPlaying = function() {
        return this.playing;
    };

    VideoItem.prototype.isManuallyPaused = function() {
        return this.manuallyPaused;
    };

    VideoItem.prototype.setManuallyPaused = function(_paused, forceUpdate) {
        if (!this.skipManualPauseUpdate || forceUpdate) {
            this.manuallyPaused = _paused;
        }
        this.skipManualPauseUpdate = false;// reset skip manual pause update
    };

    // Subscribe/publish topic slightly modified from original implementation in user.lib.js
    VideoItem.prototype.subscribeTopic = function(topic, callback, _once) {
        if(!this._topics[topic]) {
            this._topics[topic] = []
        }
        var handle = {
            topic: topic,
            id: ++this._nextHandleId,
            once: _once || false
        };
        this._topics[topic].push({
            handle: handle,
            callback: callback
        });
        return handle;
    };

    VideoItem.prototype.publishTopic = function(topic, data, callback) {
        if(!this._topics[topic]) {
            return false;
        }
        var _this = this,
            _unsubscribeList = [];
        setTimeout(function notifyTopic() {
            _.each(callback ? [{ callback: callback }] : _this._topics[topic], function(subscriber) {
                try {
                    subscriber.callback(data, topic);

                    var _handle = subscriber && subscriber.handle;
                    if (_handle && _handle.once) {
                        _unsubscribeList.push(_handle);
                    }
                } catch(ex) {
                    util.log('video.lib: error occurred publishing videoItem topic ' + topic, data, ex);
                }
            });
            if (_unsubscribeList.length > 0) {
                _.each(_unsubscribeList, function(_handle) {
                    try {
                        _this.unsubscribeTopic(_handle);
                    } catch(ex) {
                        util.log('video.lib: error occurred while trying to call unsubscribeTopic with handle: ', _handle, ' ', ex);
                    }
                });
            }
        }, 0);
        return true;
    };

    VideoItem.prototype.unsubscribeTopic = function(handle) {
        _.remove(this._topics[handle.topic] || [], function(subscriber) {
            return subscriber.handle.id === handle.id;
        });
    };

    /*
     * Gather the necessary data and make the call to fire the metrics from the BC Plugin.
     */
    VideoItem.prototype.segmentUpdate = function(id) {
        if (!id) {
            return;
        }
        var vidData = _.assign({}, this._mtxBcpVidSegments[id] || {}, this.getMtxVideoData() || {});
        //Common Metrics
        this.fireMetricAction(id, {
            video: vidData
        });
    };

    /*
     * Return an object with the necessary data about the current video for the metrics.
     */
    VideoItem.prototype.getMtxVideoData = function() {
        return {
            segmentTime: this.getCurrentTime(),
            videoName: this.config && this.config.videoTitle || ''
        };
    };

    /*
     * Try to get the current time of the video
     */
    VideoItem.prototype.getCurrentTime = function() {
        var currTime = 0;
        if (this.config.playerApi) {
            try {
                currTime = this.config.playerApi.getCurrentTime();
            } catch(e) {
                util.log("videoItem::getCurrentTime - issue retrieving the segmentTime");
            }
        }
        return currTime;
    };

    /*
     * Fire the metricsAction with the included data if defined.
     */
    VideoItem.prototype.fireMetricAction = function(actionId, data) {
        var actions = this.actions || {};
        if(!data) {
            data = {};
        }
        if(actions && actions[actionId]) {
            FD.Brand.Metrics.handler.direct(actions[actionId], data);
        }
    };




    /* BCP Update - The code below should no longer be needed as we've switched to using the brightcove plugin to load both
     * Brightcove and Youtube videos. However, leaving it commented out here for reference for the time being.

    // BCP Update - These were global variables
    var ytIsLoading = false;
    var ytReady = false;
    var _deferredList = [];
    var bcVidInitialized = false;
    var _bcVidDetail = null;
    var _bcExtList = null;

    // BCP Update - The following functions were previously added to the Video namespace above to expose them as part of
    // the API.
    launch: launchPlayer,
    youtube: {
        create: ytCreatePlayer,
        isReady: function() { return ytReady; },
        setReady: function(isReady) { ytReady = isReady; }
    },
    brightcove: {
        create: bcCreatePlayer
    }


    // BCP Update - These were the functions used for the previous integrations of Brightcove and Youtube videos.
    function launchPlayer(config, $el) {
        var def = $.Deferred();
        initPlayer().then(function() {
            if(util.currentBreakpoint() !== 'gux-bkpt-sm') {
                $('#modal-player').css({'top': Math.max(150, $(win).scrollTop() + 75) + 'px'});
            } else {
                $('#modal-player').css({'top': Math.max(150, $(win).scrollTop()) + 'px'});
            }
            $('#modal-player').css({'z-index': 2002});
            var obj = videojs('player').FordPlayer.launchModal(config);
            def.resolve(obj);
            $('body').addClass('no-scroll-sm');
            if(util.currentBreakpoint() == 'gux-bkpt-sm') {
                //Prevent body scrolling on iOS
                $('html').css({"overflow": "hidden", "position": "relative", "height": "100%"});
            }
            var ovr = {
                $el: $('#modal-player'),
                lastFocus: $el,
                hide: function() {
                    $('.bcc-modal-close-button').trigger('click');
                }
            };
            FD.Brand.Overlay.trapFocus(ovr, '[tabindex="0"]:visible', '.bcc-modal-close-button', $el)
            $('.bcc-modal-close-button').one('click', function(ev) {
                FD.Brand.Overlay.releaseFocus(ovr);
            });
            $('.bcc-modal-close-button').on('keydown', function(ev) {
                if (ev.ctrlKey || ev.metaKey || ev.altKey) {
                    return;
                }
                if (ev.which == 13 || ev.which == 32) {
                    FD.Brand.Overlay.releaseFocus(ovr);
                    $(this).off('keydown');
                }
            });
            // temporary fix to ensure that social share and save buttons are always hidden 
            // remove and make conditional once save / share is implemented.
            $('.bcc-save-icon').hide();
            $('.bcc-share-icon').hide();
        });
        return def.promise();
    }

    function initPlayer() {
        var def = $.Deferred();
        if(initialized) {
            def.resolve();
        } else {
            var settings = brand.Context.settings;
            var language = brand.Context.language;
            // create video tag to be replaced by custom Ford Brightcove player
            $('<video id="player" class="video-js" data-embed="default" controls></video>')
                .attr('data-account', settings.videoAccount)
                .attr('data-player', settings.videoPlayerKey)
                .appendTo($('body'))
                .wrap('<div id="modal-container"></div>')
                .parent()
                .wrap('<div id="modal-player"></div>');

            // load Brightcove script
            brand.Util.url.loadAsScript('//players.brightcove.net/' +
                settings.videoAccount + '/' +
                settings.videoPlayerKey +
                '_default/index.min.js').then(function() {
                // load FordPlayer script
                var base = '/cmslibs/etc/designs/brand_ford/brand/skin/' + brand.Context.skin + '/js';
                brand.Util.url.loadAsScript(base + '/brightcovePlayer.js').then(function() {
                    // initialize player
                    var cfg = {
	                    debug: true,
	                    $: $
                    };
                    if(language === 'fr') {
                        // use fr.json l10n file
                        cfg.l10n = {
	                        language: language,
	                        file: base + '/l10n/' + language + '.json'
                        };
                        cfg.plugins = {
	                        'frenchCaptions': {}
                        };
                        // default to French captions if provided (NGBS3-7145)
	                    videojs.registerPlugin('frenchCaptions', function() {
		                    var player = this;
		                    player.on('play', function () {
			                    var tracks = player.textTracks();
			                    for (var i = 0; i < tracks.length; i++) {
				                    var track = tracks[i];
				                    if (track.language == 'fr-CA' || track.language == 'fr') {
					                    track.mode = 'showing';
				                    }
			                    }
		                    });
	                    });
	                    videojs('player').frenchCaptions();
                    }
                    videojs('player').FordPlayer(cfg);
                    initialized = true;
                    def.resolve()
                });
            });
        }
        return def.promise();
    }

    function ytCreatePlayer(config, $el) {
        var def = $.Deferred();
        ytInitPlayer().then(function() {
            var itm = (config && config.item) ? config.item : null;
            var start = (itm && itm.ytVideoStartTime) ? parseInt(itm.ytVideoStartTime, 10) : 0;
            var end = (itm && itm.ytVideoEndTime) ? parseInt(itm.ytVideoEndTime, 10) : null;
            var language = brand.Context.language;

            var player = new YT.Player(config.id, {
                height: '390',
                width: '640',
                videoId: config.item.videoId,
                playerVars: {
                    autoplay: config.autoPlay,
                    enablejsapi: 1,
                    start: start,
                    end: end,
                    hl: language
                },
                events: config.events
            });
            def.resolve(player);
        }, function() {
            //Added to handle error state when player is not loaded due to privacy settings.
            def.resolve(null);
        });
        return def.promise();
    }

    function ytInitPlayer() {
        var def = $.Deferred();
        var _resolve = function() {
            if(ytReady) {
                def.resolve();
            } else {
                //need to wait until ytReady is set.
                _deferredList.push(def);
            }
        }
        if(util.url.allowScript('6')) {
            if(ytIsLoading) {
                _resolve();
            } else {
                ytIsLoading = true;
                // load Brightcove script
                brand.Util.url.loadAsScript('https://www.youtube.com/iframe_api').then(function() {
                    _resolve();
                });
            }
        } else {
            util.log('video.lib: Youtube Player library not loaded due to privacy settings');
            def.reject();
        }

        return def.promise();
    }

    function bcCreatePlayer(config) {
        var def = $.Deferred();
        bcInitPlayer(config).then(function() {
            var obj = _.extend({}, config, _bcVidDetail);

            if(_bcVidDetail && _bcVidDetail.playerApi) {
                _bcVidDetail.playerApi.setConfig(config);
            }

            def.resolve(obj);
        }, function() {
            //Added to handle error state when player is not loaded due to privacy settings.
            def.resolve(null);
        });
        return def.promise();
    }

    function bcInitPlayer(config) {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            if(_bcVidDetail && _bcVidDetail.initialized) {
                def.resolve(_bcVidDetail);
            } else {
                _bcVidDetail = {};
                var settings = brand.Context.settings;
                var language = brand.Context.language;
                var $bcSlideItem = $(config.template());

                $bcSlideItem.addClass('active');
                $bcSlideItem.appendTo(config.slideContainer);
                _bcVidDetail.slideItem = $bcSlideItem;

                brand.Util.url.loadAsScript('//players.brightcove.net/' +
                    settings.videoAccount + '/' +
                    settings.videoPlayerKey +
                    '_default/index.min.js').then(function() {
                    _bcVidDetail.initialized = true;
                    _bcVidDetail.player = videojs('player');
                    registerBcPlayerExtensions();
                    _bcVidDetail.playerApi = bcPlayerAPIWrapper(config, _bcVidDetail.player);

                    loadLanguage(language).then(function() {
                        def.resolve(_bcVidDetail);
                    });
                });
            }
        } else {
            util.log('video.lib: Brightcove Player library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    //Simple Brightcove API to match some of the Youtube API functions
    function bcPlayerAPIWrapper(config, player) {
        var api = {};
        if(player) {
            api = {
                autoplay: function () {
                    var shouldAutoplay = (util.currentBreakpoint === 'gux-bkpt-sm') ? false : true;
                    player.autoplay(shouldAutoplay);

                    player.one("play", function() {
                        player.autoplay(true);
                    });
                },
                destroy: function () {
                    //player.dispose();
                },
                getCurrentTime: function () {
                    return player.currentTime();
                },
                getPlayer: function () {
                    return player;
                },
                getPlayerId : function () {
                    return 'player';
                },
                getVideoData: function () {
                    return config.currentVideo;
                },
                pauseVideo: function () {
                    player.pause();
                },
                playVideo: function () {
                    player.play();
                },
                createButton: function(player, className, click, callback) {
                    if(_bcExtList && _bcExtList.playerButton) {
                        new _bcExtList.playerButton(player, className, player.controlBar.el(), click, callback);
                    }
                },
                setControlText: function(className, label) {
                    _bcVidDetail.slideItem.find('.' + className).find('.vjs-control-text').text(label);
                },
                setConfig: function (_config) {
                    config = _.extend({}, config, _config);
                },
                setCurrentVideo: function (_currentVideo) {
                    config.currentVideo = _currentVideo;
                },
                isFullscreen: function() {
                    return player.isFullscreen();
                }
            };
        }
        return api;
    }

    function registerBcPlayerExtensions() {
        if(!_bcExtList) {
            _bcExtList = {};
        }

        _bcExtList.vjsButton = videojs.getComponent("Button");
        _bcExtList.playerButton = videojs.extend(_bcExtList.vjsButton, {
            constructor: function(player, className, parent, click, callback) {
                _bcExtList.vjsButton.prototype.constructor.call(this, player, {});
                this.el = this.el_;
                this.el.className = "vjs-control bcc-player-button " + className;

                if (parent) {
                    parent.appendChild(this.el);
                }
                if (click && typeof(click) == 'function') {
                    $(this.el).on("click touchstart", function(ev) {
                        click();
                        return false;
                    });
                }
                if (callback && typeof(callback) == 'function') {
                    var data = {
                        className: this.el.className,
                        el: this.el
                    };
                    callback(data);
                }
            }
        });
    }

    function loadLanguage(language) {
        var def = $.Deferred();
        if(language === 'fr') {
            //Load language file
            var base = '/cmslibs/etc/designs/brand_ford/brand/skin/' + brand.Context.skin + '/js',
                file = base + '/l10n/' + language + '.json';

            $.get(file, function(data) {
                if (typeof data != "string") {
                    _bcVidDetail.labels = data;
                } else {
                    try {
                        _bcVidDetail.labels = JSON.parse(data);
                    } catch (e) {
                        _bcVidDetail.labels = {};
                    }
                }
            }).done(function() {
                if (window.videojs) {
                    videojs.addLanguage(language, _bcVidDetail.labels);
                    videojs('player').language(language);

                    // default to French captions if provided (NGBS3-7145)
                    videojs.registerPlugin('frenchCaptions', function() {
                        var player = this;
                        player.on('play', function () {
                            var tracks = player.textTracks();
                            for (var i = 0; i < tracks.length; i++) {
                                var track = tracks[i];
                                if (track.language == 'fr-CA' || track.language == 'fr') {
                                    track.mode = 'showing';
                                }
                            }
                        });
                    });
                    videojs('player').frenchCaptions();
                }
                def.resolve();
            }).fail(function() {
                if(!_bcVidDetail.labels) {
                    _bcVidDetail.labels = {};
                }
                def.resolve();
            });
        } else {
            if(!_bcVidDetail.labels) {
                _bcVidDetail.labels = {};
            }
            def.resolve();
        }
        return def.promise();
    }

    $('body').on('fgxVideo:youtubeReady', function() {
        for(var i = 0; i < _deferredList.length; i++) {
            _deferredList[i].resolve();
        }
        _deferredList = [];
    });

    if(!win.onYouTubeIframeAPIReady) {
        win.onYouTubeIframeAPIReady = function() {
            FD.Brand.Video.youtube.setReady(true);
            $('body').trigger('fgxVideo:youtubeReady');
        }
    }*/

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util, FD.Brand.Context);
/*global FD*/
(function(win, $, _, brand, ngp, ctx) {

    // search library
    _.extend(brand.namespace('FD.Brand.Search', win), {
        typeAheadResults: getSearchTypeaheadResults,
        selectResult: onResultsSelect,
        setReferrerApp: setReferrerApp,
        astuteTypeAheadResults: getAstuteTypeAheadResults,
        initAstuteSession: getAsyncTopic(initAstuteSession)
    });

    var defaults = {
        maxResultCount: 10
    };
    var settings = ctx && ctx.settings || {};
    var _asKey = "astuteServiceUrl";
    //NZ - per BRAND-13492 - market should always be en-US regardless of corner. This was originally setup as ctx.language + "-" + ctx.region
    var _astuteSettings = {
        market: "en-US",
        serviceUrl: (settings && (settings[_asKey + ctx.make] || settings[_asKey])) || "//use-fordservicelayer.astuteknowledge.com/AskFordWeb",
        sessionID: null
    };
    var _initAstuteSession = FD.Brand.Search.initAstuteSession;

    function getSearchTypeaheadResults(val, $container, $searchInput, $resultsAlert, maxCount) {
        var results = [],
            maxResultCount = maxCount || defaults.maxResultCount;

        ngp.searchTypeAhead({
            N: '0',
            Di: '8124',
            Dk: '1',
            Dx: 'rel+static(rank,descend)',
            Dn: '0',
            D: val + '*'
        }).done(function(locations) {
            if(locations != null) {
                handleTypeaheadResponse(locations, $container, $searchInput, $resultsAlert, maxResultCount);
            } else {
                $container.hide();
            }
        }).fail(function(resp) {
            $container.hide();
        });
    }

    function handleTypeaheadResponse(resp, $container, $searchInput, $resultsAlert, maxResultCount) {
        var results = resp.map(function(result) {
            return result.Location[0].DimValueName;
        });

        if( maxResultCount !== -1) {
            results = results.slice(0, maxResultCount);
        }

        if(results !== null) {
            $container.find(".search-res-item").remove(); //Should unbind all event handlers on the search items as well.
            processTypeAheadResponse(results, "fgx-brand-searchTypeAheadItem", $container, $searchInput, $resultsAlert);
        } else {
            $container.hide();
            if (typeof $resultsAlert !== 'undefined') {
                $resultsAlert.text('');
            }
        }
    }

    function processTypeAheadResponse(resp, itemId, $container, $searchInput, $resultsAlert) {
        var index = 0,
            idPrefix = itemId || "fgx-brand-searchTypeAheadItem";
        for(var res in resp) {
            var id = idPrefix + index;
            var resultStr = resp[res];
            // on the author environment, for some reason the final result is always a JS function...make sure we don't display that.
            if (typeof(resultStr) != 'function') {
                $container.append("<li id='" + id + "' class='search-res-item' tabindex='-1' aria-selected='false' role='option' data-fgx-keypress='true'>" + resultStr + "</li>");
            }
            index ++;
        }
        $container.show();
        $searchInput.toggleClass('fgx-list-shown', true);//BRAND-12331

        if (typeof $resultsAlert !== 'undefined') {
            var templateTxt = $resultsAlert.data('label-template');
            if (templateTxt) {
                $resultsAlert.text(templateTxt.replace('{count}', resp.length));
            }
        }

        // The mousedown event handler is needed to stop the blur event from firing when clicking on a search result.
        $container.find(".search-res-item").on('mousedown', function(ev) {
            ev.preventDefault();
        }).on('click', function() {
            var $form = $(this).closest("form");
            onResultsSelect($form, $(this).text());
        }).on('focusin', function(){
            $container.find(".search-res-item").attr('aria-selected', 'false');
            $(this).attr('aria-selected', 'true');
            $searchInput.attr('aria-activedescendant', $(this).attr('id'));
        }).on('keydown', function(ev){
            if (ev.shiftKey && ev.which === 9) {
              //shift was down when tab was pressed...so refocus on the search input
              $searchInput.focus();
              return false;
            } else if (ev.which === 27) {
                //escape key was pressed...so refocus on the search input
                $searchInput.focus();
                $container.hide();
                if (typeof($resultsAlert) !== 'undefined') {
                    $resultsAlert.text('');
                }
                $searchInput.toggleClass('fgx-list-shown', false);//BRAND-12331
                $searchInput.removeAttr('aria-activedescendant');
                return false;
            }
        });
    }

    function onResultsSelect($form, value) {
        var $inputEl = $form.find(".search-input");
        $inputEl.val(value);
        $form.submit();
    }
    
    // duplicated from our user JS library
    // helper for topics retrieved asynchronously
    // wraps a common promise that is returned
    // deferred is passed into load function and resolved when topic is loaded
    // this makes the function reentrant without initiating multiple requests to load topic
    function getAsyncTopic(fnLoad) {
        var promise = null;
        var fn = function() {
            var def;
            if(promise === null) {
                def = $.Deferred();
                promise = def.promise();
                fnLoad(def);
            }
            return promise;
        };
        fn.$_reset = function() {
            promise = null;
        };
        return fn;
    }

    function initAstuteSession(def) {
        if(_astuteSettings && _astuteSettings.sessionID) {
            def.resolve(_astuteSettings);
        } else {
            var prm = {
                url: _astuteSettings.serviceUrl + "/init",
                contentType: 'application/json',
                processData: false,
                data: JSON.stringify({ market: _astuteSettings.market }),
                type: "POST"
            }

            $.ajax(prm).done(function(resp) {
                if(resp) {
                    if(resp.sessionID) {
                        _astuteSettings.sessionID = resp.sessionID;
                        def.resolve(_astuteSettings);
                    } else {
                        def.reject();
                    }
                } else {
                    def.reject();
                }
            }).fail(function() {
                def.reject();
            });
        }
    }

    function astuteAutoComplete(data) {
        var def = $.Deferred(),
            prm = {
                url: _astuteSettings.serviceUrl + "/autocomplete",
                contentType: 'application/json',
                processData: false,
                data: JSON.stringify(_.assign({}, data)),
                type: "POST"
            };

        $.ajax(prm).done(function(resp) {
            if(resp && resp.suggestions) {
                def.resolve(resp.suggestions);
            } else {
                def.reject();
            }
        }).fail(function() {
            def.reject();
        });

        return def.promise();
    }

    function getAstuteTypeAheadResults(val, $container, $searchInput, $resultsAlert, maxCount) {
        var maxResultCount = maxCount || defaults.maxResultCount;

        _initAstuteSession().done(function(resp) {
            astuteAutoComplete({
                sessionID: _astuteSettings.sessionID,
                utterance: val.replace('+', '%20'),
                suggestionCount: maxResultCount
            }).done(function(resp) {
                handleAstuteTypeaheadResponse(resp, $container, $searchInput, $resultsAlert, maxResultCount);
            }).fail(function() {
                $container.hide();
            });
        }).fail(function() {
            $container.hide();
        });
    }

    function handleAstuteTypeaheadResponse(resp, $container, $searchInput, $resultsAlert, maxResultCount) {
        if(resp) {
            if(!_.isArray(resp)) {
                resp = [resp];
            }
            $container.find(".search-res-item").remove(); //Should unbind all event handlers on the search items as well.

            if(_.isEmpty(resp)) {
                $container.hide();
                if (typeof $resultsAlert !== 'undefined') {
                    $resultsAlert.text('');
                }
                return;
            }

            processTypeAheadResponse(resp, "fgx-brand-astuteSearchTypeAheadItem", $container, $searchInput, $resultsAlert);

        } else {
            $container.hide();
            if (typeof $resultsAlert !== 'undefined') {
                $resultsAlert.text('');
            }
        }
    }

    function setReferrerApp($formWrapper) {
        if(ctx.settings.syn && ctx.metrics && ctx.metrics.pageName && ctx.metrics.pageName.indexOf('owner') >= 0) {
            var formWrapper = $formWrapper[0];
            var referrerApp = document.createElement('input');
            referrerApp.type = "hidden";
            referrerApp.name = "referrerApp";
            referrerApp.value = "owner";
            formWrapper.appendChild(referrerApp);
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.NgpServices, FD.Brand.Context);
/*global FD*/
/**
 * Pricing support library
 *
 * Dynamically loads Single Payment Calculator if not available
 * Queries DOM elements looking for pricing data attributes and substituting pricing data
 *
 */
(function(win, _, ctx, user, util, mtx) {

    var ioComponent = null;
    var _mtxActions = null;
    var mtxContext = 'io',
        onClickSrc = '',
        ioData = {
            'io': {
                id: 'io',
                prefix: 'vehicles',
                linkNameBase: ':vehicle:incentives:content:action:',
                onClickBase: 'incentives:content:',
                OnClickPrefix: ''
            },
            'bp': {
                id: 'bp',
                prefix: 'bp',
                linkNameBase: ':bp:incentives:content:action:',
                onClickBase: 'bp:incentives:content:',
                OnClickPrefix: 'bp'
            }
        },
        mtxVariables = null,
        tabKeys = {
            'offers-by-model': 'by-model',
            'featured-offers': 'featured',
            'additional-offers': 'others'
        },
        latestTab = '',
        stConfigurationURL = '',
        leadFormParams = {
            gip: {
                formType: 'request',
                context : 'IncentivesQuote',
                altLeadSource: 'NGBS',
                altLeadSourceCA: 'IO NGBS',
                mtxShowKey: 'ioShowLeadFormAction',
                mtxSubmitSuccessKey: 'ioLeadFormSubmissionSuccessAction',
                mtxSubmitSuccessOptInKey: 'ioLeadFormSubmissionSuccessOptInAction',
                t3Title: (ctx.locale === 'fr_ca') ? 'Demander un Prix' : 'Request a Price',
                t3SubmitLabel: (ctx.locale === 'fr_ca') ? 'Demander un Prix' : 'Request a Price'
            },
            testDrive: {
                formType: 'schedulev2',
                context: 'IncentivesTestDrive',
                altLeadSource: 'IO Test Drive',
                altLeadSourceCA: 'IO Test Drive',
                mtxShowKey: 'ioShowTestDriveFormAction',
                mtxSubmitSuccessKey: 'ioTestDriveFormSubmissionSuccessAction',
                mtxSubmitSuccessOptInKey: 'ioTestDriveFormSubmissionSuccessOptInAction'
            }
        },
        latestLeadFormKey = 'gip',
        _golfFormOverrides = {},
        _golfFormOverrideKeys = [
            {
                urlKey: 'year',
                golfKey: 'year'
            }, {
                urlKey: 'make',
                golfKey: 'make'
            }, {
                urlKey: 'model',
                golfKey: 'model'
            }, {
                urlKey: 'postalCode',
                golfKey: 'postalCode'
            }, {
                urlKey: 'leadsource',
                golfKey: 'leadSource',
                context: 'lead'
            }, {
                urlKey: 'altleadsource',
                golfKey: 'altLeadSource',
                context: 'lead'
            }, {
                urlKey: 'intcmp',
                golfKey: 'campaignID',
                context: 'lead'
            }, {
                urlKey: 'env',
                golfKey: 'tier'
            }, {
                urlKey: 'tertiarysource',
                golfKey: 'tertiarysource',
                context: 'lead'
            }, {
                urlKey: 'dealerPACode',
                golfKey: 'prefPaCode'
            }],
        _year = getQuerystringParameter("year"),
        _make = getQuerystringParameter("make"),
        _model = getQuerystringParameter("model"),
        _postalCode = getQuerystringParameter("postalCode"),
        _url = win.location.href;

        if(_url.indexOf('/io-frame') >= 0) {
            if(_year && _make && _model) {
                if(ctx) {
                    if(ctx.nameplate) {
                        ctx.nameplate.ngpModelName = _model;
                        ctx.nameplate.ngpYear = _year;
                    } else {
                        var data = {
                            ngpModelName: _model,
                            ngpYear: _year
                        };
                        ctx.nameplate = data;
                    }
                }
                if(FD.Brand && FD.Brand.Metrics) {
                    FD.Brand.Metrics.updateVehicle(_make, _model, _year);
                }
            }
        }
    $(init);

    //////

    function init() {
        ioComponent = win.ShoppingToolsIncentivesAndOffers || null;
        if(ioComponent) {
            //Metrics Update
            mtxContext = getQuerystringParameter('app') || 'io';
            onClickSrc = getQuerystringParameter('c5src') || '';
            stConfigurationURL = getQuerystringParameter('stConfigurationURL') || '';
            _mtxActions = ctx && ctx.mtxActions;

            // TODO: implement metrics callback functions
            // see http://wiki.ngptools.com/confluence/display/ngbs3/Incentives+and+Offers+Pilot+Integration+Documentation for details
            var _ioData = getIOData();

            //Metrics Update
            mtxVariables = {
                '$$appID': _ioData.id,
                '$$appPrefix': _ioData.prefix,
                '$$onClickSrc': onClickSrc,
                '$$incentivesYear': ctx.nameplate && ctx.nameplate.ngpYear,
                '$$incentivesMake': ctx && ctx.make,
                '$$incentivesNameplate': ctx.nameplate && (ctx.nameplate.metricsName || ctx.nameplate.ngpModelName).toLowerCase(),
                '$$appOnClickPrefix': _ioData.appOnClickPrefix
            };

            var callbacks = {
                close: function() {
                	//Metrics Update
                	if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioCloseAction,
                            mtxVariables
                        );

                        FD.Brand.Metrics.spcFlags.reset();
                    }
                },
                incentiveView: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioIncentiveViewLoadAction,
                            mtxVariables
                        );
                    }
                },
                initialTabDisplay: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$tabName = data.tabName.replace(/-/g, " ");
                            resp.$$offersText = (data.hasOffers) ? 'offers' : 'no-offers';
                            resp.$$tabKey = tabKeys[data.tabName];
                        }
                        latestTab = resp.$$tabName;
                        var variables = _.extend({}, mtxVariables, resp);
                        var mtxKey = (data && data.tabName === 'offers-by-model') ? 'ioInitialTabDisplayModelOffersAction' : 'ioInitialTabDisplayAction';
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions[mtxKey],
                            variables
                        );
                    }
                },
                tabChange: function(data) {
                	//Metrics Update
                	if(_mtxActions) {
                	    var resp = {};
                        if(data) {
                            resp.$$tabName = data.tabName.replace(/-/g, " ");
                            resp.$$offersText = (data.hasOffers) ? 'offers' : 'no-offers';
                            resp.$$tabKey = tabKeys[data.tabName];
                        }
                        latestTab = resp.$$tabName;
                        var variables = _.extend({}, mtxVariables, resp);
                	    var mtxKey = (data && data.tabName === 'offers-by-model') ? 'ioTabChangeModelOffersAction' : 'ioTabChangeAction';
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions[mtxKey],
                            variables
                        );
                    }
                },
                postalCodeClick: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.zipCodeOverlayOpenAction,
                            mtxVariables
                        );
                    }
                },
                postalCodeUpdated: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.zipCodeChangeAction,
                            mtxVariables
                        );
                    }
                },
                expandTrim: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        if(data && (data.expanded === 'true' || data.expanded === true)) {
                            var resp = {};
                            resp.$$trimName = data.trimName;
                            var variables = _.extend({}, mtxVariables, resp);
                            FD.Brand.Metrics.handler.direct(
                                _mtxActions.ioExpandTrimAction,
                                variables
                            );
                        }
                    }
                },
                showSPC: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$paymentType = data.paymentType;
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioShowSpcAction,
                            variables
                        );
                    }
                },
                showLeadForm: function(data) {
                    var prms = _.extend({}, data, leadFormParams['gip']);
                    latestLeadFormKey = 'gip';
                    showLeadForm(prms);
                },
                showTestDriveForm: function(data) {
                    var prms = _.extend({}, data, leadFormParams['testDrive']);
                    latestLeadFormKey = 'testDrive';
                    showLeadForm(prms);
                },
                offerPaging: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$offerSection = data.offerSection;
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioCarouselScrollAction,
                            variables
                        );
                    }
                },
                print: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$offerTypes = (data.offerTypes && data.offerTypes.toLowerCase() === 'retail') ? 'retail' : 'lease';
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioPrintAction,
                            variables
                        );
                    }
                },
                showSPCCashOverlay: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$trimName = data.trim;
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioShowSpcCashOverlayAction,
                            variables
                        );
                    }
                },
                additionalExitLink: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$offerTitle = data.offerTitle;
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioAdditionalExitLinkAction,
                            variables
                        );
                    }
                },
                vehicleExitLink: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$tabName = data.tabName.replace(/-/g, " ");
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioVehicleExitLinkAction,
                            variables
                        );
                    }
                },
                dealerExitLink: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$tabName = data.tabName.replace(/-/g, " ");
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioDealerExitLinkAction,
                            variables
                        );
                    }
                },
                buildAndPriceExitLink: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioBnpExitLinkAction,
                            mtxVariables
                        );
                    }
                },
                spcCalculatorHidden: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.spcCalculatorHiddenAction,
                            mtxVariables
                        );

                        FD.Brand.Metrics.spcFlags.reset();
                    }
                },
                spcFinanceTabView: function(data) {
                    //Metrics Update
                    if(_mtxActions && !FD.Brand.Metrics.spcFlags.tabDisplayed('finance')) {
                        var action = (FD.Brand.Metrics.spcFlags.tabDisplayed('lease')) ? 'spcFinanceTabAdditionalViewAction' : 'spcFinanceTabViewAction';
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions[action],
                            mtxVariables
                        );
                        FD.Brand.Metrics.spcFlags.set('finance', true);
                    }
                },
                spcLeaseTabView: function(data) {
                    //Metrics Update
                    if(_mtxActions && !FD.Brand.Metrics.spcFlags.tabDisplayed('lease')) {
                        var action = (FD.Brand.Metrics.spcFlags.tabDisplayed('finance')) ? 'spcLeaseTabAdditionalViewAction' : 'spcLeaseTabViewAction';
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions[action],
                            mtxVariables
                        );
                        FD.Brand.Metrics.spcFlags.set('lease', true);
                    }
                },
                spcFinancePrintClick: function() {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.spcFinancePrintClickAction,
                            mtxVariables
                        );
                    }
                },
                spcLeasePrintClick: function() {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.spcLeasePrintClickAction,
                            mtxVariables
                        );
                    }
                },
                spcCreditLinkClick: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.spcCreditLinkClickAction,
                            mtxVariables
                        );
                    }
                },
                spcFrequencyChange: function(data) {
                    //Metrics Update
                    if(_mtxActions) {
                        var resp = {};
                        if(data) {
                            resp.$$frequency = data.frequency;
                        }
                        var variables = _.extend({}, mtxVariables, resp);
                        FD.Brand.Metrics.handler.direct(
                            _mtxActions.ioSpcFrequencyChangeAction,
                            variables
                        );
                    }
                }
            };
            var location = user.location.current();

            //Metrics Update
            // initialize component
            if (_year && _make && _model && _postalCode) {
                //Metrics Update
                //Set the incentives nameplate values
                mtxVariables['$$incentivesYear'] = _year;
                mtxVariables['$$incentivesMake'] = _make;
                mtxVariables['$$incentivesNameplate'] = _model.toLowerCase();

                // if all required querystring parameters exist for defining vehicle via the url, then use them.
                ioComponent.show({
                    year : _year,
                    make : _make,
                    model : _model,
                    trim : getQuerystringParameter("trim"),
                    postalCode : _postalCode,
                    appContext : getQuerystringParameter("appContext")
                }, callbacks);

            } else {
                
                // otherwise default to the default context
                ioComponent.show({
                    year: ctx.nameplate && ctx.nameplate.ngpYear,
                    make: ctx.make,
                    model: ctx.nameplate && ctx.nameplate.ngpModelName,
                    postalCode: location && location.postalCode,
                    appContext: 'ngbs_sploffr'
                }, callbacks);
            }

            initializeFormOverrides();
        }
    }

    function showLeadForm(data) {
        user.authentication.current().then(function(authState) {
            var cfg = {
                model: _golfFormOverrides && _golfFormOverrides.model || data.model,
                year: _golfFormOverrides && _golfFormOverrides.year || data.year,
                postalCode: _golfFormOverrides && _golfFormOverrides.postalCode || data.postalCode,
                type: (isCommercial(data.model)) ? 'comm' : '',
                options: {
                    allowChangeVehicle: false,
                    allowChangeDealer: true
                }, 
                lead: {
                    context: data.context,
                    altLeadSource: (ctx.region === 'CA') ? data.altLeadSourceCA : data.altLeadSource
                }
            };

            if(stConfigurationURL && stConfigurationURL != '') {
                cfg.lead.stConfigurationURL = stConfigurationURL;
            }

            if (ctx.make === 'Lincoln' && authState.authType === 'user') {
                cfg.lead.leadSource = 'Lincoln.com Concierge Lead'
            }
            if($(".incentivesandoffers").length) { //GOLF-493 - remove street address from GOLF form when GIP is clicked from WITHIN IO
                cfg.options.hideAddress = (ctx.region !== 'CA');
            }

            if(data && data.submitLabel) {
                cfg.ctaLabel = data.submitLabel;
            }

            if(_golfFormOverrides && _golfFormOverrides.tier == 'tier3') {
                cfg.options.allowChangeDealer = false;
                cfg.tier = _golfFormOverrides.tier;//GOLF-1427

                if(_golfFormOverrides.prefPaCode) {
                    cfg.prefPaCode = _golfFormOverrides.prefPaCode;
                }

                if(data) {
                    if(data.t3Title) {
                        cfg.formTitle = data.t3Title;
                    }

                    if(data.t3SubmitLabel) {
                        cfg.ctaLabel = data.t3SubmitLabel;
                    }
                }
            }

            if(_golfFormOverrides && _golfFormOverrides.lead) {
                cfg.lead = _.extend({}, cfg.lead, _golfFormOverrides.lead);
            }

            var lastFocusElm = null;
            if(data && data.returnFocusElement) {
                lastFocusElm = data.returnFocusElement;
            }

            FD.Brand.Form[data.formType].show(cfg, leadComplete, leadEvent, null, lastFocusElm);

            //Metrics Update
            if(_mtxActions) {
                var resp = {
                    '$$tabName': latestTab
                };
                var variables = _.extend({}, mtxVariables, resp);
                FD.Brand.Metrics.handler.direct(
                    _mtxActions[data.mtxShowKey],
                    variables
                );
            }
        });
    }
    
    function leadEvent(event, data) {
        var prms = leadFormParams[latestLeadFormKey] || leadFormParams['gip'];
        //NZ: had || event === 'ResponseView' in if statement below, but removed since this may be causing the metrics to fire twice
        if(event === 'SubmissionSucceeded') {
            //Metrics Update
            if(_mtxActions) {
                var req = data && data.request,
                    optIn = req && req["customer.allowfollowup"],
                    mtxKey = (optIn && (optIn === true || optIn === 'true')) ? prms.mtxSubmitSuccessOptInKey : prms.mtxSubmitSuccessKey;

                if(data && data.response && data.response.cksVisitID) {
                    FD.Brand.Metrics.setParameter('user_cksVisitId', data.response.cksVisitID);
                }

                var resp = {
                    '$$tabName': latestTab
                };
                var variables = _.extend({}, mtxVariables, resp);
                FD.Brand.Metrics.handler.direct(
                    _mtxActions[mtxKey],
                    variables
                );
            }
        }
    }

    
    function leadComplete(data) {
        // TODO: metrics?
        FD.Brand.Util.log('IO lead complete', data);
    }
    
    function getQuerystringParameter(name) {
        
        if(name = (new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)')).exec(location.search))
            return decodeURIComponent(name[1]);
    }

    function isCommercial(model) {
        var flag = false,
            lcModel = (model && model.toLowerCase()) || '';

        if(win.location.href.toLowerCase().indexOf("commercial") > -1 || (lcModel.indexOf("commercial") > -1)) {
            flag = true;
        } else {
            switch(lcModel) {
                case 'e-series cutaway':
                case 'chassis cab':
                case 'f-650-750':
                case 'transit chassis':
                case 'strippedchassis':
                case 'econoline chassis':
                    flag = true;
                    break;
            }
        }
        return flag;
    }

    function initializeFormOverrides() {
        _.each(_golfFormOverrideKeys, function(item) {
            var val = getQuerystringParameter(item.urlKey) || '';
            if(val && val != '') {
                if(item.context) {
                    if(!_golfFormOverrides[item.context]) {
                        _golfFormOverrides[item.context] = {};
                    }
                    _golfFormOverrides[item.context][item.golfKey] = val;
                } else {
                    _golfFormOverrides[item.golfKey] = val;
                }
            }
        });
    }

    //Metrics Update
    function getIOData() {
        return ioData[mtxContext] || ioData['io'];
    }

} )(window, FD.Brand.lodash, FD.Brand.Context, FD.Brand.User, FD.Brand.Util, FD.Brand.Metrics);
/*global FD*/
/**
 * GOLF form support library
 */
(function(win, $, _, brand, ctx, user, util) {

    var FORM_PARAMETER_DEFAULTS = {
        getupdates: {
            'Ford': {
                listid: '310124',
                qacodeEmail: '0799A',
                qacodeMail: '0848312720'
            },
            'Lincoln': {
                listid: '320864',
                qacodeEmail: '0799A',
                qacodeMail: '0848320876'
                
            }
        },
        guShop: {
            'Ford': {
                qacodeMail: '0848312726'
            }
        },
        guReveal: {
            'Ford': {
                qacodeMail: '0848501137'
            }
        },
        guRevealShop: {
            'Ford': {
                qacodeMail: '0848501149'
            }
        },
        guRevealCTA: {
            'Ford': {
                qacodeMail: '0848501172'
            }
        },
        guBillboard: {
            'Lincoln': {
                qacodeMail: '0848500673'
            }
        },
        blgetupdates: {
            'Lincoln': {
                qacodeMail: '0848321168'
            }
        },
        guComm: {
            'Ford': {
                qacodeMail: '0848501420'
            }
        },
        canvasgu: {
            'Ford': {
                listid: '320864',
                qacodeEmail: '0799A',
                brochureCode: '222'
            },
            'Lincoln': {
                listid: '320864',
                qacodeEmail: '0799A',
                brochureCode: '222'
            }
        },
        personaldriver: {
            'Ford': {
                listid: '320864',
                qacodeEmail: '0799A',
                brochureCode: '223'
            },
            'Lincoln': {
                listid: '320864',
                qacodeEmail: '0799A',
                brochureCode: '223'
            }
        },
        kmi: {
            'Ford': {
                listid: '312726',
                qacodeEmail: '0799A',
                brochureCode: '222'
            },
            'Lincoln': {
                listid: '320879',
                qacodeEmail: '0799A',
                brochureCode: '222'

            }
        }
    };
    var SCHEDULE_EVENT_DATA = {
        schedule: {
            'FormShown': {
                'registeredEvent': true,
                'mtxKey': 'scheduleTestDriveShowFormAction'
            },
            'RequestView': {
                'registeredEvent': false,
                'mtxKey': ''
            },
            'ResponseView': {
                'registeredEvent': true,
                'mtxKey': 'scheduleTestDriveResponseViewAction'
            },
            'SelectVehicleView': {
                'registeredEvent': true,
                'mtxKey': 'scheduleTestDriveSelectVehicleViewAction'
            }
        },
        fleetschedule: {
            'FormShown': {
                'registeredEvent': false,
                'mtxKey': ''
            },
            'RequestView': {
                'registeredEvent': true,
                'mtxKey': 'fleetScheduleTestDriveRequestViewAction'
            },
            'ResponseView': {
                'registeredEvent': true,
                'mtxKey': 'fleetScheduleTestDriveResponseViewAction'
            },
            'SelectVehicleView': {
                'registeredEvent': true,
                'mtxKey': 'fleetScheduleTestDriveSelectVehicleViewAction'
            }
        }
    };

    _.extend(brand.namespace('FD.Brand.Form', win), {
        request: formFactory('request', {skinVersion: "guxv2"}),
        schedule: formFactory('schedule'),
        blschedule: formFactory('schedule', {skinVersion: "lincolnblv1", blackLabelOnly: true}),
        schedulev2: formFactory('schedule', {skinVersion: "guxv2", id: 'schedulev2'}),
        fleetschedule: formFactory('schedule', {skinVersion: "fleet", id: 'fleetschedule'}),
        getupdates: formFactory('getupdates'),
        guShop: formFactory('getupdates', _.extend({id: 'guShop'}, getFormParameterDefaults('getupdates'), formParameters('guShop'))),
        guReveal: formFactory('getupdates', _.extend({id: 'guReveal'}, getFormParameterDefaults('getupdates'), formParameters('guReveal'))),
        guRevealShop: formFactory('getupdates', _.extend({id: 'guRevealShop'}, getFormParameterDefaults('getupdates'), formParameters('guRevealShop'))),
        guRevealCTA: formFactory('getupdates', _.extend({id: 'guRevealCTA'}, getFormParameterDefaults('getupdates'), formParameters('guRevealCTA'))),
        guBillboard: formFactory('getupdates', _.extend({id: 'guBillboard'}, getFormParameterDefaults('getupdates'), formParameters('guBillboard'))),
        blgetupdates: formFactory('getupdates', _.extend({id: 'blgetupdates'}, getFormParameterDefaults('getupdates'), formParameters('blgetupdates'))),
        guComm: formFactory('getupdates', _.extend({skinVersion: 'commform', id: 'guComm'}, getFormParameterDefaults('getupdates'), formParameters('guComm'))),
        canvasgu: formFactory('getupdates', _.extend({skinVersion: 'canvasv1', id: 'canvasgu'}, formParameters('canvasgu'))),
        personaldriver: formFactory('getupdates', _.extend({skinVersion: 'personaldriverv1', id: 'personaldriver'}, formParameters('personaldriver'))),
        kmi: formFactory('getupdates', _.extend({skinVersion: 'kmi', id: 'kmi'}, formParameters('kmi'))),
        imageshare: formFactory('emailshare', {skinVersion: "imageshare", id: "emailImageShare"}),
        videoshare: formFactory('emailshare', {skinVersion: "videoshare", id: "emailVideoShare"}),
        registerEventCallback: registerEventCallback,
        unregisterEventCallback: unregisterEventCallback,
        formEventCallback: formEventCallback,
        load: loadForm
    });

    var _loadedFiles = {};
    var _eventCallbacks = [];

    //////

    function formFactory(formType, prm, methods) {
        var golfForm = null;
        var golfLoading = false;
        //NGBS3-10469 - use the id value if passed in to distinguish between canvas get updates form (canvasgu) and normal get updates form (getupdates).
        var formId = (prm && prm.id) ? prm.id : formType;
        return _.extend({
            show: function(cfg, formCallback, eventCallback, title, targetElement) {
                if(golfForm) {
                    showForm(golfForm, cfg, formCallback, eventCallback, title, targetElement);
                } else {
                    if(golfLoading) {
                        return;
                    }
                    golfLoading = true;
                    loadForm(formType, prm).done(function($form) {
                        var golfBase = win.FD.Pantry.Golf;
                        golfBase.initialized().done(function() {
                            golfBase.refresh();
                            golfForm = golfBase.getForm(formId);
                            showForm(golfForm, cfg, formCallback, formEventCallback(golfForm, formType, eventCallback), title, targetElement);
                            golfLoading = false;
                        });
                    });
                }
            }
        }, methods || {});
    }

    /**
     * Register a callback function to receive events from all GOLF forms
     * Function called with the following parameters:
     *  - Form type
     *  - Event name
     *  - Current form configuration
     * @param fnCallback
     */
    function registerEventCallback(fnCallback) {
        if(_.isFunction(fnCallback)) {
            _eventCallbacks.push(fnCallback);
        }
    }

    function unregisterEventCallback(fnCallback) {
        _.pull(_eventCallbacks, fnCallback);
    }

    function formEventCallback(form, formType, fnCallback) {
        return function() {
            var args = [].slice.call(arguments);
            for(var i = -1; i < _eventCallbacks.length; i++) {
                var fn = (i < 0) ? fnCallback : _eventCallbacks[i];
                if(i == 0) {
                    args.unshift(formType);
                }
                if(fn) {
                    try {
                        fn.apply(form, args);
                    } catch (e) {
                    }
                }
            }
        }
    }

    function loadForm(formType, prm, container) {
        var def = $.Deferred();
        var path = '/aemservices/common/api/component';
        var formContainerWrap = (container) ? container : 'body';

        if(ctx.region === 'CA') {
            // BRAND-15571 - need to use Shop Base Url and prepend /cmslibs path for CA
            path = (ctx.settings['shopUrl' + ctx.make + ctx.languageKey] || ctx.settings['shopUrl' + ctx.make]) + util.url.prepend(path, '/cmslibs');
            if (ctx.settings.syn === '1') {
                path = path + '.ext';
            }
        } else {
            // bit of goofiness to handle the /cmslibs rewrites on the FNA stack
            if (ctx.settings.syn === '1') {
                if (ctx.settings.env !== 'local') {
                    path = util.url.prepend(path, '/cmslibs');
                    path = (ctx.settings['shopUrl' + ctx.make + ctx.languageKey] || ctx.settings['shopUrl' + ctx.make]) + path + '.ext';
                }
            }
        }
        $.get(path + '.html/golf-' + formType, _.extend({
            id: formType,
            formType: formType,
            presentation: 'overlay',
            make: ctx.make,
            region: ctx.region.toLowerCase()
        }, formParameters(formType), prm)).done(function(resp) {
            if(resp) {
                var $form = $(resp);
                var $files = $form.find('script,link[rel="stylesheet"]');
                var files = [];
                var loadNextFile = function() {
                    if(files.length === 0) {
                        util.log('golf.lib: files loaded ' + formType);
                        win.setTimeout(function() {
                            def.resolve($form);
                        }, 0);
                        return;
                    }
                    var file = files.shift();
                    var url = file.url;
                    if(_loadedFiles[url]) {
                        loadNextFile();
                    } else {
                        if(file.script) {
                            util.url.loadAsScript(url).then(loadNextFile, function() {
                                util.log('golf.lib: failed to load script ' + file.url);
                                def.reject();
                            });
                        } else {
                            util.url.loadAsStyle(url);
                            loadNextFile();
                        }
                        _loadedFiles[url] = 1;
                    }
                };
                $.each($files, function(i, file) {
                    var $file = $(file);
                    if($file[0].tagName === 'SCRIPT') {
                        var src = $file.attr('src');
                        if(src) {
                            files.push({
                                script: 1,
                                url: src
                            });
                        } else {
                            $.globalEval($file.text())
                        }
                    } else {
                        files.push({
                            script: 0,
                            url: $file.attr('href')
                        });
                    }
                });
                $files.remove();
                $form.appendTo(formContainerWrap);
                util.log('golf.lib: form loaded ' + formType);
                loadNextFile();
            }
        });
        return def.promise();
    }

    function showForm(golfForm, cfg, formCallback, eventCallback, title, targetElement) {
        var _location = user.location.current();
        var config = _.extend({
            formTitle: title,
            model: ctx.nameplate && ctx.nameplate.ngpModelName,
            year: ctx.nameplate && ctx.nameplate.ngpYear,
            postalCode: _location.postalCode
        }, cfg);

        // BRAND-17295 - don't pass the postalCode to the get updates form on Ford CA if it doesn't come from either the FPI cookie or user input.
        if (ctx.make === 'Ford' && ctx.region === 'CA' && golfForm && golfForm.formType === 'getupdates') {
            if (config.postalCode && (_location.postalCodeSource === 'Akamai' || _location.postalCodeSource === 'Default')) {
                delete config.postalCode;
            }
        }
        golfForm.show(formCallback, config, eventCallback, targetElement);
    }

    function formParameters(formType) {
        return _.extend({},
            (FORM_PARAMETER_DEFAULTS[formType] || {})[ctx.make],
            ctx.forms && ctx.forms[formType]);
    }

    /**
     * Will just return the defaults (if specified) for the formType without checking for the existence of authored values.
     */
    function getFormParameterDefaults(formType) {
        return _.extend({}, (FORM_PARAMETER_DEFAULTS[formType] || {})[ctx.make] || {});
    }
    
    // new metrics for form events
    try {
        FD.Brand.Form.registerEventCallback(handleGolfMetrics);
    }
    catch(err) {
        console.log("Error occurred in the form registration handling method");
    }

    function fireGUSubmissionSuccessAction(data) {
        var formId = data && data.formId || '';
        var mtxAction = '';
        var mtxData = {};
        switch(formId) {
            case 'canvasgu':
                mtxAction = 'canvasGUSubmissionSuccessAction';
                break;
            case 'personaldriver':
                mtxAction = 'personalDriverSubmissionSuccessAction';
                break;
            case 'getUpdatesBrochures':
                //The metrics for the get brochures form are handled separately in that component, so don't set an mtxAction for it here.
                break;
            case 'kmi':
                mtxAction = 'kmiSubmissionSuccessAction';
                break;
            case 'guComm':
                var req = data && data.request,
                    resp = data && data.response;
                if(resp) {
                    var commMtx = resp.commFormMtx || {},
                        contactPref = commMtx && commMtx.contactPref;

                    if (contactPref === 'email') {
                        mtxAction = 'getUpdatesCommSubmissionSuccessEmailOptinAction';
                    } else if (contactPref === 'phone') {
                        mtxAction = 'getUpdatesCommSubmissionSuccessPhoneOptinAction';
                    } else {
                        mtxAction = 'getUpdatesCommSubmissionSuccessNeitherOptinAction';
                    }

                    mtxData['$$getUpdatesTitleType'] = commMtx && commMtx.title || '';
                    mtxData['$$getUpdatesIndustryType'] = commMtx && commMtx.industry || '';
                }
                if (req) {
                    var nameplate = util.str.firstInstance(req.mtxName, ';'),
                        year = util.str.firstInstance(req.year, ';');
                    mtxData['$$getUpdatesNameplate'] = nameplate;
                    mtxData['$$getUpdatesYear'] = year;
                }
                break;
            default:
                var req = data && data.request;
                if(req) {
                    var isEmail = req.email,
                        isMail = req.mail,
                        nameplate = util.str.firstInstance(req.mtxName, ';'),
                        year = util.str.firstInstance(req.year, ';');

                    if(typeof(isEmail) == 'undefined' || !isEmail) {
                        isEmail = 0;
                    }
                    if(typeof(isMail) == 'undefined' || !isMail) {
                        isMail = 0;
                    }

                    if(ctx.region === 'CA' || (isEmail == 1 && isMail == 0)) {
                        mtxAction = 'getUpdatesSubmissionSuccessEmailOptinAction';
                    } else if(isEmail == 1 && isMail == 1) {
                        mtxAction = 'getUpdatesSubmissionSuccessBothOptinAction';
                    } else {
                        mtxAction = 'getUpdatesSubmissionSuccessMailOptinAction';
                    }

                    mtxData['$$getUpdatesNameplate'] = nameplate;
                    mtxData['$$getUpdatesYear'] = year;
                }
                break;
        }

        if(mtxAction != '') {
            FD.Brand.Metrics.handler.direct(
                FD.Brand.Context.mtxActions[mtxAction],
                mtxData
            );
        }
    }

    function fireScheduleMtxActions(eventData, config) {
        var mtxData = {};
        if(eventData && eventData.registeredEvent === true) {
            if(config) {
                if(config.model) {
                    mtxData['$$testDriveNameplate'] = config.model.toLowerCase();
                }
                if(config.year) {
                    mtxData['$$testDriveYear'] = config.year;
                }
                if(config.response && config.response.cksVisitID) {
                    FD.Brand.Metrics.setParameter('user_cksVisitId', config.response.cksVisitID);
                }
            }
            FD.Brand.Metrics.handler.direct(
                FD.Brand.Context.mtxActions[eventData.mtxKey],
                mtxData
            );
        }
    }
    
    function handleGolfMetrics (formType, eventName, config) {
        try {
            switch (formType) {
            case 'getupdates':
                // Get Updates form events
                switch (eventName) {
                case 'FormShown':
                    var showAction = 'getUpdatesShowFormAction';
                    if(config && config.formId) {
                        switch(config.formId) {
                            case 'canvasgu':
                                showAction = 'canvasGUShowFormAction';
                                break;
                            case 'personaldriver':
                                showAction = 'personalDriverShowFormAction';
                                break;
                            case 'kmi':
                                showAction = 'kmiShowFormAction';
                                break;
                            case 'getUpdatesBrochures':
                                showAction = '';
                                break;
                            case 'guComm':
                                showAction = 'getUpdatesCommShowFormAction';
                                break;
                        }
                    }

                    if(showAction !== '') {
                        // metrics call for showing form
                        FD.Brand.Metrics.handler.direct(
                            FD.Brand.Context.mtxActions[showAction]
                        );
                    }
                    break;
                case 'SubmissionSucceeded':
                    // metrics call for successful submission
                    fireGUSubmissionSuccessAction(config);
                    break;
                }
                break;
            case 'schedule':
                var eventList = SCHEDULE_EVENT_DATA[(config && config.formId) || 'schedule'] || SCHEDULE_EVENT_DATA['schedule'];
                switch (eventName) {
                case 'FormShown' :
                    var eventData = eventList && eventList['FormShown'] || {};
                    fireScheduleMtxActions(eventData, config);
                    break;
                case 'RequestView':
                    var eventData = eventList && eventList['RequestView'] || {};
                    fireScheduleMtxActions(eventData, config);
                    break;
                case 'ResponseView':
                    var eventData = eventList && eventList['ResponseView'] || {};
                    fireScheduleMtxActions(eventData, config);
                    break;
                case 'SelectVehicleView':
                    var eventData = eventList && eventList['SelectVehicleView'] || {};
                    fireScheduleMtxActions(eventData, config);
                    break;
                }
                break;
            case 'emailshare':
                switch (eventName) {
                    case 'ResponseView':
                    //case 'SubmissionSucceeded':
                        var eventData = {
                            "formType": formType,
                            "eventName": eventName,
                            "config": config
                        };
                        $('body').trigger('fgxBrandShareComplete', [eventData]);
                        break;
                }
                break;
            }
        } catch(err) {
            console.log("Error occurred in the form event callback method " + err);
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context, FD.Brand.User, FD.Brand.Util);
/*global FD*/
;(function(win, $, _, brand, util) {

    // setup namespace
    _.extend(brand.namespace('FD.Brand.Position', win), {
        items: {
            setup: setupPositionedItems,
            update: updatePositionedItems
        }
    });

    function setupPositionedItems(element, positionedItemClass, contextSelector) {
        var slides = {},
            $element = $(element),
            positionedItemClass = positionedItemClass || "fgx-positioned-slide-",
            contextSelector = contextSelector || ".billboard-slide.item";

        $element.find(contextSelector).each(function() {
            var $elm = $(this),
                slideId = $elm.data("slideId") || "0",
                elements = $elm.find('[data-position-element]'),
                slideItem = {};

            elements.each(function(idx) {
                var $posElm = $(this),
                    data = $posElm.data('positionElement');

                if(data && data.styles && !$.isEmptyObject(data.styles)) {
                    var itemClass = "fgx-" + data.itemType + "-" + idx;
                    slideItem[itemClass] = data;
                    $posElm.addClass(itemClass);
                    if(util.currentBreakpoint() === 'gux-bkpt-sm') {
                        if(data.hasMobileOverride) {
                            $posElm.css(data.styles.mobile);
                        } else {
                            //add the desktop styles on mobile if we don't have a mobile override
                            if(data.styles.desktop) {
                                $posElm.css(data.styles.desktop);
                            }
                        }
                    } else {
                        if(data.styles.desktop) {
                            $posElm.css(data.styles.desktop);
                        }
                    }
                }
            });

            if(!$.isEmptyObject(slideItem)) {
                var itemClass = positionedItemClass + slideId;
                $elm.addClass(itemClass);
                slides[itemClass]= slideItem;
            }
        });

        return slides;
    }

    function updatePositionedItems(version, positionedObjects) {
        //Iterate over the billboards that have positioned items
        $.each(positionedObjects, function(key, value) {
            if(value && !$.isEmptyObject(value)) {
                //Iterate over the slides
                $.each(value, function(k, v) {
                    if(v && !$.isEmptyObject(v)) {
                        //Iterate over the slide items (headline, subheadline, cta, etc.)
                        $.each(v, function(k1, v1) {
                            if((version === 'mobile' && !v1.hasMobileOverride) || (v1.styles[version] && $.isEmptyObject(v1.styles[version]))) {
                                return;
                            }

                            var selector = "." + k1;
                            var context = "." + key + " ." + k;
                            $(selector, context).css(v1.styles[version]);
                        });
                    }
                });
            }
        });
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util);
;(function(win, $, _, util, ctx) {

    // setup namespace
    _.extend(FD.Brand.namespace('FD.Brand.External', win), {
        adChoices: {
            show: showAdChoices
        },
        whosOn: {
            show: showWhosOn
        },
        commentCard: {
            show: showCommentCard
        },
        vrPlayer: {
            show: showVrPlayer
        },
        cafex: {
            load: loadCafeX
        }
    });

    var _loadedScripts = [];

    var _whosOnDomains = {
        'US-Ford': {
            'sync': '/chat/chatstart.htm?domain=' +
                (ctx.settings.env === 'prod' ? 'support.ford.com' : 'sync.ford.com') +
                '&AspxAutoDetectCookieSupport=1&SID=0',
            'vehicle': '/chat/chatstart.htm?domain=owner.ford.com&AspxAutoDetectCookieSupport=1&SID=0'
        },
        'US-Lincoln': {
            'concierge': '/chat/chatstart.htm?domain=www.lincoln.com&SID=1'
        },
        'CA-Lincoln': {
            'concierge': '/chat/chatstart.htm?domain=www.lincolncanada.com&SID=1'
        }
    };
    var _whosOnWindows = {};
    var _vrConfig = {
        WL_PLAYER_ID: 'wl_vr-player',
        initialized: false,
        options: {}
    };
    var _staticAdChoicesSets = [
        {
            smartLink: '#$creditAdChoices',
            type: 'credit',
            btnId: '_bapw-link',
            pid: getSettingsData('creditAdChoicesPid') || 18173,
            cid: getSettingsData('creditAdChoicesCid') || 1063,
            removeTag: false,
            loaded: false
        },
        {
            smartLink: '#$adChoices',
            type: 'brand',
            btnId: '',
            btnCls: 'evidon-notice-link',
            removeTag: true,
            loaded: false
        }
    ];

    $(init);

    function init() {
        var settings = ctx && ctx.settings || {};
        if(ctx.translationProvider === 'motionpoint') {
            loadMotionPoint();
        }
        if (ctx.region === 'US' && !settings.syn) {
            loadCommentCard();
        } else if (settings.syn && ctx.includeIPerceptionsInSyndicatedFooter === 'include') {
            loadCommentCard();
        }
        if (ctx.accessibility.accessibilityJSInclude === 'wcag') {
            loadAccessibility();
        }
        if(ctx.chatServiceProvider == 'cafex' && ctx.loadCafexOnPage) {
            loadCafeX();
        }

        setupStaticAdChoices(false);
    }

    function loadScripts(scripts) {
        var def = $.Deferred();
        var loadNextScript = function() {
            if(scripts.length === 0) {
                def.resolve();
                return;
            }
            var script = scripts.shift();
            if(_loadedScripts[script]) {
                loadNextScript();
            } else {
                var host = (ctx.settings.synBaseUrl && script[0] === '/' && script[1] !== '/') ? ctx.settings.synBaseUrl : '';
                util.url.loadAsScript(host + script).then(loadNextScript, function() {
                    util.log('external.lib: failed to load script ' + script);
                    def.reject();
                });
                _loadedScripts[script] = 1;
            }
        };
        loadNextScript();
        return def.promise();
    }

    function showAdChoices(el) {
        if(!util.url.allowScript('6')) {
            util.log('external.lib: AdChoices library not loaded due to privacy settings');
            return;
        } else if (ctx.region === 'US' && ctx.make == 'Lincoln') {
            util.log('external.lib: original AdChoices smartLink functionality disabled for Lincoln US');
            return;
        }
        var pid = 201;
        var ocid = 1063;
        var protocol = win.location.protocol;
        var basePath = (protocol === 'https:') ? 'https://a248.e.akamai.net/betterad.download.akamai.com/91609/pub/' : 'http://cdn.betrad.com/pub/';
        var track = function (a) {
            var img = new Image();
            img.src = protocol + "//l.betrad.com/pub/p.gif?pid=" + pid + "&ocid=" + ocid + "&i" + a + "=1&r=" + Math.random();
        };
        var bp = FD.Brand.Util.currentBreakpoint();
        if (bp === 'gux-bkpt-sm' || bp === 'gux-bkpt-med') {
            win.open('//info.evidon.com/pub_info/' + pid + '?v=1');
            track('c');
        } else {
            loadScripts([
                basePath + 'pub2.js'
            ]).done(function () {
                if (win.BAPW && win.BAPW.i) {
                    win.BAPW.i(el, {
                        pid: pid,
                        ocid: ocid
                    });
                }
                //Temporary fix for https://issues.ngptools.com/jira/browse/AEMOPS-6175
                //Should be removed once Ad Choices fixes this issue within their script
                window.addEventListener("message", function(){
                    $("#_bapw-notice").remove();
                }, false );
            });
        }
    }

    function loadStaticAdChoices(item) {
        if(item && !item.loaded) {
            if(!util.url.allowScript('6')) {
                util.log('external.lib: Static AdChoices library not loaded due to privacy settings');
                return;
            }
            var ev = document.createElement('script');
            ev.type = 'text/javascript';
            ev.async = true;
            if (item.type === 'credit') {
                ev.setAttribute('data-ev-tag-pid', item.pid || '');
                ev.setAttribute('data-ev-tag-ocid', item.cid || '');
                ev.src = '//c.evidon.com/pub/tag.js';
            } else {
                var host = (ctx.settings && ctx.settings.synBaseUrl) ? ctx.settings.synBaseUrl : '';
                ev.src = host + '/cmslibs/etc/designs/brand_ford/brand/vendor/adchoices/js/adchoices.js';
            }
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ev, s);
            item.loaded = true;
        }
    }

    function setupStaticAdChoices(skipFooterListener) {
        var $globalFooterEl = $('body').find('[data-fgx-global-footer]').not('[data-fgx-init]');
        var found = false;
        _staticAdChoicesSets.forEach(function(item) {
            var $el = $('body').find('a[href=\'' + item.smartLink + '\']');
            if ($el && $el.length > 0) {
                $el.attr('id', item && item.btnId || '_bapw-link');
                if (item.removeTag && item.btnCls) {
                    $el.parent().addClass(item.btnCls);
                    $el.remove();
                } else if (item.btnCls) {
                    $el.addClass(item.btnCls);
                }
                loadStaticAdChoices(item);
                found = true;
            }
        });

        // There's a possibility that the footer component hasn't been loaded when this logic is run initially on syndicated
        // pages. Therefore, the below logic is used to check if thats the case, and if so, sets up a listener that will
        // re-trigger the setupStaticAdChoices logic once the globalFooter is loaded.
        if (!found && !skipFooterListener && ctx.settings && ctx.settings.syn && (!$globalFooterEl || ($globalFooterEl && $globalFooterEl.length === 0))) {
            $('body').one('fgxBrandGlobalFooterInitialized', function() {
                setupStaticAdChoices(true);
            });
        }
    }

    function showWhosOn(domainId) {
        var domain = _whosOnDomains[ctx.region + '-' + ctx.make][domainId];
        if(domain) {
            var whosOnWindow = _whosOnWindows[domainId];
            if(whosOnWindow && !whosOnWindow.closed) {
                whosOnWindow.focus();
            } else {
                var url = ctx.settings.whosOnUrl + domain + '&lang=' + ctx.language;
                _whosOnWindows[domainId] = win.open(
                    url,
                    domainId,
                    'scrollbars=1,menubar=0,resizeable=1' +
                    (util.currentBreakpoint() !== 'gux-bkpt-sm' ? ',width=484,height=361' : '')
                );
            }
        }
    }

    function loadCommentCard() {
        if(!util.url.allowScript('6')) {
            util.log('external.lib: iPerceptions library not loaded due to privacy settings');
            return;
        }
        win.setTimeout(function() {
            loadScripts([
                '//ips-invite.iperceptions.com/invitations/invitationsJS/126/s126452/iPGCC_launcher.js'
            ]);
        }, 10)
    }

    function showCommentCard() {
        if(win.ipeGCCards) {
	        win.ipeGCCards.loadScript();
        } else {
            util.log('external.lib: iPerceptions comment card library not loaded');
        }
    }

    function loadAccessibility() {
        win.setTimeout(function() {
            loadScripts([
                '/cmslibs/etc/designs/brand_ford/brand/vendor/accessibility/wcag.js'
            ]);
        }, 5000);
    }

    function loadMotionPoint() {
        if(!util.url.allowScript('6')) {
            util.log('external.lib: MotionPoint library not loaded due to privacy settings');
            return;
        }
	    var mp_el = document.createElement('script');
	    mp_el.id = 'mpelid';
	    mp_el.async = true;
	    mp_el.src = ctx.settings['mpEasyLinkUrl' + ctx.make];
	    var s = document.getElementsByTagName('script')[0];
	    s.parentNode.insertBefore(mp_el, s);
	    win.mp_var = {
		    UrlLang: 'mp_js_current_lang',
		    SrcUrl: decodeURIComponent('mp_js_orgin_url'),
		    oSite: decodeURIComponent('mp_js_origin_baseUrl'),
		    tSite: decodeURIComponent('mp_js_translated_baseUrl')
	    }
    }

    function showVrPlayer(config, $el) {
        var def = $.Deferred();
        initVrPlayer().then(function() {
            var callbacks = {
                exitCallback: function() {
                    var $player = $('#' + _vrConfig.WL_PLAYER_ID);
                    $('body').removeClass('no-scroll');
                    $player.removeClass('shown');
                    $player.empty();

                    if($el && $el.length > 0) {
                        $el.focus();
                    }
                }
            };
            var options = _.extend(_vrConfig.options, callbacks);
            var path = (config && config.wl_appConfig) ? config.wl_appConfig : "";
            if(path !== "") {
                var rattler = win && win.RATTLER || {};
                var obj = rattler.createPlayer(path, document.getElementById(_vrConfig.WL_PLAYER_ID), options);

                $('#' + _vrConfig.WL_PLAYER_ID).addClass('shown');
                $('body').addClass('no-scroll');
                def.resolve(obj);
            } else {
                def.resolve({});
            }
        }, function() {
            def.reject();
        });
        return def.promise();
    }

    function initVrPlayer() {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            if(_vrConfig.initialized) {
                def.resolve();
            } else {
                // create wl player tag to add the custom VR player to
                $('<div id="' + _vrConfig.WL_PLAYER_ID + '"></div>')
                    .appendTo($('body'));

                window.__webpack_public_path__="/cmslibs/etc/designs/brand_ford/brand/vendor/vrplayer/";

                loadScripts(['/cmslibs/etc/designs/brand_ford/brand/vendor/vrplayer/static/js/fordcom360v1.0.13.js']).then(function() {
                    _vrConfig.initialized = true;
                    def.resolve();
                }, function() {
                    _vrConfig.initialized = false;
                    $('#' + _vrConfig.WL_PLAYER_ID).remove();
                    util.log('vr.lib: error loading VR Player JS file');
                    def.reject();
                });
            }
        } else {
            util.log('external.lib: 360 VR Player library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    function loadCafeX() {
        if(!util.url.allowScript('6')) {
            util.log('external.lib: CafeX library not loaded due to privacy settings');
            return;
        }
        var scriptPath = ctx && ctx.settings['cafexUrl'] || '/cmslibs/etc/designs/common/vendor/cafex/cafex_PROD.js';
        loadScripts([
            scriptPath
        ]);
    }

    function getSettingsData(key) {
        var settings = ctx && ctx.settings || {};
        return settings[key + ctx.make + ctx.languageKey] || settings[key + ctx.languageKey] || settings[key + ctx.make] || settings[key];
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand.Util, FD.Brand.Context);
/*global FD*/
/**
 * Link support library
 */
;(function(win, $, _, ctx, ngp, overlay, util, form) {

    // setup namespace
    _.extend(FD.Brand.namespace('FD.Brand.Link', win), {
        baseUrl: baseUrl,
        secureUrl: secureUrl,
        processLink: processLink,
        switchLanguage: switchLanguage,
        externalUrl: function() { return true; },
        getPageContext: getPageContext,
        setPageContext: setPageContext
    });

    var settings = ctx.settings;
    var linkParameters = {};
    var attributes = {
        urlKey: 'urlKey',
        trimName: 'trimName',
        trimId: 'trimId',
        ngpTrimName: 'ngpTrimName',
        brandNameplateLink: 'brandNameplateLink'
    };
    var LANG_COOKIE = 'lang';
    var pageContext = {
	    make: ctx.make,
	    model: ctx.nameplate && ctx.nameplate.ngpModelName,
	    year:  ctx.nameplate && ctx.nameplate.ngpYear,
	    trim: ctx.model && ctx.model.ngpTrimName
    };
    var segmentNameMap = {
        'car': 'cars',
        'crossover': 'crossovers',
        'suv': 'suvs',
        'hybrid': 'cars',
        'truck': 'trucks',
        'commercial-truck': 'commercial-trucks'
    };
    var _configureNameplateList = ['bronco sport', 'bronco'];

	$(init);
    $('body').on('click', 'a[href^=\'#$\']', customLinkClick);
    // global key-listener for non <a> and <button> elements which should be actionable or links to add behaviors for accessibility
    $('body').on('keypress', '[data-fgx-keypress]', fgxBrandKeyPress);
    // separate listener needed for arrow and esc keys - not all browsers support keypress for those.
    $('body').on('keydown', '[data-fgx-keypress]', fgxBrandKeyDown);
    // listener to transition to another item via arrow keys when on an item within a group (radio button or tab)
    $('body').on('keydown', '[data-fgx-focusable-group-item]', fgxFocusableGroupKeyDown);

    //////

    function init() {
        // check if need to switch to preferred language
        if(ctx.translationProvider === 'tdc') {
            var code = util.cookie.get(LANG_COOKIE);
            if(code && code !== ctx.language) {
                var lang = _.find(ctx.languages.languageLinks, { code: code });
                if(lang) {
                    location.assign(langUrlPath(lang.domain));
                    return;
                }
            }
        }
        // process custom link on initial hash
        var hash = win.location.hash;
        if(hash && hash.substring(0, 2) === '#$') {
            var context = linkContext();
            getParameters(context).done(function(prm) {
                processLink(hash, null, context, prm);
            }).fail(function() {
                util.log('Failed to open hash link ' + hash, context);
            })
        }
        // process deep links
        if
        (
            settings.deepLink &&
            settings.deepLink.match(/[^/]+/g).length === 1) // no deeplinks with subpaths
        {
            try {
                var $link = $('#' + settings.deepLink.substring(1));
                win.setTimeout(function() {
                    console.log('deep link to ' + settings.deepLink);
                    util.window.scrollTo($link, 250);
                }, 200);
            } catch(e) { }
        }

        if (settings && !settings.syn) {
            setupGlobalFocusInListener();
        }
    }

    function customLinkClick(ev) {
        ev.preventDefault();
        var $el = $(this);
        var href = $(this).attr('href');
        var target = $(this).attr('target');
        var context = linkContext($el.closest('[data-link-context]'));
        getParameters(context).done(function(prm) {
            processLink(href, target, context, prm, $el);
        }).fail(function() {
            util.log('Failed to open link ' + href, context);
        });
    }
    
    function fgxBrandKeyPress(ev){
        var focused = $(':focus');
        var role = focused.attr('role');
        if(ev.which === 13 && (role === 'radio' || role === 'button' || role === 'link' || role === 'combobox' || role === 'option' || role === 'listbox')) {
            ev.preventDefault();
            ev.stopPropagation();
            focused.trigger('click');
        } else if (ev.which === 32 && (role === 'radio' || role === 'button' || role === 'combobox' || role === 'checkbox' || role === 'option' || role === 'listbox')) {
            // prevent the default 'space' behavior, which causes the window to scroll
            ev.preventDefault();
            ev.stopPropagation();
            focused.trigger('click');
        }
    }
    
    function fgxBrandKeyDown(ev) {
        var focused = $(':focus');
        var role = focused.attr('role');
        if (ev.which === 40 && (role === 'option' || role === 'combobox' || role === 'listbox')) {
            // down arrow
            ev.preventDefault();
            ev.stopPropagation();
            if (role === 'combobox' || role === 'listbox') {
                $dropdownEl = $('.fgx-custom-select-dropdown', focused);
                if (!$dropdownEl.hasClass('shown')) {
                    focused.trigger('click');
                    // then focus first li
                    $('li:visible', $dropdownEl).first().focus();
                } else {
                    // don't trigger click, only shift focus
                    $('li:visible', $dropdownEl).first().focus();
                }
            } else {
                // focus next li
                focused.next().focus();
            }
        } else if (ev.which === 38 && (role === 'option' || role === 'combobox' || role === 'listbox')) {
            // up arrow
            ev.preventDefault();
            ev.stopPropagation();
            if (role === 'combobox' || role === 'listbox') {
                $dropdownEl = $('.fgx-custom-select-dropdown', focused);
                if (!$dropdownEl.hasClass('shown')) {
                    focused.trigger('click');
                    // then focus last li
                    $('li:visible', $dropdownEl).last().focus();
                } else {
                    // don't trigger click, only shift focus
                    $('li:visible', $dropdownEl).last().focus();
                }
            } else {
                // focus prev li
                focused.prev().focus();
            }
        } else if (ev.which === 27 && (role === 'option')) {
            // esc key
            ev.preventDefault();
            ev.stopPropagation();
            focused.closest('.fgx-custom-select').trigger('click');
            focused.closest('.fgx-custom-select').focus();
        }
    }

    function fgxFocusableGroupKeyDown(ev) {
        var focused = $(document.activeElement),
            $groupContainer = focused.closest('[data-fgx-focusable-group]'),
            $items = $groupContainer.find('[data-fgx-focusable-group-item]'),
            itemsCount = $items.length;

        if($groupContainer.length > 0 && itemsCount > 1) {
            //We have a group with more than 1 item so we need to check the key that is pressed and handle accordingly.
            var idx = $items.index(focused),
                nextIdx = idx,
                keyCode = ev.which;

            if(keyCode === 37 || keyCode === 38) {
                // left and up arrow should go to the previous element
                nextIdx = (idx === 0) ? (itemsCount - 1) : (idx - 1);
            } else if(keyCode === 39 || keyCode === 40) {
                // right and down arrow should go to the next element
                nextIdx = (idx === (itemsCount - 1)) ? 0 : (idx + 1);
            }

            if(nextIdx !== idx) {
                //The next index was updated so one of the proper keys was pressed and we should move forward changing the focus.
                ev.preventDefault();
                ev.stopPropagation();

                var $nextItem = $items.eq(nextIdx),
                    role = focused.attr('role');
                $nextItem.focus();
                if(role === 'radio') {
                    $nextItem.trigger('click');
                }
            }
        }
    }

    function setupGlobalFocusInListener() {
        var navSelector = (ctx && ctx.make === 'Lincoln') ? '.lincolnMainNavigation' : '.fordMainNavigation',
            $mainNav = $(navSelector),
            $secondaryNav = $('.secondaryNavigation'),
            _hasSecondaryNav = ($secondaryNav.length > 0),
            excludedSelectors = navSelector + ', .media-overlay, .postal-code-wrapper, .search-overlay, .fgx-overlay' + ((_hasSecondaryNav) ? ', .secondaryNavigation' : ''),
            $stickyEl = (_hasSecondaryNav) ? $secondaryNav : $mainNav,
            $win = $(win);

        var handleFocusIn = function(ev) {
            var $target = $(ev.target);
            if (!$target || $target.closest(excludedSelectors).length > 0) {
                return;
            }
            var vpTop = Math.floor($win.scrollTop()),
                elmBorderTop = Math.floor($target.offset().top),
                elmBorderBtm = Math.floor(elmBorderTop + $target.outerHeight(true)),
                topPosDiff = elmBorderTop - vpTop,
                stickyOffset = $stickyEl.height();
            if (vpTop > $mainNav.height() && ((topPosDiff >= 0 && topPosDiff < stickyOffset) || (topPosDiff < 0 && elmBorderBtm > vpTop)) && (_hasSecondaryNav || !$mainNav.hasClass('hide-off-top'))) {
                var scrollPos = vpTop - (stickyOffset - topPosDiff) - 10;
                $('html, body').animate({
                scrollTop: scrollPos
                }, 200);
            }
        };
        $('body').on('focusin', util.debounce(handleFocusIn, 300));
    }

    function linkContext($ctxEl) {
        return _.assign({}, pageContext, $ctxEl && $ctxEl.length && $.parseJSON($ctxEl.attr('data-link-context')) || {});
    }

    function showGolfForm(typ, $el) {
        FD.Brand.User.authentication.current().then(function(authState) {
            var $ctxEl = $el && $el.closest('[data-link-context]');
            var cfg = _.assign(
                (typ === 'quote' || typ === 'testdrive' || typ === 'testdrivev2') && pageContext.make === 'Lincoln' && authState.authType === 'user'
                    ? { lead: { leadSource: 'Lincoln.com Concierge Lead' } }
                    : (typ === 'bltestdrive' && pageContext.make === 'Lincoln')
                    ? { configToken: ctx.pageConfigToken}
                    : {},
                $ctxEl && $ctxEl.length && $.parseJSON($ctxEl.attr('data-link-context')) || {});

            switch(typ) {
                case 'testdrive':
                case 'testdrivev2':
                case 'bltestdrive':
                case 'fleettestdrive':
                    cfg.lead = _.assign({}, { context: 'BrandScheduleTestDrive' }, cfg.lead || {});
                    break;
            }
            var $overrideLastFocus = $el && $el.data('fgxLastFocusOverride');
            var $lastFocusElm = ($overrideLastFocus && $overrideLastFocus.length > 0) ? $overrideLastFocus : $el;
            form[{
                quote: 'request',
                testdrive: 'schedule',
                bltestdrive: 'blschedule',
                testdrivev2: 'schedulev2',
                fleettestdrive: 'fleetschedule'
            }[typ] || typ].show(cfg, null, null, null, $lastFocusElm);
        });
    }

    function getParameters(context) {
        return $.Deferred(function (defer) {
            var key = _.values(context).join('-');
            var prm = linkParameters[key];
            if (prm) {
                defer.resolve(prm);
            } else {
                if(!((context.model && context.year) || context.configToken)) {
                    defer.resolve(null);
                    return;
                }
                prm = {};
                var attr = _.keys(attributes).join(',');
                if (context.configToken) {
                    ngp.attributesProxy('/config/Details.json', {
                        configToken: context.configToken,
                        partClass: 'NONE',
                        returnAttributes: 'NGP_ModelInfo_VehicleType',
                        appContext: 'T1'
                    }, attr).done(function(resp) {
                        var config = resp && resp.Response;
                        if(config) {
                            var attrVal = _.assign(ngp.attributeMap(config.Attribute), config._attributes);
                            var params = {
                                make: config.Make,
                                model: config.Model,
                                year: config.Year
                            };
                            prm = _.assign({}, prm, params);
                            prm.trim = context.configToken;
                            prm.config = context.configToken;

                            // NZ - updating the context parameters here with the make/model/year returned from the
                            // configDetail call to properly handle the potential situation where either a model/year
                            // aren't passed in the context object initially, or the configToken references a different
                            // vehicle than the other parameters that were passed in.
                            _.assign(context, params);

                            _.each(attrVal, function(v, k) {
                                if(attributes[k]) {
                                    prm[attributes[k]] = v;
                                }
                            });
                            if(attrVal['NGP_ModelInfo_VehicleType']) {
                                prm.vehicleType = attrVal['NGP_ModelInfo_VehicleType'];
                            }
                            linkParameters[key] = prm;
                            defer.resolve(prm);
                        } else {
                            defer.resolve(null);
                        }
                    }).fail(function() {
                        defer.resolve(null);
                    });
                } else {
                    ngp.attributesProxy('/products/ModelSlices.json',
                        _.assign({}, context, {
                        modelSliceDefiners: 'ST_Display_Trim_Names',
                        appContext: 'T1'
                    }), attr).done(function(resp) {
                        var model = util.objPath(resp, 'Response.Model');
                        if(model) {
                            var attrVal = model._attributes;
                            prm.vehicleType = model.VehicleType;
                            prm.year = context.year;
                            if (context.trim) {
                                var trim = context.trim.trim();
                                var foundTrim = null;
                                _.each(util.toArray(util.objPath(model, 'ModelSlices.ModelSlice') || []), function (ms) {
                                    var msAttr = ms._attributes;
                                    var id = msAttr.ngpTrimName;
                                    if (id === trim) {
                                        foundTrim = id;
                                        _.assign(attrVal, msAttr);
                                        prm.trim = ms.ConfigToken;
                                        prm.config = ms.ConfigToken;
                                        return false;
                                    }
                                });
                                if (!foundTrim) {
                                    util.log('Trim not found ' + context.trim);
                                    defer.reject();
                                    return;
                                }
                            }
                            _.each(attrVal, function (v, k) {
                                if (attributes[k]) {
                                    prm[attributes[k]] = v;
                                }
                            });

                            linkParameters[key] = prm;
                            defer.resolve(prm);
                            //util.log('link parameters', prm)
                        }
                    }).fail(function() {
                        defer.resolve(null);
                    });
                }
            }
        }).promise();
    }

    function processLink(href, target, context, prm, $el) {
        var link = /^#\$(\w*)(\/\w*)?(\?.*)?$/g.exec(href);
        if(link) {
            var url;
            var type = link[1];
            var path = link[2];
            var qs = util.url.queryString(link[3] || ' ');
            var vehType = (win.location.href.indexOf("commercial") > -1) ? 'comm' : '';
            switch(type) {
                case 'spc':
                    if(prm) {
                        prm['type'] = vehType;
                        FD.Brand.Pricing.show(_.extend({}, context, prm), $el);
                        return;
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'estimatepayment');
                    }
                    break;
                case 'postalCode':
                    overlay.instance.postalCodeOverlay.show(true, $el, 'input');
                    return;
                case 'languageSelector':
                    overlay.instance.languageSelector.show(true, $el, 'a.btn');
                    return;
                case 'sendEmail':
                    overlay.instance.emailOverlay.show(true, $el, '.email-subject-textfield');
                    return;
                case 'bp':
                    if(prm) {
                        var toConfigApp = useConfigureApp(context.model),
                            appID = ((ctx && ctx.make === 'Lincoln') || toConfigApp) ? '/configure/' : '/build/';
                        url = [ baseUrl('shop'),
                            appID,
                            prm.urlKey,
                            '/',
                            context.year,
                            '/'];
                        if (toConfigApp) {
                            // BRAND-16019 - go to the new configure application
                            if (context.configToken) {
                                url.push(
                                    'config/exterior/',
                                    prm.config
                                );
                            } else if (context.trim && prm.trimId) {
                                url.push(
                                    'model/customize/',
                                    prm.trimId
                                );
                            }
                        } else {
                            // BRAND-16019 - go to the BNP experience
                            //BRAND-14435
                            if (context.configToken) {
                                // BRAND-16019 - the check for 'configure' here relates to whether we're directing to BNP
                                // for Lincoln or Ford as BNP for Lincoln is setup to use 'configure' in the URL. This check
                                // is NOT related to the actual configure application in any way.
                                var pageKey = (appID === '/configure/') ? 'exterior' : 'config';
                                url.push(
                                    '#/',
                                    pageKey,
                                    '/',
                                    prm.config
                                );
                            } else if(context.trim) {
                                url.push(
                                    '#/select/',
                                    prm.config
                                );
                            }
                        }
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'build');
                    }
                    break;
                case 'si':
                    url = [ baseUrl('shop'),
                        '/inventory/' ];
                    if(prm) {
                        url.push(
                            prm.urlKey || context.model.replace(/\s/g, '').toLowerCase(),
                            '/',
                            context.year,
                            '/'
                        );
                        if(context.trim) {
                            qs.add('selectTrim', prm.ngpTrimName);
                        }
                    }  else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'inventory');
                    }
                    break;
                case 'siresults':
                    url = [ baseUrl('shop'),
                        '/inventory/' ];
                    if(prm) {
                        url.push(
                            prm.urlKey || context.model.replace(/\s/g, '').toLowerCase(),
                            '/results/'
                        );
                        if(context.year) {
                            qs.add('year', context.year);
                        }
                        if(context.trim) {
                            qs.add('selectTrim', prm.ngpTrimName);
                        }
                        if(context.radius) {
                            qs.add('Radius', context.radius);
                        }
                    }  else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'inventoryresults');
                    }
                    break;
                case 'incentives':
                    if(prm) {
                        url = [ baseUrl('ngbs'),
                            ngbsNameplatePath(prm),
                            '/pricing-and-incentives/'
                        ];
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'incentives');
                    }
                    break;
                case 'nbs':
                    url = [ baseUrl('shop'),
                        '/showroom/' ];
                    break;
                case 'iqq':
                    if(prm) {
                        url = [ baseUrl('shop'),
                            '/quote/' ];

                        url.push(
                            prm.urlKey || context.model.toLowerCase(),
                            '/',
                            context.year,
                            '/'
                        );
                        if(context.trim) {
                            qs.add('select', prm.trimName);
                        }
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'quote');
                    }
                    break;
                case 'compare':
                    if(prm) {
                        url = [ baseUrl('ngbs'),
                            ngbsNameplatePath(prm),
                            '/compare/'
                        ];
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'compare');
                    }
                    break;
                case 'brochures':
                    if(prm) {
                        url = [ baseUrl('ngbs'),
                            ngbsNameplatePath(prm),
                            '/brochures/'
                        ];
                    } else {
                        url = [ baseUrl('shop'),
                            '/showroom/' ];
                        qs.add('linktype', 'brochures');
                    }
                    break;
                case 'quote':
                case 'testdrive':
                case 'getupdates':
                case 'guShop':
                case 'guReveal':
                case 'guRevealShop':
                case 'guRevealCTA':
                case 'guBillboard':
                case 'guComm':
                case 'blgetupdates':
                case 'bltestdrive':
                case 'canvasgu':
                case 'personaldriver':
                case 'testdrivev2':
                case 'fleettestdrive':
                case 'kmi':
                case 'imageshare':
                case 'videoshare':
                    showGolfForm(type, $el);
                    return;
                case 'userSignIn':
                    // url = [ baseUrl('ngbsSecure'),
                    //     '/account/sign-in/?CLWInitLoad=signin&CLWRedirectLogin=',
                    //     encodeURIComponent(window.location.href),
                    //     "&Continue=",
                    //     encodeURIComponent(window.location.href) //BNP-4030
                    // ];
                    FD.Brand.User.authentication.login();
                    break;
                case 'userSignOut':
                    FD.Brand.User.authentication.logout();
                    return;
                case 'opinionLab': // included for backward compatibility
                case 'commentCard':
                    FD.Brand.External.commentCard.show();
                    break;
                case 'adChoices':
                    FD.Brand.External.adChoices.show($el && $el[0]);
                    break;
                case 'chat':
                    if(ctx && ctx.chatServiceProvider == 'cafex') {
                        FD.Brand.External.cafex.load();
                    } else {
                        FD.Brand.External.whosOn.show(path && path.substring(1));
                    }
                    break;
                case 'vrPlayer':
                    var $ctxEl = $el.closest('[data-vr-config]');
                    var vrConfig = _.extend({}, $ctxEl && $ctxEl.length && $.parseJSON($ctxEl.attr('data-vr-config')) || {});
                    FD.Brand.External.vrPlayer.show(vrConfig, $el);
                    break;
                case 'browserBack':
                    win.history.back();
                    break;
                case 'cookieSettings':
                    if (win.Optanon) {
                        try {
                            win.Optanon.ToggleInfoDisplay();
                        } catch(e) {
                            util.log('link.lib: error occurred opening the OneTrust cookie overlay. ', e);
                        }
                    } else {
                        util.log('link.lib: window.Optanon does not exist');
                    }
                    break;
                default:
                    util.log('link.lib: Unknown link', link);
                    return;
            }
            if(url) {
                url.push(qs.asString());
            }
            var fullLink = url && url.join('');
            if(fullLink) {
                if (target === '_blank') {
                    window.open(fullLink);
                } else {
                    window.location.assign(fullLink);
                }
            }
        }
    }

    function secureUrl(url) {
        return url.replace(/^http:\/\//i, 'https://');
    }

    function ngbsNameplatePath(prm) {
        if(ctx.nameplatePath) {
	        return ctx.nameplatePath.substr(ctx.siteRootPath.length) || '';
        } else {
            var output = prm.brandNameplateLink || '';
            return (output.slice(-1) === '/') ? output.slice(0, output.length - 1) : output;
        }
    }

    function baseUrl(type) {
        var key = type + 'Url';
        return settings[key + ctx.make + ctx.languageKey] || settings[key + ctx.languageKey] || settings[key + ctx.make] || settings[key];
    }

    function useConfigureApp(np) {
        return (_configureNameplateList.indexOf((np || '').toLowerCase()) >= 0);
    }
    
    function switchLanguage(el) {
        var $el = $(el);
        if($el.hasClass('current-lang')) {
            return true;
        }
        var lang = el.getAttribute('data-lang');
        var url = el.getAttribute('data-href');
        switch(ctx.translationProvider) {
            case 'tdc':
                location.assign(langUrlPath(url));
                var domain = ctx.settings['siteCookieDomain' + ctx.make];
                util.cookie.set(LANG_COOKIE, lang, {
                    path: '/',
                    domain: ((domain || '') === '') ? null : domain,
                    expires: 30
                });
                return true;
            default:
                // motion point
                return false;
        }
    }

    function langUrlPath(langDomain) {
        var path = location.pathname;
        if(path === '/') {
            path = '';
        }
        var outPath = '';
        if(path.indexOf('/content/') === 0) {
            var pathArr = path.split('/');
            for(var i = 5; i < pathArr.length; i++) {
                outPath += '/';
                outPath += pathArr[i];
            }
            // if(outPath.length === 0) {
            //     outPath = '/';
            // }
        } else {
            outPath = path;
        }
        outPath = util.url.extension(outPath).removeSpecified('.html');
        if(outPath.length > 0 && outPath.substring(outPath.length - 1) !== '/') {
            outPath += '/'
        }
        return '//' + langDomain + outPath + util.url.queryString().asString();
    }

    function getPageContext() {
        return _.assign({}, pageContext);
    }

    function setPageContext(ctx) {
        ctx = ctx || {};
        if(ctx.configToken) {
            ngp.configDetail({
                configToken: ctx.configToken,
                partClass: 'NONE',
                returnAttributes: 'ST_Display_Trim_Names',
                appContext: 'T1'
            }).done(function(config) {
                if(config) {
                    var params = {
                        make: config.Make,
                        model: config.Model,
                        year: config.Year,
                        trim: config.Attribute && config.Attribute.Value,
                        configToken: ctx.configToken
                    };
	                _.assign(pageContext, params);
	                updateFDContext(params);
                }
            });
        } else {
	        var params = {
                make: ctx.make,
                model: ctx.model,
                year: ctx.year,
                trim: ctx.trim
            };
	        _.assign(pageContext, params);
            updateFDContext(params);
        }
    }

    function updateFDContext(params) {
        if(ctx) {
            ctx.make = params.make;
            var nameplate = {
                ngpModelName: params.model,
                ngpYear: params.year
            };
            ctx.nameplate = _.extend({}, ctx.nameplate || {}, nameplate);

            if(params.trim) {
                var model = {
                    ngpTrimName: params.trim
                };
                ctx.model = _.extend({}, ctx.model || {}, model);
            }
            if(params.configToken) {
                ctx.pageConfigToken = params.configToken;
            }
        }
        if (FD.Brand && FD.Brand.Metrics) {
            FD.Brand.Metrics.updateVehicle(params.make, params.model, params.year);
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand.Context, FD.Brand.NgpServices, FD.Brand.Overlay, FD.Brand.Util, FD.Brand.Form);

/*global FD*/
(function(win, $, _, brand, ctx, user, util) {

    // dealer library
    _.extend(brand.namespace('FD.Brand.Dealer', win), {
        sortPreferred: getSortPreferred,
        isFullStateName: getIsFullStateName,
        updateDealer: updateDealer,
        updateSearchHints: updateSearchHints,
        getSearchHintData: getSearchHintData,
        appendT3QS: appendT3QS,
        getDealerConfig: getDealerConfig
    });
    
    var NON_ALPHA_REGEX = /[^A-Za-z0-9]/g;
    
    function getSortPreferred(dealers) {
        var preferredDealers = [];
        var unpreferredDealers = [];
        _.each(dealers, function eachDealer(dealer) {
            if (dealer.isPreferred) {
                preferredDealers.push(dealer);
            }
            else {
                unpreferredDealers.push(dealer);
            }
        });

        return preferredDealers.concat(unpreferredDealers);
    }
    
    var fullStateNames = ['Alabama','Alaska','Arizona','Arkansas','California','Colorado','Connecticut','Delaware','District of Columbia','Florida','Georgia','Hawaii','Idaho','Illinois','Indiana','Iowa','Kansas','Kentucky','Louisiana','Maine','Maryland','Massachusetts','Michigan','Minnesota','Mississippi','Missouri','Montana','Nebraska','Nevada','New Hampshire','New Jersey','New Mexico','New York','North Carolina','North Dakota','Ohio','Oklahoma','Oregon','Pennsylvania','Rhode Island','South Carolina','South Dakota','Tennessee','Texas','Utah','Vermont','Virginia','Washington','West Virginia','Wisconsin','Wyoming'];
    var fullProvinceNames = ['Alberta','British Columbia','Manitoba','New Brunswick','Newfoundland and Labrador','Newfoundland','Labrador','Nova Scotia','Nunavut','Northwest Territories','Ontario','Prince Edward Island','Quebec','Saskatchewan','Yukon'];
    
    function getIsFullStateName(val) {
        if (ctx.region === 'CA') {
            for (var i = 0; i < fullProvinceNames.length; i ++) {
                var str = fullProvinceNames[i];
                if (str.toLowerCase() === val.toLowerCase()) {
                    return true;
                }
            }
        } else {
            for (var i = 0; i < fullStateNames.length; i ++) {
                var str = fullStateNames[i];
                if (str.toLowerCase() === val.toLowerCase()) {
                    return true;
                }
            }
        }
        return false;
    }
    
    function updateDealer(dealer, idx, salesOpenUntil, salesOpenAgain, preferredDealer, dealerPageLink, hoursDisplayType) {
        // convert service/sales open/close time format
        var dt = new Date();
        var dow = dt.getDay();
        var hour = dt.getHours();
        // only process our hours if we don't already have a 'SalesHoursDescription' - if we do, we've already processed this dealer.
        if(dealer.SalesHours && dealer.SalesHours.Day && !dealer.SalesHoursDescription) {
            _.each(dealer.SalesHours.Day, function(day, dayIdx) {
                if (dayIdx === dow && day.open && hour < day.open.split(':')[0]) {
                    dealer.SalesHoursDescription = salesOpenAgain + ' ' + convertTime(day.open, hoursDisplayType);
                } else if(dayIdx === dow && day.close && hour < day.close.split(':')[0]) {
                    dealer.SalesHoursDescription = salesOpenUntil + ' ' + convertTime(day.close, hoursDisplayType);
                } else if (dayIdx === dow && day.close && hour >= day.close.split(':')[0]) {
                    dealer.SalesHoursDescription = salesOpenAgain + ' ' + findNextOpen(dealer.SalesHours.Day, (dayIdx + 1), hoursDisplayType);
                } else if (dayIdx === dow && day.closed) {
                    dealer.SalesHoursDescription = salesOpenAgain + ' ' + findNextOpen(dealer.SalesHours.Day, (dayIdx + 1), hoursDisplayType);
                }
                day.open = convertTime(day.open, hoursDisplayType);
                day.close = convertTime(day.close, hoursDisplayType);
            });
        }
        // need to convert service hours as well
        if(dealer.ServiceHours && dealer.ServiceHours.Day) {
            _.each(dealer.ServiceHours.Day, function(day, dayIdx) {
                day.open = convertTime(day.open, hoursDisplayType);
                day.close = convertTime(day.close, hoursDisplayType);
            });
        }
        // figure out if we're a preferred dealer and set a flag.
        if (preferredDealer != null && dealer.PACode && dealer.PACode === preferredDealer.PACode) {
            dealer.isPreferred = true;
        } else {
            dealer.isPreferred = false;
        }
        if (dealerPageLink != null) {
            var ext = (window.location.pathname.indexOf('.html') > 0) ? '.html' : '';
            dealer.DeepLinkUrl = [
                dealerPageLink,
                dealer.urlKey,
                ext
            ].join('');
            dealer.ReviewsDeepLinkUrl = [
                dealerPageLink,
                dealer.urlKey,
                '/reviews',
                ext
            ].join('');
        }
        if(dealer.PACode && dealer.Address && dealer.Address.PostalCode) {
            var street = [dealer.Address.Street1];
            if (dealer.Address.Street2) {
                street.push(dealer.Address.Street2);
            }
            if (dealer.Address.Street3) {
                street.push(dealer.Address.Street3);
            }
            dealer.AddressStreet = street.join(', ');
            dealer.AddressCityStateZip = dealer.Address.City + ', ' + (dealer.Address.Province || dealer.Address.State) + ' ' + dealer.Address.PostalCode;
            dealer.MobileMapUrl = 'http://maps.apple.com/?daddr=' + dealer.AddressStreet + ' ' + dealer.AddressCityStateZip;
        }
        if(dealer.textnumber) {
            dealer.TextUrl = dealer.textnumber.replace(/^\(/, '').replace(/\)\s?/, ' ').replace(/\s/g, '').replace('-', '');
        }
        // if 'mt-attr-val' cookie exists add the appropriate param value to the dealer data
        var mtAttrValCookieVal = util.cookie.get('mt-attr-val'),
            currentQSObj = util.parameters.decode(window.location.search),
            fdGuidCurrentQSVal = currentQSObj['fdguid'];
            
        if (mtAttrValCookieVal != null && typeof mtAttrValCookieVal !== 'undefined') {
            dealer.mtAttrQS = 'fdguid=' + mtAttrValCookieVal;
        } else if (fdGuidCurrentQSVal != null && typeof fdGuidCurrentQSVal !== 'undefined') {
            dealer.mtAttrQS = 'fdguid=' + fdGuidCurrentQSVal;
        } else {
            dealer.mtAttrQS = null;
        }
        
        //dealer.mtAttrQS = (mtAttrValCookieVal) ? 'fdguid=' + mtAttrValCookieVal : null;
        if(ctx.make === 'Lincoln') {
            // normalize combined ratings using Lincoln values if they exist
            if (dealer.l_cmb_rate_ct && dealer.l_cmb_rate_ct > 0) {
                dealer.combinedRating = dealer.l_cmb_rate;
                dealer.combinedRatingsPercentage = generateRatingsPercentage(dealer.l_cmb_rate);
                dealer.combinedRatingsCount = dealer.l_cmb_rate_ct;
            }
            // normalize sales ratings using Lincoln values if they exist
            if (dealer.l_sls_rate_ct && dealer.l_sls_rate_ct > 0) {
                dealer.salesRating = dealer.l_sls_rate;
                dealer.salesRatingsPercentage = generateRatingsPercentage(dealer.l_sls_rate);
                dealer.salesRatingsCount = dealer.l_sls_rate_ct;
            }
            // normalize service ratings using Lincoln values if they exist
            if (dealer.l_svc_rate_ct && dealer.l_svc_rate_ct > 0) {
                dealer.serviceRating = dealer.l_svc_rate;
                dealer.serviceRatingsPercentage = generateRatingsPercentage(dealer.l_svc_rate);
                dealer.serviceRatingsCount = dealer.l_svc_rate_ct;
            }
        } else {
            // normalize combined ratings using Ford values
            if (dealer.f_cmb_rate_ct && dealer.f_cmb_rate_ct > 0) {
                dealer.combinedRating = dealer.f_cmb_rate;
                dealer.combinedRatingsPercentage = generateRatingsPercentage(dealer.f_cmb_rate);
                dealer.combinedRatingsCount = dealer.f_cmb_rate_ct;
            }
            // normalize sales ratings using Ford values if they exist
            if (dealer.f_sls_rate_ct && dealer.f_sls_rate_ct > 0) {
                dealer.salesRating = dealer.f_sls_rate;
                dealer.salesRatingsPercentage = generateRatingsPercentage(dealer.f_sls_rate);
                dealer.salesRatingsCount = dealer.f_sls_rate_ct;
            }
            // normalize service ratings using Ford values if they exist
            if (dealer.f_svc_rate_ct && dealer.f_svc_rate_ct > 0) {
                dealer.serviceRating = dealer.f_svc_rate;
                dealer.serviceRatingsPercentage = generateRatingsPercentage(dealer.f_svc_rate);
                dealer.serviceRatingsCount = dealer.f_svc_rate_ct;
            }
        }
        dealer.index = idx;
        return dealer;
    }
    
    function generateRatingsPercentage(decimalValue) {
        var ratingsPercentage = (decimalValue / 5) * 100;
        return ratingsPercentage + '%';
    }
    
    function findNextOpen(days, index, hoursDisplayType) {
        var nextOpen = undefined;
        var totalIterations = 0;
        while (nextOpen === undefined) {
            if (index > days.length) index = 0;
            var day = days[index];
            if (day != undefined && day.open) {
                if (day.open.indexOf('AM') > 0 || hoursDisplayType == '24') {
                    nextOpen = day.open + " " + day.name;
                } else {
                    nextOpen = convertTime24to12(day.open) + " " + day.name;
                }
                break;
            }
            index ++;
            totalIterations ++;
            if (totalIterations >= 7) break;
        }
        return nextOpen;
    }
    
    function convertTime(time, hoursDisplayType) {
        if(hoursDisplayType == '12') {
            return convertTime24to12(time);
        } else {
            return convertTime24(time);
        }
    }
    
    function convertTime24to12(time) {
        // if we have 'AM' or 'PM' in our time value, we've already been converted.
        if(time && time.indexOf('AM') < 0 && time.indexOf('PM') < 0) {
            var arTime = time.split(':');
            if (arTime.length == 2) {
                var hour = parseInt(arTime[0], 10);
                var amPM = 'AM';
                if (hour === 0 || hour > 12) {
                    hour = (hour === 0) ? 12 : hour - 12;
                    amPM = 'PM';
                } else if (hour === 12) {
                    amPM = 'PM';
                }
                time = hour + ':' + arTime[1] + amPM;
            }
        }
        return time;
    }
    
    function convertTime24(time) {
        // if we have 'h' in our time value, we've already been converted
        if (time && time.indexOf('h') < 0) {
            var arTime = time.split(':');
            if (arTime.length < 2) {
                time = arTime[0] + 'h00';
            } else {
                time = arTime[0] + 'h' + arTime[1];
            }
        }
        return time;
    }

    /**
     * Retrieve the typeAhead results directly without handling the display logic.
     * @param data - object that includes the following properties:
     *      -val: the value that should be passed to the typeAhead service.
     *      -isDealer: boolean to indicate whether a dealerName or location search is being performed.
     * @param maxCount - the maximum number of results that should be returned. Default: 5.
     * @param includeDistance - boolean indicating whether the distance based on the users current coordinates should be determined or not.
     */
    function getSearchHintData(data, maxCount, includeDistance) {
        var def = $.Deferred(),
            cCoords = {},
            maxResultCount = maxCount || 5,
            includeDist = includeDistance || false;
        if(includeDist && util && util.env.geoLocation()) {
            cCoords = user.location.coordinates();
        }

        if(!data.isDealer) {
            // search by location
            // Note, maxResults is limited to 20 below because thats the maximum that the BING location API will allow.
            // reference: https://docs.microsoft.com/en-us/bingmaps/rest-services/locations/find-a-location-by-query
            $.ajax({
                url: ctx.settings.mapSearch,
                dataType: 'jsonp',
                data: {
                    q: data.val,
                    maxResults: Math.min(maxResultCount, 20),
                    key: ctx.settings.mapKey
                },
                jsonp: 'jsonp',
                cache: true
            }).done(function(resp) {
                var locations,
                    results = [];
                if (resp.statusCode === 200 &&
                    resp.resourceSets &&
                    resp.resourceSets.length &&
                    (locations = resp.resourceSets[0]) &&
                    (locations = locations.resources)) {

                    locations = _.filter(locations, {
                        address: {
                            countryRegionIso2: ctx.region
                        }
                    });

                    _.each(locations.slice(0, Math.min(locations.length, maxResultCount)), function(item) {
                        var hasCoordinates = (item.point && item.point.coordinates && item.point.coordinates.length),
                            resItem = {
                                name: item.name || '',
                                paCode: null,
                                location: {
                                    lat: (hasCoordinates) ? item.point.coordinates[0] : 1,
                                    lon: (hasCoordinates) ? item.point.coordinates[1] : 1
                                },
                                distance: {},
                                hasDistance: false
                            };

                        if(includeDist && !_.isEmpty(cCoords)) {
                            var dist = util.distance.betweenCoords(cCoords.lat, cCoords.lon, resItem.location.lat, resItem.location.lon, true);
                            resItem.distance = _.extend(resItem.distance, dist);
                            resItem.hasDistance = (!_.isEmpty(resItem.distance));
                        }
                        results.push(resItem);
                    });
                }
                def.resolve(results);
            }).fail(function(resp) {
                def.resolve([]);
            });
        } else {
            // search by dealer name
            var locateDealerServiceURI = '/search/JSONTypeAheadServlet.do';
            var Di = 8398;
            if (ctx.make === 'Lincoln' && ctx.region === 'CA') {
                locateDealerServiceURI = '/search-lincolnfoc/JSONTypeAheadServlet.do';
                Di = 8415;
            } else if (ctx.make === 'Lincoln' && ctx.region === 'US') {
                locateDealerServiceURI = '/search-lincoln/JSONTypeAheadServlet.do';
                Di = 8383;
            } else if (ctx.make === 'Ford' && ctx.region === 'CA') {
                locateDealerServiceURI = '/search-fordfoc/JSONTypeAheadServlet.do';
                Di = 8440;
            }
            $.ajax({
                url: ctx.settings.ngpServiceUrl + locateDealerServiceURI,
                data: {
                    api_key: ctx.settings.ngpApiKey,
                    N: 0,
                    Dk: 10,
                    Dx: 'rel static(rank,descend)',
                    Dn: 0,
                    Di: Di,
                    D: data.val + '*'
                },
                callback: 'JSON_CALLBACK',
                method: 'GET',
                responseType: 'json',
                cache: true,
                timeout: 5000
            }).done(function(resp) {
                var locations,
                    results = [];
                if (resp.DimensionSearch &&
                    resp.DimensionSearch.length &&
                    (locations = resp.DimensionSearch[0].Locations) &&
                    locations.length) {

                    results = _.map(_.pluck(_.flatten(_.pluck(locations.slice(0, Math.min(locations.length, maxResultCount)), 'Location')), 'DimValueName'), function (location) {
                        var locationParts = location.split('+');
                        var resItem = {
                            paCode: (locationParts[0]) ? locationParts[0] : '',
                            name: (locationParts[1]) ? locationParts[1] : '',
                            location: {
                                city: locationParts[2],
                                state: locationParts[3],
                                lat: (locationParts[4]) ? parseFloat(locationParts[4]) : 1,
                                lon: (locationParts[5]) ? parseFloat(locationParts[5]) : 1
                            },
                            distance: {},
                            hasDistance: false
                        };

                        if(includeDist && !_.isEmpty(cCoords)) {
                            var dist = util.distance.betweenCoords(cCoords.lat, cCoords.lon, resItem.location.lat, resItem.location.lon, true);
                            resItem.distance = _.extend(resItem.distance, dist);
                            resItem.hasDistance = (!_.isEmpty(resItem.distance));
                        }
                        return resItem;
                    });
                }
                def.resolve(results);
            }).fail(function(resp) {
                def.resolve([]);
            });
        }
        return def.promise();
    }

    // NZ: The updateSearchHints function should be updated to use the new getSearchHintData function to retrieve the typeAhead
    // data at some point so the logic isn't duplicated. I'm leaving it as is for now though to prevent the need for retesting.
    function updateSearchHints($cnt, srch, $input, $alertCnt, clear) {
        //var $cnt = componentElement(this, '.type-ahead-results');
        var $lst = $cnt.find('ul');
        var $alert = ($alertCnt && typeof($alertCnt) != 'undefined' && $alertCnt.length > 0) ? $alertCnt : $cnt.find('.search-suggestions-info');
        //var srch = getSearchData.call(this);
        var def = $.Deferred();
        $cnt.hide();
        $lst.empty();
        if (clear || !/^[a-z]{2,}/i.test(srch.val)) {
            toggleMarkup([]);
            return;
        }
        var util = FD.Brand && FD.Brand.Util,
            cCoords = {};
        if(util && util.env.geoLocation()) {
            cCoords = user.location.coordinates();
        }

        if(!srch.isDealer) {
            // search by location
            $.ajax({
                url: ctx.settings.mapSearch,
                dataType: 'jsonp',
                data: {
                    q: srch.val,
                    key: ctx.settings.mapKey
                },
                jsonp: 'jsonp',
                cache: true
            }).done(function(resp) {
                var locations,
                    results = [];
                if (resp.statusCode === 200 &&
                        resp.resourceSets &&
                        resp.resourceSets.length &&
                        (locations = resp.resourceSets[0]) &&
                        (locations = locations.resources)) {
                    locations = _.filter(locations, {
                        address: {
                            countryRegionIso2: ctx.region
                        }
                    });

                    _.each(locations.slice(0, Math.min(locations.length, 5)), function(item) {
                        var hasCoordinates = (item.point && item.point.coordinates && item.point.coordinates.length),
                            resItem = {
                                name: item.name || '',
                                paCode: null,
                                location: {
                                    lat: (hasCoordinates) ? item.point.coordinates[0] : 1,
                                    lon: (hasCoordinates) ? item.point.coordinates[1] : 1
                                },
                                distance: {}
                            };

                        if(!_.isEmpty(cCoords)) {
                            var dist = util.distance.betweenCoords(cCoords.lat, cCoords.lon, resItem.location.lat, resItem.location.lon, true);
                            resItem.distance = _.extend(resItem.distance, dist);
                        }

                        results.push(resItem);
                    });
                    //results = _.uniq(_.pluck(locations.slice(0, Math.min(locations.length, 5)), 'name'));
                }
                def.resolve(results);
            })
        } else {
            // search by dealer name
            var locateDealerServiceURI = '/search/JSONTypeAheadServlet.do';
            var Di = 8398;
            if (ctx.make === 'Lincoln' && ctx.region === 'CA') {
                locateDealerServiceURI = '/search-lincolnfoc/JSONTypeAheadServlet.do';
                Di = 8415;
            } else if (ctx.make === 'Lincoln' && ctx.region === 'US') {
                locateDealerServiceURI = '/search-lincoln/JSONTypeAheadServlet.do';
                Di = 8383;
            } else if (ctx.make === 'Ford' && ctx.region === 'CA') {
                locateDealerServiceURI = '/search-fordfoc/JSONTypeAheadServlet.do';
                Di = 8440;
            }
            $.ajax({
                url: ctx.settings.ngpServiceUrl + locateDealerServiceURI,
                data: {
                    api_key: ctx.settings.ngpApiKey,
                    N: 0,
                    Dk: 10,
                    Dx: 'rel static(rank,descend)',
                    Dn: 0,
                    Di: Di,
                    D: srch.val + '*'
                },
                callback: 'JSON_CALLBACK',
                method: 'GET',
                responseType: 'json',
                cache: true,
                timeout: 5000
            }).done(function(resp) {
                var locations,
                    results = [];
                if (resp.DimensionSearch &&
                        resp.DimensionSearch.length &&
                        (locations = resp.DimensionSearch[0].Locations) &&
                        locations.length) {
                    results = def.resolve(_.map(_.pluck(_.flatten(_.pluck(locations.slice(0, Math.min(locations.length, 5)), 'Location')), 'DimValueName'), function (location) {
                        var locationParts = location.split('+');
                        var resItem = {
                            paCode: (locationParts[0]) ? locationParts[0] : '',
                            name: (locationParts[1]) ? locationParts[1] : '',
                            location: {
                                city: locationParts[2],
                                state: locationParts[3],
                                lat: (locationParts[4]) ? parseFloat(locationParts[4]) : 1,
                                lon: (locationParts[5]) ? parseFloat(locationParts[5]) : 1
                            },
                            distance: {}
                        };
                        console.log(location);
                        console.log(resItem);

                        if(!_.isEmpty(cCoords)) {
                            var dist = util.distance.betweenCoords(cCoords.lat, cCoords.lon, resItem.location.lat, resItem.location.lon, true);
                            resItem.distance = _.extend(resItem.distance, dist);
                        }
                        return resItem;
                        //return location.split('+')[0];
                    }));
                }
                def.resolve(results);
            });
        }
        def.promise().done(function(results) {
            toggleMarkup(results);
            $lst.empty();
            var index = 0;
            var distUnit = (ctx.region === 'CA') ? 'km' : 'mi';
            _.each(results, function(result) {
                $('<li id="fgx-brand-dealerSearchSuggestion' + index + '" class="result" tabindex="-1" role="option" aria-selected="false" data-fgx-keypress="true" data-pacode="' + result.paCode + '"><span><span class="result-name">' + result.name + '</span><span class="result-meta-wrap"><span class="result-location">' + ((result.location && result.location.city) ? ' (' +result.location.city + ', ' + result.location.state + ')' : '')  + '</span><span class="result-distance">' + ((!_.isEmpty(result.distance)) ? result.distance[distUnit] : '') + '</span></span></li>').appendTo($lst);
                index ++;
            });
            $cnt.toggle(results.length > 0);
            $input.toggleClass('fgx-list-shown', (results.length > 0));//BRAND-12331
            if (results.length <= 0) {
                $input.removeAttr('aria-activedescendant');
            }
            if (typeof $alert !== 'undefined' && results.length > 0) {
                // set alert text
                var templateTxt = $alert.data('label-template');
                if (templateTxt) {
                    $alert.text(templateTxt.replace('{count}', results.length));
                }
            } else if (typeof $alert !== 'undefined' && results.length <= 0) {
                $alert.text('');
            }
            $lst.find(".result").on('focusin', function(){
                $lst.find(".result").attr('aria-selected', 'false');
                $(this).attr('aria-selected', 'true');
                $input.attr('aria-activedescendant', $(this).attr('id'));
            }).on('keydown', function(ev){
                if (ev.shiftKey && ev.which === 9) { 
                  //shift was down when tab was pressed...so refocus on the search input
                  $input.focus();
                  return false;
                } else if (ev.which === 27) {
                    //escape key was pressed...so refocus on the search input
                    $input.focus();
                    $cnt.hide();
                    $alert.text('');
                    $input.removeClass('fgx-list-shown');//BRAND-12331
                    $input.removeAttr('aria-activedescendant');
                    return false;
                }
            });
        });
    }

    function toggleMarkup(results) {// NGBS3-10835
        // .search-container needs set height on mobile map view for viewport height calculation and scrolling,
        // therefore cant expand .search-container to contain .advanced-search, so hide advanced search cta when there are type ahead results
        if(FD.Brand.Util.currentBreakpoint() === 'gux-bkpt-sm' && $(".dealer-standard.expanded").length){ //mobile and map view
            $("p.advanced").toggle(!(results.length > 0));
        }
    }

    function appendT3QS(url, mtAttrQS) {
        var output = '',
            qs = '',
            t3QueryString = ctx.t3DealerQueryString || '';
        //Append the T3 query string to qs if available and remove '?' if present
        if(!_.isEmpty(t3QueryString)) {
            if(t3QueryString.indexOf('?') > -1) {
                qs += t3QueryString.substring((t3QueryString.indexOf('?') + 1), t3QueryString.length);
            } else {
                qs += t3QueryString;
            }
        }
        // if a 'mt-attr-val' cookie is present, we will have a Query String value added to our dealer object, add it to qs
        if (mtAttrQS) {
            if (!_.isEmpty(qs)) {
                qs += '&';
            }
            qs += mtAttrQS;
        }
        // if qs is not empty, decode our params and add them to our URL, otherwise, leave the url as is.
        if(typeof(qs) != 'undefined' && qs !== '') {
            var _url = util.url.urlObject(url),
                param = util.parameters.decode(qs);
            _url.qs.add(param);
            output = _url.url();
        } else {
            output = url;
        }
        return output;
    }

    function getDealerConfig() {
        var cfg = brand.Component && brand.Component.locateDealerConfig || {};
        if (cfg) {
            var exitOvrs = brand.Link && brand.Link.exitOverlays,
                exitOvrId = cfg.exitOverlayId || '';
            cfg.hasExitOverlay = !!(exitOvrId && exitOvrs && typeof(exitOvrs[exitOvrId]) != 'undefined');
            cfg.exitOverlayCls = (cfg.hasExitOverlay) ? 'fgx-external-url-trigger' : '';
        }
        return cfg;
    }
    
})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context, FD.Brand.User, FD.Brand.Util);
/*global FD*/
/**
 * Search Inventory Services support library
 */
(function(win, $, _, ctx, util) {
    var settings = ctx.settings;

    // setup namespace
    _.extend(FD.Brand.namespace('FD.Brand.Inventory', win), {
        dealerLot: function(prm) {
            return serviceCall('/dealer-lot', prm);
        }
    });

    function serviceCall(method, prm, fn, skipCheck, fullPath) {
        return $.Deferred(function (defer) {
            var path = (fullPath) ? method : '/aemservices/cache/inventory' + method;

            $.getJSON(path, prm).done(function(resp) {
                if(skipCheck || checkResponse(resp)) {
                    defer.resolve(fn ? fn(resp) : resp);
                } else {
                    defer.reject();
                }
            }).fail(function(resp) {
                util.log(method + ' failed', resp);
                defer.reject(resp);
            });
        }).promise();
    }

    function checkResponse(resp) {
        if(resp) {
            if(resp.status === 'success') {
                return true;
            } else {
                util.log('inventoryLib::Service call failed [' + resp.status + '] ' + resp.errorMessage);
            }
        } else {
            util.log('inventoryLib::Service call failed - No response');
        }
        return false;
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand.Context, FD.Brand.Util);
;(function($, brand) {

    brand.setInitHandler('[data-fgx-you-might-also-like]', init);

    /////////////

    function init(components) {

        var brand = window.FD.Brand;
        
        brand.Dig.resolve(components);
        
        var mqlPhone = window.matchMedia('(max-width: 767px)'),
            mqlTablet = window.matchMedia('(max-width: 992px)'),
            mqlDesktop = window.matchMedia('(max-width: 1440px)');

        $(window).resize(function(){
            handleResize();
        });

        handleResize();
        
        $('.two-column-carousel', components).each(function() {
            FD.Brand.Util.carousel.swipe(this, function(el, dir) {
                swipe(el, '.two-column-carousel', dir);
            });
        });

        // populate pricing on initial location resolution and also if it changes.
        brand.User.location.subscribe(function() {
            components.each(function() {
                var _this = this;
                brand.Pricing.refresh(this, true).done(function(templates){
                    updateMonthlyPrice(_this);
                    applyPostalCodeClickAction(_this);
                });
            });
        });
        
        function updateMonthlyPrice(_this) {
            $('.make-info.monthly-price', _this).each(function() {
                var $el = $(this),
                    priceEl = $el.find('.pricing'),
                    txtVal = priceEl.text(),
                    infoEl = $el.find('.icon-info'),
                    priceDetail = priceEl.data('pricing');
                
                if (priceDetail && priceDetail.offerType) {
                    if ((priceDetail.offerType === 'lease' || priceDetail.offerType === 'finance' || (priceDetail.offerType === 'cash' && typeof priceEl.attr('data-pricing-template-cash') !== 'undefined')) && typeof txtVal !== 'undefined' && txtVal !== '') {
                        infoEl.attr('href', '#$spc').removeClass('hidden');
                        infoEl.removeAttr('aria-hidden');
                    }
                }
            });
        }
        
        function applyPostalCodeClickAction(_this) {
            var $pcEl = $('.ymal-zipcode-txt', _this);
            var pcMtxAction = $pcEl.attr('data-fd-metrics-zip-click');
            if (typeof pcMtxAction !== 'undefined') {
                $pcEl.find('a').attr('data-fd-metrics-click', pcMtxAction);
            }
        }
        
        function handleResize(){
            $('.two-column-carousel', components).each(function() {
                $(this).carousel({interval: false});
            });

            if(mqlPhone.matches){
                if (!$('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).addClass("slide");
            }
            else if (mqlTablet.matches) {
                if ($('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).removeClass("slide");
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.two-column-carousel', components).closest('.you-might-also-like'));
            }
            else if (mqlDesktop.matches) {
                if ($('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).removeClass("slide");
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.two-column-carousel', components).closest('.you-might-also-like'));
            }
        }
        
        function resetPaginationAriaLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.removeAttr('aria-live');
            pageInfo.removeAttr('aria-atomic');
            pageInfo.text('');
        }
        
        function updatePaginationAriaLabel($carousel, current, total) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, sibling class, direction
        function swipe(elm, sib, dir) {
            // only perform the swipe if the screen is smaller than 768px wide.
            if(mqlPhone.matches){
                $(elm).carousel(dir);
                $(elm).siblings(sib).carousel(dir);
                twoColUpdateIndicators(elm);
                // new metrics
                var mtxDirection = (dir === 'next') ? 'right' : 'left';
                FD.Brand.Metrics.handler.direct(
                    $(elm).attr('data-fd-metrics-scroll'), {
                        $$carouselScrollDirection: mtxDirection
                    }
                );
            }
        }

        //Update the active toggle indicator
        function twoColUpdateIndicators(elm) {
            var current = $(elm, components).find('.active').index();
            var newIdx = current;
            $(elm, components).siblings('.carousel-indicators').children().each(function() {
                $(this).removeClass('active');
                if(($(this).find('button').data('slideTo') * 1) !== current) {
                    $(this).addClass('active');
                    newIdx = $(this).find('button').data('slideTo') * 1;
                }
            });
            var $carousel = $(elm).closest('.you-might-also-like');
            // if our meatballs are showing we're on mobile, update our pagination aria label
            updatePaginationAriaLabel($carousel, (newIdx + 1), 2);
        }

        // activate a carousel slide when one of the indicators is clicked.
        $('.carousel-indicators li > button', components).click(function() {
            var goToId = parseInt($(this).data("slideTo"), 10);
            var $li = $(this).closest('li');

            if(!$li.hasClass('active')) {
                // new metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-scroll')
                );
            }

            $li.parent().siblings('.two-column-carousel').each(function() {
                $(this).carousel(goToId);
            });

            $li.siblings().removeClass("active");
            $li.addClass("active");
            var $carousel = $(this).closest('.you-might-also-like');
            // if our meatballs are showing we're on mobile, update our pagination aria label
            updatePaginationAriaLabel($carousel, (goToId + 1), 2);
        });
    }
    
})(jQuery, FD.Brand);
;(function($, _, win, brand, user, util, ctx){
    var components,
        baseTriggerTypeTemplates = {},
        _listSizeClasses = [
            'list-zero',
            'list-one',
            'list-two',
            'list-three'
        ],
        mql;

    brand.setInitHandler('[data-fgx-recently-viewed-vehicles]', init);

    function init(newComponents) {
        if(newComponents.length == 0) {
            return;
        }
        components = newComponents;
        mql = window.matchMedia('(min-width: 768px)');
        mql.addListener(handleResize);
        handleResize(mql);
        baseTriggerTypeTemplates = {
            baseModel: {
                pricingTemplate: '{pricingLabel} {price}',
                showIBall: false,
                pricingType: 'startingAt'
            },
            configuredModel: {
                pricingTemplate: '{pricingLabel} {price}',
                showIBall: true,
                pricingType: 'estimatedNet'
            }
        };


        user.fps.current().done(function(state) {
            if(!state.loaded) {
                util.log('FPS library not loaded');
                components.toggleClass('hidden', true);
                return;
            }

            FPS.RVV.getAllByGroups({ success: function(data) {
                var recentlyViewed = data[0].RVVAllGrouped;
                util.log('****RVV Data**** ', data[0]);
                if (recentlyViewed != undefined && recentlyViewed.length > 0) {
                    components.each(function() {
                        setupComponent(this, recentlyViewed);
                    });
                }
            }, error: function() {
                util.log("RVV - FPS RVV call failed.");
                components.toggleClass('hidden', true);
            } });
        });

        //Slide the carousel when the indicators are clicked
        $('.rv-models-container .carousel-indicators li', components).on('click', function(ev) {
            var $el = $(this);
            if ($el.hasClass('active')) {
                ev.stopPropagation();
                ev.preventDefault();
                return;
            }
            var goToId = $el.data("slideTo"),
                $carousel = $el.closest('.rv-models-container'),
                total = $carousel.find('.carousel-indicators li').not('.hidden').length;
            $carousel.carousel(goToId);
            updatePaginationAriaLabel($carousel, (goToId + 1), total);
        });
    }

    function setupComponent(el, rvData) {
        var $el = $(el),
            $modelsContainer = $el.find('.rv-models-container'),
            compData,
            markupTemplates = {},
            _promises = [],
            _vehicles = [];
        try {
            compData = JSON.parse($el.find('script[data-component-data]').text());
        } catch(err) {
            compData = {};
        }

        $el.find('script[data-fgx-recently-viewed-vehicles-template-id]').each(function(idx, tmpl) {
            var $tmpl = $(tmpl),
                id = $tmpl.attr('data-fgx-recently-viewed-vehicles-template-id') || '';
            if(id && !markupTemplates[id]) {
                markupTemplates[id] = _.template(tmpl.innerHTML);
            }
        });

        compData.$el = $el;
        compData.markupTemplates = _.assign({}, markupTemplates);
        compData.templateItems = $.extend(true, {}, compData.templateItems || {}, baseTriggerTypeTemplates);
        compData.pricingLabels = {
            startingAt: $.extend({}, compData.startingAtPriceLabel || {}),
            estimatedNet: $.extend({}, compData.estimatedNetPriceLabel || {})
        };
        util.carousel.swipe($modelsContainer[0], swipe);

        for (var i = 0; i < rvData.length; i ++) {
            if (i == 3) break;
            // BRAND-15880: try to retrieve the displayName and displayNameShort values from VDM for a given
            // vehicle before calling the setupRvItem function for that vehicle.
            var createRvItemPromise = function(rvItem, idx) {
                var vehData = {
                    model: rvItem._nameplate || '',
                    year: rvItem._year || '',
                    trim: rvItem._trim || ''
                };

                var promise = util.vdm.displayName(vehData);
                promise.then(function(respData) {
                    rvItem.displayName = respData.displayName || '';
                    rvItem.displayNameShort = respData.displayNameShort || '';
                    _vehicles[idx] = setupRvItem(rvItem, idx, compData);
                });
                return promise;
            };
            var rvItem = rvData[i];
            if (rvItem.returnURL && rvItem._nameplate) {
                var promise = createRvItemPromise(rvItem, i);
                _promises.push(promise);
            }
        }

        // BRAND-15880: wait for all the promises to be resolved (i.e. wait for setupRvItem to be called for
        // each vehicle) before finishing the rest of the setup for this component.
        $.when.apply($, _promises).done(function() {
            renderVehicleItems(_vehicles, compData);
        });

    }

    function setupRvItem(rvItem, index, compData) {
        var data = {
            isValid: false,
            idx: index,
            modelClass: 'model_' + index,
            infoIconText: getValForKey(compData, 'infoIconLinkText'),
            priceDetailHeadline: getValForKey(compData, 'priceDetailHeadline'),
            imageErrorHeadline: getValForKey(compData, 'imageErrorHeadline'),
            imageErrorDescription: getValForKey(compData, 'imageErrorDescription'),
            vinPrefixLabel: getValForKey(compData, 'vinPrefixText'),
            infoIconClickAction: compData.iballClickAction,
            subheadlineHTag: getValForKey(compData, 'subheadlineHTag')
        };
        var suffixData = _.find(compData.triggerTypeItems || [], {'suffix': rvItem.suffix || ''});
        if (!suffixData || $.isEmptyObject(suffixData)) {
            util.log("RVV::setupRvItem - error - suffixData is either not defined or empty. ", data);
            return data;
        }
        var templateData = compData.templateItems && compData.templateItems[suffixData && suffixData.templateKey || 'baseModel'] || {};
        data.isValid = true;
        data = $.extend(true, {}, data, templateData, suffixData, rvItem);
        data.vin = '';
        var pricingContext = {
            year: data._year,
            model: data._nameplate,
            paymentType: 'buy'
        };
        var linkContext = {
            year: data._year,
            model: data._nameplate
        };
        var defaultTitleTmpl = '{displayName}';
        var displayName = '<span class="rv-model-name">' + (data.displayName || '') + '</span>';
        var replacementStr = '';
        data.url = data.returnURL || '';
        data.digImage = ctx.settings.digUrl + '/' + encUriSegment(data._brand, true) + '/' + encUriSegment(data._nameplate, true) + '/' + encUriSegment(data._year, true) + '/HD-TILE/Hero/EXT/' + (data.digAngle || '5') + '/vehicle.png';
        data.strPricingLabelList = JSON.stringify(compData.pricingLabels[data.pricingType] || {});

        if (data.templateKey === 'configuredModel' && data._UID) {
            // check if the _UID is a Config Token or a VIN
            if (data._UID.indexOf('Config[') > -1) {
                replacementStr = '/' + encUriSegment(data._UID, true) + '/';
                pricingContext.configToken = data._UID;
            } else {
                replacementStr = '/' + encodeURIComponent('Vin[' + decodeURIComponent(data._UID) + ']') + '/';
                pricingContext.vin = data._UID;
                data.vin = data._UID;
                if (data._PAcode) {
                    pricingContext.dealerPACode = data._PAcode;
                }
            }
            if (data._trim) {
                linkContext.trimId = data._trim;
            }
        } else if (data._trim || data.blackLabelVehicle) {
            var digTrimVal = (data.blackLabelVehicle) ? 'Black Label' : data._trim;
            replacementStr = '/' + encodeURIComponent('Hero[' + decodeURIComponent(digTrimVal) + ']') + '/';
            if (data._trim) {
                pricingContext.trimId = data._trim;
                linkContext.trimId = data._trim;
            }
        }

        if (replacementStr) {
            data.digImage = data.digImage.replace('/Hero/', replacementStr);
        }

        if (data.url && data.campaignCode) {
            var campaign = data.campaignCode.replace('{nameplate}', data._nameplate.toLowerCase());
            var campaignObj = util.str.toObject(campaign);
            var urlObj = util.url.urlObject(data.url);
            urlObj.qs.add(campaignObj);
            data.url = urlObj.url();
        }

        data.ctaOneItem = createCtaItem(data.ctaOneDisplay, data.ctaOneText, data.url, data.ctaOneAriaLabel, data.ctaOneBtnType);
        data.ctaTwoItem = createCtaItem(data.ctaTwoDisplay, data.ctaTwoText, data.ctaTwoLink, data.ctaTwoAriaLabel, data.ctaTwoBtnType, data.ctaTwoClickAction_ma);
        data.strLinkContext = JSON.stringify(linkContext);
        data.strPricingContext = JSON.stringify(pricingContext);
        data.title = (data.title || defaultTitleTmpl).replace('{displayName}', displayName);
        data.showVin = !!(data.displayVin && data.vin);
        return data;
    }

    function renderVehicleItems(items, compData) {
        var itemCount = 0,
            $comp = compData && compData.$el,
            $container = $comp && $comp.find('.rv-models'),
            discLabelPrefix = (ctx.accessibility && ctx.accessibility.disclosureLabelPrefix) || '',
            hasVinShown = false;
        _.each(items, function(item, idx) {
            if (item && item.isValid) {
                var data = { vehicle: item },
                    _template = compData && compData.markupTemplates && compData.markupTemplates.vehicleItem,
                    $vehicleItem = $(_template(data));
                if ($vehicleItem && $vehicleItem.length) {
                    var $modelImg = $vehicleItem.find('.model-img');
                    var $img = $modelImg.find('img');
                    if(!($img.hasClass('lazyloaded') || $img.hasClass('lazyloading'))) {
                        $img.on('load', function (ev) {
                            $modelImg.find('.image-loader-svg').addClass('hidden');
                        });
                        $img.on('error', function() {
                            $img.addClass("hidden");
                            $modelImg.find('.image-loader-svg').addClass('hidden');
                            $modelImg.addClass('fgx-model-min-height');
                            $modelImg.find('.image-error-wrap').removeClass('hidden');
                        });
                    } else {
                        $modelImg.find('.image-loader-svg').addClass('hidden');
                    }
                    $container.append($vehicleItem);
                    if (item.showVin) {
                        hasVinShown = true;
                    }
                    itemCount++;
                }
            }
        });

        if (itemCount > 0) {
            var targetData = brand.getTargetCampaignData();
            if (targetData.initialized && win.appendCampaignCodesTarget) {
                win.appendCampaignCodesTarget($comp, targetData.campaignTargetKey, targetData.campaignTmpl, targetData.debug);
            }
            $('sup[data-vdm-disc]', $comp).each(function() {
                var $el = $(this),
                    discLabel = discLabelPrefix + ' ' + $el.text();
                $el.attr({
                    'tabindex': '0',
                    'role': 'button',
                    'data-fgx-keypress': 'true',
                    'aria-label': discLabel
                });
            });

            if (itemCount > 1) {
                $('.carousel-indicators li', $comp).each(function(idx) {
                    if (idx >= itemCount) {
                        return false;
                    }
                    $(this).removeClass('hidden');
                });
            }

            util.images.load($comp);
            $comp.find('.make-info.vin-container').toggleClass('hidden', !hasVinShown);
            $container.addClass(_listSizeClasses[itemCount] || '');
            $container.find('.rv-model.item').first().addClass('active');
            $comp.removeClass('hidden');

            brand.User.location.subscribe(function() {
                var _this = $comp[0];
                brand.Pricing.refresh(_this, true).done(function(templates){
                    handlePriceResponse(_this, compData);
                });
            });
        } else {
            $comp.toggleClass('hidden', true);
        }
    }

    function createCtaItem(_display, _label, _link, _ariaLabel, _btnType, _clickAction) {
        return {
            show: !!(_display && _label && _link),
            label: _label || '',
            link: _link || '',
            ariaLabel: _ariaLabel || '',
            btnType: _btnType,
            showIcon: !!(_btnType === 'btn-icon' || _btnType === 'btn-icon-light' || _btnType === 'btn-icon-light-alt'),
            ctaClass: (_btnType === 'btn-primary' || _btnType === 'btn-secondary' || _btnType === 'btn-secondary-alt') ? 'fgx-btn-md-width-100' : '',
            clickAction: _clickAction || '{ }'
        };
    }

    function encUriSegment(val, decodeFirst) {
        return encodeURIComponent(((decodeFirst) ? decodeURIComponent(val) : val));
    }

    function getValForKey(obj, key) {
        return obj && obj[key] || '';
    }

    function handlePriceResponse(el, compData) {
        var $comp = $(el),
            _template = compData && compData.markupTemplates && compData.markupTemplates.priceDetailFlyout;
        $comp.find('.make-info.price').each(function() {
            var $el = $(this),
                $priceEl = $el.find('.pricing'),
                $iballEl = $el.find('.icon-info'),
                $disclosureEl = $el.find('.disclosure');

            var handleError = function() {
                $priceEl.toggleClass('hidden', true);
                $disclosureEl.toggleClass('hidden', true);
                $iballEl.toggleClass('hidden', true);
            };

            if ($priceEl && $priceEl.length) {
                var priceDetail = $priceEl.data('pricing');
                if (priceDetail && priceDetail.pricingData && $iballEl && $iballEl.length > 0) {
                    var pricingData = brand.Pricing.formatPriceTipData(priceDetail);
                    if (pricingData && _template) {
                        try {
                            var priceTipData = { pricingData: pricingData || {} };
                            var $priceTipEl = $(_template(priceTipData)).data('pricingData', pricingData);
                            var $tipEl = $el.find('.price-tip');
                            $tipEl.data('price-tip-content', $priceTipEl.html());
                            $iballEl.removeClass('hidden');
                        } catch(err) {
                            handleError();
                        }
                    } else if (!pricingData || _.isEmpty(pricingData) || !pricingData.price || pricingData.price === '$0' || pricingData.price === '0 $') {
                        handleError();
                    }
                } else if ((!priceDetail || typeof(priceDetail) == 'undefined') || _.isEmpty(priceDetail) || (!priceDetail.price || priceDetail.price === '$0' || priceDetail.price === '0 $') || $priceEl.text() === '' || typeof($priceEl.text()) == 'undefined') {
                    handleError();
                }
            }
        });
    }

    //Callback function of the hammer swipe listeners.
    //pass in the element, direction
    function swipe(elm, dir, ev) {
        // only perform the swipe if the screen is smaller than 768px wide.
        if(!mql.matches){
            var $elm = $(elm),
                $modelsList = $elm.find(".rv-models");
            if(!$modelsList.hasClass("list-one")) {
                $elm.carousel(dir);

                // metrics
                var mtxDirection = (dir === 'next') ? 'right' : 'left',
                    scrollAction = $elm.attr('data-fd-metrics-scroll') || '';
                if (scrollAction) {
                    FD.Brand.Metrics.handler.direct(scrollAction, {
                            $$carouselScrollDirection: mtxDirection
                        }
                    );
                }
                // pagination aria label
                var current = parseInt($('.carousel-indicators li.active', $elm).attr('data-slide-to'));
                var total = $('.carousel-indicators li:visible', $carousel).length;
                updatePaginationAriaLabel($elm, (current + 1), total);
            }
        }
    }

    function resetPaginationAriaLabel($carousel) {
        var pageInfo = $carousel.find('.pagination-info');
        pageInfo.attr('aria-hidden', 'true');
        pageInfo.removeAttr('aria-live');
        pageInfo.removeAttr('aria-atomic');
        pageInfo.text('');
    }

    function updatePaginationAriaLabel($carousel, current, total) {
        var pageInfo = $carousel.find('.pagination-info');
        var pageInfoTemplate = pageInfo.data('label-template');
        pageInfo.attr('aria-hidden', 'false');
        pageInfo.attr('aria-live', 'polite');
        pageInfo.attr('aria-atomic', 'true');
        if(pageInfoTemplate) {
            pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
        }
    }

    function handleResize(mql) {
        components.each(function() {
            var $carousel = $(this).find('.rv-models-container.carousel');
            $carousel.carousel({interval: false});

            if (mql.matches) {
                if ($carousel.hasClass('slide')) {
                    $carousel.removeClass('slide');
                    // pagination aria label needs to be removed and marked as hidden
                    resetPaginationAriaLabel($carousel);
                }
            } else {
                $carousel.toggleClass('slide', true);
            }
        });
    }

})(jQuery, FD.Brand.lodash, window, FD.Brand, FD.Brand.User, FD.Brand.Util, FD.Brand.Context);
;(function($, _, win, brand, user, util, ctx){
    
    var components,
        templates = {},
        contextLabels,
        pricingEnabled,
        pricingTemplates,
        pricingLabelTypes,
        pricingDisclosures,
        pricingIBallToggles,
        pricingLabels = {
            startingAt: {},
            estimatedNet: {}
        },
        campaignCodes,
        mainLinkMetrics,
        imageLinkMetrics,
        ctaOneLabels,
        ctaOneMetrics,
        ctaTwoLabels,
        ctaTwoLinks,
        ctaTwoMetrics,
        digAngle;

    brand.setInitHandler('[data-fgx-recently-viewed]', init);

    function init(newComponents) {

        if(newComponents.length == 0) {
            return;
        }
        
        components = newComponents;

        if(!components.hasClass("bbLayout")) {
            var mql = window.matchMedia('(min-width: 768px)');
            mql.addListener(handleResize);

            handleResize(mql);

            $('.recently-viewed-carousel', components).each(function() {
                FD.Brand.Util.carousel.swipe(this, swipe);
            });
        }
        
        $('script[data-fgx-recently-viewed-template-id]').each(function(idx, tmpl) {
            var $tmpl = $(tmpl);
            templates[$tmpl.attr('data-fgx-recently-viewed-template-id')] = _.template(tmpl.innerHTML);
        });
        
        var modelsContainer = $('.rv-models-container', components);
        
        pricingEnabled = (modelsContainer.data('pricing-enabled') && (modelsContainer.data('pricing-enabled') === 'true' || modelsContainer.data('pricing-enabled') == true)) ? true : false;
        digAngle = (modelsContainer.data('digAngle') || '5');
        
        var contextLabelObj = modelsContainer.data('context-labels');
        contextLabels = {};
        initActivityMap(contextLabelObj, contextLabels);
        
        var pricingTemplateObj = modelsContainer.data('pricing-templates');
        pricingTemplates = {};
        initActivityMap(pricingTemplateObj, pricingTemplates);
        
        var pricingDisclosuresObj = modelsContainer.data('pricing-disclosures');
        pricingDisclosures = {};
        initActivityMap(pricingDisclosuresObj, pricingDisclosures);
        
        var pricingIBallTogglesObj = modelsContainer.data('pricing-iball-toggles');
        pricingIBallToggles = {};
        initActivityMap(pricingIBallTogglesObj, pricingIBallToggles);
        
        var campaignCodeObj = modelsContainer.data('campaign-codes');
        campaignCodes = {};
        initActivityMap(campaignCodeObj, campaignCodes);
        
        var mainLinkMetricsObj = modelsContainer.data('main-link-metrics');
        mainLinkMetrics = {};
        initActivityMap(mainLinkMetricsObj, mainLinkMetrics);
        
        var imageLinkMetricsObj = modelsContainer.data('image-link-metrics');
        imageLinkMetrics = {};
        initActivityMap(imageLinkMetricsObj, imageLinkMetrics);
        
        var ctaOneLabelsObj = modelsContainer.data('cta-one-labels');
        ctaOneLabels = {};
        initActivityMap(ctaOneLabelsObj, ctaOneLabels);
        
        var ctaOneMetricsObj = modelsContainer.data('cta-one-metrics');
        ctaOneMetrics = {};
        initActivityMap(ctaOneMetricsObj, ctaOneMetrics);
        
        var ctaTwoLabelsObj = modelsContainer.data('cta-two-labels');
        ctaTwoLabels = {};
        initActivityMap(ctaTwoLabelsObj, ctaTwoLabels);
        
        var ctaTwoLinksObj = modelsContainer.data('cta-two-links');
        ctaTwoLinks = {};
        initActivityMap(ctaTwoLinksObj, ctaTwoLinks);
        
        var ctaTwoMetricsObj = modelsContainer.data('cta-two-metrics');
        ctaTwoMetrics = {};
        initActivityMap(ctaTwoMetricsObj, ctaTwoMetrics);

        var pricingLabelTypesObj = modelsContainer.data('pricing-label-types');
        pricingLabelTypes = {};
        initActivityMap(pricingLabelTypesObj, pricingLabelTypes);

        // setup pricing label types
        setPricingLabelTypes(modelsContainer, 'starting-at-price-label', 'startingAt');
        setPricingLabelTypes(modelsContainer, 'estimated-net-price-label', 'estimatedNet');
        
        user.fps.current().done(function(state) {
           if(!state.loaded) {
            console.log('FPS library not loaded');
            return;
           }
           
           FPS.RVV.getAllByGroups({ success: function(data) {
               
               var recentlyViewed = data[0].RVVAllGrouped;
               
               console.log('****************');
               console.log(data[0]);
               
               if (recentlyViewed != undefined && recentlyViewed.length > 0) {
                    var _promises = [];
                    var $rvBBTitle = $('.rv-bb-title', components);
                    for (var i = 0; i < recentlyViewed.length; i ++) {
                        console.log('setup - index : ' + i);
                        if (i == 3) break;
                        // BRAND-15880: try to retrieve the displayName and displayNameShort values from VDM for a given
                        // vehicle before calling the setupRvItem function for that vehicle.
                        var createRvItemPromise = function(rvItem, idx) {
                            var vehData = {
                                model: rvItem._nameplate || '',
                                year: rvItem._year || '',
                                trim: rvItem._trim || ''
                            };

                            var promise = util.vdm.displayName(vehData);
                            promise.then(function(respData) {
                                rvItem.displayName = respData.displayName || '';
                                rvItem.displayNameShort = respData.displayNameShort || '';
                                setupRvItem(rvItem, idx);
                            });
                            return promise;
                        };
                        var rvItem = recentlyViewed[i];
                        if (!((i > 0 && $rvBBTitle.length) || !(rvItem.returnURL && rvItem._nameplate))) {
                            var promise = createRvItemPromise(rvItem, i);
                            _promises.push(promise);
                        }
                    }
                    // BRAND-15880: wait for all the promises to be resolved (i.e. wait for setupRvItem to be called for
                    // each vehicle) before finishing the rest of the setup for this component.
                    $.when.apply($, _promises).done(function() {
                        var $validItems = $('.rv-model.fgx-rvv-valid-item', components),
                            _itemsSize = $validItems && $validItems.length || 0;
                        if (_itemsSize > 0) {
                            var sizeClass = 'list-one';
                            if (_itemsSize > 1) {
                                sizeClass = (_itemsSize === 2) ? 'list-two' : 'list-three';
                                $('.carousel-indicators li', components).each(function(idx) {
                                    if (idx >= _itemsSize) {
                                        return false;
                                    }
                                    $(this).removeClass('hidden');
                                });
                            }
                            $('ul.rv-models', components).addClass(sizeClass);
                            $validItems.first().addClass('active');

                            util.images.load(components);
                            $('.rv-title').removeAttr('aria-hidden');

                            var discLabelPrefix = (ctx.accessibility && ctx.accessibility.disclosureLabelPrefix) || '';
                            $('sup[data-vdm-disc]', components).each(function(){
                                var $el = $(this),
                                    discLabel = discLabelPrefix + ' ' + $el.text();
                                $el.attr({
                                    'tabindex': '0',
                                    'role': 'button',
                                    'data-fgx-keypress': 'true',
                                    'aria-label': discLabel
                                });
                            });

                            components.show();
                            if (pricingEnabled) {
                                brand.User.location.subscribe(function() {
                                    components.each(function() {
                                        var _this = this;
                                        brand.Pricing.refresh(this, true).done(function(templates){
                                            updatePriceTip(_this);
                                        });
                                    });
                                });
                            }
                        }
                    });
               }
           }, error: function() {
               // ensure everything is hidden
               components.hide();
           } });
        });
        
        function initActivityMap(source, target) {
            for (var key in source) {
                if (key === 'pricingIncentives') {
                    // we need to assign this to three different activities
                    target['IOFeatured'] = source[key];
                    target['IOModelOffers'] = source[key];
                    target['IOAdditionalOffer'] = source[key];
                } else {
                    // all others only map to one...
                    target[key] = source[key];
                }
            }
        }

        function setPricingLabelTypes($el, labelTypeAttr, labelTypeKey) {
            if (!$el || $el.length === 0) {
                return;
            }

            var priceLabelsObj = $el.data(labelTypeAttr),
                priceLabels = (priceLabelsObj && typeof(priceLabelsObj) != 'undefined' && priceLabelsObj != 'null') ? priceLabelsObj : {};

            pricingLabels[labelTypeKey] = _.extend({}, pricingLabels[labelTypeKey], priceLabels);
        }
        
        function updatePriceTip(_this) {
            $('.make-info.price', _this).each(function() {
                var $el = $(this),
                    priceEl = $el.find('.pricing'),
                    infoEl = $el.find('.icon-info'),
                    disclosureEl = $el.find('.disclosure'),
                    priceDetail = priceEl.data('pricing');
                
                if (priceDetail && !infoEl.hasClass('hidden')) {
                    // only populate data if our info icon is showing...
                    var pricingData = brand.Pricing.formatPriceTipData(priceDetail);
                    var prm = { pricingData: pricingData };
                    // use our data to populate our content template
                    var $priceTipEl = $(templates.priceDetailFlyout(prm)).data('pricingData', pricingData);
                    var $rvvComponent = $el.closest('.recently-viewed');
                    var $liEl = $el.closest('li');
                    var tipId = 'fgx-recentlyViewed-priceDetail-';
                    if ($liEl.hasClass('model_0')) {
                        tipId += '0';
                    } else if ($liEl.hasClass('model_1')) {
                        tipId += '1';
                    } else if ($liEl.hasClass('model_2')) {
                        tipId += '2';
                    }
                    var $tipEl = $el.find('.price-tip');
                    // set up our price-tip link and populate content data attribute
                    infoEl.attr('href', '#price-tip=' + tipId);
                    $tipEl.data('price-tip-content', $priceTipEl.html());
                    
                    if (priceEl.text() === '' || typeof(priceEl.text()) == 'undefined') {
                        infoEl.hide();
                        disclosureEl.hide();
                    }
                    
                } else if ((!priceDetail || typeof(priceDetail) == 'undefined') || _.isEmpty(priceDetail) || (!priceDetail.price || priceDetail.price === '$0' || priceDetail.price === '0 $')) {
                    infoEl.hide();
                    disclosureEl.hide();
                    priceEl.hide();
                } else if (priceEl.text() === '' || typeof(priceEl.text()) == 'undefined') {
                    priceEl.hide();
                    infoEl.hide();
                    disclosureEl.hide();
                }
                
            });
        }

        function handleResize(mql) {
            $('.recently-viewed-carousel', components).each(function() {
                $(this).carousel({interval: false});
            });

            if(mql.matches){
                if ($('.recently-viewed-carousel', components).hasClass("slide")) { 
                    $('.recently-viewed-carousel', components).removeClass("slide");
                    // pagination aria label needs to be removed and marked as hidden
                    resetPaginationAriaLabel($('.recently-viewed-carousel', components).closest('.recently-viewed'));
                }
            }
            else {
                if (!$('.recently-viewed-carousel', components).hasClass("slide")) { $('.recently-viewed-carousel', components).addClass("slide"); }
            }
        }
        
        function resetPaginationAriaLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.removeAttr('aria-live');
            pageInfo.removeAttr('aria-atomic');
            pageInfo.text('');
        }
        
        function updatePaginationAriaLabel($carousel, current, total) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, direction
        function swipe(elm, dir, ev) {
            // only perform the swipe if the screen is smaller than 768px wide.
            if(!mql.matches){
                var $modelsList = $(elm).find(".rv-models");
                if(!$modelsList.hasClass("list-one")) {
                    $(elm).carousel(dir);

                    // new metrics
                    var mtxDirection = (dir === 'next') ? 'right' : 'left';
                    FD.Brand.Metrics.handler.direct(
                        $(elm).attr('data-fd-metrics-scroll'), {
                            $$carouselScrollDirection: mtxDirection
                        }
                    );
                    // pagination aria label
                    var $carousel = $(elm).closest('.recently-viewed');
                    var current = parseInt($('.carousel-indicators li.active', $carousel).attr('data-slide-to'));
                    var total = $('.carousel-indicators li:visible', $carousel).length;
                    updatePaginationAriaLabel($carousel, (current + 1), total);
                }
            }
        }

        //Slide the carousel when the indicators are clicked
        $('.recently-viewed-carousel .carousel-indicators li', components).click(function() {
            var goToId = $(this).data("slideTo");

            if(!$(this).hasClass('active')) {
                // new metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-scroll')
                );
            }
            
            var $component = $(this).closest('.recently-viewed');
            var $ol = $(this).parent();
            var total = $ol.find('li').length;

            $(this).closest('.recently-viewed-carousel').carousel(goToId);
            updatePaginationAriaLabel($component, (goToId + 1), total);
        });
    }

    //Method to determine if an image was loaded successfully. Sourced from: https://stackoverflow.com/questions/9815762/detect-when-an-image-fails-to-load-in-javascript
    function testImage(url) {
        var imgPromise = new Promise(function imgPromise(resolve, reject) {
            var imgElement = new Image();

            imgElement.addEventListener('load', function imgOnLoad() {
                resolve(this);
            });

            imgElement.addEventListener('error', function imgOnError() {
                reject();
            });

            imgElement.src = url;
        });
        return imgPromise;
    }
    
    function setupRvItem(rvItem, index) {
        var $rvBBTitle = $('.rv-bb-title', components);
        if ((index > 0 && $rvBBTitle.length) || !(rvItem.returnURL && rvItem._nameplate)) {
            // if we're in billboard layout we don't need to initialize items 2 and 3.
            // OR if either the returnURL or _nameplate isn't defined for an item, then we don't need to initialize it either (BRAND-15145).
            return;
        }
        var pricingContext = {
            year: rvItem._year,
            model: rvItem._nameplate
        };
        var linkContext = {
            year: rvItem._year,
            model: rvItem._nameplate
        }
        var url = rvItem.returnURL;
        var digImgUrl = FD.Brand.Context.settings.digUrl + '/' + encodeURIComponent(decodeURIComponent(rvItem._brand)) + '/' + encodeURIComponent(decodeURIComponent(rvItem._nameplate)) + '/' + encodeURIComponent(decodeURIComponent(rvItem._year)) + '/HD-TILE/Hero/EXT/' + digAngle + '/vehicle.png';
        var displayName = '<span class="rv-model-name">' + (rvItem.displayName || '') + '</span>';
        var isBlackLabel = (rvItem.suffix === 'ViewPageBlackLabel' || rvItem.suffix === 'ViewModelDetailBlackLabel');
        if (rvItem._UID) {
            // check if the _UID is a Config Token or a VIN
            if (rvItem._UID.indexOf('Config[') > -1) {
                var replacementStr = '/' + encodeURIComponent(decodeURIComponent(rvItem._UID)) + '/';
                digImgUrl = digImgUrl.replace('/Hero/', replacementStr);
                pricingContext.configToken = rvItem._UID;
            } else {
                var replacementStr = '/' + encodeURIComponent('Vin[' + decodeURIComponent(rvItem._UID) + ']') + '/';
                digImgUrl = digImgUrl.replace('/Hero/', replacementStr);
                pricingContext.vin = rvItem._UID;
                if (rvItem._PAcode) {
                    pricingContext.dealerPACode = rvItem._PAcode;
                }
            }
            if (rvItem._trim) {
                linkContext.trimId = rvItem._trim;
            }
        } else if (rvItem._trim) {
            var digTrimVal = (isBlackLabel) ? 'Black Label' : rvItem._trim;
            var replacementStr = '/' + encodeURIComponent('Hero[' + decodeURIComponent(digTrimVal) + ']') + '/';
            digImgUrl = digImgUrl.replace('/Hero/', replacementStr);
            pricingContext.trimId = rvItem._trim;
            linkContext.trimId = rvItem._trim;
        } else if (isBlackLabel) {
            var replacementStr = '/' + encodeURIComponent('Hero[Black Label]') + '/';
            digImgUrl = digImgUrl.replace('/Hero/', replacementStr);
        }
        var itemClass = '.model_' + index;
        var $el = $(itemClass, components);
        
        // set smartlink context
        $el.attr('data-link-context', JSON.stringify(linkContext));
        
        if (pricingEnabled) {
            // pricing context and template assignment
            $el.attr('data-pricing-context', JSON.stringify(pricingContext));
            if (typeof pricingContext.vin !== 'undefined') {
                var vinContainer = $el.find('.vin-container');
                var vinEl = vinContainer.find('.vin');
                vinEl.text(pricingContext.vin);
                vinContainer.find('.prefix').removeClass('hidden');
                // un-hide all VIN containers in order to create equivalent space even on items with no vin...
                $('.vin-container', components).removeClass('hidden');
            }
            var pricingTemplate = pricingTemplates[rvItem.suffix];
            var pricingDisclosure = pricingDisclosures[rvItem.suffix];
            var showIBall = pricingIBallToggles[rvItem.suffix];
            if (typeof pricingTemplate !== 'undefined') {
                var $pricingElWrap = $el.find('.make-info.price'),
                    pricingLabelType = pricingLabelTypes[rvItem.suffix],
                    pricingLabel = pricingLabels[pricingLabelType || 'startingAt'];

                if(!_.isEmpty(pricingLabel)) {
                    $pricingElWrap.attr('data-pricing-labels', JSON.stringify(pricingLabel));
                }

                // we have a pricing template, so apply it to this item
                var pricingEl = $el.find('.make-info.price > .pricing');
                pricingEl.attr('data-pricing-template', pricingTemplate);
                if (typeof pricingDisclosure !== 'undefined') {
                    $el.find('.make-info.price > .disclosure').html(pricingDisclosure);
                }
                if (typeof showIBall !== 'undefined' && (showIBall == true || showIBall === 'true')) {
                    $el.find('.make-info.price > a.icon-info').removeClass('hidden');
                }

            } /* Removing 'else' condition, which previously hid the price container if no price label was available for the respective activity.
               * This is to accommodate BRAND-15147, which requires identical CTA alignment regardless of whether a price is present.
               */
        }
        
        var img = $el.find('img');
        //NZ: Removed via BRAND-13397: img.attr('alt', rvItem._year + ' ' + rvItem._brand + ' ' + rvItem._nameplate);

        //NZ: Call testImage here to determine if the image is valid or not.
        testImage(digImgUrl).then(
            function successImageLoad(imgObj) {
                //NZ - should add check here to handle the Ghost image variant (returns with 200 but DIG exception in header)
                if(!(img.hasClass('lazyloaded') || img.hasClass('lazyloading'))) {
                    img.on('load', function (ev) {
                        $el.find('.image-loader-svg').addClass('hidden');
                    });
                } else {
                    $el.find('.image-loader-svg').addClass('hidden');
                }
            },
            function failedImageLoad() {
                img.addClass("hidden");
                $el.find('.image-loader-svg').addClass('hidden');
                $el.find('.model-img').addClass('fgx-model-min-height');
                $el.find('.image-error-wrap').removeClass('hidden');
            }
        );

        // deal with DIG Image here
        img.attr('data-srcset', digImgUrl);
        img.removeAttr('aria-hidden');
        var imgLink = $el.find('.model-img');
        var $headingEl = $el.find('.rv-model-title');
        $headingEl.removeAttr('aria-hidden');
        var text = $headingEl.find('a');
        var label = contextLabels[rvItem.suffix];
        if (label === '' || label == undefined) {
            // attempt to default to 'View Page' label
            label = contextLabels['ViewPage'];
        }

        var modelText = (label !== '' && label != undefined) ? label.replace('{rvname}', displayName) : displayName;
        modelText += '<span class="icon fgx-brand-model-name-chevron icon-action-chevron-right-25px" aria-hidden="true"></span>';
        text.html(modelText);
        var $rvBBTitleA = $rvBBTitle.find('a');
        // Set the model text to the BB headline if the bbLayout is selected and we are on the first model.
        if($rvBBTitle.length && itemClass === '.model_0') {
            $rvBBTitleA.html(modelText);
            $rvBBTitle.removeAttr('aria-hidden');
        }
        // replace URL
        if (url !== '' && typeof url != 'undefined' && url != null) {
            var idx = url.indexOf('#');
            var hash = '';
            if(idx >= 0) {
                var hash = url.substring(idx);
                url = url.substring(0, idx);
            }
            // check for campaign code and append to url
            var code = campaignCodes[rvItem.suffix];
            if (code !== '' && typeof code != 'undefined' && code != null) {
                if (code.indexOf('{nameplate}') >= 0) {
                    code = code.replace('{nameplate}', rvItem._nameplate.toLowerCase());
                }
                if (url.indexOf(encodeURI(code)) < 0) {
                    (url.indexOf('?') >= 0) ? url += '&' : url += '?';
                    url += encodeURI(code);
                }
            }
            var targetCampaign = $el.closest('[data-target-campaign-url-value]').attr('data-target-campaign-url-value');
            if(targetCampaign && (url.indexOf(targetCampaign) < 0)) {
                (url.indexOf('?') >= 0) ? url += '&' : url += '?';
                url += targetCampaign;
            }
            url += hash;
            imgLink.attr('href', url);
            text.attr('href', url);
            // click actions for main text and image if they exist
            var mainLinkClickAction = mainLinkMetrics[rvItem.suffix];
            var imageLinkClickAction = imageLinkMetrics[rvItem.suffix];
            if (typeof mainLinkClickAction !== 'undefined') {
                text.attr('data-fd-metrics-click', mainLinkClickAction);
            }
            if (typeof imageLinkClickAction !== 'undefined') {
                imgLink.attr('data-fd-metrics-click', imageLinkClickAction);
            }
            // remove aria-hidden from <a> tags
            //NZ: Removed via BRAND-13397/BRAND-13739: - imgLink.removeAttr('aria-hidden');
            text.removeAttr('aria-hidden');
            // Set the url to the BB headline if the bbLayout is selected and we are on the first model.
            if($rvBBTitleA.length && itemClass === '.model_0') {
                $rvBBTitleA.attr('href', url);
            }
            // setup cta one
            var $ctaOneContainer = $el.find('.cta-one-container');
            var ctaOneLabel = ctaOneLabels[rvItem.suffix];
            var ctaOneClickAction = ctaOneMetrics[rvItem.suffix];
            if (typeof ctaOneLabel !== 'undefined') {
                // we have a label, set up the cta and remove aria-hidden attribute
                $ctaOneContainer.find('a').attr('href', url).attr('aria-hidden', false);
                $ctaOneContainer.find('.cta-text').text(ctaOneLabel);
                if (typeof ctaOneClickAction !== 'undefined') {
                    $ctaOneContainer.find('a').attr('data-fd-metrics-click', ctaOneClickAction);
                }
            } else {
                $ctaOneContainer.hide();
            }
        }
        // set up secondary cta if defined
        var $ctaTwoContainer = $el.find('.cta-two-container');
        var ctaTwoLabel = ctaTwoLabels[rvItem.suffix];
        var ctaTwoLink = ctaTwoLinks[rvItem.suffix];
        var ctaTwoClickAction = ctaTwoMetrics[rvItem.suffix];
        if (typeof ctaTwoLabel !== 'undefined' && typeof ctaTwoLink !== 'undefined') {
            // we have a label, set up the cta and remove aria-hidden attribute
            $ctaTwoContainer.find('a').attr('href', ctaTwoLink).attr('aria-hidden', false);
            $ctaTwoContainer.find('.cta-text').text(ctaTwoLabel);
            if (typeof ctaTwoClickAction !== 'undefined') {
                $ctaTwoContainer.find('a').attr('data-fd-metrics-click', ctaTwoClickAction);
            }
        } else {
            $ctaTwoContainer.hide();
        }
        $el.addClass("item fgx-rvv-valid-item").removeClass("hidden");
    }
   
})(jQuery, FD.Brand.lodash, window, FD.Brand, FD.Brand.User, FD.Brand.Util, FD.Brand.Context);

;(function($, brand) {

    brand.setInitHandler('[data-fgx-multi-year-vehicle-tile]', init);

    /////////////

    function init(components) {
        
        var brand = window.FD.Brand;

        brand.Dig.resolve(components);

        //populate pricing
        components.each(function(idx) {
            brand.Pricing.refresh(this);

            if($(this).hasClass('has-tabs')) {
                $(this).find('[data-fgx-id-tmpl]').each(function() {
                    var $el = $(this),
                        idTmpl = $(this).attr('data-fgx-id-tmpl'),
                        ctrlTmpl = $(this).attr('data-fgx-controls-tmpl'),
                        labelledTmpl = $(this).attr('data-fgx-labelledby-tmpl');

                    $el.attr('id', idTmpl.replace('{tileCount}', idx));

                    if(ctrlTmpl && typeof(ctrlTmpl) != 'undefined') {
                        $el.attr('aria-controls', ctrlTmpl.replace('{tileCount}', idx));
                    } else if(labelledTmpl && typeof(labelledTmpl) != 'undefined') {
                        $el.attr('aria-labelledby', labelledTmpl.replace('{tileCount}', idx));
                    }
                });
            }
        });
        
        function resetPaginationAriaLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.removeAttr('aria-live');
            pageInfo.removeAttr('aria-atomic');
            pageInfo.text('');
        }
        
        function updatePaginationAriaLabel($carousel, current, total) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }
        
        // activate a carousel slide when one of the indicators is clicked.
        $('.tabnav button.year-item', components).click(function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            var goToId = parseInt($(this).data("slideTo"), 10);
            var $carousel = $(this).closest('.myvt-inner-container');
            var total = $(this).parent().find('button.year-item').length;

            $carousel.find('li.vehicle').each(function() {
                $(this).removeClass('active');
                var idx = parseInt($(this).data('idx'), 10);
                if (idx === goToId) {
                    $(this).addClass('active');
                }
            });
            
            if (!$(this).hasClass("active")) {
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-click')
                );
            }

            $(this).siblings('.year-item').removeClass("active").attr('aria-selected', 'false');
            $(this).addClass("active").attr('aria-selected', 'true');
            // update our pagination aria label
            updatePaginationAriaLabel($carousel, (goToId + 1), total);
        });
        
        // our hover states for our 'main tile' which is really two elements combined
        
        $('.tabnav', components).mouseover(function(ev) {
            var $tile = $(this).closest('.multiYearVehicleTile');
            $('.tabnav', $tile).addClass('hover');
            $('.primary', $tile).addClass('hover');
        });
        
        $('.primary', components).mouseover(function(ev) {
            var $tile = $(this).closest('.multiYearVehicleTile');
            $('.tabnav', $tile).addClass('hover');
            $('.primary', $tile).addClass('hover');
        });
        
        $('.tabnav', components).mouseout(function(ev) {
            var $tile = $(this).closest('.multiYearVehicleTile');
            $('.tabnav', $tile).removeClass('hover');
            $('.primary', $tile).removeClass('hover');
        });
        
        $('.primary', components).mouseout(function(ev) {
            var $tile = $(this).closest('.multiYearVehicleTile');
            $('.tabnav', $tile).removeClass('hover');
            $('.primary', $tile).removeClass('hover');
        });
        
        $('.secondary', components).click(function(ev) {
            // ensure that entire container of cta two is clickable...
            if (ev.target.className === 'secondary' || ev.target.className === 'myvt-cta') {
                $(this).find('a:visible').trigger('click');
            }
        });
        
    }
})(jQuery, FD.Brand);
/*global Hammer*/
;(function($, _, brand, disclosures) {
  'use strict';
    var _el,
        compare_el,
        container_el,
        wrapper_el,
        models_el,
        model_el,
        arrows_el,
        back_arrow_el,
        next_arrow_el,
        meatballs_el,
        window_el,
        hammertime = null,
        _onResize_d,
        setMeatballs_d,
        model_widths,
        breakPoint,
        _hasTouch,
        meatballPrefix,
        hasLastSlideMobile;

    brand.setInitHandler('[data-fgx-models-display]', init);

  //////

  function init(components) {
    _el = $(".cq-frame").length > 0 ? $(".cq-frame").contents().find(".model-display") : $(".model-display");
    compare_el = _el.children('.md-compare-models');
    wrapper_el = _el.children('.md-content-wrapper');
    container_el = wrapper_el.children('.md-models-container');
    models_el = container_el.children('.md-models');
    model_el = models_el.children('.md-model-model');
    arrows_el = wrapper_el.children('.carousel-arrows');
    back_arrow_el = wrapper_el.children('.carousel-arrows.carousel-left');
    next_arrow_el = wrapper_el.children('.carousel-arrows.carousel-right');
    meatballs_el = _el.children('.meatballs');
    window_el = $(window);
    _onResize_d = _.debounce(_onResize, 50);
    setMeatballs_d = _.debounce(setMeatballs, 200);
    model_widths = new Array();
    breakPoint = window.FD.Brand.Util.currentBreakpoint();
    meatballPrefix = $(components).data('meatballPrefix');
    hasLastSlideMobile = $(components).data('hasLastSlideMobile');
    if(!meatballPrefix) {
        meatballPrefix = '';
    }
    _hasTouch = window.FD.Brand.Util.env.touch();
    if((_el.length > 0) && (models_el.length > 0)) {
	    FD.Brand.Util.carousel.swipe(_el[0], function(el, dir) {
		    if(breakPoint === 'gux-bkpt-sm' || _hasTouch) {
			    ((dir === 'next') ? jumpNextMeatball : jumpPrevMeatball).call(el);
		    }
	    });
    }

    // Setup a hover state for cta buttons, part of Ford CTA globalization
    if ( $('html').hasClass('fgx-brand-Ford') ) {
        var $cta = $('a.btn-secondary', components);
        window.FD.Brand.Util.ctaHover($cta);
    }

    /*init */

    window_el.resize(_onResize_d);
    finishList();

    components.each(function() {
      var _this = this;
      var startingPriceDiscColor = $(_this).data('startingPriceDiscColor') || '';
      var monthlyPriceDiscColor = $(_this).data('monthlyPriceDiscColor') || '';
      var $modelsCtx = $(_this).find('.md-models');

      if(startingPriceDiscColor && startingPriceDiscColor !== '') {
        updateDisclosureColor($modelsCtx, '.starting-disc sup[data-vdm-disc]', startingPriceDiscColor);
      }

      brand.User.location.subscribe(function() {
          FD.Brand.Pricing.refresh(_this, true).done(function(templates) {
              _.each(templates, function($el) {
                  var priceDetail = $el.data('pricing');
                  if(priceDetail && priceDetail.priceValue) {
                      var validOfferType = (priceDetail.offerType == 'lease' || priceDetail.offerType == 'finance');
                      if($el.hasClass('monthly-price-item') && validOfferType) {
                          $el.closest('.line-item').removeClass('hidden').closest('.monthly-price').removeClass('hidden');
                      } else if ($el.hasClass('monthly-disc') && validOfferType) {
                          // Make the monthlyPrice disclosure accessible
                          disclosures.updateDisclosures($el);
                          if (monthlyPriceDiscColor) {
                            updateDisclosureColor($el, 'sup[data-vdm-disc]', monthlyPriceDiscColor);
                          }
                      }
                  }
              });
              // NZ - Ensure the disclosures that were added via the pricing library have their tabindexes
              // set appropriately if they're hidden.
              updateTabIndexes();
          });
      });
    });

  }

  function finishList() {
    
    window.FD.Brand.Dig.resolve($('.model-display .md-models-container .md-models .md-model-model .model-img'));
    
    model_el.each(function(){
      var new_el = $(this);
      
      model_widths.unshift(new_el.width() + cssNum(new_el, "marginLeft") + cssNum(new_el, "marginRight"));
      
      new_el.on("click", exitToCTA);
    });


    compare_el.on("click", exitToCTA);

    arrows_el.children(".carousel-next").on("click", {
      metrics: "click arrow next"
    }, jumpNextMeatball);

    arrows_el.children(".carousel-previous").on("click", {
      metrics: "click arrow previous"
    }, jumpPrevMeatball);

    _el.addClass("loaded");
    window_el.resize();
  }


  // * FUNCTIONS *

  function updateDisclosureColor(context, selector, color) {
    var discColor = "#" + color;
    $(selector, context).each(function() {
        $(this).css('color', discColor);
    });
  }

  function cssNum(el, string) {
    return Number(el.css(string).replace("px", ""));
  }

  function setLeftTo(num) {
    models_el.css("left", num + "px");
  }

  function appendLabel(el, label) {
    el.append(label);
    return el.children().last();
  }

  function exitToCTA() {//(data)
    //METRICS
    // metrics.clickEvent($(this).attr('data-metrics'));
    //click
    // console.log($(this).attr('data-cta'));
  }
  
  function updateTabIndexes() {
      var activeMeatball = meatballs_el.find("a.active");
      // we have different widths based on margins for first and last item, so calculate by dividing total width by number of models.
      var model_width = models_el.width() / model_el.length;
      var visible_tiles = Math.round(container_el.width() / model_width);
      var currentIdx = (activeMeatball && activeMeatball.length > 0) ? (parseInt(activeMeatball.data('idx'), 10)) : 0;
      var index = currentIdx * visible_tiles;
      var counter = 0;
      currentIdx += 1;
      // first, set all existing items with tabindex attribute to '-1'
      $('[tabindex]', model_el).each(function() {
          $(this).attr('tabindex', '-1');
      });
      model_el.attr('aria-hidden', 'true');
      // next, for our items which are currently visible, toggle tabindex to '0'
      while (counter < visible_tiles) {
          if (index < model_el.length) {
              var model = model_el[index];
                $('[tabindex]', model).each(function() {
                    $(this).attr('tabindex', '0');
                });
                $(model).attr('aria-hidden', 'false');
                counter ++;
                index ++;
          } else {
              break;
          }
      }
      // set our pagination aria label
      var meatballsElms = meatballs_el.find('a');
      var totalIdx = (meatballsElms && meatballsElms.length > 0) ? meatballsElms.length : 1;
      updatePaginationLabel(_el, currentIdx, totalIdx, visible_tiles);
  }
  
  function updatePaginationLabel($carousel, current, total, itemsPerPage) {
      var pageInfo = $carousel.find('.pagination-info');
      var pageInfoTemplate = pageInfo.data('label-template');
      pageInfo.attr('aria-hidden', 'false');
      if(pageInfoTemplate) {
        pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total).replace('{itemsPerPage}', itemsPerPage));
      }
  }

  function jumpToMeatball(el) {

    meatballs_el.find("a.active").removeClass("active");
    setLeftTo(-1 * el.attr('data-position'));
    el.children("a").addClass("active");
    updateTabIndexes();
  }

  function jumpNextMeatball() {
    var t = meatballs_el.find("a.active").parent().next();
    if (t.length) {
      jumpToMeatball(t);
    } else {
      jumpToMeatball(meatballs_el.children().first());
    }

    //Common Metrics
    scrollAction.call(this);
  }

  function jumpPrevMeatball() {
    var t = meatballs_el.find("a.active").parent().prev();
    if (t.length) {
      jumpToMeatball(t);
    } else {
      jumpToMeatball(meatballs_el.children().last());
    }

    //Common Metrics
    scrollAction.call(this);
  }

  function clickToMeatball() {
    jumpToMeatball($(this));
    $(this).closest('.model-display').find('.md-content-wrapper .md-models-container').focus();

    //Common Metrics
    scrollAction.call(this);
  }

  function resetMeatballs(el, widths) {

    var keys = _.keys(widths),
      _widthskey,
      m_el = el.children("li");

    while ((_widthskey = keys.shift())) {
      $(m_el[_widthskey]).attr("data-position", widths[_widthskey].total);
    }
  }

  function createMeatballs(el, widths) {

    var keys = _.keys(widths),
      _widthskey,
      new_el,
      active_el;

    while ((_widthskey = keys.shift())) {

      new_el = appendLabel(el, createMeatball(_widthskey, widths[_widthskey].total));
      if (widths[_widthskey].total <= Number(models_el.css("left").replace("px", "") * -1)) {
        active_el = new_el.children("a");
      }

      new_el.on("click", {
        metrics: "click meatball" + _widthskey
      }, clickToMeatball);
    }
    if(active_el) {
        active_el.addClass("active");
    }
  }

  function createMeatball(num, pos) {
    var dispNum = parseInt(num, 10) + 1;
    var ariaLabel = meatballPrefix + ' ' + dispNum;
    return String.prototype.concat.call(
      '<li class="meatball" data-position="',
      pos,
      '"><a href="javascript:void(0);" data-idx="',
      num,
      '" tabindex="0" role="button" data-fgx-keypress="true" aria-label="',
      ariaLabel,
      '">',
      dispNum,
      '</a></li>\n');
  }

  function setMeatballs(el, widths) {

    var _currentwidth = 0,
      _meatballwidths = _.filter(widths, function(n) {

        if (n.combined >= _currentwidth) {
          _currentwidth = n.combined + container_el.width();
          return true;
        }

        return false;
      }),
      last_meatball = el.children('li').length,
      meatball_num = _meatballwidths.length;

    function compareLastMeatBalls() {
      return el.children('li').last().attr("data-position") !== _meatballwidths[meatball_num - 1].total;
    }

    if (meatball_num > 1) {
      if (last_meatball !== meatball_num) {
        el.empty();
        createMeatballs(el, _meatballwidths);
        setLeftTo(-1 * Number(el.find("a.active").parent().attr("data-position")));
      } else if (compareLastMeatBalls()) {
        resetMeatballs(el, _meatballwidths);
        setLeftTo(-1 * Number(el.find("a.active").parent().attr("data-position")));
      }
      arrows_el.addClass("scrollable");
      meatballs_el.addClass("scrollable");
    } else {

      if(last_meatball > 0) {
          el.empty();
          updateTabIndexes();
      }

      arrows_el.removeClass("scrollable");
      meatballs_el.removeClass("scrollable");
      setLeftTo(0);
    }
    
    updateTabIndexes();
  }

  function _onResize() {
    breakPoint = window.FD.Brand.Util.currentBreakpoint();

    var _prev = 0,
      _totalwidth = 0,
      _widths = _.chain(model_widths)
      .map(function(n) {
        _totalwidth+= Number(n);
        var t = {
          width: Number(n),
          total: _prev,
          combined: _prev + Number(n)
        };
        _prev += n;
        return t;
      })
      .value();

    if(breakPoint !== 'gux-bkpt-sm' && _widths[0] && _widths[0].width) {
        // Only if we have a final mobile slide (Image OR Compare Models CTA)
        if (hasLastSlideMobile) {
            // Remove one of the widths from the total width to account for the mobile li element which is hidden on desktop
            _totalwidth = _totalwidth - _widths[0].width;
        }
    }

    //widths should be changing on every resize
    models_el.css("width", _totalwidth*1.1 + "px");

    var _len = _widths.length,
      r = 0;

    if(breakPoint !== 'gux-bkpt-sm') {
        // Only if we have a final mobile slide (Image OR Compare Models CTA)
        if (hasLastSlideMobile) {
            // remove last item from _widths and re-define _len to account for the mobile li element which is hidden on desktop
            _widths.pop();
        }
        _len = _widths.length;
        for (var i = 0; i < _len; i++){
          var t = _widths[i].combined;

          if (_el.width() >= t){
            r = t;
          }
        }
        container_el.width(r);
    } else {
        container_el.width(290);
    }

    //the meatballs, with all its calculations, can wait and be debounced
    setMeatballs_d(meatballs_el, _widths);
  }

  //Common Metrics
  function scrollAction() {
    FD.Brand.Metrics.handler.direct($(this).closest('[data-fgx-models-display]').attr('data-fd-metrics-scroll'));
  }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Disclosures);

;(function($, _, win, brand, user, util, ctx, ngp, mtx){

    var components,
        templates = {},
        //NZ: The order of the triggers within the array below is important. These need to be in the order of priority.
        _FPSTriggers = [
            {
                key: 'SISVV',
                params: ['_brand', '_nameplate', '_year', '_trim', '_PAcode', '_ZIP', '_UID']
            }, {
                key: 'SINGSearch',
                params: ['brand', 'nameplate', 'year', '_brand', '_nameplate', '_year', 'trim', 'zip', 'engine', 'exteriorColor', 'interiorColor', 'transmission', 'exteriorFeatures__WheelSize']
            }, {
                key: 'OI',
                params: ['_brand', '_nameplate', '_year']
            }, {
                key: 'BNP',
                params: ['_brand', '_nameplate', '_year', '_trim', '_PAcode', '_ZIP']
            }, {
                key: 'BPModelSelect',
                tmplKey: 'BNP',
                params: ['_brand', '_nameplate', '_year']
            }
        ],
        _FPSToNGPAttributeMap = {
            '_brand': 'make',
            '_nameplate': 'model',
            '_year': 'year',
            '_trim': 'trim',
            '_ZIP': 'postalCode',
            'zip': 'postalCode',
            '_PAcode': 'dealerPACode',
            'WheelSize': 'wheelSize',
            '_UID': 'vin'
        },
        _properties = {},
        _dealerDistanceUnits = {
            'US': 'mi',
            'CA': 'km'
        }[ctx && ctx.region || 'US'],
        _pricingLabels = {
            startingAt: {},
            estimatedNet: {}
        },
        _pricingDisclosures = {
            startingAt: '',
            estimatedNet: ''
        },
        _listSizeClasses = [
            'list-zero',
            'list-one',
            'list-two',
            'list-three'
        ],
        inventoryRequestUrl = '',
        baseSingUrl = '',
        _pageType = null;

    brand.setInitHandler('[data-fgx-local-inventory-you-might-like]', init);

    function init(newComponents) {

        if(newComponents.length == 0) {
            return;
        }

        components = newComponents;

        $('script[data-fgx-local-inventory-yml-template-id]').each(function(idx, tmpl) {
            var $tmpl = $(tmpl),
                id = $tmpl.attr('data-fgx-local-inventory-yml-template-id') || '';
            if(id && !templates[id]) {
                templates[id] = _.template(tmpl.innerHTML);
            }
        });

        inventoryRequestUrl = $(components).attr('data-inventory-request-url');
        if(inventoryRequestUrl && inventoryRequestUrl.slice(-5) === '.html') {
            inventoryRequestUrl = inventoryRequestUrl.slice(0, inventoryRequestUrl.length - 5);
        }
        if(inventoryRequestUrl && inventoryRequestUrl.slice(-1) === '/') {
            inventoryRequestUrl = inventoryRequestUrl.slice(0, inventoryRequestUrl.length - 1);
        }
        util.log("LIYML::Init reqURL is: ", inventoryRequestUrl);

        baseSingUrl = brand.Link.baseUrl('shop') + '/inventory/';

        // setup pricing label types
        setPricingLabelTypes(components, 'starting-at-price-label', 'startingAt');
        setPricingLabelTypes(components, 'estimated-net-price-label', 'estimatedNet');

        _pricingDisclosures.startingAt = components.attr('data-starting-at-price-disclosure') || '';
        _pricingDisclosures.estimatedNet = components.attr('data-estimated-net-price-disclosure') || '';

        _properties.infoIconText = components.attr('data-iball-text') || '';
        _properties.infoIconClickAction = components.attr('data-iball-click-action') || '';
        _properties.digAngle = components.attr('data-dig-angle') || '5';
        _properties.vinPrefixLabel = components.attr('data-vin-prefix') || '';
        _properties.priceDetailHeadline = components.attr('data-price-detail-headline') || '';
        _properties.defaultBtnType = components.attr('data-default-cta-btn-type') || '';
        _properties.defaultCampaignCode = components.attr('data-default-campaign-code') || '';
        _properties.triggeredItemBtnType = components.attr('data-triggered-item-cta-btn-type') || '';
        _properties.inventoryItemsBtnType = components.attr('data-inventory-items-cta-btn-type') || '';
        _properties.vinUnavailableLabel = components.attr('data-vin-unavailable-label') || '';
        _properties.vinUnavailableCtaText = components.attr('data-vin-unavailable-cta-text') || '';
        _properties.vinUnavailableAriaLabel = components.attr('data-vin-unavailable-aria-label') || '';
        _properties.vinUnavailableClickAction = components.attr('data-vin-unavailable-cta-click-action') || '';

        _properties.defaultVehicleTiles = [];

        user.fps.current().done(function(state) {
            if(!state.loaded) {
                util.log('FPS library not loaded');
                initDefaultView();
                return;
            }

            var nameplate = ctx.nameplate && ctx.nameplate.ngpModelName || '',
                trim = ctx.model && ctx.model.ngpTrimName || null,
                year = ctx.nameplate && ctx.nameplate.ngpYear || '';

            if(!nameplate) {
                initDefaultView();
                return;
            }

            var fpsResponseObject = {
                success: function(data) {
                    var recentlyViewed = (data && data[0]) ? data[0].RVVYMAL : null;

                    util.log('**************** LIYML Data');
                    util.log(data[0]);

                    if (recentlyViewed && !_.isEmpty(recentlyViewed)) {
                        var triggerTypeData = components.attr('data-trigger-type-items');

                        try {
                            _properties.triggerTypeTiles = triggerTypeData && JSON.parse(triggerTypeData) || {};
                        } catch(err) {
                            _properties.triggerTypeTiles = {};
                        }


                        var recentVehicle = null,
                            triggerData = null;

                        _.each(_FPSTriggers, function(trigger) {
                            var rvTrigger = recentlyViewed[trigger.key];

                            if(rvTrigger != null && !_.isEmpty(rvTrigger)) {
                                recentVehicle = _.assign({}, rvTrigger);
                                triggerData = _.assign({}, trigger);
                                return false;
                            }
                        });

                        if(recentVehicle) {
                            //Move forward with call to retrieve inventory for this vehicle.

                            if(triggerData && triggerData.params) {
                                _properties.currTriggerTile = _.assign({}, _properties.triggerTypeTiles[triggerData.tmplKey || triggerData.key || ''] || {});
                                _properties.triggerType = (recentVehicle.suffix || '').toLowerCase();

                                var triggeredPrms = {},
                                    prm = {
                                        'postalCode': user.location.current().postalCode,
                                        'radius': '50'
                                    };
                                _.each(triggerData.params, function(param) {
                                    var val = '';
                                    if(param.indexOf('__') < 0) {
                                        val = recentVehicle[param] || '';
                                    } else {
                                        var pArr = param.split('__'),
                                            pKey = pArr[0] || '',
                                            pSubKey = pArr[1] || '';
                                        if(pKey && pSubKey) {
                                            val = recentVehicle[pKey] && recentVehicle[pKey][pSubKey] || '';
                                            param = pSubKey;
                                        }
                                    }

                                    var ngpKey = _FPSToNGPAttributeMap[param] || _FPSToNGPAttributeMap["_" + param] || param;
                                    if(val) {
                                        var outputVal = '';
                                        if(_.isObject(val)) {
                                            _.each(val, function(itmVal, key) {
                                                if(itmVal !== 0) {
                                                    outputVal += (!outputVal ? '' : ';') + key;
                                                }
                                            });

                                            if (ngpKey === 'year' && !outputVal) {
                                                var years = _.keys(val);
                                                if (years.length > 1) {
                                                    years.sort(function(a, b) {
                                                        var numA = parseInt(a, 10),
                                                            numB = parseInt(b, 10);
                                                        return numB - numA;
                                                    });
                                                }
                                                outputVal = years[0];
                                            }
                                        } else {
                                            outputVal = val;
                                        }

                                        if(outputVal) {
                                            triggeredPrms[ngpKey] = outputVal;
                                        }
                                    }

                                });

                                if(!_.isEmpty(triggeredPrms)) {
                                    user.dealer.current().done(function(_dealer) {
                                        if(!_.isEmpty(_dealer) && _dealer.preferred && _dealer.preferred.PACode) {
                                            triggeredPrms.preferredDealerPACode = _dealer.preferred.PACode;
                                            prm.dealerPACode = _dealer.preferred.PACode;
                                        }
                                        if(triggerData.key === 'BNP' && recentVehicle['_UID'] && recentVehicle['_UID'].indexOf('Config[') === 0) {
                                            triggeredPrms.configToken = recentVehicle['_UID'];
                                        }
                                        prm.fps = FD.Brand.Util.parameters.encode(triggeredPrms, 1);

                                        recentVehicle._brandStandardizedPrms = _.assign({}, triggeredPrms);
                                        recentVehicle._brandTriggerKey = triggerData.key || '';
                                        recentVehicle._brandTmplTriggerKey = triggerData.tmplKey || recentVehicle._brandTriggerKey;

                                        $.getJSON(inventoryRequestUrl, prm).then(function(res) {
                                            util.log(res);
                                            handleInventoryResponse(res, 'triggered', recentVehicle);
                                        }, function() {
                                            util.log("LIYML::triggeredView - request for triggered inventory failed. Calling the default view now");
                                            initDefaultView();
                                        });
                                    });

                                }
                            }
                        } else {
                            util.log("LIYML::Error - no data returned by FPS for any of the triggered experiences");
                            initDefaultView();
                        }

                    } else {
                        util.log("LIYML::Error - no recently viewed data defined.");
                        initDefaultView();
                    }
                }, error: function() {
                    util.log("LIYML::Error - error in the FPS getByNamePlate call");
                    initDefaultView();
                }
            };

            FPS.YMAL.getByNamePlate(nameplate, trim, year, fpsResponseObject);
        });
    }

    function setPricingLabelTypes($el, labelTypeAttr, labelTypeKey) {
        if (!$el || $el.length === 0) {
            return;
        }

        var priceLabelsObj = $el.data(labelTypeAttr),
            priceLabels = (priceLabelsObj && typeof(priceLabelsObj) != 'undefined' && priceLabelsObj != 'null') ? priceLabelsObj : {};

        _pricingLabels[labelTypeKey] = _.assign({}, _pricingLabels[labelTypeKey], priceLabels);
    }

    function initDefaultView() {
        var defaultData = components.attr('data-default-vehicle-tiles'),
            vehicleTiles;

        try {
            vehicleTiles = defaultData && JSON.parse(defaultData) || [];
        } catch(err) {
            vehicleTiles = [];
        }

        if(_.isEmpty(vehicleTiles)) {
            // If we're initializing the default view and the vehicles are empty then we should ensure the component is hidden.
            components.addClass('hidden');
            return;
        }

        _properties.defaultVehicleTiles = vehicleTiles;
        _properties.triggerType = 'default';
        user.dealer.current().done(function(_dealer) {
            var prm = {
                'postalCode': user.location.current().postalCode
            };

            if(!_.isEmpty(_dealer) && _dealer.preferred && _dealer.preferred.PACode) {
                prm.dealerPACode = _dealer.preferred.PACode;
            }

            $.getJSON(inventoryRequestUrl, prm).then(function(res) {
                util.log(res);
                handleInventoryResponse(res, 'default');
            }, function() {
                util.log("LIYML::initDefaultView - request for default inventory failed. Hiding the component now");
                components.addClass('hidden');
            });
        });
    }

    function handleInventoryResponse(vehicles, experience, vehicleData) {
        var handleError = function() {
            if(experience === 'triggered') {
                initDefaultView();
            } else {
                components.addClass('hidden');
            }
        }
        if(vehicles && !_.isEmpty(vehicles)) {
            var hasValidEntry = false,
                data = {},
                _hasPromise = false,
                _promise;

            _.each(vehicles, function(veh, idx) {
                if(veh != null && !_.isEmpty(veh)) {
                    hasValidEntry = true;
                    var config = {
                        'idx': idx
                    };
                    if(experience === 'triggered' && !_.isEmpty(vehicleData)) {
                        config = getUpdatedConfigData(config, vehicleData);
                    }
                    data['vehicle'+idx] = processVehicleData(veh, experience, config);
                }
            });

            if(experience === 'triggered' && hasValidEntry && (!data.vehicle0 || _.isEmpty(data.vehicle0))) {
                //The data for the RVV Trigger tile wasn't returned, but we're in the trigger experience so we
                // should see if data is available in the fpsVehicleData. If so, then we'll retrieve the proper information,
                // call processVehicleData, and set hasValidEntry to true
                util.log("LIYML::handleInventoryResponse - first tile is empty. vehicleData is: ", vehicleData);
                var fpsData = {};
                var config = {
                    'idx': 0
                };
                if(!_.isEmpty(vehicleData)) {
                    fpsData = _.assign({}, fpsData, vehicleData._brandStandardizedPrms || {});
                    if(fpsData.model) {
                        fpsData.model = _.capitalize(fpsData.model);
                    }
                    config = getUpdatedConfigData(config, vehicleData);
                }
                if(!_.isEmpty(fpsData)) {
                    hasValidEntry = true;
                    // BRAND-15880: If data wasn't returned for the triggered tile vehicle from the backend, and we're going
                    // to use the FPS data to fill that tile directly, then we first need to try to get the displayName and
                    // displayNameShort properties from VDM for the vehicle before calling processVehicleData.
                    _hasPromise = true;
                    _promise = util.vdm.displayName(fpsData);
                    _promise.then(function(respData) {
                        data['vehicle0'] = processVehicleData(respData, experience, config);
                    });
                } else {
                    hasValidEntry = false;
                }
            }

            if(!hasValidEntry) {
                handleError();
                return;
            }

            if(experience === 'triggered' && vehicleData && vehicleData._brandTmplTriggerKey) {
                $('[data-fgx-trigger-type="' + vehicleData._brandTmplTriggerKey + '"]', components).removeClass('hidden');
            }

            // BRAND-15880: hold off on calling the renderVehicleItems function until the data for vehicle0 is processed
            // and the promise is resolved. Note, if _hasPromise is false then this will be resolved right away.
            $.when(_hasPromise && _promise).done(function() {
                renderVehicleItems(data, experience);
            });

        } else {
            handleError();
        }
    }

    function getUpdatedConfigData(config, vehicleData) {
        config = config || {};
        var output = {};
        if(vehicleData) {
            if(vehicleData.suffix) {
                output.suffix = vehicleData.suffix;
            }
            if(vehicleData.returnURL) {
                output.returnURL = vehicleData.returnURL;
            }
            if(vehicleData._brandTriggerKey) {
                output._brandTriggerKey = vehicleData._brandTriggerKey;
            }
            if(vehicleData._brandTmplTriggerKey) {
                output._brandTmplTriggerKey = vehicleData._brandTmplTriggerKey;
            }
        }
        return _.assign({}, config, output);
    }

    function processVehicleData(veh, experience, config) {
        config = _.assign({}, config || {});
        var data = _.assign({}, veh);

        var digUrl = FD.Brand.Context.settings.digUrl + '/' + encodeURIComponent(decodeURIComponent(veh.make)) + '/' + encodeURIComponent(decodeURIComponent(veh.model)) + '/' + encodeURIComponent(decodeURIComponent(veh.year)) + '/HD-TILE/Hero/EXT/' + _properties.digAngle + '/vehicle.png';
        data.digImage = getUpdatedDigUrl(digUrl, veh);
        data.modelClass = 'model_' + config.idx;
        data.listItem = true;
        data.vinPrefixLabel = _properties.vinPrefixLabel;
        data.experience = experience;
        data.index = config.idx;
        data.titleTemplate = "{displayName}";
        data.url = '#';
        data.campaignUrl = '#';
        data.linkContext = {
            'year': veh && veh.year || '',
            'radius': '100'
        };

        data.vinUnavailableClass = '';
        data.vinUnavailableLabel = _properties.vinUnavailableLabel;
        data.showVinUnavailableCta = false;
        data.vinUnavailableCtaText = _properties.vinUnavailableCtaText;
        data.vinUnavailableAriaLabel = _properties.vinUnavailableAriaLabel;
        data.vinUnavailableClickAction = _properties.vinUnavailableClickAction;

        data.pricingContext = {
            'year': veh && veh.year || '',
            'model': veh && veh.model || ''
        };
        data.priceLabelKey = 'estimatedNet';
        data.isNetPrice = true;
        data.priceLabel = '';
        data.price = {};
        data.priceDisplay = {};
        data.infoIconText = _properties.infoIconText;
        data.infoIconClickAction = _properties.infoIconClickAction;
        data.priceDetailHeadline = _properties.priceDetailHeadline;
        data.priceTipData = {
            incentives: [],
            planTypes: {}
        };

        if(experience === 'triggered') {
            var currTile = _properties.currTriggerTile || {},
                campaign = currTile && currTile.campaignCode,
                ctaItems = currTile && currTile.ctaItems,
                ctaKey = 'inventoryItems';

            data.listItem = (config.idx !== 0);

            if(config.idx === 0) {
                if(veh.vin) {
                    if(!veh.present) {
                        data.vinUnavailableClass = 'vin-unavailable';
                        data.showVinUnavailableCta = true;
                    }
                    if(!veh.pricing) {
                        data.pricingContext.vin = veh.vin;
                        var paCode = veh.dealerPACode || veh.dealerPaCode || '';
                        if(paCode) {
                            data.pricingContext.dealerPACode = paCode;
                        }
                    }
                } else {
                    if(config._brandTriggerKey === 'BNP' && data.configToken) {
                        //NZ - If we're in a BNP experience we need to update the pricing context, but don't need to
                        //alter the priceLabelKey or the isNetPrice flag.
                        data.pricingContext.configToken = data.configToken;
                    } else {
                        data.priceLabelKey = 'startingAt';
                        data.isNetPrice = false;
                    }
                }

                data.ctaBtnStyle = _properties.triggeredItemBtnType;
                ctaKey = 'triggeredItem';

                data.url = (!data.showVinUnavailableCta && config.returnURL) || '#$siresults';

                if(campaign) {
                    campaign = campaign.replace('{nameplate}', veh.model.toLowerCase());
                    var campaignObj = util.str.toObject(campaign);
                    var urlObj = util.url.urlObject(data.url);
                    urlObj.qs.add(campaignObj);
                    data.campaignUrl = urlObj.url();
                } else {
                    data.campaignUrl = data.url;
                }

                if(currTile && currTile.triggeredItemTitle) {
                    data.titleTemplate = currTile.triggeredItemTitle;
                }

            } else {
                data.ctaBtnStyle = _properties.inventoryItemsBtnType;

                var urlObj = createDetailsLink(veh, campaign || '');
                data.url = urlObj.url || '#';
                data.campaignUrl = urlObj.campaignUrl || '#';
            }

            var ctaItem = ctaItems && ctaItems[ctaKey] || {};
            if(!_.isEmpty(ctaItem)) {
                data.ctaLabel = ctaItem.text || '';
                data.ctaAriaLabel = ctaItem.ariaLabel || '';
                data.ctaClickAction = ctaItem.clickAction || '';
            }

        } else {
            var vehData = {};
            if(_properties.defaultVehicleTiles && _properties.defaultVehicleTiles.length > 0) {
                if(config.idx >= 0 && _properties.defaultVehicleTiles[config.idx]) {
                    vehData = _properties.defaultVehicleTiles[config.idx];
                }
            }

            if(!_.isEmpty(vehData)) {
                data.ctaLabel = vehData.ctaText;
                data.ctaAriaLabel = vehData.ctaAriaLabel || '';
                data.ctaClickAction = vehData.ctaClickAction || '';
            }


            data.ctaBtnStyle = _properties.defaultBtnType;
            var urlObj = createDetailsLink(veh, _properties.defaultCampaignCode || '');
            data.url = urlObj.url || '#';
            data.campaignUrl = urlObj.campaignUrl || '#';

        }

        if(data.dealerDistance) {
            data.dealerDistanceDisplay = '(' + data.dealerDistance + ' ' + _dealerDistanceUnits + ')';
        }

        data.showCtaIcon = !!(data.ctaBtnStyle == 'btn-icon' || data.ctaBtnStyle == 'btn-icon-light' || data.ctaBtnStyle === 'btn-icon-light-alt');

        if(data.titleTemplate) {
            // BRAND-15880: Add logic to replace the {displayName} placeholder with the displayName value if found
            // within the titleTemplate. The {year}, {model}, and {trim} placeholders should no longer be used, but I
            // left the logic to replace them in place so they aren't output to the screen as placeholders if they
            // are still authored.
            data.title = data.titleTemplate.replace('{year}', data.year || '')
                                           .replace('{model}', data.model || '')
                                           .replace('{trim}', data.trim || '')
                                           .replace('{displayName}', data.displayName || '');

        }

        data.priceDisclosure = _pricingDisclosures[data.priceLabelKey] || '';

        if(veh && veh.trim) {
            data.linkContext.trim = veh.trim;
            if(!(data.pricingContext.vin || data.pricingContext.configToken)) {
                data.pricingContext.trimId = veh.trim;
            }
        }
        data.strLinkContext = JSON.stringify(data.linkContext);
        data.strPricingContext = JSON.stringify(data.pricingContext);
        if(data.isNetPrice && data.pricing) {
            data.priceInResponse = true;
            data.priceLabel = brand.Pricing.label(_pricingLabels[data.priceLabelKey] || {}, data.pricing);
            data.price = _.assign({}, brand.Pricing.price(data.pricing));
            _.forEach(data.price, function(val, key) {
                data.priceDisplay[key] = brand.Pricing.format(val);
            });

            //Setup data for price tooltip:
            var planId = brand.Pricing.planId(data.pricing);
            data.priceTipData = {
                basePrice: data.priceDisplay.base,
                options: data.priceDisplay.options,
                destinationCharges: brand.Pricing.format(data.destinationCharge),
                sellingPrice: data.priceDisplay.total,
                totalIncentives: brand.Pricing.format(data.incentiveTotal),
                price: data.priceDisplay.net,
                showFriendsAndNeighbors: false,
                incentives: [],
                planId: planId,
                planTypes: {
                    'msrp': (planId === 'msrp'),
                    'az': (planId === 'az'),
                    'x': (planId === 'x')
                }
            };
            if(data.incentives) {
                _.forEach(data.incentives, function(itm) {
                    itm.amount = brand.Pricing.format(itm.amount);
                    itm.offerValidRange = itm.startDate + '-' + itm.expiryDate;
                    //util.dateTime.longFormat(itm.startDate) + '-' + util.dateTime.longFormat(itm.expiryDate);
                    data.priceTipData.incentives.push(itm);
                });
            }

        } else {
            data.priceInResponse = false;
            data.pricingLabelObj = _pricingLabels[data.priceLabelKey] || {};
            data.strPricingLabelList = JSON.stringify(data.pricingLabelObj);
            data.pricingLabelTemplate = "{pricingLabel} {price}";
        }


        return data;
    }

    function getUpdatedDigUrl(currentUrl, veh) {
        var output = currentUrl;

        if(veh) {
            if(veh.imageToken) {
                output = output.replace('/Hero/', '/'+encodeURIComponent(decodeURIComponent(veh.imageToken))+'/');
            } else if(veh.vin) {
                output = output.replace('/Hero/', '/'+encodeURIComponent('Vin[' + decodeURIComponent(veh.vin) + ']')+'/');
            } else if(veh.configToken) {
                output = output.replace('/Hero/', '/' + encodeURIComponent(decodeURIComponent(veh.configToken)) + '/');
            }
        }
        return output;
    }

    function createDetailsLink(veh, campaign) {
        var url = [baseSingUrl],
            qs = util.url.queryString(' '),
            output = {};
        if(veh) {
            url.push(
                veh.model.toLowerCase(),
                '/details/',
                veh.vin
            );
            qs.add('zipcode', user.location.current().postalCode);
            if(veh.dealerPaCode) {
                qs.add('ownerPACode', veh.dealerPaCode);
            }
            if(veh.year) {
                qs.add('year', veh.year);
            }
        }
        var urlStr = url.join('');
        output.url = urlStr + qs.asString();
        if(campaign && veh) {
            campaign = campaign.replace('{nameplate}', veh.model.toLowerCase());
            var campaignObj = util.str.toObject(campaign);
            qs.add(campaignObj);
            output.campaignUrl = urlStr + qs.asString();
        } else {
            output.campaignUrl = output.url;
        }
        return output;
    }

    function handlePriceResponse(el) {
        var $el = $(el),
            priceEl = $el.find('.pricing.price-not-in-response'),
            $iballEl = $el.find('.icon-info.price-not-in-response');

        if(priceEl && priceEl.length > 0) {
            var priceDetail = priceEl.data('pricing');

            if(priceDetail) {
                if($iballEl && $iballEl.length > 0) {
                    var $priceWrap = priceEl.closest('.make-info.price');
                    var pricingData = brand.Pricing.formatPriceTipData(priceDetail);
                    setPriceTipInfo($priceWrap, $iballEl, pricingData);
                }
            } else {
                var priceText = (priceEl.text() || '').trim();
                var priceTemp = (priceEl.attr('data-pricing-template') || '').trim();
                if(priceText === priceTemp) {
                    priceEl.addClass('hidden').siblings('.disclosure').addClass('hidden');
                }
            }
        }
    }

    function setPriceTipInfo($priceWrap, $iballEl, pricingData) {
        if($priceWrap && $priceWrap.length > 0 && $iballEl && $iballEl.length > 0 && pricingData) {
            var priceTipData = { pricingData: pricingData || {} };
            var $priceTipEl = $(templates.priceDetailFlyout(priceTipData)).data('pricingData', pricingData);
            var $tipEl = $priceWrap.find('.price-tip');
            $tipEl.data('price-tip-content', $priceTipEl.html());
            $iballEl.removeClass('hidden');
        }
    }

    function getPageType() {
        if (!_pageType) {
            switch(ctx.pageType || '') {
                case 'VehicleModelsDetailPage':
                case 'VehicleModelsDetailPageBlackLabel':
                    _pageType = 'modeldetail';
                    break;
                case 'VehicleHomePage':
                case 'VehicleHomePageBlackLabel':
                default:
                    _pageType = 'vhp';
                    break;
            }
        }
        return _pageType;
    }

    function impressionDataPrefix() {
        return [
            mtx && mtx.getParameter('$sitePrefix') || '',
            getPageType(),
            _properties.triggerType || ''
        ].join('-');
    }

    function vehicleImpressionData(veh) {
        if (!veh || _.isEmpty(veh)) {
            return '';
        }
        var output = [
            'liyml' + (veh.index + 1),
            veh.year,
            veh.metricsName || veh.model || ''
        ];
        if (veh.trim) {
            output.push(veh.trim);
        }
        return output.join(':');
    }

    function setImpressionData(data) {
        var dataStr = _.filter((data || []), function(itm) {
                return (itm);
            }).join('|').toLowerCase(),
            domain = ctx.settings['siteCookieDomain' + ctx.make];
        util.cookie.set('liyml_details', dataStr, {
            encodeValue: true,
            path: '/',
            domain: ((domain || '') == '') ? null : domain
        });
    }

    function renderVehicleItems(items, experience) {
        var firstSelector = (experience === 'triggered') ? '.triggered-exp-section.triggered-tile-section' : '.default-layout .liyml-models',
            additionalSelector = (experience === 'triggered') ? '.triggered-exp-section.local-inventory-section .triggered-layout .liyml-models' : '.default-layout .liyml-models',
            $firstContainer = $(firstSelector, components),
            $additionalContainer = $(additionalSelector, components),
            itemCount = 0,
            impressionData = [impressionDataPrefix(), null, null, null];

        _.each(items, function(item, idx) {
            var data = { vehicle: item },
                $vehicleItem = $(templates.vehicleItem(data));
            if($vehicleItem && $vehicleItem.length) {
                var $modelImg = $vehicleItem.find('.model-img');
                var $img = $modelImg.find('img');
                if(!($img.hasClass('lazyloaded') || $img.hasClass('lazyloading'))) {
                    $img.on('load', function (ev) {
                        $modelImg.find('.image-loader-svg').addClass('hidden');
                    });
                    $img.on('error', function() {
                        $modelImg.find('.image-loader-svg').addClass('hidden');
                    });
                } else {
                    $modelImg.find('.image-loader-svg').addClass('hidden');
                }

                var $priceWrap = $vehicleItem.find('.make-info.price');
                var $iballEl = $priceWrap.find('.icon-info.price-in-response');
                setPriceTipInfo($priceWrap, $iballEl, item.priceTipData);

                var $container = (idx === 'vehicle0') ? $firstContainer : $additionalContainer;
                $container.append($vehicleItem);
                // NZ: The items aren't necessarily stored in order, so utilize the index property of each item instead
                // of the itemCount value as its placement in the impressionData array, incrementing 1 to account for the
                // impression data prefix.
                impressionData[(item.index + 1)] = vehicleImpressionData(item);
                itemCount++;
            }
        });

        var discLabelPrefix = (ctx.accessibility && ctx.accessibility.disclosureLabelPrefix) || '';
        $('sup[data-vdm-disc]', components).each(function(){
            var $el = $(this),
                discLabel = discLabelPrefix + ' ' + $el.text();
            $el.attr({
                'tabindex': '0',
                'role': 'button',
                'data-fgx-keypress': 'true',
                'aria-label': discLabel
            });
        });

        if(experience === 'default') {
            // NZ - itemCount shouldn't be over 3 ever, so retrict it to 3 if so some reason it is above
            if(itemCount > 3) {
                itemCount = 3;
            }
            $('.default-exp-container .liyml-models', components).addClass(_listSizeClasses[itemCount] || '');
        }

        $('[data-fgx-view-id="' + experience + '"]', components).removeClass('hidden');

        components.removeClass('hidden');

        setImpressionData(impressionData);

        brand.User.location.subscribe(function() {
            components.each(function() {
                var _this = this;
                brand.Pricing.refresh(this, true).done(function(templates){
                    handlePriceResponse(_this);
                });
            });
        });

    }

})(jQuery, FD.Brand.lodash, window, FD.Brand, FD.Brand.User, FD.Brand.Util, FD.Brand.Context, FD.Brand.NgpServices, FD.Brand.Metrics);
;(function($, brand) {

    brand.setInitHandler('[data-fgx-compare-vehicles]', init);

    /////////////

    function init(components) {

        var mql = window.matchMedia('(min-width: 768px)');

        $('.toggle-collapse a', components).click(function () {
            var $elm = $(this);
            var $compVehicles = $elm.closest('.compare-vehicles');
            $compVehicles.toggleClass('expanded');

            //Metrics - POC
            if($compVehicles.hasClass('expanded')) {
                brand.Metrics.handler.direct($elm.attr('data-fd-metrics-expand'));
            }
        });

        // Set the interval to false for carousel
        $('.carousel', components).each(function () {
            $(this).carousel({interval: false});
        });
        $('.carousel', components).each(function () {
	        FD.Brand.Util.carousel.swipe(this, swipe);
        });
        
        function updateAriaPressed() {
            $('.carousel .carousel-indicators li', components).each(function() {
                var $el = $(this);
                $el.attr('aria-pressed', $el.hasClass('active'));
            });
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, direction
        function swipe(elm, dir, ev) {
            // only perform the swipe if the screen is smaller than 768px wide.
            if (!mql.matches) {
                $(elm).carousel(dir);
                setTimeout(updateAriaPressed, 250);

                //Metrics - POC
                scrollAction.call(elm);
            }
        }

        // activate a carousel slide when one of the indicators is clicked.
        $('.carousel .carousel-indicators li', components).click(function () {
            //var goToId = parseInt($(this).data("slideTo"), 10);
            var goToId = $(this).data("slideTo");

            $(this).parent().parent('.carousel').carousel(goToId);
            updateAriaPressed();

            //Metrics - POC
            scrollAction.call(this);
        });

        window.FD.Brand.Dig.resolve($('.vehicles.list-inline'));
        components.each(function () {
            FD.Brand.Pricing.refresh(this)
        });

        //Metrics - POC
        function scrollAction() {
            brand.Metrics.handler.direct($(this).closest('[data-fgx-compare-vehicles]').attr('data-fd-metrics-scroll'));
        }
    }

})(jQuery, FD.Brand);

;(function($, win, _, brand, ctx, link, util, user){

    brand.setInitHandler('[data-fgx-brochures-and-guides]', init);

    function init(components) {

        if(components.length == 0) {
            return;
        }

        var initialized = false;
        var activeAnchor = null;
        var _golfForm = null;
        var getBrochureSuccessEmailAction = $(components).attr('data-fd-brochure-success-email');
        var getBrochureSuccessMailAction = $(components).attr('data-fd-brochure-success-mail');
        var getBrochureSuccessBothAction = $(components).attr('data-fd-brochure-success-both');
        var _settings = ctx && ctx.settings;
        var _ngpApiKey = _settings && _settings.brochuresApiKey || '';
        var _npId = ctx && ctx.nameplate && ctx.nameplate.id || '';
        var $brochureSelect = $('.brochure-select-container', components);
        var $brochureDefaultOpt = $brochureSelect.find('option[data-custom-value="'+ _npId +'"]');
        var _emailOnlyInForm = !!(ctx && ctx.make === 'Lincoln' && ctx.region === 'US');

        window.FD.Brand.Dig.resolve(components);

        if(win.FD.Pantry && win.FD.Pantry.Golf) {
            FD.Pantry.Golf.initialized().done(function() {
                _golfForm = FD.Pantry.Golf.getForm('getUpdatesBrochures');
            });
        }

        //NGBS3-6488: Pre-populate main model name as default option
        if (_npId && $brochureDefaultOpt && $brochureDefaultOpt.length > 0) {
            $brochureSelect.val(_npId);
            updateSelectData($brochureSelect, $brochureDefaultOpt);
        }

        // monitor hash changes
        if(win.addEventListener) {
            win.addEventListener('hashchange', anchorCheck);
        } else {
            // IE8 fallback
            win.onhashchange = anchorCheck;
        }
        anchorCheck();

        var getBrochureFormCallback = function(eventName, config) {
            // Get Updates form events
            switch (eventName) {
                case 'SubmissionSucceeded':
                    // metrics call for successful submission
                    var req = config && config.request;
                    if(req) {
                        var isEmail = req.email,
                            isMail = req.mail,
                            nameplate = util.str.firstInstance(req.mtxName, ';'),
                            year = util.str.firstInstance(req.year, ';'),
                            mtxAction;

                        if(typeof(isEmail) == 'undefined' || !isEmail) {
                            isEmail = 0;
                        }
                        if(typeof(isMail) == 'undefined' || !isMail) {
                            isMail = 0;
                        }

                        if((ctx.region === 'CA' || _emailOnlyInForm) || (isEmail == 1 && isMail == 0)) {
                            mtxAction = getBrochureSuccessEmailAction;
                        } else if(isEmail == 1 && isMail == 1) {
                            mtxAction = getBrochureSuccessBothAction;
                        } else {
                            mtxAction = getBrochureSuccessMailAction;
                        }

                        if(mtxAction && typeof(mtxAction) != 'undefined') {
                            FD.Brand.Metrics.handler.direct(
                                mtxAction, {
                                    $$getUpdatesNameplate: nameplate,
                                    $$getUpdatesYear: year,
                                    $$brochuresTab: 'brochures',
                                    $section: 'brochures'
                                }
                            );
                        }

                        scrollToForm($('.brochures-form-wrapper', components));
                    }
                    break;
            }
        };
       
        $('.tab-label', components).click(function() {
            switchTabs.call(this);
        });

        $('.fgx-brand-select-container', components).on('change', function(ev) {
            updateSelected($(this));
        });

        $('.brochure-method', components).click(function(ev) {
            ev.preventDefault();
            var $el = $(this);
            util.swapColors.call($el);
            $el.toggleClass('selected');
            var formEl = $('#getUpdatesBrochures', components);
            var rowEl = $('.other-methods', components);
            var formWrapper = $('.brochures-form-wrapper', components);
            var mailSelected = $('.brochure-method.mail', components).hasClass('selected');
            var emailSelected = $('.brochure-method.email', components).hasClass('selected');
            var brochureContent = $el.closest('.brochure-content');
            var $selected = brochureContent.find('.brochure-select-container');
            var year = $selected.data('modelYear') || '';
            var modelDisplayName = $selected.data('modelDisplayName') || '';

            if (_golfForm != null && _golfForm != undefined) {
                var config = {
                    model: (modelDisplayName) ? modelDisplayName : (ctx.nameplate && ctx.nameplate.ngpModelName),
                    year: (year) ? year : (ctx.nameplate && ctx.nameplate.ngpYear),
                    postalCode: user.location.current().postalCode,
                    options: {
                        showEmailOnlyGU: !_emailOnlyInForm,
                        emailChecked: (_emailOnlyInForm || emailSelected),
                        mailChecked: (!_emailOnlyInForm && mailSelected),
                        emailOnlyBrochures: _emailOnlyInForm
                    }
                };

                // BRAND-17295 - don't pass the postalCode to the get updates form on Ford CA if it doesn't come from either the FPI cookie or user input.
                if (ctx.make === 'Ford' && ctx.region === 'CA' && _golfForm && _golfForm.formType === 'getupdates') {
                    var _location = user.location.current();
                    if (config.postalCode && (_location.postalCodeSource === 'Akamai' || _location.postalCodeSource === 'Default')) {
                        delete config.postalCode;
                    }
                }
                var eventCallback = FD.Brand.Form.formEventCallback(_golfForm, _golfForm.formType, getBrochureFormCallback);
                _golfForm.show(null, config, eventCallback);
                rowEl.hide();
                if (mailSelected || emailSelected) {
                    formWrapper.removeClass('hidden');
                } else {
                    formWrapper.addClass('hidden');
                }
            }
        });

        $('.download-btn', components).click(function(ev) {
            ev.preventDefault();
            var $el = $(this),
                $form = $el.closest('.brochure-content'),
                $selected = $form.find('.brochure-select-container'),
                $zip = $form.find('.zip-input'),
                data = {
                    make: ctx.make,
                    model: $selected.data('modelName'),
                    year: $selected.data('modelYear'),
                    api_key: _ngpApiKey || ''
                },
                qs = util.url.queryString(),
                url = '';
            //Remove the error if displayed.
            $form.removeClass('has-error');

            if(typeof(data.make) === 'undefined' || typeof(data.model) === 'undefined' || typeof(data.year) === 'undefined') {
                $form.addClass('has-error');
                return;
            }

            if($zip.length && $zip.val() !== 'undefined') {
                var pattern = (ctx.region && ctx.region === 'CA') ? "^[ABCEGHJKLMNPRSTVXY]{1}\\d{1}[A-Z]{1} *\\d{1}[A-Z]{1}\\d{1}$" : "^\\d{5}$",
                    val = $zip.val();

                if(validate(val, pattern)) {
                    data = _.extend(data, {postalCode: val});
                }
            }

            qs.add(data);

            url = [link.baseUrl('ngbs'),
                '/services/assets/Brochure',
                qs.asString()].join('');

            if(url) {
                win.open(url);
            }
        });

        function updateSelected($el) {
            if (!$el || $el.length === 0) {
                return;
            }
            var newVal = $el.val(),
                $opt = $el.find('option[data-custom-value="'+ newVal +'"]');
            if (newVal && $opt && $opt.length > 0) {
                var $form = $el.closest('.brochure-content');
                if($form.hasClass('has-error')) {
                    $form.removeClass('has-error');
                }
                updateSelectData($el, $opt);
            }
        }

        function updateSelectData($select, $opt) {
            $select
                .data({
                    "modelName": $opt.data('modelName') || '',
                    "modelYear": $opt.data('modelYear') || '',
                    "modelDisplayName": $opt.data('modelDisplayName') || ''
                });
        }

        function scrollToForm($form) {
            if(!$form || $form.length == 0) {
                return;
            }

            var $stickyNav = $('.navbar-static-top'),
                topOffset = $form.offset().top,
                scrollTo = ($stickyNav.length) ? (topOffset - $stickyNav.height()) : topOffset;

            $('html,body').animate({
              scrollTop: scrollTo
            }, 200);
        }

        function anchorCheck() {
            var anchorId = win.location.hash;
            var toggle = null;
            if (anchorId) {
                var anchor = anchorId.substr(1);
                // process hash
                if(activeAnchor === anchor) {
                    return;
                }
                var dataAttr = '[data-view="'+anchor+'"]';
                toggle = $(dataAttr, components);
            } /*else {
                // init the first section to open
                if (!initialized) {
                    toggle = $('.tab-label', components).first();
                }
            }*/

            if(toggle) {
                switchTabs.call(toggle);
                initialized = true;
            }
        }

        function switchTabs() {
            var view = $(this).attr('data-view');
            if(view) {
                if(!$(this).hasClass('selected')) {
                    // remove all 'selected' classes, then add to this object
                    $('.tab-label', components).removeClass('selected');
                    $('.tab-label', components).attr('aria-selected', 'false');
                    $(this).addClass('selected');
                    $(this).attr('aria-selected', 'true');
                    $('.content-section', components).removeClass('active');
                    $('.content-section.' + view, components).addClass('active');
                }
                updateHash(view);
            }
        }

        function updateHash(view) {
            if(view && ((activeAnchor && (view !== activeAnchor)) || !activeAnchor)) {
                win.location.hash = view;
                activeAnchor = view;
            }
        }
    }

    function validate(val, pattern) {
        if(pattern) {
            var regex = new RegExp(pattern, 'i');
            return regex.test(val);
        } else {
            return false;
        }
    }
   
})(jQuery, window, FD.Brand.lodash, FD.Brand, FD.Brand.Context, FD.Brand.Link, FD.Brand.Util, FD.Brand.User);

;(function($, brand, util) {

    brand.setInitHandler('[data-fgx-table-container]', init);

    /////////////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        var mql = window.matchMedia('(min-width: 768px)');
        mql.addListener(setAccordions);
        setAccordions(mql);

        $('.accordion-heading', components).on('click', function() {
            var bp = util.currentBreakpoint();
            if(bp === 'gux-bkpt-sm') {
                util.accordion.update($(this), components, ".accordion-heading", ".accordion-content", false, trackAccordionToggleClick);
            }
        });
        
        /**
         * Will C. - Callback method which allows metrics events to be handled after the accordion sections have been handled.
         * Not having this logic in a callback was causing odd race conditions where metrics were only being fired in certain scenarios.
         **/
        function trackAccordionToggleClick() {
            var $el = $(this);
            if ($el.hasClass('open')) {
                //Common Metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-open'),
                    $el
                );
            }
        }

        function setAccordions(mql) {
            if(mql.matches) {
                //On desktop
                $('.accordion-heading', components).attr('tabindex', '-1').removeAttr('role').removeAttr('aria-expanded');
                $('.accordion-content', components).removeClass('hidden');
            } else {
                //On mobile
                $('.accordion-heading', components).attr('tabindex', '0').attr('role', 'button').attr('data-fgx-keypress', 'true');
                $('.accordion-content', components).each(function() {
                    var $el = $(this);
                    $el.toggleClass('hidden', !($el.hasClass('open')));
                });
                $('.accordion-heading', components).each(function(){
                    var $el = $(this);
                    $el.attr('aria-expanded', $el.hasClass('open') ? 'true' : 'false');
                });
            }
        }
    }
    
})(jQuery, FD.Brand, FD.Brand.Util);
;(function($, brand) {

    brand.setInitHandler('[data-fgx-four-column-grid]', init);

    /////////////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        $('.col-text .inner table', components).each(function() {
            $(this).attr('role', 'presentation');
        });
    }
})(jQuery, FD.Brand);

/*global metrics*/
;(function($, win, ctx) {

    var previouslyShown = false,
        $indicatorarrow = $('.scroll-indicator'),
        adminMode = $('.scroll-indicator-admin').length,
        overlapInterval,
        $win = $(win);

    $(init);

    /////////////

    function init() {
        updateIndicator();

        // On window scroll - set previouslyShown to true if the scroll
        var scrollListener = function() {
            if ($win.scrollTop() > 199) {
                previouslyShown = true;
                updateIndicator();
                $win.off("scroll", scrollListener);
            }
        };

        var mtxActions = ctx && ctx.mtxActions;
        var scrollClickAction = mtxActions && mtxActions.scrollIndicatorClickAction || null;

        $win.on("scroll", scrollListener);

        //On window resize - Make sure we aren't overlapping anything we shouldn't be overlapping
        $win.resize(function() {
            if(!previouslyShown) {
                updateIndicator();
            }
        });

        // On indicator click - Scroll vertical size of the browser minus 60 pixels.
        $indicatorarrow.click(function() {
            var wHeight = $win.height();
            $("html, body").animate({
                scrollTop: (wHeight - 60)
            });
            previouslyShown = true;
            updateIndicator();

            // Common Metrics
            if (scrollClickAction) {
                FD.Brand.Metrics.handler.direct(
                    scrollClickAction
                );
            }
        });

        // If we're overlapping on load, move the arrow - only checks for billboard meatballs right now.
        // Since billboards take a bit to load, we watch for the 'shown' class to be added to the
        // meatballs. However, quit waiting after 4 seconds.
        var counter = 0;
        overlapInterval = setInterval(function() {
            var $meatballs = $('.billboard-container .carousel-indicators');
            counter++;
            if ($meatballs.length && counter < 5) {
                if($meatballs.hasClass("shown")) {
                    if (indicatorOverlap()) {
                        var amount = $meatballs.offset().top;
                        moveIndicator(amount);
                    }
                    clearInterval(overlapInterval);
                }
            } else {
                clearInterval(overlapInterval);
            }
        }, 1000);

    }

    // Update indicator visibility
    function updateIndicator() {
        // Make sure we keep the admin indicator
        if (adminMode) {
            $('.scroll-indicator-admin .scroll-indicator').show();
            return false;
        }

        if (showIndicator()) {
            $indicatorarrow.fadeIn('slow');
        } else {
            $indicatorarrow.fadeOut('slow');
        }
    }


    //Check if we should show indicator
    function showIndicator() {

        // Variables
        var wHeight = $win.height(),
            wWidth = $win.width();

        //Check if it has already been shown
        if(previouslyShown) {
            return false;
        }

        // Check if we are at/near the top of the page
        if( $win.scrollTop() > (wHeight / 2)) {
            return false;
        }

        // Visible area needs to be less then 900 height and more then 992 wide
        if (wHeight > 900 || wWidth < 992) {
            return false;
        }

        // Check if indicator is overlapping anything it shouldn't
        if (indicatorOverlap()) {
            return false;
        }

        // Check if we're on the admin page
        if (adminMode) {
            return false;
        }

        return true;

    }

    // Check if indicator is overlapping specific other items
    function indicatorOverlap(returnNum) {

        // Variables
        var hasOverlap = false,
            h1, w1, h2, w2;
        var x1 = y1 = b1 = r1 = x2 = y2 = b2 = r2 = 0;

        // If indicator is hidden, we cant calculate anything.. well need to set visibility, show it, calculate and go from there
        if (!$indicatorarrow.is(":visible")) {
            $indicatorarrow.addClass('invisible');
            $indicatorarrow.show();
        }

        // Indicator
        if ($indicatorarrow.length) {
            h1 = $indicatorarrow.outerHeight(true);
            w1 = $indicatorarrow.outerWidth(true);
            x1 = $indicatorarrow.offset().left;
            y1 = $indicatorarrow.offset().top;
            b1 = y1 + h1;
            r1 = x1 + w1;
        }

        // Check against billboard meatballs
        var $meatballs = $('.billboard-container .carousel-indicators.shown');
        if ($meatballs.length) {
            x2 = $meatballs.offset().left;
            y2 = $meatballs.offset().top;
            h2 = $meatballs.outerHeight(true);
            w2 = $meatballs.outerWidth(true);
            b2 = y2 + h2;
            r2 = x2 + w2;

            // Check Overlap (only meatballs for now)
            hasOverlap = (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) ? false : true;
        }


        //Check visibility
        if ($indicatorarrow.hasClass("invisible")) {
            $indicatorarrow.removeClass('invisible');
            $indicatorarrow.hide();
        }

        // Return top of meatballs so we can position indicator above it
        if (returnNum) {
            hasOverlap = $meatballs.offset().top;
        }

        return hasOverlap;
    }

    // Move the indicator since its overlapping something
    function moveIndicator(moveAmount) {
        if(!moveAmount) {
            return;
        }
        $indicatorarrow.animate({
            top: moveAmount - $indicatorarrow.outerHeight(true) - $win.scrollTop() - 10
        });
    }



})(jQuery, window, FD.Brand.Context);

/*global FD*/
/**
 * Postal Code Overlay
 */
(function(win, $, brand, ctx, overlay, user, ngp) {

    var ovr;
    var $inp;
    var $msg;
    var $icn;
    var $cta;
    var postalCodeValidate;
    var zipCodeChangeAction;
    var zipCodeOverlayOpenAction;
    var searchIsGeo = false;
    var errorShown = false;
    brand.setInitHandler('[data-fgx-postal-code-overlay]', init);

    //////

    function init(components) {
        var mtxActions = ctx && ctx.mtxActions;
        zipCodeChangeAction = mtxActions && mtxActions.zipCodeChangeAction || null;
        zipCodeOverlayOpenAction = mtxActions && mtxActions.zipCodeOverlayOpenAction || null;
        
        ovr = overlay.register('postalCodeOverlay', components, {
            show: function() {
                var _location = user.location.current(),
                    postalCode = _location && _location.postalCode,
                    geoPACode = _location && _location.geoPACode;
                if(postalCode) {
                    searchIsGeo = !!(geoPACode);
                    setPostalCode(postalCode, geoPACode || '');
                } else {
                    searchIsGeo = false;
                }
                initGeoIcon(brand.Util.env.geoLocation(), components);
                if (zipCodeOverlayOpenAction) {
                    FD.Brand.Metrics.handler.direct(
                        zipCodeOverlayOpenAction
                    );
                }
            }
        });

        $inp = $('#txt_zipCode', components);
        $msg = $('.zipcode-msg', components);
        $icn = $('.alert-icon', components);
        $cta = $('.postal-code-cta', components);

        $icn.hide();

        if(FD.Brand.Component && FD.Brand.Component.locateDealerConfig && FD.Brand.Component.locateDealerConfig.validationZipCode) {
            postalCodeValidate = new RegExp(FD.Brand.Component.locateDealerConfig.validationZipCode);
        }
        $('.icon-search', components).add($cta).click(submitPostalCode);
        $inp.click(function() {
            $inp.val('')
                .addClass('postal-code-textfield-context')
        }).focus(function() {
            $inp.select();
        }).keypress(function(ev) {
            if(ev.which === 13) {
                submitPostalCode();
                return false;
            } else if (errorShown) {
                updateError();
            }
        });
        $('.icon-close', components).click(function() {
            ovr.hide();
        });

        if($('#txt_zipCode')[0].value.length) {
            $(".center-rightside-content .postal-code-cta").addClass("text-entered");
        }

        $('#txt_zipCode').bind('input propertychange click', function() {
              searchIsGeo = false;

              if(this.value.length){
                $(".center-rightside-content .postal-code-cta").addClass("text-entered");
              } else {
                $(".center-rightside-content .postal-code-cta").removeClass("text-entered");
              }
        });
    }
    
    function initGeoIcon(geoEnabled, components) {
        $('.ico-geolocation', components).toggle(geoEnabled)
            .click(lookupGeoPostalCode);
    }

    function lookupGeoPostalCode() {
        if (win.navigator && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                ngp.dealers({
                    make: ctx.make,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                }).done(function(dealers) {
                    if(dealers.length > 0) {
                        searchIsGeo = true;
                        setPostalCode(dealers[0].Address.PostalCode, dealers[0].PACode);
                    }
                });
            }, function() {
                brand.Util.log("Postal Code Overlay - error retrieving the current position");
            });
        }
    }

    function setPostalCode(postalCode, geoPACode) {
        $inp.css({'color': '#000'})
            .val(postalCode);

        if(geoPACode) {
            $inp.attr('data-geo-pa-code', geoPACode);
        } else if($inp[0].hasAttribute('data-geo-pa-code')) {
            $inp.removeAttr('data-geo-pa-code');
        }
    }

    function validatePostalCode(postalCode) {
        return !postalCodeValidate || postalCodeValidate.test(postalCode);
    }

    function updatePostalCode(postalCode) {
        return $.Deferred(function (defer) {
            if(!validatePostalCode(postalCode)) {
                defer.reject('invalid');
            } else {
                var geoPACode = '';
                if(searchIsGeo) {
                    searchIsGeo = false;
                    geoPACode = $inp.attr('data-geo-pa-code') || '';
                }
                if(geoPACode || $inp[0].hasAttribute('data-geo-pa-code')) {
                    $inp.removeAttr('data-geo-pa-code');
                }
                ngp.location(postalCode).then(function() {
                    user.location.setPostalCode(postalCode, geoPACode || '');
                    defer.resolve(postalCode);
                }, function(resp) {
                    defer.reject(resp.status === 400 ? 'invalid' : 'error');
                });
            }
        }).promise();
    }

    function submitPostalCode() {
        updateError();
        updatePostalCode($inp.val()).then(function() {
            ovr.hide();
        }, function(err) {
            updateError($msg.attr('data-msg-' + err) || '');
        });
        if (zipCodeChangeAction) {
            FD.Brand.Metrics.handler.direct(
                zipCodeChangeAction
            );
        }
    }

    function updateError(err) {
        errorShown = !!(err);
        $msg.text(err || '');
        $msg.toggleClass('postalcode-error', errorShown);
        $icn.toggle(errorShown);
        $inp.attr('aria-invalid', errorShown);
    }

})(window, $, FD.Brand, FD.Brand.Context, FD.Brand.Overlay, FD.Brand.User, FD.Brand.NgpServices);


/*global FD*/
;(function (win, $, _, brand, overlay, video, util, ctx, discLib) {

    _.extend(FD.Brand.namespace('FD.Brand.MediaOverlay', win), {
        link: linkElement
    });

    var defaultConfig = {
    };
    var ovr;
    var $arrows;
    var $backArrow;
    var $nextArrow;
    var lastClickedArrowDirection;
    var deeplink;
    var components;
    var itemTemplate;
    var bcpItemTemplate;
    var anchorIds = {};
    var activeAnchor = null;
    var _intervalRefs = [];
    var aspectRatioList = {
        'ratio15-16': 1.06,
        'ratio1-1': 1.0,
        'ratio4-3': .75,
        'ratio16-9': .5625,
        'ratio3-2': .6666,
        'ratio7-3': .4285,
        'ratio2-1': .5
    };
    var _bcConfig = {};
    var _currTitleStyle = '';
    var settings = ctx && ctx.settings;
    var _mtxBcpVidSegments = {
        'videoStart': {
        },
        'videoSegment25': {
            videoNamePercentageWatched: '25% complete'
        },
        'videoSegment50': {
            videoNamePercentageWatched: '50% complete'
        },
        'videoSegment75': {
            videoNamePercentageWatched: '75% complete'
        },
        'videoComplete': {
            videoNamePercentageWatched: 'video complete'
        }
    };
    var _baseVideoConfig = {
        brightcove: {
            _bcpBaseConfig: {
                'placeHolderDivId': 'fgx-media-overlay-bc-player-container',
                'isYoutube': false,
                'showFilmstripToggle': true,
                'autoPlay': true
            },
            _brandConfig: {
                'fgxInstanceId': 'mediaOverlayBC',
                'fgxSetupSlideItem': true,
                'slideItemClass': 'fgx-media-overlay-brightcove-item',
                'slideHeadlineId': 'fgx-media-overlay-bc-item-headline'
            },
            slidesSelector: '.video-carousel-inner',
            carouselTypeClass: 'fgx-brand-brightcove-carousel',
            swipeInitialized: false
        },
        youtube: {
            _bcpBaseConfig: {
                'placeHolderDivId': 'fgx-media-overlay-yt-player-container',
                'isYoutube': true,
                'autoPlay': true
            },
            _brandConfig: {
                'fgxInstanceId': 'mediaOverlayYT',
                'fgxSetupSlideItem': true,
                'slideItemClass': 'fgx-media-overlay-youtube-item',
                'slideHeadlineId': 'fgx-media-overlay-yt-item-headline'
            },
            slidesSelector: '.yt-video-carousel-inner',
            carouselTypeClass: 'fgx-brand-youtube-carousel',
            swipeInitialized: false
        }
    };
    var _videoOverlayLoading = false;

    // return image source config to match legacy overlay behavior (primary image, use 1280 rendition)
    function legacyImageOverride(image) {
        var output = null;
        if(image && image.primaryImage) {
            output = [{
                breakpoint: 0,
                // if our image is a TIF file, it's being served by Dynamic Media, and thus will not have the default rendition
                src: (image.primaryImage.indexOf('.tif') != -1 || 
                      image.primaryImage.indexOf('.TIF') != -1 || 
                      image.primaryImage.indexOf('.tiff') != -1 || 
                      image.primaryImage.indexOf('.TIFF') != -1) ? image.primaryImage : util.images.renditionUrl(image.primaryImage, 'cq5dam.web.1280.1280.jpeg')
            }];
        }
        return output;
    }

    brand.setInitHandler('[data-fgx-media-overlay]', init);

    /////////////

    function init(components) {

        if (ctx.settings.deepLink && (ctx.settings.deepLink.indexOf('/image') == 0 || ctx.settings.deepLink.indexOf('/video') == 0)) {
            // if we have a video or image deeplink, make sure we pop the overlay and update our hash
            deeplink = ctx.settings.deepLink.split('/')[2];
            win.location.hash = deeplink;
        }

        ovr = overlay.register('mediaOverlay', components, {
            show: function() {

                var carousel = ovr.$el.find('.carousel');
                var active = carousel.find('.active');
                var config = active.data('config');
                updatePositions();
            },
            hide: function() {
                var carousel = ovr.$el.find('.carousel');
                carousel.toggleClass('fgx-brand-text-only-carousel', false);
                // BRAND-15577 - call updateAriaLabelledById with no parameter to reset the aria-labelledby attribute when the overlay is closed.
                updateAriaLabelledById();
                resetPaginationAriaLabel(carousel);
                updateHash(null);
                stopVideo();
            }
        });
        var _hasTouch = util.env.touch();
        $('.icon-close', components).on('click', function() {
            ovr.hide();
        });
        itemTemplate = _.template($('script[data-fgx-media-overlay-item]').html());
        //BCP Update - Create one template for use with the BCP since both Brightcove and Youtube videos are setup to utilize it.
        bcpItemTemplate = _.template($('script[data-fgx-media-overlay-bcp-item]').html());

        // carousel arrow clicks
        $arrows = $('.carousel-arrows.global-arrows', components);
        $backArrow = $('.carousel-arrows.global-arrows.carousel-left', components);
        $nextArrow = $('.carousel-arrows.global-arrows.carousel-right', components);
        $('div', $arrows).click(function(ev) {
            ev.preventDefault();
            lastClickedArrowDirection = ($(this).is('.carousel-next')) ? 'next' : 'prev';
            advanceCarousel(lastClickedArrowDirection);
        });
        // carousel arrow hover
        $(components).on('mouseenter', '.has-list .image-wrapper, .has-list .video-wrapper', function() {
            $nextArrow.animate({ right: '0px' }, 'fast');
            $backArrow.animate({ left: '0px' }, 'fast');
        }).on('mouseenter', '.carousel-caption-media-overlay, .bcc-carousel-content', function() {
            $nextArrow.animate({ right: '-70px' }, 'fast');
            $backArrow.animate({ left: '-70px' }, 'fast');
        });
        // carousel arrows adjust for keyboard focus (avoids pushing the image over when tabbing to arrows)
        // Note: animation here caused odd and unexpected results, hence changing it to plain CSS.
        $arrows.on('focusin', function() {
            $nextArrow.css('right', '0px');
            $backArrow.css('left', '0px');
        }).on('focusout', function() {
            $nextArrow.css('right', '');
            $backArrow.css('left', '');
        });
        // add image expand events
        $(components).on('click', '.img-expand', function(ev) {
            var $carousel = ovr.$el.find('.carousel');
            var active = $carousel.find('.active');
            var config = active.data('config');
            var ovrExpand = {
                $el: $('.img-expanded'),
                hide: function() {
                    $('.imgExpand-close').trigger('click');
                }
            };
            $('.img-expanded-container').empty().append(util.images.renderPicture(config.image, 'FullScreen', legacyImageOverride(config.image)));
            $('.img-expanded-footer-content').html(config.headline);
            ovrExpand.$el.fadeIn(400, function() {
                overlay.trapFocus(ovrExpand, '.imgExpand-close', '.imgExpand-close', ev.target);
            });
            $('body').addClass('no-scroll');
            fireOverlayMetricAction('imageExpand');
        });

        components.each(function() {
            /* BCP Update - need to prevent the carousel swipe from being recorded twice on mobile when using brightcove
             * plugin, so setup the hammer logic on the carousel-inner element for the standard overlay instead of on the
             * container as a whole. This allows us to setup the hammer logic on the text section of the overlay for videos
             */
            var $imgSlideContainer = $(this).find('.carousel-inner');
            setupSwipe($imgSlideContainer[0]);
        });
        // this is outside of the scope of 'components' so must be treated differently.
        $('.imgExpand-close').click(function() {
            $('.img-expanded').fadeOut();
            $('body').removeClass('no-scroll');
            var ovrExpand = {
                $el: $('.img-expanded'),
                lastFocus: $('.img-expand', components)
            };
            overlay.releaseFocus(ovrExpand);
        });
        // monitor hash changes
        if(win.addEventListener) {
            win.addEventListener('hashchange', anchorCheck);
        } else {
            // IE8 fallback
            win.onhashchange = anchorCheck;
        }
        // update on carousel slide changes
        $(components).on('slid.bs.carousel', '.carousel', function() {
            updateSelected();
        });

        $(window).resize(function() {
            updatePositions();
        });

        /*
        // show video player
        $(components).on('click', '.image-wrapper', function(ev) {
            var $el = $(this).closest('.item');
            var idx = $el.data('video-idx');
            if(_.isNumber(idx)) {
                ev.preventDefault();
                var lst = $el.data('videos');
                var vid = lst[idx];
                video.launch({
                    videos: lst,
                    playIndex: idx,
                    autoPlay: true,
                    showSaveButton: false, //vid.canSave,
                    showShareButton: false //vid.canShare,
                });
            }
        });
        */

    }

    function swipeHandler(el, dir) {
        var breakPoint = util.currentBreakpoint();
        if(breakPoint === 'gux-bkpt-sm' || breakPoint === 'gux-bkpt-med' || _hasTouch) {
            advanceCarousel(dir);
        }
    }

    function setupSwipe(el) {
        if (!el) {
            return;
        }
        FD.Brand.Util.carousel.swipe(el, swipeHandler);
    }

    function resolveItemConfig($el, cfg, groupConfig) {
        var itemConfig = $el.attr('data-overlay-item');
        var config = _.extend({}, defaultConfig,
            groupConfig && JSON.parse(groupConfig) || {},
            itemConfig && JSON.parse(itemConfig) || {},
            cfg);
        config.headline = config.headline || '&nbsp;';
        return config;
    }

    function linkElement(element) {
        $('[data-overlay-item]', $(element)).each(function() {
            var $el = $(this);
            if(!_.isArray($el.data('overlay-idx'))) {
                linkOverlay($el);
            }
        });
        anchorCheck();
    }

    function linkOverlay($el, cfg) {
        var items = [];
        var videoConfig = {
            bcpItems: [],
            items: []
        };
        var ytVideoConfig = {
            bcpItems: [],
            items: []
        };
        var $dynamicDisc = $el.closest('[data-dynamic-disclosure-enable]').find('.dynamic-disclosures');
        var $grp = $el.closest('[data-overlay-group]');
        var grp = $grp.attr('data-overlay-group');
        var externalBaseUrl = ctx && ctx.externalizedUrl || '';
        var siteDomain = ctx && ctx.siteDomain || '';
        if (siteDomain.charAt(siteDomain.length - 1) === "/") {
            siteDomain = siteDomain.slice(0, -1);
        }
        (($grp.length > 0) ? $grp.find('[data-overlay-item]') : $el).each(function(idx, itemEl) {
            var $item = $(itemEl);
            var item = resolveItemConfig($item, cfg, grp);
            // NZ: canShare, canSave, and canDownload should no longer be used anywhere, but statically setting
            // those properties to false here so they're available in the item (while still being disabled) in case they
            // were missed anywhere during the removal process.
            item.canShare = false;
            item.canSave = false;
            item.canDownload = false;

            var mediaType = 'video';

            item.dynamicDisc = {
                display: false,
                content: ''
            };
            if($dynamicDisc.length) {
                item.dynamicDisc.display = true;
                item.dynamicDisc.content = $dynamicDisc.html();
            }

            if(item.image) {
                item.accLabel = item.image.altTag || '';
            }

            if(item.ytVideoId) {
                var videoIdx = ytVideoConfig.items.length;
                $item.data('overlay-idx', ['y', videoIdx]);
                item.videoId = item.ytVideoId;

                //NZ - at this time YT videos can't be downloaded, so always ensure the download link is hidden for them.
                item.canDownload = false;

                //NZ - BRAND-14435 - The footer section was only implemented for the image overlay, so ensure its hidden for Videos
                item.displayFooter = false;

                ytVideoConfig.items.push({
                    videoId: item.videoId,
                    videoTitle: item.headline,
                    titleStyle: item.headlineStyle,
                    videoDescription: item.description,
                    videoThumbnail: item.videoThumbnail,
                    disclaimerText: item.disclosures,
                    anchorId: item.anchorId,
                    actions: item.actions,
                    ctas: item.ctas,
                    expandDetails: item.expandDetails || false,
                    index: videoIdx,
                    dynamicDisc: item.dynamicDisc,
                    canShare: item.canShare,
                    canSave: false,
                    canDownload: item.canDownload || false,
                    displayFooter: item.displayFooter,
                    encodedTitle: util.htmlString.encode(item.headline),
                    accLabel: item.headline || ''
                });
                ytVideoConfig.bcpItems.push(item.videoId);
            } else if(item.videoId) {
                var videoIdx = videoConfig.items.length;
                $item.data('overlay-idx', ['v', videoIdx]);

                //NZ - BRAND-14435 - The footer section was only implemented for the image overlay, so ensure its hidden for Videos
                item.displayFooter = false;

                videoConfig.items.push({
                    videoId: item.videoId,
                    videoTitle: item.headline,
                    titleStyle: item.headlineStyle,
                    videoDescription: item.description,
                    videoThumbnail: item.videoThumbnail,
                    disclaimerText: item.disclosures,
                    anchorId: item.anchorId,
                    actions: item.actions,
                    ctas: item.ctas,
                    expandDetails: item.expandDetails || false,
                    index: videoIdx,
                    dynamicDisc: item.dynamicDisc,
                    canShare: item.canShare,
                    canSave: false,
                    canDownload: item.canDownload || false,
                    displayFooter: item.displayFooter,
                    encodedTitle: util.htmlString.encode(item.headline),
                    accLabel: item.headline || ''
                });
                var bcpVidData = {
                    videoId: item.videoId,
                    videoTitle: item.headline
                    /*videoThumbnail: item.videoThumbnail*/
                };
                videoConfig.bcpItems.push(bcpVidData);
            } else {
                var itemIdx = items.length;
                $item.data('overlay-idx', ['i', itemIdx]);
                mediaType = 'image';
                item.slideHeadlineId = 'fgx-media-overlay-img-item-headline-' + itemIdx;
                items.push(item);
            }
            var $trigger = $item.find('[data-overlay-item-trigger]');
            if($trigger.length > 0) {
                var sel = $trigger.attr('data-overlay-item-trigger');
                if(sel) {
                    $trigger = $(sel, $item);
                }
            } else {
                $trigger = $item;
            }
            if(item.anchorId) {
                anchorIds[item.anchorId] = [$(this), items, videoConfig, ytVideoConfig, item.anchorId, item.videoId];
            }
            $trigger.off('click.fgxMediaOverlay').on('click.fgxMediaOverlay', function(ev) {
                ev.preventDefault();
                showOverlay($(this), items, videoConfig, ytVideoConfig, item.anchorId);
            });
        });
    }

    function showOverlay($el, items, videoConfig, ytVideoConfig) {
        var idx = $el.data('overlay-idx');
        switch(idx[0]) {
            case 'v':
                showVideoOverlay($el, videoConfig, idx[1], 'brightcove');
                break;
            case 'i':
                var $ovr = ovr.$el;
                var $carousel = $ovr.find('.carousel');
                var $slides = $carousel.find('.carousel-inner');
                $slides.empty();
                _.each(items, function(item, i) {
                    // NZ - BRAND-14435 - Put this here so its only run the first time an item within the
                    // overlay group is opened instead of being run once for every overlay item on pageLoad.
                    if (item.displayFooter && !item.footerInitialized) {
                        item.linkContextStr = (item.footerConfigToken) ? JSON.stringify({ "configToken": item.footerConfigToken }) : "{ }";
                        if (!_.isEmpty(item.footerCtas)) {
                            _.each(item.footerCtas, function(itm) {
                                var btnType = itm.btnClass;
                                itm.showIcon = !!(btnType == 'btn-icon' || btnType == 'btn-icon-light' || btnType == 'btn-icon-light-alt');
                            });
                        }
                        item.footerInitialized = true;
                    }

                    var $item = $(itemTemplate({
                        index: i,
                        count: items.length,
                        item: item,
                        picture: FD.Brand.Util.images.renderPicture(item.image, 'Overlay', legacyImageOverride(item.image), true).html()
                    }));

                    $item.data('config', item);
                    if(i === idx[1]) {
                        $item.addClass('active');
                    }
                    $item.appendTo($slides);
                });
                $ovr.data('actions',  items[idx[1]].actions);
                $carousel.toggleClass('has-list', items.length > 1);
                $carousel.carousel({ interval: false });
                $carousel.carousel(idx[1]);
                updateSelected();
                util.images.load($slides);
                initTextOnlyArrows();
                ovr.show(true, $el, '.close-overlay');
                break;
            case 'y':
                showVideoOverlay($el, ytVideoConfig, idx[1], 'youtube');
                break;
        }

        if (typeof FD.Brand.Disclosures != 'undefined') {
            FD.Brand.Disclosures.updateDisclosures(ovr.$el);
        }
    }

    function showVideoOverlay($el, videoConfig, _idx, type) {
        if (_videoOverlayLoading) {
            return;
        }
        _videoOverlayLoading = true;
        var baseVideoCfg = _baseVideoConfig && _baseVideoConfig[type];
        var videos = videoConfig.bcpItems;
        var videoItems = videoConfig.items;

        //The Brightcove Plugin Video is integrated differently than the other media types that are part of the mediaOverlay.
        //This will create one player and dynamically update the video thats displayed within that player. This means
        //there will only be one Brightcove Plugin slide item created (per video type) whereas the other types will
        //create a separate slide for each slideitem.

        updateHash(videoItems[_idx].anchorId);
        var $ovr = ovr.$el;
        var $carousel = $ovr.find('.carousel');
        var $imgSlides = $carousel.find('.carousel-inner');
        var $vidSlides = $carousel.find(baseVideoCfg.slidesSelector);
        $imgSlides.empty();
        $vidSlides.removeClass('hidden');
        $carousel.addClass(baseVideoCfg.carouselTypeClass);
        // BCP Update - ensure has-list is always removed so double arrows aren't displayed when opened after an image overlay.
        $carousel.toggleClass('has-list', false);
        $ovr.addClass('fgx-brand-brightcove-modal');

        var bcpConfig = {
            playIndex: _idx,
            videos: videos
        };
        var brandConfig = {
            template: bcpItemTemplate,
            slideContainer: $vidSlides,
            index: _idx,
            count: videoItems.length,
            currentVideo: videoItems[_idx],
            videoItems: videoItems
        };
        brandConfig = _.assign({}, baseVideoCfg._brandConfig || {}, brandConfig);
        bcpConfig = _.assign({}, baseVideoCfg._bcpBaseConfig || {}, bcpConfig);

        video.bcp.create(bcpConfig, brandConfig).then(function(vConfig) {
            if(vConfig && vConfig.initialized) {
                _bcConfig = _.extend({}, _bcConfig, vConfig);
                _bcConfig.bcScriptLoaded = true;

                _bcConfig.bcpFramework.on('loaded', bcpOnLoaded);
                _bcConfig.bcpFramework.on('videoStart', bcpOnVideoStart);
                _bcConfig.bcpFramework.on('first-quartile', bcpOnFirstQuartile);
                _bcConfig.bcpFramework.on('second-quartile', bcpOnSecondQuartile);
                _bcConfig.bcpFramework.on('third-quartile', bcpOnThirdQuartile);
                _bcConfig.bcpFramework.on('fourth-quartile', bcpOnFourthQuartile);

                if (_bcConfig.playerApi && _bcConfig.playerApi.hasFullscreen() && _bcConfig.player) {
                    _bcConfig.player.on("fullscreenchange", bcHandleFullScreenChange);
                }

                if (!baseVideoCfg.swipeInitialized) {
                    baseVideoCfg.swipeInitialized = true;
                    if (_bcConfig.slideItem && _bcConfig.slideItem.length > 0) {
                        var $contentContainer = _bcConfig.slideItem.find('.carousel-caption');
                        setupSwipe($contentContainer[0]);
                    }
                }

                updateAriaLabelledById(_bcConfig.slideHeadlineId);
                setupBcpSlide();
                updateSelected();

            } else {
                _bcConfig = _.extend({}, brandConfig);
                _bcConfig.bcScriptLoaded = false;
            }
            ovr.show(true, $el, '.close-overlay');
            _videoOverlayLoading = false;
        });

        $ovr.data('actions',  videoItems[_idx].actions);
        util.images.load($vidSlides);

    }

    function initTextOnlyArrows(components) {
        // text only arrow clicks
        $toarrows = $('.text-only-arrows', components);
        $('div', $toarrows).click(function(ev) {
            ev.preventDefault();
            lastClickedArrowDirection = ($(this).is('.carousel-next')) ? 'next' : 'prev';
            advanceCarousel(lastClickedArrowDirection);
        });
    }

    function advanceCarousel(direction) {
        var $carousel = ovr.$el.find('.carousel');

        if(isVideoCarousel($carousel)) {
            // The brightCove plugin carousel doesn't actually rotate slides, it just swaps the content out.
            updateBcVideo(direction);
        } else {
            $carousel.carousel(direction);

            // BCP Update - move the logic for the carousel scroll metric so it only fires on the image carousel.
            // The advanceCarousel method is only called by the video carousel when swiped on mobile, so this is no longer
            // a reliable place to fire the scroll metrics for the BC/YT videos.
            //Common Metrics
            fireScrollAction('imageCarouselScroll', direction);
        }
    }
    
    function updatePaginationAriaLabel($carousel, current, total, accLabel) {
        var pageInfo = $carousel.find('.pagination-info');
        var pageInfoTemplate = pageInfo.data('label-template');
        var outputStr = '';

        if(pageInfoTemplate) {
            outputStr += wrapInDiv(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
        }
        if (accLabel) {
            outputStr += wrapInDiv(accLabel);
        }
        pageInfo.html(outputStr);
    }
    
    function resetPaginationAriaLabel($carousel) {
        var pageInfo = $carousel.find('.pagination-info');
        pageInfo.html('');
    }

    /*
     * Update the aria-labelledby attribute on the media-overlay element with the id that is passed in. If no id is passed in,
     * the attribute is set to an empty string.
     */
    function updateAriaLabelledById(id) {
        ovr.$el.attr('aria-labelledby', id || '');
    }

    function updateSelected() {
        var carousel = ovr.$el.find('.carousel');
        var active = carousel.find('.active');
        var config = active.data('config');
        var isVidCarousel = isVideoCarousel(carousel);
        updateHash(config.anchorId);
        updatePositions();

        if (!isVidCarousel) {
            // update pagination info for non-brightcove items
            updatePaginationAriaLabel(carousel, active.data('current-item'), active.data('total-items'), config && config.accLabel || '');
            // update the ariaLabelledBy attribute with the id for the headline of the current slide.
            updateAriaLabelledById(config && config.slideHeadlineId || '');

            if (config.image) {
                var altText = config.image.altTag || "";
                // show image carousel arrows
                // NZ - Remove fgx-brand-text-only-carousel class to allow the CSS to properly display the global arrows if
                // the has-list class is on the carousel element
                carousel.toggleClass('fgx-brand-text-only-carousel', false);
                // WC - BRAND-15950 - ensure the proper arrow button is focused (if we were previously on a text only slide, focus is lost)
                if (lastClickedArrowDirection === 'prev') {
                    $('.carousel-arrows.global-arrows.carousel-left > .carousel-btn.carousel-previous', carousel).focus();
                } else {
                    $('.carousel-arrows.global-arrows.carousel-right > .carousel-btn.carousel-next', carousel).focus();
                }
                $('.media-overlay .img-expand').show();
            } else {
                // hide image carousel arrows
                // NZ - Add fgx-brand-text-only-carousel class to allow the CSS to properly hide the global arrows (even if
                // the has-list class is on the carousel element)
                carousel.toggleClass('fgx-brand-text-only-carousel', true);
                // WC - BRAND-15950 - ensure the proper arrow button is focused (if we were previously on a text only slide, focus is lost)
                if (lastClickedArrowDirection === 'prev') {
                    $('.text-only-arrows > .carousel-previous', carousel).focus();
                } else {
                    $('.text-only-arrows > .carousel-next', carousel).focus();
                }
                $('.media-overlay .img-expand').hide();
            }
        }
    }

    function setImageExpandAndArrowsTop(mediaHeight) {
        var imgExpandTop = (mediaHeight * .88);
        var arrowsTop = (mediaHeight * .41);
        $('.media-overlay .img-expand').css('top', imgExpandTop);
        $('.media-overlay .carousel-arrows.global-arrows').css('top', arrowsTop);
    };

    function updatePositions() {
        var maxHeight = Math.max(450, (450 + $(win).height()-625)) + 'px';
        var $active = ovr.$el.find('.active');
        // BCP Update - the logic within this function no longer pertains to videos since the img-expand element is hidden
        // on videos and the arrows are now handled by the Brightcove plugin.
        if($active.length && !($active.hasClass("fgx-media-overlay-youtube-item") || $active.hasClass("fgx-media-overlay-brightcove-item"))) {
            var $wrapper = $active.find('.image-wrapper'),
                $img = $wrapper.find('img'),
                mediaHeight = 0;

            $wrapper.css({'maxHeight': maxHeight});

            //check if image is loaded before setting the img-expand position
            if($img && $img.length > 0) {
                if ($img[0].complete){
                    mediaHeight = $wrapper.height();
                    if (mediaHeight > 0) setImageExpandAndArrowsTop(mediaHeight);
                }else{
                    $img.on("load", function(){
                        mediaHeight = $wrapper.height(); //get the media height after the image loads
                        if (mediaHeight > 0) setImageExpandAndArrowsTop(mediaHeight);
                    });
                }
            }
        }

        updateScrollOffset();
    }

    function updateScrollOffset() {
        var secondOffset = Math.max(0,($(win).height()-768)/2);
        var scrollOffset = "150," + secondOffset;
        ovr.$el.attr('data-overlay-scroll-offset', scrollOffset);
    }

    function anchorCheck() {
        var anchorId = win.location.hash;
        if(anchorId) {
            anchorId = anchorId.substr(1);
            if(activeAnchor === anchorId) {
                return;
            }
            var item = anchorIds[anchorId];
            if(item) {
                activeAnchor = anchorId;
                win.setTimeout(function() {
                    win.scrollTo(0, Math.max(item[0].offset().top - 150, 0));
                    showOverlay.apply(null, item);
                }, 0);
            }
        }
    }

    function updateHash(anchorId) {
        activeAnchor = anchorId;
        if(win.history.replaceState) {
            var href = win.location.href;
            href = href.substr(0, href.length - win.location.hash.length) + ((anchorId) ? '#' + anchorId : '');
            win.history.replaceState({}, document.title, href);
        }
    }

    function startMediaDownload(src) {
        if(src) {
            var $anchor = $(document.createElement("a"));
            $anchor
                .addClass('hidden')
                .attr('href', src)
                .attr('target', '_blank')
                .attr('download', '')
                .appendTo($('body'));
            $anchor[0].click();
            $anchor.remove();
        }
    }

    function wrapInDiv(str) {
        return (str) ? ('<div>' + str + '</div>') : '';
    }

    function getDisclosureList($container, includeDynamic) {
        var output = [];

        if($container && $container.length > 0) {
            var globalList = getDisclosuresByType($container, "global");
            var dynamicList = [];
            if(includeDynamic) {
                dynamicList = getDisclosuresByType($container, "dynamic");
            }

            output = _.union(dynamicList, globalList);
        }

        return output;
    }

    function getDisclosuresByType($container, type) {
        var output = [];
        if(!$container || $container.length === 0) {
            return output;
        }

        var selector = (type === 'dynamic') ? "a[href^=\'#disc\']" : "sup[data-vdm-disc]";

        $container.find(selector).each(function() {
            var $discEl = $(this),
                displayText = $discEl.text() || '',
                callLib = (discLib && (type !== 'dynamic' || displayText)),
                param = (type === 'dynamic') ? $discEl : $discEl.attr('data-vdm-disc'),
                _discData = (callLib) ? discLib[type].getData(param) : null;

            if(_discData && _discData.detail) {
                var discOutput = ((_discData.id || '') +  " " + _discData.detail).trim();
                output.push(discOutput);
            }
        });

        return output;
    }

    function bcHandleFullScreenChange(ev) {
        if(_bcConfig.playerApi) {
            var isFS = _bcConfig.playerApi.isFullscreen();
            if(isFS) {
                fireOverlayMetricAction('videoExpand');
            }
        }
    }

    function updateBcVideo(direction) {
        // BCP Update - Altered this to call the next/previous functionality of the BC plugin (which will in turn fire the
        // load event where the rest of the setup functions will be fired) instead of handling that logic here manually.
        if (_bcConfig && _bcConfig.bcpFramework) {
            var methodKey = (direction === 'prev') ? 'prevVideo' : 'nextVideo';
            _bcConfig.bcpFramework[methodKey]();
        }
    }

    // BCP Update - This will be called by bcpOnLoaded, which will mean a new video was loaded into the player. If the
    // playIndex from the framework doesn't match the current index in _bcConfig then a new video is playing and we
    // should call the appropriate functions to load new data in the BCP slide.
    function updateBcVideoContent() {
        if (_bcConfig && _bcConfig.bcpFramework) {
            var currIndex = _bcConfig.index,
                newIndex = _bcConfig.bcpFramework.getPlayIndex();

            if (newIndex !== currIndex) {
                // BCP Update - Moved this logic to fire the carousel scroll metric for the video overlay here since this
                // function is called anytime the video changes. Note, this is within the index checks to prevent this
                // metric from firing when the overlay is opened initially.
                // Common Metrics
                fireScrollAction('videoCarouselScroll', (newIndex < currIndex) ? 'prev' : 'next');

                _bcConfig.index = newIndex;
                _bcConfig.currentVideo = _bcConfig.videoItems[newIndex];

                if(_bcConfig.playerApi) {
                    _bcConfig.playerApi.setCurrentVideo(_bcConfig.currentVideo);
                }

                setupBcpSlide();
                updateSelected();
            }
        }
    }

    function setupBcpSlide() {
        if(_bcConfig && _bcConfig.currentVideo) {
            var currVideo = _bcConfig.currentVideo;
            var $slideItem = _bcConfig.slideItem;

            if(currVideo && _bcConfig.playerApi) {
                currVideo.playerApi = _bcConfig.playerApi;
            }

            $slideItem.data('config', currVideo);

            $slideItem.toggleClass('active', true);

            //Video Heading Elements
            var title = (currVideo.videoTitle) ? currVideo.videoTitle : '',
                titleStyle = (currVideo.titleStyle) ? currVideo.titleStyle : '';
            updateBcVideoHeading(title, titleStyle, _bcConfig.count);

            //Description
            updateBcVideoDescription((currVideo.videoDescription) ? currVideo.videoDescription : '');

            //Disclaimer
            updateBcVideoDisclaimer((currVideo.disclaimerText) ? currVideo.disclaimerText : '');

            //Dynamic Disclosures
            updateBcDynamicDisclosures(currVideo);

            //CTAs
            updateBcCTAs(currVideo);
        }
    }

    function resetBcpSlide() {
        if(_bcConfig && _bcConfig.bcScriptLoaded) {
            _bcConfig.bcpFramework.off('loaded', bcpOnLoaded);
            _bcConfig.bcpFramework.off('videoStart', bcpOnVideoStart);
            _bcConfig.bcpFramework.off('first-quartile', bcpOnFirstQuartile);
            _bcConfig.bcpFramework.off('second-quartile', bcpOnSecondQuartile);
            _bcConfig.bcpFramework.off('third-quartile', bcpOnThirdQuartile);
            _bcConfig.bcpFramework.off('fourth-quartile', bcpOnFourthQuartile);

            if (_bcConfig.playerApi && _bcConfig.playerApi.hasFullscreen() && _bcConfig.player) {
                _bcConfig.player.off("fullscreenchange", bcHandleFullScreenChange);
            }

            var $slideItem = _bcConfig.slideItem;

            // BCP Update - need to remove the active class from the slide when closing/reseting a slide. This was causing
            // problems where we were retrieving the 'config' object from the active slide, but it was actually for the
            // wrong active slide since a new YT slide was created and the brightcove slide is before the YT slide.
            $slideItem.toggleClass('active', false);

            //Reset Heading Elements
            updateBcVideoHeading('', '', 0);

            //Reset video description
            updateBcVideoDescription('');

            //Reset disclaimer text
            updateBcVideoDisclaimer('');

            //Reset Dynamic Disclosures
            updateBcDynamicDisclosures(null);

            //Reset CTAs
            updateBcCTAs(null);

            if (_bcConfig.fgxInstanceId === 'mediaOverlayYT') {
                // BCP Update - set fgxSetupSlideItem to false for Youtube so that the slide template isn't re initialized
                // the next time a YT video overlay is opened (since we're resetting the instance, the logic to initialize
                // the template would be run a second time, but the template doesn't need to be initialized again.)
                if (_baseVideoConfig.youtube && _baseVideoConfig.youtube._brandConfig) {
                    _baseVideoConfig.youtube._brandConfig.fgxSetupSlideItem = false;
                }
                video.bcp.resetInstance(_bcConfig.fgxInstanceId);
            }
        }
    }

    function updateBcVideoHeading(title, titleStyle, count) {
        var paginationText = updateBcPaginationLabel(count),
            ariaLabel = title + ' ' + paginationText;

        updateBcVideoTitle(title, titleStyle, ariaLabel);
    }

    function updateBcVideoTitle(title, titleStyle, ariaLabel) {
        var $titleElm = _bcConfig.slideItem.find('.carousel-content-header');
        $titleElm.html(title);

        if(_currTitleStyle !== '') {
            $titleElm.removeClass(_currTitleStyle);
        }
        _currTitleStyle = titleStyle || '';
        $titleElm.addClass(_currTitleStyle);
        // NZ - BRAND-14473 - Commenting out line below as the text/markup is announced correctly if we just let NVDA
        // read it from the element instead of setting it within an aria-label attribute on the heading element.
        //$titleElm.attr('aria-label', ariaLabel);
    }

    function updateBcPaginationLabel(count) {
        var $pageCountWrapper = _bcConfig.slideItem.find('.carousel-page-count'),
            $pageCountElm = $pageCountWrapper.find('.page-count-media-overlay'),
            paginationLabel = ovr.$el.data('fgxPaginationLabel'),
            paginationText = '',
            carousel = ovr.$el.find('.carousel'),
            currVideo = _bcConfig && _bcConfig.currentVideo;

        if(count > 1) {
            if(paginationLabel && typeof(paginationLabel) != 'undefined') {
                paginationText = (_bcConfig.index + 1) + ' ' + paginationLabel + ' ' + _bcConfig.count;
                //Update pagination aria label
                updatePaginationAriaLabel(carousel, (_bcConfig.index + 1), _bcConfig.count, currVideo && currVideo.accLabel || '');
            }
            $pageCountElm.html(paginationText);
            $pageCountWrapper.removeClass('hidden');
        } else {
            $pageCountElm.html('');
            $pageCountWrapper.addClass('hidden');
            //Reset pagination aria label
            resetPaginationAriaLabel(carousel);
        }
        return paginationText;
    }

    function updateBcVideoDescription(description) {
        var $slideItem = _bcConfig.slideItem,
            $descItem = $slideItem.find('.fgx-item-description');

        if(description && description !== '') {
            $descItem.html(description).removeClass('hidden');
        } else {
            $descItem.html('').addClass('hidden');
        }
    }

    function updateBcVideoDisclaimer(disclaimer) {
        var $slideItem = _bcConfig.slideItem,
            $discWrapper = $slideItem.find('.disclaimer-container'),
            $discContent = $discWrapper.find('.disclaimer-content');

        if(disclaimer && disclaimer !== '') {
            $discContent.html(disclaimer);
            $discWrapper.removeClass('hidden');
        } else {
            $discContent.html('');
            $discWrapper.addClass('hidden');
        }
    }

    function updateBcDynamicDisclosures(video) {
        var $slideItem = _bcConfig.slideItem,
            $dynamicDiscElm = $slideItem.find('.dynamic-disclosure-wrapper');

        if(video && video.dynamicDisc && video.dynamicDisc.display) {
            $dynamicDiscElm.html(video.dynamicDisc.content);
            $dynamicDiscElm.removeClass('hidden');
            $slideItem.attr('data-dynamic-disclosure-enable', '');
        } else {
            $dynamicDiscElm.html('');
            $dynamicDiscElm.addClass('hidden');
            $slideItem.attr('data-dynamic-disclosure-enable', null);
        }
    }

    function updateBcCTAs(video) {
        var $slideItem = _bcConfig.slideItem,
            $ctaContainer = $slideItem.find('.fgx-cta-wrap');
        $ctaContainer.empty();

        if(video && video.ctas && video.ctas.length > 0) {
            _.each(video.ctas, function(cta) {
                if(cta.url && cta.text) {
                    $('<a></a>')
                        .attr('href', cta.url)
                        .attr('class', cta.cssClass)
                        .attr('target', cta.target)
                        .attr('aria-label', cta.ariaLabel)
                        .html(cta.text)
                        .appendTo($ctaContainer);
                }
            });
            $ctaContainer.removeClass('hidden');
        } else {
            $ctaContainer.addClass('hidden');
        }
    }

    function getCurrentBcSource() {
        var vidSrc = '';
        if(_bcConfig && _bcConfig.player) {
            var sourceArr = [],
                renditionsArr = _bcConfig.player.currentSources() || [];

            for(var i = 0; i < renditionsArr.length; i++) {
                if(renditionsArr[i].container === 'MP4' && renditionsArr[i].hasOwnProperty('src')) {
                    sourceArr.push(renditionsArr[i]);
                }
            }

            // Sort the renditions from highest to lowest on size
            if(sourceArr.length > 1) {
                sourceArr.sort(function(a, b) {
                    return b.size - a.size;
                });
            }

            // Get the highest rendition
            vidSrc = (sourceArr.length > 0) ? sourceArr[0].src : '';
        }
        return vidSrc;
    }

    function bcpOnLoaded(data) {
        updateBcVideoContent();
    }

    function bcpOnVideoStart(data) {
        bcSegmentUpdate('videoStart');
    }

    function bcpOnFirstQuartile(data) {
        bcSegmentUpdate('videoSegment25');
    }

    function bcpOnSecondQuartile(data) {
        bcSegmentUpdate('videoSegment50');
    }

    function bcpOnThirdQuartile(data) {
        bcSegmentUpdate('videoSegment75');
    }

    function bcpOnFourthQuartile(data) {
        bcSegmentUpdate('videoComplete');
    }

    /*
    Common Video Functions
     */
    function stopVideo() {
        var $carousel = ovr.$el.find('.carousel');
        if(isVideoCarousel($carousel)) {
            var typeClass = ($carousel.hasClass('fgx-brand-youtube-carousel')) ? 'fgx-brand-youtube-carousel' : 'fgx-brand-brightcove-carousel';

            if (_bcConfig && _bcConfig.bcpFramework) {
                _bcConfig.bcpFramework.pause();

                if (typeClass === 'fgx-brand-youtube-carousel') {
                    _bcConfig.bcpFramework.destroy();
                }
            }
            _bcConfig.slideContainer.addClass('hidden');

            $carousel.removeClass(typeClass);
            ovr.$el.removeClass('fgx-brand-brightcove-modal');
            resetBcpSlide();
        }
    }

    /*
     * BCP Update - Determine if a carousel contains a BC/YT video or not
     */
    function isVideoCarousel($carousel) {
        return !!($carousel && $carousel.length > 0 && ($carousel.hasClass('fgx-brand-youtube-carousel') || $carousel.hasClass('fgx-brand-brightcove-carousel')));
    }

    /*

     Metrics section

     */

    /*
     * BCP Update - Added new functions to handle firing the metrics from the BC Plugin
     */
    function bcSegmentUpdate(id) {
        if (!id) {
            return;
        }
        var vidData = _.assign({}, _mtxBcpVidSegments[id] || {}, getMtxBcVideoData() || {});
        //Common Metrics
        fireOverlayMetricAction(id, {
            video: vidData
        });
    }

    function getMtxBcVideoData() {
        var currVideo = _bcConfig && _bcConfig.currentVideo,
            data = {
                segmentTime: getCurrentBcTime(currVideo),
                videoName: currVideo && currVideo.videoTitle || ''
            };
        return data;
    }

    function getCurrentBcTime(currVideo) {
        var currTime = 0;
        if (currVideo && currVideo.playerApi) {
            try {
                currTime = currVideo.playerApi.getCurrentTime();
            } catch(e) {
                util.log("mediaOverlay::getVideoSegment - issue retrieving the segmentTime")
            }
        }
        return currTime;
    }

    /*
     * BCP Update - create a separate method for the carousel scroll action to create the call to the fireOverlayMetricAction
     * function since the scroll logic gets called from different functions now depending on media type.
     */
    function fireScrollAction(actionId, direction) {
        var mtxData = {};
        if (direction) {
            mtxData['$$carouselScrollDirection'] = (direction == 'prev') ? 'left' : 'right';
        }

        fireOverlayMetricAction(actionId, mtxData);
    }

    function fireOverlayMetricAction(actionId, data) {
        var actions = ovr.$el.data('actions');
        if(!data) {
            data = {};
        }
        if(actions && actions[actionId]) {
            FD.Brand.Metrics.handler.direct(actions[actionId], data);
        }
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay, FD.Brand.Video, FD.Brand.Util, FD.Brand.Context, FD.Brand.Disclosures);

;(function($, win, _, brand, util, ctx, user) {

    brand.setInitHandler('[data-fgx-golf-form-container]', init);

    /////////////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        var _ccpaMtxRequestTypeMap = {
            'dns': 'do not sell data',
            'dmd': 'delete data',
            'smd': 'access data'
        };

        components.each(function() {
            var $el = $(this),
                formId = $el.attr('data-fd-golf-form-id') || '',
                formType = $el.attr('data-fd-golf-form-type') || '',
                formTitle = $el.attr('data-fd-golf-form-title') || '',
                formCtaLabel = $el.attr('data-fd-golf-form-cta-label') || '',
                skinVersion = $el.attr('data-fd-golf-form-skin-version') || '',
                formAccessVersion = $el.attr('data-fd-golf-form-access-version') || '',
                _golfForm = null,
                _mtxActions = {};

            _mtxActions['startAction'] = $el.attr('data-fd-start-action');
            _mtxActions['selectVehiclePageAction'] = $el.attr('data-fd-select-vehicle-page-action');
            _mtxActions['addtlDetailsClickAction'] = $el.attr('data-fd-addtl-details-click-action');
            _mtxActions['contactPageAction'] = $el.attr('data-fd-contact-page-action');
            _mtxActions['completeAction'] = $el.attr('data-fd-complete-action');
            _mtxActions['completeTdAltLocAction'] = $el.attr('data-fd-complete-td-alt-loc-action');
            _mtxActions['completeEmailAction'] = $el.attr('data-fd-complete-email-action');
            _mtxActions['completeMailAction'] = $el.attr('data-fd-complete-mail-action');
            _mtxActions['completeBothAction'] = $el.attr('data-fd-complete-both-action');
            _mtxActions['completeAltLocAndEmailAction'] = $el.attr('data-fd-complete-alt-loc-and-email-action');
            _mtxActions['printSummaryAction'] = $el.attr('data-fd-print-summary-action');


            if(formId !== '' && formType !== '') {
                var prm = {
                    id: formId,
                    formType: formType,
                    presentation: 'embed',
                    make: ctx.make,
                    region: ctx.region.toLowerCase(),
                    skinVersion: skinVersion
                };
                if(formTitle != '') {
                    prm.formTitle = formTitle;
                }
                if(formCtaLabel != '') {
                    prm.ctaLabel = formCtaLabel;
                }
                var formContainerEl = $el.find('.sub-component-wrap');
                var golf = brand && brand.Form;
                if(golf) {
                    golf.load(formType, prm, formContainerEl).done(function($form) {
                        if(win.FD.Pantry && win.FD.Pantry.Golf) {
                            FD.Pantry.Golf.initialized().done(function() {
                                _golfForm = FD.Pantry.Golf.getForm(formId);
                                var data = {
                                    formType: _golfForm.formType,
                                    mtxActions: _mtxActions,
                                    formAccessVersion: formAccessVersion
                                };
                                if(_golfForm) {
                                    var cfg = {
                                            postalCode: user.location.current().postalCode
                                        },
                                        nameplate = ctx && ctx.nameplate;

                                    if(nameplate) {
                                        if(nameplate.ngpModelName) {
                                            cfg.model = nameplate.ngpModelName;
                                        }
                                        if(nameplate.ngpYear) {
                                            cfg.year = nameplate.ngpYear;
                                        }
                                    }

                                    // BRAND-14407
                                    if(formType === 'ccpa' && formAccessVersion === 'callcenter') {
                                        cfg.options = {};
                                        cfg.options.callCenter = true;
                                    }

                                    var config = _.extend({}, prm, cfg);

                                    // BRAND-14407 - call show method for ccpa form only at the moment. Come back to this
                                    // to see if we can just update it to call show for all form types when we have time
                                    // to verify change doesn't negatively affect those integrations.
                                    if(formType === 'ccpa') {
                                        _golfForm.show(null, config, formEventCallback(_golfForm, data, handleFormCallback));
                                    } else {
                                        _golfForm.setConfig(config, formEventCallback(_golfForm, data, handleFormCallback));
                                    }
                                }
                            });
                        }
                    });
                }
            }
        });

        function formEventCallback(form, callbackData, fnCallback) {
            return function() {
                var args = [].slice.call(arguments);
                args.unshift(callbackData);
                if(fnCallback) {
                    try {
                        fnCallback.apply(form, args);
                    } catch (e) {
                    }
                }
            }
        }

        function handleFormCallback(callbackData, eventName, config) {
            //the this keyword should refer to the form in this method if needed.
            var formType = callbackData && callbackData.formType || '',
                mtxActions = callbackData && callbackData.mtxActions || {};

            try {
                if(eventName === 'FormShown') {
                    fireMetric(mtxActions, 'startAction');
                } else {
                    switch (formType) {
                        case 'getupdates':
                            // Get Updates form events
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    // metrics call for successful submission
                                    fireGUSubmissionSuccessAction(config, mtxActions);
                                    scrollToForm(this.$form);
                                    break;
                            }
                            break;
                        case 'schedule':
                            switch (eventName) {
                                case 'ResponseView':
                                    var resp = config && config.response;
                                    if(resp && resp.cksVisitID) {
                                        FD.Brand.Metrics.setParameter('user_cksVisitId', resp.cksVisitID);
                                    }
                                    fireMetric(mtxActions, 'completeAction');
                                    scrollToForm(this.$form);
                                    break;
                                case 'SelectVehicleView':
                                    fireMetric(mtxActions, 'selectVehiclePageAction');
                                    break;
                            }
                            break;
                        case 'partsservice':
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    var req = config && config.request,
                                        action = (req && req.dealerFollowup) ? 'completeEmailAction' : 'completeAction',
                                        mtxData = _.extend({}, getMtxData(config, false));
                                    fireMetric(mtxActions, action, mtxData);
                                    scrollToForm(this.$form);
                                    break;
                                case 'SelectVehicleView':
                                    fireMetric(mtxActions, 'selectVehiclePageAction');
                                    break;
                            }
                            break;
                        case 'catestdrive':
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    var req = config && config.request,
                                        resp = config && config.response,
                                        action = 'completeAction',
                                        mtxData = _.extend({}, getMtxData(config, true));

                                    if(resp) {
                                        if(resp.cksVisitID) {
                                            FD.Brand.Metrics.setParameter('user_cksVisitId', resp.cksVisitID);
                                        }

                                        if(resp.followUp && resp.homeWorkTestDrive) {
                                            action = 'completeAltLocAndEmailAction';
                                        } else if(resp.followUp) {
                                            action = 'completeEmailAction';
                                        } else if(resp.homeWorkTestDrive) {
                                            action = 'completeTdAltLocAction';
                                        }
                                    }

                                    fireMetric(mtxActions, action, mtxData);
                                    scrollToForm(this.$form);
                                    break;
                                case 'PageTwoLoad':
                                    var action = 'contactPageAction',
                                        mtxData = _.extend({}, getMtxData(config, true));
                                    fireMetric(mtxActions, action, mtxData);
                                    break;
                                case 'print':
                                case 'printSummary':
                                    var mtxData = _.extend({}, getMtxData(config, true));
                                    fireMetric(mtxActions, 'printSummaryAction', mtxData);
                                    break;
                            }
                            break;
                        case 'catradein':
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    var resp = config && config.response,
                                        action = 'completeAction',
                                        mtxData = _.extend({}, getMtxData(config, true));

                                    if(resp && resp.followUp) {
                                       action = 'completeEmailAction';
                                    }
                                    fireMetric(mtxActions, action, mtxData);
                                    scrollToForm(this.$form);
                                    break;
                                case 'PageTwoLoad':
                                    var action = 'contactPageAction',
                                        mtxData = _.extend({}, getMtxData(config, true));
                                    fireMetric(mtxActions, action, mtxData);
                                    break;
                            }
                            break;
                        case 'cacontactus':
                        case 'casponsorship':
                        case 'caroadside':
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    fireMetric(mtxActions, 'completeAction');
                                    scrollToForm(this.$form);
                                    break;
                            }
                            break;
                        case 'cacx727':
                            switch (eventName) {
                                case 'AddtlDetailsOpened':
                                    fireMetric(mtxActions, 'addtlDetailsClickAction');
                                    break;
                                case 'SubmissionSucceeded':
                                    var resp = config && config.response,
                                        action = 'completeAction';
                                    if(resp) {
                                        if(resp.cksVisitID) {
                                            FD.Brand.Metrics.setParameter('user_cksVisitId', resp.cksVisitID);
                                        }

                                        if(resp.followUp) {
                                            action = 'completeEmailAction';
                                        }
                                    }
                                    fireMetric(mtxActions, action);
                                    scrollToForm(this.$form);
                                    break;
                            }
                            break;
                        case 'ccpa':
                            //NZ - MTX-8403 - WIP: need to add logic to retrieve the selected form tab from GOLF, and update the action based on email/mail selected if form tab is set to access-data version.
                            var formAccessVersion = callbackData && callbackData.formAccessVersion || '';
                            switch (eventName) {
                                case 'SubmissionSucceeded':
                                    var action = 'completeAction',
                                        reqType = (config && config.requestType || '').toLowerCase(),
                                        mtxReqType = _ccpaMtxRequestTypeMap[reqType] || '',
                                        deliveryMethod = (config && config.deliveryMethod || '').toLowerCase(),
                                        mtxData = {};

                                    if(reqType === 'smd') {
                                        action = (deliveryMethod === 'm') ? 'completeMailAction' : 'completeEmailAction';
                                    }

                                    if(mtxReqType) {
                                        mtxData['$$requestType'] = mtxReqType;
                                    }

                                    fireMetric(mtxActions, action, mtxData);
                                    scrollToForm(this.$form);
                                    break;
                            }
                            break;
                    }
                }
            } catch(err) {
                console.log("Error occurred in the form event callback method " + err);
            }
        }

        function scrollToForm($form) {
            if(!$form || $form.length == 0) {
                return;
            }

            var $stickyNav = $('.navbar-static-top'),
                topOffset = $form.offset().top,
                scrollTo = ($stickyNav.length) ? (topOffset - $stickyNav.height()) : topOffset;

            $('html,body').animate({
              scrollTop: scrollTo
            }, 200);
        }

        function fireMetric(mtxActions, action, mtxData) {
            var data = (mtxData && !_.isEmpty(mtxData)) ? mtxData : {};
            if(action && mtxActions && typeof(mtxActions[action]) != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    mtxActions[action],
                    data
                );
            }
        }

        function getMtxData(config, updateDefaults) {
            var data = {};
            if(config) {
                var model = (config.mtxName || config.model || '').toLowerCase();
                if(model || config.year) {
                    if(updateDefaults) {
                        data.vehicle = {};
                    }
                    if(model) {
                        data['$segment'] = FD.Brand.Metrics.getSegment(model);
                        if(data['$segment'] && data['$segment'] === 'truck-commercial') {
                            model = FD.Brand.Metrics.getCommNameplate(model);
                        }
                        data['$$formNameplate'] = model;

                        if(updateDefaults) {
                            data['$nameplate'] = model;
                            data.vehicle['nameplate'] = (ctx.make + ' ' + model).toLowerCase();
                        }
                    }
                    if(config.year) {
                        data['$$formYear'] = config.year;

                        if(updateDefaults) {
                            data['$modelYear'] = config.year;
                            data.vehicle['modelYear'] = config.year;
                        }
                    }
                }
            }
            return data;
        }

        function fireGUSubmissionSuccessAction(data, mtxActions) {
            var skinVersion = data && data.skinVersion || '';
            var mtxAction = '';
            var mtxData = {};
            switch(skinVersion) {
                case 'canvasv1':
                case 'personaldriverv1':
                    mtxAction = 'completeAction';
                    break;
                default:
                    var req = data && data.request;
                    if(req) {
                        var isEmail = req.email,
                            isMail = req.mail,
                            nameplate = util.str.firstInstance(req.mtxName, ';'),
                            year = util.str.firstInstance(req.year, ';');

                        if(typeof(isEmail) == 'undefined' || !isEmail) {
                            isEmail = 0;
                        }
                        if(typeof(isMail) == 'undefined' || !isMail) {
                            isMail = 0;
                        }

                        if(ctx.region === 'CA' || (isEmail == 1 && isMail == 0)) {
                            mtxAction = 'completeEmailAction';
                        } else if(isEmail == 1 && isMail == 1) {
                            mtxAction = 'completeBothAction';
                        } else {
                            mtxAction = 'completeMailAction';
                        }

                        mtxData['$segment'] = FD.Brand.Metrics.getSegment(nameplate);
                        mtxData['$$formNameplate'] = nameplate;
                        mtxData['$nameplate'] = nameplate;
                        mtxData.vehicle = {};
                        mtxData.vehicle['nameplate'] = nameplate;
                        mtxData['$$formYear'] = year;
                        mtxData['$modelYear'] = year;
                        mtxData.vehicle['modelYear'] = year;
                    }
                    break;
            }

            if(mtxAction != '') {
                fireMetric(mtxActions, mtxAction, mtxData);
            }
        }
    }
})(jQuery, window, FD.Brand.lodash, FD.Brand, FD.Brand.Util, FD.Brand.Context, FD.Brand.User);
/*global FD*/
/**
 * Email Overlay
 */
(function(win, $, brand, ctx, overlay, util, user) {

    var baseUrl = (ctx.make === 'Ford') ? ctx.settings.mailSendUrlFord : ctx.settings.mailSendUrlLincoln;
    var ovr;
    var $subjectInp;
    var $bodyInp;
    var $subjectPlaceholder;
    var $bodyPlaceholder;
    var $fromEmail;
    var $cta;
    var $components;
    var $consumerId = 'anonymous';
    brand.setInitHandler('[data-fgx-email-overlay]', init);

    //////

    function init(components) {
        ovr = overlay.register('emailOverlay', components, {
            show: function() {
                resetEmailForm();
                $('.success-msg', components).hide();
                $('body').addClass('no-scroll');
            },
            hide: function() {
                $('body').removeClass('no-scroll');
            }
        });
        
        $components = components;
        
        $subjectInp = $('#txt_emailSubject', components);
        $bodyInp = $('#txt_emailBody', components);
        
        $cta = $('.email-cta', components);
        
        $fromEmail = $('#txt_fromEmail', components).val();
        
        $subjectPlaceholder = $subjectInp.val();
        $bodyPlaceholder = $bodyInp.val();
        
        $subjectInp.focus(function(ev) {
            handleFocus($subjectInp, $subjectPlaceholder);
        });
        
        $bodyInp.focus(function(ev) {
            handleFocus($bodyInp, $bodyPlaceholder);
        });
        
        $subjectInp.focusout(function(ev) {
            handleFocusOut($subjectInp, $subjectPlaceholder);
        });
        
        $bodyInp.focusout(function(ev) {
            handleFocusOut($bodyInp, $bodyPlaceholder);
        });
        
        $('.icon-close', components).click(function() {
            ovr.hide();
        });
        
        $cta.click(validateAndSubmit);
        
        user.authentication.subscribe(updateConsumerId, false);
        
    }
    
    function updateConsumerId(authState) {
        //window.alert('!!!');
        //window.alert('authState.consumerId : ' + authState.consumerId);
        if (authState.consumerId) $consumerId = authState.consumerId;
    }
    
    function handleFocus(el, placeholder) {
        if (el.val() === placeholder) {
            el.val('');
            el.addClass('active');
        }
    }
    
    function handleFocusOut(el, placeholder) {
        if (el.val() === '') {
            el.removeClass('active');
            el.val(placeholder);
        }
    }
    
    function validateAndSubmit() {
        var subjectTxt = $subjectInp.val();
        var bodyTxt = $bodyInp.val();
        if (subjectTxt !== $subjectPlaceholder && bodyTxt !== $bodyPlaceholder) {
            // we're valid
            $('.validation-error', $components).hide();
            $subjectInp.removeClass('error');
            $bodyInp.removeClass('error');
            // submit to email service
            sendEmail(subjectTxt, bodyTxt);
        } else {
            // we're invalid
            $('.validation-error', $components).show();
            if (subjectTxt === $subjectPlaceholder) $subjectInp.addClass('error');
            if (bodyTxt === $bodyPlaceholder) $bodyInp.addClass('error');
        }
    }
    
    function callEmailService(data) {
        //var jsonData = JSON.stringify(data);
        return $.Deferred(function (defer) {
            $.ajax({
                'url': baseUrl + '/core-services/mail/send', 
                'method': 'jsonp', 
                'data': data, 
                xhrFields: {
                    withCredentials: true
                }
            }).done(function(resp) {
                if(resp) {
                    defer.resolve(resp);
                } else {
                    defer.resolve(null);
                }
            }).fail(function(resp) {
                util.log('Send email failed', resp);
                defer.reject(resp);
            });
        }).promise();
    }
    
    function resetEmailForm() {
        $subjectInp.val($subjectPlaceholder);
        $subjectInp.removeClass('active');
        $bodyInp.val($bodyPlaceholder);
        $bodyInp.removeClass('active');
        $('.validation-error', $components).hide();
        $('.submission-error', $components).hide();
        $subjectInp.removeClass('error');
        $bodyInp.removeClass('error');
    }
    
    function sendEmail(subject, body) {
        $('.success-msg', $components).hide();
        var data = {
            'from': $fromEmail,
            'subject': subject,
            'message': body,
            'posttext': $consumerId
        }
        callEmailService(data).then(function() {
            resetEmailForm();
            $('.success-msg', $components).show();
        }, function(err) {
            $('.submission-error', $components).show();
        });
    }

})(window, $, FD.Brand, FD.Brand.Context, FD.Brand.Overlay, FD.Brand.Util, FD.Brand.User);
/*global FD*/
;(function ($, brand, util, ctx) {

    var COOKIE_NAME = 'fgx-brand-cookie-notice';
    brand.setInitHandler('[data-fgx-cookie-notice-overlay]', init);

    /////////////

    function init(components) {
        if(components.length === 0) {
            return;
        }

        var showAction = components.attr('data-fd-metrics-on-show');

        if(!util.cookie.get(COOKIE_NAME)) {
            components.removeClass('hidden');

            setTabIndexes("0");

            // common metrics
            if(typeof(showAction) != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    showAction
                );
            }
        }

        $('.close-wrap', components).on('click', function() {
            components.addClass('hidden');

            util.cookie.set(COOKIE_NAME, 1, {
                path: '/',
                expires: 365,
                domain: ctx.settings['siteCookieDomain' + ctx.make]
            });
        });

        function setTabIndexes(val) {
            components.find('a').each(function() {
                $(this).attr('tabindex', val);
            });
        }
    }
})(jQuery, FD.Brand, FD.Brand.Util, FD.Brand.Context);
/*global FD*/
;(function ($, brand, util, overlay, context) {

    var COOKIE_NAME = 'browser-alert';
    var ovr;
    brand.setInitHandler('[data-fgx-browser-alert]', init);

    /////////////

    function init(components) {
        if(components.length === 0) {
            return;
        }
        ovr = overlay.register('browserAlert', components);
        $('.icon-close', components).on('click', function() {
            ovr.hide();
        });
        var isMobile = util.currentBreakpoint() === 'gux-bkpt-sm';
        var maxUnsupportedVersion = {
            msie: 11,
            ie: 11,
            chrome: isMobile ? 38 : 27,
            firefox: isMobile ? 0 : 35,
            safari: isMobile ? 7 : 5,
            android: isMobile ? 3 : 0
        };
        var info = util.env.browser();
        info.name = (info.name || '').toLowerCase().trim();
        var onClickAction = components.attr('data-fd-metrics-on-show');
        if(!util.cookie.get(COOKIE_NAME) && maxUnsupportedVersion[info.name] >= info.version) {
            // we're not initiated by a user action, so pass in undefined as the target.
            ovr.show(true, undefined, '.browser-item');
            
            util.cookie.set(COOKIE_NAME, 1, {
                path: '/',
                domain: context.settings['siteCookieDomain' + context.make]
            });

            // new metrics
            FD.Brand.Metrics.handler.direct(
                onClickAction
            );
        }
        //checking if the browser is supported
        if(maxUnsupportedVersion[info.name] >= info.version) {
        	// callBrowserUnsupportedGenericOverlayPostPageLoad();
        }
    }

})(jQuery, FD.Brand, FD.Brand.Util, FD.Brand.Overlay, FD.Brand.Context);

/*global metrics*/

;(function($, _, ctx) {
  'use strict';

  var _window = $(window);
  var _bttArrow_el = $(".btt-arrow");
  var mtxActions = ctx && ctx.mtxActions;
  var backToTopClickAction = mtxActions && mtxActions.backToTopClickAction || null;
  var accessibility = ctx && ctx.accessibility;
  var backToTopAriaLabel = accessibility && accessibility.backToTopAriaLabel || null;
  
  if (backToTopAriaLabel) {
      _bttArrow_el.attr("aria-label", backToTopAriaLabel);
  }

  var currentScrollTop,
    scrollDirection,
    arrowVisible,
    mouseIsOverArrow,
    __int;

  _window.on("scroll", _.throttle(bttArrowAdmin_scroll, 200));

// bool 'mouseIsOverArrow' is only for Mouse Input functions
  _bttArrow_el.on("mouseover", function() {
    mouseIsOverArrow = true;
  });

  _bttArrow_el.on("mouseout", function() {
    mouseIsOverArrow = false;
  });

  _bttArrow_el.on("click", function() {
    _scrollToTop();

    //Common Metrics
    if (backToTopClickAction) {
        FD.Brand.Metrics.handler.direct(
            backToTopClickAction
        );
    }

  });

// * FUNCTIONS *

  // Actions - Window

  function bttArrowAdmin_scroll() {
    _scrollCheck();
    if (_bttArrow_el.is(':focus')) {
        // if we're in focus, our visibility has been handled by CSS, make sure our var reflects that
        arrowVisible = true;
    }
    if ((_window.scrollTop() + _window.height()) > 1599) {
      if ((scrollDirection === "up")) {
        if (!arrowVisible) {
          _fadeInTopArrow();
        }
        _scrollStart();
        return;
      }
    } else if (arrowVisible) {
      return;
    }
    _scrollStop();
  }

  //Actions - Arrow

  function _scrollStop(bool) {
    if ((bool || !mouseIsOverArrow) && !_bttArrow_el.is(':focus')) {
      clearInterval(__int);
      scrollDirection = null;
      _fadeOutTopArrow();
    }
  }

  function _scrollStart() {
    clearInterval(__int);
    __int = setInterval(function() {
      _scrollStop()
    }, 2500);
  }

  function _scrollCheck() {
    var lastScrollTop = currentScrollTop ? currentScrollTop : _window.scrollTop();
    currentScrollTop = _window.scrollTop();

    var _direction = scrollDirection;
    scrollDirection = (currentScrollTop < lastScrollTop) ? "up" : "down";
  }

  // Animations

  function _fadeInTopArrow() {
    arrowVisible = true;
    _bttArrow_el.css({
        "width":"65px",
        "height":"65px",
        "padding":"10px",
        "right":"-15px"
    });
    _bttArrow_el.animate({
      right: "15px",
      opacity: 1
    }, "fast");
  }

  function _fadeOutTopArrow() {
    _bttArrow_el.animate({
      opacity: 0
    }, "fast", function() {
        arrowVisible = false;
        _bttArrow_el.css({
            "width":"1px",
            "height":"1px",
            "padding":"0",
            "right":"-15px"
        });
    });
  }

  function _scrollToTop(){
    $("html, body").animate({
      scrollTop: 0
    },
    400,
    "swing",
    function(){
      _scrollStop(true); //at end, stop scroll and focus on main nav brand logo
      if (ctx.make === 'Ford') {
          $("#brand-nav-logo-lnk").focus();
      } else {
          $(".brand-nav-logo-lnk:visible").focus();
      }
    });
  }

})(jQuery, FD.Brand.lodash, FD.Brand.Context);

;(function($, brand, ctx, search, util) {
    var $resultsContainer;
    var $resultsAlert;
    var formActions = {
        'Mobile': '',
        'Desktop': ''
    };

    brand.setInitHandler('[data-fgx-search-bar]', init);

    ///////

    function init(components) {

        if(components.length == 0) {
            return;
        }
        
        var exitOverlayId = components.attr('data-exit-overlay-id');
        var settings = ctx.settings || {};
        var formAction;
        var mqlPhone = window.matchMedia('(max-width: 767px)');

        formActions.Mobile = getFormActionUrl('Mobile');
        formActions.Desktop = getFormActionUrl();

        if(formActions.Mobile !== formActions.Desktop) {
            formAction = getCurrentFormAction();
            mqlPhone.addListener(handleResize);
        } else {
            formAction = formActions.Desktop || '';
        }

        $resultsContainer = $('.search-suggestions', components);
        $resultsAlert = $('.search-suggestions-info', components);

        $("form", components).attr("action", formAction);
        
        $("form", components).on('submit', function(ev){
            var params = {
                q: $('.search-bar-input', components).val()
            };
            var hrefValue = formAction + "?" + util.parameters.encode(params);
            var submitAction = $(this).attr('data-fd-metrics-submit-action');
            var fireSubmitAction = function() {
                if (typeof submitAction != 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        submitAction
                    );
                }
            };

            if (typeof exitOverlayId != 'undefined' && (brand.Link && brand.Link.exitOverlays && typeof (brand.Link.exitOverlays[exitOverlayId]) != 'undefined')) {
                // ensure we have an href attribute for the simple choice overlay logic
                $("form", components).attr("href", hrefValue);
                $(this).attr("target", "_blank");
                FD.Brand.Link.exitOverlays[exitOverlayId].externalUrl.call(this, ev, true);
            } else {
                ev.preventDefault();
                fireSubmitAction();
                window.location.assign(hrefValue);
                return;
            }
            // our exit overlay has its own metrics action, but we should still fire this one if it's configured.
            fireSubmitAction();
        });

        search.initAstuteSession().done(function(resp) {
            util.log("searchBar::init - astute session initialized");
            $('.search-bar-input', components).on('input', function() {
                if($(this).val().length === 0) {
                    $resultsContainer.hide();
                    $resultsAlert.text('');
                    $(this).toggleClass('fgx-list-shown', false);//BRAND-12331
                } else {
                    search.astuteTypeAheadResults($(this).val(), $resultsContainer, $(this), $resultsAlert);
                }
            });
        }).fail(function() {
            util.log("searchBar::init - error initializing astute session");
        });

        $('.search-bar-input', components).on('keydown', function(ev){
            //BRAND-12331
            if (ev.which === 40 && $(this).hasClass('fgx-list-shown')) {
                // focus on the very first type-ahead result item
                var firstItem = $resultsContainer.find('li').first();
                firstItem.focus();
            }
        });
        $('.search-bar-input', components).on('blur', function() {
            // need a slight delay to see if we've tabbed to a result item
            setTimeout(function(){
                var active = $(document.activeElement);
                if (!active.hasClass('search-res-item') && !$resultsContainer.hasClass('fgx-is-scrolling')) {
                    // if we're not focused on a results item, hide the type-ahead results container
                    $resultsContainer.hide();
                    $resultsAlert.text('');
                    $('.search-bar-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                    $('.search-bar-input', components).removeAttr('aria-activedescendant');
                    $('.search-res-item', components).attr('aria-selected', 'false');
                } else if (active.hasClass('search-res-item')) {
                    // if we've tabbed onto a results item, set a listener for when the results items lose focus so we can properly hide the results container.
                    $('.search-res-item', components).on('focusout', function() {
                        setTimeout(function(){ 
                            var active = $(document.activeElement);
                            if (!active.hasClass('search-res-item') && !active.hasClass('search-bar-input')) {
                                $resultsContainer.hide();
                                $resultsAlert.text('');
                                $('.search-bar-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                                $('.search-res-item', components).off('focusout');
                            }
                        }, 100);
                    });
                }
            }, 100);
        });
        // handling for if the search suggestions scroll bar is clicked, ensuring we don't hide our type-ahead results container in that case.
        $resultsContainer.on('mousedown', function(ev){
            $resultsContainer.addClass('fgx-is-scrolling');
        });
        $resultsContainer.on('mouseup', function(ev){
            $('.search-bar-input', components).focus();
            $resultsContainer.removeClass('fgx-is-scrolling');
        });
        $('.search-bar-submit', components).on('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            $(this).closest("form").submit();
        });
                                                                     
        $('.accordion-heading', components).on('click', function() {
            var $el = $(this);
            var expandAction = $(this).attr('data-fd-metrics-open');
            if ($el.hasClass('open')) {
                $el.toggleClass('open');
                $el.attr('aria-expanded', 'false');
                $el.next('.accordion-content').toggleClass('open').hide();
            } else {
                $('.accordion-heading.open', components).removeClass('open').attr('aria-expanded', 'false');
                $('.accordion-content.open', components).removeClass('open').hide();
                $el.toggleClass('open');
                $el.attr('aria-expanded', 'true');

                var events = 'animationend webkitAnimationEnd MSAnimationEnd transitionend webkitTransitionEnd';

                $el.next('.accordion-content').show().toggleClass('open').one(events, function(){
                    $('html, body').animate({
                    //compensate for static navbar
                    scrollTop: $el.offset().top - $('.navbar-static-top').height()
                    }, 200);
                });
                if (typeof expandAction != 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        $el.attr('data-fd-metrics-open')
                    );
                }
            }
        });


        function getCurrentFormAction(mediaKey) {
            if(!mediaKey) {
                mediaKey = (util.currentBreakpoint() === 'gux-bkpt-sm') ? 'Mobile' : 'Desktop';
            }
            return formActions[mediaKey] || formActions['Desktop'] || '';
        }

        function handleResize(mqlPhone) {
            var mediaKey = (mqlPhone.matches) ? 'Mobile' : 'Desktop';
            formAction = getCurrentFormAction(mediaKey);
            $("form", components).attr("action", formAction);
        }

        function getBaseUrl(type, mediaKey) {
            var key = type + 'Url';
            mediaKey = mediaKey || '';
            return settings[key + ctx.make + ctx.languageKey + mediaKey] || settings[key + ctx.languageKey + mediaKey] || settings[key + ctx.make + mediaKey] || settings[key + mediaKey];
        }

        function getFormActionUrl(mediaKey) {
            var type = 'astuteSearch';
            var mediaTypeUrl = null;
            if(mediaKey) {
                mediaTypeUrl = getBaseUrl(type, mediaKey);
            }
            return mediaTypeUrl || getBaseUrl(type);
        }
    }
})(jQuery, FD.Brand, FD.Brand.Context, FD.Brand.Search, FD.Brand.Util);
;(function($, _, brand, overlay) {

    brand.setInitHandler('[data-fgx-secondary-navigation]', init);

    //////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        var $windowEl = $(window),
            $mainNav = null,
            $section = components,
            $el = $section.find(".nav-secondary_wrapper"),
            $bar_el = $el.find(".nav-secondary_bar"),
            $ul_el = $bar_el.find(".nav-secondary"),
            $hamburger_el = $ul_el.find(".nav-secondary_main_hamburger"),
            bar_height = cssNum($ul_el.find(".nav-secondary_menu1_top"), "padding"),
            _onResize_d = _.debounce(_onResize, 50),
            $elOffsetTop,
            menu_connect,
            break_point = window.FD.Brand.Util.currentBreakpoint(),
            ovr = {};

        if($(".fordMainNavigation .navbar.navbar-default").length > 0){
            $mainNav = $(".fordMainNavigation .navbar.navbar-default");
        }else if($(".lincolnMainNavigation .navbar.navbar-default").length > 0){
            $mainNav = $(".lincolnMainNavigation .navbar.navbar-default");
        }else{}

        /*init */
        $windowEl.resize(_onResize_d);
        $windowEl.scroll(_.throttle(_onScroll, 125));
        setList($ul_el, finishList);

        // * FUNCTIONS *
        function finishList() {

            $elOffsetTop = $section.offset().top + 3;

            $windowEl.resize();
            $windowEl.scroll();

            var $subnav = $el.find('.nav-secondary_menu1 .nav-mask .subnav');
            var $menu1 = $el.find('.nav-secondary_menu1_dropdown');
            var $secondarySubnav = $el.find('li.nav-secondary_submenu.nav-secondary_menu.first');
            var $tertiarySubnav = $el.find('li.nav-secondary_submenu.nav-secondary_menu.second');
            var selected = $subnav.find('li.selected');
            var selectedChildren = $subnav.find('li.nav-secondary_menu3.selected');
            var selectedGrandChildren = $subnav.find('li.nav-secondary_menu3.nav-secondary_menu.selected');
            var hasSelectedGrandChild = false;
            var subnavListItem = $subnav.find('li.nav-secondary_menu2.nav-secondary_menu');

            if(selectedGrandChildren.length > 0){
                selected = selectedGrandChildren.parent().parent().parent();
                hasSelectedGrandChild = true;
            } else if(selectedChildren.length > 0){
                selected = selectedChildren.parent().parent().parent();
            }

            if (selected.length > 0) {
                if ($(selected[0]).find('ul.grandchildren li').length > 0) {
                    var $selected = $(selected[0]);
                    // clone for grandchildren
                    $selected.children().clone().appendTo($secondarySubnav);
                    // clone for great-grandchildren
                    $selected.children().clone().appendTo($tertiarySubnav);
                    // get nav mask for grandchildren 
                    var $navMask = $secondarySubnav.find('.nav-mask');
                    // get nav mask for great-grandchildren
                    var $tertiaryNavMask = $tertiarySubnav.find('.nav-mask');
                    // add grandchildren to secondary
                    var $ul = $secondarySubnav.find('ul.grandchildren').detach().appendTo($navMask);
                    // remove great-grandchildren from secondary
                    $secondarySubnav.find('ul.great-grandchildren').detach();
                    // add great-grandchildren to tertiary
                    var $ul_gc = $tertiarySubnav.find('ul.great-grandchildren.active').detach().appendTo($tertiaryNavMask);
                    // remove grandchildren from tertiary
                    $tertiarySubnav.find('ul.grandchildren').detach();
                    // modify classes for secondary and remove 'hidden' class
                    $ul.removeClass().addClass('dropdown subnav');
                    $secondarySubnav.find('span.nav-secondary_menu2_top').removeClass('nav-secondary_menu2_top').addClass('nav-secondary_menu3_top');
                    var $navTop = $secondarySubnav.find('span.nav-secondary_menu3_top').first();
                    $navTop.append($navTop.find('a').first().html());
                    $navTop.find('a').first().remove();
                    $secondarySubnav.removeClass('hidden');
                    // deal with grandchildren if we have them
                    if (hasSelectedGrandChild && $ul_gc != null) {
                        // modify classes for tertiary and remove 'hidden' class
                        $ul_gc.removeClass().addClass('dropdown subnav');
                        $tertiarySubnav.find('span.nav-secondary_menu2_top').removeClass('nav-secondary_menu2_top').addClass('nav-secondary_menu3_top');
                        var $navTopTertiary = $tertiarySubnav.find('span.nav-secondary_menu3_top').first();
                        $navTopTertiary.find('a').first().remove();
                        $navTopTertiary.append(selectedGrandChildren.find('a').first().html());
                        $tertiarySubnav.removeClass('hidden');
                    }
                    
                }
            }
            
            // WC - If we ever have an href that's an anchor, make sure we close all sub-menus on click.
            $el.find($('a')).each(function() {
                var $this = $(this);
                var href = $this.attr('href');
                if (href && href.indexOf('#') === 0) {
                    $this.on("click", clickOff);
                }
            });

            $el.find($('li.nav-secondary_menu')).each(function() {
                var $this = $(this),
                    _mask = $this.children('.nav-mask'),
                    _subnav = _mask.children('.subnav');

                if ($this.find('span.has-children').length > 0) {
                    $this.on("click", clickSubNav);

                    if($this.hasClass("nav-secondary_menu1") || $this.hasClass("nav-secondary_submenu")) {
                        var $childSpan = $this.children('span.has-children');
                        $childSpan.attr('aria-expanded', 'false').addClass('expandable-always');

                        if($this.hasClass("nav-secondary_submenu")) {
                            $childSpan.attr({'tabindex': '0', 'role': 'button', 'data-fgx-keypress': 'true'});
                        }

                        var ovrId = $this.attr('data-fgx-secondaryNav-ovr-id') || '';
                        if(ovrId) {
                            $this.addClass('fgx-trap-focus');
                            var _ovr = {
                                id: ovrId,
                                $el: $this,
                                focusElements: 'a:visible, button:visible, [data-fgx-keypress]:visible',
                                lastFocus: $childSpan,
                                expanded: false,
                                hide: function() {
                                    var $menuLi = $(document.activeElement).closest('.fgx-trap-focus');
                                    _clickSubNav($menuLi, true);
                                }
                            };

                            if(ovr && ovr[_ovr.id]) {
                                ovr[_ovr.id] = _.extend({}, ovr[_ovr.id], _ovr);
                            } else {
                                ovr[_ovr.id] = _ovr;
                            }
                        }
                    }
                }
                if ($this.hasClass('nav-secondary_submenu') && $this.find('.nav-title a').length > 0) {
                    $this.find('.nav-title a').first().addClass('hidden');
                    $this.find('.nav-title').first().append($this.find('.nav-title a').first().html());
                }

                if ($this.hasClass("nav-secondary_next-steps")){
                    //_subnav.width($this.width()-2);
                } else {
                    _mask.width($this.width());
                    _subnav.css('width', $this.width());
                }

            });

            // Need to call function to identify mobile only dropdowns within the list
            findChildLists();
            
            // focusout handlers to close an open menu when we tab away from it
            $el.on('focusout', onElementFocusOut);

            //force main nav to nonsticky
            if ($mainNav && $mainNav.length > 0 && !$mainNav.hasClass("nonsticky")) {
                $mainNav.addClass("nonsticky");
            }

            $hamburger_el.click(function(event) {
                $section.toggleClass("open");
                if($mainNav && $mainNav.length > 0) {
                    $mainNav.toggleClass("open");
                }
            });

            $(".next-steps").children(".fgx-on-mobile").clone().addClass('next-steps-append').appendTo(".subnav-wrapper");
            
            if (break_point === "gux-bkpt-med" || break_point === "gux-bkpt-sm") {
                // we need to hide our next steps item.
                $el.find('.next-steps').hide();
            }
            if (break_point === "gux-bkpt-sm") {
                // if we're on mobile, our tabindexes for sub-menus with children or grandchildren should be set to 0
                $('span.nav-secondary_menu2_top.has-children[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $('span.nav-secondary_menu3_top.has-children[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $('span.has-grandchildren[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $el.find('.expandable-mobile-only').each(function() {
                    var $closestMenu = $(this).closest('li.nav-secondary_menu');
                    $(this).attr('aria-expanded', $closestMenu.hasClass('open') ? 'true' : 'false');
                });
            } else {
                // if we're not on mobile, our tabindexes for sub-menus with children or grandchildren should be set to -1
                $('span.nav-secondary_menu2_top.has-children[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $('span.nav-secondary_menu3_top.has-children[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $('span.has-grandchildren[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $el.find('.expandable-mobile-only').removeAttr('aria-expanded');
            }
            
            $el.find('.no-viz').removeClass('no-viz');
            $el.removeClass('no-viz');
            $(".nav-secondary").addClass("loaded");
        }
        
        function onElementFocusOut(ev) {
            setTimeout(function() {
                var $active = $(document.activeElement);
                
                var $subnav = $el.find('li.nav-secondary_menu1');
                var $secondarySubnav = $el.find('li.nav-secondary_submenu.nav-secondary_menu.first');
                var $tertiarySubnav = $el.find('li.nav-secondary_submenu.nav-secondary_menu.second');
                
                if ($subnav.hasClass('open')) {
                    var $result = $subnav.find($active);
                    if (!$active.is($subnav) && (!$result.length || $result.length <= 0)) {
                        closeMenu($subnav);
                    }
                }
                
                if ($secondarySubnav.hasClass('open')) {
                    var $result = $secondarySubnav.find($active);
                    if (!$active.is($secondarySubnav) && (!$result.length || $result.length <= 0)) {
                        closeMenu($secondarySubnav);
                    }
                }
                
                if ($tertiarySubnav.hasClass('open')) {
                    var $result = $tertiarySubnav.find($active);
                    if (!$active.is($tertiarySubnav) && (!$result.length || $result.length <= 0)) {
                        closeMenu($tertiarySubnav);
                    }
                }
                
            }, 150);
        }

        function findChildLists() {
            var markChildLists = function($container) {
                if(!$container || $container.length === 0) {
                    return;
                }

                var $childListEl = $container.find('span.has-children');
                $childListEl.each(function() {
                    $(this).addClass('expandable-mobile-only');
                });
            };

            markChildLists($el.find('.nav-secondary_menu1 .nav-mask .subnav'));
            markChildLists($el.find('li.nav-secondary_submenu.nav-secondary_menu > .nav-mask'));
        }
        
        function setNavBarHeights(){

            $('#navbar').remove();

            var $mainNav_collapse = $mainNav.find(".navbar-collapse .navbar-nav .open .dropdown-menu"),
                collapse_height = Number($mainNav_collapse.height()),
                newHeight = Number($mainNav.height());

            $("<style>")
                .prop("id", "navbar")
                .prop("type", "text/css")
                .html("\
    .secondaryNavigation.section.fixed.open {\
        top: " + newHeight + "px;\
    }\
    .secondaryNavigation.section {\
        padding-top: " + (collapse_height === 0 ? 0 : collapse_height) + "px;\
    }")
                .appendTo("head");
        }

        function cssNum(el, string) {
            var val = el.css(string);
            return (val) ? Number(val.replace("px", "")) : 0;
        }

        //NZ - This function should no longer be necessary. The chevrons were added directly to the markup with proper conditional checks
        function setChevrons(){
            var $has_children = $el.find('.has-children:not(.nav-secondary_menu4_top)');
            $has_children.each(function(){
                var $this = $(this);
                if (!$this.hasClass("nav-secondary_top")){
                    $this.children("span").addClass('nav-secondary_top');
                    $this = $this.children(".nav-secondary_top");
                }
                $this.prepend('<i class="icon-action-chevron-down-25px chevron-down"></i>');
            });
        }

        //NZ - This function should no longer be necessary. The nav-mask div was added to the markup where necessary.
        function setInitialDropdownMargins() {
            $(".subnav").each(function() {
                var $el = $(this),
                    $el_mask = $el.parent(".nav-mask");

                if ($el_mask.length === 0) {
                    $el.wrap('<div class="nav-mask"></div>');
                    $el_mask = $el.parent(".nav-mask");
                }

                $el_mask.height(0);
            });
        }

        //NZ - this function should no longer be necessary. All references to it have been commented out/removed.
        function setDropdownsMargins() {
            var $id = setInterval(function(){
                var check = true,
                    $outerHeight,
                    $lastheight,
                    $height;

                $(".subnav:hidden").each(function() {
                    var $el = $(this),
                        $el_mask = $el.parent(".nav-mask");

                    $el.removeAttr("mask-height");
                    $el.removeAttr("style");

                    $el_mask.height(0);
                });

                $(".subnav:visible").each(function() {
                    var $el = $(this),
                        $el_mask = $el.parent(".nav-mask");

                    $outerHeight = Number($el.outerHeight());
                    $height = $outerHeight + cssNum($el,"marginTop");
                    $lastheight = Number($el_mask.height());

                    if ($lastheight !== $height){
                        $el.css("marginTop", $outerHeight * -1);
                        $el.attr("mask-height", $height);
                        check = false;
                    }
                    $el_mask.height($height);
                });
                if (check){
                    if (!$el.hasClass("loaded")){
                        $el.addClass("loaded");
                    }

                    if($ul_el.children(".nav-secondary_menu1").children(".nav-mask").hasClass("force-overflow")) {
                        updateClassList($ul_el.children(".nav-secondary_menu1").children(".nav-mask"), "force-overflow", false);
                    }

                    clearInterval($id);
                }
            }, 30);
        }

        function handleBodyClick(event) {
            if(!$(event.target).closest('.nav-secondary_wrapper').length && !$(event.target).is('.nav-secondary_wrapper')) {
                clickOff();
            }
        }

        function clickSubNav(e) {

            // MG: is there a need for this,
            // e.stopPropagation();

            // NZ: looks like the stopPropagation was for the mobile sub-navs. This should be a workaround.
            var targetClsList = $(e.target).closest(".nav-secondary_menu").attr("class"),
                currentClsList = $(this).closest(".nav-secondary_menu").attr("class");

            if(targetClsList === currentClsList) {
                _clickSubNav($(e.currentTarget));
            }
        }

        function clickOff(e) {
            _clickSubNav($('.nav-secondary_menu1'), true);
        }

        function _clickSubNav(_currentTarget, _open) {
            // var $submask = _currentTarget.children(".nav-mask"),
            //   $subnav  = $submask.children(".subnav");

            var noopen = _open || false;
            var hideOverflow = false;
            
            if (_currentTarget.hasClass("open")) {
                closeMenu(_currentTarget);
                closeSubMenu(_currentTarget);

                if (_currentTarget.hasClass('nav-secondary_submenu')) {
                    if ($('.nav-secondary_menu2.selected.open').length > 0){
                        closeMenu($('.nav-secondary_menu2.selected'));
                    }
                } else if (_currentTarget.hasClass('nav-secondary_menu2') && _currentTarget.hasClass('selected')) {
                    if ($('.nav-secondary_submenu.open').length > 0){
                        closeMenu($('.nav-secondary_submenu'));
                    }
                } else if (_currentTarget.hasClass('nav-secondary_menu3') && _currentTarget.hasClass('selected')) {
                    if ($('.nav-secondary_submenu.open').length > 0){
                        closeSubMenu($('.nav-secondary_submenu'));
                    }
                } else if(_currentTarget.hasClass('nav-secondary_menu1')) {
                    updateFixedBody();
                }

                if(_currentTarget.hasClass('fgx-top-level-menu')) {
                    $('body').off('click.fgxSecondaryNavMenu', handleBodyClick);
                }
            } else {
                if (_currentTarget.hasClass('nav-secondary_menu1')) {
                    closeMenu($('.nav-secondary_submenu.first'));
                    closeMenu($('.nav-secondary_submenu.second'));
                    closeMenu($('.nav-secondary_next-steps'));
                    hideOverflow = true;
                } else if (_currentTarget.hasClass('nav-secondary_submenu')) {
                    closeMenu($('.nav-secondary_menu1'));
                    closeMenu($('.nav-secondary_next-steps'));

                    if ($('.nav-secondary_menu2.selected.open').length > 0){
                        openMenu($('.nav-secondary_menu2.selected'));
                    }
                    if ($('.nav-secondary_menu3.selected.open').length > 0){
                        openSubMenu($('.nav-secondary_menu3.selected'));
                    }

                } else if (_currentTarget.hasClass('nav-secondary_menu2')) {

                    $.each($('.nav-secondary_menu2'), function(i, el) {
                        closeMenu($(el));
                    });

                    if (_currentTarget.hasClass("selected") && $('.nav-secondary_submenu').length > 0){
                        openMenu($('.nav-secondary_submenu'));
                    }

                } else if (_currentTarget.hasClass('nav-secondary_next-steps')) {
                    closeMenu($('.nav-secondary_submenu'));
                    closeMenu($('.nav-secondary_menu1'));
                    closeSubMenu($('.nav-secondary_submenu'));
                }

                if (!noopen){
                    openMenu(_currentTarget);
                    openSubMenu(_currentTarget);

                    var mtxAttr = _currentTarget.attr('data-fd-metrics-open');
                    if(mtxAttr) {
                        brand.Metrics.handler.direct(mtxAttr, _currentTarget);
                    }

                    if(_currentTarget.hasClass('nav-secondary_menu1')) {
                        updateFixedBody();
                    }

                    if(_currentTarget.hasClass('fgx-top-level-menu')) {
                        $('body').off('click.fgxSecondaryNavMenu', handleBodyClick).on('click.fgxSecondaryNavMenu', handleBodyClick);
                    }
                } else {
                    if(_currentTarget.hasClass('fgx-top-level-menu')) {
                        $('body').off('click.fgxSecondaryNavMenu', handleBodyClick);
                    }
                }
            }
        }

        function openMenu($el) {
            var $submask = $el.children(".nav-mask"),
                $subnav = $submask.children(".subnav");

            if($submask.hasClass("closed")) {
                $submask.removeClass("closed");
            }

            updateAriaExpanded($el, 'open');

            $subnav.addClass("open").show();
            $el.addClass("open");

            updateFocusTrap($el, 'open');
        }

        function closeMenu($el) {
            var $submask = $el.children(".nav-mask"),
                $subnav = $submask.children(".subnav");

            if(!$submask.hasClass("closed")) {
                $submask.addClass("closed");
            }

            updateAriaExpanded($el, 'close');
            updateFocusTrap($el, 'close');

            $subnav.removeClass("open");
            if (!$subnav.hasClass('next-steps') || ($subnav.hasClass('next-steps') && (break_point === "gux-bkpt-med" || break_point === "gux-bkpt-sm"))) {
                $subnav.hide();
            }
            $el.removeClass("open");
        }
        
        function openSubMenu($el) {
            var $submask = $el.children(".sub-nav-mask"),
                $subnav = $submask.children(".subnav"),
                $mobileChangeModelBtn = $('.mw-wrapper.model-compare .content-wrap .comparison.mobile-change-model'),
                $mobileModelTitles = $('.mw-wrapper.model-compare .content-wrap .comparison.mobile-titles');

            if($submask.hasClass("closed")) {
                $submask.removeClass("closed");
            }

            updateAriaExpanded($el, 'open');

            $subnav.addClass("open").show();
            $el.addClass("open");
            $mobileChangeModelBtn.addClass("hidden");
            $mobileModelTitles.addClass("hidden");

            updateFocusTrap($el, 'open');
        }

        function closeSubMenu($el) {
            var $submask = $el.children(".sub-nav-mask"),
                $subnav = $submask.children(".subnav"),
                $mobileChangeModelBtn = $('.mw-wrapper.model-compare .content-wrap .comparison.mobile-change-model'),
                $mobileModelTitles =  $('.mw-wrapper.model-compare .content-wrap .comparison.mobile-titles');

            if(!$submask.hasClass("closed")) {
                $submask.addClass("closed");
            }

            updateAriaExpanded($el, 'close');
            updateFocusTrap($el, 'close');
            
            $subnav.removeClass("open");
            if (!$subnav.hasClass('next-steps') || ($subnav.hasClass('next-steps') && (break_point === "gux-bkpt-med" || break_point === "gux-bkpt-sm"))) {
                $subnav.hide();
            }
            $el.removeClass("open");
            $mobileChangeModelBtn.removeClass("hidden");
            $mobileModelTitles.removeClass("hidden");
        }

        function updateAriaExpanded($el, action) {
            var $btnElm = null,
                $childElm = $el.children('span.has-children');

            if($childElm.hasClass("expandable-mobile-only")) {
                if(break_point === 'gux-bkpt-sm') {
                    $btnElm = $childElm;
                }
            } else {
                $btnElm = $childElm;
            }

            if($btnElm != null && $btnElm.length > 0) {
                $btnElm.attr('aria-expanded', (action === 'open') ? 'true' : 'false');
            }
        }

        function updateFocusTrap($el, action) {
            if($el && $el.hasClass('fgx-trap-focus')) {
                var ovrId = $el.attr('data-fgx-secondaryNav-ovr-id') || '';

                if(ovrId) {
                    var _ovr = ovr[ovrId];

                    if(action === 'open') {
                        _ovr.expanded = true;
                        overlay.trapFocus(_ovr, _ovr.focusElements, undefined, $el.children('span.has-children'), true);
                    } else {
                        if(_ovr.expanded) {
                            overlay.releaseFocus(_ovr);
                        }
                        _ovr.expanded = false;
                    }
                }
            }
        }

        function updateClassList($el, clsName, addClass) {
            if(addClass) {
                $el.addClass(clsName);
            } else {
                $el.removeClass(clsName);
            }
        }

        function updateFixedBody() {
            var $body = $('body'),
                $navSecondary = $el.find(".nav-secondary_menu1"),
                isOpen = $navSecondary.hasClass("open");

            if(isOpen && $section.hasClass("fixed")) {
                if(!$body.hasClass("secondaryNavFixed")) {
                    $body.addClass("secondaryNavFixed");
                }
            } else {
                if($body.hasClass("secondaryNavFixed")) {
                    $body.removeClass("secondaryNavFixed");
                }
            }
        }

        function setHRef(data) {
            //METRICS
            // metrics.clickEvent(data.metrics);
            //go to data.href;

        }

        function setList(el, callback) {

            //move child menu elements to parents
            el.find("[data-parent]").each(function(){
                var t = $(this);
                t.detach().appendTo($el.find("[data-level='" + t.attr("data-parent") + "']"));
                t.removeAttr('data-parent');
            });

            //set metrics
            el.find("[data-href]").each(function(){
                var t = $(this);
                t.on("click", {
                    href: t.attr("data-href"),
                    metrics: t.attr("data-metrics")
                }, setHRef);
            });

            callback ? callback() : null;

        }

        //NZ: This function should no longer be needed. All references to it have been commented out/removed.
        function setWrapperWidth(bool) {
            var _fixed = $section.hasClass("fixed");

            if (!_fixed){
                $section.removeAttr("style");
                return;
            }

            //get wrapper original width
            $section.removeClass("fixed");

            if (bool){
                $section.removeAttr("style");
            }

            var menu_width = $section.width();
            $section.addClass("fixed");

            var checkstyle = $section.attr("style");

            if (typeof checkstyle === typeof undefined || checkstyle === false || Number($section.attr("lastwidth")) !== menu_width){
                $section.width(menu_width);
                $section.attr("lastwidth", menu_width);
            }
        }

        function _onResize() {
            $elOffsetTop = $section.offset().top + 3;
            $el.removeClass("loaded");
            break_point = window.FD.Brand.Util.currentBreakpoint();
            var $nextStepsUl = $el.find('.next-steps');
            if (break_point !== "gux-bkpt-med" && break_point !== "gux-bkpt-sm") {
                // we need to show our next steps dropdown item.
                $nextStepsUl.show();
                // add role="presentation" to all 'next-steps' <ul> / <li> elements since they are not actually behaving like list elements
                $nextStepsUl.attr('role', 'presentation');
                $nextStepsUl.find('li').attr('role', 'presentation');
            } else {
                // we need to hide our next steps dropdown item.
                $nextStepsUl.hide();
                // remove role="presentation" from all 'next-steps' <ul> / <li> elements since they are now behaving like list elements
                $nextStepsUl.removeAttr('role');
                $nextStepsUl.find('li').removeAttr('role');
            }
            if (break_point === "gux-bkpt-sm") {
                // if we're on mobile, our tabindexes for sub-menus with children or grandchildren should be set to 0
                $('span.nav-secondary_menu2_top.has-children[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $('span.nav-secondary_menu3_top.has-children[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $('span.has-grandchildren[tabindex]', $el).attr('tabindex', '0').attr('role', 'button');
                $el.find('.expandable-mobile-only').each(function() {
                    var $closestMenu = $(this).closest('li.nav-secondary_menu');
                    $(this).attr('aria-expanded', $closestMenu.hasClass('open') ? 'true' : 'false');
                });
            } else {
                // if we're not on mobile, our tabindexes for sub-menus with children or grandchildren should be set to -1
                $('span.nav-secondary_menu2_top.has-children[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $('span.nav-secondary_menu3_top.has-children[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $('span.has-grandchildren[tabindex]', $el).not('.expandable-always').attr('tabindex', '-1').removeAttr('role');
                $el.find('.expandable-mobile-only').removeAttr('aria-expanded');
            }
        }

        function _onScroll() {
            if ($windowEl.scrollTop() >= $elOffsetTop) {
                if (!$section.hasClass("fixed")) {
                    $section.addClass("fixed");
                    updateFixedBody();
                }
            } else {
                if ($section.hasClass("fixed")) {
                    $section.removeClass("fixed");
                    $section.removeClass("open");
                    if($mainNav && $mainNav.length > 0) {
                        $mainNav.removeClass("open");
                    }
                    updateFixedBody();
                }
            }
        }

        (function splitModelNameAndYear() {
            var text = $($('.secondaryNavigation .nav-secondary .dropdown-font .model-year')[0]).text(),
            yearText = text.substring(0, text.indexOf(" ")),
            modelText = text.substring(text.indexOf(" ")),
            yearElem = $('.secondaryNavigation .nav-secondary .dropdown-font .model-year')[0],
            modelElem = $('.secondaryNavigation .nav-secondary .dropdown-font .model-name')[0];
            $(yearElem).text(yearText);
            $(modelElem).text(modelText);
        })();

    }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay);

/*global FD*/
;(function (win, $, brand, overlay, search, ctx) {
    var ovr,
        $resultsContainer,
        $resultsAlert;

    brand.setInitHandler('[data-fgx-search-overlay]', init);

    /////////////

    function init(components) {
        var ovrTriggers = $('[data-fgx-search-overlay-trigger]'),
            defaultAction = (ctx.make === 'Ford') ? "//www.ford.com/search/" : "//www.lincoln.com/search/",
            formAction = ctx.settings['ngbsSearchUrl' + ctx.make + ctx.languageKey] || ctx.settings['ngbsSearchUrl' + ctx.make] || defaultAction,
            mtxActions = ctx && ctx.mtxActions,
            searchSubmitAction = mtxActions && mtxActions.searchSubmitAction || null,
            searchOverlayOpenAction = mtxActions && mtxActions.searchOverlayOpenAction || null;

        ovr = overlay.register('searchOverlay', components);
        $resultsContainer = $('.search-suggestions', components);
        $resultsAlert = $('.search-suggestions-info', components);
        $("form", components).attr("action", formAction);

        search.setReferrerApp($('.form-wrapper', components));

        ovrTriggers.each(function() {
            $(this).on('click', 'a', function(ev) {
                $(".navbar-static-top .drop-parent .dropdown-menu").hide();
                ev.preventDefault();
                $(window).scrollTop(0);
                ovr.show(true, $(this), '.search-overlay-input');
                // new metrics
                if (searchOverlayOpenAction) {
                    FD.Brand.Metrics.handler.direct(
                        searchOverlayOpenAction
                    );
                }
            });
        });
        
        // listen for form to submit so we can track on both the submit button click, or enter
        $("form", components).on('submit', function(){
            // new metrics
            if (searchSubmitAction) {
                FD.Brand.Metrics.handler.direct(
                    searchSubmitAction
                );
            }
        });

        $('.icon-close', components).on('click', function() {
            ovr.hide();
            //show main nav items slightly after hiding overlay, so they dont reappear until after overlay closes
            setTimeout(function(){ $(".navbar-static-top .drop-parent .dropdown-menu").show(); }, 350);
        });
        $('.search-overlay-input', components).on('input', function() {
            if($(this).val().length === 0) {
                $resultsContainer.hide();
                $resultsAlert.text('');
                $(this).toggleClass('fgx-list-shown', false);//BRAND-12331
            } else {
                search.typeAheadResults($(this).val(), $resultsContainer, $(this), $resultsAlert);
            }
        });
        $('.search-overlay-input', components).on('keydown', function(ev){
            //BRAND-12331
            if (ev.which === 40 && $(this).hasClass('fgx-list-shown')) {
                // focus on the very first type-ahead result item
                var firstItem = $resultsContainer.find('li').first();
                firstItem.focus();
            }
        });
        $('.search-overlay-input', components).on('blur', function() {
            // need a slight delay to see if we've tabbed to a result item
            setTimeout(function(){ 
                var active = $(document.activeElement);
                if (!active.hasClass('search-res-item') && !$resultsContainer.hasClass('fgx-is-scrolling')) {
                    // if we're not focused on a results item, hide the type-ahead results container
                    $resultsContainer.hide();
                    $resultsAlert.text('');
                    $('.search-overlay-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                    $('.search-overlay-input', components).removeAttr('aria-activedescendant');
                    $('.search-res-item', components).attr('aria-selected', 'false');
                } else if (active.hasClass('search-res-item')) {
                    // if we've tabbed onto a results item, set a listener for when the results items lose focus so we can properly hide the results container.
                    $('.search-res-item', components).on('focusout', function() {
                        setTimeout(function(){ 
                            var active = $(document.activeElement);
                            if (!active.hasClass('search-res-item') && !active.hasClass('search-overlay-input')) {
                                $resultsContainer.hide();
                                $resultsAlert.text('');
                                $('.search-overlay-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                                $('.search-res-item', components).off('focusout');
                            }
                        }, 100);
                    });
                }
            }, 100);
        });
        // handling for if the search suggestions scroll bar is clicked, ensuring we don't hide our type-ahead results container in that case.
        $resultsContainer.on('mousedown', function(ev){
            $resultsContainer.addClass('fgx-is-scrolling');
        });
        $resultsContainer.on('mouseup', function(ev){
            $('.search-overlay-input', components).focus();
            $resultsContainer.removeClass('fgx-is-scrolling');
        });
        $('.search-overlay-submit', components).on('click', function() {
            $(this).closest("form").submit();
        });

        $(document).click(function(event) {
            //reveal dropdown menus when search overlay closed by clicking outside of search overlay template
            if( $(".search-overlay.template").is(":visible") && !$(event.target).closest('.search-overlay.template').length) {
                setTimeout(function(){ $(".navbar-static-top .drop-parent .dropdown-menu").show(); }, 350);
            }
        });
    }

})(window, jQuery, FD.Brand, FD.Brand.Overlay, FD.Brand.Search, FD.Brand.Context);

;(function($, _, brand, search, ctx, pricing) {

    brand.setInitHandler('[data-fgx-lincoln-main-navigation]', init);

    function init(components) {
        if(components.length == 0) {
            return;
        }

        if(ctx && ctx.hideGlobalHeader) {
            $(components).addClass('fgx-brand-hidden');
        }

        var mtxActions = ctx && ctx.mtxActions,
            languageSelectorOverlayOpenAction = mtxActions && mtxActions.languageSelectorOverlayOpenAction || null,
            defaultAction = (ctx.make === 'Ford') ? "//www.ford.com/search/" : "//www.lincoln.com/search/",
            formAction = ctx.settings['ngbsSearchUrl' + ctx.make + ctx.languageKey] || ctx.settings['ngbsSearchUrl' + ctx.make] || defaultAction,
            $searchForm = $('form.mobile-search-form', components),
            $resultsContainer = $searchForm.find('.search-suggestions'),
            $bgOverlay = $('.lincolnMainNavOverlay'),
            $navbarToggle = $('.navbar-toggle', components),
            $body = $('body'),
            rowBtnSizeClasses = {
                3: 'three-btns',
                4: 'four-btns',
                5: 'five-btns'
            },
            ovr = {},
            mobileMainMenuOvr = {
                lastFocus: $navbarToggle,
                $el: $('.menu-items-container', components),
                hide: function() {
                    toggleMobileMenu.call($navbarToggle);
                }
            },
            mobileFirstLevelIsTrapped = false,
            mobileSecondLevelIsTrapped = false,
            mobileAnimationTriggered = false,
            mqlPhone = window.matchMedia('(max-width: 767px)'),
            _hasSecondaryNav = ($('.secondaryNavigation').length > 0),
            _layoutKey = (brand.Util.currentBreakpoint() == 'gux-bkpt-sm') ? 'mobile' : 'desktop',
            navHeight = components.outerHeight(),
            _dynamDisplayOnScroll = ((components.attr('data-dynamic-scroll-display-enabled') || '') === 'true'),
            _forceNoDynamDisplay = false;

        brand.Dig.resolve(components);

        components.each(function() {
            pricing.refresh(this);
        });
        
        mqlPhone.addListener(handleResize);

        // Mobile Search Setup
        $searchForm.attr("action", formAction);
        search.setReferrerApp($searchForm.find('.form-wrapper'));

        // Server-Side Current Page object will not work on rewritten Publish URLs - handling this via JS.
        var relativeLoc = '/' + window.location.href.replace(/^(?:\/\/|[^\/]+)*\//, "");
        $('.nav-link-item', components).each(function(){
            var href = $(this).attr('href');
            if (href === relativeLoc || href === window.location.href) {
                $(this).addClass('active');
            }
        });

        // user menu
        brand.User.authentication.subscribe(setUserMenuState);

        // dealer detail
        brand.User.dealer.subscribe(setDealerDetail);

        // Event Handlers
        $('.flyout-container', components).on('focusin', '.fgx-brand-nav-flyout-end', function(ev) {
            var focusSelector = '.flyout-container ' + ((_layoutKey === 'mobile') ? '.flyout-back' : '.flyout-close-tablet');
            updateFocus(focusSelector);
        });

        $('.menu-items-container', components).on('focusin', '.fgx-brand-nav-mobile-menu-end', function(ev) {
            if (_layoutKey === 'mobile') {
                updateFocus('.mbl-menu-close');
            }
        });

        $('.navbar-toggle, .mbl-menu-close', components).on('click', function(ev) {
            ev.preventDefault();
            if (brand.Util.currentBreakpoint() == 'gux-bkpt-sm') {
                toggleMobileMenu.call($navbarToggle);
            }
        });

        $('.mbl-menu-close', components).on('focusin focusout', function(ev) {
            $navbarToggle.toggleClass('fgx-focus-display', (ev.type === 'focusin'));
        });

        // language links
        $('.language-dropdown', components).on('click', '.dropdown', function() {
            if(languageSelectorOverlayOpenAction && !$(this).closest('.language-dropdown').hasClass('open')) {
                // language dropdown is being opened
                FD.Brand.Metrics.handler.direct(
                    languageSelectorOverlayOpenAction
                );
            }
        });

        $('.fgx-lang-link', components).on('click', function(ev) {
            if(FD.Brand.Link.switchLanguage(this)) {
                ev.preventDefault();
            }
        });

        $('.flyout-toggle', components).on('click', function(ev) {
            ev.preventDefault();
            var $el = $(this),
                $menuItems = $el.closest('.menu-items-container'),
                $flyoutContainer = $menuItems.find('.flyout-container'),
                $comp = $menuItems.closest('.lincolnMainNavigation'),
                isOpen = $el.hasClass('opened'),
                diffFlyoutOpened = (!isOpen && $menuItems.find('.flyout-toggle.opened').length > 0);

            // Hide the current opened flyout - force the focus to be released from the overlay if one is definitely opened,
            // and skip resetting the focus to the initial element if we're closing a different flyout before opening this one.
            closeFlyoutMenus($menuItems, $flyoutContainer, $comp, (isOpen || diffFlyoutOpened), diffFlyoutOpened);

            if (!isOpen) {
                // Show the flyout for the current toggle element
                var flyoutId = $el.attr('data-nav-flyout-id') || '',
                    $flyoutItem = flyoutId && $flyoutContainer.find('#' + flyoutId);
                if ($flyoutItem && $flyoutItem.length > 0) {
                    // mock up an overlay - we need to trap focus
                    ovr.lastFocus = $el;
                    ovr.$el = $flyoutContainer;
                    ovr.hide = function() {
                        $('.flyout-close-tablet', $flyoutItem).trigger('click');
                    };
                    if (brand.Util.currentBreakpoint() == 'gux-bkpt-sm') {
                        // overrides for mobile
                        ovr.hide = function() {
                            $('.flyout-back', $flyoutContainer).trigger('click');
                        };
                    }
                    
                    $el.addClass('opened').attr('aria-expanded', 'true');
                    $comp.addClass('flyout-opened');
                    $flyoutItem.removeClass('hidden');
                    $flyoutContainer.toggleClass('opened', true);
                    $bgOverlay.toggleClass('open', true);
                    $body.on('click.fgxMainNav', handleBodyClick);

                    FD.Brand.Overlay.trapFocus(ovr, 'a:not([tabindex="-1"]):visible, button:visible, [data-fgx-keypress]:visible', null, $el, true);
                    mobileSecondLevelIsTrapped = true;
                }
            }

            if ($('.secondaryNavigation').length > 0) {
                $menuItems.closest('.navbar-static-top').toggleClass('nonsticky', isOpen);
            }
        });
        
        $('.flyout-close-tablet', components).on('click', function(ev){
            ev.preventDefault();
            var $el = $(this),
                $menuItems = $el.closest('.menu-items-container'),
                $flyoutContainer = $menuItems.find('.flyout-container'),
                $comp = $menuItems.closest('.lincolnMainNavigation');

            // Hide the current opened flyout - force focus to be released, but don't prevent the focus from being reset to the initial element.
            closeFlyoutMenus($menuItems, $flyoutContainer, $comp, true, false);
            
            if ($('.secondaryNavigation').length > 0) {
                $menuItems.closest('.navbar-static-top').toggleClass('nonsticky', true);
            }
        });

        $('.flyout-back', components).on('click', function(ev) {
            ev.preventDefault();
            var $menuItems = $(this).closest('.menu-items-container'),
                $flyoutContainer = $menuItems.find('.flyout-container'),
                $comp = $menuItems.closest('.lincolnMainNavigation'),
                $activeItem = $menuItems.find('.flyout-toggle.opened');

            closeFlyoutMenus($menuItems, $flyoutContainer, $comp, false, false);

            if (isElValid($activeItem)) {
                $activeItem.focus();
            }
        });

        $('.flyout-close', components).on('click', function(ev) {
            // NZ - this is a mix of the flyout-back and navbar-toggle click handlers above, and should more than likely be merged
            // with the logic from those handlers in a separate function at some point, but keeping it separate for now for convenience.
            ev.preventDefault();
            var $el = $(this),
                $flyoutContainer = $el.closest('.flyout-container'),
                $menuItems = $flyoutContainer.closest('.menu-items-container'),
                isOpen = $menuItems.hasClass('opened'),
                $comp = $menuItems.closest('.lincolnMainNavigation'),
                cssProps = (isOpen) ? {"overflow": "", "position": "", "height": ""} : {"overflow": "hidden", "position": "relative", "height": "100%"};

            closeFlyoutMenus($menuItems, $flyoutContainer, $comp, false, false);
            
            if (mobileFirstLevelIsTrapped) {
                FD.Brand.Overlay.releaseFocus(mobileMainMenuOvr);
                mobileFirstLevelIsTrapped = false;
            }

            $menuItems.toggleClass('opened', !isOpen);
            $el.toggleClass('opened', !isOpen);
            $navbarToggle.toggleClass('opened', !isOpen);
            $navbarToggle.attr('aria-expanded', !isOpen);
            $('body').toggleClass('no-scroll-sm', !isOpen);
            // Prevent Body scrolling / Enable scrolling on iOS after close
            $('html').css(cssProps);

            // clear any search input if it exists
            $('.mobile-search-input', components).val('');

            if ($('.secondaryNavigation').length > 0) {
                $el.closest('.navbar-static-top').toggleClass('nonsticky', isOpen);
            }

            if (isElValid($navbarToggle)) {
                $navbarToggle.focus();
            }
        });

        // Vehicle year click handler
        $('.tabnav button.year-item', components).on('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            if ($(this).hasClass('active')) {
                return;
            }
            var $el = $(this),
                goToId = parseInt($el.data('yearTabIdx'), 10) || 0,
                $container = $el.closest('.nav-vehicle-tile-content'),
                $yearLinks = $container.find('button.year-item'),
                $vehicles = $container.find('.vehicle-item');

            $vehicles
                .removeClass('active')
                .filter('[data-year-tabpanel-idx="' + goToId + '"]')
                .addClass('active');

            $yearLinks.removeClass('active').attr('aria-selected', 'false');
            $el.addClass('active').attr('aria-selected', 'true');
        });

        // mobile - search form
        $('.mobile-search-input', components)
            .on('input', function() {
                if($(this).val().length === 0) {
                    $resultsContainer.hide();
                } else {
                    search.typeAheadResults($(this).val(), $resultsContainer, $(this));
                }
            }).on('blur', function() {
                $resultsContainer.hide();
            });

        $('.mobile-search-submit', components).on('click', function() {
            $(this).closest("form").submit();
        });

        // Initialize dynamic scrolling functionality when enabled
        if (_dynamDisplayOnScroll) {
            if (!_hasSecondaryNav) {
                // we're on a brand page that doesn't have the secondary navigation, so setup the dynamic scrolling functionality.
                setupScrollHandling(window);
            }
            $(document).on('brandnav:nodynamicscroll', function(ev) {
                brand.Util.log("lincolnMainNavigation - brandnav:nodynamicscroll handler triggered");
                disableScrollListener(window);
                _forceNoDynamDisplay = true;
            });
        }


        // Functions
        function isElValid($el) {
            return ($el && $el.length > 0);
        }

        function updateFocus(_selector) {
            var $focusEl = $(_selector, components);
            if ($focusEl && $focusEl.length > 0) {
                $focusEl.focus();
            }
        }

        function handleBodyClick(ev) {
            // clicking outside the main nav or within the mainNav but outside of dropdown items should close nav dropdowns
            // and remove the overlay
            var $target = $(ev.target);
            if ($target.hasClass('lincolnMainNavOverlay') || ($target.closest('.lincolnMainNavigation').length && !$target.closest('.flyout-toggle, .flyout-container').length)) {
                var $comp = $('.lincolnMainNavigation'),
                    $menuItems = $comp.find('.menu-items-container'),
                    $flyoutContainer = $menuItems.find('.flyout-container');
                // Hide the current opened flyout
                closeFlyoutMenus($menuItems, $flyoutContainer, $comp, false, false);
            }
        }

        function toggleMobileMenu(skipSecondLevelRel) {
            var $el = $(this),
                $container = $el.closest('.container-fluid'),
                $menuItems = $container.find('.menu-items-container'),
                isOpen = $menuItems.hasClass('opened'),
                cssProps = (isOpen) ? {"overflow": "", "position": "", "height": ""} : {"overflow": "hidden", "position": "relative", "height": "100%"},
                skipSecondLevelRel = skipSecondLevelRel || false;

            $menuItems.toggleClass('opened', !isOpen);
            $el.toggleClass('opened', !isOpen);
            $el.attr('aria-expanded', !isOpen);
            $('body').toggleClass('no-scroll-sm', !isOpen);
            // Prevent Body scrolling / Enable scrolling on iOS after close
            $('html').css(cssProps);

            // clear any search input if it exists
            $('.mobile-search-input', components).val('');

            if ($('.secondaryNavigation').length > 0) {
                $el.closest('.navbar-static-top').toggleClass('nonsticky', isOpen);
            }

            if ($menuItems.hasClass('opened')) {
                // trap focus
                FD.Brand.Overlay.trapFocus(mobileMainMenuOvr, 'a:not([tabindex="-1"]):visible, button:visible, [data-fgx-keypress]:visible', null, $el, true);
                mobileFirstLevelIsTrapped = true;
            } else {
                // release focus
                if (mobileSecondLevelIsTrapped && !skipSecondLevelRel) {
                    FD.Brand.Overlay.releaseFocus(ovr);
                    mobileSecondLevelIsTrapped = false;
                }
                FD.Brand.Overlay.releaseFocus(mobileMainMenuOvr);
                mobileFirstLevelIsTrapped = false;
            }
        }

        function closeFlyoutMenus($menuItems, $flyoutContainer, $comp, forceRelease, skipLastFocus) {
            if (!isElValid($menuItems) || !isElValid($flyoutContainer) || !isElValid($comp)) {
                return;
            }
            // Hide the current opened flyout
            $menuItems.find('.flyout-toggle.opened').removeClass('opened').attr('aria-expanded', 'false');
            $flyoutContainer.toggleClass('opened', false);
            $flyoutContainer.find('.flyout-menu-item').addClass('hidden');
            $comp.removeClass('flyout-opened');
            $bgOverlay.removeClass('open');
            $body.off('click.fgxMainNav', handleBodyClick);

            if (mobileSecondLevelIsTrapped || forceRelease) {
                if (skipLastFocus) {
                    ovr.skipLastFocus = true;
                }
                FD.Brand.Overlay.releaseFocus(ovr);
                ovr.skipLastFocus = false;
                mobileSecondLevelIsTrapped = false;
            }
        }

        function setUserMenuState(authState) {
            var _loaded = authState && authState.loaded || false,
                _authType = authState && authState.authType || '',
                $authFlyoutWrap = $('.user-menu-items .user-btns-wrap', components),
                $authItems = $('[data-auth]', components),
                $currentAuthItems = $authItems.filter('[data-auth~="' + _authType +'"]'),
                currentFlyoutBtnsLen = $currentAuthItems.filter(function() { return ($(this).closest('.user-btns-wrap').length > 0); }).length || 0;
            // hide entire li element if auth is not loaded
            $('.user-menu-toggle', components).toggleClass('hidden', !_loaded);
            $authItems.addClass('hidden');
            $currentAuthItems.toggleClass('hidden', false);

            _.forEach(rowBtnSizeClasses, function(val, key) {
                $authFlyoutWrap.toggleClass(val, currentFlyoutBtnsLen == key);
            });

            if(_authType == 'user') {
                brand.User.profile.current().then(function(profileState) {
                    if(profileState && profileState.firstName) {
                        $currentAuthItems.each(function() {
                            var $titleEl = $(this).find('.btn-headline'),
                                itemTemplate = ($titleEl.data('fgxItemTemplate') || $titleEl.text()).trim(),
                                val = itemTemplate.replace('{firstName}', profileState.firstName);
                            $titleEl.html(val);
                        });
                    }
                });
            }
        }

        function setDealerDetail(dealerState) {
            var $nav = $(components),
                noDealerGnav = $nav.data('noDealerGnav') || '',
                savedDealerGnav = $nav.data('savedDealerGnav') || '',
                gnavParam = (dealerState && dealerState.preferred) ? savedDealerGnav : noDealerGnav;

            $('.dealer-gnav-update', $nav).each(function() {
                var href = $(this).attr('href');
                if(href) {
                    href = appendQueryString(href, gnavParam);
                    $(this).attr('href', href);
                }
            });
        }

        function appendQueryString(url, parameter) {
            var output = '';
            if(url && typeof(url) !== 'undefined') {
                var qsPos = url.indexOf('?');
                if(qsPos >= 0) {
                    var str = url.substring(qsPos);
                    var urlBase = url.substring(0, qsPos);
                    var qs = brand.Util.url.queryString(str);
                    var param = brand.Util.parameters.decode(parameter);
                    qs = qs.add(param);
                    output = urlBase + qs.asString();
                } else if (parameter) {
                    output = url + "?" + parameter;
                } else {
                    output = url;
                }
            }
            return output;
        }

        // Functions to setup and handle dynamic scrolling functionality when enabled
        function setupScrollHandling(el) {
            // wait for initial scroll event before setting up the logic to handle subsequent scrolls. Used in an attempt
            // to prevent the nav from unintentionally being hidden when reloading a page that has already been scrolled.
            $(el).one('scroll.fgxMainNav', function() { createScrollListener(el); });
        }
        function createScrollListener(el) {
            var $el = $(el),
                lastScrollPos = $el.scrollTop(),
                $menuItems = $('.menu-items-container', components),
                $flyoutContainer = $menuItems.find('.flyout-container'),
                scrollLock = false;
            var handleScroll = function() {
                if (!scrollLock) {
                    scrollLock = true;
                    var scrollPos = $el.scrollTop(),
                        scrollDir = ((scrollPos - lastScrollPos) > 0) ? 'down' : 'up',
                        hasOpenFlyout = ((_layoutKey === 'mobile' && mobileFirstLevelIsTrapped && $menuItems.hasClass('opened')) || (_layoutKey === 'desktop' && $flyoutContainer.hasClass('opened')));
                    lastScrollPos = scrollPos;
                    // add or remove the 'hide-off-top' class from the main nav element as needed
                    components.toggleClass('hide-off-top', (!hasOpenFlyout && scrollPos > navHeight && scrollDir === 'down'));
                    // wait before releasing the scroll lock
                    window.setTimeout(function() {
                        scrollLock = false;
                    }, 100);
                } else {
                    lastScrollPos = $el.scrollTop();
                }
            };
            components.addClass('top-trans-enabled');
            if (!_forceNoDynamDisplay) {
                $el.on('scroll.fgxMainNav', handleScroll);
                components.on('focusin.fgxMainNav', function(ev) {
                    $(this).removeClass('hide-off-top');
                });
            }
        }
        function disableScrollListener(el) {
            $(el).off('scroll.fgxMainNav');
            components.removeClass('top-trans-enabled hide-off-top');
        }
        
        // manage focus trapping and transfer as neccessary
        function handleResize(mql) {
            var $openedFlyout = $('.flyout-menu-item:not(.hidden)', components),
                $triggerEl = $('.flyout-toggle.opened', components),
                $flyoutContainer = $('.menu-items-container', components),
                $focused = $(':focus'),
                _hasOpenFlyout = !!($openedFlyout && $openedFlyout.length > 0);
            navHeight = components.outerHeight();
            _layoutKey = (mql.matches) ? 'mobile' : 'desktop';
            if(_layoutKey === 'mobile') {
                // we're mobile
                if (_hasOpenFlyout) {
                    // apply our mobile overrides for our overlay object
                    var firstFocus = 'a.flyout-back';
                    ovr.hide = function() {
                        $('.flyout-back', $flyoutContainer).trigger('click');
                    };
                    // check to see if our mobile toggle thinks it's expanded...
                    if ($navbarToggle.attr('aria-expanded') === 'false') {
                        // release focus on our items, and then reset the mobile menu to be displayed.
                        if (mobileFirstLevelIsTrapped) {
                            FD.Brand.Overlay.releaseFocus(mobileMainMenuOvr);
                        }
                        if (mobileSecondLevelIsTrapped) {
                            FD.Brand.Overlay.releaseFocus(ovr);
                        }
                        toggleMobileMenu.call($navbarToggle);
                    } else {
                        // make sure we release focus, before we re-trap in order of the menu levels...
                        FD.Brand.Overlay.releaseFocus(ovr);
                        FD.Brand.Overlay.releaseFocus(mobileMainMenuOvr);
                        FD.Brand.Overlay.trapFocus(mobileMainMenuOvr, 'a:not([tabindex="-1"]):visible, button:visible, [data-fgx-keypress]:visible', null, $navbarToggle, true);
                        mobileFirstLevelIsTrapped = true;
                    }
                    // Re-trap the focus in the ovr object and set mobileSecondLevelIsTrapped to true regardless of whether the mobile menu was previously opened or not.
                    FD.Brand.Overlay.trapFocus(ovr, 'a:not([tabindex="-1"]):visible, button:visible, [data-fgx-keypress]:visible', firstFocus, $triggerEl, true);
                    mobileSecondLevelIsTrapped = true;

                    // if we were NOT previously focused on the close button for tablet, focus back on the previously focused element
                    if (!$focused.hasClass('flyout-close-tablet')) {
                        // if we are the main vehicle cta or the price disclosure, we will have a parent with the following classes
                        var $vehicleRightCol = $focused.closest('.veh-column-item.column-right');
                        if ($vehicleRightCol && $vehicleRightCol.length > 0) {
                            // we're on mobile, so transfer the focus to the mobile link, which is the vehicle name
                            $vehicleRightCol.find('.nameplate-name').focus();
                        } else {
                            $focused.focus();
                        }
                    }
                }
            } else {
                // we're transitioning to tablet
                if (mobileFirstLevelIsTrapped && $flyoutContainer && $flyoutContainer.hasClass('opened')) {
                    // Close the mobile menu if its opened when we go to tablet. If there is an open flyout within the
                    // mobile menu, it will continue to display in the open state, so indicate to the toggleMobileMenu function
                    // that the flyouts remain open so the focus isn't released from them.
                    mobileMainMenuOvr.skipLastFocus = true;
                    toggleMobileMenu.call($navbarToggle, _hasOpenFlyout);
                    mobileMainMenuOvr.skipLastFocus = false;
                }
                if (_hasOpenFlyout) {
                    if ($focused.hasClass('flyout-back') || $focused.hasClass('flyout-close')) {
                        $('.flyout-close-tablet', $openedFlyout).focus();
                    } else {
                        // if we are the main vehicle cta or the price disclosure, we will have a parent with the following classes
                        var $vehicleRightCol = $focused.closest('.veh-column-item.column-right');
                        if ($vehicleRightCol && $vehicleRightCol.length > 0) {
                            // we're on mobile, so transfer the focus to the mobile link, which is the vehicle name
                            $vehicleRightCol.find('.main-cta > a').focus();
                        }
                    }
                }
            }
        }

    }
})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Search, FD.Brand.Context, FD.Brand.Pricing);
/*global FD*/
;(function ($, win, brand, overlay, ctx) {

    var ovr;
    var currentLanguage = null;
    brand.setInitHandler('[data-fgx-language-selector]', init);

    /////////////

    function init(components) {
        // relocate overlay to be direct child of body
        // $('body').append(components);
        // components = $('[data-fgx-language-selector]');

        var mtxActions = ctx && ctx.mtxActions,
            languageSelectorOverlayOpenAction = mtxActions && mtxActions.languageSelectorOverlayOpenAction || null,
            changeLanguageAction = mtxActions && mtxActions.changeLanguageAction || null;

        ovr = overlay.register('languageSelector', components, {
            show: function() {
                // new metrics
                if (languageSelectorOverlayOpenAction) {
                    FD.Brand.Metrics.handler.direct(
                        languageSelectorOverlayOpenAction
                    );
                }
            }
        });
        $('.icon-close', components).on('click', function() {
            ovr.hide();
        });
        $('.continue-lang-btn', components).on('click', function() {
            ovr.hide();
        });
        $('.fgx-lang-link', components).on('click', function(ev) {
            if(FD.Brand.Link.switchLanguage(this)) {
	            ev.preventDefault();
            }

            // new metrics
            if (changeLanguageAction) {
                FD.Brand.Metrics.handler.direct(
                    changeLanguageAction
                );
            }
            ovr.hide();
        });

        // Setup a hover state for CTA's, part of Ford CTA globalization
        if ( $('html').hasClass('fgx-brand-Ford') ) {
            var $cta = $('a.btn-primary.cta, a.btn-secondary.cta, a.btn-secondary-alt.cta', components);
            window.FD.Brand.Util.ctaHover($cta);
        }

        // hack to reinit MP link handling
        if(win.mp_langLink) {
	        $('.mplangLink').each(function(i, el) {
	            el.onclick = null;
            });
	        win.mp_langLink();
        }

        //NGBS3-6164:
        //remove languageselector hash so that when user selects new language,
        //lang select overlay does not pop on new langauge page
        if(window.location.hash == '#$languageSelector') {
            //wait until overlay called by hash before removing hash
            setTimeout( function() {window.location.hash = '';}, 50);
        }
    }

})(jQuery, window, FD.Brand, FD.Brand.Overlay, FD.Brand.Context);
;(function($, brand, search, ctx) {

    brand.setInitHandler('[data-fgx-global-footer]', init);

    var $resultsContainer;

    /////////////

    function init(components) {

        var defaultAction = (ctx.make === 'Ford') ? "//www.ford.com/search/" : "//www.lincoln.com/search/";
		var formAction = ctx.settings['ngbsSearchUrl' + ctx.make + ctx.languageKey] || ctx.settings['ngbsSearchUrl' + ctx.make] || defaultAction;

	    $resultsContainer = $('.search-suggestions', components);
	    $resultsAlert = $('.search-suggestions-info', components);

        if(components.length == 0) {
            return;
        }

        if(ctx && ctx.hideGlobalFooter) {
            $(components).addClass('fgx-brand-hidden');
        }

        $(".navbar-form", components).attr("action", formAction);

        search.setReferrerApp($('.navbar-form .form-group', components));

        // initialize component elements as necessary
        //function setBreaks(){
        //    var bp = window.FD.Brand.Util.currentBreakpoint();
        //    var showClass = '.'+ bp;
        //
        //    $('.gux-bkpt-base').hide();
        //    $(showClass).show();
        //    var $tertNav = $('.tertiary>.navbar', components);
        //
        //    if(bp === 'gux-bkpt-xlg' && $($tertNav).hasClass('navbar-inverse')){
        //        $($tertNav).removeClass('navbar-inverse').addClass('navbar-default');
        //    }else if(bp !== 'gux-bkpt-xlg' && $($tertNav).hasClass('navbar-default')) {
        //        $($tertNav).removeClass('navbar-default').addClass('navbar-inverse');
        //    }
        //
        //}
        //
        //$('.globalFooter li.finance').child()
        //
        //$('.globalFooter li.finance').children('ul').hide();




        function accordionList() {

            var bp = window.FD.Brand.Util.currentBreakpoint();
            var footerAccordions = [];

			if(bp === 'gux-bkpt-sm') {
                footerAccordions = ['.shop','.finance','.owner','.experience'];
            } else if (bp === 'gux-bkpt-med') {
                footerAccordions = ['.finance','.owner','.experience'];
            } else {
                // lg or xlg, no accordions
            }

            return footerAccordions;
        }



        function triggerAccordions(accordion) {

            //FD.Brand.Util.log("accordion[0].parentElement: ", accordion[0].parentElement);

            var list = accordionList();
            var accParentEl = (accordion && accordion.length > 0) ? accordion[0].parentElement : null;
            $.each(list, function( index, value ) {
                var $el = $('.globalFooter .main ' + value + ' > div.list-heading');
                if ($el && $el.length > 0) {
                    var $parentEl = $el.siblings('ul'),
                        parentEl = ($parentEl && $parentEl.length > 0) ? $parentEl[0].parentElement : null;
                    // allow open accordion to close when clicked
                    if (parentEl && accParentEl && parentEl != accParentEl) {
                        $el.siblings('ul').hide();
                        $el.attr('aria-expanded', 'false');
                    }
                }
            });

            accordion.toggle();
        }


        function initAccordions(accordionListArr) {

            //FD.Brand.Util.log("footerAccordions: ", accordionListArr);
            var $lstHeadings = $('.globalFooter .main div.list-heading');
            $lstHeadings.siblings('ul').show();
            $lstHeadings.filter('[tabindex]').each(function() {
                // clear all button-related attributes
                $(this).removeAttr('tabindex role data-fgx-keypress aria-expanded');
            });
            $lstHeadings.off();

            $.each(accordionListArr, function( index, value ) {
                var $colHeading = $('.globalFooter .main ' + value + ' > div.list-heading');
                $colHeading.attr({
                    'tabindex': '0',
                    'role': 'button',
                    'data-fgx-keypress': 'true',
                    'aria-expanded': 'false'
                });
                $colHeading.siblings('ul').hide();
                $colHeading.on( "click", function() {
                    triggerAccordions($( this ).siblings('ul'));
                    if ($(this).siblings('ul').is(':visible')) {
                        $(this).attr('aria-expanded', 'true');
                        // new metrics
                        FD.Brand.Metrics.handler.direct(
                            $(this).attr('data-fd-metrics-open')
                        );
                    }
                });
            });
        }

        $('.search-input', components).on('input', function() {
            if($(this).val().length === 0) {
                $resultsContainer.hide();
                $resultsAlert.text('');
                $(this).toggleClass('fgx-list-shown', false);//BRAND-12331
            } else {
                search.typeAheadResults($(this).val(), $resultsContainer, $(this), $resultsAlert);
            }
        });
        $('.search-input', components).on('keydown', function(ev){
            //BRAND-12331
            if (ev.which === 40 && $(this).hasClass('fgx-list-shown')) {
                // focus on the very first type-ahead result item
                var firstItem = $resultsContainer.find('li').first();
                firstItem.focus();
            }
        });
        $('.search-input', components).on('blur', function() {
            // need a slight delay to see if we've tabbed to a result item
            setTimeout(function(){ 
                var active = $(document.activeElement);
                if (!active.hasClass('search-res-item') && !$resultsContainer.hasClass('fgx-is-scrolling')) {
                    // if we're not focused on a results item, hide the type-ahead results container
                    $resultsContainer.hide();
                    $resultsAlert.text('');
                    $('.search-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                    $('.search-input', components).removeAttr('aria-activedescendant');
                    $('.search-res-item', components).attr('aria-selected', 'false');
                } else if (active.hasClass('search-res-item')) {
                    // if we've tabbed onto a results item, set a listener for when the results items lose focus so we can properly hide the results container.
                    $('.search-res-item', components).on('focusout', function() {
                        setTimeout(function(){ 
                            var active = $(document.activeElement);
                            if (!active.hasClass('search-res-item') && !active.hasClass('search-input')) {
                                $resultsContainer.hide();
                                $resultsAlert.text('');
                                $('.search-input', components).toggleClass('fgx-list-shown', false);//BRAND-12331
                                $('.search-res-item', components).off('focusout');
                            }
                        }, 100);
                    });
                }
            }, 100);
        });
        // handling for if the search suggestions scroll bar is clicked, ensuring we don't hide our type-ahead results container in that case.
        $resultsContainer.on('mousedown', function(ev){
            $resultsContainer.addClass('fgx-is-scrolling');
        });
        $resultsContainer.on('mouseup', function(ev){
            $('.search-input', components).focus();
            $resultsContainer.removeClass('fgx-is-scrolling');
        });
        $('.search-submit', components).on('click', function() {
            $(this).closest("form").submit();
        });

        $(window).resize(function(){
            //setBreaks();
            initAccordions(accordionList());
        });

        //setBreaks();
        initAccordions(accordionList());

        //NZ: Added as part of BRAND-13461
        $('body').trigger('fgxBrandGlobalFooterInitialized');

    }

})(jQuery, FD.Brand, FD.Brand.Search, FD.Brand.Context);

;(function($, _, brand, user, pricing, search, ctx, dealerLib, ngp) {

    var components,
        _layoutKey = 'desktop',
        _ladInitialized = false,
        _ladData = {},
        _dealerItemTemplate = null,
        _flyoutData = {
            isActive: false,
            activeType: '',
            activeOvr: null
        },
        _dskOvrIdx = 0,
        _dskOvrAttr = 'data-fgx-fordMainNav-flyout-id',
        _dskOvrIdPrefix = 'fgx-fordMainNav-flyout-',
        _dskOverlays = {},
        _mobileMenuOvr = {
            isOpen: false,
            focusElements: 'a:not([tabindex="-1"]):visible, input:visible, button:visible, [data-fgx-keypress]:visible',
            skipLastFocus: false
        },
        _searchInst = {};

    brand.setInitHandler('[data-fgx-ford-main-navigation]', init);

    function init(_components) {

        if (!_components || _components.length == 0) {
            return;
        }
        components = _components;

        if (ctx) {
            if(ctx.hideGlobalHeader) {
                $(components).addClass('fgx-brand-hidden');
            }
            if (ctx.settings && ctx.settings.syn && components.hasClass('with-eyebrow')) {
                $('html').addClass('fgx-brand-syn-eyebrow');
            }
        }

        var mql = window.matchMedia('(min-width: 992px)'),
            mtxActions = ctx && ctx.mtxActions,
            languageSelectorOverlayOpenAction = mtxActions && mtxActions.languageSelectorOverlayOpenAction || null,
            defaultAction = "//www.ford.com/search/",
            formAction = ctx.settings['ngbsSearchUrl' + ctx.make + ctx.languageKey] || ctx.settings['ngbsSearchUrl' + ctx.make] || defaultAction,
            $resultsContainer = $('.search-suggestions', components),
            $navbarToggle = $('.navbar-toggle', components),
            $bgOverlay = $('.fordMainNavOverlay'),
            _hasSecondaryNav = ($('.secondaryNavigation').length > 0),
            notificationsEnabled = (($(components).attr('data-notification-enabled') || '') === 'yes'),
            $body = $('body'),
            navHeight = components.outerHeight(),
            _dynamDisplayOnScroll = ((components.attr('data-dynamic-scroll-display-enabled') || '') === 'true'),
            _forceNoDynamDisplay = false;


        _mobileMenuOvr.lastFocus = $navbarToggle;
        _mobileMenuOvr.$el = $('.menu-items-container', components);
        _mobileMenuOvr.hide = function() {
            toggleMobileMenu.call($navbarToggle);
        };
        _mobileMenuOvr.$firstToggle = _mobileMenuOvr.$el.find('.flyout-toggle').first();

        $('.flyout-toggle:not(.flyout-mbl-only)', components).each(function() {
            setupOvrItem($(this));
        });

        mql.addListener(handleResize);
        handleResize(mql);

        brand.Dig.resolve(components);

        components.each(function() {
            pricing.refresh(this);
        });

        user.authentication.subscribe(setUserMenuState);
        user.dealer.subscribe(setDealerDetail);

        // Server-Side Current Page object will not work on rewritten Publish URLs - handling this via JS.
        var relativeLoc = '/' + window.location.href.replace(/^(?:\/\/|[^\/]+)*\//, "");
        $('.eyebrow-item', components).each(function() {
            var $el = $(this),
                href = $el.attr('href');
            if (href === relativeLoc || href === window.location.href) {
                $el.addClass('active');
            }
        });

        // search form
        $('.fgx-search-input', components).each(function(idx) {
            var id = 'fgx-mainNav-search-' + idx;
            _searchInst[id] = searchController($(this), formAction, id, search);
        });


        // Event Handlers
        $('.flyout-item-wrap', components).on('focusin', '.fgx-brand-nav-flyout-end', function(ev) {
            var $focusEl = $(this).closest('.flyout-item-wrap').find('.flyout-toggle');
            updateFocus($focusEl);
        });

        $('.menu-items-container', components).on('focusin', '.fgx-brand-nav-mobile-menu-end', function(ev) {
            if (_layoutKey === 'mobile') {
                var $focusEl = $('.mbl-menu-close', components);
                updateFocus($focusEl);
                //updateFocus('.mbl-menu-close');
            }
        });

        $('.navbar-toggle, .mbl-menu-close', components).on('click', function() {
            toggleMobileMenu.call($navbarToggle);
        });

        $('.mbl-menu-close', components).on('focusin focusout', function(ev) {
            $navbarToggle.toggleClass('fgx-focus-display', (ev.type === 'focusin'));
        });

        $('.flyout-toggle', components).on('click', function(ev) {
            ev.preventDefault();
            //NZ - I don't believe this is needed but commenting out just in case. - ev.stopPropagation();
            handleFlyoutToggle.call(this);
        });

        $('.column-vehicle-item', components).on('click', '.year-item-toggle', function(ev) {
            var $el = $(this),
                activeClass = $el[0].value || 'active-veh-1',
                $tile = $el.closest('.vehicle-tile');
            $tile.toggleClass('active-veh-1 active-veh-2', false).addClass(activeClass);
        });

        $('.segment-anchor-trigger', components).on('click', function(ev) {
            var $el = $(this),
                segId = $el.attr('data-fgx-section-id') || '',
                $container = $el.closest('.flyout-container'),
                $segItem = (segId) ? $container.find('#' + segId) : null;
            
            $('.segment-anchor-trigger', components).removeClass('open');
            $el.addClass('open');
            
            if ($segItem && $segItem.length > 0) {
                $container.animate({
                    scrollTop: $segItem.position().top
                }, 200, function() {
                    $segItem.toggleClass('fgx-show-outline', true)
                            .focus()
                            .one('blur.fgxFordMainNav', function() {
                                $(this).toggleClass('fgx-show-outline', false);
                            });
                });
            }
        });

        // language links
        $('.fgx-lang-link', components).on('click', function(ev) {
            if(FD.Brand.Link.switchLanguage(this)) {
                ev.preventDefault();
            }
        });

        // Initialize dynamic scrolling functionality when enabled
        if (_dynamDisplayOnScroll) {
            if (!_hasSecondaryNav) {
                // we're on a brand page that doesn't have the secondary navigation, so setup the dynamic scrolling functionality.
                setupScrollHandling(window);
            }
            $(document).on('brandnav:nodynamicscroll', function(ev) {
                brand.Util.log("fordMainNavigation - brandnav:nodynamicscroll handler triggered");
                disableScrollListener(window);
                _forceNoDynamDisplay = true;
            });
        }


        // Functions
        function updateFocus($focusEl) {
            if ($focusEl && $focusEl.length > 0) {
                $focusEl.focus();
            }
        }

        function setupOvrItem($el) {
            if (!$el || $el.length === 0) {
                return;
            }
            var _id = _dskOvrIdPrefix + ++_dskOvrIdx,
                $toggle = $el.attr(_dskOvrAttr, _id),
                $flyoutWrap = $toggle.closest('.flyout-item-wrap').attr(_dskOvrAttr, _id),
                _ovr = {
                    id: _id,
                    $el: $flyoutWrap,
                    lastFocus: $toggle,
                    focusElements: 'a:not([tabindex="-1"]):visible, input:visible, button:visible, [data-fgx-keypress]:visible',
                    skipLastFocus: false,
                    hide: _.wrap($toggle, function($toggleEl) {
                        handleFlyoutToggle.call($toggleEl[0]);
                    })
                };
            _dskOverlays[_ovr.id] = _ovr;
        }

        function handleBodyClick(ev) {
            // clicking outside the main nav or within the mainNav but outside of dropdown items should close nav dropdowns
            // and remove the overlay
            var $target = $(ev.target);
            if ($target.hasClass('fordMainNavOverlay') || ($target.closest('.fordMainNavigation').length && !$target.closest('.flyout-toggle, .flyout-container, .navbar-toggle').length)) {
                // Hide the current opened flyout
                closeFlyoutMenus();

                // NZ - on mobile this click handler can be called to close the flyouts without actually closing the mobile
                // menu so we want to prevent the nonsticky class from being added in the case because it will override the
                // position: fixed that is used for the mobile menu.
                if (_hasSecondaryNav && _layoutKey !== 'mobile') {
                    components.find('.navbar-static-top').toggleClass('nonsticky', true);
                }
            }
        }

        function toggleMobileMenu() {
            var $el = $(this),
                $container = $el.closest('.container-fluid'),
                $menuItems = $container.find('.menu-items-container'),
                isOpen = $menuItems.hasClass('opened');

            $menuItems.toggleClass('opened', !isOpen);
            $el.toggleClass('opened', !isOpen);
            $el.attr('aria-expanded', !isOpen);
            $('body').toggleClass('no-scroll-sm', !isOpen);

            // clear any search input if it exists
            $('.fgx-search-input', components).val('');

            if (_hasSecondaryNav) {
                $el.closest('.navbar-static-top').toggleClass('nonsticky', isOpen);
            }

            if (isOpen) {
                // if isOpen is true here, then the mobile menu is actually being closed.
                closeFlyoutMenus();
                FD.Brand.Overlay.releaseFocus(_mobileMenuOvr);
            } else {
                FD.Brand.Overlay.trapFocus(_mobileMenuOvr, _mobileMenuOvr.focusElements, null, _mobileMenuOvr.lastFocus, false);
                handleFlyoutToggle.call(_mobileMenuOvr.$firstToggle[0]);
            }

            _mobileMenuOvr.isOpen = !isOpen;
        }

        function handleFlyoutToggle() {
            var $el = $(this),
                $flyoutGroup = $el.closest('[data-fgx-flyout-group]');

            if (canActivateToggle($el)) {
                var layoutSelector = (_layoutKey === 'mobile') ? '' : ':not(.flyout-mbl-only)';
                var hSelector = '.flyout-toggle' + layoutSelector;
                var cSelector = '.flyout-container' + layoutSelector;

                $(components).toggleClass('no-transition-dsk', dskPreventTransitionCheck($el));
                $('.segment-anchor-trigger', components).toggleClass('open', false);

                if (_flyoutData.isActive && _layoutKey === 'desktop') {
                    var newId = $el.attr(_dskOvrAttr) || '',
                        activeOvr = _flyoutData.activeOvr || {};
                    if (newId && activeOvr && activeOvr.id && activeOvr.id !== newId) {
                        // If a different flyout is already open then releaseFocus from that flyout without updating the lastFocus
                        // position. Note, the accordion.update call below will actually handle the logic to close the active flyout.
                        activeOvr.skipLastFocus = true;
                        FD.Brand.Overlay.releaseFocus(activeOvr);
                        activeOvr.skipLastFocus = false;
                    }
                }

                brand.Util.accordion.update($el, $flyoutGroup, hSelector, cSelector, true, function() {
                    var $el = $(this),
                        isOpen = $el.hasClass('open'),
                        id = $el.attr(_dskOvrAttr) || '',
                        invisibleBg = isOpen && $el.hasClass('fgx-no-bg-ovr');

                    _flyoutData.isActive = (isOpen);
                    _flyoutData.activeType = (isOpen) ? ($el.attr('data-flyout-type') || '') : '';

                    if (_layoutKey === 'desktop' && id && !_.isEmpty(_dskOverlays[id] || {})) {
                        var _ovr = _dskOverlays[id];
                        if (isOpen) {
                            FD.Brand.Overlay.trapFocus(_ovr, _ovr.focusElements, '.flyout-toggle', _ovr.lastFocus, false);
                            _flyoutData.activeOvr = _.assign({}, _ovr || {});
                        } else {
                            _flyoutData.activeOvr = null;
                            FD.Brand.Overlay.releaseFocus(_ovr);
                        }
                    } else {
                        _flyoutData.activeOvr = null;
                    }

                    $bgOverlay.toggleClass('open', isOpen).toggleClass('fgx-invisible-bg', invisibleBg);

                    $body.off('click.fgxMainNav', handleBodyClick);
                    if (isOpen) {
                        $body.on('click.fgxMainNav', handleBodyClick);
                    }

                    // NZ - On mobile the flyouts can be closed without actually closing the main mobile menu, so we want
                    // to prevent the nonsticky class from being added in that case because it will override the position: fixed
                    // that is used for the mobile menu.
                    if (_hasSecondaryNav && _layoutKey !== 'mobile') {
                        $el.closest('.navbar-static-top').toggleClass('nonsticky', !isOpen);
                    }
                });
            }
        }

        function canActivateToggle($el) {
            return !!($el && $el.length > 0 && (!$el.hasClass('.flyout-mbl-only') || _layoutKey === 'mobile'));
        }

        function getActiveFocusTrappedOvr() {
            return _flyoutData.activeOvr || {};
        }

        function hasActiveFocusTrappedOvr() {
            return (_flyoutData.isActive && !_.isEmpty(getActiveFocusTrappedOvr()));
        }

        function updatePresentationElms() {
            var $presElms = $('.presentation-only-lg', components);
            var onDsk = (_layoutKey === 'desktop');
            var bpKey = (onDsk) ? 'dsk' : 'mbl';
            if ($presElms && $presElms.length) {
                $presElms.attr('role', (onDsk) ? 'presentation' : null);
            }
            $('[data-role-cfg]', components).each(function() {
                var $el = $(this),
                    roleCfg = null;
                try {
                    roleCfg = JSON.parse($el.attr('data-role-cfg') || '{ }');
                } catch(e) { }
                // logic below will set the role attribute to the provided value for the bp, or remove the role attribute if no value is provided.
                $el.attr('role', roleCfg && roleCfg[bpKey] || null);
            });
        }

        function updateFlyoutAttributes() {
            var onDsk = (_layoutKey === 'desktop'),
                hSelector = '.flyout-toggle.flyout-mbl-only',
                cSelector = '.flyout-container.flyout-mbl-only' + ((onDsk) ? '' : ':not(.open)');

            $(cSelector, components).toggleClass('hidden', !onDsk);
            $('.vehicles-nav-items', components).attr('data-fgx-flyout-group', ((onDsk) ? null : 'true'));

            if (onDsk) {
                $(hSelector, components).attr('aria-expanded', null);
            } else {
                $(hSelector, components).each(function() {
                    var $el = $(this);
                    $el.attr('aria-expanded', $el.hasClass('open') ? 'true' : 'false');
                });
            }
        }

        function closeFlyoutMenus() {
            var layoutSelector = (_layoutKey === 'mobile') ? '' : ':not(.flyout-mbl-only)';
            var hSelector = '.flyout-toggle.open' + layoutSelector;
            var cSelector = '.flyout-container.open' + layoutSelector;

            $(hSelector, components).removeClass('open').attr('aria-expanded', 'false');
            $(cSelector, components).removeClass('open').addClass('hidden');
            $('.segment-anchor-trigger', components).toggleClass('open', false);

            if (hasActiveFocusTrappedOvr()) {
                FD.Brand.Overlay.releaseFocus(getActiveFocusTrappedOvr());
            }
            _flyoutData.activeOvr = null;
            _flyoutData.isActive = false;
            _flyoutData.activeType = '';
            $bgOverlay.toggleClass('open fgx-invisible-bg', false);
            $body.off('click.fgxMainNav', handleBodyClick);
        }

        // User Menu
        function setUserMenuState(authState) {
            // hide entire li element if auth is not loaded
            var $menuItem = $('.user-menu-item', components).toggleClass('hidden', !authState.loaded);
            var $authItems = $menuItem.find('[data-auth]').addClass('hidden');
            var $currentAuthItems = $authItems.filter('[data-auth~="' + authState.authType + '"]').toggleClass('hidden', false).not('[data-auth-icon]');

            if(authState && authState.authType == 'user') {
                user.profile.current().then(function(profileState) {
                    var firstName = profileState && profileState.firstName || '';
                    $currentAuthItems.each(function() {
                        var $el = $(this),
                            itemTemplate = ($el.attr('data-fgx-item-template') || $el.text() || '').trim(),
                            val = itemTemplate.replace('{firstName}', firstName);
                        $el.find('.link-text').html(val);
                    });
                });
            }

            var $notificationListItems = $currentAuthItems.find('[data-notification-item]');
            if (notificationsEnabled && $notificationListItems && $notificationListItems.length > 0) {
                var $allNotificationItems = $(components).find('[data-notification-item]');
                user.fps.notification.getAll().done(function(data) {
                    $allNotificationItems.toggleClass('hidden', !(data.SavedVehicleCount && data.SavedVehicleCount.total > 0));
                }).fail(function() {
                    $allNotificationItems.toggleClass('hidden', true);
                });
            }
        }

        function initDealerData() {
            var $nav = $(components),
                _ladConfig = dealerLib.getDealerConfig() || {},
                savedDealerEnabled = $nav.attr('data-saved-dealer-enabled') || '',
                savedDealerGnav = $nav.attr('data-saved-dealer-gnav') || '',
                moreDealersLink = $nav.attr('data-lad-moredealershref') || '',
                moreDealersLinkSavedGnav = moreDealersLink,
                $dealerItemEl = $nav.find('.fgx-lad-item');

            if (moreDealersLink) {
                moreDealersLinkSavedGnav = appendQueryString(moreDealersLink, savedDealerGnav);
            }

            var data = {
                ladConfig: _ladConfig,
                showSavedDealer: (savedDealerEnabled == 'yes') ? true : false,
                distanceLabel: $nav.attr('data-lad-distance-label') || '',
                distanceTypeKey: (ctx.region === 'CA') ? 'DistanceKM' : 'Distance',
                noDealerGnav: $nav.attr('data-no-dealer-gnav') || '',
                savedDealerGnav: savedDealerGnav,
                dealerAppContext: $nav.attr('dealerAppContext') || '',
                suppressDealerHours: _ladConfig && _ladConfig.suppressDealerHours || false,
                salesOpenUntil: $nav.attr('data-lad-sales-open-until') || '',
                salesOpenAgain: $nav.attr('data-lad-sales-open-again') || '',
                hoursDisplayType: $nav.attr('data-lad-hours-displaytype') || '',
                dealerDetailLink: _ladConfig && _ladConfig.dealerDetailPageUrl || '',
                detailLinkDestination: $nav.attr('data-lad-detail-link-destination') || 'dealer-details',
                ratingLinkDestination: $nav.attr('data-lad-rating-link-destination') || 'dealer-details',
                detailClickAction: $nav.attr('data-dealer-detail-click-action') || '',
                detailAriaLabelTmpl: $nav.attr('data-lad-detail-aria-label') || '',
                moreDealersLink: moreDealersLink,
                moreDealersLinkSavedGnav: moreDealersLinkSavedGnav,
                hideDealerRatings: _ladConfig && _ladConfig.hideDealerRatings || false,
                starAriaLabelTmpl: $nav.attr('data-lad-star-aria-label') || '',
                ratingsAriaLabelTmpl: $nav.attr('data-lad-ratings-aria-label') || '',
                chatAriaLabelTmpl: $nav.attr('data-lad-chat-aria-label') || '',
                directionsAriaLabelTmpl: $nav.attr('data-lad-directions-aria-label') || '',
                textDealerAriaLabelTmpl: $nav.attr('data-lad-text-dealer-aria-label') || '',
                $ladItemEl: $dealerItemEl
            };

            $dealerItemEl.on('click', '.dealer-rating .dealer-rating-iball', function(event) {
                event.preventDefault();
                event.stopImmediatePropagation();
                if (FD.Brand.Overlay) {
                    FD.Brand.Overlay.show('dealerRatingsInfo', true, $(this));
                }
            });

            // Update LAD urls to include proper gnavparameter
            $('.dealer-gnav-update', components).each(function() {
                var href = $(this).attr('href');
                if(href) {
                    href = appendQueryString(href, data.noDealerGnav);
                    $(this).attr('href', href);
                }
            });

            _ladData = _.assign({}, _ladData, data);
            _dealerItemTemplate = _.template($('script[data-fgx-main-nav-saved-dealer-item]').html());
            _ladInitialized = true;
        }

        function setDealerDetail(dealerState) {
            if (!_ladInitialized) {
                initDealerData();
            }

            var $ladItemEl = _ladData.$ladItemEl,
                $savedDealerWrap = $ladItemEl.find('.fgx-saved-dealer-content');
            $savedDealerWrap.empty();
            if (dealerState.preferred && _ladData && _ladData.showSavedDealer) {
                var dealer = dealerLib.updateDealer(dealerState.preferred, 0, _ladData.salesOpenUntil, _ladData.salesOpenAgain, null, _ladData.dealerDetailLink, _ladData.hoursDisplayType);

                if (dealer != null) {
                    var dist = dealerState.preferred[_ladData.distanceTypeKey];
                    var distanceTxt = (dist && dist !== '0') ? (dist + " " + _ladData.distanceLabel) : '';
                    $ladItemEl.find('.fgx-saved-dealer .lad-link-label').text(dealerState.preferred.Name)
                    $ladItemEl.find('.fgx-saved-dealer .dealer-distance').text(distanceTxt);

                    dealer.Distance = dist;

                    var starAriaLabel = (_ladData.starAriaLabelTmpl || '').replace('{starCount}', dealer.combinedRating || '');
                    var ratingsAriaLabel = (_ladData.ratingsAriaLabelTmpl || '').replace('{reviewCount}', dealer.combinedRatingsCount || '');
                    var detailAriaLabel = (_ladData.detailAriaLabelTmpl || '').replace('{dealerName}', dealer.Name || '');
                    var chatAriaLabel = (_ladData.chatAriaLabelTmpl || '').replace('{dealerName}', dealer.Name || '');
                    var directionsAriaLabel = (_ladData.directionsAriaLabelTmpl || '').replace('{dealerName}', dealer.Name || '');
                    var textDealerAriaLabel = (_ladData.textDealerAriaLabelTmpl || '').replace('{dealerName}', dealer.Name || '');

                    // phone
                    var phone = dealer.Phone;
                    if (dealer.dlrcalltrk_lad && dealer.dlrcalltrk_lad !== '') {
                        phone = dealer.dlrcalltrk_lad;
                    } else if (dealer.ldlrcalltrk_lad && dealer.ldlrcalltrk_lad !== '') {
                        phone = dealer.ldlrcalltrk_lad;
                    }
                    dealer.fgxPhoneDisplay = phone;

                    // dealer detail deeplink
                    var dealerDeepLink,
                        detailLinkCls = '';
                    if (_ladData.detailLinkDestination === 'dealer-website' && dealer.URL && !_.isEmpty(dealer.URL)) {
                        var qs = _ladData.savedDealerGnav;
                        // if a 'mt-attr-val' cookie is present, we will have a Query String value added to our dealer object, add it to qs
                        if (dealer.mtAttrQS) {
                            if (!_.isEmpty(qs)) {
                                qs += '&';
                            }
                            qs += dealer.mtAttrQS;
                        }
                        dealerDeepLink = appendQueryString(dealer.URL, qs);
                        detailLinkCls = _ladData.ladConfig && _ladData.ladConfig.exitOverlayCls || '';
                    } else {
                        dealerDeepLink = appendQueryString(dealer.DeepLinkUrl, _ladData.savedDealerGnav);
                        dealerDeepLink = appendAppContext(dealerDeepLink, _ladData.dealerAppContext);
                    }
                    
                    // rating deeplink
                    var ratingDeepLink,
                        ratingLinkCls = '';
                    if (_ladData.ratingLinkDestination === 'dealer-website' && dealer.URL && !_.isEmpty(dealer.URL)) {
                        var qs = _ladData.savedDealerGnav;
                        // if a 'mt-attr-val' cookie is present, we will have a Query String value added to our dealer object, add it to qs
                        if (dealer.mtAttrQS) {
                            if (!_.isEmpty(qs)) {
                                qs += '&';
                            }
                            qs += dealer.mtAttrQS;
                        }
                        ratingDeepLink = appendQueryString(dealer.URL, qs);
                        ratingLinkCls = _ladData.ladConfig && _ladData.ladConfig.exitOverlayCls || '';
                    } else {
                        ratingDeepLink = appendQueryString(dealer.ReviewsDeepLinkUrl, _ladData.savedDealerGnav);
                        ratingDeepLink = appendAppContext(ratingDeepLink, _ladData.dealerAppContext);
                    }

                    var prm = {
                        dealer: dealer,
                        cfg: _ladData.ladConfig,
                        starAriaLabel: starAriaLabel,
                        ratingsAriaLabel: ratingsAriaLabel,
                        detailAriaLabel: detailAriaLabel,
                        detailLinkCls: detailLinkCls,
                        dealerDeepLink: dealerDeepLink,
                        ratingDeepLink: ratingDeepLink,
                        ratingLinkCls: ratingLinkCls,
                        chatAriaLabel: chatAriaLabel,
                        directionsAriaLabel: directionsAriaLabel,
                        textDealerAriaLabel: textDealerAriaLabel,
                        moreDealersLinkSavedGnav: _ladData.moreDealersLinkSavedGnav,
                        showTextDealer: ctx.showTextDealer
                    };
                    $(_dealerItemTemplate(prm)).appendTo($savedDealerWrap);

                    // dealer chat
                    if (ctx.region !== 'CA') {
                        var $dealerChat = $savedDealerWrap.find('.actions .dealer-chat');
                        // check for chat
                        ngp.dealerChatStatus({dealerPACode: dealer.PACode, make: ctx.make}).done(function(resp) {
                            if(resp && resp.url) {
                                var url = resp.url;
                                $dealerChat
                                    .toggleClass('hidden', false)
                                    .on('click', 'a', function(event) {
                                        event.preventDefault();
                                        event.stopImmediatePropagation();
                                        // new metrics
                                        FD.Brand.Metrics.handler.direct(
                                            $(this).attr('data-fd-metrics-click')
                                        );
                                        window.open(url, '_blank', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,width=350,height=620');
                                    });
                            }
                        });
                    }

                    $ladItemEl.toggleClass('saved-dealer-state', true);
                } else {
                    $ladItemEl.toggleClass('saved-dealer-state', false);
                }
            } else {
                $ladItemEl.toggleClass('saved-dealer-state', false);
            }
        }

        function appendQueryString(url, parameters) {
            var output = '';
            if(url && typeof(url) !== 'undefined') {
                if(typeof(parameters) != 'undefined' && parameters !== '') {
                    var _url = brand.Util.url.urlObject(url),
                        param = brand.Util.parameters.decode(parameters);
                    _url.qs.add(param);
                    output = _url.url();
                } else {
                    output = url;
                }
            }
            return output;
        }

        function appendAppContext(url, context) {
            var output = '';
            if(url && typeof(url) !== 'undefined') {
                if(context && typeof(context) !== 'undefined' && context !== '') {
                    var _url = brand.Util.url.urlObject(url),
                        contextStr = '/context/' + context;
                    _url.setHash(contextStr, true);
                    output = _url.url();
                } else {
                    output = url;
                }
            }
            return output;
        }

        function dskPreventTransitionCheck($el) {
            // If we're opening a flyout on desktop that's the same 'type' as the one that's already open, then prevent the animation from happening.
            return (_layoutKey === 'desktop' && _flyoutData.isActive && ($el.attr('data-flyout-type') || '') === _flyoutData.activeType && !$el.hasClass('open') && _flyoutData.activeType != '');
        }

        function handleResize(mql) {
            _layoutKey = (!mql.matches) ? 'mobile' : 'desktop';
            navHeight = components.outerHeight();
            updatePresentationElms();
            updateFlyoutAttributes();

            if (_layoutKey === 'desktop' && _mobileMenuOvr.isOpen) {
                // When resizing the screen from mobile to desktop we should close the mobile menu and release focus, but set
                // the skipLastFocus property on the mobileMenuOvr object to true first so focus isn't moved off the current element.
                _mobileMenuOvr.skipLastFocus = true;
                toggleMobileMenu.call($navbarToggle);
                // Reset to false after toggling the mobile menu
                _mobileMenuOvr.skipLastFocus = false;
            } else if (_layoutKey === 'mobile' && hasActiveFocusTrappedOvr()) {
                var activeOvr = getActiveFocusTrappedOvr(),
                    lastId = activeOvr.id;
                activeOvr.skipLastFocus = true;
                closeFlyoutMenus();
                // Need to reset the skipLastFocus in the actual overlay object itself because activeOvr will be set to null in the closeFlyoutMenus function.
                (_dskOverlays[lastId] || {}).skipLastFocus = false;
            }
        }

        // Functions to setup and handle dynamic scrolling functionality when enabled
        function setupScrollHandling(el) {
            // wait for initial scroll event before setting up the logic to handle subsequent scrolls. Used in an attempt
            // to prevent the nav from unintentionally being hidden when reloading a page that has already been scrolled.
            $(el).one('scroll.fgxMainNav', function() { createScrollListener(el); });
        }
        function createScrollListener(el) {
            var $el = $(el),
                lastScrollPos = $el.scrollTop(),
                scrollLock = false;
            var handleScroll = function() {
                if (!scrollLock) {
                    scrollLock = true;
                    var scrollPos = $el.scrollTop(),
                        scrollDir = ((scrollPos - lastScrollPos) > 0) ? 'down' : 'up',
                        hasOpenFlyout = ((_layoutKey === 'mobile' && _mobileMenuOvr.isOpen) || (_layoutKey === 'desktop' && _flyoutData.isActive));
                    lastScrollPos = scrollPos;
                    // add or remove the 'hide-off-top' class from the main nav element as needed
                    components.toggleClass('hide-off-top', (!hasOpenFlyout && scrollPos > navHeight && scrollDir === 'down'));
                    // wait before releasing the scroll lock
                    window.setTimeout(function() {
                        scrollLock = false;
                    }, 100);
                } else {
                    lastScrollPos = $el.scrollTop();
                }
            };
            components.addClass('top-trans-enabled');
            if (!_forceNoDynamDisplay) {
                $el.on('scroll.fgxMainNav', handleScroll);
                components.on('focusin.fgxMainNav', function(ev) {
                    $(this).removeClass('hide-off-top');
                });
            }
        }
        function disableScrollListener(el) {
            $(el).off('scroll.fgxMainNav');
            components.removeClass('top-trans-enabled hide-off-top');
        }


        function searchController($inputEl, formAction, id, searchLib) {

            function searchControllerHelper($input, id, searchLib) {
                var _this = this,
                    _id = id,
                    _searchLib = searchLib;

                _this.$input = $input;
                _this.$form = $input.closest('.fgx-search-form');
                _this.$formWrapper = _this.$form.find('.form-wrapper');
                _this.$resultsContainer = _this.$form.find('.search-suggestions');
                _this.$searchSubmit = _this.$form.find('.fgx-search-submit');

                _this.setAction = setFormAction;
                _this.setReferrerApp = setReferrerApp;
                _this.inputChange = handleInputChange;
                _this.hideResults = hideResults;
                _this.itemFocusOut = handleItemFocusOut;
                _this.submitForm = submitForm;
                _this.getId = getId;

                // Event Listeners
                _this.$input
                    .on('input', handleInputChange)
                    .on('keydown', handleInputKeydown)
                    .on('blur', function() {
                        _this.itemFocusOut('input');
                    });

                // handling to ensure the type-ahead results container isn't hidden if the search suggestions scroll bar is clicked.
                _this.$resultsContainer
                    .on('mousedown', function() {
                        _this.$resultsContainer.addClass('fgx-is-scrolling');
                    })
                    .on('mouseup', function() {
                        _this.$input.focus();
                        _this.$resultsContainer.removeClass('fgx-is-scrolling');
                    })
                    .on('focusout', '.search-res-item', function() {
                        _this.itemFocusOut('result');
                    });

                _this.$searchSubmit.on('click', submitForm);

                return _this;

                function setFormAction(action) {
                    _this.$form.attr("action", action || '');
                    return _this;
                }

                function setReferrerApp() {
                    if (_searchLib) {
                        _searchLib.setReferrerApp(_this.$formWrapper);
                    }
                    return _this;
                }

                function handleInputChange() {
                    var $this = $(this),
                        val = $this.val();
                    if(val.length === 0) {
                        _this.hideResults();
                    } else {
                        try {
                            _searchLib.typeAheadResults(val, _this.$resultsContainer, $this);
                        } catch(ex) { }
                    }
                }

                function handleInputKeydown(ev) {
                    if (ev.which === 40 && $(this).hasClass('fgx-list-shown')) {
                        // focus on the very first type-ahead result item
                        _this.$resultsContainer.find('li').first().focus();
                    }
                }

                function handleItemFocusOut(itmType) {
                    // setTimeout is needed because nothing has focus during 'focusout'
                    setTimeout(function() {
                        var active = $(document.activeElement),
                            itmTypeCond = !((itmType === 'result') ? active.hasClass('fgx-search-input') : _this.$resultsContainer.hasClass('fgx-is-scrolling'));

                        if (!active.hasClass('search-res-item') && itmTypeCond) {
                            _this.hideResults();
                        }
                    }, 100);
                }

                function hideResults() {
                    _this.$resultsContainer.hide();
                    _this.$input.toggleClass('fgx-list-shown', false);//BRAND-12331
                    return _this;
                }

                function submitForm() {
                    _this.$form.submit();
                }

                function getId() {
                    return _id;
                }
            }

            var _sch = new searchControllerHelper($inputEl, id, searchLib);

            _sch.setAction(formAction)
                .setReferrerApp();

            return _sch;
        }

    }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.User, FD.Brand.Pricing, FD.Brand.Search, FD.Brand.Context, FD.Brand.Dealer, FD.Brand.NgpServices);
/*global FD*/
;(function ($, win, _, brand, overlay, user) {
    brand.setInitHandler('[data-fgx-simple-choice]', init);
    brand.setInitHandler('[data-fgx-simple-choice-overlay-list]', initTriggers);

    /////////////
    
    var _exitOverlayInstances = {};
    var _ctx = {};
    var _settings = {};
    var _dynamicExtListenerInitialized = false;
    var _triggers = {
        'none': {
            description: 'None',
            fn: function() {
                return false;
            }
        },
        'pageLoad': {
            description: 'Page Load',
            fn: function() {
                return true;
            }
        },
        'pageLoadOnce': {
            description: 'Page Load (once per session)',
            fn: function(id) {
                return oncePerSession(id);
            }
        },
        'pricePlanAZ': {
            description: 'A/Z Plan Participant',
            fn: function(id) {
                return user.pricing.current().pricePlan === 'AZPLAN' && oncePerSession(id);
            }
        },
        'pricePlanX': {
            description: 'X Plan Participant',
            fn: function(id) {
                return user.pricing.current().pricePlan === 'XPLAN' && oncePerSession(id);
            }
        },
        'externalUrl': {
            description: 'External Url Click',
            fn: function(id, ovr) {
                setExternalUrlHandler(id, ovr);
                return false;
            }
        }
    };

    function oncePerSession(id) {
        var key = 'fgx-simple-choice-trigger-' + id;
        if(win.sessionStorage.getItem(key)) {
            return false;
        }
        win.sessionStorage.setItem(key, 1);
        return true;
    }

    function init(components) {
        _ctx = brand && brand.Context;
        _settings = _ctx && _ctx.settings;
        components.each(function(){
            var $el = $(this);
            var id = $el.data('fgx-overlay-id');
            var trigger = $el.data('fgx-overlay-trigger');
            var ovr = overlay.register(id, $el);
            $('.icon-close', $el).on('click', function() {
                ovr.hide();
            });
            if(trigger && _triggers[trigger] && _triggers[trigger].fn(id, ovr)) {
                // ensure focus is trapped, focus on the first <a> tag, 
                // since no user action initiated the overlay, pass in an undefined target.
                ovr.show(true, undefined, 'a');
            }
        });

    }
    
    function initTriggers(components) {
        // provide list of triggers in author mode
        if(brand.Ext) {
            brand.Ext.simpleChoice = {
                triggerOptions: function() {
                    return _.map(_triggers, function (v, k) {
                        return {
                            value: k,
                            text: v.description
                        };
                    });
                }
            };
        }
    }

    function setExternalUrlHandler(id, ovr) {
        var externalLinkSuffix = '#!' + id;
        var externalUrlSelector = 'a[href$=\'' + externalLinkSuffix + '\']';
        var updateLink = function() {
            // update href to remove link suffix
            var $link = $(this);
            var href = $link.attr('href');
            href = href.substring(0, href.length - externalLinkSuffix.length);
            // add click handler to prompt user
            $link.attr('href', href)
                .on('click.fgxBrandExternal', checkExternalUrl);
            // indicate the link has the fgxBrandExternal click listener
            $link.attr('data-set-external-click-handler', true);
        };
        var checkExternalUrl = function(ev, skipAdditionalTrigger) {
            var _ev = $.extend(true, {}, ev);
            ev.preventDefault();
            var $link = $(this);
            var href = $link.attr('href');
            var target = $link.attr('target');
            // setup overlay button handlers
            ovr.$el.off('click.cta');
            ovr.$el.one('click.cta', '.cta-one a', function() {
                // Continue
                ovr.hide();

                // Common Metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-click')
                );

                $link.off('click.fgxBrandExternal');

                if(!skipAdditionalTrigger) {
                    $link.trigger('click');
                }

                var setExtHandler = $link.attr('data-set-external-click-handler');
                if(setExtHandler === 'true') {
                    $link.on('click.fgxBrandExternal', checkExternalUrl);
                }
                
                if (target === '_blank') {
                    window.open(href);
                } else {
                    window.location.assign(href);
                }

                return false;
            });
            ovr.$el.one('click.cta', '.cta-two a', function() {
                // Cancel
                ovr.hide();

                // Common Metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-click')
                );
                return false;

            });
            ovr.show(true, $link, 'a.btn');
            return false;
        };
        // update current external links
        $(externalUrlSelector).each(updateLink);
        // update & process any new links
        $('body').on('click', externalUrlSelector, function(ev) {
            updateLink.call(this);
            checkExternalUrl.call(this, ev);
        }).on('click', '[data-external-url]', checkExternalUrl);

        // setup a dynamic external listener for new links, but only do it once.
        if (!_dynamicExtListenerInitialized) {
            _dynamicExtListenerInitialized = true;
            $('body').on('click', '.fgx-external-url-trigger', handleDynamicExtClick);
        }

        // setup angular directive if loaded
        if(win.angular && _settings && !_settings.syn) {
            try {
                win.angular.module('fgx.directives').directive('fgxExternalUrl', [
                    function () {
                        return {
                            restrict: 'A',
                            link: function (scope, element) {
                                element.on('click', function(ev) {
                                    return checkExternalUrl.call(element, ev);
                                });
                            }
                        };
                    }
                ]);
            } catch(e) {
                brand.Util.log('simpleChoiceOverlayList::setExternalUrlHandler - error occurred trying to initialize the fgxExternalUrl directive. ', e);
            }

        }
        _exitOverlayInstances[id] = {
            externalUrl: checkExternalUrl
        };
        _.extend(FD.Brand.namespace('FD.Brand.Link', win), {
            exitOverlays: _exitOverlayInstances,
            externalUrl: checkExternalUrl
        });
    }

    function handleDynamicExtClick(ev) {
        var $el = $(this),
            externalId = $el.attr('data-fgx-external-ovr-id') || 'external';

        if (brand.Link && !_.isEmpty(brand.Link.exitOverlays)) {
            // NZ - use the overlay related to the externalId if available. Otherwise, use the generic brand.Link.externalUrl
            // which will relate to the last external overlay registered.
            var extLinkObj = (brand.Link.exitOverlays[externalId]) ? brand.Link.exitOverlays[externalId] : brand.Link;
            try {
                extLinkObj.externalUrl.call(this, ev, true);
            } catch(e) {
                brand.Util.log('simpleChoiceOverlayList::handleDynamicExtClick - error occurred trying to trigger the external overlay. ', e);
            }
        }
    }

})(jQuery, window, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay, FD.Brand.User);
;(function($, win, brand, util) {

    brand.setInitHandler('[data-fgx-link-dropdown]', init);

    /////////////

    function init(components) {

        if(components.length === 0) {
            return;
        }

        $('.fgx-custom-select', components).on('click', function() {
            var $el = $(this),
                $dropdown = $el.find('.fgx-custom-select-dropdown'),
                $selectContainer = $el.find('.fgx-custom-select-container'),
                $select = $selectContainer.closest('.fgx-custom-select'),
                $listbox = $dropdown.find('ul');;

            if(util.currentBreakpoint() === 'gux-bkpt-sm' && $el.closest('.table-container').length === 1) {
                if(!$dropdown.hasClass('shown')) {
                    //We are opening the dropdown. Need to append custom margin to the
                    $select.addClass('fgx-custom-margin-btm');
                } else {
                    $select.removeClass('fgx-custom-margin-btm');
                }
            }
            
            $dropdown.toggleClass('shown');
            $selectContainer.toggleClass('shown');
            
            $el.attr('aria-expanded', $dropdown.hasClass('shown'));
            $listbox.attr('aria-hidden', !$dropdown.hasClass('shown'));
        });
        
        $('.fgx-custom-select', components).on('click', 'li', function(ev) {
            var $el = $(this),
                $tgt = $(ev.target),
                $a = $el.find('a').first();
                $dropdown = $el.closest('.fgx-custom-select-dropdown'),
                $combobox = $el.closest('.fgx-custom-select'),
                $listbox = $dropdown.find('ul');
            
            $dropdown.removeClass('shown');
            $combobox.attr('aria-expanded', $dropdown.hasClass('shown'));
            $combobox.attr('aria-activedescendant', $el.attr('id'));
            $listbox.attr('aria-hidden', !$dropdown.hasClass('shown'));
            $('li', $listbox).attr('aria-selected', 'false');
            $el.attr('aria-selected', 'true');
            if ($tgt.is('li')) {
                // should apply to our key-listener 'click' event only
                var target = $a.attr('target');
                var href = $a.attr('href');
                if (target === '_blank') {
                    // new window
                    var win = window.open(href, '_blank');
                    win.focus();
                } else {
                    // current window
                    location.href = href;
                }
            }
            
        });
    }

})(jQuery, window, FD.Brand, FD.Brand.Util);

;(function($, win, brand) {

    var activeAnchor = null;
    brand.setInitHandler('[data-fgx-glossary-page]', init);

    /////////////

    function init(components) {

        $('.mobile-dropdown-display', components).click(function() {
            $(this).parent('.custom-dropdown').toggleClass('open');
        });

        $(components).on('click', '.tabbed-list li' , function() {
            var $el = $(this);
            if(!$el.hasClass('disabled')) {
                $el.addClass('selected').siblings().removeClass('selected');
                $el.attr('aria-pressed', 'true').siblings().attr('aria-pressed', 'false');
                $('.selected-option', components).text($el.text());
                showSection($el.attr('data-section'));
            }
        });
        if(win.addEventListener) {
            win.addEventListener('hashchange', anchorCheck);
        } else {
            // IE8 fallback
            win.onhashchange = anchorCheck;
        }
        if(!anchorCheck()) {
            // click first non-disabled section
            $('.tabbed-list li').not('.disabled').first().click();
        }
    }

    function showSection(section) {
        if(section) {
            $('.glossary-section-content[data-section=\'' + section + '\']')
                .show()
                .siblings()
                .hide();
        } else {
            $('.glossary-section-content').show();
        }
        updateHash(section);
    }

    function anchorCheck() {
        var anchorId = win.location.hash;
        if(anchorId) {
            anchorId = anchorId.substr(1);
            if(anchorId === '*') {
                anchorId = '';
            }
            if(activeAnchor === anchorId) {
                return;
            }
            $('.tabbed-list li[data-section=\'' + anchorId + '\']').click();
            activeAnchor = anchorId;
            return true;
        }
    }

    function updateHash(anchorId) {
        anchorId = anchorId || '*';
        activeAnchor = anchorId;
        if(win.history.replaceState) {
            var href = win.location.href;
            href = href.substr(0, href.length - win.location.hash.length) + ((anchorId) ? '#' + anchorId : '');
            win.history.replaceState({}, document.title, href);
        }
    }


})(jQuery, window, FD.Brand);

;(function($, win, brand, util) {

    var activeAnchor = null;

    brand.setInitHandler('[data-fgx-anchor-link-bar]', init);

    /////////////

    function init(components) {
        if(components.length === 0) {
            return;
        }

        components.each(function(idx) {
            var $el = $(this);
            if($el.hasClass('m-link-dropdown')) {
                var $select = $el.find('.fgx-custom-select'),
                    $current = $select.find('.fgx-custom-select-current'),
                    $firstItem = $select.find('.fgx-anchorLinkBar-link-item.first-item'),
                    firstText = $firstItem.attr('data-fgx-link-text'),
                    firstIconClass = $firstItem.attr('data-fgx-icon-class'),
                    ariaOwns = $select.attr('aria-owns').replace('{{compIdx}}', idx);
                $select.attr('aria-owns', ariaOwns);
                $select.find('[data-fgx-id-template]').each(function() {
                    var idTemplate = $(this).attr('data-fgx-id-template').replace('{{compIdx}}', idx);
                    $(this).attr('id', idTemplate);
                });
                if($current) {
                    updateCurrentDisplay($current, firstText, firstIconClass);
                }
            }
        });

        $('.anchors', components).on('click', 'li', function(ev) {
            updateActiveLink.call(this);
        });

        $('.fgx-custom-select', components).on('click', function() {
            var $el = $(this),
                $dropdown = $el.find('.fgx-custom-select-dropdown'),
                $selectContainer = $el.find('.fgx-custom-select-container'),
                $listbox = $dropdown.find('ul');

            $dropdown.toggleClass('shown');
            $selectContainer.toggleClass('shown');

            $el.attr('aria-expanded', $dropdown.hasClass('shown'));
            $listbox.attr('aria-hidden', !$dropdown.hasClass('shown'));
        });

        $('.fgx-custom-select', components).on('click', 'li', function(ev) {
            var $el = $(this),
                $tgt = $(ev.target),
                $a = $el.find('a').first();
                $dropdown = $el.closest('.fgx-custom-select-dropdown'),
                $combobox = $el.closest('.fgx-custom-select'),
                $listbox = $dropdown.find('ul'),
                $current = $combobox.find('.fgx-custom-select-current'),
                linkText = $el.attr('data-fgx-link-text'),
                iconClass = $el.attr('data-fgx-icon-class'),
                activeId = $el.attr('data-fgx-anchor-id');

            $combobox.attr('aria-activedescendant', $el.attr('id'));
            $('li', $listbox).attr('aria-selected', 'false');
            $el.attr('aria-selected', 'true');

            if($current) {
                var updated = updateCurrentDisplay($current, linkText, iconClass);
                if(updated) {
                    var $anchors = $combobox.closest('.anchor-link-bar').find('.anchors');

                    $anchors.find('.navbar-nav').each(function() {
                        var $itm = $(this),
                            currentId = $itm.attr('data-fgx-anchor-id');

                        $itm.toggleClass('active-link', (currentId === activeId));
                    });
                }

            }

            if ($tgt.is('li')) {
                // should apply to our key-listener 'click' event only
                var href = $a.attr('href'),
                    $href = $(href),
                    $stickyNav = $('.navbar-static-top'),
                    topOffset = ($href && $href.length > 0) ? $href.offset().top : 55,
                    scrollTo = ($stickyNav.length) ? topOffset - $stickyNav.height() : topOffset;

                updateHash(href.substr(1));

                $('html').animate({scrollTop:scrollTo}, 0);
            }

            activeAnchor = activeId;
        });

        // monitor hash changes
        if(win.addEventListener) {
            win.addEventListener('hashchange', anchorCheck);
        } else {
            // IE8 fallback
            win.onhashchange = anchorCheck;
        }
        anchorCheck();

        function updateActiveLink() {
            var $el = $(this);
            if($el.hasClass('active-link')) {
                return;
            }

            var $anchors = $el.closest('.anchors'),
                $anchorLinkBar = $anchors.closest('.anchor-link-bar'),
                activeAnchorId = $el.attr('data-fgx-anchor-id');
            $anchors.find('.active-link').removeClass('active-link');
            $el.addClass('active-link');

            if($anchorLinkBar.hasClass('m-link-dropdown')) {
                var linkText = $el.attr('data-fgx-link-text'),
                    iconClass = $el.attr('data-fgx-icon-class'),
                    $combobox = $anchorLinkBar.find('.fgx-custom-select'),
                    $listbox = $combobox.find('.fgx-custom-select-dropdown ul'),
                    activeId = '';

                $listbox.find('.fgx-anchorLinkBar-link-item').each(function() {
                    var $itm = $(this),
                        currentAnchorId = $itm.attr('data-fgx-anchor-id');
                    if(currentAnchorId === activeAnchorId) {
                        $itm.attr('aria-selected', 'true');
                        activeId = $itm.attr('id');
                    } else {
                        $itm.attr('aria-selected', 'false');
                    }
                });

                if(activeId != '') {
                    $combobox.attr('aria-activedescendant', activeId);
                }

                updateCurrentDisplay($anchorLinkBar.find('.fgx-custom-select .fgx-custom-select-current'), linkText, iconClass);
            }

            activeAnchor = activeAnchorId;
        }

        function anchorCheck() {
            var anchorId = win.location.hash;
            var toggle = null;
            if (anchorId) {
                var anchor = anchorId.substr(1);
                // process hash
                if(activeAnchor === anchor) {
                    return;
                }
                var dataAttr = '.navbar-nav[data-fgx-anchor-id="'+anchor+'"]';
                toggle = $(dataAttr, components);
            }

            if(toggle) {
                updateActiveLink.call(toggle);
                activeAnchor = anchorId.substr(1);
            }
        }

        function updateCurrentDisplay($current, linkText, iconClass) {
            if(!$current || ($current && $current.length == 0)) {
                return false;
            }
            var output = '',
                updated = false;
            if(iconClass) {
                var iconMarkup = '<i class="fgx-icon ' + iconClass + '" aria-hidden="true"></i>';
                output +=  iconMarkup;
            }
            if(linkText) {
                var linkMarkup = '<span class="link-text">' + linkText + '</span>';
                output += linkMarkup;
            }
            if(output != '') {
                $current.html(output);
                updated = true;
            }
            return updated;
        }

        function updateHash(id) {
            if(id && (id !== activeAnchor)) {
                win.location.hash = id;
                activeAnchor = id;
            }
        }
    }
})(jQuery, window, FD.Brand, FD.Brand.Util);

/*global FD*/
;(function (win, $, _, brand, ctx, user, util, ngp) {
    var components,
        _loadedPaths = {},
        _inEditMode = false;

    brand.setInitHandler('[data-fgx-incentives-campaign-card]', init);

    /////////////

    function init(newComponents) {
        if(newComponents.length == 0) {
            return;
        }

        components = newComponents;
        _inEditMode = !!(components.attr('data-fgx-in-author-edit') === 'yes');

        var vehicleData = {
                postalCode: user.location.current().postalCode,
                appContext: 'ngbs_sploffr',
                language: ctx && ctx.languageKey || 'EN'
            };

        vehicleData = _.assign(vehicleData, getVehicleData());

        if(_inEditMode) {
            components.find('.content-section').toggleClass('hidden', false);
        }

        if (!(vehicleData.make && vehicleData.model && vehicleData.year && vehicleData.postalCode)) {
            initDefaultView();
            return;
        } else {
            var _userPricing = user.pricing.current();
            if (_userPricing && _userPricing.planType) {
                vehicleData.planType = _userPricing.planType;
            }
            ngp.specialOffers(vehicleData).done(function(resp) {
                var campaignOffers = {},
                    getOffers = function(obj) {
                        var _offers = _.where(util.objPathAsArray(obj, 'Groups.Group'), { type: "Campaign" });
                        _.forEach(_offers || [], function(itm) {
                            var itmCampaign = itm && itm.Campaign,
                                cmpId = itmCampaign && itmCampaign.Id;
                            if (typeof(campaignOffers[cmpId]) === 'undefined' || _.isEmpty(campaignOffers[cmpId])) {
                                campaignOffers[cmpId] = itm;
                            }
                        });
                    };
                // Get Campaign type offers at the nameplate level
                getOffers(resp);
                // Get any available Campaign type offers at the trim level.
                _.forEach(util.objPathAsArray(resp, 'Trims.Trim'), function(trim) {
                    if (trim) {
                        getOffers(trim);
                    }
                });

                if (_.isEmpty(campaignOffers)) {
                    initDefaultView();
                    return;
                }

                var sortedOffers = _.sortBy(campaignOffers, function(itm) {
                    var itmCampaign = itm && itm.Campaign,
                        seqNum = itmCampaign && itmCampaign.SequenceNumber;
                    // NZ - the result of parseInt is OR'd with 0 to prevent a NAN from being returned, which is what
                    // parseInt will return if it can't convert the input to a number.
                    return (seqNum) ? parseInt(seqNum, 10) || 0 : 0;
                });
                var offer = sortedOffers[0];
                renderOfferContent(offer, vehicleData);
            }).fail(function() {
                initDefaultView();
                return;
            });
        }

        $('.card-print', components).on('click', function() {
            var $wrapper = $(this).closest('.incentives-campaign-card-wrapper');
            togglePrintClasses($wrapper, true);
            var handlePrintClose = function() {
                togglePrintClasses($wrapper, false);
            };
            setupPrintEndListeners(handlePrintClose);
            win.print();
        });
    }

    function getVehicleData() {
        var data = {};

        if (ctx && ctx.nameplate) {
            data.make = ctx.make;
            data.model = ctx.nameplate.ngpModelName || '';
            data.year = ctx.nameplate.ngpYear || '';
        } else {
            var cookie = util.cookie.get('FPI'),
                params = (cookie) ? util.parameters.decode(cookie) : { };
            if (!_.isEmpty(params)) {
                data.make = params.make || '';
                data.model = params.model || '';
                data.year = params.year || '';
            }
        }
        return data;
    }

    function initDefaultView() {
        // If we're in edit mode, the authored sub component should be loaded and visible by default
        if(_inEditMode) {
            return;
        }
        util.log("incentivesCampaignCard::initializing default view");

        var requestUrl = components.attr('data-campaign-unavailable-resource-url') || '';

        if (requestUrl) {
            if (!_loadedPaths[requestUrl]) {
                $.get(requestUrl).then(function(res) {
                    util.log("incentivesCampaignCard::sub-component request - successful. ", {"url": requestUrl});
                    _loadedPaths[requestUrl] = 1;
                    var selector = '.campaign-unavailable .sub-component-wrap';
                    var $compWrap = components.find(selector);
                    if($compWrap.length) {
                        updateVisibleSection('campaign-unavailable', false);
                        if(components.hasClass('hidden')) {
                            components.removeClass('hidden');
                        }
                        $compWrap.html(res);
                        brand.initComponent($compWrap);
                    }
                }, function() {
                    util.log("incentivesCampaignCard::sub-component request - failed. Hiding component. ", {"url": requestUrl});
                    components.addClass('hidden');
                });
            } else {
                //The paths have already been loaded, so we just need to ensure the proper components are displaying
                var selector = '.campaign-unavailable .sub-component-wrap';
                var $compWrap = components.find(selector);
                if($compWrap.length) {
                    updateVisibleSection('campaign-unavailable', false);
                }
            }
        } else {
            components.addClass('hidden');
        }
    }

    function renderOfferContent(currentOffer, vehicleData) {
        var offer = currentOffer && currentOffer.Campaign || {};

        // BRAND-15693 - initialize the default view if the sequence number of the selected offer is >= 50.
        if ((!offer || _.isEmpty(offer)) || (offer && ((parseInt(offer.SequenceNumber, 10) || 0) >= 50))) {
            initDefaultView();
            return;
        }

        var $elm = $('.incentives-campaign-card', components),
            offerImg = offer.CampaignImages && offer.CampaignImages.CampaignImage,
            altText = '',
            linkCtx = _.pick(vehicleData, ['make', 'model', 'year']),
            $printDisclaimerEl = $elm.find('.print-disclaimer-note');

        updateVisibleSection('campaign-available', true);

        $elm.closest('.incentives-campaign-card-wrapper').attr('data-link-context', JSON.stringify(linkCtx));

        if (offer.Name) {
            var $nameEl = $elm.find('.nameplate-text').html(offer.Name).removeClass('hidden').addClass('fgx-brand-print-force-shown');
            altText = $nameEl.text().trim();
        }

        if (offer.Detail) {
            $elm.find('.card-text')
                .html(offer.Detail)
                .removeClass('hidden')
                .addClass('fgx-brand-print-force-shown');
        }

        if (offer.Disclaimer) {
            $elm.find('.popup-disclaimer .fgx-popup-tooltip-content')
                .html(offer.Disclaimer)
                .addClass('fgx-brand-print-force-shown')
                .closest('.popup-disclaimer')
                .removeClass('hidden')
                .addClass('fgx-brand-print-force-shown');
        }

        if (offerImg && offerImg.URL) {
            var $wrapper = $elm.find('.img-wrap').addClass('fgx-brand-print-force-shown'),
                settings = ctx && ctx.settings,
                baseUrl = settings && settings.ngpServiceUrl || '',
                pathArr = offerImg.URL.split("?"),
                params = (pathArr[1]) ? util.parameters.encode(util.parameters.decode(pathArr[1])) : '',
                path = pathArr[0] + "?api_key=" + (settings && settings.ngpApiKey || "") + "&" + params;
            $('<img class="lazyload"/>')
                .attr('data-srcset', baseUrl + path)
                .attr('alt', altText)
                .addClass('fgx-brand-print-force-shown')
                .appendTo($wrapper);
        }

        setTimingAlert($elm, offer.StartDate, offer.EndDate);

        if ($printDisclaimerEl.length) {
            var noteTmpl = $printDisclaimerEl.attr('data-pdn-tmpl') || '';
            if (noteTmpl) {
                var template = _.template(noteTmpl, {interpolate: /{([\s\S]+?)}/g}),
                    data = {
                        date: wrapInStrong(util.dateTime.longFormat()),
                        make: wrapInStrong(vehicleData.make),
                        model: wrapInStrong(vehicleData.model),
                        year: wrapInStrong(vehicleData.year),
                        postalCode: wrapInStrong(vehicleData.postalCode)
                    },
                    outputText = template(data);
                $printDisclaimerEl.html(outputText || '');
            }
        }

    }

    function setTimingAlert($elm, sDateStr, eDateStr) {
        var cDate = new Date(),
            sDate = getDateObj(sDateStr),
            eDate = getDateObj(eDateStr);

        if (datesWithinRange(sDate, cDate)) {
            showElm($elm, '.just-announced');
        } else if (datesWithinRange(cDate, eDate)) {
            showElm($elm, '.expiring-soon');
        }
    }

    function getDateObj(dateStr) {
        var dateArr = (dateStr || '').split('-');

        if ( dateArr.length < 3) {
            return null;
        }

        return new Date(dateArr[0], (parseInt(dateArr[1], 10) - 1), dateArr[2]);
    }

    function datesWithinRange(sDate, eDate) {
        return (_.isDate(sDate) && _.isDate(eDate)) ? (sDate.setDate(sDate.getDate() + 10) >= eDate) : false;
    }

    function showElm($container, selector) {
        if (!$container || !selector) {
            return;
        }
        $container.find(selector)
                  .removeClass('hidden')
                  .addClass('fgx-brand-print-force-shown');
    }

    function updateVisibleSection(sectionId, enableForPrint) {
        if (!_inEditMode) {
            components.find('.content-section').each(function() {
                var $el = $(this),
                    isSection = $el.hasClass(sectionId);
                $el.toggleClass('hidden', !isSection)
                   .toggleClass('fgx-brand-print-force-shown', (enableForPrint && isSection));
            });
        }
    }

    function wrapInStrong(txt) {
        return (txt) ? ('<strong>' + txt + '</strong>') : '';
    }

    function setupPrintEndListeners(callback) {
        var eventKey = (win.onafterprint !== undefined) ? 'afterprint' : 'focus';
        $(win).one(eventKey, callback);
    }

    function togglePrintClasses($el, enabled) {
        $('body').toggleClass('fgx-brand-print-hide-all-children', enabled);
        if ($el && $el.length) {
            $el.parents().each(function() {
                if (!$(this).is('body')) {
                    $(this).toggleClass('fgx-brand-print-force-shown', enabled);
                }
            });
        }
    }
    
})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Context, FD.Brand.User, FD.Brand.Util, FD.Brand.NgpServices);
;(function($, win, _, brand, util, user) {

    var _loadedPaths = {},
        _compRegistry = {},
        _exp = '',
        _baseID = 'zcc-item-',
        _inEditMode = false;

    brand.setInitHandler('[data-fgx-zip-code-container]', init);

    /////////////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        _inEditMode = !!(components.attr('data-zip-prevent-call') === 'yes');

        // load components on initial location resolution and also if it changes.
        user.location.subscribe(function() {
            var location = user.location.current();
            var zipAware = !!(location && location.postalCodeSource !== 'Akamai' && location.postalCodeSource !== 'Default' && location.postalCode);

            if(!_inEditMode && (_exp === '' || (_exp === 'zip-unaware' && zipAware) || (_exp === 'zip-aware' && !zipAware))) {
                _exp = (zipAware) ? 'zip-aware' : 'zip-unaware';

                components.each(function(idx) {
                    var $this = $(this),
                        id = $this.attr('data-fgx-comp-id') || '',
                        compData = {},
                        requestUrl = '';

                    if(!id) {
                        id = _baseID + idx;
                        registerComp($this, id);
                    }

                    compData = _.assign({}, _compRegistry[id] || {});

                    if(!_.isEmpty(compData)) {
                        requestUrl = ((zipAware) ? compData.zipAwarePath : compData.zipUnawarePath) || '';
                    }

                    if(!_loadedPaths[requestUrl]) {
                        $.get(requestUrl).then(function(res) {
                            util.log("zipCodeContainer::request - successful. ", {"url": requestUrl});
                            _loadedPaths[requestUrl] = 1;
                            var selector = '.' + _exp + ' .sub-component-wrap';
                            var $compWrap = $this.find(selector);
                            if($compWrap.length) {
                                $this.find('.content-section').each(function() {
                                    $(this).toggleClass('hidden', !$(this).hasClass(_exp));
                                });
                                if($this.hasClass('hidden')) {
                                    $this.removeClass('hidden');
                                }
                                $compWrap.html(res);
                                brand.initComponent($compWrap);
                            }
                        }, function() {
                            util.log("zipCodeContainer::request - failed. Hiding component. ", {"url": requestUrl});
                            $this.addClass('hidden');
                        });
                    } else {
                        //The paths have already been loaded, so we just need to ensure the proper components are displaying
                        var selector = '.' + _exp + ' .sub-component-wrap';
                        var $compWrap = $this.find(selector);
                        if($compWrap.length) {
                            $this.find('.content-section').each(function() {
                                $(this).toggleClass('hidden', !$(this).hasClass(_exp));
                            });
                        }
                    }

                });
            }
        });
    }

    function registerComp($el, id) {
        if(!$el || $el.length === 0) {
            return;
        }

        $el.attr('data-fgx-comp-id', id);

        var zipAwarePath = $el.attr('data-zip-aware-resource-url') || '';
        var zipUnawarePath = $el.attr('data-zip-unaware-resource-url') || '';
        var data = {
            'compID': id,
            'zipUnawarePath': zipUnawarePath,
            'zipAwarePath': zipAwarePath
        };
        _compRegistry[id] = _.assign({}, data);
        util.log("zipCodeContainer::registerComp - comp registered: ", data);
    }

})(jQuery, window, FD.Brand.lodash, FD.Brand, FD.Brand.Util, FD.Brand.User);
;(function($, brand, media) {

    brand.setInitHandler('[data-fgx-gallery-trigger-reveal]', init);

    var MIN_DISPLAY = 8,
        MIN_DISPLAY_TABLET = 9,
        bp = 'gux-bkpt-med',
        prev_bp = 'gux-bkpt-med';
        
    /////////////

    function init(components) {
        components.each(function() {
            var $sections = $(this).find('.content-section'),
                $viewMore = $(this).find('.view-more');

            $sections.each(function() {
                var $tiles = $(this).find(".fgx-brand-gallery-items-wrap .gallery-tile"),
                    tileCount = $tiles.length,
                    isActive = $(this).hasClass('active'),
                    i = 1,
                    CURR_MIN_DISPLAY = MIN_DISPLAY;

                if (bp === 'gux-bkpt-med') {
                    // use the min display number for tablet
                    CURR_MIN_DISPLAY = MIN_DISPLAY_TABLET;
                }

                $tiles.each(function() {
                    if(i > CURR_MIN_DISPLAY) {
                        $(this).addClass("hidden");
                    }
                    i++;
                });

                if(isActive && (tileCount > CURR_MIN_DISPLAY)) {
                    $viewMore.removeClass("hidden");
                }
            });
            
            var $tabs = $(this).find('.section-tab');
            
            $tabs.each(function() {
                if($(this).hasClass('active')) {
                    $(this).attr('aria-pressed', 'true');
                } else {
                    $(this).attr('aria-pressed', 'false');
                }
            });

            var $moreToggle = $(this).find('.moreDesc');
            var $lessToggle = $(this).find('.lessDesc');
            var $desc = $(this).find('.description-more');

            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
                $lessToggle.focus();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
                $moreToggle.focus();
            });
        });

        $('.view-more', components).click(function(ev) {
            ev.preventDefault();
            var $section = $(this).parent('.content-sections').find('.content-section.active'),
                $tiles = $section.find(".fgx-brand-gallery-items-wrap .gallery-tile.hidden"),
                hiddenTileCount = $tiles.length,
                i = 1
                CURR_MIN_DISPLAY = MIN_DISPLAY;
            
            if (bp === 'gux-bkpt-med') {
                // use the min display number for tablet
                CURR_MIN_DISPLAY = MIN_DISPLAY_TABLET;
            }

            $tiles.each(function() {
                if(i <= CURR_MIN_DISPLAY) {
                    $(this).removeClass("hidden");
                    if (i == 1) {
                        // if we're the very first tile revealed, set focus so we pick up where we left off
                        $(this).focus();
                    }
                } else {
                    return false;
                }
                i++;
            });

            if(hiddenTileCount <= CURR_MIN_DISPLAY) {
                $(this).addClass("hidden");
            }
        });

        $('.section-tab', components).click(function() {
            if($(this).hasClass('active')) {
                return;
            }

            var $elm = $(this),
                $btnWrapper = $elm.closest('.btn-wrapper'),
                $headerWrapper = $btnWrapper.closest('.header-wrapper'),
                $container = $headerWrapper.siblings('.content-sections'),
                $sections = $container.find('.content-section'),
                $viewMore = $container.find('.view-more'),
                tabId = $elm.data('tabId'),
                hiddenTileCount = 0;

            $sections.each(function() {
                var sectionId = $(this).data('tabId');

                if(sectionId === tabId) {
                    $(this).addClass('active');
                    hiddenTileCount = $(this).find(".fgx-brand-gallery-items-wrap .gallery-tile.hidden").length;
                } else {
                    $(this).removeClass('active');
                }
            });

            $btnWrapper.find('.section-tab').each(function() {
                $(this).removeClass('active');
                $(this).attr('aria-pressed', 'false');
            });
            $elm.addClass('active');
            $elm.attr('aria-pressed', 'true');

            //Check if the 'view-more' button needs to be displayed for this tab.
            if(hiddenTileCount > 0) {
                $viewMore.removeClass('hidden');
            } else {
                $viewMore.addClass('hidden');
            }

        });

        $(window).resize(function(){
            setBreaks(components);
        });

        setBreaks(components);
        media.link(components);
    }

    function setBreaks(components){
        bp = brand.Util.currentBreakpoint();
        if (bp !== prev_bp) {
            // only refresh the tiles when our breakpoint changes.
            refreshGalleryTiles(components);
            prev_bp = bp;
        }
    }
    
    function refreshGalleryTiles(components) {
        components.each(function() {
            var $sections = $(this).find('.content-section'),
                $viewMore = $(this).find('.view-more');

            $sections.each(function() {
                var $tiles = $(this).find(".fgx-brand-gallery-items-wrap .gallery-tile"),
                    tileCount = $tiles.length,
                    isActive = $(this).hasClass('active'),
                    i = 1
                    CURR_MIN_DISPLAY = MIN_DISPLAY;
                
                if (bp === 'gux-bkpt-med') {
                    // use the min display number for tablet
                    CURR_MIN_DISPLAY = MIN_DISPLAY_TABLET;
                }
                
                $tiles.each(function() {
                    if(i > CURR_MIN_DISPLAY) {
                        $(this).addClass("hidden");
                    } else {
                        $(this).removeClass("hidden");
                    }
                    i++;
                });

                if(isActive && (tileCount > CURR_MIN_DISPLAY)) {
                    $viewMore.removeClass("hidden");
                }
            });
        });
    }

})(jQuery, FD.Brand, FD.Brand.MediaOverlay);
;(function($, brand, media) {

    brand.setInitHandler('[data-fgx-gallery-trigger]', init);


    /////////////

    function init(components) {

        components.each(function() {
            if($(this).hasClass('hide-cta')) {
                return true;
            }

            var ctaText = $(this).data('ctaText');
            var ctaAriaLabel = $(this).data('ctaAriaLabel');
            var ctaLink = $(this).data('ctaLink');
            var ctaTarget = $(this).data('ctaTarget');
            var ctaBackgroundColor = ($(this).data('ctaBgcolor')) ? $(this).data('ctaBgcolor') : '';

            //changed to eighth element instead of last - BRAND-4166
            var $galleryTiles = $(this).find('.gallery-items-wrap .gallery-tile');
            var $eighthElm = $galleryTiles.eq(7);
            var $unusedTiles = $galleryTiles.slice(8);

            if(ctaBackgroundColor && ctaBackgroundColor != '' && !$(this).hasClass('cta-bg-opaque')) {
                ctaBackgroundColor += "opacity:0.8;";
            }

            $('a.gallery-link', $eighthElm).prop('href', ctaLink);
            $('a.gallery-link', $eighthElm).attr('aria-label', ctaAriaLabel);
            $('a.gallery-link', $eighthElm).prop('target', ctaTarget);
            $('a.gallery-link', $eighthElm).attr('style', ctaBackgroundColor);
            $('a.gallery-link .gallery-text', $eighthElm).html(ctaText);
            var inlineColor = $('a.gallery-link .gallery-text', $eighthElm).find('span').css('color');
            if (inlineColor != '') {
                $('a.gallery-link .icon-action-chevron-right-25px', $eighthElm).css('color', inlineColor);
            }

            $eighthElm
                .attr("role", "none")
                .attr("tabindex", null)
                .attr('data-overlay-item', null)
                .attr('data-overlay-item-trigger', null)
                .attr('data-fgx-keypress', null)
                .attr('data-fd-metrics-click', null)
                .attr('data-fd-metrics-skip-inherit', true)
                .addClass('gallery-link-tile');

            //Set all tiles after the eighth to be hidden from the overlay as well - BRAND-4166
            $unusedTiles
                .attr("role", "none")
                .attr("tabindex", null)
                .attr('data-overlay-item', null)
                .attr('data-overlay-item-trigger', null)
                .attr('data-fgx-keypress', null)
                .attr('data-fd-metrics-click', null)
                .attr('data-fd-metrics-skip-inherit', true);

        });
        media.link(components);

        brand.Metrics.setInherited({
            container: components,
            inheritList: [{
                selector: '.gallery-image-tile',
                containerAttr: 'data-fd-metrics-image-click-inherit',
                childAttr: 'data-fd-metrics-click'
            }]
        });
    }
})(jQuery, FD.Brand, FD.Brand.MediaOverlay);
;(function($, brand, media) {

    brand.setInitHandler('[data-fgx-gallery-category]', init);

    /////////////

    function init(components) {

        var MIN_DISPLAY = 7,
            bp = 'gux-bkpt-med',
            prevScrollPos = 0;

        components.each(function() {
            var $tiles = $(this).find(".gallery-items-wrap .gallery-tile"),
                tileCount = $tiles.length,
                i = 1;

            $tiles.each(function() {
                //add class to destinguish between the different sized images.
                switch(i % MIN_DISPLAY) {
                    case 1:
                    case 2:
                    case 3:
                    case 4:
                        $(this).addClass("first-row");
                        break;
                    case 5:
                    case 6:
                    case 0:
                        $(this).addClass("second-row");
                        break;
                }
                if(i > MIN_DISPLAY) {
                    $(this).addClass("hidden");
                }
                i++;
            });

            if(tileCount > MIN_DISPLAY) {
                $(this).find(".view-more").removeClass("hidden");
            }

            //Add a class to the first tile for mobile display purposes
            $tiles.first().addClass("first-tile");

            //Set tile-count for mobile.
            $(this).find(".mobile-row .tile-count").html(tileCount + " images");
        });

        function setBreaks(){
            bp = window.FD.Brand.Util.currentBreakpoint();
        }

        /*NZ 3/22: Commenting out - should be removed but leaving it in for now incase we need to revert quickly.
        function positionVideoIcons(){
            $('.video-icon-wrap', components).each(function( index ) {
                var elTop = ($( this ).parent().height()/2) - ($( this ).height()/2);
                $( this ).css('top', elTop +'px');
            });
        }*/

        function updateMobileDisplay(container) {
            var $tiles = container.find(".gallery-items-wrap .gallery-tile"),
                tileCount = $tiles.length,
                i = 1;

            $tiles.each(function() {
                //add class to destinguish between the different sized images.
                switch(i % 10) {
                    case 1:
                    case 9:
                        $(this).addClass("mobile-width-sm");
                        break;
                    case 2:
                    case 8:
                        $(this).addClass("mobile-width-lg");
                        break;
                    case 3:
                    case 4:
                    case 6:
                    case 7:
                        $(this).addClass("mobile-width-md");
                        break;
                    case 5:
                    case 0:
                        $(this).addClass("mobile-width-xl");
                        break;
                }
                if(i > 10) {
                    $(this).addClass("hidden");
                } else if(i <= 10 && $(this).hasClass("hidden")) {
                    $(this).removeClass("hidden");
                }
                i++;
            });
            var viewContainer = container.find(".view-more");
            if(tileCount > 10) {
                viewContainer.removeClass("hidden");
            } else {
                viewContainer.addClass("hidden");
            }
        }

        $('a.view-more', components).click(function(ev) {
            ev.preventDefault();
            if(bp === 'gux-bkpt-sm') {
                $('.video-icon-wrap', components).show();
            }
            var $tiles = $(this).parent('.gallery-category').find(".gallery-items-wrap .gallery-tile.hidden"),
                hiddenTileCount = $tiles.length,
                i = 1,
                MIN_DISPLAY = (bp === 'gux-bkpt-sm') ? 10 : 7;

            $tiles.each(function() {
                if(i <= MIN_DISPLAY) {
                    $(this).removeClass("hidden");
                    if (i == 1) {
                        // if we're the very first tile revealed, set focus so we pick up where we left off
                        $(this).focus();
                    }
                } else {
                    return false;
                }
                i++;
            });

            if(hiddenTileCount <= MIN_DISPLAY) {
                $(this).addClass("hidden");
            }
        });

        $('.gallery-tile.first-tile .gallery-img img, .mobile-row', components).click(function(ev) {
            //Only respond to the click if on mobile
            if(bp === 'gux-bkpt-sm') {

                $('.video-icon-wrap', components).show();

                var $container = $(this).parents(".gallery-category"); //gallery-category

                if(!$container.hasClass("mobile-category-detail")) {
                    ev.stopPropagation();
                    $container.addClass("mobile-category-detail");
                    //Hide the other siblings.
                    components.each(function() {
                        if(!$(this).hasClass("mobile-category-detail")) {
                            $(this).addClass("desktop-only");
                        }
                    });
                    updateMobileDisplay($container);
                    prevScrollPos = $(window).scrollTop();
                    $(window).scrollTop(0);
                    $('.gallery-back', components).focus();

                    //Metrics - POC
                    brand.Metrics.handler.direct($container.attr('data-fd-metrics-category-click'));
                }
                //NZ 3/22: remove if no revert needed - positionVideoIcons();
            }
        });

        $('.gallery-back', components).click(function() {

            if(bp === 'gux-bkpt-sm') {
                $('.video-icon-wrap', components).hide();

                var $container = $(this).parents(".gallery-category");
                $container.removeClass("mobile-category-detail");
                //Show the other siblings.
                components.each(function() {
                    $(this).removeClass("desktop-only");
                });
                //NZ 3/22: remove if no revert needed - positionVideoIcons();
                $(window).scrollTop(prevScrollPos);
            }
        });

        $(window).resize(function(){
            //NZ 3/22: remove if no revert needed - positionVideoIcons();
            setBreaks();
            if(bp !== 'gux-bkpt-sm') {
                $('.video-icon-wrap', components).show();
            } else {
                // In mobile hide the video icons if the 'detail' section is not opened.
                if(!$('.mobile-category-detail.gallery-category').length) {
                    $('.video-icon-wrap', components).hide();
                }
            }
        });
        //NZ 3/22: remove if no revert needed - positionVideoIcons();
        setBreaks();

        media.link(components);

        brand.Metrics.setInherited({
            container: components,
            inheritList: [{
                selector: '.gallery-image-tile',
                containerAttr: 'data-fd-metrics-image-click-inherit',
                childAttr: 'data-fd-metrics-click'
            }]
        });
    }
})(jQuery, FD.Brand, FD.Brand.MediaOverlay);

;(function($, brand){

    brand.setInitHandler('[data-fgx-gallery-brand]', init);

    /////////////

    function init(components) {

        brand.MediaOverlay.link(components);
        //when all the tiles are visible
        $('.social-view-all', components).click(function(event){
            var $comp = $(this).closest('[data-fgx-gallery-brand]');
            var visible = $('.hidden-tile', $comp).is(':visible');
            var metricAttr = 'data-fd-metrics-view-all';
            $('.hidden-tile', $comp).toggleClass('tile-show', !visible);
            $('.viewLess', $comp).toggle(!visible);
            $('.viewAll', $comp).toggle(visible);
            $('.view-glyph', $comp)
                .toggleClass('icon-plus-outline-50px', visible)
                .toggleClass('icon-minus-outline-50px', !visible);

            if(visible) {
                //distance from top of viewport to top of view all/less button
                var viewAllViewportOffset = $('.galleryBrand.section .container.social-view-all.mobile').offset().top - $(window).scrollTop();
                var hiddenTilesHeight = 0;
                $('.brand-gallery .flexinline .hidden-tile').each(function() {
                  hiddenTilesHeight += $(this).outerHeight();
                });
                //max scroll distance from top
                var pageBottom = $(document).height() - $(window).height() + hiddenTilesHeight;
                //distance from bottom of page to bottom of view all/less button
                var viewAllDistanceFromBottom = pageBottom - ( $('.galleryBrand.section .container.social-view-all.mobile').offset().top + $('.galleryBrand.section .container.social-view-all.mobile').outerHeight() );
                //cant get viewport offset of view all/less button because after clicking, offset changes before can capture needed value
                //so use clientY (if defined) to capture last bit of offset user had relative to viewport when they clicked view less
                if (typeof event.clientY != 'undefined') {
                    $(window).scrollTop(pageBottom - viewAllDistanceFromBottom - event.clientY);
                } else {
                    // use best guess (290 from testing by tabbing to the element and then mouse-clicking) 
                    // because the button was 'clicked' by a keypress
                    $(window).scrollTop(pageBottom - viewAllDistanceFromBottom - 290);
                }

                //Metrics - POC
                metricAttr = 'data-fd-metrics-view-less';
                
            } else {
                // we were invisible at the beginning of the method, so we've been toggled on and are actually visible now.
                // focus on first 'hidden-tile' item's anchor tag.
                $('.hidden-tile:first a', $comp).focus();
            }

            //Metrics - POC
            var mtxRule = $comp.attr(metricAttr);
            if(mtxRule) {
                brand.Metrics.handler.direct(mtxRule);
            }
        });

    }
    
})(jQuery, FD.Brand);

;(function($, brand, util){

    brand.setInitHandler('[data-fgx-colorizer-gallery]', init);

    function init(components) {

        var $cta = $('.extSpin-cta > a.btn-cta.btn-primary, .extSpin-cta > a.btn-cta.btn-secondary', components);
        window.FD.Brand.Util.ctaHover($cta);
        
        if ($('.extSpin_container').length) {

            var $el = $(this),
                $img = $('#car_img'),
                $img_temp = $('#car_temp'),
                $spinControl = $('.spin_control'),
                $swatchItem = $('.swatchItem'),
                $reelCache = $('.round-cache'),
                $colorSwatch = $('.color_swatch'),
                $colorSwatchLabel = $('.color_swatch_label'),
                $extSpinContainer = $('.extSpin_container'),
                $imgReel = $('#car_img-round'),
                $colorSwatches = $('.color-swatches'),
                $colorSwatchesMainContainer = $('.color-swatches-main-container'),
                $swatchItemSelected = $('.swatchItem-selected'),
                $swatchSelectedColorExterior = $('.swatch-selected-color-exterior'),
                $swatchSelectedColorInterior = $('.swatch-selected-color-interior'),
                $labelExterior = $('.label-exterior'),
                $labelInterior = $('.label-interior'),
                $spinModelsItem = $('.spin-models-label'),
                spinModelsItemSize = ($spinModelsItem && $spinModelsItem.length) || 0,
                $swatchSelectedContainer = $('.swatch-selected-container'),
                spinIconIsVisible = true,
                spinInterval,
                isSpinning,
                currentFrame = 1,
                spinSpeed = 50,
                extColor = $('.swatchItem:first').attr('data-color'),
                extColorLabel = $('.swatchItem:first').text(),
                altText = $('.swatchItem:first').attr('data-alt-tag') || '',
                modelName = $('.color-swatches:first').attr('data-model'),
                modelYear = $('.color-swatches:first').attr('data-year'),
                modelTrim = $('.color-swatches:first').attr('data-trim'),
                isLoading = false,
                isLocal = (window.location.href.indexOf('http') === -1) ? true : false,
                mainHeight,
                newHeight,
                mobileWidth = 768,
                realResize = false,
                viewType = 'exterior',
                isTouch,
                winWidth = $(window).width(),
                index,
                spinDir,
                assetPath = $('.swatchItem:first').attr('data-assetPath'),
                assetServer = isLocal ? '' : $('.extSpin_container').attr('data-assetServer'),
                swatchIconMarkup = '<i class="icon icon-check-solid-25px swatch-selected-icon"></i>',
                mobileColorSelectionOpen = false,
                imgAltPrefix = $img.attr('alt') || '',
                rotateAction = $('.swatchItem:first').attr('data-fd-metrics-rotate'),
                imgTouchEndFired = false,
                $sliderEl = null,
                sliderAttributes = {
                    'tabindex': '0',
                    'role': 'slider',
                    'aria-labelledby':'car_img',
                    'aria-valuemin':'1',
                    'aria-valuemax':'36',
                    'aria-valuenow':'1',
                    'aria-valuetext':''
                },
                imgAngleAriaLabels = $extSpinContainer.data('img-angle-aria-labels'),
                currImgAngleLabels = imgAngleAriaLabels;

            updateCurrentImgAngleLabels($('.swatchItem:first', components));

            var $tabbedContentSection = $colorSwatches.closest('.tab-content-section');
            
            if($tabbedContentSection && $tabbedContentSection.length > 0) {
                $colorSwatches.addClass('fgx-in-hideable-section');
                $colorSwatches.data('fgxHiddenContainerEl', $tabbedContentSection);
            }

            var setupEvents = function () {

                $spinControl.bind("mousedown touchstart MozTouchDown", function (e) {
                    if (isSpinning) {
                        return;
                    }
                    isSpinning = true;
                    checkTouchEvents(e);
                    index = $(e.target).index();
                    spinDir = $(this).attr('id').split('_')[1];
                    spinInterval = setInterval(function () {
                        spinCar(spinDir);
                    }, spinSpeed);
                });

                $spinControl.bind("mouseup touchend MozTouchRelease", function (e) {
                    isSpinning = false;
                    checkTouchEvents(e);
                    clearInterval(spinInterval);
                });
                
                //binding touch event on colorizer image
                $img.bind("mouseup touchend", function (e) {
                    if(e.type === 'touchend') {
                        FD.Brand.Metrics.handler.direct(rotateAction);
                        imgTouchEndFired = true;
                    } else {
                        if(!imgTouchEndFired) {
                            FD.Brand.Metrics.handler.direct(rotateAction);
                        }
                        imgTouchEndFired = false;
                    }
                  });

                $spinControl.mouseleave(function (evt) {
                    clearInterval(spinInterval);
                });
                
                $img.mouseenter(function () {
                    $(this).removeClass('grabbing');
                    $(this).addClass('grab');
                });
                
                $img.mouseup(function () {
                    $(this).removeClass('grabbing');
                    $(this).addClass('grab');
                });
                
                $img.mousedown(function () {
                    $(this).removeClass('grab');
                    $(this).addClass('grabbing');
                });
                
                $img.bind("mousedown touchstart MozTouchDown", function (e) {
                    // upon interacting with image, spin icon needs to disappear
                    if (spinIconIsVisible) {
                        hideSpinIcon();
                    }
                });
                
                if (util.env.touch()) {
                    setSpinIcon('touch');
                }

                $('.swatchItem-selected-interior').click(function () {
                    $colorSwatchesMainContainer.scrollLeft(3000);
                });
                
                // set initial 'aria-checked' / 'aria-pressed' state
                $('.swatchItem:first').attr('aria-checked', 'true');

                if(spinModelsItemSize > 1) {
                    $('.spin-models-label:first').attr('aria-pressed', 'true');
                }
            }
            
            var setSpinIcon = function(type) {
                if (type === 'touch') {
                    $spinControl.find('.mobile').show();
                    $spinControl.find('.desktop').hide();
                    $spinControl.find('.spin-icon-label').hide();
                } else {
                    $spinControl.find('.desktop').show();
                    $spinControl.find('.spin-icon-label').show();
                    $spinControl.find('.mobile').hide();
                }
            }
            
            var hideSpinIcon = function () {
                $('.spin_control_container', components).fadeOut(500);
                spinIconIsVisible = false;
            }

            //
            var spinCar = function (spinDir) {
                if (spinDir === 'left') {
                    $img.trigger('stepLeft');
                } else {
                    $img.trigger('stepRight');
                }
            }

            var setColor = function (color, extColorLabel, assetPath) {

                if (isLoading) {
                    return
                }

                //$('.swatchItem-label').html('');
                $('.swatchItem-label').hide();
                $('.swatchItem-label[data-color="' + color + '"]').fadeIn();
                //$('.swatchItem-label[data-color="' + color + '"]').html(extColorLabel);

                $swatchSelectedContainer.hide();
                $swatchSelectedContainer.html('');

                $('.swatch-selected-container[data-color="' + color + '"]').fadeIn();
                $('.swatch-selected-container[data-color="' + color + '"]').html(swatchIconMarkup);

                var imgAltText = imgAltPrefix + ' ' + altText;
                $img.attr('alt', imgAltText.trim());

                $('#car_img-round').css({'width': '100%', 'height': 'auto', 'overflow': 'hidden'});
                var varZero = (currentFrame < 10) ? '0' : '';

                isLoading = false;
                
                loadReel();
            }

            var loadReel = function () {

                //
                $('.round-cache').remove();

                //
                $img.unreel();

                // calculate width for revolution
                var rev = $('.extSpin_container').width() * 1.5;

                $img.reel({
                    frames: 36,
                    frame: currentFrame,
                    cw: true,
                    brake: 0.23,
                    throwable: 1,
                    revolution: rev,
                    cursor: 'default',
                    images: assetPath.split(',')
                }).off("loaded.fgxColorizer360").on("loaded.fgxColorizer360", function(ev){
                    $('.reel-cache').find('img').attr('alt', '');
                    $sliderEl = $('#car_img-reel');
                    sliderAttributes['aria-valuenow'] = currentFrame;
                    $sliderEl.attr(sliderAttributes);
                    $sliderEl.off("keydown.fgxColorizer360").on("keydown.fgxColorizer360", function (e) {
                        if (e.ctrlKey || e.metaKey || e.altKey) {
                            return;
                        }
                        switch(e.which) {
                            case 39: // Right Arrow - note that spin directions are reversed for keypress functionality
                                if (isSpinning) {
                                    return;
                                }
                                // upon interacting with keyboard, spin icon needs to disappear
                                if (spinIconIsVisible) {
                                    hideSpinIcon();
                                }
                                isSpinning = true;
                                spinInterval = setInterval(function () {
                                    spinCar('left');
                                }, spinSpeed);
                            break;
                            case 37: // Left Arrow - note that spin directions are reversed for keypress functionality
                                if (isSpinning) {
                                    return;
                                }
                                // upon interacting with keyboard, spin icon needs to disappear
                                if (spinIconIsVisible) {
                                    hideSpinIcon();
                                }
                                isSpinning = true;
                                spinInterval = setInterval(function () {
                                    spinCar('right');
                                }, spinSpeed);
                            break;
                        }

                    });

                    $sliderEl.off("keyup.fgxColorizer360").on("keyup.fgxColorizer360", function (e) {
                        if (isSpinning) {
                            isSpinning = false;
                            clearInterval(spinInterval);
                        }
                    });
                    if (currImgAngleLabels && currImgAngleLabels.hasOwnProperty(currentFrame)) {
                        $sliderEl.attr('aria-valuetext', currImgAngleLabels[currentFrame].label);
                    }
                }).off("frameChange.fgxColorizer360").on('frameChange.fgxColorizer360', function () {
                    currentFrame = $(this).data("frame");
                    if ($sliderEl != null) {
                        $sliderEl.attr('aria-valuenow', currentFrame);
                        if (currImgAngleLabels && currImgAngleLabels.hasOwnProperty(currentFrame)) {
                            $sliderEl.attr('aria-valuetext', currImgAngleLabels[currentFrame].label);
                        }
                    }
                });
            }

            // Setup Swatch
            var setupSwatch = function () {

                //
                isTouch = (winWidth < mobileWidth) ? true : false;

                //
                $('.color-swatches').first().css({'opacity': 1});

                //
                $('.color-swatches:not(:first)').hide();

                //
                $swatchItem.each(
                    function () {
                        var swatchHex = $(this).attr('data-hex');
                        $(this).css('backgroundColor', swatchHex);
                    });

                //
                $('.swatchItem-selected-exterior').css({
                    'background-color': $('.color_swatch_exterior .swatchItem:first-child').attr('data-hex')
                });
                $('.swatchItem-selected-interior').css({
                    'background-color': $('.color_swatch_interior .swatchItem:first-child').attr('data-hex')
                });

                $('.swatch-selected-interior').hide();

                if ($('.color_swatch_interior').length != 0) {
                    $('.swatch-selected-interior').show();
                } else {
                    $('.swatch-selected-interior').hide();
                }


            }

            var handleSwatchItemClick = function () {
                var $this = $(this);
                assetPath = $this.attr('data-assetPath');
                rotateAction = $this.attr('data-fd-metrics-rotate');
                updateCurrentImgAngleLabels($this);

                //
                var prevViewType = components.attr('data-fgx-current-view'),
                    currentView = $this.parent().parent().parent().attr('class'),
                    viewType = (currentView.indexOf('exterior') !== -1) ? 'exterior' : 'interior',
                    extColor = $this.attr('data-color'),
                    extColorLabel = $this.text(),
                    modelTrim = $this.attr('data-trimName'),
                    isTouch = (winWidth < mobileWidth) ? true : false;

                altText = $this.attr('data-alt-tag') || '';

                //
                if (isTouch) {

                    if (viewType === 'exterior') {
                        $swatchSelectedColorExterior.html(extColorLabel);
                    } else if (viewType === 'interior') {
                        $swatchSelectedColorInterior.html(extColorLabel);
                    }

                } else {
                    if (viewType === 'exterior') {
                        $swatchSelectedColorExterior.html(extColorLabel);
                        $labelInterior.html('');
                    } else if (viewType === 'interior') {
                        $labelExterior.html('');
                        $swatchSelectedColorInterior.html(extColorLabel);
                    }
                }

                // update spin set from current swatch
                setColor(extColor, extColorLabel, assetPath);

                // update aria-pressed attribute
                $swatchItem.attr('aria-checked', 'false');
                $(this).attr('aria-checked', 'true');

                // set mobile selected
                $('.swatchItem-selected-' + viewType).css({
                    'background-color': $(this).attr('data-hex')
                });

                if(prevViewType !== viewType) {
                    components.attr('data-fgx-current-view', viewType);
                }
            };
            
            var handleSwatchItemHoverIn = function () {
                var isSelected = ($(this).attr('aria-checked') === 'true' || $(this).attr('aria-checked') === true);
                if (!isSelected) {
                    var $parent = $(this).closest('.swatchItem-container');
                    $('.swatchItem-label', $parent).fadeIn();
                }
            };
            
            var handleSwatchItemHoverOut = function () {
                var isSelected = ($(this).attr('aria-checked') === 'true' || $(this).attr('aria-checked') === true);
                if (!isSelected) {
                    var $parent = $(this).closest('.swatchItem-container');
                    $('.swatchItem-label', $parent).hide();
                }
            };

            $swatchItem.on('click', handleSwatchItemClick);
            $swatchItem.on('focus', handleSwatchItemHoverIn);
            $swatchItem.on('focusout', handleSwatchItemHoverOut);
            $swatchItem.hover(handleSwatchItemHoverIn, handleSwatchItemHoverOut);

            // check mouse/touch events
            var checkTouchEvents = function (e) {
                if (e.originalEvent.touches && e.originalEvent.touches.length) {
                    e = e.originalEvent.touches[0];
                } else if (e.originalEvent.changedTouches && e.originalEvent.changedTouches.length) {
                    e = e.originalEvent.changedTouches[0];
                }
            }

            //
            var spinModelsItemClickHandler = function() {
                if ($(this).hasClass('spin-model-selected')) {
                    return;
                } else {
                    $spinModelsItem.removeClass('spin-model-selected');
                    $spinModelsItem.attr('aria-pressed', 'false');
                    $(this).addClass('spin-model-selected');
                    $(this).attr('aria-pressed', 'true');
                }

                //
                $('.color-swatches').css({'opacity': 1});

                //
                var modelView = $(this).attr('data-view');
                var nextTrim = $(this).attr('data-trim');
                modelTrim = nextTrim;

                $colorSwatches.hide();
                $('#' + nextTrim).show();

                var $intSwatchItem = $('#' + modelTrim + ' .color_swatch_interior .color_swatch .swatchItem:first');
                var $extSwatchItem = $('#' + modelTrim + ' .color_swatch_exterior .color_swatch .swatchItem:first');

                if($intSwatchItem && $intSwatchItem.length > 0) {
                    handleSwatchItemClick.call($intSwatchItem);
                }

                if($extSwatchItem && $extSwatchItem.length > 0) {
                    handleSwatchItemClick.call($extSwatchItem);
                }


                $('.swatch-selected-interior').hide();

                if ($('#' + nextTrim).find('.color_swatch_interior').length != 0) {
                    $('.swatch-selected-interior').show();
                } else {
                    $('.swatch-selected-interior').hide();
                }
            };

            if (spinModelsItemSize > 1) {
                $spinModelsItem.on('click', spinModelsItemClickHandler);
            }

            function updateCurrentImgAngleLabels($swatchEl) {
                var $viewAngleLabelEl = $swatchEl && $swatchEl.closest('[data-view-img-angle-aria-labels]');
                var viewImgAngleLabels = null;
                if ($viewAngleLabelEl && $viewAngleLabelEl.length) {
                    viewImgAngleLabels = $viewAngleLabelEl.data('view-img-angle-aria-labels') || null;
                }
                currImgAngleLabels = viewImgAngleLabels || imgAngleAriaLabels;
            }


            //
            $('.spin-models-label:first').addClass('spin-model-selected');
            
            // if we're in a tabbed content section, we need to add a class to that component in order for size calculations to work
            var $hiddenContainer = null;
            if($colorSwatches.hasClass('fgx-in-hideable-section') && !$colorSwatches.is(':visible')) {
                $hiddenContainer = $colorSwatches.data('fgxHiddenContainerEl');

                if($hiddenContainer && typeof($hiddenContainer) !== 'undefined' && $hiddenContainer.length > 0) {
                    $hiddenContainer.addClass('fgx-brand-size-calc');
                }
            }

            $colorSwatches.each(function (index) {

                var totalWidth = 0,
                    isTouch = (winWidth < mobileWidth) ? true : false;

                if (isTouch) {
                    $(this).find('.color_swatch').each(function (index, element) {
                        var $swatchItems = $(element).find('.swatchItem-container');
                        $swatchItems.each(function () {
                            totalWidth += Number($(this).outerWidth(true));
                        });
                    });
                } else {
                    $(this).find('[data-colorizer]').each(function (elm) {
                        totalWidth += Number($(this).outerWidth(true));
                    });
                }

                var colorSwatchesWidth = totalWidth + 90 + 'px';

                $(this).css({
                    'width': colorSwatchesWidth
                });

            });
            
            if($hiddenContainer && $hiddenContainer.hasClass('fgx-brand-size-calc')) {
                $hiddenContainer.removeClass('fgx-brand-size-calc');
            }

            $(window).resize(function () {
                winWidth = $(window).width();
            });

            setupSwatch();
            setupEvents();
            // init on lazy load
            $(document).on('lazybeforeunveil', function (ev) {
                if ($(ev.target).hasClass('colorizer-360')) {
                    setColor(extColor, extColorLabel, assetPath);
                }
            });
            // init if already loaded
            if($('.colorizer-360').is('.lazyloading, .lazyloaded')) {
                setColor(extColor, extColorLabel, assetPath);
            }
        }
    }
})(jQuery, FD.Brand, FD.Brand.Util);

;(function($, brand, media) {

    brand.setInitHandler('[data-fgx-two-column-feature]', init);

    /////////////

    function init(components) {

        var mqlPhone = window.matchMedia('(max-width: 767px)'),
            mqlTablet = window.matchMedia('(max-width: 992px)'),
            mqlDesktop = window.matchMedia('(max-width: 1440px)');

        $(window).resize(function(){
            handleResize();
        });

        //window.FD.Brand.Util.moreLessInit(components, true, 6, 1.15, '.ml-wrapper');
        handleResize();
        
        // Setup a hover state for any 'btn' buttons
        var $cta = $('a.btn.btn-primary, a.btn.btn-secondary, a.btn.btn-secondary-alt', components);
        window.FD.Brand.Util.ctaHover($cta);

        $('.two-Column .two-column-carousel', components).each(function() {
	        FD.Brand.Util.carousel.swipe(this, function(el, dir) {
		        swipe(el, '.two-column-carousel', dir);
	        });
        });

        media.link(components);

        components.each(function() {

            var $moreToggleOne = $(this).find('.col-one .moreDesc');
            var $lessToggleOne = $(this).find('.col-one .lessDesc');
            var $descOne = $(this).find('.col-one .description-more');
            $moreToggleOne.click(function() {
                $descOne.toggle();
                $(this).hide();
                $lessToggleOne.focus();
            });
            $lessToggleOne.click(function() {
                $descOne.toggle();
                $moreToggleOne.show();
                $moreToggleOne.focus();
            });

            var $moreToggleTwo = $(this).find('.col-two .moreDesc');
            var $lessToggleTwo = $(this).find('.col-two .lessDesc');
            var $descTwo = $(this).find('.col-two .description-more');
            $moreToggleTwo.click(function() {
                $descTwo.toggle();
                $(this).hide();
                $lessToggleTwo.focus();
            });
            $lessToggleTwo.click(function() {
                $descTwo.toggle();
                $moreToggleTwo.show();
                $moreToggleTwo.focus();
            });
        });

        function handleResize(){
            $('.two-Column .two-column-carousel', components).each(function() {
                $(this).carousel({interval: false});
            });

            if(mqlPhone.matches){
                if (!$('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).addClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 3, 1.15, '.ml-wrapper');
            }
            else if (mqlTablet.matches) {
                if ($('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).removeClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.two-column-carousel', components).closest('.two-column-feature'));
            }
            else if (mqlDesktop.matches) {
                if ($('.two-column-carousel', components).hasClass("slide")) $('.two-column-carousel', components).removeClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.two-column-carousel', components).closest('.two-column-feature'));
            }
        }
        
        function resetPaginationAriaLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.removeAttr('aria-live');
            pageInfo.removeAttr('aria-atomic');
            pageInfo.text('');
        }
        
        function updatePaginationAriaLabel($carousel, current, total) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, sibling class, direction
        function swipe(elm, sib, dir) {
            // only perform the swipe if the screen is smaller than 768px wide.
            if(mqlPhone.matches){
                $(elm).carousel(dir);
                twoColUpdateIndicators(elm);
                // new metrics
                FD.Brand.Metrics.handler.direct(
                    $(elm).attr('data-fd-metrics-scroll')
                );
            }
        }

        //Update the active toggle indicator
        function twoColUpdateIndicators(elm) {
            var current = $(elm, components).find('.active').index();
            var newIdx = current;
            $(elm, components).siblings('.carousel-indicators').children().each(function() {
                $(this).removeClass('active');
                if(($(this).data('slideTo') * 1) !== current) {
                    $(this).addClass('active');
                    newIdx = $(this).data('slideTo') * 1;
                }
            });
            var $carousel = $(elm).closest('.two-column-feature');
            // if our meatballs are showing we're on mobile, update our pagination aria label
            updatePaginationAriaLabel($carousel, (newIdx + 1), 2);
        }

        // activate a carousel slide when one of the indicators is clicked.
        $('.two-Column .carousel-indicators li', components).click(function() {
            var goToId = parseInt($(this).data("slideTo"), 10);

            if(!$(this).hasClass('active')) {
                // new metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-scroll')
                );
            }

            $(this).parent().siblings('.two-column-carousel').each(function() {
                $(this).carousel(goToId);
            });

            $(this).siblings().removeClass("active");
            $(this).addClass("active");
            var $carousel = $(this).closest('.two-column-feature');
            // if our meatballs are showing we're on mobile, update our pagination aria label
            updatePaginationAriaLabel($carousel, (goToId + 1), 2);
        });
    }
})(jQuery, FD.Brand, FD.Brand.MediaOverlay);

;(function($, brand, media) {

    brand.setInitHandler('[data-fgx-three-column-feature]', init);

    /////////////

    function init(components) {

        var mqlPhone = window.matchMedia('(max-width: 767px)'),
            mqlTablet = window.matchMedia('(max-width: 992px)'),
            mqlDesktop = window.matchMedia('(max-width: 1440px)');

        $(window).resize(function(){
            handleResize();
        });

        //window.FD.Brand.Util.addMoreLink(components, 125);
        //window.FD.Brand.Util.moreLessInit(components, true, 6, 1.15, '.ml-wrapper');
        handleResize();
        
        // Setup a hover state for any 'btn' buttons
        var $cta = $('a.btn.btn-primary, a.btn.btn-secondary, a.btn.btn-secondary-alt', components);
        window.FD.Brand.Util.ctaHover($cta);

        $('.three-Column .three-column-carousel', components).each(function() {
	        FD.Brand.Util.carousel.swipe(this, swipe);
        });

        media.link(components);

        components.each(function() {

            var $moreToggleOne = $(this).find('.col-one .moreDesc');
            var $lessToggleOne = $(this).find('.col-one .lessDesc');
            var $descOne = $(this).find('.col-one .description-more');
            $moreToggleOne.click(function() {
                $descOne.toggle();
                $(this).hide();
                $lessToggleOne.focus();
            });
            $lessToggleOne.click(function() {
                $descOne.toggle();
                $moreToggleOne.show();
                $moreToggleOne.focus();
            });

            var $moreToggleTwo = $(this).find('.col-two .moreDesc');
            var $lessToggleTwo = $(this).find('.col-two .lessDesc');
            var $descTwo = $(this).find('.col-two .description-more');
            $moreToggleTwo.click(function() {
                $descTwo.toggle();
                $(this).hide();
                $lessToggleTwo.focus();
            });
            $lessToggleTwo.click(function() {
                $descTwo.toggle();
                $moreToggleTwo.show();
                $moreToggleTwo.focus();
            });

            var $moreToggleThree = $(this).find('.col-three .moreDesc');
            var $lessToggleThree = $(this).find('.col-three .lessDesc');
            var $descThree = $(this).find('.col-three .description-more');
            $moreToggleThree.click(function() {
                $descThree.toggle();
                $(this).hide();
                $lessToggleThree.focus();
            });
            $lessToggleThree.click(function() {
                $descThree.toggle();
                $moreToggleThree.show();
                $moreToggleThree.focus();
            });
        });

        function handleResize(){
            $('.three-column-carousel', components).each(function() {
                $(this).carousel({interval: false});
            });

            if(mqlPhone.matches){
                if (!$('.three-column-carousel', components).hasClass("slide")) $('.three-column-carousel', components).addClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 3, 1.15, '.ml-wrapper');
            }
            else if (mqlTablet.matches) {
                if ($('.three-column-carousel', components).hasClass("slide")) $('.three-column-carousel', components).removeClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.three-column-carousel', components));
            }
            else if (mqlDesktop.matches) {
                if ($('.three-column-carousel', components).hasClass("slide")) $('.three-column-carousel', components).removeClass("slide");
                //window.FD.Brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
                // pagination aria label needs to be removed and marked as hidden
                resetPaginationAriaLabel($('.three-column-carousel', components));
            }
        }
        
        function resetPaginationAriaLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.removeAttr('aria-live');
            pageInfo.removeAttr('aria-atomic');
            pageInfo.text('');
        }
        
        function updatePaginationAriaLabel($carousel, current, total) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }

        function updateAriaCurrent($carousel) {
            $carousel.find('.carousel-indicators li').each(function() {
                var $el = $(this);
                $el.find('.fgx-btn').attr('aria-current', ($el.hasClass('active') ? 'true' : 'false'));
            });
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, direction
        function swipe(elm, dir, ev) {
            // only perform the swipe if the screen is smaller than 768px wide.
            if(mqlPhone.matches){
                $(elm).carousel(dir);
                // new metrics
                FD.Brand.Metrics.handler.direct(
                    $(elm).attr('data-fd-metrics-scroll')
                );
                // we're on mobile, update our pagination aria label
                var activeIdx = parseInt($(elm).find('.carousel-indicators li.active').data("slideTo"));
                updatePaginationAriaLabel($(elm), (activeIdx + 1), 3);
                updateAriaCurrent($(elm));
            }
        }

        //Slide the carousel when the indicators are clicked
        $('.three-Column .carousel-indicators li', components).click(function() {
            var goToId = $(this).data("slideTo");

            if(!$(this).hasClass('active')) {
                // new metrics
                FD.Brand.Metrics.handler.direct(
                        $(this).attr('data-fd-metrics-scroll')
                );
            }
            var $carousel = $(this).parent().parent('.three-column-carousel');
            $carousel.carousel(goToId);
            // if our meatballs are showing we're on mobile, update our pagination aria label
            updatePaginationAriaLabel($carousel, (goToId + 1), 3);
            updateAriaCurrent($carousel);
        });
    }
})(jQuery, FD.Brand, FD.Brand.MediaOverlay);

;(function(win, $, _, brand, util) {

    var $window,
        _onResize_d,
        _tabScrollConfig = {
            'activeSlide': 0,
            'leftPosition': 0,
            'totalTabs': 1,
            settings: {
                'gux-bkpt-xs': {
                    tabWidthRatio: .75,
                    tabsDisplayed: 1,
                    scrollWidthRatio: .75,
                    totalSlides: 1,
                    scrollable: false
                },
                'gux-bkpt-sm': {
                    tabWidthRatio: .75,
                    tabsDisplayed: 1,
                    scrollWidthRatio: .75,
                    totalSlides: 1,
                    scrollable: false
                },
                'gux-bkpt-med': {
                    tabWidthRatio: .4,
                    tabsDisplayed: 2,
                    scrollWidthRatio: .8,
                    totalSlides: 1,
                    scrollable: false
                },
                'gux-bkpt-lg': {
                    tabWidthRatio: .23,
                    tabsDisplayed: 4,
                    scrollWidthRatio: .92,
                    totalSlides: 1,
                    scrollable: false
                },
                'gux-bkpt-xlg': {
                    tabWidthRatio: .23,
                    tabsDisplayed: 4,
                    scrollWidthRatio: .92,
                    totalSlides: 1,
                    scrollable: false
                }
            }
        },
        activeAnchor = null,
        _intervalRefs = {},
        _playPauseControlClasses = ['fgx-play-pause-icon-hidden', 'fgx-play-pause-icon-shown'];

    brand.setInitHandler('[data-fgx-tabbed-bar-feature]', init);

    /////////////

    function init(components) {
        // Variables
        $window = $(win);
        _onResize_d = _.debounce(_onResize, 50);

        components.each(function(compIdx) {
            var $el = $(this),
                $tabContainer = $el.find('.tab-container'),
                isContentTabs = $tabContainer.hasClass('content-tabs'),
                totalTabs = $el.data('totalTabs'),
                compBaseId = 'brand-tbf-' + compIdx + '-',
                mobileSlideNum = totalTabs,
                tabletSlideNum = desktopSlideNum = 1,
                mobileScroll = tabletScroll = desktopScroll = false,
                tabScrollConfig = JSON.parse(JSON.stringify(_tabScrollConfig)),
                $tabContentContainer = $el.find('.tab-section-container'),
                tabletLastSlideOffset = desktopLastSlideOffset = 0;
            switch(totalTabs) {
                case 0:
                case 1:
                    break;
                case 2:
                    $el.addClass('tab-scroll-mobile');
                    mobileScroll = true;
                    break;
                case 3:
                case 4:
                    $el.addClass('tab-scroll-mobile tab-scroll-tablet');
                    $tabContainer.find('.carousel-arrows').addClass('shown');
                    tabletSlideNum = 2;
                    tabletLastSlideOffset = (totalTabs % 2);
                    mobileScroll = true;
                    tabletScroll = true;
                    break;
                default:
                    $el.addClass('tab-scroll-mobile tab-scroll-tablet tab-scroll-dsk');
                    $tabContainer.find('.carousel-arrows').addClass('shown');
                    tabletSlideNum = Math.ceil(totalTabs/2);
                    desktopSlideNum = Math.ceil(totalTabs/4);
                    tabletLastSlideOffset = (totalTabs % 2);
                    desktopLastSlideOffset = (totalTabs % 4);
                    mobileScroll = true;
                    tabletScroll = true;
                    desktopScroll = true;
                    break;
            }

            tabScrollConfig.totalTabs = totalTabs;

            var updateSettings = function(key, mVal, tVal, dVal) {
                tabScrollConfig.settings['gux-bkpt-xs'][key] = mVal;
                tabScrollConfig.settings['gux-bkpt-sm'][key] = mVal;
                tabScrollConfig.settings['gux-bkpt-med'][key] = tVal;
                tabScrollConfig.settings['gux-bkpt-lg'][key] = dVal;
                tabScrollConfig.settings['gux-bkpt-xlg'][key] = dVal;
            }

            updateSettings('totalSlides', mobileSlideNum, tabletSlideNum, desktopSlideNum);
            updateSettings('lastSlideOffset', 0, tabletLastSlideOffset, desktopLastSlideOffset);
            updateSettings('scrollable', mobileScroll, tabletScroll, desktopScroll);

            $tabContainer.data('tabScrollConfig', tabScrollConfig);

            $tabContainer.find('.tab-item').each(function(idx) {
                var slideGroups = {
                        'gux-bkpt-xs': idx,
                        'gux-bkpt-sm': idx,
                        'gux-bkpt-med': Math.floor(idx/2),
                        'gux-bkpt-lg': Math.floor(idx/4),
                        'gux-bkpt-xlg': Math.floor(idx/4)
                    },
                    $tab = $(this),
                    $tabLink = $tab.find('.tab-item-link'),
                    tabBaseId = compBaseId + ($tabLink.attr('data-fgx-anchor-id') || '') + '-tab',
                    mtxData = {
                        '$$activeTabName': $tabLink.find('.tab-label').text() || ''
                    };
                $tab.data('slideGroups', slideGroups);

                $tabLink.attr({
                    'data-fd-metrics-data': JSON.stringify(mtxData),
                    'id': tabBaseId,
                    'aria-controls': tabBaseId + '-content'
                });

                if(idx === 0) {
                    $tab.addClass('active-tab visible-tab');
                }
            });

            var $firstContentSlide = $tabContentContainer.find('.tab-content-section.item').first();
            $firstContentSlide.addClass('active');
            $tabContentContainer.find('.current-slide-num').html('1');
            $tabContentContainer.find('.tab-content-section.item').each(function(idx) {
                var $el = $(this),
                    prevIdx = (((idx === 0) ? totalTabs : idx) - 1),
                    tabBaseId = compBaseId + ($el.attr('data-fgx-anchor-id') || '') + '-tab';
                $el.attr({
                    'data-prev-slide': prevIdx,
                    'id': tabBaseId + '-content',
                    'aria-labelledby': tabBaseId
                });
            });

            var playPauseIconDisplay = $firstContentSlide.data('fgxPlayPauseIconDisplay');
            updatePlayPauseControlDisplay($el, playPauseIconDisplay);

            $tabContentContainer.carousel({interval: false});
            $tabContentContainer.on('slid.bs.carousel', function(ev) {
                $tabContentContainer.data('isSliding', false);

                // NZ: Layering Bootstrap Carousels within one another is not supported OOTB, so we need to check
                // for bootstrap carousels within the active slide, and set the 'active' class on their first item
                // and the first carousel indicator. This will allow them to display properly.
                var $activeSlide = $tabContentContainer.find('.tab-content-section.item.active'),
                    $bsCarousels = $activeSlide.find('[data-fgx-bootstrap-carousel-container]');

                var eventData = {
                    slideContainer: $tabContentContainer,
                    activeSlide: $activeSlide
                };
                $('body').trigger('fgxTabbedBarFeatureTabChangeEnd', [eventData]);

                if($bsCarousels && $bsCarousels.length > 0) {
                    $bsCarousels.each(function() {
                        var $activeItem = $(this).find('.carousel-inner .item.active');
                        if(!$activeItem || ($activeItem && $activeItem.length == 0)) {
                            $(this).find('.carousel-inner').each(function() {
                                $(this).find('.item').first().addClass('active');
                            });
                            $(this).find('.carousel-indicators').children().first().addClass('active');
                        }
                    });
                }
            });

            // Setup swipe listeners for the tabContainer and the tabContentContainer
            FD.Brand.Util.carousel.swipe($tabContainer[0], tabSwipe);
            FD.Brand.Util.carousel.swipe($tabContentContainer[0], contentSwipe);

            var $globalArrows = $tabContainer.find('.global-arrows');
            if($el.hasClass('fgx-auto-play-enabled') && $globalArrows && $globalArrows.length > 0) {
                var delay = parseInt($el.data("fgxInterval"), 10) || 7000;
                var initialize = ($el.hasClass('auto-advance-immediate'));
                var interval = null;
                var intervalRefId = "interval" + compIdx;

                if (initialize) {
                    interval = setInterval(function() {
                        handleInterval($el);
                    }, delay);
                }

                $el.data("intervalRefId", intervalRefId);

                _intervalRefs[intervalRefId] = {
                    'setInterval': interval,
                    'delay': delay,
                    'container': $el,
                    'initialized': initialize
                };

            }
        });


        // Click Actions
        $('.content-tabs .tab-item-link', components).on('click', function() {
            var $tabItemsWrap = $(this).closest('.tab-items-wrap');
            // Temporarily remove the focusout listener when a new tab is selected to prevent the updateScrollPosition logic from being run twice.
            $tabItemsWrap.off('focusout', handleFocusOut);
            initializeInterval($(this));
            selectTab.call(this);
            $(this).closest('.tabbed-bar-feature').find('.tab-section-container').focus();
            // Reinstate the focusout listener after the focus has been shifted.
            $tabItemsWrap.on('focusout', handleFocusOut);
        });

        // Arrow Clicks
        $('.tab-container.content-tabs .carousel-arrows .carousel-btn', components).on('click', function() {
            var $arrow = $(this),
                tabContainer = $arrow.closest('.tab-container'),
                dir = ($arrow.hasClass('carousel-previous')) ? 'prev' : 'next';

            initializeInterval(tabContainer);
            startTabSlide(tabContainer, dir);
        });

        $('.tab-section-container .arrow-container .container-arrow', components).on('click', function() {
            var $arrow = $(this),
                $tabSectionContainer = $arrow.closest('.tab-section-container'),
                slide = $tabSectionContainer.find(".tab-content-section.item.active"),
                dir = ($arrow.hasClass('carousel-previous')) ? 'prev' : 'next',
                nextId = slide.data(dir+"Slide");

            initializeInterval($tabSectionContainer);
            startContentSlide($tabSectionContainer, dir, nextId);
        });

        // Check to see if the values around the visible tab need to be updated after focus leaves the tab-items-wrap element.
        $('.tab-items-wrap', components).on('focusout', handleFocusOut);

        $('.tab-item', components).on('focusin', function() {
            var $el = $(this),
                $tabWrap = $el.closest('.tab-wrap'),
                $tabContainer = $tabWrap.closest('.tab-container');
            if (!$tabContainer.hasClass('tbf-calc-in-progress')) {
                var bp = util.currentBreakpointXS(),
                    config = $tabContainer.data('tabScrollConfig'),
                    settings = config && config.settings && config.settings[bp] || {};
                if (settings.scrollable && isTabPeaking($el, $tabWrap)) {
                    $el.addClass('last-focused');
                    // Set force update to true if the peaking tab has the visible-tab class to ensure the scroll is properly updated in that case.
                    var forceUpdate = ($el.hasClass('visible-tab'));
                    updateScrollPosition($tabContainer, '.last-focused', forceUpdate, true, 300);
                    $el.removeClass('last-focused');
                }
            }
        });

        // Video play/pause icon click
        $('.tab-section-container .arrow-container', components).on('click', '.icon-vid-play-pause', function() {
            var $icon = $(this),
                $tabSectionContainer = $icon.closest('.tab-section-container'),
                $tabbedBarFeature = $tabSectionContainer.closest('.tabbed-bar-feature'),
                intervalRefId = $tabbedBarFeature.data('intervalRefId') || '',
                $activeSlide = $tabSectionContainer.find('.carousel-inner > .tab-content-section.item.active'),
                eventData = {
                    activeSlide: $activeSlide,
                    slideContainer: $tabSectionContainer,
                    componentContext: $tabbedBarFeature
                };

            initializeInterval($tabbedBarFeature);
            stopInterval(intervalRefId);

            if($tabbedBarFeature.hasClass('child-inline-video-playing')) {
                //video is currently playing, so we need to pause the video.
                $('body').trigger('fgxTabbedBarFeaturePauseVideo', [eventData]);
                $tabbedBarFeature.removeClass('child-inline-video-playing');
            } else {
                //video is currently paused, so we need to start the video.
                $('body').trigger('fgxTabbedBarFeaturePlayVideo', [eventData]);
                $tabbedBarFeature.addClass('child-inline-video-playing');
            }
        });

        $('body')
            .on('fgxInlineVideoPause', function(ev, data) {
                inlineVideoStatusUpdate(data, 'pause');
            })
            .on('fgxInlineVideoPlay', function(ev, data) {
                inlineVideoStatusUpdate(data, 'play');
            })
            .on('fgxInlineVideoEnded', function(ev, data) {
                if(data && data.videoElement && data.videoElement.length > 0) {
                    var $slide = data.videoElement.closest('.tab-content-section.item');
                    if($slide && $slide.length > 0) {
                        var $tabbedBarFeature = $slide.closest('.tabbed-bar-feature'),
                            intervalRefId = $tabbedBarFeature.data('intervalRefId') || '',
                            $globalArrows = $tabbedBarFeature.find('.tab-container .global-arrows');

                        stopInterval(intervalRefId);

                        if($tabbedBarFeature.hasClass('fgx-auto-play-enabled') && $globalArrows && $globalArrows.length > 0) {
                            if(intervalRefId && _intervalRefs[intervalRefId] && _intervalRefs[intervalRefId].initialized) {
                                handleInterval($tabbedBarFeature);
                            }
                        }
                    }
                }
            });

        // Initialization Setup
        $window.resize(_onResize_d);

        // monitor hash changes
        if(win.addEventListener) {
            win.addEventListener('hashchange', anchorCheck);
        } else {
            // IE8 fallback
            win.onhashchange = anchorCheck;
        }
        anchorCheck();

        // Functions
        function startTabSlide(tabContainer, dir) {
            if(!tabContainer || tabContainer.length == 0) {
                return;
            }
            tabContainer.toggleClass('tbf-calc-in-progress', true);

            var $tabWrap = tabContainer.find('.tab-wrap'),
                tabWrapWidth = $tabWrap.width(),
                bp = util.currentBreakpointXS(),
                config = tabContainer.data('tabScrollConfig') || _tabScrollConfig,
                settings = config.settings[bp],
                slideComplete = function() {
                    tabContainer.toggleClass('tbf-calc-in-progress', false);
                };

            if((dir == 'next' && (config.activeSlide < (settings.totalSlides - 1))) || (dir == 'prev' && config.activeSlide > 0)) {
                var $tabbedBarFeature = tabContainer.closest('.tabbed-bar-feature'),
                    autoPlayEnabled = ($tabbedBarFeature.hasClass('fgx-auto-play-enabled')),
                    intervalRefId = '',
                    unevenOffset = (config.totalTabs % settings.tabsDisplayed !== 0),
                    currentTabIdx = config.activeSlide * settings.tabsDisplayed,
                    indexOffset = unevenOffset ? 0 : (config.totalTabs - currentTabIdx) % settings.tabsDisplayed,
                    slideOffset,
                    nextIdx,
                    useFullWidthRatio = false;


                if (autoPlayEnabled) {
                    intervalRefId = $tabbedBarFeature.data('intervalRefId');
                    stopInterval(intervalRefId);
                }

                if(dir === 'next') {
                    slideOffset = (indexOffset === 0) ? settings.tabsDisplayed : indexOffset;
                    nextIdx = currentTabIdx + slideOffset;
                    useFullWidthRatio = ((config.activeSlide + 1) == (settings.totalSlides - 1));
                } else {
                    slideOffset = (indexOffset === 0) ? settings.tabsDisplayed : (settings.tabsDisplayed - indexOffset);
                    nextIdx = currentTabIdx - slideOffset;
                }

                var targetLeft = Math.floor(findLeft(nextIdx, config, settings, tabWrapWidth, useFullWidthRatio)),
                    $tabItemsWrap = $tabWrap.find('.tab-items-wrap'),
                    currentPos = config.leftPosition,
                    newPos = targetLeft,
                    mtxAction = tabContainer.data('tabCarouselScrollAction');

                $tabWrap.animate({scrollLeft: newPos}, 600, slideComplete);
                config.leftPosition = newPos;
                config.activeSlide = (dir == 'prev') ? config.activeSlide - 1 : config.activeSlide + 1;
                tabContainer.data('tabScrollConfig', config);

                var displayedTabIndex = config.activeSlide * settings.tabsDisplayed;
                updateVisibleTab($tabItemsWrap, displayedTabIndex);

                var $activeTabName = $tabItemsWrap.find('.active-tab .tab-label');

                //Metrics
                if(mtxAction && typeof(mtxAction) != 'undefined') {
                    //activeTabName
                    brand.Metrics.handler.direct(mtxAction, {
                        $$carouselScrollDirection: (dir == 'prev') ? 'left' : 'right',
                        $$activeTabName: $activeTabName.text() || ''
                    });
                }

                if (autoPlayEnabled) {
                    resetInterval(intervalRefId);
                }
            } else {
                slideComplete();
            }
        }

        function findLeft(idx, config, settings, tabWrapWidth, fullWidthRatio) {
            var slideOffset = 0,
                tabWidthRatio = settings.tabWidthRatio,
                tabWidth = tabWidthRatio * tabWrapWidth,
                fullWidthOffset = 0;
            if (idx + settings.tabsDisplayed > config.totalTabs) {
                slideOffset = ((idx + settings.tabsDisplayed) - config.totalTabs) * tabWidth;
            }
            if(fullWidthRatio) {
                // Account for the right-margin of the items when calculating the additional offset.
                // Without doing this, the last item will be cut off at the end and wont be fully displayed.
                var marginOffset = 3 * (config.totalTabs - 1);
                fullWidthOffset = tabWrapWidth - (settings.tabsDisplayed * tabWidth) - marginOffset;
                slideOffset += fullWidthOffset;
            }

            var targetLeft = ((idx * tabWidth)) - slideOffset;
            return targetLeft;
        }

        function startContentSlide(elm, dir, nextId) {
            var isSliding = $(elm).data('isSliding');
            if(!isSliding || isSliding === 'false') {
                $(elm).data('isSliding', true);

                var $tabbedBarFeature = $(elm).closest('.tabbed-bar-feature'),
                    autoPlayEnabled = ($tabbedBarFeature.hasClass('fgx-auto-play-enabled')),
                    intervalRefId = '';

                if (autoPlayEnabled) {
                    intervalRefId = $tabbedBarFeature.data('intervalRefId');
                    stopInterval(intervalRefId);
                }

                try {
                    var nextSlide = $(elm).find('.tab-content-section.item[data-tab-index="'+nextId+'"]');
                    $(elm).data('bs.carousel').slide(dir, nextSlide);
                    // update aria pagination info alert
                    updateContentPaginationLabel($(elm), nextId);
                } catch(e) {
                    //If there is a problem calling the slide function directly then just use the id to be safe.
                    $(elm).carousel(nextId);
                }
                $(elm).find('.current-slide-num').html((nextId + 1));

                if (autoPlayEnabled) {
                    resetInterval(intervalRefId);
                }

                var $tabContainer = $(elm).siblings('.tab-container');
                updateActiveTab($tabContainer, nextId);

                //Metrics
                var mtxAction = $(elm).data('contentCarouselScrollAction');
                if(mtxAction && typeof(mtxAction) != 'undefined') {
                    brand.Metrics.handler.direct(mtxAction);
                }
            }
        }

        function updateActiveTab($tabContainer, nextId) {
            if(!$tabContainer || $tabContainer.length == 0) {
                return;
            }

            $tabContainer
                .find('.active-tab')
                .removeClass('active-tab')
                .find('.tab-item-link')
                .attr('aria-selected', 'false');

            var $newActiveTab = $tabContainer.find('.tab-item[data-tab-index="'+nextId+'"]'),
                playPauseIconDisplay = $newActiveTab.data('fgxPlayPauseIconDisplay'),
                $newActiveTabLink = $newActiveTab.find('.tab-item-link'),
                $tabbedBarFeature = $tabContainer.closest('.tabbed-bar-feature'),
                $tabSectionContainer = $tabbedBarFeature.find('.tab-section-container'),
                $newActiveSlide = $tabSectionContainer.find('.carousel-inner > .tab-content-section.item[data-tab-index="'+nextId+'"]'),
                eventData = {
                    slideContainer: $tabSectionContainer,
                    activeSlide: $newActiveSlide
                };
            $newActiveTab.addClass('active-tab');
            $newActiveTabLink.attr('aria-selected', 'true');
            $tabSectionContainer.find('.carousel-inner > .tab-content-section[tabindex="0"]').attr('tabindex', '-1');
            $newActiveSlide.attr('tabindex', '0');

            $('body').trigger('fgxTabbedBarFeatureTabChange', [eventData]);

            updatePlayPauseControlDisplay($tabbedBarFeature, playPauseIconDisplay);

            updateScrollPosition($tabContainer, '.active-tab', false, true);

            var anchorId = $newActiveTabLink.data('fgxAnchorId');
            if(anchorId) {
                updateHash(anchorId);
            }
        }

        function updateVisibleTab($tabItemsWrap, displayedTabIndex) {
            if(!$tabItemsWrap || $tabItemsWrap.length == 0) {
                return;
            }
            $tabItemsWrap.find('.visible-tab').removeClass('visible-tab');
            $tabItemsWrap.find('.tab-item').each(function(idx) {
                if(idx == displayedTabIndex) {
                    $(this).addClass('visible-tab');
                }
            });
        }

        function updateScrollPosition($tabContainer, tabSelector, forceUpdate, adjustVisibleTab, animDuration) {
            if(!$tabContainer || $tabContainer.length == 0) {
                return;
            }
            $tabContainer.toggleClass('tbf-calc-in-progress', true);

            var bp = util.currentBreakpointXS(),
                config = $tabContainer.data('tabScrollConfig'),
                settings = config.settings[bp],
                $tab = $tabContainer.find(tabSelector),
                newActiveSlide = $tab.data('slideGroups')[bp],
                tabWrapWidth = $tabContainer.find('.tab-wrap').width(),
                scrollAmount = (settings.scrollWidthRatio * tabWrapWidth * newActiveSlide),
                $tabItemsWrap = $tabContainer.find('.tab-items-wrap'),
                duration = animDuration || 600,
                slideComplete = function() {
                    $tabContainer.toggleClass('tbf-calc-in-progress', false);
                };

            if((config.activeSlide != newActiveSlide) || forceUpdate) {
                if(((newActiveSlide + 1) == settings.totalSlides) && ((config.activeSlide != newActiveSlide) || settings.scrollable) && settings.totalSlides != 1) {
                    var tabWidthRatio = settings.tabWidthRatio,
                        tabWidth = tabWidthRatio * tabWrapWidth,
                        idx = $tab.data('tabIndex'),
                        slideOffset = (settings.lastSlideOffset !== 0) ? ((settings.tabsDisplayed - settings.lastSlideOffset) * tabWidth) : 0,
                        marginOffset = 3 * (config.totalTabs - 1),
                        fullWidthOffset = tabWrapWidth - (settings.tabsDisplayed * tabWidth) - marginOffset;

                    slideOffset += fullWidthOffset;

                    if ((tabSelector === '.active-tab' || tabSelector === '.last-focused') && (idx === config.totalTabs - 1) && (idx !== (newActiveSlide * settings.tabsDisplayed))) {
                        // BRAND-15068 - Update the index of the tab used for calculating the positioning when going backwards
                        // to the last tab from the first tab. This change in index will allow the left position value to
                        // be calculated properly so the last set of tabs will fill the remaining space (instead of having a gap).
                        idx = newActiveSlide * settings.tabsDisplayed;
                    }

                    scrollAmount = (idx * tabWidth) - slideOffset;
                }

                $tabContainer.find('.tab-wrap').animate({scrollLeft: scrollAmount}, duration, slideComplete);
                config.leftPosition = scrollAmount;
                config.activeSlide = newActiveSlide;
                $tabContainer.data('tabScrollConfig', config);

                if(adjustVisibleTab) {
                    var displayedTabIndex = config.activeSlide * settings.tabsDisplayed;
                    updateVisibleTab($tabItemsWrap, displayedTabIndex);
                }

            } else {
                slideComplete();
            }
        }

        function canSwipe(elm, section) {
            var $elm = $(elm);
            if(!$elm || $elm.length == 0) {
                return;
            }

            var bp = util.currentBreakpointXS(),
                $tabbedBarFeature = $elm.closest('.tabbed-bar-feature'),
                swipeEnabled = false;

            // For the tablet and desktop breakpoints below, since the content section only displays one tab at a time
            // on all breakpoints, if we can scroll on mobile, we can scroll on any breakpoint. However, we still need
            // to check for the tab-scroll-tablet or tab-scroll-dsk classes if we're scrolling the tabs section since
            // multiple tabs can be displayed at once for those breakpoints.
            switch(bp) {
                case 'gux-bkpt-xs':
                case 'gux-bkpt-sm':
                    swipeEnabled = ($tabbedBarFeature.hasClass('tab-scroll-mobile'));
                    break;
                case 'gux-bkpt-med':
                    if(brand.Util.env.touch()) {
                        swipeEnabled = (section == 'tab') ? ($tabbedBarFeature.hasClass('tab-scroll-tablet')) : ($tabbedBarFeature.hasClass('tab-scroll-mobile'));
                    }
                    break;
                case 'gux-bkpt-lg':
                case 'gux-bkpt-xlg':
                    if(brand.Util.env.touch()) {
                        swipeEnabled = (section == 'tab') ? ($tabbedBarFeature.hasClass('tab-scroll-dsk')) : ($tabbedBarFeature.hasClass('tab-scroll-mobile'));
                    }
                    break;
            }
            return swipeEnabled;
        }

        function tabSwipe(elm, dir, ev) {
            if(canSwipe(elm, 'tab')) {
                var tabContainer = $(elm);

                initializeInterval(tabContainer);
                startTabSlide(tabContainer, dir);
            }
        }

        function contentSwipe(elm, dir, ev) {
            if(canSwipe(elm, 'content')) {
                if(ev && typeof(ev) != 'undefined') {
                    var $target = $(ev.target),
                        $flexColumn = $target.closest('.fcf-wrapper');
                    if($flexColumn && $flexColumn.length > 0 && $flexColumn.hasClass('wrap-carousel')) {
                        return;
                    }
                }
                var $tabSectionContainer = $(elm),
                    slide = $tabSectionContainer.find(".tab-content-section.item.active"),
                    nextId = slide.data(dir+"Slide");

                initializeInterval($tabSectionContainer);
                startContentSlide($tabSectionContainer, dir, nextId);
            }
        }

        function anchorCheck() {
            var anchorId = win.location.hash;
            var toggle = null;
            if (anchorId) {
                var anchor = anchorId.substr(1);
                // process hash
                if(activeAnchor === anchor) {
                    return;
                }
                var dataAttr = '.tab-item-link[data-fgx-anchor-id="'+anchor+'"]';
                toggle = $(dataAttr, components);
            }

            if(toggle && toggle.length > 0) {
                // NZ: It shouldn't be the case that the same anchor id is used more than once on a page, but in the event
                // that it is, the following logic will allow each tab to be selected within its instance of the component,
                // but the page will only use the first instance to determine the vertical scroll offset.
                var $toggle = (toggle.length > 1) ? $(toggle[0]) : toggle;
                toggle.each(function() {
                    selectTab.call($(this));
                });

                var $tabbedBarFeature = $toggle.closest('.tabbed-bar-feature'),
                    $stickyNav = $('.navbar-static-top'),
                    topOffset = $tabbedBarFeature.offset().top,
                    scrollTo = ($stickyNav.length) ? topOffset - $stickyNav.height() : topOffset;

                $('html').animate({scrollTop:scrollTo}, 0);
            }
        }

        function selectTab() {
            var $tabItem = $(this).closest('.tab-item'),
                nextId = $tabItem.data('tabIndex'),
                $tabContainer = $tabItem.closest('.tab-container'),
                $tabbedBarFeature = $tabContainer.closest('.tabbed-bar-feature'),
                $tabSectionContainer = $tabbedBarFeature.find('.tab-section-container'),
                nextSlide = $tabSectionContainer.find('.tab-content-section.item[data-tab-index="'+nextId+'"]'),
                autoPlayEnabled = ($tabbedBarFeature.hasClass('fgx-auto-play-enabled')),
                intervalRefId = '';

            if (autoPlayEnabled) {
                intervalRefId = $tabbedBarFeature.data('intervalRefId');
                stopInterval(intervalRefId);
            }

            $tabSectionContainer.carousel(nextId);
            $tabSectionContainer.find('.current-slide-num').html((nextId + 1));

            if (autoPlayEnabled) {
                resetInterval(intervalRefId);
            }

            updateActiveTab($tabContainer, nextId);
        }

        function updateHash(id) {
            if(id && ((activeAnchor && (id !== activeAnchor)) || !activeAnchor)) {
                win.location.hash = id;
                activeAnchor = id;
            }
        }

        function updatePaginationLabel($carousel, pageInfoSelector, current, total) {
            if(!$carousel || $carousel.length == 0) {
                return;
            }
            var pageInfo = $carousel.find(pageInfoSelector),
                pageInfoTemplate = pageInfo.data('labelTemplate');
            pageInfo.attr('aria-hidden', 'false');
            pageInfo.attr('aria-live', 'polite');
            pageInfo.attr('aria-atomic', 'true');
            if(pageInfoTemplate) {
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total));
            }
        }

        function updateContentPaginationLabel($carousel, nextId) {
            var total = $carousel.closest('.tabbed-bar-feature').data('totalTabs');
            updatePaginationLabel($carousel, '.content-pagination-info', (nextId + 1), total);
        }

        /*
         * Update the stored data related to scroll position if the scrollLeft position has changed from the last stored
         * position when the tab items wrap element loses focus. This is needed to keep the scroll position data stored
         * within the component synced up with the visible position because they can get out of sync if a user uses the
         * tab key to navigate through the tabs without activating any of them.
         */
        function handleFocusOut(ev) {
            var _wrap = this,
                $target = $(ev.target),
                $tabContainer = $(_wrap).closest('.tab-container');
            if (!$tabContainer.hasClass('tbf-calc-in-progress')) {
                // setTimeout of 0 is needed because nothing has focus during 'focusout'
                setTimeout(function () {
                    if (!$.contains(_wrap, document.activeElement)) {
                        var $tabWrap = $(_wrap).closest('.tab-wrap'),
                            config = $tabContainer.data('tabScrollConfig') || _tabScrollConfig,
                            lastOffset = Math.floor(config.leftPosition),
                            currOffset = Math.floor($tabWrap.scrollLeft());

                        if (lastOffset !== currOffset) {
                            var $tab = $target.closest('.tab-item').addClass('last-focused');
                            updateScrollPosition($tabContainer, '.last-focused', false, true);
                            $tab.removeClass('last-focused');
                        }
                    }
                }, 0);
            }
        }


        function isTabPeaking($tab, $wrapper) {
            if ((!$tab || $tab.length === 0) || (!$wrapper || $wrapper.length === 0)) {
                return false;
            }
            var tabBox = $tab[0].getBoundingClientRect(),
                wrapBox = $wrapper[0].getBoundingClientRect(),
                tabL = Math.floor(tabBox.left),
                tabR = Math.floor(tabBox.right),
                wrapL = Math.floor(wrapBox.left),
                wrapR = Math.floor(wrapBox.right);
            return (((tabR > wrapR) && (tabL < wrapR)) || ((tabL < wrapL) && (tabR > wrapL))) || false;
        }

        function handleInterval($el) {
            if(!$el || $el.length == 0) {
                return;
            }

            var $tabSectionContainer = $el.find('.tab-section-container'),
                slide = $tabSectionContainer.find('.tab-content-section.item.active'),
                autoAdvanceId = slide.data('fgxAutoAdvanceTo'),
                nextId;

            if(autoAdvanceId && typeof(autoAdvanceId) != 'undefined') {
                var nextSlide = $tabSectionContainer.find('.tab-content-section.item[data-fgx-anchor-id="' + autoAdvanceId + '"]');
                nextId = nextSlide.data('tabIndex');
            } else {
                nextId = slide.data('nextSlide');
            }

            startContentSlide($tabSectionContainer, 'next', nextId);
        }

        function stopInterval(id) {
            if(id && _intervalRefs[id]) {
                var currentInterval = _intervalRefs[id].setInterval;
                if(currentInterval) {
                    clearInterval(currentInterval);
                }
                _intervalRefs[id].setInterval = null;
            }
        }

        function resetInterval(id) {
            if(id && _intervalRefs[id]) {
                stopInterval(id);
                if(_intervalRefs[id].initialized) {
                    var interval = setInterval(function() {
                        handleInterval(_intervalRefs[id].container);
                    }, _intervalRefs[id].delay);
                    _intervalRefs[id].setInterval = interval;
                }
            }
        }

        function initializeInterval($el) {
            if(!$el || $el.length == 0) {
                return;
            }

            var $tabbedBarFeature = $el.closest('.tabbed-bar-feature'),
                autoPlayEnabled = ($tabbedBarFeature.hasClass('fgx-auto-play-enabled')),
                intervalRefId = '';

            if (autoPlayEnabled) {
                intervalRefId = $tabbedBarFeature.data('intervalRefId');

                if(intervalRefId && intervalRefId != '' && _intervalRefs[intervalRefId]) {
                    _intervalRefs[intervalRefId].initialized = true;
                }
            }
        }

        function updatePlayPauseControlDisplay($el, playPauseIconDisplay) {
            if(!$el || $el.length == 0) {
                return;
            }

            _.each(_playPauseControlClasses, function(item) {
                $el.toggleClass(item, (playPauseIconDisplay === item))
            });
        }

        function inlineVideoStatusUpdate(data, status) {
            if(data && data.videoElement && data.videoElement.length > 0) {
                var $tabbedBarFeature = data.videoElement.closest('.tabbed-bar-feature');
                if($tabbedBarFeature && $tabbedBarFeature.length > 0) {
                    var intervalRefId = $tabbedBarFeature.data('intervalRefId') || '';
                    stopInterval(intervalRefId);
                    $tabbedBarFeature.toggleClass('child-inline-video-playing', (status === 'play'));
                }
            }
        }

        function _onResize() {
            components.each(function() {
                var $tabContainer = $(this).find('.tab-container'),
                    isContentTabs = $tabContainer.hasClass('content-tabs');

                if(isContentTabs) {
                    updateScrollPosition($tabContainer, '.visible-tab', true, false);
                }
            });
        }

    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util);
;(function($, _, win, brand, pos, util, disclosures) {

    brand.setInitHandler('[data-fgx-single-static-feature]', init);

    /////////////

    function init(components) {

        //$(window).resize(function(){
        //    handleResize();
        //});

        //brand.Util.moreLessInit(components, true, 6, 1.15, '.ml-wrapper');
        //handleResize();

        var positionedElems = {},
            POSITIONED_ELEM_BASE_CLASS = "fgx-positioned-ssf-",
            POSITIONED_ITEM_BASE_CLASS = "fgx-positioned-item-",
            mqlPhone = window.matchMedia('(max-width: 767px)'),
            _inlineVideosOnPage = false,
            tabMql = window.matchMedia('(min-width: 768px) and (max-width: 991px)'),
            _currMediaKey = '',
            _onScroll_d = null,
            _bcpIndex = 0,
            BCP_BASE_ID = "fgx-bc-player-container-ssf-",
            _bcpInstances = {};

        mqlPhone.addListener(handlePositionedResize);
        tabMql.addListener(handleResize);
        
        // Setup a hover state for any 'btn-primary' buttons
        var $ctaP = $('.single-static-feature-cta > a.btn.btn-primary.add-hover', components);
        brand.Util.ctaHover($ctaP);
        // hover state for secondary CTA's, part of Ford CTA globalization
        if ( $('html').hasClass('fgx-brand-Ford') ) {
            var $ctaS = $('.single-static-feature-cta > a.btn.btn-secondary.add-hover', components);
            brand.Util.ctaHover($ctaS)
        }

        brand.MediaOverlay.link(components);

        components.each(function(count) {
            brand.Pricing.refresh(this);

            var $moreToggle = $(this).find('.moreDesc');
            var $lessToggle = $(this).find('.lessDesc');
            var $desc = $(this).find('.description-more');
            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
                $lessToggle.focus();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
                $moreToggle.focus();
            });
            
            var $popupDisclosureLink = $(this).find('.fgx-popup-tooltip');
            $popupDisclosureLink.click(function(ev) {
                ev.stopPropagation();
                disclosures.popupDisclosureLinkClick(ev);
            });

            // NZ - BRAND-12106 - Added logic to update the color of tel links that are dynamically added by IOS
            // to match the authored color of the text.
            var $telLinksToUpdate = $(this).find('.description.authored-color a[href^=\'tel:\']');
            if($telLinksToUpdate && $telLinksToUpdate.length > 0) {
                var descColor = $(this).find('.description.authored-color').css('color');
                $telLinksToUpdate.css('color', descColor);
            }

            var slides = {};
            slides = pos.items.setup(this,POSITIONED_ITEM_BASE_CLASS, ".single-static-feature-text");

            if(!$.isEmptyObject(slides)) {
                var elementClass = POSITIONED_ELEM_BASE_CLASS + count;
                $(this).addClass(elementClass);
                positionedElems[elementClass] = slides;
            }
        });

        var $inlineVideoElements = $('.fgx-has-inline-video', components),
            $bcInlineVideoElements = $inlineVideoElements.filter('.inline-video-bc');
        if($inlineVideoElements && $inlineVideoElements.length > 0) {
            initInlineVideos();
            // Setup event listeners for the inline-video elements and whatnot.
            $('body')
                .on('fgxTabbedBarFeatureTabChange', function(ev, data) {
                    if(data && data.slideContainer && data.slideContainer.length > 0) {
                        // BC inline implementation. Start with the slideContainer that was returned, then search for any
                        // ssf.inline-video-bc elements and loop through those. That way we know we're only looking through
                        // videos within this instance of the tabbedbarfeature component.
                        data.slideContainer.find('.single-static-feature.single-video.inline-video-bc').each(function() {
                            var _this = this,
                                $comp = $(_this),
                                videoInst = getBcpInstanceFromComponent($comp);
                            if (videoInst) {
                                // set the transition lock to indicate this video instance is in transition.
                                videoInst.setTransitionLock(true);
                                if (!videoInst.displayOnBP()) {
                                    return;
                                }
                                if (videoInst.isPlaying()) {
                                    videoInst.pause(true);
                                }
                            }

                        });
                    }
                })
                .on('fgxTabbedBarFeatureTabChangeEnd', function(ev, data) {
                    if(data && data.slideContainer && data.slideContainer.length > 0) {
                        var activeSlideAvailable = !!(data.activeSlide && data.activeSlide.length > 0),
                            activeVideoInstList = [],
                            _bcPromises = [];

                        // BC inline implementation. Start with the slideContainer that was returned, then search for any
                        // ssf.inline-video-bc elements and loop through those. That way we know we're only looking through
                        // videos within this instance of the tabbedbarfeature component.
                        data.slideContainer.find('.single-static-feature.single-video.inline-video-bc').each(function() {
                            var _this = this,
                                $comp = $(_this),
                                videoInst = getBcpInstanceFromComponent($comp);
                            if (videoInst) {
                                if (!videoInst.displayOnBP()) {
                                    // release the lock
                                    videoInst.setTransitionLock(false);
                                    return;
                                }

                                if(activeSlideAvailable && $.contains(data.activeSlide[0], _this)) {
                                    var _promise = videoInst.loadInViewport();

                                    // Adding to a list to delay starting the video until all other videos have been paused.
                                    // This is so the play event fires after all pause events, which should prevent any potential conflicts.
                                    if (videoInst.autoplayEnabledOnBP()) {
                                        activeVideoInstList.push(videoInst);
                                        _bcPromises.push(_promise);
                                    } else {
                                        // release the lock
                                        videoInst.setTransitionLock(false);
                                    }
                                } else {
                                    // release the lock
                                    videoInst.setTransitionLock(false);
                                }
                            }
                        });

                        if(activeVideoInstList.length > 0) {
                            _.each(activeVideoInstList, function(videoInst) {
                                if (videoInst) {
                                    var handleVideoUpdate = function(skipPromiseCheck) {
                                        if (videoInst.initialized) {
                                            // release the lock
                                            videoInst.setTransitionLock(false);
                                            if (videoInst.isVisible()) {
                                                videoInst.play(true);
                                            }
                                        } else if (!skipPromiseCheck) {
                                            // if video is not initialized already, then wait for the promises to be
                                            // resolved and check again.
                                            $.when.apply($, _bcPromises).done(function() {
                                                handleVideoUpdate(true);
                                            });
                                        } else {
                                            // need to release lock even if video isn't initialized
                                            videoInst.setTransitionLock(false);
                                        }
                                    };
                                    handleVideoUpdate();
                                }
                            });
                        }
                    }
                })
                .on('fgxTabbedBarFeaturePauseVideo', function(ev, data) {
                    handleTabbedBarVideoEvent(ev, data, 'pause');
                })
                .on('fgxTabbedBarFeaturePlayVideo', function(ev, data) {
                    handleTabbedBarVideoEvent(ev, data, 'play');
                });
        }

        function initInlineVideos() {
            _inlineVideosOnPage = true;
            var bp = util.currentBreakpoint();
            _currMediaKey = (bp === 'gux-bkpt-sm') ? 'mobile' : ((bp === 'gux-bkpt-med') ? 'tablet' : 'desktop');

            // Setup any inline BC videos that are available.
            $bcInlineVideoElements.each(function() {
                setupInlineVideo($(this));
            });

            updateInlineVideoDisplay(_currMediaKey, false);
            _onScroll_d = _.debounce(_onScroll, 100);
            $(win).on('scroll', _onScroll_d);
        }

        function fireVideoEvent(elm, ev) {
            var $video = $(elm),
                eventData = {
                    videoElement: $video,
                    componentType: 'ssf'
                };

            if(ev) {
                $('body').trigger(ev, [eventData]);
            }
        }

        function setupInlineVideo($el) {
            if (!$el || $el.length === 0) {
                return;
            }
            var inlineId = BCP_BASE_ID + ++_bcpIndex,
                inlineConfigStr = $el.attr('data-inline-video-config'),
                inlineConfig = inlineConfigStr && JSON.parse(inlineConfigStr) || {},
                inlineHeadline = $el.attr('data-inline-video-title') || '',
                $vidContainer = $el.find('.inline-video-container'),
                data = {
                    id: inlineId,
                    fgxInstanceId: inlineId,
                    slideItem: $el,
                    videoContainer: $vidContainer,
                    type: 'brightcove',
                    displayType: 'inline',
                    settings: {
                        muted: true,
                        loop: !!($vidContainer.is('[data-fgx-loop]')),
                        playsinline: true
                    },
                    bcpConfig: {
                        playIndex: 0,
                        videos: [{'videoId': $vidContainer.attr('data-fgx-video-id') || '', 'videoTitle': inlineHeadline}]
                    },
                    brandConfig: {
                        index: 0,
                        count: 1
                    },
                    actions: inlineConfig && inlineConfig.actions || {},
                    videoTitle: inlineHeadline
                };
            $vidContainer.attr('id', inlineId);

            var videoInstance = brand.Video.videoItem.create(data);

            videoInstance.subscribeTopic('play', function(data) {
                var inst = data && data.inst;
                if (inst) {
                    fireVideoEvent(inst.videoContainer, 'fgxInlineVideoPlay');
                }
            });
            videoInstance.subscribeTopic('pause', function(data) {
                var inst = data && data.inst;
                if (inst) {
                    fireVideoEvent(inst.videoContainer, 'fgxInlineVideoPause');
                }
            });
            videoInstance.subscribeTopic('ended', function(data) {
                var inst = data && data.inst;
                if (inst) {
                    fireVideoEvent(inst.videoContainer, 'fgxInlineVideoEnded');
                }
            });

            _bcpInstances[inlineId] = videoInstance;
        }

        function handleTabbedBarVideoEvent(ev, data, key) {
            if(data && data.activeSlide && data.activeSlide.length > 0) {
                // BC inline implementation. Start with the activeSlide that was returned, then search for any
                // ssf.inline-video-bc elements and loop through those. That way we know we're only looking through
                // videos within this instance of the tabbedbarfeature component/activeSlide.
                data.activeSlide.find('.single-static-feature.single-video.inline-video-bc').each(function() {
                    var _this = this,
                        $comp = $(_this),
                        videoInst = getBcpInstanceFromComponent($comp);
                    if (videoInst) {
                        if (!videoInst.displayOnBP()) {
                            return;
                        }

                        if (key === 'play') {
                            if (videoInst.isVisible()) {
                                videoInst.play();
                            }
                        } else {
                            videoInst.pause();
                        }
                    }

                });
            }
        }

        function updateInlineVideoDisplay(mediaKey, fromScroll) {
            if(!_inlineVideosOnPage) {
                return;
            }

            // Implementation for new BCP inline videos.
            _.each(_bcpInstances, function(inst) {
                if (mediaKey === 'mobile') {
                    if (inst.shownOnMobile()) {
                        updateVideoForBP(inst);
                    } else if (!fromScroll) {
                        if (inst.initialized) {
                            inst.pause(true);
                        }
                    }
                } else {
                    updateVideoForBP(inst);
                }
            });
        }

        function updateVideoForBP(_inst) {
            if (_inst) {
                _inst.loadInViewport().done(function(inst) {
                    if (inst && inst.initialized) {
                        if (inst.autoplayEnabledOnBP() && inst.isVisible() && !inst.isManuallyPaused()) {
                            inst.play(true);
                        }
                    }
                });
            }
        }

        function getBcpInstanceFromComponent($el) {
            if (!$el || $el.length === 0) {
                return null;
            }

            var instanceId = $el.find('.inline-video-container').attr('id'),
                videoInst = _bcpInstances[instanceId] || null;
            return videoInst;
        }

        function _onScroll() {
            if(_currMediaKey === '') {
                var bp = util.currentBreakpoint();
                _currMediaKey = (bp === 'gux-bkpt-sm') ? 'mobile' : ((bp === 'gux-bkpt-med') ? 'tablet' : 'desktop');
            }
            updateInlineVideoDisplay(_currMediaKey, true);
        }

        function handlePositionedResize(mqlPhone) {
            if(mqlPhone.matches) {
                pos.items.update('mobile', positionedElems);
            } else {
                pos.items.update('desktop', positionedElems);
            }
        }

        function handleResize(mql) {
            if(mql.matches) {
                _currMediaKey = 'tablet';
            } else {
                var bp = util.currentBreakpoint();
                _currMediaKey = (bp === 'gux-bkpt-sm') ? 'mobile' : 'desktop';
            }
            updateInlineVideoDisplay(_currMediaKey, false);
        }

        //function handleResize(){
        //    var mqlPhone = window.matchMedia('(max-width: 767px)');
        //    var mqlTablet = window.matchMedia('(max-width: 992px)');
        //    var mqlDesktop = window.matchMedia('(max-width: 1440px)');
        //
        //    if(mqlPhone.matches){
        //        brand.Util.moreLessInit(components, false, 3, 1.15, '.ml-wrapper');
        //    }
        //    else if (mqlTablet.matches) {
        //        brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
        //    }
        //    else if (mqlDesktop.matches) {
        //        brand.Util.moreLessInit(components, false, 6, 1.15, '.ml-wrapper');
        //    }
        //}
    }
    
})(jQuery, FD.Brand.lodash, window, FD.Brand, FD.Brand.Position, FD.Brand.Util, FD.Brand.Disclosures);

;(function($, brand) {

    brand.setInitHandler('[data-fgx-hotspot-feature]', init);

    /////////////

    function init(components) {

        // Setup a hover state for any 'btn-primary' buttons
        var $ctaP = $('.hotspot-feature-cta > a.btn.btn-primary.add-hover', components);
        brand.Util.ctaHover($ctaP);
        // hover state for secondary CTA's, part of Ford CTA globalization
        if ( $('html').hasClass('fgx-brand-Ford') ) {
            var $ctaS = $('.hotspot-feature-cta > a.btn.btn-secondary.add-hover', components);
            brand.Util.ctaHover($ctaS);
        }
        var $overlayGroup = $('.hotspot-feature-image', components);
        brand.MediaOverlay.link($overlayGroup);

        components.each(function() {
            var $moreToggle = $(this).find('.moreDesc');
            var $lessToggle = $(this).find('.lessDesc');
            var $desc = $(this).find('.description-more');
            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
                $lessToggle.focus();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
                $moreToggle.focus();
            });
        });

    }
    
})(jQuery, FD.Brand);

;(function($, _, brand, media, util) {
    
    var _components,
        _onResize_d,
        setMeatballs_d,
        breakPoint,
        _hasTouch,
        hammertime = null,
        window_el,
        meatballLabel = '',
        carouselScrollAction;

    brand.setInitHandler('[data-fgx-flex-column-feature]', init);

    /////////////

    function init(components) {
        
        _components = components;
        _onResize_d = _.debounce(_onResize, 50);
        setMeatballs_d = _.debounce(setMeatballs, 200);
        breakPoint = util.currentBreakpoint();
        _hasTouch = util.env.touch();
        window_el = $(window);
        meatballLabel = (brand.Context.accessibility && brand.Context.accessibility.meatballLabelPrefix) || '';
        
        // link media overlay
        media.link(components);
        
        window_el.resize(_onResize_d);
        
        components.each(function() {
        
            // initial elements
        
            this._el = $(this);
            this.container_el = $('.fcf-wrapper', this);
            this.mobileTxt_el = $('.mobile-carousel-text', this);
            this.visible_tiles_desktop = $(this.container_el).attr('data-desktop-columns');
            this.visible_tiles_tablet = $(this.container_el).attr('data-tablet-columns');
            this.visible_tiles_mobile = $(this.container_el).attr('data-mobile-columns');
            this.visible_tiles = 0;
            this.features_el = $('.fcf-container', this);
            this.tile_el = $('.flexTile', this);
            this.arrows_el = $('.carousel-arrows', this);
            this.back_arrow_el = $('.carousel-arrows.carousel-left', this);
            this.next_arrow_el = $('.carousel-arrows.carousel-right', this);
            this.meatballs_el = $('.meatballs', this);
            this.tile_width = 0;
            this.total_tiles = 0;
            this.total_width = 0;
            this.visible_width = 0;
            this.tile_widths = new Array();
            this.isCarousel = false;
            this.carouselScrollAction = $(this).data('carousel-scroll-action');
            this.inContextDisclosuresDisplayBottom = this._el.hasClass('fgx-disclosures-bottom');
            if ($(this.container_el).hasClass('wrap-carousel')) {
                // finish initializing only if author has specified carousel wrapping behavior.
                if((this.container_el.length > 0) && (this.features_el.length > 0)) {
                    hammertime = new Hammer(this.container_el[0]);
                }
                
                this.isCarousel = true;

                /*init */

                finishList(this);
            }
            /**
             * BRAND-17894 - If our component is configured to display all in-context disclosures at the bottom, we need to remove them
             * from the individual slides and append them to the container that should hold them all.
             **/
            if (this.inContextDisclosuresDisplayBottom) {
                var $discBottomContainer = this._el.find('.disclosure-wrapper');
                this._el.find('.fgx-moveable-disclosure').detach().appendTo($discBottomContainer);
            }
        });
        function refreshValues(scope) {
            scope.total_tiles = scope.tile_el.length;

            var tile = $(scope.tile_el[0]);
            scope.tile_width = tile.width() + cssNum(tile, "marginLeft") + cssNum(tile, "marginRight");

            scope.total_width = scope.tile_width * scope.total_tiles;
        }

        function finishList(scope) {
            var $tabbedContentSection = $(scope).closest('.tab-content-section');
            if($tabbedContentSection && $tabbedContentSection.length > 0) {
                $(scope).addClass('fgx-in-hideable-section');
                $(scope).data('fgxHiddenContainerEl', $tabbedContentSection);
            }

            refreshValues(scope);

            scope.arrows_el.children(".carousel-next").on("click", {
              metrics: "click arrow next"
            }, function() {
                jumpNextMeatball(scope);
            });

            scope.arrows_el.children(".carousel-previous").on("click", {
              metrics: "click arrow previous"
            }, function() {
                jumpPrevMeatball(scope);
            });
            
            //swipe
            if(hammertime) {
                hammertime.on('dragleft swipeleft dragright swiperight', function (ev) {
                    if(breakPoint === 'gux-bkpt-sm' || _hasTouch) {
                        switch(ev.type) {
                            case 'dragleft':
                            case 'swipeleft':
                                jumpNextMeatball(scope);
                                break;
                            case 'dragright':
                            case 'swiperight':
                                jumpPrevMeatball(scope);
                                break;
                        }
                    }
                });
            }

            scope._el.addClass("loaded");
            window_el.resize();
            
            // window resize doesn't always trigger on Safari, so make sure we set our meatballs...
            //setMeatballs(scope.meatballs_el, scope);

        }

        function cssNum(el, string) {
            return Number(el.css(string).replace("px", ""));
        }

        function setLeftTo(el, num) {
            el.css("left", num + "px");
        }

        function setMobileTextTo(el, str) {
            el.text(str);
        }

        function appendLabel(el, label) {
            el.append(label);
            return el.children().last();
        }
        
        function updateTabIndexes(scope) {
            var activeMeatball = scope.meatballs_el.find("a.active");
            var index = activeMeatball.text() * scope.visible_tiles;
            var counter = 0;
            // first, set the tabindex attribute of all existing items with tabindex attribute and any links authored within
            // a slide that don't already have a tabindex attribute to '-1'
            $('[tabindex], a:not([tabindex])', scope.tile_el).each(function() {
                $(this).attr('tabindex', '-1');
            });
            // NZ - hide all tiles initially when not on mobile. But on mobile, we set the aria-hidden attribute to false
            // for all tiles because this component relies on the default behavior of a screen reader to swipe through the
            // 'visible' tiles on mobile since there are no meatballs or arrows for a user to click to navigate through.
            scope.tile_el.attr('aria-hidden', (breakPoint === 'gux-bkpt-sm') ? 'false' : 'true');
            // next, for our tiles which are currently visible, toggle tabindex to '0'
            while (counter < scope.visible_tiles) {
                if (index < scope.tile_el.length) {
                    var tile = scope.tile_el[index];
                    $('[tabindex]', tile).each(function() {
                        $(this).attr('tabindex', '0');
                    });
                    // NZ - only need to update the aria-hidden attribute of the current tile if we're not on mobile.
                    if (breakPoint !== 'gux-bkpt-sm') {
                        $(tile).attr('aria-hidden', 'false');
                    }
                    counter ++;
                    index ++;
                } else {
                    break;
                }
            }
            // set our pagination aria label
            if (scope.visible_tiles < scope.total_tiles) {
                updatePaginationLabel(scope._el, (parseInt(activeMeatball.text()) + 1), scope.meatballs_el.find("a").length, scope.visible_tiles);
            } else {
                // Will C. - BRAND-18481 - clear text from the label and set aria-hidden to 'true'
                hidePaginationLabel(scope._el);
            }
            
        }
        
        function updatePaginationLabel($carousel, current, total, itemsPerPage) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            if(pageInfoTemplate) {
                pageInfo.attr('aria-hidden', 'false');
                pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total).replace('{itemsPerPage}', itemsPerPage));
            }
        }
        
        function hidePaginationLabel($carousel) {
            var pageInfo = $carousel.find('.pagination-info');
            pageInfo.attr('aria-hidden', 'true');
            pageInfo.text('');
        }
        
        function setArrows(el, scope) {
            var first = scope.meatballs_el.children().first();
            var last = scope.meatballs_el.children().last();
            var prevArrow = scope.arrows_el.children(".carousel-previous");
            var nextArrow = scope.arrows_el.children(".carousel-next");
            if (el.attr('data-position') === first.attr('data-position')) {
                if (!prevArrow.hasClass('inactive')) {
                    prevArrow.removeClass('active');
                    prevArrow.addClass('inactive');
                }
            } else {
                if (prevArrow.hasClass('inactive')) {
                    prevArrow.removeClass('inactive');
                    prevArrow.addClass('active');
                }
            }
            if (el.attr('data-position') === last.attr('data-position')) {
                if (!nextArrow.hasClass('inactive')) {
                    nextArrow.removeClass('active');
                    nextArrow.addClass('inactive');
                }
            } else {
                if (nextArrow.hasClass('inactive')) {
                    nextArrow.removeClass('inactive');
                    nextArrow.addClass('active');
                }
            }
            // update our tab index attributes to avoid tabbing off-screen and messing up our positioning
            updateTabIndexes(scope);
        }

        function jumpToMeatball(el, scope) {
            scope.meatballs_el.find("a.active").removeClass("active");
            setLeftTo(scope.features_el, -1 * el.attr('data-position'));
            setMobileTextTo(scope.mobileTxt_el, el.attr('data-mobile-text'));
            el.children("a").addClass("active");
            setArrows(el, scope);
            // new metrics
            if (typeof scope.carouselScrollAction != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    scope.carouselScrollAction
                );
            }
        }

        function jumpNextMeatball(scope) {

            var t = scope.meatballs_el.find("a.active").parent().next();
            if (t.length) {
              jumpToMeatball(t, scope);
            } else {
              // this used to jump to the first slide
              //jumpToMeatball(scope.meatballs_el.children().first(), scope);
            }
        }

        function jumpPrevMeatball(scope) {

            var t = scope.meatballs_el.find("a.active").parent().prev();
            if (t.length) {
              jumpToMeatball(t, scope);
            } else {
              // this used to jump to the last slide
              //jumpToMeatball(scope.meatballs_el.children().last(), scope);
            }
        }

        function clickToMeatball(el, scope) {
            jumpToMeatball(el, scope);
            scope.container_el.focus();
        }

        function resetMeatballs(el, widths) {

            var keys = _.keys(widths),
              _widthskey,
              m_el = el.children("li");

            while ((_widthskey = keys.shift())) {
              $(m_el[_widthskey]).attr("data-position", widths[_widthskey].total);
            }
        }

        function createMeatballs(el, widths, scope) {

            var keys = _.keys(widths),
              _widthskey,
              new_el,
              active_el;

            while ((_widthskey = keys.shift())) {

              new_el = appendLabel(el, createMeatball(_widthskey, widths[_widthskey], widths.length));
              if (widths[_widthskey] <= Number(scope.features_el.css("left").replace("px", "") * -1)) {
                active_el = new_el.children("a");
                setMobileTextTo(scope.mobileTxt_el, new_el.attr('data-mobile-text'));
              }

              new_el.on("click", {
                metrics: "click meatball" + _widthskey
              }, function(){
                  clickToMeatball($(this), scope);
              });
            }
            if(active_el) {
                active_el.addClass("active");
            }
        }

        function createMeatball(num, pos, total) {
            var ariaLabel = meatballLabel + ' ' + (parseInt(num) + 1);
            return String.prototype.concat.call(
              '<li  data-position="',
              pos,
              '" data-mobile-text="',
              parseInt(num) + 1,
              '/',
              total,
              '"><a href="javascript:void(0);" tabindex="0" role="button" data-fgx-keypress="true" aria-label="' + ariaLabel + '">',
              num,
              '</a></li>\n');
        }

        function setMeatballs(el, scope) {
            var _meatballwidths = [];
            var meatball_num = Math.ceil(scope.total_width / scope.visible_width);
            // always start with our features at 0px left position
            setLeftTo(scope.features_el, 0);

            for (var i = 0; i < meatball_num; i ++) {
                _meatballwidths[i] = scope.visible_width * i;
            }

            if (meatball_num > 1) {
                el.empty();
                createMeatballs(el, _meatballwidths, scope);
                scope.arrows_el.addClass("scrollable");
                scope.meatballs_el.addClass("scrollable");
            } else {
                scope.arrows_el.removeClass("scrollable");
                scope.meatballs_el.removeClass("scrollable");
            }

            setArrows(scope.meatballs_el.children().first(), scope);
        }

        function _onResize() {
            breakPoint = util.currentBreakpoint();
            
            _components.each(function() {
                if (this.isCarousel) {
                    var scope = this,
                        $hiddenContainer = null,
                        $el = $(scope);

                    if($el.hasClass('fgx-in-hideable-section') && !$el.is(':visible')) {
                        $hiddenContainer = $el.data('fgxHiddenContainerEl');

                        if($hiddenContainer && typeof($hiddenContainer) !== 'undefined' && $hiddenContainer.length > 0) {
                            $hiddenContainer.addClass('fgx-brand-size-calc');
                        }
                    }

                    refreshValues(scope);

                    if(breakPoint === 'gux-bkpt-sm') {
                        // mobile
                        scope.visible_tiles = scope.visible_tiles_mobile;
                        scope.visible_width = scope.tile_width * scope.visible_tiles_mobile;
                    } else if (breakPoint === 'gux-bkpt-med') {
                        // tablet
                        scope.visible_tiles = scope.visible_tiles_tablet;
                        scope.visible_width = scope.tile_width * scope.visible_tiles_tablet;
                    } else {
                        // desktop
                        scope.visible_tiles = scope.visible_tiles_desktop;
                        scope.visible_width = scope.tile_width * scope.visible_tiles_desktop;
                    }

                    setMeatballs(scope.meatballs_el, scope);

                    if($hiddenContainer && $hiddenContainer.hasClass('fgx-brand-size-calc')) {
                        $hiddenContainer.removeClass('fgx-brand-size-calc');
                    }
                }
            });
        }
        
    }    
    
})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.MediaOverlay, FD.Brand.Util);

;(function($, brand, util){

    brand.setInitHandler('[data-fgx-features-slider]', init);

    function init(components) {
        var $mHeightComponents = $('.features-slider.has-mobile-override');
        var mql = window.matchMedia('(min-width: 768px)');
        mql.addListener(handleResize);
        handleResize(mql);

        components.each(function() {
            if($(this).find(".sliderSpin_container").length) {
                this.$img = $('.slider_img', $(this));
                this.assetPath = this.$img.attr('data-assetPath');
                this.altText = this.$img.attr('data-altTag');
                this.spinSetSize = parseInt(this.$img.attr('data-set-size'), 10);
                this.mHeightOverride = $(this).attr('data-mobile-height-override');
                this.sliderContainer = $('.sliderSpin_container', $(this));
                this.$imgPlaceholder = $('.placeholder_img', $(this));
                this.sliderControl = $('.fgx-brand-slider-control', $(this));
                this.$moreToggle = $('.ml-wrapper .moreDesc', $(this));
                this.$lessToggle = $('.ml-wrapper .lessDesc', $(this));
                this.$desc = $('.ml-wrapper .description-more', $(this));
                this.currentFrame = 1;
                this.isChanging = false;

                setupEvents(this);
            }
        });

        var $firstOverlayGroup = $('.hotspot-wrapper.first-set', components);
        var $secondOverlayGroup = $('.hotspot-wrapper.second-set', components);
        brand.MediaOverlay.link($firstOverlayGroup);
        brand.MediaOverlay.link($secondOverlayGroup);

        // Setup a hover state for any 'btn-primary' or 'btn-secondary' buttons
        var $cta = $('.cta-wrapper a.btn.btn-primary.add-hover', components);
        var $ctaS = $('.cta-wrapper a.btn.btn-secondary.add-hover', components);
        util.ctaHover($cta);
        util.ctaHover($ctaS);

        function setupEvents(scope) {
            scope.sliderControl.on("input", function() {
                var newVal = parseInt($(this).val(), 10);
                scope.$img.reel('frame', newVal);

                scope.currentFrame = newVal;
                $(scope).removeClass('first-frame');
                $(scope).removeClass('last-frame');
                if(scope.currentFrame === 1) {
                    $(scope).addClass('first-frame');
                } else if(scope.currentFrame === scope.spinSetSize) {
                    $(scope).addClass('last-frame');
                }
            });
            scope.sliderControl.on("change", function() {
                FD.Brand.Metrics.handler.direct($(this).attr('data-fd-metrics-slider'));
            });
            scope.$moreToggle.click(function() {
                scope.$desc.toggle();
                $(this).hide();
            });
            scope.$lessToggle.click(function() {
                scope.$desc.toggle();
                scope.$moreToggle.show();
            });
        }

        function spinCar(spinDir, scope) {
            if (spinDir === 'left') {
                scope.$img.trigger('stepLeft');
            } else {
                scope.$img.trigger('stepRight');
            }
        }

        function loadReel(scope) {
            //
            $('.round-cache').remove();

            //
            scope.$img.unreel();

            // calculate width for revolution
            var rev = scope.sliderContainer.width() * 1.5;

            scope.$img.reel({
                frames: scope.spinSetSize,
                frame: scope.currentFrame,
                cw: true,
                brake: 0.23,
                draggable: false,
                throwable: 0,
                revolution: rev,
                cursor: 'default',
                images: scope.assetPath.split(','),
                klass: 'slider_img'
            })
            .bind('frameChange', function () {
                scope.currentFrame = $(this).data("frame");
            })
            .bind('loaded', function() {
                scope.$imgPlaceholder.hide();
            });
        }

        function handleResize(mql) {
            if(mql.matches) {
                $mHeightComponents.each(function() {
                    $(this).css('height', "");
                });
            } else {
                $mHeightComponents.each(function() {
                    if(this.mHeightOverride) {
                        $(this).css('height', this.mHeightOverride + 'px');
                    }
                });
            }
        }

        handleResize(mql);
        // init on lazy load
        $(document).on('lazybeforeunveil', function (ev) {
            if ($(ev.target).hasClass('features-slider')) {
                loadReel(ev.target);
            }
        });
        // init if already loaded
        components.each(function() {
            if($(this).is('.lazyloading, .lazyloaded')) {
                loadReel(this);
            }
        });
    }
})(jQuery, FD.Brand, FD.Brand.Util);
;(function($, _, brand) {

    brand.setInitHandler('[data-fgx-features-carousel-slide]', init);

    function init(components) {

        components.each(function(count) {
            var $moreToggle = $(this).find('.moreDesc');
            var $lessToggle = $(this).find('.lessDesc');
            var $desc = $(this).find('.description-more');

            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
                $lessToggle.focus();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
                $moreToggle.focus();
            });
        });
    }

})(jQuery, FD.Brand.lodash, FD.Brand);

;(function($, _, brand, media, util, win) {

    var _components,
        _onResize_d,
        setMeatballs_d,
        breakPoint,
        _hasTouch,
        _intervalRefs = {},
        meatballLabel = '';

    brand.setInitHandler('[data-fgx-features-carousel-container]', init);

    /////////////

    function init(components) {
        _components = components;
        _onResize_d = _.debounce(_onResize, 50);
        setMeatballs_d = _.debounce(setMeatballs, 200);
        breakPoint = util.currentBreakpoint();
        _hasTouch = util.env.touch();
        meatballLabel = (brand.Context.accessibility && brand.Context.accessibility.meatballLabelPrefix) || '';

        var $cta = $('.features-carousel-cta > a.btn.add-hover', components);
        util.ctaHover($cta);

        components.each(function() {
            var tileCount = $(this).find(".features-carousel-slide.item").length,
                slideCount = tileCount,
                $tiles = $(this).find(".features-carousel-slide.item"),
                inContextDisclosuresDisplayBottom = $(this).hasClass('fgx-disclosures-bottom');

            /*if($(this).hasClass("two-tiles")) {
                slideCount = Math.ceil(tileCount/2);
            }*/

            if(slideCount > 1) {
                $(this).find('.features-carousel-slide.item').each(function(idx) {
                    var $slide = $(this).attr('data-slide-id', idx);
                    //Add the 'first-slide' class to the first slide
                    if (idx === 0) {
                        $slide.addClass('first-slide');
                    }
                });

                $(this).find(".carousel-arrows").addClass("shown");

                //Add the hover listener for carousel arrows
                $(this).hover(function() {
                    if(breakPoint == 'gux-bkpt-lg' || breakPoint == 'gux-bkpt-xlg') {
                        $(this).find(".carousel-arrows.hoverArrows").fadeIn(500);
                    }
                }, function() {
                    if(breakPoint == 'gux-bkpt-lg' || breakPoint == 'gux-bkpt-xlg') {
                        $(this).find(".carousel-arrows.hoverArrows").fadeOut(500);
                    }
                });

                //Add the indicators
                $(this).find("div.flex-indicators").addClass("shown");


                FD.Brand.Util.carousel.swipe(this, function(el, dir) {
                    if(breakPoint === 'gux-bkpt-sm' || _hasTouch) {
                        var intervalRefId = $(el).data("intervalRefId");
                        resetInterval(intervalRefId);
                        ((dir === 'next') ? jumpNextMeatball : jumpPrevMeatball)($(el));
                    }
                });
                
                /**
                 * BRAND-17894 - If our component is configured to display all in-context disclosures at the bottom, we need to remove them
                 * from the individual slides and append them to the container that should hold them all.
                 **/
                if (inContextDisclosuresDisplayBottom) {
                    var $discBottomContainer = $(this).find('.disclosure-wrapper');
                    $(this).find('.fgx-moveable-disclosure').detach().appendTo($discBottomContainer).addClass('in-ctx-disclosure');
                }
            }

            var $tabbedContentSection = $(this).closest('.tab-content-section');
            if($tabbedContentSection && $tabbedContentSection.length > 0) {
                $(this).addClass('fgx-in-hideable-section');
                $(this).data('fgxHiddenContainerEl', $tabbedContentSection);
            }
        });

        media.link(components);

        $('.carousel-arrows.global-arrows .carousel-next', components).on("click", {
            metrics: "click arrow next"
        }, function() {
            var parent_el = $(this).parent().parent(),
                intervalRefId = parent_el.data("intervalRefId");
            resetInterval(intervalRefId);
            jumpNextMeatball(parent_el);
        });
        $('.carousel-arrows.global-arrows .carousel-previous', components).on("click", {
            metrics: "click arrow previous"
        }, function() {
            var parent_el = $(this).parent().parent(),
                intervalRefId = parent_el.data("intervalRefId");
            resetInterval(intervalRefId);
            jumpPrevMeatball(parent_el);
        });

        $(win).resize(_.debounce(_onResize, 50));
        components.addClass("loaded");
        $(win).resize();

        var counter = 0;
        components.each(function() {
            var _this = $(this);
            var globalArrowsLen = $(this).find('.carousel-arrows.global-arrows').length;

            if(_this.hasClass('autoplay') && (_this.find(".features-carousel-slide.item").length > 1) && (globalArrowsLen > 0)) {
                var delay = _this.data("interval");
                if(!delay) {
                    delay = 7000;
                }
                var interval = setInterval(function() {
                    jumpNextMeatball(_this, true);
                }, delay);
                var intervalRefId = "interval" + counter;
                _this.data("intervalRefId", intervalRefId);
                _intervalRefs[intervalRefId] = {
                    'setInterval': interval,
                    'delay': delay,
                    'container': _this
                };
            }
            counter++;
        });

        $(win).scroll(_.debounce(_onScroll, 100));
        $(win).scroll();
    }

    function cssNum(el, string) {
        return Number(el.css(string).replace("px", ""));
    }

    function setLeftTo(num, el) {
        el.css("left", num + "px");
    }

    function appendLabel(el, label) {
        el.append(label);
        return el.children().last();
    }

    function updateWidths(el) {
        //Going to dynamically set the widths of each slide.
        var container_width = el.width(),
            _showMultiple = el.hasClass('two-tiles'),
            _firstElem = el.find('.features-carousel-slide').first(),
            _elemMargin = (_firstElem.length) ? (cssNum(_firstElem, "marginLeft") + cssNum(_firstElem, "marginRight")) : 24,
            _elemWidth = (_showMultiple && breakPoint !== 'gux-bkpt-sm') ? ((container_width - (2 * _elemMargin)) / 2) : (container_width - _elemMargin),
            runOnce,
            item_widths = new Array();


        el.find('.features-carousel-slide').each(function() {
            var new_el = $(this);
            //Set the widths
            if(runOnce == undefined) {
                if(new_el.closest('.features-carousel-container ').hasClass('two-tiles') && $("html").hasClass("fgx-brand-Ford")) {
                    _elemWidth = _elemWidth * .9;
                    runOnce = true;
                }
            }

            //NGBS3-10970
            //Subtract the new element width by 4. This is to fix the positioning of the slides when sliding.
            new_el.width(_elemWidth - 4);

            item_widths.unshift(_elemWidth + cssNum(new_el, "marginLeft") + cssNum(new_el, "marginRight"));
        });

        return item_widths;
    }

    function resetInterval(id) {
        if(id && _intervalRefs[id]) {
            clearInterval(_intervalRefs[id].setInterval);
            var interval = setInterval(function() {
                jumpNextMeatball(_intervalRefs[id].container, true);
            }, _intervalRefs[id].delay);
            _intervalRefs[id].setInterval = interval;
        }
    }

    function updateTabIndexes(el) {
        // tab behavior moves the content of the carousel around, so we need to explicitly disable it on any items that aren't currently active
        var _showMultiple = el.hasClass('two-tiles');
        var activeMeatball = $(el).find(".global-indicators").find("a.flex-active");
        var slidesWrapper = $(el).find("ul.slides.slide-wrapper");
        var counter = 0;
        var visible_slides = (_showMultiple && breakPoint !== 'gux-bkpt-sm') ? 2 : 1;
        var slides = slidesWrapper.children();
        var currentIdx = (activeMeatball && activeMeatball.length > 0) ? parseInt(activeMeatball.text()) : 0;
        var index =  currentIdx * visible_slides;
        currentIdx += 1;
        // first, set all existing items with tabindex attribute to '-1'
        $('[tabindex]', slidesWrapper).each(function() {
            $(this).attr('tabindex', '-1');
        });
        // check links that don't have tabindexes assciated with them as well to account for the more/less links and
        // any potential links that are authored within the description or disclosures of a slide.
        $('a:not([tabindex])', slidesWrapper).each(function() {
            $(this).attr('tabindex', '-1');
        });

        slides.attr('aria-hidden', 'true');

        while (counter < visible_slides) {
            if (index < slides.length) {
                // for our slides which are currently visible, toggle tabindex to '0' for all elements with that attribute
                var slide = $(slides[index]);
                $('[tabindex]', slide).each(function() {
                    $(this).attr('tabindex', '0');
                });
                // if we have tabindex set on our <li> itself, toggle that to '0' as well
                if (slide[0].hasAttribute('tabindex')) {
                    slide.attr('tabindex', '0');
                }
                slide.attr('aria-hidden', 'false');
                counter ++;
                index ++;
            } else {
                break;
            }
        }
        // set our pagination aria label
        updatePaginationLabel($(el), currentIdx, $(el).find(".global-indicators").find("a").length, visible_slides);
    }
    
    function updatePaginationLabel($carousel, current, total, itemsPerPage) {
        var pageInfo = $carousel.find('.pagination-info');
        var pageInfoTemplate = pageInfo.data('label-template');
        pageInfo.attr('aria-hidden', 'false');
        if(pageInfoTemplate) {
            pageInfo.text(pageInfoTemplate.replace('{current}', current).replace('{total}', total).replace('{itemsPerPage}', itemsPerPage));
        }
    }

    /**
    * Update the arrows to add/remove the inactive class based on the selected meatball
    * el - meatball element that was clicked
    * meatballs_el - meatballs wrapper element
    * wrapper_el - wrapper element for the container
    **/
    function updateInactiveArrows(el, meatballs_el, wrapper_el) {
        if(!el || !meatballs_el || !wrapper_el) {
            return;
        }
        var slideId = parseInt(el.attr('data-slide-id'),10),
            meatball_num = meatballs_el.find('li').length,
            lastMeatball = meatball_num - 1;
        switch(slideId) {
            case 0:
                wrapper_el.find(".carousel-previous").addClass("inactive");
                wrapper_el.find(".carousel-next").removeClass("inactive");
                break;
            case lastMeatball:
                wrapper_el.find(".carousel-previous").removeClass("inactive");
                wrapper_el.find(".carousel-next").addClass("inactive");
                var id = wrapper_el.data("intervalRefId");
                if(id && typeof(id) != 'undefined' && _intervalRefs[id]) {
                    clearInterval(_intervalRefs[id].setInterval);
                }
                break;
            default:
                wrapper_el.find(".carousel-previous").removeClass("inactive");
                wrapper_el.find(".carousel-next").removeClass("inactive");
                break;
        }
    }

    function jumpToMeatball(el, meatballs_el, skipMtx) {
        var wrapper_el = meatballs_el.parent('.features-carousel-container'),
            container = wrapper_el.find('.slide-wrapper');
        skipMtx = skipMtx || false;
        meatballs_el.find("a.flex-active").removeClass("flex-active");
        setLeftTo(-1 * el.attr('data-position'), container);
        el.children("a").addClass("flex-active");
        updateInactiveArrows(el, meatballs_el, wrapper_el);

        // new metrics
        var carouselScrollAction = wrapper_el.data('carousel-scroll-action');
        if (typeof carouselScrollAction != 'undefined' && !skipMtx) {
            FD.Brand.Metrics.handler.direct(
                carouselScrollAction
            );
        }
    }

    function jumpNextMeatball(el, skipMtx) {//(data)
        //METRICS
        // metrics.clickEvent(data.metrics);
        //click
        $(el).find(".carousel-previous").removeClass("inactive");
        skipMtx = skipMtx || false;
        var meatballs_el = el.find('.global-indicators'),
            t = meatballs_el.find("a.flex-active").parent().next();
        if (t.length) {
            jumpToMeatball(t, meatballs_el, skipMtx);
        } else {
            //NGBS3-5889 requested this carousel continuously swipes thru items instead of animating back to the beginning of the items,
            //Since large effort, for now prevent animation once at the end of carousel slide items, and apply inactive css
            //jumpToMeatball(meatballs_el.children('ol').children().first(), meatballs_el);
        }
        //the rest of NGBS3-5889
        var nextSlides = $(el).find(".global-indicators").find("a.flex-active").parent().next().length;
        if(!nextSlides){
            $(el).find(".carousel-next").addClass("inactive");
        }
        updateTabIndexes(el);
    }

    function jumpPrevMeatball(el, skipMtx) {//(data)
        //METRICS
        // metrics.clickEvent(data.metrics);
        //click
        $(el).find(".carousel-next").removeClass("inactive");
        skipMtx = skipMtx || false;
        var meatballs_el = el.find('.global-indicators'),
            t = meatballs_el.find("a.flex-active").parent().prev();
        if (t.length) {
            jumpToMeatball(t, meatballs_el, skipMtx);
        } else {
            //NGBS3-5889 requested this carousel continuously swipes thru items instead of animating back to the beginning of the items,
            //Since large effort, for now prevent animation once at the end of carousel slide items, and apply inactive css
            //jumpToMeatball(meatballs_el.children('ol').children().last(), meatballs_el);
        }
        //the rest of NGBS3-5889
        var nextSlides = $(el).find(".global-indicators").find("a.flex-active").parent().prev().length;
        if(!nextSlides){
            $(el).find(".carousel-previous").addClass("inactive");
        }
        updateTabIndexes(el);
    }

    function createMeatballs(el, widths) {
        var parent_el = el.parent(),
            wrapper_el = parent_el.find('.slide-wrapper'),
            list_el = appendLabel(el, '<ol class="flex-control-nav"></ol>');
        var keys = _.keys(widths),
            _widthskey,
            new_el,
            active_el;

        while ((_widthskey = keys.shift())) {
            new_el = appendLabel(list_el, createMeatball(_widthskey, widths[_widthskey].total));
            if (widths[_widthskey].total <= Number(wrapper_el.css("left").replace("px", "") * -1)) {
                active_el = new_el.children("a");
            }

            new_el.on("click", {
                metrics: "click meatball" + _widthskey
            }, function() {
                var intervalRefId = parent_el.data("intervalRefId");
                resetInterval(intervalRefId);
                jumpToMeatball($(this), el, false);
                updateTabIndexes(parent_el);
                $(this).closest('.features-carousel-container').find('.slides-container').focus();
            });
        }

        active_el.addClass("flex-active");
        updateTabIndexes(parent_el);
    }

    function createMeatball(num, pos) {
        /*return String.prototype.concat.call(
            '<li  data-position="',
            pos,
            '"><a>',
            num,
            '</a></li>\n');*/
        var ariaLabel = meatballLabel + ' ' + (Number(num) + 1);
        return String.prototype.concat.call(
            '<li  data-position="',
            pos,
            '" data-slide-id="',
            num,
            '"><a href="javascript:void(0);" tabindex="0" role="button" data-fgx-keypress="true" aria-label="' + ariaLabel + '">',
            num,
            '</a></li>\n');
    }

    function resetMeatballs(el, widths) {
        var keys = _.keys(widths),
            _widthskey,
            m_el = el.children("ol").children("li");

        while ((_widthskey = keys.shift())) {
            $(m_el[_widthskey]).attr("data-position", widths[_widthskey].total);
        }
    }

    function setMeatballs(el, widths) {
        var parent_el = el.parent(),
            container_el = parent_el.find('.slides-container'),
            wrapper_el = parent_el.find('.slide-wrapper'),
            _currentwidth = 0,
            _meatballwidths = _.filter(widths, function(n) {
                if (n.combined > _currentwidth) {
                    _currentwidth = n.total + container_el.width();
                    return true;
                }

                return false;
            }),
            last_meatball = el.children('ol').children('li').length,
            meatball_num = _meatballwidths.length;

        function compareLastMeatBalls() {
            return el.children('ol').children('li').last().attr("data-position") !== _meatballwidths[meatball_num - 1].total;
        }

        if (meatball_num > 1) {
            if (last_meatball !== meatball_num) {
                el.empty();
                createMeatballs(el, _meatballwidths);
                setLeftTo(-1 * Number(el.find("a.flex-active").parent().attr("data-position")), wrapper_el);
            } else if (compareLastMeatBalls()) {
                resetMeatballs(el, _meatballwidths);
                setLeftTo(-1 * Number(el.find("a.flex-active").parent().attr("data-position")), wrapper_el);
            }
            parent_el.find('.carousel-arrows.global-arrows').addClass("scrollable");
            el.addClass("scrollable");
        } else {
            if(last_meatball > 0) {
                el.empty();
                updateTabIndexes(parent_el);
            }

            parent_el.find('.carousel-arrows.global-arrows').removeClass("scrollable");
            el.removeClass("scrollable");
            setLeftTo(0, wrapper_el);
        }
    }

    function _onResize() {
        breakPoint = util.currentBreakpoint();

        if(breakPoint !== 'gux-bkpt-sm'){
            $('.carousel-arrows.hoverArrows',_components).removeClass("hide-arrows");
            $('.carousel-arrows.hoverArrows',_components).hide();
        }
        else {
            $('.carousel-arrows.hoverArrows',_components).addClass("hide-arrows");
        }

        _components.each(function() {
            var $hiddenContainer = null,
                $el = $(this);

            if($el.hasClass('fgx-in-hideable-section') && !$el.is(':visible')) {
                $hiddenContainer = $el.data('fgxHiddenContainerEl');

                if($hiddenContainer && typeof($hiddenContainer) !== 'undefined' && $hiddenContainer.length > 0) {
                    $hiddenContainer.addClass('fgx-brand-size-calc');
                }
            }

            var _prev = 0,
                _totalwidth = 0,
                item_widths = updateWidths($(this)),
                _widths = _.chain(item_widths)
                    .map(function(n) {
                        _totalwidth+= Number(n);
                        var t = {
                            width: Number(n),
                            total: _prev,
                            combined: _prev + Number(n)
                        };
                        _prev += n;
                        return t;
                    })
                    .value();

            //widths should be changing on every resize
            //models_el.css("width", _totalwidth*1.1 + "px");
            $(this).find('.slide-wrapper').css("width", _totalwidth*1.1 + "px");

            var meatballsEl = $(this).find('.global-indicators');
            //shouldn't set the meatballs if we are on author.
            if(meatballsEl.length) {
                //the meatballs, with all its calculations, can wait and be debounced
                //setMeatballs_d(meatballsEl, _widths);
                setMeatballs(meatballsEl, _widths);
            }

            if($hiddenContainer && $hiddenContainer.hasClass('fgx-brand-size-calc')) {
                $hiddenContainer.removeClass('fgx-brand-size-calc');
            }
        });
    }

    function _onScroll() {
        _components.each(function() {
            var _this = $(this),
                slideCount = _this.find(".features-carousel-slide.item").length,
                globalArrowsLen = _this.find('.carousel-arrows.global-arrows').length,
                id = _this.data("intervalRefId");

            if(!_this.hasClass('autoplay') || slideCount <= 1 || globalArrowsLen === 0) {
                return;
            }

            if(!util.inViewport(_this)) {
                if(!_this.hasClass('fgx-is-paused')) {
                    //_this.carousel('pause');
                    if(id && _intervalRefs[id]) {
                        clearInterval(_intervalRefs[id].setInterval);
                    }
                    _this.addClass('fgx-is-paused');
                }
            } else {
                if(_this.hasClass('fgx-is-paused')) {
                    //_this.carousel('cycle');
                    resetInterval(id);
                    _this.removeClass('fgx-is-paused');
                }
            }
        });
    }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.MediaOverlay, FD.Brand.Util, window);

;(function($, brand) {

    brand.setInitHandler('[data-fgx-expanded-feature]', init);

    /////////////

    function init(components) {

        //var selector = '.expanded-header >.item >.ml-wrapper',
            //mql = window.matchMedia('(min-width: 768px)');
        //mql.addListener(handleResize);

        //window.FD.Brand.Util.moreLessInit(components, true, 3, 1.15, selector);
        //handleResize(mql);

        //Add class to float the last element left if there are an odd number of elements within the side-by-side layout.
        components.each(function() {
            var componentWrap = $(this).find('.sub-component-wrap.side-by-side');
            if(componentWrap.length) {
                var children = componentWrap.find('div.section');
                if(children.length && ((children.length % 2) === 1)) {
                    children.last().addClass('pull-left');
                }
            }

            var $moreToggle = $(this).find('.expanded-header .moreDesc');
            var $lessToggle = $(this).find('.expanded-header .lessDesc');
            var $desc = $(this).find('.expanded-header .description-more');

            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
                $lessToggle.focus();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
                $moreToggle.focus();
            });
        });

        // Setup a hover state for CTA's, part of ford CTA globalization
        var $cta = $('a.global-cta-expanded-feature.btn-primary', components);
        window.FD.Brand.Util.ctaHover($cta);


        //function handleResize(mql){
        //    if(!mql.matches){
        //        window.FD.Brand.Util.moreLessInit(components, false, 3, 1.15, selector);
        //    } else {
        //        window.FD.Brand.Util.moreLessInit(components, false, 25, 1.15, selector);
        //    }
        //}
    }
})(jQuery, FD.Brand);

;(function($, _, brand, util) {

    var templates = {},
        _loadedPaths = {},
        CLOCK_BASE_ID = 'fgx-cdt-clock-',
        _clockBaseIdx = 0,
        _timeInMs = {
            'sec': 1000,
            'min': (1000 * 60),
            'hr': (1000 * 60 * 60),
            'day': (1000 * 60 * 60 * 24)
        },
        _inEditMode = false;

    brand.setInitHandler('[data-fgx-countdown-timer]', init);

    /////////////

    function init(components) {
        if (!components || components.length === 0) {
            return;
        }

        _inEditMode = !!(components.attr('data-fgx-in-author-edit') === 'yes');

        components.each(function() {
            var $el = $(this);
            if (!templates.timerItem) {
                var $tmpl = $el.find("script[data-fgx-cdt-template-id='timerItem']");
                if ($tmpl.length) {
                    templates.timerItem = _.template($tmpl.html());
                }
            }
            // Dynamically select which background image to load and render it.
            renderBackgroundImage($el);
            initComponentState($el);

            // Handle setting up the tooltip for the calendar links.
            var $calContainer = $el.find('.fgx-ct-active-state .calendar-container'),
                $calOvrContentEl = $calContainer.find('.calendar-overlay-content');
            if ($calOvrContentEl.length) {
                var calOvrContent = $calOvrContentEl.html();
                $calContainer.find('[data-fgx-calendar-link-opener]').data('tooltipContent', calOvrContent);
            }

        });

        function initComponentState($el, fromTimeout) {
            if (!$el || $el.length === 0) {
                return;
            }
            var startDate = createDate($el.attr('data-fgx-start-date') || ''),
                endDate = createDate($el.attr('data-fgx-end-date') || ''),
                currDate = new Date();
            if ((startDate <= currDate) && (currDate < endDate)) {
                var timerData = parseAttrData($el, 'data-fgx-active-timer-list');
                if (timerData && timerData.length > 0) {
                    var data = {
                        timerData: timerData,
                        sDate: startDate,
                        eDate: endDate,
                        cDate: currDate
                    };
                    triggerState($el, 'active', data);
                } else {
                    triggerState($el, 'hidden');
                }
            } else if (currDate >= endDate) {
                triggerState($el, 'complete');
            } else {
                if (fromTimeout) {
                    triggerState($el, 'hidden');
                    return;
                }

                var _delay = (startDate - currDate);
                setTimeout(function() {
                    initComponentState($el, true);
                }, Math.max(_delay, 0));
            }
        }

        function setupClock($el, timerData, sDate, eDate, cDate) {
            var activeTimerStr = $el.attr('data-fgx-active-timers') || '',
                $container = $el.find('.fgx-ct-active-state .timer-container'),
                _sTime = sDate.getTime(),
                _eTime = eDate.getTime();
            // TODO: cleanup unused properties that are set on the clockItem from a previous iteration
            var clockItem = {
                id: CLOCK_BASE_ID + ++_clockBaseIdx,
                sTime: _sTime,
                eTime: _eTime,
                cTime: cDate.getTime(),
                totalTimeDiff: (_eTime - _sTime),
                $comp: $el,
                $timerContainer: $container,
                $accLabel: $container.find('.timer-acc-label'),
                $accAlertLabel: $container.find('.timer-acc-alert-label'),
                activeIntvlIds: ((activeTimerStr) ? activeTimerStr.split('-') : []),
                alertLabelPrefix: $el.attr('data-fgx-timer-alert-prefix') || '',
                currentTimes: [],
                daySet: false,
                hrSet: false,
                minSet: false,
                secSet: false,
                timers: {},
                timersArr: []
            };

            var timerColors = {};
            _.forEach(['fill', 'boarder', 'progress', 'text'], function(itm) {
                var _attr = 'data-fgx-timer-' + itm + '-color',
                    cls = $el.attr(_attr) || '';
                if (cls) {
                    timerColors[itm] = cls;
                }
            });

            clockItem.$comp.attr('fgx-cdt-clock-id', clockItem.id);
            clockItem.$timerContainer.addClass('timers-disp-' + timerData.length);
            _.forEach(timerData, function(timer, idx) {
                timer.itemClass = 'timer-' + timer.typeId;
                timer.$el = $(templates.timerItem({timer: timer, colors: timerColors}));
                timer.$timeLabel = timer.$el.find('.timer-number');
                timer.$pluralLabel = timer.$el.find('.label-plural');
                timer.pluralLabel = timer.$pluralLabel.text();
                timer.$singleLabel = timer.$el.find('.label-single');
                timer.singleLabel = timer.$singleLabel.text();
                timer.$remainingBrdr = timer.$el.find('.timer-remaining-brdr');

                if (idx === 0) {
                    timer.largestIntvl = true;
                    timer.timeLimit = timeForInterval(clockItem.totalTimeDiff, timer.typeId, true);
                } else {
                    timer.largestIntvl = false;
                    timer.timeLimit = (timer.typeId === 'hr') ? 24 : 60;
                }
                clockItem[timer.typeId + 'Set'] = true;
                clockItem.timers[timer.typeId] = timer;
                clockItem.timersArr.push(timer);
                clockItem.$timerContainer.append(timer.$el);
                if (timer.largestIntvl) {
                    clockItem.largestIntvlId = timer.typeId;
                }
            });

            var $brdrEl = clockItem.$timerContainer.find('.timer-remaining-brdr').first();
            clockItem.radius = parseInt($brdrEl.attr('r'), 10);
            clockItem.circumference = (2 * Math.PI * clockItem.radius).toFixed(0);

            startClock(clockItem);
        }

        function startClock(clockItem) {
            var _clockItem = clockItem,
                _secCount = 0;
            var updateAccAlert = function() {
                var _accLabel = _clockItem.alertLabelPrefix + ' ' + _clockItem.currentTimesStr;
                _clockItem.$accAlertLabel.html(_accLabel);
            };
            var updateClock = function() {
                var _now = new Date().getTime(),
                    _diff = (_clockItem.eTime - _now);
                _clockItem.cTime = _now;
                // Basic idea - loop through the array of active interval ids every second and calculate the time remaining
                // for each interval. If that value has changed from whats currently displaying, then update the displayed
                // value, ensure the correct label is showing, and set the 'stroke-dasharray' property of the timer-remaining-brdr
                // element to handle the animation.
                _.forEach(_clockItem.activeIntvlIds, function(intId, idx) {
                    var _time = timeForInterval(_diff, intId, (idx === 0)),
                        timer = _clockItem.timers[intId] || {};
                    if (!_.isEmpty(timer) && timer.currentTime !== _time && _time >= 0) {
                        var isSingle = (_time === 1);
                        timer.$timeLabel.html(_time);
                        timer.$pluralLabel.toggleClass('hidden', isSingle);
                        timer.$singleLabel.toggleClass('hidden', !isSingle);
                        timer.currentTime = _time;
                        _clockItem.currentTimes[idx] = _time + ' ' + ((isSingle) ? timer.singleLabel : timer.pluralLabel);
                        timer.$remainingBrdr.toggleClass('hide-stroke', (_time === 0));
                        var dashArray = getCircleDashArray(timer, _clockItem.circumference);
                        timer.$remainingBrdr.attr('stroke-dasharray', dashArray);
                    }
                });

                // For accessibility reasons the time values need to all be read together at once. Therefore, we need to
                // update a separate span with this value that is for screen readers only.
                _clockItem.currentTimesStr = _clockItem.currentTimes.join(' ').trim();
                _clockItem.$accLabel.html(_clockItem.currentTimesStr);

                // fire the updateAccAlert method once a minute to allow the screen reader to announce the updated time every minute.
                if (_secCount === 0) {
                    updateAccAlert();
                }
                _secCount = (_secCount === 59) ? 0 : (_secCount + 1);

                if (_diff <= 0) {
                    try {
                        clearInterval(timeInterval);
                        triggerState(_clockItem.$comp, 'complete');
                    } catch(e) {}
                }
            };
            updateClock();
            var timeInterval = setInterval(updateClock, 1000);
        }

        function timeForInterval(_diff, intId, isLongest) {
            var _time;
            if (!isLongest) {
                switch(intId) {
                    case 'hr':
                        _time = Math.floor((_diff % _timeInMs.day) / _timeInMs.hr);
                        break;
                    case 'min':
                        _time = Math.floor((_diff % _timeInMs.hr) / _timeInMs.min);
                        break;
                    case 'sec':
                        _time = Math.floor((_diff % _timeInMs.min) / _timeInMs.sec);
                        break;
                    default:
                        _time = Math.floor(_diff / _timeInMs[intId]);
                        break;
                }
            } else {
                _time = Math.floor(_diff / _timeInMs[intId]);
            }
            return _time || 0;
        }

        /*
         * calculateTimeFraction and getCircleDashArray functions below are used to get the necessary data for the animation.
         * These two functions are based on functions found in the following tutorial. The link below can provide more insight.
         * https://css-tricks.com/how-to-create-an-animated-countdown-timer-with-html-css-and-javascript/
         */
        function calculateTimeFraction(timer) {
            var rawTimeFraction = timer.currentTime / timer.timeLimit;
            return rawTimeFraction - (1 / timer.timeLimit) * (1 - rawTimeFraction);
        }

        function getCircleDashArray(timer, circumference) {
            return [
                (calculateTimeFraction(timer) * circumference).toFixed(0),
                circumference
            ].join(' ');
        }


        function triggerState($el, key, data) {
            if (!$el || $el.length === 0) {
                return;
            }

            if (key === 'active' && data) {
                toggleStateDisplay($el, 'active', _inEditMode);
                setupClock($el, data.timerData, data.sDate, data.eDate, data.cDate);
            } else {
                if (_inEditMode) {
                    $el.find('.content-section').toggleClass('hidden', false);
                    return;
                }

                if (key === 'complete') {
                    var requestUrl = $el.attr('data-complete-state-resource-url') || '';
                    if (requestUrl && !_loadedPaths[requestUrl]) {
                        $.get(requestUrl).then(function(res) {
                            util.log("countdownTimer::complete state request - successful. ", {"url": requestUrl});
                            _loadedPaths[requestUrl] = 1;
                            var $compWrap = $el.find('.fgx-ct-complete-state .sub-component-wrap');
                            toggleStateDisplay($el, 'complete');
                            if ($compWrap.length) {
                                $compWrap.html(res);
                                brand.initComponent($compWrap);
                            }
                        }, function() {
                            //request failed. Hide the sub-component-wrap and display the authored complete state text
                            util.log("countdownTimer::complete state request - failed. Hiding sub-component. ", {"url": requestUrl});
                            $el.find('.fgx-ct-complete-state .sub-component-wrap').toggleClass('hidden', true);
                            toggleStateDisplay($el, 'complete');
                        });
                    }
                } else {
                    //Hide the component
                    $el.toggleClass('hidden', true);
                }
            }
        }

        /*
         * When true, the skipClassCheck parameter will force the 'hidden' class to be removed from both the content-section elements.
         * When false or not passed in the addition/removal of the 'hidden' class will be determined by the 'hasClass' check.
         */
        function toggleStateDisplay($el, state, skipClassCheck) {
            var stateClass = 'fgx-ct-' + state + '-state';
            $el.find('.content-section').each(function() {
                var $this = $(this);
                $this.toggleClass('hidden', (!skipClassCheck && !$this.hasClass(stateClass)));
            });
            if ($el.hasClass('hidden')) {
                $el.removeClass('hidden');
            }
        }



        function parseAttrData($el, attrName) {
            var data = $el.attr(attrName),
                output;
            try {
                output = data && JSON.parse(data) || [];
            } catch(e) {
                output = [];
            }
            return output;
        }

        function getBackgroundImage($el) {
            var bgImgs = parseAttrData($el, 'data-fgx-background-images'),
                bgImg = {};

            if (bgImgs && !_.isEmpty(bgImgs)) {
                var idx = (bgImgs.length === 1) ? 0 : _.random(0, bgImgs.length - 1);
                bgImg = bgImgs[idx];
            }
            return bgImg;
        }

        function renderBackgroundImage($el) {
            if (!$el || $el.length === 0) {
                return;
            }

            var bgImg = getBackgroundImage($el),
                $bgContainer = $el.find('.background-container');
            if (!_.isEmpty(bgImg)) {
                var $picture = brand.Util.images.renderPicture(bgImg);
                $bgContainer.append($picture);
                var $img = $picture.find('img'),
                    $contentContainer = $el.find('.content-container');
                setPositionedClass($img, $contentContainer);
                //TODO: may need to call brand.Util.images.load($slides);
            }
        }

        function setPositionedClass($img, $container) {
            if (!$container || $container.length === 0) {
                return;
            }

            if (($img && $img.length !== 0) && !($img.hasClass('lazyloaded') || $img.hasClass('lazyloading'))) {
                $img.one('load', function() {
                    $container.toggleClass('positioned-content', true);
                });
            } else {
                $container.toggleClass('positioned-content', true);
            }
        }

        function createDate(timeStr) {
            return (timeStr) ? new Date(timeStr) : new Date();
        }

    }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Util);
;(function($, _, brand) {
    'use strict';

    brand.setInitHandler('[data-fgx-disclosures]', init);

    //////

    function init(components) {

        var $lst = $('ul', components),
            $lstHolder = $('.disclosures-text', components),
            $intro = $('.disc-intro', components),
            $container = $('#fgx-sitewide-disclosures', components),
            introText = "",
            count = 0,
            subheadlineHTag = $container.attr('data-subheadline-htag');

        if($intro.length > 0) {
            introText = $intro.html();
        }

        _.each(FD.Brand.Context.disclosures || [], function(disc) {
            if(count === 0 && (introText.length > 0)) {
                $('<li class="disc-note">' + introText + '</li>').appendTo($lst);
            } else {
                var dStr = '<li>';
                if (typeof subheadlineHTag !== 'undefined' && subheadlineHTag.length > 0) {
                    dStr += ('<' + subheadlineHTag + '>' + disc.id  + '. </' + subheadlineHTag + '>');
                } else {
                    dStr += (disc.id  + '. ');
                }
                dStr += (formatHtml(disc.detail) + '</li>');
                $(dStr).appendTo($lst);
            }
            count++;
        });
        
        // we're collapsed at first, init tabindex on any links within our content to '-1'
        $('a', $lst).attr('tabindex', '-1');
        $('sup[data-vdm-disc]', $lst).attr('tabindex', '-1');
        
        components
            .on('click', '.title button', function() {
                $(this).closest('.disclosures').toggleClass('open');
                $(this).attr('aria-expanded', $(this).closest('.disclosures').hasClass('open'));
                if ($(this).closest('.disclosures').hasClass('open')) {
                    $lstHolder.attr('tabindex', '0');
                    $container.attr('aria-hidden', 'false');
                    $('a', $lst).attr('tabindex', '0');
                    $('sup[data-vdm-disc]', $lst).attr('tabindex', '0');
                } else {
                    $lstHolder.attr('tabindex', '-1');
                    $container.attr('aria-hidden', 'true');
                    $('a', $lst).attr('tabindex', '-1');
                    $('sup[data-vdm-disc]', $lst).attr('tabindex', '-1');
                }
            })
            .addClass('loaded');


    }
    
    function formatHtml(discDetail) {
        if (discDetail.indexOf('<p>') !== 0) {
            // if our detail text isn't contained in a <p> </p> element, add one around the first paragraph only
            if (discDetail.indexOf('<p>') === -1) {
                discDetail = '<p>' + discDetail + '</p>';
            } else {
                var segments = discDetail.split('<p>');
                discDetail = '<p>' + segments.shift() + '</p>' + segments.join('<p>');
            }
        }
        return discDetail;
    }

})(jQuery, FD.Brand.lodash, FD.Brand);


/*global FD*/
;(function (win, $, brand, overlay, ctx) {

    var ovr;
    var messageData;

    brand.setInitHandler('[data-fgx-send-to-phone-overlay]', init);

    //////

    function init(components) {
        ovr = overlay.register('sendToPhoneOverlay', components);
        var ovrShow = ovr.show;
        ovr.show = function(data, $triggerEl) {
            messageData = data;
            ovrShow(true, $triggerEl, 'input');
            
        };

        $('.icon-closer', components).on('click', function() {
            ovr.hide();
            resetForm(components);
        });
        $('form', components).submit(submitForm);
        //$('[name="number"]', components).fordPhoneInput();
    }
    
    function resetForm(components) {
        components.find('.error').hide();
        components.find('.success').hide();
        components.find('form').show();
        components.find('.phone-disclaimer').show();
        components.find('input[type=phone]').val('');
    }

    function submitForm(ev) {
        ev.preventDefault();
        var $form = $(this);
        // get form data
        var originalNumber = $form.find('[name="number"]').val();
        var parsedNumber = originalNumber.replace(/\D/g, '').replace(/^1/g, '');
        var carrier = $.trim($form.find('[name="carrier"]').val());
        var fromAddress = $form.data('from-address');
        var mtxAction = $form.data('send-complete-action');
        if (fromAddress == undefined) fromAddress = 'lcdealer@ford.com';
        var errorField; 
        // check for errors
        $form.find('.errors').stop(true, false).slideUp('fast', function onSlideUpComplete(event) {
            $form.find('.error').stop(true, false).hide();
        });
        if(!parsedNumber || parsedNumber.length !== 10 || !originalNumber.match(/^[0-9 \-()]+$/)) {
            errorField = 'number';
        }
        else if (!carrier || carrier === '?') {
            errorField = 'carrier';
        }

        if(errorField) {
            // show errors
            $form.find('.errors').stop(true, true).show()
                .find('.error.' + errorField).slideDown();
        } else {
            // submit data
            var postData = {
                to: parsedNumber + '@' + carrier,
                from: fromAddress,
                fromDisplayName: fromAddress,
                template: 'lad',
                data: JSON.stringify(messageData),
                html: false
            };
            $.post(
                ctx.settings['mailSendUrl' + ctx.make] + '/core-services/mail/send',
                postData
            );
            $form.add('p', $form.parent()).hide();
            $form.parent().find('.success').slideDown('fast', function () {
                setTimeout(function () {
                    ovr.hide();
                    resetForm($('[data-fgx-send-to-phone-overlay]'));
                }, 1000);
            });

            // new metrics
            if (typeof mtxAction != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    mtxAction
                );
            }
        }
    }

})(window, jQuery, FD.Brand, FD.Brand.Overlay, FD.Brand.Context);

;(function (win, $, brand, util, user) {

    brand.setInitHandler('[data-fgx-quick-search]', init);

    //////

    function init(components) {
        var subheadlineHtml = $('.fgx-brand-subheadline', components).html() + " " + brand.Pricing.postalLink();
        $('.fgx-brand-subheadline', components).html(subheadlineHtml);
        
        var yearFieldPlaceholder = $('#qsMinYear', components).attr('placeholder');

        components.each(function() {
            var $makeDropDown = $(this).find('.fgx-brand-select-container.make-dropdown'),
                dropdownId = $makeDropDown.attr('data-dropdown-id');
            updateSelected($makeDropDown, dropdownId);
        });
        
        $('#qsMinYear', components).on('focus', yearFieldFocus);
        $('#qsMaxYear', components).on('focus', yearFieldFocus);
        $('#qsMinYear', components).on('blur', yearFieldBlur);
        $('#qsMaxYear', components).on('blur', yearFieldBlur);
        
        function yearFieldFocus(e) {
            var $el = $(this);
            if($el.val().length === 0) {
                $el.attr('placeholder', '');
            }
        }
        
        function yearFieldBlur(e) {
            var $el = $(this);
            if($el.val().length === 0 && typeof yearFieldPlaceholder !== 'undefined') {
                $el.attr('placeholder', yearFieldPlaceholder);
            }
        }

        $('.fgx-brand-select-container', components).on('change', function(ev) {
            var $el = $(this),
                dropdownId = $el.attr('data-dropdown-id');
            updateSelected($el, dropdownId);
        });

        $('.search-cta', components).on('click', function() {
            // Year Field Validation only if fields are present and values exist
            if ($('#qsMinYear', components).length > 0 || $('#qsMaxYear', components).length > 0) {
                var inputError = false;
                var curYear = new Date().getFullYear();
                var $minYear = $('#qsMinYear', components);
                var $maxYear = $('#qsMaxYear', components);
                
                if ($minYear.val() != null && $minYear.val() !== '') {
                    if (/^\d+$/.test($minYear.val()) === false || ($minYear.val() > 999 && $minYear.val() <= curYear) === false) {
                        inputError = true;
                        $minYear.css('border-color', 'red');
                    } else {
                        $minYear.attr('style', '');
                    }
                }
                
                if ($maxYear.val() != null && $maxYear.val() !== '') {
                    if (/^\d+$/.test($maxYear.val()) === false || ($maxYear.val() > 999 && $maxYear.val() <= curYear) === false) {
                        inputError = true;
                        $maxYear.css('border-color', 'red');
                    } else {
                        $maxYear.attr('style', '');
                    }
                }
                
                if (inputError) {
                    // show error text and return...
                    $('.error-text-year', components).removeClass('hidden');
                    return false;
                } else {
                    if (!$('.error-text-year', components).hasClass('hidden')) {
                        $('.error-text-year', components).addClass('hidden');
                    }
                }
                
            }

            var baseUrl = $(this).data('ctaLink');
            var $dropdownWrap = $(this).closest('.dropdown-wrap');
            $dropdownWrap.find('.fgx-brand-select-container').not('.hidden').each(function() {
                var $el = $(this),
                    id = $el.data('dropdownId'),
                    val = $el.val() || '';
                // we need to ensure we're replacing *all* instances of the placeholders - especially {make}
                baseUrl = baseUrl.split("{"+id+"}").join(val);
            });

            // Distance and priceHigh are removed for quick-search display type so they are not caught by the 'each' loop above.
            if($dropdownWrap.closest('.quick-search').data('displayType') === 'quick-search') {
                baseUrl = baseUrl.replace("{distance}", '');
                baseUrl = baseUrl.replace("{priceHigh}", '');
            }

            var yearLow = $dropdownWrap.find('.year-low').val() || '';
            var yearHigh = $dropdownWrap.find('.year-high').val() || '';
            baseUrl = baseUrl.replace("{yearLow}", yearLow);
            baseUrl = baseUrl.replace("{yearHigh}", yearHigh);
            baseUrl = baseUrl.replace("{zipCode}", (user.location.current().postalCode || ''));

            var qIndex = baseUrl.indexOf('?');
            if(qIndex >= 0) {
                var domain = baseUrl.substring(0, qIndex);
                var qs = baseUrl.substring(qIndex + 1);
                //Since this is authored we want to decode the string first to ensure it doesn't get encoded twice.
                qs = util.parameters.encode(util.parameters.decode(qs));
                baseUrl = domain + "?" + qs;
            }

            win.location = baseUrl;
        });

        function updateSelected($elm, dropdownId) {
            if (!$elm || $elm.length === 0 || !dropdownId) {
                return;
            }
            var newVal = $elm.val();
            if (newVal && dropdownId === 'make') {
                var $modelDropDowns = $elm.closest('.dropdown-wrap').find('[data-dropdown-id="model"]');
                $modelDropDowns
                    .val('')
                    .each(function() {
                        var $item = $(this);
                        $item.toggleClass('hidden', (($item.attr('data-make-id') || '') !== newVal));
                    });
            }
        }
    }
})(window, jQuery, FD.Brand, FD.Brand.Util, FD.Brand.User);
/*global FD*/
;(function (win, $, _, brand, overlay, ctx, user, util, ngp, dealerLib) {

    _.extend(brand.namespace('FD.Brand.DealerTrigger', win), {
        fireMetrics: fireMetrics,
        handleExtClick: handleExternalClick
    });

    var components;
    var cfg = null;
    var ctx = ctx;
    var templates = {};
    var ovr;
    var mapControlLoaded = false;
    var isInitialSearch = true;
    var searchIsGeo = false;
    var currentPostalCode = null;
    var currentSearchType = null;
    var currentSearchTerm = null;
    var dealerPageLink = null;
    var dealerDetailsPageLink = null;
    var mapWasExpanded = false;
    var salesOpenUntil = $('#dt').data('sales-open-until');
    var salesOpenAgain = $('#dt').data('sales-open-again');
    var hoursDisplayType = $('#dt').data('hours-displaytype');
    var postalLinkLabel = $('#dt').data('updateSearchLabel') || '';
    var dealerSearchAction = $('#dt').data('dealer-search-action');
    var starsAriaLabelTmpl = '';
    var dealerIdxAriaLabelTmpl = '';
    if (hoursDisplayType === undefined || hoursDisplayType === '') hoursDisplayType = '12';
    var base64Img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAuCAYAAACiR6CHAAACz0lEQVRYhc2ZW4hOURTHf98ZTJghNUxqah5MubyY5k2KJjU15VJ4MDLkAbmkqcmDlBceKA9KStFEJhEy4cGLB16Y4nMNoxTj0mDCiHIZl5bWqc+Zfc7sc853Lv+X0zlnf2v92t/ae6+1TmH8nBZCaAowC1gMzANmAjXAOOAHMAj0ATeAy8AT4KOteVsYcboEWAPMDQF/D+gGLilkLJhJQAewFZgWAsKrd8Bh4CDw2W9QxdipM/zezQfOAm3AxBgg6O+bgVbgIfDSNMjx+bEAXAEaY0J41ah220wvxxierQZOBoDGVZXGUQE4VWrL63AR0JUgSKnfLvVnhKkDjgCVCYO4qlR/dSaYnUBDSiCuGtTvfzBNQHvKIK7a1f8/GAmkdUB1RjDV6r8gMLW6grKU+K91dDOqyRhG/Dc7uivmQa2OGzw5UJPA1OcEpt7R7TkPqhKY4ZzADAvMpxyAiIYE5mkOQER9juaredBNgenJCUyPwNwB7mYMIgxFgfkKHM8Y5oRwuCnEGeBVRiDi9zQl+cwAsCcjmL3AWzyZ3jHgQsogsniOujelML+BzSkGcxHYqH5HwKDTtRK4nzDIA2AF8L70oakkeQa0JLgZFtX+c+8Lv/pIZmgpcL3MIDLjy3XBjFBQsTaoZWi5YugFsEqvRo1WOb4BlmmfJY4GdEYeB9mwKWP7tS9jnFoLfQc2aawEyramvg1si5iI7QAu2gwMU+CfBzpDguwHDtkODmoWmdQLTNZ+3mjq1o6XtaK0Pjotjo2rwIawhqPA/AG2B6yMfo2vb2nAoMf+euCL57kArI26FcTpUPUa/ootwLWoBsMGsFfSuawAFgL7gANxjJkajGG1G7hlu5ckATNbW2DSypigm2GHXoe0Cf3Ir99bLhj5RiDJ8wJguna9TPqpIJLb7rI1HjZmJCv7oIHvHg0SM3L/SyuN1/rNQJrP56zPNOAvcsOEpYeZCnAAAAAASUVORK5CYII=';
    var info = util.env.browser();
    var locationOptions = {};
    if(info.name === 'IE' && info.version == 11) {
        locationOptions = {
            enableHighAccuracy: false,
            maximumAge: 50000
        };
    }

    if (ctx.make === 'Lincoln') {
        base64Img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAuCAYAAACiR6CHAAACzUlEQVRYhc2ZS0gWURTHf98YCaFFIJog2EKoVsm3iyCSoBB60IPIyKJFRQ8ikAgRgqhFrVsUFFYUYVAk1aJNC9uUUF8vqAyCsgdWUgkFPezBiTMwjdf57v3G+Wb+m2FmLuf8uHPuveecyeUXLsFB04HZwFJgHjALqAEmAz+AYWAAuAVcA54Cn2zN28KI02XABmCuA/wD4BxwVSEjVVE/synq/VRgH3AMWAnMcABBxy8G1gJTgHvA9/EGexGG5gN9wAGg1hEirFq106d2nWDagOtAc0yIsJrVbpvp5STDs/XA2SKzFkdVGkc54HzQTtjhIqA7QZCg3271Z4RpAI4DlQmD+KpUfw0mmE4gcmkloCb1+x9MHmgvM4ivdvX/D0YCaRNQnRJMtfrPCUydrqA0Jf7rBKZFz5c0Jf5bBKY1ZRBfrZ4fPBlQXmAaMwLT6On2nAVVCcxoRmBGBeZzBkBEIwLzLAMgogFP89Us6LbA9GYEptfTvPR+yiDCUBCYr8DplGHOCIefQlwAXqcEIn57COQzQ8DBlGAOAe8IZXongctlBpHFc8K/CcL8BraXMZgLwFb1OwYGna41wMOEQR4Bq4EPwYemkuS5lqRJbYYFtf8i/GK8+khmaDlwc4JBZMZX6YIZo6hibVjL0ImKoZfAOr0aVaxyfAus0D5LHA3pjDyJsmFTxg5qX8Y4tRaSFsg2jZVI2dbUd4FdJSZie4ErNgNdCvxLQIcjyBHgqO3gYp2rsPqBadrPKyZpe+x0MV5K66PD4ti4AWxxNVwKzB9gd8TKGNT4+lYOGPTY3wx8CT0XgI2lbgVxOlT9hk+xQ5uIJSluu6wnkAcdBk7FMWZqMLpqP3DHdi9JAmaOtsBqtNksm+EevY4A74HHwKskYeQfgSTPC4B67XqZ9FNB5DN22Rp33fQkK/uoseYfDRV6/0srjTf6z0CazxetzzTgL19PhJLYv4FpAAAAAElFTkSuQmCC';
    }

    brand.setInitHandler('[data-fgx-locate-dealer-trigger]', init);

    //////

    function init(newComponents, brandUrl) {

        components = newComponents;
        cfg = dealerLib.getDealerConfig();

        if(components.length === 0 || cfg == null || _.isEmpty(cfg)) {
            return;
        }
        dealerDetailsPageLink = cfg.dealerDetailPageUrl;
        dealerPageLink = $('.dealer-mini').data('moredealershref');
        if (dealerPageLink === '' || dealerPageLink == null || dealerPageLink == undefined) {
            dealerPageLink = (brandUrl || ctx.settings.synBaseUrl || '') + (ctx.settings.sitePath || '') + 'dealerships' +
                (win.location.pathname.substr(win.location.pathname.length - 5) === '.html' ? '.html' : '/');
        }

        if (dealerDetailsPageLink === '' || dealerDetailsPageLink == null || dealerDetailsPageLink == undefined) {
            dealerDetailsPageLink = (brandUrl || ctx.settings.synBaseUrl || '') + (ctx.settings.sitePath || '') + 'dealer-details' +
                (win.location.pathname.substr(win.location.pathname.length - 5) === '.html' ? '.html' : '/');
        }

        starsAriaLabelTmpl = components.attr('data-stars-aria-label-tmpl') || '';
        dealerIdxAriaLabelTmpl = components.attr('data-dealer-index-aria-label-tmpl') || '{index} {dealerName}';

        components.each(function(idx) {
            var $el = $(this);
            var $overlayEl = $('.trigger-update-zip', $el);
            var id = 'fgxDealerTriggerOverlayDesc' + idx;
            $('.trigger-update-zip .body', $el).append($('.location-unaware', $el).clone());
            $overlayEl.find('.location-unaware > .fgx-brand-lt-h3').attr('id', id);
            $overlayEl.attr('aria-describedby', id);
            // BRAND-14396 - add logic to prevent the id of the type ahead flyout from being duplicated when used in the overlay.
            var typeAheadId = 'fgx-brand-dealerTriggerTypeAheadResults' + idx;
            var resultsHeaderId = 'fgx-brand-dealerTriggerTypeAheadResultsHeader' + idx;
            var $searchWrap = $overlayEl.find('.search-wrap');
            $searchWrap.find('.fgx-dealer-search-input').each(function() {
                $(this).attr('aria-owns', typeAheadId);
            });
            $searchWrap.find('.type-ahead-results > .header').attr('id', resultsHeaderId);
            $searchWrap.find('.type-ahead-results > .list-unstyled').attr('id', typeAheadId).attr('aria-labelledby', resultsHeaderId);
            var elements = 'a:visible, input:text:visible, button:visible, [data-fgx-keypress]:visible';
            ovr = overlay.register('triggerUpdateZipOverlay', $('.trigger-update-zip', $el), {}, elements);
        });

        components.on('click', '.location-unaware .search-options input', selectSearchOption);
        components.on('click', '.location-unaware .search-options .txt-label', function(ev){
            $(this).closest('label.radio').find('input').trigger('click');
        });
        components.on('focusin focusout keyup', '.location-unaware .search input', updateSearchTextState);
        /*components.on('keydown', '.location-unaware .search input', function(ev){
            if (ev.which === 40 && ($(this).attr('aria-expanded') === 'true' || $(this).attr('aria-expanded') === true)) {
                var $resultsContainer = componentElement(this, '.type-ahead-results ul');
                // focus on the very first type-ahead result item
                var firstItem = $resultsContainer.find('li').first();
                firstItem.focus();
            }
        });*/
        components.on('click', '.search-submit', searchSubmit);
        components.on('click', '.search-clear', function() {
            var srch = getSearchData.call($(this));
            srch.$txt.val('').focus();
        });

        components.on('click', '.details .actions .view-map a', function(ev) {
            ev.preventDefault();
            setDealerExpanded.call(this, null);
        });

        components.on('click', '.details .actions .send-phone a', sendToPhone);
        components.on('click', '.dealers .collapse-icon span', function() {
            setDealerExpanded.call(this, false);
        });
        components.on('click', '.geo .btn', getCurrentPosition);
        components.on('click', '.type-ahead-results li', function() {
            var $el = $(this);
            var srch = getSearchData.call($el);
            var txtVal = $el.text();
            var $resName = $el.find('.result-name');
            var $paCode = $el.data('pacode');
            if($resName.length) {
                txtVal = $resName.text();
            }
            srch.$txt.val(txtVal);
            if ($paCode != null) {
                paCodeSubmit.call($el, $paCode);
            } else {
                searchSubmit.call($el);
            }
        });
        
        components.on('click', '.js-postal-link', function(ev) {
            ev.preventDefault();
            $('.trigger-update-zip .location-unaware', components).show();
            ovr.show(true, $(this), '.radio .txt-label');
            var isExpanded = !componentElement(this, '.location-aware').hasClass('collapsed');
            if (isExpanded) {
                mapWasExpanded = true;
                $('.dealers .collapse-icon span').trigger('click');
            } else {
                mapWasExpanded = false;
            }

            if (currentSearchType === 'dealerName') {
                $(":radio[value=dealer]", components).each(function() {
                    $(this).trigger("click");
                });
            }else{
                $(":radio[value=location]", components).each(function() {
                    $(this).trigger("click");
                });
            }
        });
        components.on('click', '.trigger-update-zip .close-flip', function() {
            ovr.hide();
            if (util.currentBreakpoint() === 'gux-bkpt-sm') {
                window.location.hash = 'dt';
                resetFocus();
            }
        });

        $('script[data-fgx-locate-dealer-trigger-template-id]').each(function(idx, tmpl) {
            //console.log(tmpl.innerHTML);
            var $tmpl = $(tmpl);
            templates[$tmpl.attr('data-fgx-locate-dealer-trigger-template-id')] = _.template(tmpl.innerHTML);
        });

        if(FD.Brand.Util.env.geoLocation()) {
            var coordinates = user.location.coordinates();
        }

	    user.location.subscribe(updatePostalCodeState);
        updatePostalCodeState();

    }

    /**
     * Helper method for the info-boxes on the map to call their metrics events.  Scoped to FD.Brand.DealerTrigger
     **/
    function fireMetrics(event) {
        var action = $(event.currentTarget).attr('data-fd-metrics-click');
        if (typeof action != 'undefined') {
            FD.Brand.Metrics.handler.direct(
                action
            );
        }
    }

    /**
     * Helper method for the info-boxes on the map to trigger the exitOverlay logic within the simple choice overlay list when necessary.
     */
    function handleExternalClick(ev) {
        if (cfg && cfg.hasExitOverlay) {
            var externalId = cfg && cfg.exitOverlayId || '';
            if (brand.Link && !_.isEmpty(brand.Link.exitOverlays) && brand.Link.exitOverlays[externalId]) {
                try {
                    brand.Link.exitOverlays[externalId].externalUrl.call(this, ev, true);
                } catch(e) {
                    brand.Util.log('locateDealerTrigger::handleExternalClick - error occurred trying to trigger the external overlay. ', e);
                }
            }
        }
    }

    function setLocationState(aware) {
        $('.location-aware', components).toggle(aware);
        $('.location-unaware', components).toggle(!aware);
    }

    function setDealerExpanded(expanded) {
        var $cnt = componentElement(this, '.location-aware');
        var $dlr = $('.dealers', $cnt);
        var $mapToggle = $('.closest-dealer .actions .view-map a', $cnt);
        var isExpanded = !$cnt.hasClass('collapsed');
        if(expanded == null) {
            expanded = !isExpanded;
        }
        if(expanded === isExpanded) {
            return;
        }
        if(expanded) {
            $dlr.slideDown().attr('aria-hidden', 'false');
            $cnt.removeClass('collapsed');
            $mapToggle.attr('aria-expanded', 'true');
            $('.view-map', $mapToggle).hide();
            $('.close-map', $mapToggle).show();
            createMap.call(this);
        } else {
            $dlr.slideUp().attr('aria-hidden', 'true');
            $cnt.addClass('collapsed');
            $mapToggle.attr('aria-expanded', 'false');
            $('.view-map', $mapToggle).show();
            $('.close-map', $mapToggle).hide();
        }
    }

    function componentElement(el, selector) {
        var $el = $(el).closest('[data-fgx-locate-dealer-trigger]');
        if(selector) {
            $el = $el.find(selector);
        }
        return $el;
    }

    function selectSearchOption() {
        var $el = $(this);
        var opt = $el.val();
        var $cnt = componentElement($el, '.location-unaware');
        var $input = $('.search .search-text-' + opt, $cnt);
        var $closestTypeAheadResults = $el.closest('.location-unaware').find('.type-ahead-results');
        dealerLib.updateSearchHints($closestTypeAheadResults, getSearchData.call(this), $input, componentElement(this, '.search-suggestions-info'), true);
        var $parent = $el.parent();
        var $labels = $parent.closest('.search-options').find('label');
        $labels.removeClass('selected').find('.txt-label').attr({'aria-checked': 'false', 'tabindex': '-1'});
        $parent.addClass('selected').find('.txt-label').attr({'aria-checked': 'true', 'tabindex': '0'}).focus();
        $('.search-wrap .search', $cnt).toggleClass('show-location', opt === 'location');
        $('.search input', $cnt).hide();
        $input.show();
    }

    function updateSearchTextState(ev) {
        if (ev.type === 'focusin') {
            ev.preventDefault();
            if (util.currentBreakpoint() === 'gux-bkpt-sm') {
                window.location.hash = '';
            }
        }

        var focus = ev.type !== 'focusout';
        var $txt = $(this);
        var val = $txt.val();
        var hasValue = val.length > 0;
        var $cnt = componentElement($txt, '.location-unaware');
        var $closestTypeAheadResults = $txt.closest('.location-unaware').find('.type-ahead-results');
        setTimeout(function() {
            // in timeout to allow clicks to propagate and focus to transfer
            var active = $(document.activeElement);

            $('.search-action', $cnt).toggle(!hasValue);
            if (!active.hasClass('search-submit')) {
                $('.search-submit', $cnt).toggle(focus && hasValue);
                $('.search-clear', $cnt).toggle(!focus && hasValue);
            } else {
                $('.search-submit', $cnt).one('focusout', function() {
                    $('.search-submit', $cnt).toggle(focus && hasValue);
                    $('.search-clear', $cnt).toggle(!focus && hasValue);
                });
            }

            if (!active.hasClass('geo')) {
                $('.geo', $cnt).toggle(FD.Brand.Util.env.geoLocation() && focus);
            } else {
                $('.geo', $cnt).one('focusout', function() {
                    $('.geo', $cnt).toggle(FD.Brand.Util.env.geoLocation() && focus);
                });
            }
        }, 150);
        if(ev.type === 'keyup') {
            if(ev.keyCode === 13) {
                searchSubmit.call($txt);
            } else if (ev.keyCode === 40) {
                // if we're the 'down' arrow and our search suggestions are populated and visible...
                // BRAND-12331
                if ($txt.hasClass('fgx-list-shown')) {
                    var $resultsContainer = $('.type-ahead-results:visible', $cnt).find('ul');
                    // focus on the very first type-ahead result item
                    var firstItem = $resultsContainer.find('li').first();
                    firstItem.focus();
                }
            } else {
                dealerLib.updateSearchHints($closestTypeAheadResults, getSearchData.call(this), $txt, componentElement(this, '.search-suggestions-info'));
            }
        }
    }

    function getSearchData() {
        var $cnt = componentElement($(this), '.location-unaware');
        var $txt = $('.search input:visible', $cnt);
        return {
            $txt: $txt,
            val: $txt.val(),
            isDealer: $txt.hasClass('search-text-dealer')
        };
    }

    function paCodeSubmit(paCode) {
        var $cnt = componentElement(this, '.location-unaware');
        var srch = getSearchData.call($cnt);
        var params = {
            make: ctx.make,
            dealerPACode: paCode
        };
        currentSearchType = 'dealerName';
        currentSearchTerm = srch.val;
        user.location.setGeoPACode(null);
        setBusy.call($cnt, true);
        getDealer.call($cnt, params).done(function() {
            setBusy.call($cnt, false);
            setLocationState(true);
            ovr.hide();
            srch.$txt.toggleClass('fgx-list-shown', false);//BRAND-12331
            srch.$txt.removeAttr('aria-activedescendant');
            if (util.currentBreakpoint() === 'gux-bkpt-sm' && window.location.hash !== 'dt') {
                window.location.hash = 'dt';
            }
            resetFocus();
            // clear out search error if successful - NGBS3-5841
            searchError();

            // new metrics call
            if (typeof dealerSearchAction != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    dealerSearchAction
                );
            }
        }).fail(function(resp) {
            setBusy.call($cnt, false);
            updateError(resp, isPostal);
        });
    }

    function searchSubmit() {
        var $el = $(this);
        var $cnt = componentElement(this, '.location-unaware');
        var srch = getSearchData.call($cnt);
        var $input = (srch.isDealer) ? $('.search .search-text-dealer', $cnt) : $('.search .search-text-location', $cnt);
        var isPostal = false;
        var stateRegex = /^[a-zA-Z]{2}$/g;
        var params = {
            make: ctx.make,
            radius: 50,
            minDealers: 1,
            maxDealers: 1
        };
        var $closestTypeAheadResults = $el.closest('.location-unaware').find('.type-ahead-results');
        dealerLib.updateSearchHints($closestTypeAheadResults, getSearchData.call(this), $input, componentElement(this, '.search-suggestions-info'), true);
        if(!srch.val) {
            searchError(null, srch.isDealer ? 'required-dealer' : 'required-location');
            return;
        }
        // validate value
        if(srch.isDealer) {
            params.dealerName = srch.val;
        } else {
            if ((/^(?=.*[a-zA-Z])(?=.*[0-9])/.test(srch.val)) || (/\d+/.test(srch.val))) {
                if (!(new RegExp(cfg.validationZipCode)).test(srch.val)) {
                    searchError(4);
                    return;
                }
                params.postalCode = srch.val;
                isPostal = true;
            } else {
                if (!/^[A-Za-z.,\-\' ]+$/.test(srch.val)){
                    searchError(7);
                    return;
                }

                if (srch.val.indexOf(',') < 0) {
                    if (dealerLib.isFullStateName(srch.val) || stateRegex.test(srch.val)) {
                        params[ctx.region === 'CA' ? 'province' : 'state'] = srch.val;
                    } else {
                        params.city = srch.val;
                    }
                } else {
                    var val = srch.val.split(',');
                    params.city = (val[0] || '').trim();
                    if (val.length > 1) {
                        params[ctx.region === 'CA' ? 'province' : 'state'] = (val[1] || '').trim();
                    }
                }
            }
        }
        // set flags for user message text
        currentSearchType = (srch.isDealer) ? 'dealerName' : 'location';
        currentSearchTerm = srch.val;

        if(isInitialSearch) {
            _location = user.location.current();
            if(_location && _location.geoPACode) {
                params.prefDealerPACode = _location.geoPACode;
            }
            isInitialSearch = false;
        }

        if (searchIsGeo) {
            searchIsGeo = false;
            if(srch && srch.$txt && srch.$txt.length > 0) {
                var paCode = srch.$txt.attr('data-geo-pa-code') || '';
                if(paCode) {
                    params.prefDealerPACode = paCode;
                    srch.$txt.removeAttr('data-geo-pa-code');
                }
            }
        }

        setBusy.call($cnt, true);
        getDealers.call($cnt, params).done(function() {
            setBusy.call($cnt, false);
            if(isPostal) {
                currentPostalCode = params.postalCode;
                user.location.setPostalCode(currentPostalCode, (params && params.prefDealerPACode || ''));
            }
            setLocationState(true);
            ovr.hide();
            srch.$txt.toggleClass('fgx-list-shown', false);//BRAND-12331
            srch.$txt.removeAttr('aria-activedescendant');
            if (util.currentBreakpoint() === 'gux-bkpt-sm' && window.location.hash !== 'dt') {
                window.location.hash = 'dt';
            }
            resetFocus();
            // clear out search error if successful - NGBS3-5841
            searchError();

            // BRAND-6358 - blur input to allow for soft mobile keyboards to close
            $input.blur();

            // new metrics call
            if (typeof dealerSearchAction != 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    dealerSearchAction
                );
            }
        }).fail(function(resp) {
            setBusy.call($cnt, false);
            updateError(resp, isPostal);
        });
    }

    function getDealers(params) {
        var $wrapper = componentElement(this);
        var $cnt = componentElement(this, '.location-aware');
        var def = $.Deferred();
        var _api = ['dealers'],
            _promises = [],
            _errors = [],
            _dealers = [];

        var onGetDealersSuccess = function(dealers) {
            if(!dealers || dealers.length === 0) {
                var errorData = {
                    message: "[locateDealerTrigger - getDealers] - no dealers were returned."
                };
                _errors.push(errorData);
                return;
            }
            if(ctx.region === 'CA') {
                dealers.map(function(dealer) {
                    return dealer.Distance = dealer.DistanceKM;
                });
            }
            _dealers.push(dealers);
        }

        var onGetDealersError = function(response) {
            var resp = (response && response.Response) ? response.Response : {};
            var errorData = {
                message: resp.Message || resp.Error || '[locateDealerTrigger - getDealers] - error retrieving the dealers'
            };
            _errors.push(errorData);
        }

        _.each(_api, function(method) {
            var promise = ngp[method](params);
            promise.then(
                onGetDealersSuccess,
                onGetDealersError
            );
            _promises.push(promise);
        });

        $.when.apply($, _promises).done(function() {
            if(_api.length === _errors.length) {
                //There were errors for all method calls.
                _.each(_errors, function(err) {
                    if(err.message) {
                        def.reject(err.message);
                    }
                });
            } else {
                var dealers = processDealers(_dealers, $cnt);
                def.resolve(dealers);
            }
        }).fail(function(resp) {
            def.reject(resp);
        });

        return def.promise();
    }

    function getDealer(params) {
        var $cnt = componentElement(this, '.location-aware');
        var def = $.Deferred();
        ngp.dealer(params).done(function(dealer) {
            if(!dealer || dealer.length === 0) {
                def.reject(dealer);
                return;
            }

            var mobList = $('.carousel-inner', $cnt);
            
            var idx = 0; // we will only ever have one dealer from a PA Code Search
            mobList.empty();
            
            dealer = dealerLib.updateDealer(dealer, idx, salesOpenUntil, salesOpenAgain, null, dealerDetailsPageLink, hoursDisplayType);
            dealer.starsAriaLabel = starsAriaLabelTmpl.replace('{starCount}', dealer.combinedRating || '').replace('{dealerName}', dealer.Name || '').replace('{totalReviews}', dealer.combinedRatingsCount || '');
            dealer.idxAriaLabel = dealerIdxAriaLabelTmpl.replace('{index}', (dealer.index + 1)).replace('{dealerName}', dealer.Name || '');
            var prm = { dealer: dealer, cfg: cfg, isFord: (ctx.make==='Ford') };
            $('.closest-dealer', $cnt).html(templates.desktopClosest(prm)).data('dealer', dealer);
            dealer.selected = true;
            $(templates.mobileSlide(prm)).appendTo(mobList).data('dealer', dealer);
            
            // hide distance
            $('.info .distance').hide();
            $cnt.data('dealers', [dealer]);
            
            var map = $cnt.data('map');
            if(map) {
                map.dispose();
                $cnt.data('map', null);
            }
            if (mapWasExpanded) {
                $('.details .actions .view-map a', $cnt).trigger('click');
            }
            updatePostalCodeState();
            def.resolve(dealer);
        }).fail(function(resp) {
            def.reject(resp);
        });
        return def.promise();
    }

    function processDealers(_dealers, $cnt) {
        var mobList = $('.carousel-inner', $cnt);
        
        mobList.empty();
        
        var dealers = [];
        if(_dealers.length > 1) {
            _.each(_dealers, function(dealerList) {
                dealers = dealers.concat(dealerList);
            });
        } else if(_dealers.length === 1) {
            dealers = _dealers[0];
        }

        // we need to sort by distance here to account for combination of dealers and independent body shops
        dealers = _.sortBy(dealers, function(dealer) {
            var dist = 1.0;
            if(dealer && dealer.Distance) {
                dist = parseFloat(dealer.Distance);
            }
            return dist;
        });
        
        if(dealers.length > 1) {
            dealers = dealers.slice(0, 1);
        }

        var firstDealerDistance = (dealers[0] !== null && dealers[0].Distance !== null) ? parseInt(dealers[0].Distance) : null;
        if(firstDealerDistance && (firstDealerDistance > 50)) {
            dealers = dealers.slice(0,1);
        }

        _.each(dealers, function(dealer, idx) {
            dealer = dealerLib.updateDealer(dealer, idx, salesOpenUntil, salesOpenAgain, null, dealerDetailsPageLink, hoursDisplayType);

            if(dealer.URL && !_.isEmpty(dealer.URL)) {
                dealer.URL = dealerLib.appendT3QS(dealer.URL, dealer.mtAttrQS);
            }

            dealer.starsAriaLabel = starsAriaLabelTmpl.replace('{starCount}', dealer.combinedRating || '').replace('{dealerName}', dealer.Name || '').replace('{totalReviews}', dealer.combinedRatingsCount || '');
            dealer.idxAriaLabel = dealerIdxAriaLabelTmpl.replace('{index}', (dealer.index + 1)).replace('{dealerName}', dealer.Name || '');

            var prm = { dealer: dealer, cfg: cfg, isFord: (ctx.make==='Ford') };
            if(idx === 0) {
                $('.closest-dealer', $cnt).html(templates.desktopClosest(prm)).data('dealer', dealer);
                dealer.selected = true;
            } 
            $(templates.mobileSlide(prm)).appendTo(mobList).data('dealer', dealer);
        });
        if (currentSearchType === 'dealerName') {
            // hide distance
            $('.info .distance').hide();
        }
        $cnt.data('dealers', dealers);
        
        var map = $cnt.data('map');
        if(map) {
            map.dispose();
            $cnt.data('map', null);
        }
        if (mapWasExpanded) {
            $('.details .actions .view-map a', $cnt).trigger('click');
        }
        updatePostalCodeState();
        return dealers;
    }

    function getCurrentPosition() {
        var $cnt = componentElement(this);
        var err = function() {
            setBusy.call($cnt);
            searchError.call($cnt, 5, null);
        };
        setBusy.call($cnt, true);
        win.navigator.geolocation.getCurrentPosition(function(position) {
            if(position && position.coords) {
                ngp.dealers({
                    make: ctx.make,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    radius: 50,
                    minDealers: 1
                }).done(function(resp) {
                    if(resp && resp.length > 0) {
                        searchIsGeo = true;
                        var srch = getSearchData.call($cnt);
                        srch.$txt.val(resp[0].Address.PostalCode);
                        srch.$txt.attr('data-geo-pa-code', resp[0].PACode);
                        setBusy.call($cnt);
                        searchSubmit.call($cnt);
                    } else {
                        err()
                    }
                });
            } else {
                err()
            }
        }, err, locationOptions);
    }

    function updatePostalCodeState() {
        var newLocation = user.location.current();
        var newPostalCode = newLocation.postalCodeSource === 'FPI' && newLocation.postalCode || '';
        var queryDelimiter = 'q';

        if (currentSearchType === 'dealerName') {
            $('.dealer-name-label', components).show();
            $('.location-label', components).hide();
            queryDelimiter = 'qn';
        } else {
            $('.dealer-name-label', components).hide();
            $('.location-label', components).show();
        }
        if (currentSearchTerm != null && currentSearchTerm != undefined) {
            $('.js-postal-code', components).text(currentSearchTerm).attr('aria-label', postalLinkLabel + ' ' + currentSearchTerm);
            $('.js-postal-link', components).attr('aria-label', postalLinkLabel + ' ' + currentSearchTerm);
            $('.more-dealers a', components).attr('href', dealerPageLink + '#/' + queryDelimiter + '/' + currentSearchTerm);
        } else if (newPostalCode !== '') {
	        $('.js-postal-code', components).text(newPostalCode).attr('aria-label', postalLinkLabel + ' ' + newPostalCode);
	        $('.js-postal-link', components).attr('aria-label', postalLinkLabel + ' ' + newPostalCode);
	        $('.more-dealers a', components).attr('href', dealerPageLink + '#/' + queryDelimiter + '/' + newPostalCode);
        } else if (newLocation.postalCodeSource !== 'FPI') {
            $('.js-postal-code', components).text(newLocation.postalCode || '').attr('aria-label', postalLinkLabel + ' ' + (newLocation.postalCode || ''));
            $('.js-postal-link', components).attr('aria-label', postalLinkLabel + ' ' + (newLocation.postalCode || ''));
	        $('.search-text-location', components).val(newLocation.postalCode || '');
        } else {
            $('.js-postal-code', components).text(currentPostalCode).attr('aria-label', postalLinkLabel + ' ' + currentPostalCode);
            $('.js-postal-link', components).attr('aria-label', postalLinkLabel + ' ' + currentPostalCode);
            $('.more-dealers a', components).attr('href', dealerPageLink + '#/' + queryDelimiter + '/' + currentPostalCode);
        }
        if(newPostalCode) {
            if(newPostalCode !== currentPostalCode) {
                currentPostalCode = newPostalCode;
                var params = {
                    make: ctx.make,
                    radius: 50,
                    minDealers: 1,
                    maxDealers: 1,
                    postalCode: newPostalCode
                };

                if(isInitialSearch) {
                    if(newLocation.geoPACode) {
                        params.prefDealerPACode = newLocation.geoPACode;
                    }
                    isInitialSearch = false;
                }

                getDealers.call(components, params).done(function() {
                    setLocationState(true);
                });
            }
        } else if (currentSearchTerm == null || currentSearchTerm == undefined) {
            setLocationState(false);
        }

        if(isInitialSearch) {
            isInitialSearch = false;
        }
    }

    function setBusy(isBusy) {
        $(this).find('.ford-busy').toggle(isBusy);
    }

    function resetFocus() {
        var dispSelector = (util.currentBreakpoint() === 'gux-bkpt-sm') ? '.fgx-mobile' : '.fgx-desktop';
        components.find(dispSelector + ' .postal-focus-elem').focus();
    }

    function updateError(resp, isPostal) {
        var errKey = 2;
        if(isPostal) {
            if(resp && resp.responseJSON && resp.responseJSON.Response) {
                var msg = resp.responseJSON.Response.Message;
                errKey = (msg.indexOf("Invalid Postal Code") > -1) ? 4 : 2;
            } else if (resp === '[locateADealer - getDealers] - no dealers were returned.') {
                errKey = 2;
            } else {
                errKey = 1;
            }
        }
        searchError(errKey);
    }

    function searchError(err, cls) {
        var $el = $('.location-unaware .message.error', components);
        $el.find('.text').hide();
        if(cls) {
            $el.find('.text.' + cls).show();
            $el.show();
            return;
        }
        if(err) {
            $el.find('.text.error').show().text(cfg.errors[err]);
            $el.show();
            return;
        }
        $el.hide();
    }

    function loadMapControl() {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            if(mapControlLoaded) {
                def.resolve();
            } else {
                win._fgx_mapControlLoaded = function() {
                    mapControlLoaded = true;
                    def.resolve();
                    delete win._fgx_mapControlLoaded;
                };
                util.url.loadAsScript(ctx.settings.mapHost + '?callback=_fgx_mapControlLoaded')
                    .fail(function() {
                        def.reject();
                    });
            }
        } else {
            util.log('locate dealer trigger: Microsoft Map library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    function createMap() {
        var $cnt = componentElement(this, '.location-aware');
        var map = $cnt.data('map');
        var dealers = $cnt.data('dealers');

        if(map || !dealers) {
            return;
        }
        loadMapControl().done(function() {
            var mapApi = Microsoft.Maps;
            map = new mapApi.Map(
                $cnt.find('.map')[0], {
                    credentials: ctx.settings.mapKey,
                    mapTypeId: Microsoft.Maps.MapTypeId.road,
                    enableSearchLogo: false,
                    enableClickableLogo: false,
                    enableInertia: true,
                    liteMode: false,
                    showCopyright: false,
                    showMapTypeSelector: false,
                    showLocateMeButton: false
                }
            );

            var locations = [];
            var center = null;
            var setDealerState = function(dealer, selected) {
                dealer.selected = selected;
                var entityState =  (selected) ? 'selected' : 'none';
                dealer.infobox.setOptions({
                    visible: selected,
                    state: entityState
                });
                dealer.pushpin.setOptions({
                    state: entityState,
                    icon: base64Img,
                    textOffset: new Microsoft.Maps.Point(0, 10)
                });

            };

            var setDealersAriaExpanded = function (selectedDealer) {
                _.each(dealers, function(dealer, index) {
                    if(index !== 0) {
                        if(dealer === selectedDealer) {
                            selectedDealer.$el.find(".index").attr("aria-expanded", "true");
                        } else {
                            dealer.$el.find(".index").attr("aria-expanded", "false");
                        }
                    }
                });
            };

            _.each(dealers, function(dealer) {
                var location = new mapApi.Location(dealer.Latitude, dealer.Longitude);
                locations.push(location);
                if(dealer.selected) {
                    center = location;
                }
                var infobox = new mapApi.Infobox(location, {
                    width: 300,
                    height: 240,
                    offset: new mapApi.Point(15, -100),
                    htmlContent: templates.infoContent({
                        dealer: dealer,
                        cfg: cfg,
                        isFord: (ctx.make==='Ford')
                    })
                });
                dealer.infobox = infobox;
                dealer.infobox.setMap(map);
                var pushpin = new mapApi.Pushpin(location, {
                    width: 35,
                    height: 46,
                    infobox: infobox
                });
                dealer.pushpin = pushpin;
                setDealerState(dealer, dealer.selected);
                var selectDealer = function() {
                    if(!dealer.selected) {
                        var selectedDealer = _.find(dealers, { selected: true });
                        if(selectedDealer) {
                            setDealerState(selectedDealer, false);
                        }
                        setDealersAriaExpanded(dealer);
                        setDealerState(dealer, true);
                        dealer.$el.one("keydown", function (event) {
                            if(event.which === 9) {
                                $(".dealer-infobox .name a").focus();
                            }
                        });
                        map.setView({
                            center: dealer.pushpin.getLocation()
                        });
                    } else {
                        // BRAND-15868: clicking on the map can hide the info box, so make sure we show it again even if we are selected
                        dealer.infobox.setOptions({
                            visible: true,
                            state: 'selected'
                        });
                    }

                };
                mapApi.Events.addHandler(pushpin, 'click', selectDealer);
                if(dealer.$el) {
                    dealer.$el.find('.index').click(selectDealer);
                }
                map.entities.push(pushpin);
            });
            // set map events
            mapApi.Events.addHandler(map, 'click', function(ev) {
                // hide infobox when clicking on map
                if (ev.targetType === 'map') {
                    var selectedDealer = _.find(dealers, { selected: true });
                    if(selectedDealer) {
                        selectedDealer.infobox.setOptions({
                            visible: false,
                            state: 'none'
                        });
                    }
                }
            });
            // set map bounds
            if(locations.length > 1) {
                map.setView({
                    bounds: mapApi.LocationRect.fromLocations(locations)
                });
            } else {
                map.setView({
                    center: locations[0],
                    zoom: 11
                });
            }
            if(center) {
                map.setView({
                    center: center
                });
            }
        });
    }

    function sendToPhone(ev) {
        ev.preventDefault();
        var dealer = $(this).closest('.closest-dealer').data('dealer');
        var dealerPhone = '';
        var _make = ctx && ctx.make || '';
        if(dealer && typeof(dealer) != 'undefined') {
            if (_make === 'Ford' && dealer.dlrcalltrk_lad && dealer.dlrcalltrk_lad !== '') {
                dealerPhone = dealer.dlrcalltrk_lad;
            } else if (_make === 'Lincoln' && dealer.ldlrcalltrk_lad && dealer.ldlrcalltrk_lad !== '') {
                dealerPhone = dealer.ldlrcalltrk_lad;
            } else {
                dealerPhone = dealer.Phone;
            }
        }

        overlay.instance.sendToPhoneOverlay.show({
            title: dealer.Name,
            text: dealer.AddressStreet + ' ' + dealer.AddressCityStateZip,
            phone: dealerPhone
        }, $(this));
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay, FD.Brand.Context, FD.Brand.User, FD.Brand.Util, FD.Brand.NgpServices, FD.Brand.Dealer);
/*global FD*/
;(function ($, brand, util, overlay, context) {

    var ovr;
    brand.setInitHandler('[data-fgx-ratings-info]', init);

    /////////////

    function init(components) {
        if(components.length === 0) {
            return;
        }
        ovr = overlay.register('dealerRatingsInfo', components);
        $('.icon-close', components).on('click', function() {
            ovr.hide();
        });
    }

})(jQuery, FD.Brand, FD.Brand.Util, FD.Brand.Overlay, FD.Brand.Context);


/*global FD*/
;(function (win, $, _, brand, overlay, ctx, user, util, ngp, dealerLib) {

    var components;
    var _lad = FD.Brand.Component && FD.Brand.Component.locateDealer;
    var _labels = {};
    var cfg = null;
    var templates = {};
    var dealers = [];
    var currentDealers = [];
    var dealersShown = 0;
    var includesIndependent = false;
    var hasPreferred = false;
    var preferredDealer = null;
    var initialPageLoad = true;
    var initialFirefoxReplace = false;
    var isInitialSearch = true;
    var ovr = {};
    var advancedSearchOvr = {};
    var isOwnerContext = false;
    var isBfnContext = false;
    var canToggleGeo = false;
    var hasDeeplink = false;
    var mapControlLoaded = false;
    var currentPostalCode = null;
    var currentSearchType = null;
    var currentSearchTerm = null;
    var currentRadius = null;
    var currentFilters = {
        ids: [],
        items: []
    };
    var serviceFilters = (_lad && typeof(_lad.serviceFilters) !== 'undefined') ? _lad.serviceFilters : [];
    var lastSearch = {
        searchTerm: '',
        radius: '',
        filter: ''
    };
    var _searchErrors = {};
    var searchIsGeo = false;
    var onLoadFiredOnce = false;
    var onLoadNoZipAction = $('.dealer-standard').data('dealer-no-zip-action');
    var dealerSearchAction = $('.dealer-standard').data('dealer-search-action');
    var dealerAdditionalSearchAction = $('.dealer-standard').data('dealer-additional-search-action');
    // default search type to location
    var dealerSearchType = 'manual search:location';
    var saveClickAction = $('.dealer-standard').data('save-click-action');
    var unsaveClickAction = $('.dealer-standard').data('unsave-click-action');
    // owner-specific click actions
    var onLoadNoZipActionOwner = $('.dealer-standard').data('dealer-no-zip-action-owner');
    var dealerSearchActionOwner = $('.dealer-standard').data('dealer-search-action-owner');
    var dealerAdditionalSearchActionOwner = $('.dealer-standard').data('dealer-additional-search-action-owner');
    var advancedSearchClickActionOwner = $('.dealer-standard').data('advanced-search-action-owner');
    var applyAdvancedSearchClickAction = $('.dealer-standard').data('apply-advanced-search-action');
    var applyAdvancedSearchClickActionOwner = $('.dealer-standard').data('apply-advanced-search-action-owner');
    var viewMoreClickActionOwner = $('.dealer-standard').data('view-more-click-action-owner');
    var viewMapClickActionOwner = $('.dealer-standard').data('view-map-click-action-owner');
    var backToListClickActionOwner = $('.dealer-standard').data('back-to-list-click-action-owner');
    var saveClickActionOwner = $('.dealer-standard').data('save-click-action-owner');
    var unsaveClickActionOwner = $('.dealer-standard').data('unsave-click-action-owner');
    var callClickActionOwner = $('.dealer-standard').data('call-click-action-owner');
    var textClickActionOwner = $('.dealer-standard').data('text-click-action-owner');
    var chatClickActionOwner = $('.dealer-standard').data('chat-click-action-owner');
    var ratingsInfoClickActionOwner = $('.dealer-standard').data('ratings-info-click-action-owner');
    var dealerDetailsClickActionOwner = $('.dealer-standard').data('dealer-details-click-action-owner');
    var dealerReviewsClickActionOwner = $('.dealer-standard').data('dealer-reviews-click-action-owner');
    var directionsClickActionOwner = $('.dealer-standard').data('directions-click-action-owner');
    var dealerWebsiteClickActionOwner = $('.dealer-standard').data('dealer-website-click-action-owner');

    var _websiteClickAction = $('.dealer-standard').data('dealer-website-click-action');
    var _detailsClickAction = $('.dealer-standard').data('dealer-details-click-action');

    var dealerDetailsPageLink = null;
    var salesOpenUntil = (FD.Brand.Component && FD.Brand.Component.locateDealer) ? FD.Brand.Component.locateDealer.labels.sales_open_until : '';
    var salesOpenAgain = (FD.Brand.Component && FD.Brand.Component.locateDealer) ? FD.Brand.Component.locateDealer.labels.sales_open_again : '';
    var detailAlwaysExpanded = (FD.Brand.Component && FD.Brand.Component.locateDealer) ? FD.Brand.Component.locateDealer.detailAlwaysExpanded : '';
    var hoursDisplayType = (FD.Brand.Component && FD.Brand.Component.locateDealer) ? FD.Brand.Component.locateDealer.hoursDisplayType : '';
    var hideIndependent = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.hideIndependentBodyShop !== 'undefined') ? FD.Brand.Component.locateDealer.hideIndependentBodyShop : 'false';
    var showScheduleService = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.showScheduleService !== 'undefined') ? FD.Brand.Component.locateDealer.showScheduleService : 'false';
    var showRequestService = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.showRequestService !== 'undefined') ? FD.Brand.Component.locateDealer.showRequestService : 'false';
    var hideTextOnOwner = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.hideTextOnOwner !== 'undefined') ? FD.Brand.Component.locateDealer.hideTextOnOwner : 'false';
    var hideChatOnOwner = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.hideChatOnOwner !== 'undefined') ? FD.Brand.Component.locateDealer.hideChatOnOwner : 'false';
    var hideDirectionsOnOwner = (FD.Brand.Component && FD.Brand.Component.locateDealer && typeof FD.Brand.Component.locateDealer.hideDirectionsOnOwner !== 'undefined') ? FD.Brand.Component.locateDealer.hideDirectionsOnOwner : 'false';

    var hideDealerWebsite;
    var dealerWebsiteLabel = '';
    var dealerWebsiteAriaLabel = '';
    var dealerWebsiteCtaTarget = '';
    var dealerDetailsAriaLabel = '';

    var base64Img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAuCAYAAACiR6CHAAACwUlEQVRYhc2ZX2hPYRjHP7+TTGtTSluraTcrXG3tTmq1lFr5U7gwGblA/qTVmkgpcTFXNClFQ6QpssyFGxdzg+LnX2FKGGlYmMi/hR49p46zd+f3nnN2/nzr1+l3ztvzfHrP877v8zyn4OwcIIRmAfOAJcACYC4wG5gO/ARGgSHgBnAFeAJ8tDVvCyNOlwJrgYYQ8PeBs8CAQgZqWonnM4EOYBtQFQLCVYP+uoCjwGHg82SDnQBDC4FBYF9EEK+q1M6g2g0F0wZcBRpjQvjVqHbbTA9Nr2kNcKbErMVRhcZRATjnteN3uAjoTRDE67dX/RlhaoFjQFnCIK7K1F+tCWY3UJ8SiKt69fsfTBPQnjKIq3b1/w9GAmk9UJkRTKX6LwhMta6gLCX+qwWmRc+XLCX+WwSmNWMQV62OGzw5UJPA1OUEps7R7TkPqhCY8ZzAjAvMpxyAiMYE5mkOQERDjuaredBNgenPCUy/wNwF7mUMIgxFgfkKnMoY5rRwuCnEeeB1RiDitw9PPjMC7M8I5gDwFl+mdwK4lDKILJ7j7h8vzG9gS4rBXAQ2qd8JMOh0rQIeJAzyEFgJvPfeNJUkz4DFCW6GRbX/wv9gsvpIZmgZcH2KQWTGV+iCmaCgYm1Uy9CpiqGXwGq9GlWqcnwDLNc+SxyN6Iw8DrJhU8YOa1/GOLUW+gFs1lgJlG1NfQfYHjERk97MZZuBYQr8i0BnSJCDwBHbwWG7DT3AIcux0vbYFcZ4lNZHp8WxcQ3YGNZwFJg/wI6AlTGs8fU9DRj02N8AfPHdF4B1UbeCOB2qW4ZXsVWbiJEUt13W58mDuoGTcYyV6gPbaC9w23YvSQJmvrbApJVRrpthh17HgHfAI+BVkjDyjUCS52agRrteJv1SEHmNe5KCESeSJn7QBvMc/bgxQ5f8Nz3tn0tRBlywtgz8BfJ+g5dqgRu4AAAAAElFTkSuQmCC';
    var selectedBase64Image = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAA3CAYAAAB6i9geAAAEGUlEQVRogdWayY8MYRiHn6lhYuzGMMQ2dsYyE9vBZSKW4OYkOPIfODg4k5CIMBFEIg5ChBBcrCFBrLEGw9jD2JfYp8eWV341Squururu6S6/SyfVXVVPvfV+7/Z1UWnVDCKqGOgG9AHGABOBEUBfHW+ny30F3gKPgXrgPHANeKLj36PcNgqoA/QCxgFTgAkeuM56AD8Z0HsP9AXgGHAReAb8yCVoOTANmAmMBYYCHcM+YZI+Ag3AVeAAcAR4le6k4rY9Bgd93xYYDywEFgH2VL2Bkgwh0bl2jRq5TLks/jLIukGgHYDZwBJgni6ea/UEJgEG8QF4BDT73aNNiht3AuYCi/XUrSmz8HSgH1AG7BB0Woua780HlgJDWhnSK3OBauAdcAtIBIGaT84R5KA8QrrqqjfYKNgWn00GrdXrHlcASFfdZd37wAP3oOP5QaX8srZgiH9UK5ZK94gXdJbiZFw0U0x/gVoAnwoMiBHoADEZ22/QEpm6uvBs/6habCWOgu7UPIeisBoitp4GWgWMjCGkK2OrcpTCesSDyVfGNslRcVAWQ0BXxlZjoAM9xW4cZWwDDbQixpCuKgy0NB4sgSp1sjg5rzLQpv+AM+Go6Yq73hroQ+BbjEGN7aGjXjvOVjW2awZ6Wh1gXGVspx311w0xBjW2K46mFafUp8RNjWJ7aqCfgaPAjRiC3hDbFzfg24I66ddPF1AfxGRsLa2ITSf2AodiBHoY2OdOTrwp9DKwDbhZOLYW1Yvlknsgua9v1JhwvGZPhdBzYDWw25vek0Gb1PibpUcB7fMMauPH9cDm5CTkN3v6pNX2EximgVk+ZJbcAKzzS0Cpxo6fNBFGsF1aGdSFtFf+xu8HQfNRc4MrKgqGa4DVGjLrbQTqgmqOdBPnhFbgT20sZDoOTyUbk2/S634e9MN0oGh347aiQU0OW5cvgqzTJkSgwoCiNNugKDA2yxk+cqtd8sm7YU4IC4pe0311rUM19M1ENpw9DqxUkgmlKKDI2Z9oJhTpRI9sY2wFcCLsHhMZgCLQlxqd94t4rhUYq4A9USAJ2BVJp4MatXSUz4bRPWWdnYoikZSJRV3dVmUzJkSMteJ8LbBFqz2yshlANKk03KqokErNsuJO7dBlpGwsiiLBYw2DLXslu5JB7gfWaDsmY2ULanptPY32hyqTvjsHLAPOZnuTXIAiH3wBjPZMB68Dy9XzRFrhfsoV6A8lAzfNflTW2Z5qEzaqMg1PfjKgrYIs0kJLRL+Mv7IFdRRLy1QHmGXvCLS/0mxC8K9U5+Yd1HZTJivvV6jHcsGKVGV9V/X1WX5cr79qXM8nqC2cBcpMYTYrrHK31W/QbqsTWtksJvNJC/p2YxsWWMYxa9px+7TjbhFjFjyjXt0+LaSFF/AL41vvXN2rkIwAAAAASUVORK5CYII=';
    var OAR_FILTER_ID = 'OwnerAdvantageRewards';
    var globalMap;
    var info = util.env.browser();
    var locationOptions = {};
    var dealerStateUpdateWasUserInitiated = false;
    var lastClickedPACode;
    if(info.name === 'IE' && info.version == 11) {
        locationOptions = {
            enableHighAccuracy: false,
            maximumAge: 50000
        };
    }

    if (ctx.make === 'Lincoln') {
        base64Img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAuCAYAAACiR6CHAAACzUlEQVRYhc2ZS0gWURTHf98YCaFFIJog2EKoVsm3iyCSoBB60IPIyKJFRQ8ikAgRgqhFrVsUFFYUYVAk1aJNC9uUUF8vqAyCsgdWUgkFPezBiTMwjdf57v3G+Wb+m2FmLuf8uHPuveecyeUXLsFB04HZwFJgHjALqAEmAz+AYWAAuAVcA54Cn2zN28KI02XABmCuA/wD4BxwVSEjVVE/synq/VRgH3AMWAnMcABBxy8G1gJTgHvA9/EGexGG5gN9wAGg1hEirFq106d2nWDagOtAc0yIsJrVbpvp5STDs/XA2SKzFkdVGkc54HzQTtjhIqA7QZCg3271Z4RpAI4DlQmD+KpUfw0mmE4gcmkloCb1+x9MHmgvM4ivdvX/D0YCaRNQnRJMtfrPCUydrqA0Jf7rBKZFz5c0Jf5bBKY1ZRBfrZ4fPBlQXmAaMwLT6On2nAVVCcxoRmBGBeZzBkBEIwLzLAMgogFP89Us6LbA9GYEptfTvPR+yiDCUBCYr8DplGHOCIefQlwAXqcEIn57COQzQ8DBlGAOAe8IZXongctlBpHFc8K/CcL8BraXMZgLwFb1OwYGna41wMOEQR4Bq4EPwYemkuS5lqRJbYYFtf8i/GK8+khmaDlwc4JBZMZX6YIZo6hibVjL0ImKoZfAOr0aVaxyfAus0D5LHA3pjDyJsmFTxg5qX8Y4tRaSFsg2jZVI2dbUd4FdJSZie4ErNgNdCvxLQIcjyBHgqO3gYp2rsPqBadrPKyZpe+x0MV5K66PD4ti4AWxxNVwKzB9gd8TKGNT4+lYOGPTY3wx8CT0XgI2lbgVxOlT9hk+xQ5uIJSluu6wnkAcdBk7FMWZqMLpqP3DHdi9JAmaOtsBqtNksm+EevY4A74HHwKskYeQfgSTPC4B67XqZ9FNB5DN22Rp33fQkK/uoseYfDRV6/0srjTf6z0CazxetzzTgL19PhJLYv4FpAAAAAElFTkSuQmCC';
        selectedBase64Image = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACoAAAA3CAYAAAB6i9geAAAEGElEQVRogdWaWYsUVxTHf1OaQY1xGdSJmDjjMiYu44zrQxBUVFzQF1/E+AH8AAp5yFeIuKMiiASJBMX1RbMQCJFRFFfUdtwYtygOUdwd4xiO/O9QNlVtVVdP980fmobq7rq/Ovfec849p6smz5pPSvUABgLDgEZgGvA18IWu99LtXgGPgDtADjgJXADu6vrbNMP2TPHdAPgcmAzMBqaG4PrpAfI1FPhKD7NY0KeAP4DTwH2gs5Sgg4C5wAJgItAA9E34WzcD9hoZetDzwBHgN6A9K+gnQDOwVBaZkBCukOwBJ+k1BWgC9gFngTexTzu0fnTcZ58Ci4DvgOWaxlJrCDAdGAU8BW7FwcZZ9DNgGbBKG6U7VQ3MA74EaoCfBf1Ri9rUfAt8D8Sauxs0SMvgMXAF6AgPEeSNZ2tyCbAaqCsjpFOdxl4ili7lg84AVmpXV0oNYpgRB1qvdTmzgpBOM8VS7y6EQRfKT/qiBWL6ANTMPadC6zJOdWJqcKDVMnWTR5BOTWKrDuR055TZFSXVaLENMdBxwFgPIZ2MbVygEDbYD6ZIGdv0QElHjYeATsbWbKAjQsmujzK2EQZa6zGkU62B9vaDpaB658d6b2Wgr/8HnB2BToS+65GBtgH/egxqbG2Bzto+W9XYLhhoC/DQA6A4GVtLoPP1VT8Z38vYzgWqVhwD7nkAla97YvvbQF8AvwOX/GJ8r0tie+kcvm2ov6LO0xXUUzEZW9dRxKoTB4FfPAL9FTjkKifhEGq1n5+Ay5Vj61JOLGfchfxYb+thW4Xd1QNgiyzapfySjsX9m3qA8UCfMkO2C3JHfhCKqj091257B4xRwawcMktuBTZHzWhc2fG5KsIItn83gzrItcA/UV8oVB+1ZXBOSYGVtwd0E+RD7YuNhXKOQqCo9JfTMmhMUQ5PqmfAdk33g0K/+Rgo6m60qovRXMKjy0tBblQToqCSgKIwe1VeYKLKQFlky2qv1uT1JPdJc2a6r7V0QNYoVtau+VPTnUt6j7SHu2vAJsXgYmV9pnV6T6ykUx/WXe3UkWoQpJElGGuA/UkbYU5pOndhHVWppa/WbBLdUNTZIy+SSsVY1KlVmU1jAh9r63sDsLPY9Z2lAPFaqeEueYU4vZEV7fWk2MGyVkrMUj+qRRhVyDDIw0oy2rIMVIqSTqtczfGIz2xnr1eum0mlqj0Z0A860Tpd1A5vKcUAWTZTWJ3KY12Yfaaos7tQxziNinVPUTKgXYKs0kbrSH+baGUFDeRLa5QHdCp6Gehw9TM7BN+uPLfsoNZN+UYNq1r19x1YlbKst8q+XshD5LSeL5YT1P4NsUKRKUmzwjL3E4J2R53EygJqLsdStdtqWFibxc5X1hyw/5E4a5qTt6TYQqh5APtduhAK/Ad22eIpRPoRbwAAAABJRU5ErkJggg==';
    }

    // Search Activity Timeout Variables
    var _searchActivityTimeout = null;
    var _searchActivityTimeoutDelaySec = 60 * 30;
    var _searchInactive = false;

    brand.setInitHandler('[data-fgx-locate-a-dealer]', init);

    //////

    function init(newComponents, brandUrl) {

        components = newComponents;
        cfg = dealerLib.getDealerConfig();

        if(components.length === 0 || cfg == null || _.isEmpty(cfg)) {
            return;
        }

        startSearchActivityTimer(_searchActivityTimeoutDelaySec);
        dealerDetailsPageLink = cfg.dealerDetailPageUrl;

        if (dealerDetailsPageLink === '' || dealerDetailsPageLink == null || dealerDetailsPageLink == undefined) {
            dealerDetailsPageLink = (brandUrl || ctx.settings.synBaseUrl || '') + (ctx.settings.sitePath || '') + 'dealer-details' +
                (win.location.pathname.substr(win.location.pathname.length - 5) === '.html' ? '.html' : '/');
        }

        _labels = _lad && _lad.labels || {};
        hideDealerWebsite = (_lad && _lad.hideDealerWebsite) || false;
        dealerWebsiteLabel = getLabel('dealer_website');
        dealerWebsiteAriaLabel = getLabel('dealer_website_aria_label');
        dealerWebsiteCtaTarget = (_lad && _lad.dealerWebsiteCtaTarget) || '_blank';
        dealerDetailsAriaLabel = getLabel('details_aria_label');
        _searchErrors = {
            'required-dealer': getLabel('required_dealer_error_message'),
            'required-location': getLabel('required_location_error_message'),
            'invalid-search': getLabel('invalid_search_try_again'),
            'duplicate-search': getLabel('duplicate_search_message'),
            'search-extension': getLabel('search_extension_message')
        };

        advancedSearchOvr = {
            $el: $('.advanced-search', components),
            // BRAND-15582: Disable focus trapping on Advanced Search. If this ever needs to be re-implemented, un-comment lines 120, 124 and 128
            //focusElements: 'a:visible, button:visible, [data-fgx-keypress]:visible',
            expanded: $('.advanced-search', components).hasClass('expanded'),
            show: function(currentTarget) {
                toggleAdvancedSearch(true);
                //overlay.trapFocus(advancedSearchOvr, advancedSearchOvr.focusElements, '.fgx-custom-select', currentTarget, true);
            },
            hide: function() {
                toggleAdvancedSearch(false);
                //overlay.releaseFocus(advancedSearchOvr);
            }
        };

        components.on('click', 'li.dealer', onDealerClick);

        components.on('click', '.search-container .search-options input', selectSearchOption);
        components.on('click', '.search-container .search-options .txt-label', function(ev){
            $(this).closest('label.radio').find('input').trigger('click');
        });
        components.on('focusin focusout keyup', '.search-container .search input', updateSearchTextState);
        components.on('keydown focusout', '.geo', function(event) {
            if(event.which === 9 || event.type === 'focusout') {
                $(this).hide();
            }
        });
        components.on('click', '.search-submit', searchSubmit);
        components.on('click', '.make-my-dealer', onMakeMyDealerClick);
        components.on('click', '.my-dealer .current-dealer', onRemoveMyDealerClick);
        components.on('click', '.search-clear', function() {
            var srch = getSearchData.call($(this));
            srch.$txt.val('').focus();
            $('.type-ahead-results:visible', components).hide();
        });
        components.on('click', '.back-to-list', function(){
            componentElement(this).removeClass('expanded');
            var $cnt = componentElement(this, '.location-aware');
            updateMap($cnt);
            toggleMapView();

            FD.Brand.Overlay.releaseFocus(ovr);
        });
        components.on('click', '.view-map', function(){
            componentElement(this).addClass('expanded');
            var $cnt = componentElement(this, '.location-aware');
            updateMap($cnt);
            toggleMapView();

            //hack for safari desktop - not working if css is set in styles, only if nudged
            if(util.currentBreakpoint() != 'gux-bkpt-sm' && navigator.userAgent.search("Safari") > 0 && navigator.userAgent.search("Chrome") < 1){
                $(".dealer-standard.expanded").css('position', 'absolute');
                setTimeout(function() {
                    $(".dealer-standard.expanded").css('position', '');
                }, 500)
            }


            // treat this like an overlay - we need to trap focus
            ovr.lastFocus = $(this);
            ovr.$el = componentElement(this);
            ovr.hide = function() {
                $('.back-to-list', ovr.$el).trigger('click');
            };
            FD.Brand.Overlay.trapFocus(ovr, 'a:visible, .search-text-location:visible, .search-text-dealer:visible, button:visible, [data-fgx-keypress]:visible', '.back-to-list', ovr.lastFocus);
            // for some reason passing the selector into trapFocus method isn't setting focus initially to the 'back to list' button correctly.
            $('.back-to-list', ovr.$el).focus();
        });
        components.on('click', '.geo .btn', getCurrentPosition);
        components.on('click', '.view-more', updateView);
        components.on('click', '.advanced-search-toggle', function(){
            (advancedSearchOvr.expanded) ? advancedSearchOvr.hide() : advancedSearchOvr.show($(this));
            
            $(this).focus();

            if($(".dealer-standard.expanded").length && $('.advanced-search.expanded').length){ // scroll to top when open advanced search for good UI
                $(".adv-search-target")[0].scrollTop = 0;
            }
        });
        components.on('click', '.advanced-search .reset', function(){
            resetDropdown();
            resetServiceFilters();
        });
        components.on('click', '.advanced-search .apply-advanced', searchSubmit);
        components.on('click', '.service-list .checkbox .icon', onServiceFilterClick);
        components.on('click', '.option-tooltip', function(){
            $('.ford-tooltip', components).hide();
            $('.service-list li', components).removeClass('has-info-open');
            var $li = $(this).closest('li');
            var $tooltip = $('.ford-tooltip', $li);
            var ovr = {
                $el: $tooltip,
                hide: function() {
                    $('.close-tooltip', $tooltip).trigger('click');
                },
                lastFocus: $(this)
            };
            $tooltip.show({complete:function() {
                    FD.Brand.Overlay.trapFocus(ovr, 'a:visible, [data-fgx-keypress]:visible', '.close-tooltip', ovr.lastFocus, true);
                }});
            $li.addClass('has-info-open');
        });
        components.on('click', '.close-tooltip', function(){
            var $li = $(this).closest('li');
            var $tooltip = $('.ford-tooltip', $li);
            var $option = $('.option-tooltip', $li);
            var ovr = {
                $el: $tooltip,
                lastFocus: $option
            };
            $tooltip.hide({complete:function() {
                    FD.Brand.Overlay.releaseFocus(ovr);
                }});
            $li.removeClass('has-info-open');
        });
        components.on('click', '.type-ahead-results li', function() {
            var $el = $(this);
            var srch = getSearchData.call($el);
            var txtVal = $el.text();
            var $resName = $el.find('.result-name');
            var $paCode = $el.data('pacode');
            if($resName.length) {
                txtVal = $resName.text();
            }
            srch.$txt.val(txtVal);
            if ($paCode != null) {
                paCodeSubmit.call($el, $paCode);
            } else {
                searchSubmit.call($el);
            }
            componentElement(this, '.type-ahead-results').hide();
        });
        // this needs to be global, because it's scoped to a tooltip outside of the component
        $('body').on('click', '.make-my-dealer.confirm', confirmMyDealerUpdate);

        // init advanced filters
        resetDropdown();
        // need to be initially set for normal context
        applyOwnerContextToServiceFilters();

        $('.fgx-brand-select-container', components).on('change', function(ev) {
            var $el = $(this),
                dropdownId = $el.attr('data-dropdown-id');
            updateSelected($el, dropdownId);
        });

        $('.search-container', components).on('click', function(e) {
            var $el = $(this);
            if($('.dealer-standard.expanded').length && util.currentBreakpoint() === 'gux-bkpt-sm' ){ //only toggle if on map view and mobile
                if ($(e.target).hasClass("advanced-search-toggle")) { // some logic to handle whether advanced-search-toggle click should open search results or not
                    if($(".dealers.opened").length) { //if search results are already opened
                        //do nothing here, let advanced search toggle handle itself
                    } else { //if search results are not opened
                        $(".location-aware .dealers").toggleClass('opened');
                        if(!$('.advanced-search.expanded').length){ //if advanced search is not already opened
                            //do nothing here, let advanced search toggle handle itself to open
                        } else { //if advanced search is already opened
                            //prevent event from propogating, so advanced search stays opened and isnt closed when toggling search results open
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }
                }
                else if ($(e.target).parents(".message.error").length) {
                    searchError();
                }
                else if( !$(e.target).parents(".radio, .search-wrap").length && !$(e.target).is('label') ){ // dont toggle search results if other actionable items were cause of event. Idea is to only toggle search results if it was user's intent
                    $(".location-aware .dealers").toggleClass('opened');
                }
                if ($(".dealers.opened").length) {
                    $('.mobile-results-trigger', $el).attr('aria-expanded', 'true');
                    $('.results-indicator-closed', $el).removeClass('d-block').addClass('d-none');
                    $('.results-indicator-open', $el).removeClass('d-none').addClass('d-block');
                } else {
                    $('.mobile-results-trigger', $el).attr('aria-expanded', 'false');
                    $('.results-indicator-closed', $el).addClass('d-block').removeClass('d-none');
                    $('.results-indicator-open', $el).addClass('d-none').removeClass('d-block');
                }
            }
        });

        components.on('focusin', '.dealer .dealer-expand-btn',function() {
            $(this).closest('li.dealer').addClass('show-focus');
        }).on('focusout', '.dealer .dealer-expand-btn', function() {
            $(this).closest('li.dealer').removeClass('show-focus');
        });

        $('script[data-fgx-locate-dealer-template-id]').each(function(idx, tmpl) {
            var $tmpl = $(tmpl);
            templates[$tmpl.attr('data-fgx-locate-dealer-template-id')] = _.template(tmpl.innerHTML);
        });

        parseDeeplinkHash();
        // check session storage and set owner context if necessary
        if (sessionStorage['fgx-lad-ownerCtx']) {
            isOwnerContext = true;
            isBfnContext = false;
            _websiteClickAction = ((dealerWebsiteClickActionOwner) ? dealerWebsiteClickActionOwner : _websiteClickAction) || {};
            _detailsClickAction = ((dealerDetailsClickActionOwner) ? dealerDetailsClickActionOwner : _detailsClickAction) || {};
            // apply owner context to service filters
            applyOwnerContextToServiceFilters();
            applyOwnerContextToStaticElements();
        } else if(sessionStorage['fgx-lad-bfnCtx']) {
            isBfnContext = true;
            isOwnerContext = false;
        }

        if(FD.Brand.Util.env.geoLocation()) {
            var coordinates = user.location.coordinates();
        }

        user.dealer.subscribe(onDealerStateChange);
    }

    function parseDeeplinkHash() {
        if (window.location.hash !== '') {
            var hash = window.location.hash;
            var segments = window.location.hash.split('/');
            var hasInitialSearchTerm = false;
            var initialSearchTerm = null;
            for (var i = 0; i < segments.length; i ++) {
                var str = segments[i];
                if (str === 'q') {
                    initialSearchTerm = unescape(segments[ (i + 1) ]);
                    $('.search-text-location', components).val(initialSearchTerm);
                    hasInitialSearchTerm = true;
                }
                if (str === 'qn') {
                    initialSearchTerm = unescape(segments[ (i + 1) ]);
                    $('.search-options .txt-label.dealer', components).trigger('click');
                    $('.search-text-dealer', components).val(initialSearchTerm);
                    hasInitialSearchTerm = true;
                }
                if (str === 'radius') {
                    var radius = segments[ (i + 1) ],
                        $distanceSelect = $('.distance-select-container', components),
                        $selectedOpt = $distanceSelect.find("[data-custom-value='" + radius + "']");
                    if ($selectedOpt && $selectedOpt.length > 0) {
                        setDropdownVal($distanceSelect, radius, false);
                    }
                }
                if (str === 'filters') {
                    var filterStr = segments[ (i + 1) ];
                    if (filterStr.indexOf('=') > -1) {
                        var filters = filterStr.split('=');
                        var filterValues = filters[1];
                        if (filterValues.indexOf(',') > -1) {
                            // multiple filters
                            var initialSearchFilters = filterValues.split(',');
                            for (var j = 0; j < initialSearchFilters.length; j ++) {
                                var filterValue = initialSearchFilters[j];
                                $('.service-list', components).find("span[data-filter-value='" + filterValue + "']").trigger('click');
                            }
                        } else {
                            // only one filter
                            $('.service-list', components).find("span[data-filter-value='" + filterValues + "']").trigger('click');
                        }

                    }
                }
                if (str === 'openAdvanced') {
                    // initialize with the advanced panel open
                    advancedSearchOvr.show($('.search-wrap .search input:visible', components));
                }
                if (str === 'context') {
                    var dlCtx = segments[ (i + 1) ];
                    if (dlCtx === 'owner') {
                        // this will ensure that the component maintains owner context for the duration of the browsing session
                        sessionStorage['fgx-lad-ownerCtx'] = true;
                        sessionStorage.removeItem('fgx-lad-bfnCtx');
                    } else if(dlCtx === 'bfn') {
                        sessionStorage['fgx-lad-bfnCtx'] = true;
                        sessionStorage.removeItem('fgx-lad-ownerCtx');
                    }
                }
            }
            // if we have enough data for a search, trigger one, otherwise standard location state rules will apply for initial search
            if (hasInitialSearchTerm) {
                hasDeeplink = true;
                $('.search-submit', components).trigger('click');
            } else {
                user.location.subscribe(updatePostalCodeState);
                updatePostalCodeState();
            }
        } else {
            user.location.subscribe(updatePostalCodeState);
            updatePostalCodeState();
        }
    }

    function updateStandardDeeplink(searchType, searchTerm, radius, filters) {
        var deeplink = "/";
        deeplink += (searchType === 'dealerName') ? 'qn/' : 'q/';
        deeplink += searchTerm;
        deeplink += '/radius/';
        deeplink += radius;
        if (typeof filters != 'undefined' && filters !== '') {
            deeplink += '/filters/all=';
            deeplink += (filters.indexOf(';') > -1) ? filters.split(';').join(',') : filters;
        }
        // updating the window.location.hash object adds an extra history item in Firefox only...we need to handle that here...but only on initial page load
        if (info.name === 'firefox' && !initialFirefoxReplace) {
            console.log('**** REPLACE ****');
            var segments = window.location.href.split('#');
            var newLoc = segments[0] + '#' + deeplink;
            window.location.replace(newLoc);
            initialFirefoxReplace = true;
        } else {
            window.location.hash = deeplink;
        }
        // use session storage to store our last known deeplink...this will be used for the 'All Dealers' back button on Dealer Details page.
        sessionStorage['fgx-lad-lastKnownDeeplink'] = deeplink;
    }

    function toggleAdvancedSearch(open) {
        $('.advanced-search', components).toggleClass('expanded', open);
        $('.advanced-search-toggle', components).attr('aria-expanded', (open) ? 'true' : 'false');
        advancedSearchOvr.expanded = open;
    }

    function componentElement(el, selector) {
        var $el = $(el).closest('[data-fgx-locate-a-dealer]');
        if(selector) {
            $el = $el.find(selector);
        }
        return $el;
    }

    function applyOwnerContextToStaticElements() {
        if (typeof backToListClickActionOwner !== 'undefined') {
            $('.back-to-list', components).attr('data-fd-metrics-click', JSON.stringify(backToListClickActionOwner));
        }
        if (typeof advancedSearchClickActionOwner !== 'undefined') {
            $('.advanced-search-toggle', components).attr('data-fd-metrics-click', JSON.stringify(advancedSearchClickActionOwner));
        }
        if (typeof viewMapClickActionOwner !== 'undefined') {
            $('.view-map', components).attr('data-fd-metrics-click', JSON.stringify(viewMapClickActionOwner));
        }
        if (typeof backToListClickActionOwner !== 'undefined') {
            $('.back-to-list', components).attr('data-fd-metrics-click', JSON.stringify(backToListClickActionOwner));
        }
        if (typeof viewMoreClickActionOwner !== 'undefined') {
            $('.view-more', components).attr('data-fd-metrics-click', JSON.stringify(viewMoreClickActionOwner));
        }
    }

    function updateSelected($elm, dropdownId) {
        if (!$elm || $elm.length === 0 || !dropdownId) {
            return;
        }
        var newVal = $elm.val();
        if (newVal) {
            if (dropdownId === 'distance') {
                currentRadius = parseInt(newVal, 10) || newVal;
            }
        }
    }

    function setDropdownVal($elm, radius, useFallback) {
        if (!$elm || $elm.length === 0) {
            return;
        }
        currentRadius = parseInt(radius, 10) || radius;
        if (useFallback && typeof currentRadius === 'undefined') {
            currentRadius = 50;
        }
        $elm.val(currentRadius);
    }

    function resetDropdown() {
        var $selectElm = $('.distance-select-container', components),
            $defaultDistanceOpt = $selectElm.find("[data-default='true']"),
            _radius = ($defaultDistanceOpt && $defaultDistanceOpt.length > 0) ? $defaultDistanceOpt.data('customValue') : 50;
        setDropdownVal($selectElm, _radius, true);
    }

    function toggleMapView() {

        if($('.dealer-standard.expanded').length) {
            $(".search-container", components).prependTo($(".dealers", components));
            $(".advanced-search", components).prependTo($(".adv-search-target", components));
        } else {
            $(".search-container, .advanced-search", components).insertAfter(".headline.title.map-toggle-target");
        }

    }

    function onServiceFilterClick() {
        var $el = $(this);
        var $li = $el.closest('li');
        if ($li.hasClass('disabled')) {
            // we're disabled - return
            return;
        }
        // if we're exclusive, we have extra logic that needs to run before the standard logic
        if ($li.data('exclusive') === 'true' || $li.data('exclusive') == true) {
            if (!$li.hasClass('selected')) {
                // if we're not already selected, de-select and disable all other filters before continuing with standard logic.
                $('.service-list li', components).removeClass('selected');
                $('.service-list li', components).addClass('disabled');
                $('.service-list li .checkbox .icon', components).removeClass('icon-check-25px');
                $('.service-list li .checkbox .icon', components).addClass('icon-unchecked');
                $('.service-list li .checkbox .icon', components).attr('aria-checked', 'false');
                $li.removeClass('disabled');
            } else {
                // if we're already selected, we're being de-selected ourselves, so re-enable the other filters.
                $('.service-list li', components).removeClass('disabled');
            }
        }
        $li.toggleClass('selected');
        if ($li.hasClass('selected')) {
            $el.removeClass('icon-unchecked');
            $el.addClass('icon-check-25px');
            $el.attr('aria-checked', 'true');
        } else {
            $el.removeClass('icon-check-25px');
            $el.addClass('icon-unchecked');
            $el.attr('aria-checked', 'false');
        }
        // if we have the distance attribute, make sure we're handling it properly
        if (typeof $li.data('distance') !== 'undefined') {
            if ($li.hasClass('selected')) {
                // if we've been selected, set the distance dropdown to the specified value
                var selector = '.advanced-search .distance .fgx-custom-list-options li[data-custom-value="' + $li.data('distance') + '"]';
                $(selector, components).trigger('click');
            } else {
                // if we've been deselected, set the distance dropdown back to the default value
                var selector = '.advanced-search .distance .fgx-custom-list-options li[data-default="true"]';
                $(selector, components).trigger('click');
            }
        }
        // make sure we transfer focus back to the element the user clicked in case it was moved by other dynamic click actions.
        $el.focus();
        updateCurrentFilters();
    }

    function applyOwnerContextToServiceFilters() {
        $('.service-list li', components).each(function(idx, el){
            $li = $(el);
            if (isOwnerContext) {
                // set for owner context
                if ($li.data('owner-suppress') === 'true' || $li.data('owner-suppress') == true) {
                    $li.hide();
                } else if ($li.data('owner-only') === 'true' || $li.data('owner-only') == true) {
                    $li.show();
                }
            } else {
                // set for normal context
                if ($li.data('owner-only') === 'true' || $li.data('owner-only') == true) {
                    $li.hide();
                } else if ($li.data('owner-suppress') === 'true' || $li.data('owner-suppress') == true) {
                    $li.show();
                }
            }
        });
    }

    function resetServiceFilters() {
        $('.service-list li', components).removeClass('selected');
        $('.service-list li', components).removeClass('disabled');
        $('.service-list li .checkbox .icon', components).removeClass('icon-check-25px');
        $('.service-list li .checkbox .icon', components).addClass('icon-unchecked');
        $('.service-list li .checkbox .icon', components).attr('aria-checked', 'false');
        currentFilters.ids = [];
        currentFilters.items = [];
    }

    function updateCurrentFilters() {
        currentFilters.ids = [];
        currentFilters.items = [];

        $('.service-list li.selected', components).each(function(idx, el){
            $el = $(el);
            var data = {
                id: $el.find('input').attr('value') || ''
            };
            currentFilters.ids.push(data.id);
            var item = _.find(serviceFilters, data);
            if(item) {
                currentFilters.items.push(item);
            }
        });
    }

    function removePreferredDealer() {
        var def = $.Deferred();
        var currentPACode = preferredDealer.PACode;
        user.dealer.removePreferred(currentPACode).done(function() {
            if ((!isOwnerContext && typeof unsaveClickAction !== 'undefined') || (isOwnerContext && typeof unsaveClickActionOwner === 'undefined' && typeof unsaveClickAction !== 'undefined')) {
                FD.Brand.Metrics.handler.direct(
                    unsaveClickAction
                );
            } else if (isOwnerContext && typeof unsaveClickActionOwner !== 'undefined') {
                FD.Brand.Metrics.handler.direct(
                    unsaveClickActionOwner
                );
            }
            def.resolve();
        }).fail(function(resp) {
            def.reject(null);
        });
        return def.promise();
    }

    function onRemoveMyDealerClick() {
        $dealerEl = $(this).closest('li.dealer');
        var currentPACode = preferredDealer.PACode;
        dealerStateUpdateWasUserInitiated = true;
        lastClickedPACode = $dealerEl.data('pacode');
        setBusy.call(components, true);
        removePreferredDealer().done(function() {
            setBusy.call(components, false);
        }).fail(function(resp) {
            // handle failure here
            setBusy.call(components, false);
        });
    }

    function onMakeMyDealerClick() {
        $dealerEl = $(this).closest('li.dealer');
        dealerStateUpdateWasUserInitiated = true;
        lastClickedPACode = $dealerEl.data('pacode');
        var currentPACode = $dealerEl.data('pacode');
        if (!hasPreferred) {
            // we don't have a preferred dealer yet, just save
            setBusy.call(components, true);
            user.dealer.setPreferred(currentPACode).done(function() {
                if ((!isOwnerContext && typeof saveClickAction !== 'undefined') || (isOwnerContext && typeof saveClickActionOwner === 'undefined' && typeof saveClickAction !== 'undefined')) {
                    FD.Brand.Metrics.handler.direct(
                        saveClickAction
                    );
                } else if (isOwnerContext && typeof saveClickActionOwner !== 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        saveClickActionOwner
                    );
                }
                setBusy.call(components, false);
            }).fail(function(resp){
                // handle failure here (error msg about only saving one dealer?)
                setBusy.call(components, false);
            });
        }
    }

    function confirmMyDealerUpdate() {
        var newPACode = $(this).data('pacode');
        var currentPACode = preferredDealer.PACode;
        $dealerEl = $('li.dealer[data-pacode=' + newPACode + ']');
        dealerStateUpdateWasUserInitiated = true;
        lastClickedPACode = $dealerEl.data('pacode');
        setBusy.call(components, true);

        removePreferredDealer().done(function() {
            user.dealer.setPreferred(newPACode).done(function() {
                // since we remove the preferred dealer first, we need to reset the following variable to 'true' so focus is appropriately managed.
                dealerStateUpdateWasUserInitiated = true;
                if ((!isOwnerContext && typeof saveClickAction !== 'undefined') || (isOwnerContext && typeof saveClickActionOwner === 'undefined' && typeof saveClickAction !== 'undefined')) {
                    FD.Brand.Metrics.handler.direct(
                        saveClickAction
                    );
                } else if (isOwnerContext && typeof saveClickActionOwner !== 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        saveClickActionOwner
                    );
                }
                setBusy.call(components, false);
            }).fail(function(resp){
                // handle failure here
                setBusy.call(components, false);
            });
        }).fail(function(resp) {
            // handle failure here
            setBusy.call(components, false);
        });
    }

    function onDealerClick(ev) {
        if (!detailAlwaysExpanded && !$(ev.target).hasClass("select-dealer") && !$(ev.target).hasClass("phone-link") && !$(ev.target).hasClass("icon-info-25px")) { //check if actionable item was clicked, dont trigger li.dealer expansion if so
            if ($(this).hasClass('expanded')) {
                $(this).removeClass('expanded');
                $(this).find('.dealer-expand-btn').attr('aria-expanded', 'false');
                return;
            }
            var $cnt = componentElement(this);
            $('li.dealer', $cnt).removeClass('expanded');
            $(this).addClass('expanded');
        }
        // regardless, set dealer selected
        var idx = $(this).data('index');
        for (var i = 0; i < currentDealers.length; i ++) {
            var dealer = currentDealers[i];
            var iconText = '' + (dealer.index + 1) + '';

            if (i !== idx) {
                dealer.selected = false;
                dealer.$el.removeClass('selected');
                dealer.$el.find('.dealer-expand-btn').attr('aria-expanded', 'false');
                if (dealer && dealer.pushpin) {
                    dealer.pushpin.setOptions({
                        state: 'none',
                        icon: base64Img,
                        text: iconText,
                        textOffset: new Microsoft.Maps.Point(0, 10),
                        anchor: new Microsoft.Maps.Point(17.5, 46)
                    });
                }
            } else {
                dealer.selected = true;
                dealer.$el.addClass('selected');
                dealer.$el.find('.dealer-expand-btn').attr('aria-expanded', 'true');
                if (dealer && dealer.pushpin) {
                    dealer.pushpin.setOptions({
                        state: 'selected',
                        icon: selectedBase64Image,
                        text: iconText,
                        textOffset: new Microsoft.Maps.Point(0, 13),
                        anchor: new Microsoft.Maps.Point(21, 55)
                    });
                }

                if($(".dealer-standard.expanded").length) {// when on map view
                    if (globalMap) {
                        globalMap.setView({//center pushpin in map when dealer clicked
                            center: dealer.pushpin.getLocation()
                        });
                    }
                }
            }
        }
    }

    function onDealerStateChange(dealerState) {
        if (dealerState.preferred) {
            hasPreferred = true;
            preferredDealer = dealerLib.updateDealer(dealerState.preferred, 0, salesOpenUntil, salesOpenAgain, null, cfg.dealerDetailPageUrl, hoursDisplayType);

            if (initialPageLoad) {
                // we need to call processDealers again to update the order to account for our preferred dealer, but only if we have more than one dealer
                if (dealers.length > 1) {
                    components.each(function() {
                        var $cnt = componentElement($(this), '.location-aware');
                        processDealers(dealers, $cnt);
                    });
                }
                // make sure we only do this once
                initialPageLoad = false;
            }
        } else {
            hasPreferred = false;
        }
        updatePreferred();
    }

    function setLocationState(aware) {
        $('.location-aware', components).toggle(aware);
    }

    function updateView() {
        var $cnt = componentElement($(this), '.location-aware');
        showDealers($cnt, true);

        if(util.currentBreakpoint() === 'gux-bkpt-sm' && $(".dealer-standard.expanded").length && $(".dealers.opened").length){ //close dealer results on mobile when user clicks view more dealers
            $(".dealers.opened").removeClass("opened");
        }

    }

    function updatePreferred() {
        components.each(function() {
            var $cnt = componentElement($(this), '.dealer-list');
            $('li.dealer', $cnt).each(function() {
                var $el = $(this);
                var type = $el.data('type');
                if (type === 'Dealer') {
                    var paCode = $el.data('pacode');
                    if (hasPreferred) {
                        if (paCode == preferredDealer.PACode) {
                            $('.my-dealer button', $el).attr('aria-hidden', 'false');
                            $('.my-dealer', $el).show();
                            $('.make-my-dealer a', $el).attr('aria-hidden', 'true');
                            $('.make-my-dealer', $el).hide();
                            if (dealerStateUpdateWasUserInitiated && lastClickedPACode === paCode) {
                                // if our update was user initiated, apply focus to the appropriate element for accessibility purposes
                                $('.my-dealer button', $el).focus();
                                dealerStateUpdateWasUserInitiated = false;
                            }
                        } else {
                            $('.my-dealer button', $el).attr('aria-hidden', 'true');
                            $('.my-dealer', $el).hide();
                            $('.make-my-dealer a', $el).attr('aria-hidden', 'false');
                            $('.make-my-dealer', $el).show();
                            $('.make-my-dealer a', $el).attr('href', '#show-tooltip');
                            if (dealerStateUpdateWasUserInitiated && lastClickedPACode === paCode) {
                                // if our update was user initiated, apply focus to the appropriate element for accessibility purposes
                                $('.make-my-dealer a', $el).focus();
                                dealerStateUpdateWasUserInitiated = false;
                            }
                        }
                    } else {
                        $('.my-dealer button', $el).attr('aria-hidden', 'true');
                        $('.my-dealer', $el).hide();
                        $('.make-my-dealer a', $el).attr('aria-hidden', 'false');
                        $('.make-my-dealer', $el).show();
                        $('.make-my-dealer a', $el).attr('href', 'javascript:void(0);');
                        if (dealerStateUpdateWasUserInitiated && lastClickedPACode === paCode) {
                            // if our update was user initiated, apply focus to the appropriate element for accessibility purposes
                            $('.make-my-dealer a', $el).focus();
                            dealerStateUpdateWasUserInitiated = false;
                        }
                    }
                }
            });
        });
    }

    function selectSearchOption() {
        var $el = $(this);
        var opt = $el.val();
        var $cnt = componentElement($el, '.search-container');
        var $input = $('.search .search-text-' + opt, $cnt);
        dealerLib.updateSearchHints(componentElement(this, '.type-ahead-results'), getSearchData.call(this), $input, componentElement(this, '.search-suggestions-info'), true);
        var $parent = $el.parent();
        var $labels = $parent.closest('.search-options').find('label');
        $labels.removeClass('selected').find('.txt-label').attr({'aria-checked': 'false', 'tabindex': '-1'});
        $parent.addClass('selected').find('.txt-label').attr({'aria-checked': 'true', 'tabindex': '0'}).focus();
        $('.search-wrap .search', $cnt).toggleClass('show-location', opt === 'location');
        $('.search input', $cnt).hide();
        $input.show();
    }

    function updateSearchTextState(ev) {
        if (ev.type === 'focusin') {
            ev.preventDefault();
        }

        var focus = ev.type !== 'focusout';
        var $txt = $(this);
        var val = $txt.val();
        var hasValue = val.length > 0;
        var $cnt = componentElement($txt, '.search-container');
        setTimeout(function() {
            // in timeout to allow clicks to propagate and focus to transfer
            var active = $(document.activeElement);

            $('.search-action', $cnt).toggle(!hasValue);
            if (!active.hasClass('search-submit')) {
                $('.search-submit', $cnt).toggle(focus && hasValue);
                $('.search-clear', $cnt).toggle(!focus && hasValue);
            } else {
                $('.search-submit', $cnt).one('focusout', function() {
                    $('.search-submit', $cnt).toggle(focus && hasValue);
                    $('.search-clear', $cnt).toggle(!focus && hasValue);
                });
            }

            if (!active.hasClass('geo-btn') && canToggleGeo) {
                $('.geo', $cnt).toggle(FD.Brand.Util.env.geoLocation() && (focus || (!focus && (active.hasClass('search-submit') || active.hasClass('search-clear')))));
            } else {
                canToggleGeo = true;
                $('.geo', $cnt).toggle(FD.Brand.Util.env.geoLocation());
            }
        }, 150);
        if(ev.type === 'keyup') {
            // NGBS3-10835 - hide error message on keypress so error message doesn't obscure type ahead results
            searchError();
            if(ev.keyCode === 13) {
                searchSubmit.call($txt);
            } else if (ev.keyCode === 40) {
                // if we're the 'down' arrow and our search suggestions are populated and visible...
                // BRAND-12331
                if ($txt.hasClass('fgx-list-shown')) {
                    var $resultsContainer = $('.type-ahead-results:visible', $cnt).find('ul');
                    // focus on the very first type-ahead result item
                    var firstItem = $resultsContainer.find('li').first();
                    firstItem.focus();
                }
            } else {
                dealerLib.updateSearchHints(componentElement(this, '.type-ahead-results'), getSearchData.call(this), $txt, componentElement(this, '.search-suggestions-info'));
            }
        }
    }

    function getSearchData() {
        var $cnt = componentElement($(this), '.search-container');
        var $txt = $('.search input:visible', $cnt);
        return {
            $txt: $txt,
            val: $txt.val(),
            isDealer: $txt.hasClass('search-text-dealer')
        };
    }

    function getMtxDealerType() {
        return (currentFilters && currentFilters.ids && _.indexOf(currentFilters.ids, OAR_FILTER_ID) > -1) ? 'oar dealer' : 'dealer';
    }

    function fireDealerSearchMtx(isInitial, searchType, dealerType) {
        var searchAction = (isInitial || _searchInactive) ? dealerSearchAction : dealerAdditionalSearchAction;
        var searchActionOwner = (isInitial || _searchInactive) ? dealerSearchActionOwner : dealerAdditionalSearchActionOwner;
        var mtxAction = (isOwnerContext && typeof(searchActionOwner) !== 'undefined') ? searchActionOwner : searchAction;
        if (mtxAction && typeof(mtxAction) !== 'undefined') {
            FD.Brand.Metrics.handler.direct(
                mtxAction, {
                    $$searchType: searchType,
                    $$dealerType: dealerType
                }
            );
        }
        resetSearchActivityTimer();
    }

    function paCodeSubmit(paCode) {
        var $cnt = componentElement(this, '.search-container');
        var srch = getSearchData.call($cnt);
        var params = {
            make: ctx.make,
            dealerPACode: paCode
        };
        currentSearchType = 'dealerName';
        currentSearchTerm = srch.val;
        dealerSearchType = 'manual search:dealer';
        var mtxDealerType = getMtxDealerType();
        user.location.setGeoPACode(null);
        setBusy.call($cnt, true);
        getDealer.call($cnt, params).done(function() {
            setBusy.call($cnt, false);
            setLocationState(true);
            srch.$txt.toggleClass('fgx-list-shown', false);//BRAND-12331
            srch.$txt.removeAttr('aria-activedescendant');
            // clear out search error and last successful search if successful - NGBS3-5841
            searchError();
            setLastSearch('', '', '');

            // collapse advanced search panel upon successful search
            advancedSearchOvr.hide();

            // new metrics call
            fireDealerSearchMtx(isInitialSearch, dealerSearchType, mtxDealerType);
            if (isInitialSearch) {
                isInitialSearch = false;
            }
        }).fail(function(resp) {
            setBusy.call($cnt, false);
            updateError(resp, isPostal);
        });
    }

    function searchSubmit() {
        var $el = $(this);
        var $cnt = componentElement(this, '.search-container');
        var srch = getSearchData.call($cnt);
        var $input = (srch.isDealer) ? $('.search .search-text-dealer', $cnt) : $('.search .search-text-location', $cnt);
        var isPostal = false;
        var stateRegex = /^[a-zA-Z]{2}$/g;
        var useInitialMtx = false;
        // if our calling element is the advanced search cta, fire the appropriate metric
        if ($el.hasClass('apply-advanced')) {
            var filterArr = [currentRadius].concat(currentFilters.ids || []);
            var filterStr = filterArr.join('|');
            var mtxAction = (isOwnerContext) ? applyAdvancedSearchClickActionOwner : applyAdvancedSearchClickAction;
            FD.Brand.Metrics.handler.direct(
                mtxAction, {
                    $$currentFilters: filterStr
                }
            );
        }
        // if we have search filters selected, we should set minDealers to zero.
        var minDealers = (currentFilters.ids.length > 0) ? 0 : 1;
        var params = {
            make: ctx.make,
            radius: currentRadius,
            filter: currentFilters.ids.join(';'),
            minDealers: minDealers,
            maxDealers: 25
        };
        dealerLib.updateSearchHints(componentElement(this, '.type-ahead-results'), getSearchData.call(this), $input, componentElement(this, '.search-suggestions-info'), true);
        if(!srch.val) {
            searchError(null, srch.isDealer ? 'required-dealer' : 'required-location');
            return;
        }
        if (params.radius === lastSearch.radius && params.filter === lastSearch.filter && srch.val === lastSearch.searchTerm) {
            // same exact search as previous...
            searchError(null, 'duplicate-search');
            return
        }
        // validate value
        if (srch.isDealer) {
            params.dealerName = srch.val;
        } else {
            if ((/^(?=.*[a-zA-Z])(?=.*[0-9])/.test(srch.val)) || (/\d+/.test(srch.val))) {
                if (!(new RegExp(cfg.validationZipCode)).test(srch.val)) {
                    searchError(4);
                    return;
                }
                params.postalCode = srch.val;
                isPostal = true;
            } else {
                if (!/^[A-Za-z.,\-\' ]+$/.test(srch.val)){
                    searchError(7);
                    return;
                }

                if (srch.val.indexOf(',') < 0) {
                    if (dealerLib.isFullStateName(srch.val) || stateRegex.test(srch.val)) {
                        params[ctx.region === 'CA' ? 'province' : 'state'] = srch.val;
                    } else {
                        params.city = srch.val;
                    }
                } else {
                    var val = srch.val.split(',');
                    params.city = (val[0] || '').trim();
                    if (val.length > 1) {
                        params[ctx.region === 'CA' ? 'province' : 'state'] = (val[1] || '').trim();
                    }
                }
            }
        }
        // set flags for user message text
        currentSearchType = (srch.isDealer) ? 'dealerName' : 'location';
        currentSearchTerm = srch.val;
        // set searchType mtx substitution
        dealerSearchType = (srch.isDealer) ? 'manual search:dealer' : "manual search:location";

        if(isInitialSearch) {
            _location = user.location.current();
            if(_location && _location.geoPACode) {
                params.prefDealerPACode = _location.geoPACode;
            }
            useInitialMtx = true;
            isInitialSearch = false;
        }

        if (searchIsGeo) {
            searchIsGeo = false;
            dealerSearchType = 'current location';

            if(srch && srch.$txt && srch.$txt.length > 0) {
                var paCode = srch.$txt.attr('data-geo-pa-code') || '';
                if(paCode) {
                    params.prefDealerPACode = paCode;
                    srch.$txt.removeAttr('data-geo-pa-code');
                }
            }
        }


        // update our 'last search' object and our deeplink
        setLastSearch(currentSearchTerm, params.radius, params.filter);
        updateStandardDeeplink(currentSearchType, currentSearchTerm, params.radius, params.filter);

        var mtxDealerType = getMtxDealerType();

        setBusy.call($cnt, true);
        getDealers.call($cnt, params).done(function() {
            setBusy.call($cnt, false);
            if(isPostal) {
                currentPostalCode = params.postalCode;
                user.location.setPostalCode(currentPostalCode, (params && params.prefDealerPACode || ''));
            }
            setLocationState(true);
            srch.$txt.toggleClass('fgx-list-shown', false);//BRAND-12331
            srch.$txt.removeAttr('aria-activedescendant');

            if (currentDealers.length === 1 && currentDealers[0].Distance && currentDealers[0].Distance > currentRadius) {
                // we've gotten an automated search extension...show the error messaging
                searchError(null, 'search-extension');
            } else {
                // clear out search error if successful, and if we aren't an auto-extension search - NGBS3-5841
                searchError();
            }

            // collapse advanced search panel upon successful search
            advancedSearchOvr.hide();
            // BRAND-6358 - blur input to allow for soft mobile keyboards to close
            $input.blur();

            //scroll body to the locateA dealer component
            var componentOffset = $('.dealer-standard').offset().top - $('.fordMainNavigation, .lincolnMainNavigation').first().height();

            if ($('html, body').scrollTop() > componentOffset) {
                $('html, body').scrollTop(componentOffset);
            }

            // new metrics call
            fireDealerSearchMtx(useInitialMtx, dealerSearchType, mtxDealerType);
        }).fail(function(resp) {
            setBusy.call($cnt, false);
            updateError(resp, isPostal);
        });
    }

    function getDealer(params) {
        var $cnt = componentElement(this, '.location-aware');
        var def = $.Deferred();
        ngp.dealer(params).done(function(dealer) {
            if(!dealer || dealer.length === 0) {
                def.reject(dealer);
                return;
            }

            dealers = [];
            currentDealers = [];
            dealersShown = 1;
            $('.view-more', $cnt).hide();

            var deskList = $('.dealers .dealer-list', $cnt);
            var idx = 0; // we will only ever have one dealer from a PA Code Search
            deskList.empty();

            dealer = dealerLib.updateDealer(dealer, idx, salesOpenUntil, salesOpenAgain, preferredDealer, dealerDetailsPageLink, hoursDisplayType);

            var hasDealerUrl = !!(dealer.URL && !_.isEmpty(dealer.URL));
            updateDealerNameLink(dealer, hasDealerUrl);

            var hideTxtOverride = (hideTextOnOwner === 'true' && isOwnerContext);
            var prm = {
                dealer: dealer,
                cfg: cfg,
                showTextDealer: (ctx.showTextDealer && !hideTxtOverride),
                showScheduleSvc: (showScheduleService === 'true' && isOwnerContext),
                showRequestSvc: (showRequestService === 'true' && isBfnContext),
                hideChat: (hideChatOnOwner === 'true' && isOwnerContext),
                hideDirections: (hideDirectionsOnOwner === 'true' && isOwnerContext),
                useFdafCallTrkNum: !!(isBfnContext && dealer && dealer.fdafcalltrknum && dealer.fdafcalltrknum != ''),
                hasDealerUrl: hasDealerUrl,
                isLincoln: (ctx && ctx.make === 'Lincoln')
            };
            dealer.$el = $(templates.dealerItem(prm)).data('dealer', dealer);

            if (isOwnerContext) {
                updateDealerClickActionsOwner();
            }

            if (dealer.dealerType !== 'Dealer') {
                $('.my-dealer', dealer.$el).hide();
                $('.make-my-dealer', dealer.$el).hide();
            }

            checkChatStatus(dealer);

            if (detailAlwaysExpanded) {
                dealer.$el.addClass('expanded');
            }

            dealer.$el.appendTo(deskList);
            dealer.selected = true;

            $cnt.data('dealers', [dealer]);
            var map = $cnt.data('map');
            if(map) {
                map.dispose();
                $cnt.data('map', null);
            }
            createMap($cnt);
            if (!hasDeeplink) updatePostalCodeState();
            updatePreferred();
            def.resolve(dealer);
        }).fail(function(resp) {
            def.reject(resp);
        });
        return def.promise();
    }

    function getDealers(params) {
        var $wrapper = componentElement(this);
        var $cnt = componentElement(this, '.location-aware');
        var def = $.Deferred();
        var _api = ['dealers'],
            _promises = [],
            _errors = [],
            _dealers = [];

        /*BRAND-10911: replaced this logic with the logic in the if statement below
        if(params.filter.indexOf('CollisionRepair') > -1 && hideIndependent === 'false') {
            includesIndependent = true;
            _api.push('serviceLocations');
        } else {
            includesIndependent = false;
        }*/

        if(currentFilters.items && currentFilters.items.length === 1 && hideIndependent === 'false') {
            var itm = currentFilters.items[0];
            if(itm && itm.exclusive && itm.type === 'dealersAndServiceLocations') {
                _api[0] = 'dealersAndServiceLocations';
            }
        }

        var onGetDealersSuccess = function(dealers) {
            if(!dealers || dealers.length === 0) {
                var errorData = {
                    message: "[locateADealer - getDealers] - no dealers were returned."
                };
                _errors.push(errorData);
                return;
            }
            if(ctx.region === 'CA') {
                dealers.map(function(dealer) {
                    return dealer.Distance = dealer.DistanceKM;
                });
            }
            _dealers.push(dealers);
        }

        var onGetDealersError = function(response) {
            var resp = (response && response.Response) ? response.Response : {};
            var errorData = {
                message: resp.Message || resp.Error || '[locateADealer - getDealers] - error retrieving the dealers'
            };
            _errors.push(errorData);
        }

        _.each(_api, function(method) {
            var promise = ngp[method](params);
            promise.then(
                onGetDealersSuccess,
                onGetDealersError
            );
            _promises.push(promise);
        });

        $.when.apply($, _promises).done(function() {
            if(_api.length === _errors.length) {
                //There were errors for all method calls...reject our promises
                _.each(_errors, function(err) {
                    if(err.message) {
                        def.reject(err.message);
                    }
                });
            } else {
                var dealers = processDealers(_dealers, $cnt);
                def.resolve(dealers);
            }
        }).fail(function(resp) {
            def.reject(resp);
        });

        return def.promise();
    }

    function processDealers(_dealers, $cnt) {
        var deskList = $('.dealers .dealer-list', $cnt);
        deskList.empty();

        // reset our dealers array and our visibility counter

        dealers = [];
        currentDealers = [];
        dealersShown = 0;
        if(_dealers.length > 1) {
            _.each(_dealers, function(dealerList) {
                dealers = dealers.concat(dealerList);
            });
        } else if(_dealers.length === 1) {
            dealers = _dealers[0];
        }

        if (dealers.length > 5) {
            $('.view-more', $cnt).show();
        } else {
            $('.view-more', $cnt).hide();
        }

        /*BRAND-10911: This logic is no longer needed since we are now using a new service that returns results from
        both the dealers and serviceLocations APIs that are already sorted.
        if (includesIndependent) {
            console.log('Includes Independent!!!');
            // we need to sort by distance here to account for combination of dealers and independent body shops
            dealers = _.sortBy(dealers, function(dealer) {
                var dist = 1.0;
                if(dealer && dealer.Distance) {
                    dist = parseFloat(dealer.Distance);
                }
                return dist;
            });
        } else {
            console.log('NO INDEPENDENT!!!');
        }*/

        // if we have a preferred dealer, make sure that is the first dealer in our array
        if (preferredDealer != null && dealers.length > 1) {
            _.some(dealers, function(dealerItem) {
                if (preferredDealer.PACode === dealerItem.PACode) {
                    var index = dealers.indexOf(dealerItem);
                    dealers.splice(index,1);
                    dealers.unshift(dealerItem);
                    return true;
                }
            });
        }

        // restrict the number of dealers to 25
        if(dealers.length > 25) {
            dealers = dealers.slice(0, 25);
        }

        showDealers($cnt, false);

        if (!hasDeeplink) updatePostalCodeState();
        updatePreferred();
        return dealers;
    }

    function showDealers($cnt, setFocus) {
        var deskList = $('.dealers .dealer-list', $cnt);
        var startIdx = dealersShown;
        dealersShown += 5;
        if (dealersShown >= dealers.length) {
            dealersShown = dealers.length;
            $('.view-more', $cnt).hide();
        }
        for (var i = startIdx; i < dealersShown; i ++) {
            var dealer = dealerLib.updateDealer(dealers[i], i, salesOpenUntil, salesOpenAgain, preferredDealer, dealerDetailsPageLink, hoursDisplayType);
            var hasDealerUrl = !!(dealer.URL && !_.isEmpty(dealer.URL));
            if (hasDealerUrl) {
                dealer.URL = dealerLib.appendT3QS(dealer.URL, dealer.mtAttrQS);
            }

            updateDealerNameLink(dealer, hasDealerUrl);

            var hideTxtOverride = (hideTextOnOwner === 'true' && isOwnerContext);
            var prm = {
                dealer: dealer,
                cfg: cfg,
                showTextDealer: (ctx.showTextDealer && !hideTxtOverride),
                showScheduleSvc: (showScheduleService === 'true' && isOwnerContext),
                showRequestSvc: (showRequestService === 'true' && isBfnContext),
                hideChat: (hideChatOnOwner === 'true' && isOwnerContext),
                hideDirections: (hideDirectionsOnOwner === 'true' && isOwnerContext),
                useFdafCallTrkNum: !!(isBfnContext && dealer && dealer.fdafcalltrknum && dealer.fdafcalltrknum != ''),
                hasDealerUrl: hasDealerUrl,
                isLincoln: (ctx && ctx.make === 'Lincoln')
            };

            dealer.$el = $(templates.dealerItem(prm)).data('dealer', dealer);

            if (dealer.dealerType !== 'Dealer') {
                $('.my-dealer', dealer.$el).hide();
                $('.make-my-dealer', dealer.$el).hide();
            }
            /*
            Will C. - I don't think we need this anymore, but leaving it in as a comment just in case it comes up...
            if (dealer.SmarttProvider !== 'A' && dealer.SmarttProvider !== 'F') {
                $('.schedule-service', dealer.$el).hide();
            }
            */
            checkChatStatus(dealer);

            if (detailAlwaysExpanded) {
                dealer.$el.addClass('expanded');
            }

            dealer.$el.appendTo(deskList);
            dealer.selected = false;

            if (i === startIdx && setFocus) {
                dealer.$el.find('.dealer-expand-btn').focus();
            }

            currentDealers.push(dealer);
        }

        if (hasPreferred) {
            // make sure we're updating the list to set the proper state on the 'Make My Dealer' buttons
            updatePreferred();
        }

        if (isOwnerContext) {
            updateDealerClickActionsOwner();
        }

        if (currentSearchType === 'dealerName') {
            // hide distance
            $('.info .distance').hide();
        }
        $cnt.data('dealers', currentDealers);
        updateMap($cnt);
    }

    function updateDealerNameLink(dealer, hasDealerUrl) {
        if (!hideDealerWebsite && dealerWebsiteLabel && hasDealerUrl) {
            dealer.nameUrl = dealer.URL;
            dealer.nameAriaLabel = dealerWebsiteAriaLabel;
            dealer.nameClickAction = JSON.stringify(_websiteClickAction);
            dealer.nameLinkTarget = dealerWebsiteCtaTarget;
            dealer.nameCls = cfg && cfg.exitOverlayCls || '';
        } else {
            dealer.nameUrl = dealer.DeepLinkUrl;
            dealer.nameAriaLabel = dealerDetailsAriaLabel;
            dealer.nameClickAction = JSON.stringify(_detailsClickAction);
            dealer.nameLinkTarget = '_self';
            dealer.nameCls = '';
        }
    }

    function updateDealerClickActionsOwner() {
        if (typeof callClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .phone.hide-on-desktop a', components).attr('data-fd-metrics-click', JSON.stringify(callClickActionOwner));
        }
        if (typeof textClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .text-dealer a', components).attr('data-fd-metrics-click', JSON.stringify(textClickActionOwner));
        }
        if (typeof chatClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .dealer-chat a', components).attr('data-fd-metrics-click', JSON.stringify(chatClickActionOwner));
        }
        if (typeof ratingsInfoClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .ratings-count .icon.icon-info-25px.clickable', components).attr('data-fd-metrics-click', JSON.stringify(ratingsInfoClickActionOwner));
        }
        if (typeof dealerDetailsClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .dealer-detail a', components).attr('data-fd-metrics-click', JSON.stringify(dealerDetailsClickActionOwner));
        }
        if (typeof dealerReviewsClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .dealer-rating a:not(.icon-info-25px)', components).attr('data-fd-metrics-click', JSON.stringify(dealerReviewsClickActionOwner));
        }
        if (typeof directionsClickActionOwner !== 'undefined') {
            $('.dealer-list li.dealer .dealer-directions a', components).attr('data-fd-metrics-click', JSON.stringify(directionsClickActionOwner));
        }
        if (typeof dealerWebsiteClickActionOwner !== 'undefined' && !hideDealerWebsite) {
            $('.dealer-list li.dealer a.dealer-website', components).attr('data-fd-metrics-click', JSON.stringify(dealerWebsiteClickActionOwner));
        }
    }

    function updateMap($cnt) {
        var map = $cnt.data('map');
        if(map) {
            map.dispose();
            $cnt.data('map', null);
        }
        createMap($cnt);
    }

    function checkChatStatus(dealer) {
        // dealer chat
        if (ctx.region !== 'CA') {
            // check for chat
            ngp.dealerChatStatus({dealerPACode: dealer.PACode, make: ctx.make}).done(function(resp) {
                if(resp && resp.url) {
                    var url = resp.url;
                    $('.dealer-chat a', dealer.$el).on('click', function(event){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        // new metrics
                        FD.Brand.Metrics.handler.direct(
                            $(this).attr('data-fd-metrics-click')
                        );
                        window.open(url, '_blank', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,width=350,height=620');
                    });
                    $('.dealer-chat', dealer.$el).show();
                } else {
                    $('.dealer-chat', dealer.$el).hide();
                }
            });
        } else {
            $('.dealer-chat', dealer.$el).hide();
        }
    }

    function getCurrentPosition() {
        var $cnt = componentElement(this);
        var err = function() {
            setBusy.call($cnt);
            searchError.call($cnt, 5, null);
        };
        setBusy.call($cnt, true);
        win.navigator.geolocation.getCurrentPosition(function(position) {
            if(position && position.coords) {
                // ensure location is selected so our deeplink is accurate.
                componentElement($cnt, '.search-options .txt-label.location').trigger('click');
                ngp.dealers({
                    make: ctx.make,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    radius: currentRadius,
                    minDealers: 1
                }).done(function(resp) {
                    if(resp && resp.length > 0) {
                        searchIsGeo = true;
                        var srch = getSearchData.call($cnt);
                        srch.$txt.val(resp[0].Address.PostalCode);
                        srch.$txt.attr('data-geo-pa-code', resp[0].PACode);
                        setBusy.call($cnt);
                        searchSubmit.call($cnt);
                    } else {
                        err()
                    }
                });
            } else {
                err()
            }
        }, err, locationOptions);
    }

    function setLastSearch(searchTerm, radius, filter) {
        lastSearch.searchTerm = searchTerm;
        lastSearch.radius = radius;
        lastSearch.filter = filter;
    }

    function updatePostalCodeState() {
        // note: if we were loaded with a deeplink, we don't subscribe to the location state, so this method will never be called
        var newLocation = user.location.current();
        var newPostalCode = newLocation.postalCodeSource === 'FPI' && newLocation.postalCode || '';
        var akamaiPostalCode = newLocation.postalCodeSource === 'Akamai' && newLocation.postalCode || '';
        var useInitialMtx = false;
        if(newPostalCode) {
            if(newPostalCode !== currentPostalCode) {
                // need to apply new postal code to search if there's no search term already
                if (currentSearchTerm == null || currentSearchTerm == undefined) {
                    $('.search-text-location', components).val(newPostalCode);
                }
                currentPostalCode = newPostalCode;
                // if we have advanced search options selected, we should set minDealers to zero.
                var minDealers = (currentFilters.ids.length > 0) ? 0 : 1;
                var params = {
                    make: ctx.make,
                    radius: currentRadius,
                    filter: currentFilters.ids.join(';'),
                    minDealers: minDealers,
                    maxDealers: 25,
                    postalCode: newPostalCode
                };
                setLastSearch(newPostalCode, params.radius, params.filter);
                var mtxDealerType = getMtxDealerType();

                if(isInitialSearch) {
                    if(newLocation.geoPACode) {
                        params.prefDealerPACode = newLocation.geoPACode;
                    }
                    isInitialSearch = false;
                    useInitialMtx = true;
                }

                getDealers.call(components, params).done(function() {
                    setLocationState(true);
                    // collapse advanced search panel upon successful search
                    advancedSearchOvr.hide();
                    // new metrics call
                    fireDealerSearchMtx(useInitialMtx, dealerSearchType, mtxDealerType);
                });
            }
        } else if (akamaiPostalCode) {
            // apply to search text, but don't search
            if (currentSearchTerm == null || currentSearchTerm == undefined) {
                $('.search-text-location', components).val(akamaiPostalCode);
                setLocationState(false);
            }
        } else if (currentSearchTerm == null || currentSearchTerm == undefined) {
            setLocationState(false);
            // page was loaded with no FPI or Akamai Zip, fire metric accordingly, but only once
            if (!onLoadFiredOnce) {
                if ((!isOwnerContext && typeof onLoadNoZipAction !== 'undefined') || (isOwnerContext && typeof onLoadNoZipActionOwner === 'undefined' && typeof onLoadNoZipAction !== 'undefined')) {
                    FD.Brand.Metrics.handler.direct(
                        onLoadNoZipAction
                    );
                    onLoadFiredOnce = true;
                } else if (isOwnerContext && typeof onLoadNoZipActionOwner !== 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        onLoadNoZipActionOwner
                    );
                    onLoadFiredOnce = true;
                }
            }
        }

        if(isInitialSearch) {
            isInitialSearch = false;
        }
    }

    function setBusy(isBusy) {
        componentElement(this).find('.ford-busy').toggle(isBusy);
    }

    function updateError(resp, isPostal) {
        var errKey = 2;
        if(isPostal) {
            if(resp && resp.responseJSON && resp.responseJSON.Response) {
                var msg = resp.responseJSON.Response.Message;
                errKey = (msg.indexOf("Invalid Postal Code") > -1) ? 4 : 2;
            } else if (resp === '[locateADealer - getDealers] - no dealers were returned.') {
                if (lastSearch.filter !== '') {
                    errKey = 3;
                } else {
                    errKey = 2;
                }
            } else {
                errKey = 1;
            }
        }
        searchError(errKey);
    }

    /* NZ - BRAND-15584 - The searchError function now will always dynamically update the .text.error element with the proper
     * error message OR an empty string instead of hiding/showing the elements in some situations and dynamically updating
     * the .text.error element in others. Also, the 'err-hidden' class should be toggled on the .message.error element
     * to indicate whether the error is visible or not instead of actually setting the display of that element as it now
     * always should be 'displayed' so the screen reader can see it.
     */
    function searchError(err, cls) {
        var $el = $('.search-container .message.error', components),
            $txtEl = $el.find('.text.error'),
            hideErr = true;
        $txtEl.text('');
        var errMsg = (cls) ? (_searchErrors[cls] || '') : ((err && cfg.errors) ? (cfg.errors[err] || '') : '');
        if (errMsg) {
            $txtEl.text(errMsg);
            hideErr = false;
        }
        $el.toggleClass('err-hidden', hideErr);
    }

    function getLabel(key) {
        return _labels && _labels[key] || '';
    }

    // Search Activity Timeout Logic
    function setSearchInactiveFlag(val) {
        _searchInactive = val;
    }

    function resetSearchActivityTimer() {
        startSearchActivityTimer(_searchActivityTimeoutDelaySec);
    }

    function startSearchActivityTimer(delayInSecs) {
        if (_searchActivityTimeout) {
            win.clearTimeout(_searchActivityTimeout);
        }
        _searchActivityTimeout = win.setTimeout(function() {
            setSearchInactiveFlag(true);
            _searchActivityTimeout = null;
        }, delayInSecs * 1000);
        setSearchInactiveFlag(false);
    }

    function loadMapControl() {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            if(mapControlLoaded) {
                def.resolve();
            } else {
                win._fgx_mapControlLoaded = function() {
                    mapControlLoaded = true;
                    def.resolve();
                    delete win._fgx_mapControlLoaded;
                };
                util.url.loadAsScript(ctx.settings.mapHost + '?callback=_fgx_mapControlLoaded')
                    .fail(function() {
                        def.reject();
                    });
            }
        } else {
            util.log('locateADealer: Microsoft Map library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    function createMap($cnt) {
        var map = $cnt.data('map');
        var dealers = $cnt.data('dealers');
        var isExpanded = componentElement($cnt).hasClass('expanded');

        if(map || !dealers) {
            return;
        }
        loadMapControl().done(function() {
            var mapApi = Microsoft.Maps;
            map = new mapApi.Map(
                $cnt.find('.map')[0], {
                    credentials: ctx.settings.mapKey,
                    mapTypeId: Microsoft.Maps.MapTypeId.road,
                    enableSearchLogo: false,
                    enableClickableLogo: false,
                    enableInertia: true,
                    liteMode: false,
                    showCopyright: false,
                    showMapTypeSelector: false,
                    showLocateMeButton: false,
                }
            );

            map.setOptions({
                disablePanning: !isExpanded,
                disableScrollWheelZoom: !isExpanded,
                disableZooming: !isExpanded,
                showZoomButtons: isExpanded,
                showScalebar: false
            });

            globalMap = map;

            var locations = [];
            var center = null;
            var setDealerState = function(dealer, selected) {
                dealer.selected = selected;
                var entityState =  (selected) ? 'selected' : 'none';
                var iconText = '' + (dealer.index + 1) + '';
                dealer.pushpin.setOptions({
                    state: entityState,
                    icon: base64Img,
                    text: iconText,
                    textOffset: new Microsoft.Maps.Point(0, 10),
                    anchor: new Microsoft.Maps.Point(17.5, 46)
                });
            };

            _.each(dealers, function(dealer) {
                var location = new mapApi.Location(dealer.Latitude, dealer.Longitude);
                locations.push(location);
                if(dealer.selected) {
                    center = location;
                }
                var pushpin = new mapApi.Pushpin(location, {
                    width: 35,
                    height: 46
                });
                Microsoft.Maps.Events.addHandler(pushpin, 'click', function dealerPinClick(ev) {
                    if(!$(".dealer-standard.expanded").length){ //dont do anything when map clicked if not on map view
                        return false;
                    }

                    if($(".advanced-search.expanded").length){ //if open, close advanced search on dealer click so scrolls to correct dealer tile
                        advancedSearchOvr.hide();
                    }

                    var el = "#idx-" + pushpin.entity.iconText,
                        dealerIndex = pushpin.entity.iconText - 1;

                    //collapse previously opened dealer
                    $("li.dealer.expanded.selected").removeClass("expanded selected");

                    var dealerTile = $(el).closest('li.dealer[data-index="' + dealerIndex + '"]');
                    //expand selected dealer tile if not already expanded
                    if(!$(dealerTile).hasClass("expanded")){
                        dealerTile.addClass("expanded selected");
                    }

                    _.each(dealers, function(dealer) { // clear active pushpins
                        dealer.pushpin.setOptions({
                            state: 'none',
                            icon: base64Img,
                            anchor: new Microsoft.Maps.Point(17.5, 46)
                        });
                    });

                    pushpin.setOptions({ //toggle clicked pushpin active
                        state: 'selected',
                        icon: selectedBase64Image,
                        anchor: new Microsoft.Maps.Point(21, 55)
                    });

                    map.setView({ // center pushpin in map when clicked, requirement LAD redesign
                        center: dealer.pushpin.getLocation()
                    });

                    if( util.currentBreakpoint() === 'gux-bkpt-sm' ){ //mobile
                        if( $(".dealer-standard.expanded").length ) { //map view
                            //(distance from clicked dealer tile to top of container) - 16px for padding on li.dealer
                            scrollDistance = ($(el).offset().top - $(".dealer-list").offset().top) - 16;
                            $('.adv-search-target').scrollTop(scrollDistance);
                            //open dealer results if not opened already
                            if( !$(".dealer-standard.expanded .location-aware .dealers").hasClass("expanded") ) {
                                $(".dealer-standard.expanded .location-aware .dealers").addClass("opened");
                            }
                        } else { //list view
                            $('html').animate({ // - 86 is 70px mobile header height and 16px padding on li.dealer
                                scrollTop: $(el).offset().top - 86
                            }, 800);
                        }
                    } else { //desktop
                        if($(".dealer-standard.expanded").length) { //map view
                            //(distance from clicked dealer tile to top of container) - 16px for padding on li.dealer
                            scrollDistance = ($(el).offset().top - $(".dealer-list").offset().top) - 16;
                            $(".adv-search-target").animate({ //scroll past idx # of dealer tiles
                                scrollTop: scrollDistance
                            }, 800);
                        } else { //list view
                            $(".dealers").animate({ //scroll past idx # of dealer tiles
                                scrollTop: dealerIndex * $("li.dealer:not('.expanded')").outerHeight()
                            }, 800);
                        }
                    }

                });
                dealer.pushpin = pushpin;
                setDealerState(dealer, dealer.selected);
                var selectDealer = function() {
                    if(!dealer.selected) {
                        var selectedDealer = _.find(dealers, { selected: true });
                        if(selectedDealer) {
                            setDealerState(selectedDealer, false);
                        }
                        setDealerState(dealer, true);
                        map.setView({
                            center: dealer.pushpin.getLocation()
                        });
                    }
                };
                map.entities.push(pushpin);
            });
            // set map bounds
            if(locations.length > 1) {
                map.setView({
                    bounds: mapApi.LocationRect.fromLocations(locations)
                });
            } else {
                map.setView({
                    center: locations[0],
                    zoom: 11
                });
            }
            if(center) {
                map.setView({
                    center: center
                });
            }
        });
    }

    function sendToPhone(ev) {
        ev.preventDefault();
        var dealer = $(this).closest('.dealer').data('dealer');
        var dealerPhone = '';
        var _make = ctx && ctx.make || '';
        if(dealer && typeof(dealer) != 'undefined') {
            if (_make === 'Ford' && dealer.dlrcalltrk_lad && dealer.dlrcalltrk_lad !== '') {
                dealerPhone = dealer.dlrcalltrk_lad;
            } else if (_make === 'Lincoln' && dealer.ldlrcalltrk_lad && dealer.ldlrcalltrk_lad !== '') {
                dealerPhone = dealer.ldlrcalltrk_lad;
            } else {
                dealerPhone = dealer.Phone;
            }
        }

        overlay.instance.sendToPhoneOverlay.show({
            title: dealer.Name,
            text: dealer.AddressStreet + ' ' + dealer.AddressCityStateZip,
            phone: dealerPhone
        }, $(this));
    }

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay, FD.Brand.Context, FD.Brand.User, FD.Brand.Util, FD.Brand.NgpServices, FD.Brand.Dealer);
/*global FD*/
;(function (win, $, _, brand, overlay, ctx, user, util, ngp, dealerLib) {

    var components;
    var cfg = null;
    var templates = {};
    var ovr;
    var mapControlLoaded = false;
    var mapWasExpanded = false;
    var dealerPageLink = $('#dd').data('moredealershref');
    var salesOpenUntil = $('#dd').data('sales-open-until');
    var salesOpenAgain = $('#dd').data('sales-open-again');
    var hoursDisplayType = $('#dd').data('hours-displaytype');
    var hideReviewsSection = $('#dd').data('hide-reviews-section');
    // click actions object
    var saveClickAction = $('#dd').data('save-click-action');
    var chatClickAction = $('#dd').data('chat-click-action');
    // owner-specific click actions
    var allDealersClickActionOwner = $('#dd').data('all-dealers-click-action-owner');
    var shareClickActionOwner = $('#dd').data('share-click-action-owner');
    var printClickActionOwner = $('#dd').data('print-click-action-owner');
    var saveClickActionOwner = $('#dd').data('save-click-action-owner');
    var unsaveClickActionOwner = $('#dd').data('unsave-click-action-owner');
    var callClickActionOwner = $('#dd').data('call-click-action-owner');
    var textClickActionOwner = $('#dd').data('text-click-action-owner');
    var chatClickActionOwner = $('#dd').data('chat-click-action-owner');
    var reviewsClickActionOwner = $('#dd').data('reviews-click-action-owner');
    var ratingsIBallClickActionOwner = $('#dd').data('ratings-iball-click-action-owner');
    var dealerWebsiteClickActionOwner = $('#dd').data('dealer-website-click-action-owner');
    var directionsClickActionOwner = $('#dd').data('directions-click-action-owner');
    var serviceWebsiteClickActionOwner = $('#dd').data('service-website-click-action-owner');
    var newInventoryClickActionOwner = $('#dd').data('new-inventory-click-action-owner');
    var usedInventoryClickActionOwner = $('#dd').data('used-inventory-click-action-owner');
    var viewMoreClickActionOwner = $('#dd').data('view-more-click-action-owner');
    var reviewsSortClickActionOwner = $('#dd').data('reviews-sort-click-action-owner');
    var reviewsTabClickActionOwner = $('#dd').data('reviews-tab-click-action-owner');
    var hoursSelectClickActionOwner = $('#dd').data('hours-select-click-action-owner');
    // owner context toggles
    var hideChatOnOwner = $('#dd').data('hide-chat-on-owner');
    var hideTextOnOwner = $('#dd').data('hide-text-on-owner');
    var hideDirectionsOnOwner = $('#dd').data('hide-directions-on-owner');
    var hideDealerWebsiteOnOwner = $('#dd').data('hide-dealer-website-on-owner');
    var hideServiceWebsiteOnOwner = $('#dd').data('hide-service-website-on-owner');
    var hideNewInventoryOnOwner = $('#dd').data('hide-new-inventory-on-owner');
    var hideUsedInventoryOnOwner = $('#dd').data('hide-used-inventory-on-owner');
    var hideScheduleServiceOnOwner = $('#dd').data('hide-schedule-service-on-owner');
    var initialHoursSection = $('#dd').data('initial-hours-section');
    var initialReviewsSection = $('#dd').data('initial-reviews-section');
    // end owner context toggles
    // bfn specific click actions
    var serviceWebsiteClickActionBfn = $('#dd').data('serviceWebsiteClickActionBfn');
    // end bfn specific click actions
    var daysLabel = $('#dd').data('days-label');
    var hoursLabel = $('#dd').data('hours-label');
    var minutesLabel = $('#dd').data('minutes-label');
    var secondsLabel = $('#dd').data('seconds-label');
    var notEnoughReviews = $('#dd').data('not-enough-reviews');
    var reviewsShowingTpl = $('#dd').data('reviews-showing-tpl');
    var showQuicklaneTooltip = $('#dd').data('show-quicklane-tooltip');
    var salesReviewPage = 1;
    var serviceReviewPage = 1;
    var cpoReviewPage = 1;
    var currentReviewSort = 'date';
    var currentReviewOrder = 'desc';
    var reviewsApiKey = ctx.settings['reviewsApiKey'] || '';
    var showCPOReviews = $('#dd').data('show-cpo-reviews');
    var reviewSortUpdated = false;
    var currentSalesCode;
    var currentPACode;
    var isOwnerContext = false;
    var isBfnContext = false;
    var isPreferred = false;
    var hasPreferred = false;
    var preferredDealer = null;
    var showReviews = false;
	if (hoursDisplayType === undefined || hoursDisplayType === '') hoursDisplayType = '12';
    var pushpinSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1485 1280" width="50" height="50"><path d="M880.313 912.231c-146.192 146.192-385.634 146.192-531.826 0-125.277-125.277-142.924-318.529-53.814-463.414l319.837-436.398 319.619 436.398c89.11 144.885 71.462 338.138-53.814 463.414v0zM724.534 535.966c-60.569-60.569-159.7-60.569-220.269 0s-60.569 159.918 0 220.487c60.569 60.786 159.7 60.786 220.269 0 60.786-60.569 60.786-159.918 0-220.487v0z" transform="translate(0,1024) scale(1, -1)" style="fill: #2096cd;"></path></svg>';
    
    if (ctx.make === 'Lincoln') {
        pushpinSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1485 1280" width="50" height="50"><path d="M880.313 912.231c-146.192 146.192-385.634 146.192-531.826 0-125.277-125.277-142.924-318.529-53.814-463.414l319.837-436.398 319.619 436.398c89.11 144.885 71.462 338.138-53.814 463.414v0zM724.534 535.966c-60.569-60.569-159.7-60.569-220.269 0s-60.569 159.918 0 220.487c60.569 60.786 159.7 60.786 220.269 0 60.786-60.569 60.786-159.918 0-220.487v0z" transform="translate(0,1024) scale(1, -1)" style="fill: #293338;"></path></svg>';
    }
    
    brand.setInitHandler('[data-fgx-dealer-details]', init);

    //////

    function init(newComponents, brandUrl) {

        components = newComponents;
        cfg = dealerLib.getDealerConfig();
        
        if(components.length === 0 || cfg == null || _.isEmpty(cfg)) {
            return;
        }
        
        if (cfg.suppressDealerHours) {
            $('.distance-hours > .divider', components).hide();
            $('.distance-hours > .sales-hours-description', components).hide();
            $('.hours-services > .hours-full', components).hide();
        }
        
        $('script[data-fgx-dealer-details-template-id]').each(function(idx, tmpl) {
            var $tmpl = $(tmpl);
            templates[$tmpl.attr('data-fgx-dealer-details-template-id')] = _.template(tmpl.innerHTML);
        });
        
        if (ctx.settings.deepLink) {
            setBusy.call(components, true);
            $('.error-msg').hide();
            
            var urlKey = ctx.settings.deepLink.substr(1);
            if (ctx.settings.deepLink.indexOf('/reviews') > -1) {
                urlKey = ctx.settings.deepLink.substr(1, (ctx.settings.deepLink.indexOf('/reviews') - 1));
                showReviews = true;
            }
            
            var prms = {
                make: ctx.make,
                urlKey: urlKey
            };

            if (cfg.hideDealerRatings) {
                $('.dealer-rating', components).hide();
            }
            
            if (cfg.hideMyDealer) {
                $('.save', components).hide();
            } else {
                $('.save > a', components).click(function(event){
                    if (isPreferred) {
                        setBusy.call(components, true);
                        user.dealer.removePreferred(currentPACode).done(function() {
                            // we're doing all our updates on the topic change
                        }).fail(function(resp){
                            // handle failure here (error msg about only saving one dealer?)
                            setBusy.call(components, false);
                        });
                    } else if (!hasPreferred) {
                        setBusy.call(components, true);
                        user.dealer.setPreferred(currentPACode).done(function() {
                            // metrics only, we're doing all our other updates on the topic change
                            if ((!isOwnerContext && typeof saveClickAction !== 'undefined') || (isOwnerContext && typeof saveClickActionOwner === 'undefined' && typeof saveClickAction !== 'undefined')) {
                                FD.Brand.Metrics.handler.direct(
                                    saveClickAction
                                );
                            } else if (isOwnerContext && typeof saveClickActionOwner !== 'undefined') {
                                FD.Brand.Metrics.handler.direct(
                                    saveClickActionOwner
                                );
                            }
                        }).fail(function(resp){
                            // handle failure here (error msg about only saving one dealer?)
                            setBusy.call(components, false);
                        });
                    }
                });
            }
            
            // hours dropdown
            $('.fgx-brand-select-container', components).on('change', function(ev) {
                var $el = $(this),
                    dropdownId = $el.attr('data-dropdown-id');
                updateSelected($el, dropdownId);
            });
            // this needs to be global, because it's scoped to a tooltip outside of the component
            $('body').on('click', '.make-my-dealer.confirm', confirmMyDealerUpdate);

            checkForContext();
            // check session storage and set owner context if necessary
            if (sessionStorage['fgx-lad-ownerCtx']) {
                isOwnerContext = true;
                isBfnContext = false;
            } else if (sessionStorage['fgx-lad-bfnCtx']) {
                isBfnContext = true;
                isOwnerContext = false;
            }
            // check for last known deeplink and update our 'All Dealers' href if applicable
            if (sessionStorage['fgx-lad-lastKnownDeeplink']) {
                var $allDealersEl = $('.all-dealers', components);
                var baseUrl = $allDealersEl.attr('href');
                $allDealersEl.attr('href', baseUrl + '#' + sessionStorage['fgx-lad-lastKnownDeeplink']);
            }
            
            getDealer.call(components, prms).done(function() {
                // finish setup
                $('.dealer', components).show();
                user.dealer.subscribe(onDealerStateChange);
                createMap.call(components);
                setBusy.call(components, false);
                if (hideReviewsSection != true && hideReviewsSection !== 'true') {
                    initReviews(components);
                }
                
            }).fail(function(resp) {
                setBusy.call(components, false);
                $('.error-msg', components).show();
                $('.dealer', components).hide();
            });
            
        } else {
            $('.dealer').hide();
            $('.error-msg').show();
        }

    }

    function checkForContext() {
        if (window.location.hash !== '') {
            var hash = window.location.hash;
            var segments = window.location.hash.split('/');
            for (var i = 0; i < segments.length; i ++) {
                var str = segments[i];
                if (str === 'context') {
                    var dlCtx = segments[ (i + 1) ];
                    if (dlCtx === 'owner') {
                        // this will ensure that the component maintains owner context for the duration of the browsing session
                        sessionStorage['fgx-lad-ownerCtx'] = true;
                        sessionStorage.removeItem('fgx-lad-bfnCtx');
                        isOwnerContext = true;
                        isBfnContext = false;
                        // make sure we remove our hash once we're done...
                        window.location.hash = '';
                    } else if (dlCtx === 'bfn') {
                        sessionStorage['fgx-lad-bfnCtx'] = true;
                        sessionStorage.removeItem('fgx-lad-ownerCtx');
                        isBfnContext = true;
                        isOwnerContext = false;
                        // make sure we remove our hash once we're done...
                        window.location.hash = '';
                    }
                }
            }
        }
    }

    // BRAND-17789 - trigger the necessary action after the value in the 'select' element is updated.
    function updateSelected($elm, dropdownId, skipMtx) {
        if (!$elm || $elm.length === 0 || !dropdownId) {
            return;
        }
        var newVal = $elm.val();
        if (newVal) {
            if (dropdownId === 'hours') {
                var $container = $elm.closest('.hours-full'),
                    selector = '.items.' + newVal;
                // show / hide respective hours list
                $('.items', $container).hide();
                $(selector, $container).show();
            } else if (dropdownId === 'sort-reviews') {
                updateReviewSort(newVal, true);
            }

            var currMtxAction = $elm.attr('data-fd-metrics-change');
            if (!skipMtx && currMtxAction && typeof(currMtxAction) != 'undefined') {
                var _data = getMtxData($elm, newVal);
                FD.Brand.Metrics.handler.direct(
                    currMtxAction,
                    _data
                );
            }
        }
    }

    function getMtxData($elm, val) {
        var output = {};
        if ($elm && $elm.length !== 0 && val) {
            var $opt = $elm.find('option[data-custom-value="' + val +'"]'),
                mtxDataStr = $opt.attr('data-fd-metrics-data'),
                mtxData = (mtxDataStr && typeof(mtxDataStr) != 'undefined') ? JSON.parse(mtxDataStr) : {};
            output = _.extend({}, mtxData || {});
        }
        return output;
    }
    
    function onMakeMyDealerClick() {
        var currentPACode = $(this).data('pacode');
        if (!hasPreferred) {
            // we don't have a preferred dealer yet, just save
            setBusy.call(components, true);
            user.dealer.setPreferred(currentPACode).done(function() {
                if ((!isOwnerContext && typeof saveClickAction !== 'undefined') || (isOwnerContext && typeof saveClickActionOwner === 'undefined' && typeof saveClickAction !== 'undefined')) {
                    FD.Brand.Metrics.handler.direct(
                        saveClickAction
                    );
                } else if (isOwnerContext && typeof saveClickActionOwner !== 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        saveClickActionOwner
                    );
                }
                setBusy.call(components, false);
            }).fail(function(resp){
                // handle failure here (error msg about only saving one dealer?)
                setBusy.call(components, false);
            });
        }
    }
    
    function confirmMyDealerUpdate() {
        var newPACode = $(this).data('pacode');
        var currentPACode = preferredDealer.PACode;
        setBusy.call(components, true);
        user.dealer.removePreferred(currentPACode).done(function() {
            // once we've removed the current, set the new
            user.dealer.setPreferred(newPACode).done(function() {
                if ((!isOwnerContext && typeof saveClickAction !== 'undefined') || (isOwnerContext && typeof saveClickActionOwner === 'undefined' && typeof saveClickAction !== 'undefined')) {
                    FD.Brand.Metrics.handler.direct(
                        saveClickAction
                    );
                } else if (isOwnerContext && typeof saveClickActionOwner !== 'undefined') {
                    FD.Brand.Metrics.handler.direct(
                        saveClickActionOwner
                    );
                }
                setBusy.call(components, false);
            }).fail(function(resp){
                // handle failure here
                setBusy.call(components, false);
            });
        }).fail(function(resp){
            // handle failure here
            setBusy.call(components, false);
        });
    }
    
    function onDealerStateChange(dealerState) {
        if (dealerState.preferred) {
            hasPreferred = true;
            preferredDealer = dealerLib.updateDealer(dealerState.preferred, 0, salesOpenUntil, salesOpenAgain, null, cfg.dealerDetailPageUrl, hoursDisplayType);
        } else {
            hasPreferred = false;
        }
        if (dealerState.preferred && dealerState.preferred.PACode === currentPACode) {
            isPreferred = true;
            $('.save > a .save', components).hide();
            $('.save > a .unsave', components).show();
            $('.save > a', components).attr('aria-pressed', 'true');
        } else {
            isPreferred = false;
            $('.save > a .save', components).show();
            $('.save > a .unsave', components).hide();
            $('.save > a', components).attr('aria-pressed', 'false');
            if (hasPreferred) {
                $('.save > a', components).attr('href', '#show-tooltip');
            } else {
                $('.save > a', components).attr('href', 'javascript:void(0);');
            }
        }
        setBusy.call(components, false);
    }
    
    function componentElement(el, selector) {
        var $el = $(el).closest('[data-fgx-dealer-details]');
        if(selector) {
            $el = $el.find(selector);
        }
        return $el;
    }
    
    function getDealer(params) {
        var $cnt = componentElement(this, '.location-aware');
        var def = $.Deferred();
        ngp.dealerByUrlKey(params).done(function(dealer) {
            if(!dealer || dealer.length === 0) {
                def.reject(dealer);
                return;
            }
            
            var idx = 0; // we will only ever have one dealer from a PA Code Search
            
            dealer = dealerLib.updateDealer(dealer, idx, salesOpenUntil, salesOpenAgain, null, null, hoursDisplayType);

            dealer.displayUrl = dealer.URL || '';
            if(dealer.URL && !_.isEmpty(dealer.URL)) {
                dealer.URL = dealerLib.appendT3QS(dealer.URL, dealer.mtAttrQS);
            }

            if(ctx.region === 'CA') {
                dealer.Distance = dealer.DistanceKM;
            }
            
            populateContent(dealer, $cnt);
            
            $cnt.data('dealers', [dealer]);
            
            var map = $cnt.data('map');
            if(map) {
                map.dispose();
                $cnt.data('map', null);
            }
            
            def.resolve(dealer);
        }).fail(function(resp) {
            def.reject(resp);
        });
        return def.promise();
    }
    
    function populateContent(dealer, $cnt) {
        // name
        $('.dealer-name', $cnt).text(dealer.Name);
        // pacode data attributes
        $('.save > a', $cnt).data('tooltip-content', $('.save a').data('tooltip-content').replace('{{paCode}}', dealer.PACode));
        $('.save > a', $cnt).data('pacode', dealer.PACode);
        // sales rating
        $('.dealer-rating.sales .decimal-rating', $cnt).text(dealer.salesRating);
        $('.dealer-rating.sales .star-ratings .star-ratings-top', $cnt).css("width", dealer.salesRatingsPercentage);
        $('.dealer-rating.sales .ratings-count .count', $cnt).text(dealer.salesRatingsCount);
        if (!dealer.salesRatingsCount) {
            $('.dealer-rating.sales', $cnt).hide();
            $('.dealer-rating.sales .ratings-count.clickable', $cnt).attr('aria-hidden', 'true');
        } else {
            var $starRatingsEl = $('.dealer-rating.sales .star-rating-label', $cnt),
                starAriaLabelTmpl = $starRatingsEl.attr('data-aria-label-tmpl'),
                $ratingsLinkEl = $('.dealer-rating.sales .ratings-count', $cnt),
                linkAriaLabelTmpl = $ratingsLinkEl.attr('data-aria-label-tmpl');

            if(starAriaLabelTmpl && typeof(starAriaLabelTmpl) != 'undefined') {
                $starRatingsEl.text(starAriaLabelTmpl.replace('{starCount}', dealer.salesRating));
            }

            if(linkAriaLabelTmpl && typeof(linkAriaLabelTmpl) != 'undefined') {
                $ratingsLinkEl.attr('aria-label', linkAriaLabelTmpl.replace('{reviewCount}', dealer.salesRatingsCount));
            }
        }
        // service rating
        $('.dealer-rating.service .decimal-rating', $cnt).text(dealer.serviceRating);
        $('.dealer-rating.service .star-ratings .star-ratings-top', $cnt).css("width", dealer.serviceRatingsPercentage);
        $('.dealer-rating.service .ratings-count .count', $cnt).text(dealer.serviceRatingsCount);
        if (!dealer.serviceRatingsCount) {
            $('.dealer-rating.service', $cnt).hide();
            $('.dealer-rating.service .ratings-count.clickable', $cnt).attr('aria-hidden', 'true');
        } else {
            var $starRatingsEl = $('.dealer-rating.service .star-rating-label', $cnt),
                starAriaLabelTmpl = $starRatingsEl.attr('data-aria-label-tmpl'),
                $ratingsLinkEl = $('.dealer-rating.service .ratings-count', $cnt),
                linkAriaLabelTmpl = $ratingsLinkEl.attr('data-aria-label-tmpl');

            if(starAriaLabelTmpl && typeof(starAriaLabelTmpl) != 'undefined') {
                $starRatingsEl.text(starAriaLabelTmpl.replace('{starCount}', dealer.serviceRating));
            }

            if(linkAriaLabelTmpl && typeof(linkAriaLabelTmpl) != 'undefined') {
                $ratingsLinkEl.attr('aria-label', linkAriaLabelTmpl.replace('{reviewCount}', dealer.serviceRatingsCount));
            }
        }
        // star ratings click handler
        $('.star-ratings', $cnt).on('click', function() {
            var $ratingsEl = $(this).closest('.dealer-rating');
            var $reviewsEl = $('#ratings-and-reviews', $cnt);
            if ($reviewsEl.is(':visible')) {
                // scroll to element
                document.getElementById('ratings-and-reviews').scrollIntoView();
                if ($ratingsEl.hasClass('service')) {
                    updateReviewsSection('service', $cnt);
                } else {
                    updateReviewsSection('sales', $cnt);
                }
            }
        });
        // ratings count click handler
        $('.ratings-count.clickable', $cnt).on('click', function(ev){
            var $reviewsEl = $('#ratings-and-reviews', $cnt);
            var $ratingsEl = $(this).closest('.dealer-rating');
            // if we have a reviews section, we need the text and info icon to behave differently
            if ($reviewsEl.is(':visible') && !$(ev.target).hasClass('icon')) {
                // scroll to element
                document.getElementById('ratings-and-reviews').scrollIntoView();
                if ($ratingsEl.hasClass('service')) {
                    updateReviewsSection('service', $cnt);
                } else {
                    updateReviewsSection('sales', $cnt);
                }
            } else {
                // fall back to overlay
                FD.Brand.Overlay.show('dealerRatingsInfo', true, $(this));
            }
        });
        // ratings count iball click handler
        $('.ratings-count-wrap .icon-info-25px', $cnt).on('click', function(ev){
            FD.Brand.Overlay.show('dealerRatingsInfo', true, $(this));
        });
        // distance and sales
        if (dealer.Distance && dealer.Distance != '' && dealer.Distance !== '0') {
            $('.distance > span.txt', $cnt).text(dealer.Distance);
        } else {
            $('.distance', $cnt).hide();
            $('.distance-hours > span.divider').hide();
        }
        if (dealer.SalesHoursDescription) {
            $('.sales-hours-description', $cnt).text(dealer.SalesHoursDescription);
        } else {
            $('.sales-hours-description', $cnt).hide();
            $('.distance-hours > span.divider').hide();
        }
        // info panel
        $('.details .info .address .street', $cnt).text(dealer.AddressStreet);
        $('.details .info .address .city-state-zip', $cnt).text(dealer.AddressCityStateZip);
        var phone = dealer.Phone;
        if (isBfnContext && dealer.fdafcalltrknum && dealer.fdafcalltrknum !== '') {
            phone = dealer.fdafcalltrknum;
        } else if (ctx.make === 'Ford' && dealer.dlrcalltrk_lad && dealer.dlrcalltrk_lad !== '') {
            phone = dealer.dlrcalltrk_lad;
        } else if (ctx.make === 'Lincoln' && dealer.ldlrcalltrk_lad && dealer.ldlrcalltrk_lad !== '') {
            phone = dealer.ldlrcalltrk_lad;
        }
        $('.details .info .sales-phone .phone-number', $cnt).text(phone);
        $('.details .info .sales-phone .phone-number.fgx-mobile', $cnt).html('<a class="underline" href="tel://' + phone + '">' + phone + '</a>');
        if (dealer.ServicePhone) {
            $('.details .info .service-phone .phone-number', $cnt).text(dealer.ServicePhone);
            $('.details .info .service-phone .phone-number.fgx-mobile', $cnt).html('<a class="underline" href="tel://' + dealer.ServicePhone + '">' + dealer.ServicePhone + '</a>');
        } else {
            $('.details .info .service-phone', $cnt).hide();
        }
        if (dealer.URL) {
            $('.actions li.dealer-website a.website', $cnt).attr('href', dealer.URL);
        } else {
            $('.actions li.dealer-website a.website', $cnt).hide();
            $('.actions li.dealer-website a.website', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if dealer website is explicitly hidden
        if (isOwnerContext && (hideDealerWebsiteOnOwner == true || hideDealerWebsiteOnOwner === 'true')) {
            $('.actions li.dealer-website a.website', $cnt).hide();
            $('.actions li.dealer-website a.website', $cnt).attr('aria-hidden', 'true');
        }
        if (dealer.MapURL) {
            $('.actions li.directions a', $cnt).attr('href', dealer.MapURL);
        } else {
            $('.actions li.directions a', $cnt).hide();
            $('.actions li.directions a', $cnt).attr('aria-hidden', 'true');
        }
        if (dealer.MobileMapUrl) {
            $('.actions li.directions.mobile a', $cnt).attr('href', dealer.MobileMapUrl);
        } 
        // owner context wins if directions is explicitly hidden
        if (isOwnerContext && (hideDirectionsOnOwner == true || hideDirectionsOnOwner === 'true')) {
            $('.actions li.directions a', $cnt).hide();
            $('.actions li.directions a', $cnt).attr('aria-hidden', 'true');
        }
        if (dealer.serviceAppointmentURL) {
            dealer.serviceAppointmentURL = dealerLib.appendT3QS(dealer.serviceAppointmentURL, dealer.mtAttrQS);
            $('.details .service-website', $cnt).attr('href', dealer.serviceAppointmentURL);
        } else {
            $('.details .info .links.secondary .service-website', $cnt).hide();
            $('.details .info .links.secondary .service-website', $cnt).attr('aria-hidden', 'true');
            $('.actions.list-unstyled .service-website-wrap', $cnt).hide();
            $('.actions.list-unstyled .service-website', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if service website is explicitly hidden
        if (isOwnerContext && (hideServiceWebsiteOnOwner == true || hideServiceWebsiteOnOwner === 'true')) {
            $('.details .info .links.secondary .service-website', $cnt).hide();
            $('.details .info .links.secondary .service-website', $cnt).attr('aria-hidden', 'true');
            $('.actions.list-unstyled .service-website-wrap', $cnt).hide();
            $('.actions.list-unstyled .service-website', $cnt).attr('aria-hidden', 'true');
        }
        if (dealer.inventoryNewURL) {
            dealer.inventoryNewURL = dealerLib.appendT3QS(dealer.inventoryNewURL, dealer.mtAttrQS);
            $('.details .info .links.secondary .new-inventory', $cnt).attr('href', dealer.inventoryNewURL);
        } else {
            $('.details .info .links.secondary .new-inventory', $cnt).hide();
            $('.details .info .links.secondary .new-inventory', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if new inventory is explicitly hidden
        if (isOwnerContext && (hideNewInventoryOnOwner == true || hideNewInventoryOnOwner === 'true')) {
            $('.details .info .links.secondary .new-inventory', $cnt).hide();
            $('.details .info .links.secondary .new-inventory', $cnt).attr('aria-hidden', 'true');
        }
        if (dealer.inventoryUsedURL) {
            dealer.inventoryUsedURL = dealerLib.appendT3QS(dealer.inventoryUsedURL, dealer.mtAttrQS);
            $('.details .info .links.secondary .used-inventory', $cnt).attr('href', dealer.inventoryUsedURL);
        } else {
            $('.details .info .links.secondary .used-inventory', $cnt).hide();
            $('.details .info .links.secondary .used-inventory', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if used inventory is explicitly hidden
        if (isOwnerContext && (hideUsedInventoryOnOwner == true || hideUsedInventoryOnOwner === 'true')) {
            $('.details .info .links.secondary .used-inventory', $cnt).hide();
            $('.details .info .links.secondary .used-inventory', $cnt).attr('aria-hidden', 'true');
        }
        // save or unsave
        if (dealer.dealerType !== 'Dealer') {
            // hide save star for independent body shops
            $('.save', $cnt).hide();
        } if (dealer.isPreferred) {
            $('.save > a .save', $cnt).hide();
            $('.save > a .unsave', $cnt).show();
        } else {
            $('.save > a .unsave', $cnt).hide();
            $('.save > a .save', $cnt).show();
        }
        // text dealer
        if (FD.Brand.Context.showTextDealer && dealer.lctextoptin > 0 && dealer.TextUrl) {
            $('.actions .text-dealer a.fgx-desktop', $cnt).attr('data-numbers', 'sales=sms://+1' + dealer.TextUrl);
            $('.actions .text-dealer a.fgx-desktop', $cnt).attr('data-title', dealer.Name);
            $('.actions .text-dealer a.fgx-mobile', $cnt).attr('href', 'sms://+1' + dealer.TextUrl);
        } else {
            $('.actions .text-dealer', $cnt).hide();
            $('.actions .text-dealer a', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if text is explicitly hidden
        if (isOwnerContext && (hideTextOnOwner == true || hideTextOnOwner === 'true')) {
            $('.actions .text-dealer', $cnt).hide();
            $('.actions .text-dealer a', $cnt).attr('aria-hidden', 'true');
        }
        // dealer chat
        if (ctx.region !== 'CA') {
            // check for chat
            ngp.dealerChatStatus({dealerPACode: dealer.PACode, make: ctx.make}).done(function(resp) {
                if(resp && resp.url) {
                    var url = resp.url;
                    $('.actions .dealer-chat a', $cnt).on('click', function(event){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        window.open(url, '_blank', 'directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,width=350,height=620');
                        if ((!isOwnerContext && typeof chatClickAction !== 'undefined') || (isOwnerContext && typeof chatClickActionOwner === 'undefined' && typeof chatClickAction !== 'undefined')) {
                            FD.Brand.Metrics.handler.direct(
                                chatClickAction
                            );
                        } else if (isOwnerContext && typeof chatClickActionOwner !== 'undefined') {
                            FD.Brand.Metrics.handler.direct(
                                chatClickActionOwner
                            );
                        }
                    });
                } else {
                    $('.actions .dealer-chat', $cnt).hide();
                    $('.actions .dealer-chat a', $cnt).attr('aria-hidden', 'true');
                }
            });
        } else {
            $('.actions .dealer-chat', $cnt).hide();
            $('.actions .dealer-chat a', $cnt).attr('aria-hidden', 'true');
        }
        // owner context wins if chat is explicitly hidden
        if (isOwnerContext && (hideChatOnOwner == true || hideChatOnOwner === 'true')) {
            $('.actions .dealer-chat', $cnt).hide();
            $('.actions .dealer-chat a', $cnt).attr('aria-hidden', 'true');
        }
        // schedule service
        if (dealer.SmarttSubset) {
            $('.actions .schedule-service a', $cnt).attr('href', dealer.SmarttSubset);
            if (isOwnerContext && (hideScheduleServiceOnOwner == false || hideScheduleServiceOnOwner === 'false')) {
                $('.actions .schedule-service', $cnt).show();
                $('.actions .schedule-service a', $cnt).attr('aria-hidden', 'false');
            }
        }

        if(dealer && dealer.PACode) {
            var mtxData = JSON.stringify({'$$dealerPACode': dealer.PACode});
            $('[data-fgx-add-pacode]', $cnt).each(function() {
                $(this).attr('data-fd-metrics-data', mtxData);
            });
        }

        if(dealer && dealer.Name) {
            var nameData = {
                '$$dealerName': dealer.Name
            };
            $('[data-fgx-add-name]', $cnt).each(function() {
                var currMtxData = $(this).attr('data-fd-metrics-data');
                currMtxData = (currMtxData && typeof(currMtxData) != 'undefined') ? JSON.parse(currMtxData) : {};
                var mtxData = _.extend({}, currMtxData, nameData);
                $(this).attr('data-fd-metrics-data', JSON.stringify(mtxData));
            });
        }

        if (cfg && cfg.hasExitOverlay) {
            $('[data-fgx-dd-ext-link]', $cnt)
                .addClass('fgx-external-url-trigger')
                .attr('data-fgx-external-ovr-id', cfg.exitOverlayId || '');
        }

        // metrics swapout for owner context
        if (isOwnerContext) {
            if (typeof allDealersClickActionOwner !== 'undefined') {
                $('.all-dealers', $cnt).attr('data-fd-metrics-click', JSON.stringify(allDealersClickActionOwner));
            }
            if (typeof shareClickActionOwner !== 'undefined') {
                $('.actions .share a', $cnt).attr('data-fd-metrics-click', JSON.stringify(shareClickActionOwner));
            }
            if (typeof printClickActionOwner !== 'undefined') {
                $('.actions .print a', $cnt).attr('data-fd-metrics-click', JSON.stringify(printClickActionOwner));
            }
            if (typeof unsaveClickActionOwner !== 'undefined') {
                $('.save a .unsave', $cnt).attr('data-fd-metrics-click', JSON.stringify(unsaveClickActionOwner));
            }
            if (typeof callClickActionOwner !== 'undefined') {
                $('.sales-phone .phone-number.fgx-mobile', $cnt).attr('data-fd-metrics-click', JSON.stringify(callClickActionOwner));
            }
            if (typeof textClickActionOwner !== 'undefined') {
                $('.actions .text-dealer a', $cnt).attr('data-fd-metrics-click', JSON.stringify(textClickActionOwner));
            }
            if (typeof chatClickActionOwner !== 'undefined') {
                $('.actions .dealer-chat a', $cnt).attr('data-fd-metrics-click', JSON.stringify(chatClickActionOwner));
            }
            if (typeof reviewsClickActionOwner !== 'undefined') {
                $('.ratings-count.clickable', $cnt).attr('data-fd-metrics-click', JSON.stringify(reviewsClickActionOwner));
            }
            if (typeof ratingsIBallClickActionOwner !== 'undefined') {
                $('.ratings-count-wrap .icon', $cnt).attr('data-fd-metrics-click', JSON.stringify(ratingsIBallClickActionOwner));
            }
            if (typeof dealerWebsiteClickActionOwner !== 'undefined') {
                $('.actions .dealer-website a', $cnt).attr('data-fd-metrics-click', JSON.stringify(dealerWebsiteClickActionOwner));
            }
            if (typeof directionsClickActionOwner !== 'undefined') {
                $('.actions .directions a', $cnt).attr('data-fd-metrics-click', JSON.stringify(directionsClickActionOwner));
            }
            if (typeof serviceWebsiteClickActionOwner !== 'undefined') {
                $('.links.secondary .service-website', $cnt).attr('data-fd-metrics-click', JSON.stringify(serviceWebsiteClickActionOwner));
                $('.actions.list-unstyled .service-website', $cnt).attr('data-fd-metrics-click', JSON.stringify(serviceWebsiteClickActionOwner));
            }
            if (typeof newInventoryClickActionOwner !== 'undefined') {
                $('.links.secondary .new-inventory', $cnt).attr('data-fd-metrics-click', JSON.stringify(newInventoryClickActionOwner));
            }
            if (typeof usedInventoryClickActionOwner !== 'undefined') {
                $('.links.secondary .used-inventory', $cnt).attr('data-fd-metrics-click', JSON.stringify(usedInventoryClickActionOwner));
            }
            if (typeof viewMoreClickActionOwner !== 'undefined') {
                $('.btn.view-more', $cnt).attr('data-fd-metrics-click', JSON.stringify(viewMoreClickActionOwner));
            }
            if (typeof reviewsSortClickActionOwner !== 'undefined') {
                $('#fgx-reviewsSort-select', $cnt).attr('data-fd-metrics-change', JSON.stringify(reviewsSortClickActionOwner));
            }
            if (typeof reviewsTabClickActionOwner !== 'undefined') {
                $('.tab-nav .tab-label', $cnt).attr('data-fd-metrics-click', JSON.stringify(reviewsTabClickActionOwner));
            }
            if (typeof hoursSelectClickActionOwner !== 'undefined') {
                $('.fgx-brand-select-container.hours-select-container', $cnt).attr('data-fd-metrics-change', JSON.stringify(hoursSelectClickActionOwner));
            }
        } else if(isBfnContext) {
            if (typeof(serviceWebsiteClickActionBfn) !== 'undefined') {
                $('.links.secondary .service-website', $cnt).attr('data-fd-metrics-click', JSON.stringify(serviceWebsiteClickActionBfn));
                $('.actions.list-unstyled .service-website', $cnt).attr('data-fd-metrics-click', JSON.stringify(serviceWebsiteClickActionBfn));
            }
        }
        // paCode for our call to the user lib / reviews service
        currentPACode = dealer.PACode;
        currentSalesCode = (dealer.Cupid) ? dealer.Cupid : null;
        // hours and services
        populateHours($cnt, dealer.SalesHours, dealer.ServiceHours);
        
        populateServices(dealer.Specialties, $cnt);
    }
    
    function populateHours($cnt, salesData, serviceData) {
        var $dropdown = $('.hours-services .hours-full .fgx-brand-select-container.hours-select-container', $cnt);
        var $salesHeading = $('.hours-services .hours-full .heading.sales', $cnt);
        var $salesHoursUl = $('.hours-services .hours-full > ul.items.sales', $cnt);
        var $hoursHeading = $('.hours-services .hours-full .heading.services', $cnt);
        var $servicesHeading = $('.hours-services .hours-full .heading.services', $cnt);
        var $servicesHoursUl = $('.hours-services .hours-full > ul.items.services', $cnt);
        if (salesData.Day) {
            populateHoursUl($salesHoursUl, salesData);
        } else {
            $salesHoursUl.hide();
            $salesHeading.hide();
            $salesHeading.attr('aria-hidden', 'true');
        }
        if (serviceData.Day) {
            populateHoursUl($servicesHoursUl, serviceData);
        } else {
            $servicesHoursUl.hide();
            $servicesHeading.hide();
            $servicesHeading.attr('aria-hidden', 'true');
        }
        if (salesData.Day && serviceData.Day) {
            // dropdown treatment, hide headings and service hours (default initial view is sales hours)
            $servicesHeading.hide();
            $servicesHeading.attr('aria-hidden', 'true');
            $salesHeading.hide();
            $salesHeading.attr('aria-hidden', 'true');
            $servicesHoursUl.hide();
            // check for owner context and show service hours initially if applicable
            if (isOwnerContext && initialHoursSection === 'service') {
                $dropdown.val('services');
                updateSelected($dropdown, 'hours', true);
            }
        } else {
            // only one list showing, hide dropdown and hours heading
            $dropdown.hide();
            $dropdown.attr('aria-hidden', 'true');
            $hoursHeading.hide();
            $hoursHeading.attr('aria-hidden', 'true');
        }
        
    }
    
    function populateHoursUl($ulEl, data) {
        var closedLabel = $('#dd').data('closed-label');
        var sunday;
        _.each(data.Day, function(day, dayIdx) {
            var li = "<li><span class=\"day-label\">{labelTxt}</span><span class=\"hours\">{hoursTxt}</span></li>";
            var labelTxt = day.name;
            var hoursTxt = "";
            if (day.open && day.close) {
                hoursTxt = day.open + " - " + day.close;
            } else {
                hoursTxt = closedLabel;
            }
            li = li.replace('{labelTxt}', labelTxt).replace('{hoursTxt}', hoursTxt);
            if (dayIdx > 0) {
                // we're not Sunday, add to list immediately
                $ulEl.append(li);
            } else {
                // we're Sunday, save until last
                sunday = li;
            }
        });
        // once we're done, put Sunday last
        $ulEl.append(sunday);
    }
    
    function populateServices(data, $cnt) {
        if (data.Specialty && data.Specialty.length > 0) {
            var columnUl = $('.service-specialties > .items.col-0', $cnt);
            for (var i = 0; i < data.Specialty.length; i++) {
                columnUl.append('<li>' + data.Specialty[i] + '</li>');
            }
        } else {
            $('.service-specialties', $cnt).hide();
        }
    }

    // NZ - This function was previously being called from populateServices. Looks like it can be deleted, but keeping
    // around for now in case I missed something.
    function splitUp(arr, n) {
        var rest = arr.length % n, // how much to divide
            restUsed = rest, // to keep track of the division over the elements
            partLength = Math.floor(arr.length / n),
            result = [];

        for(var i = 0; i < arr.length; i += partLength) {
            var end = partLength + i,
                add = false;

            if(rest !== 0 && restUsed) { // should add one element for the division
                end++;
                restUsed--; // we've used one division element now
                add = true;
            }

            result.push(arr.slice(i, end)); // part of the array

            if(add) {
                i++; // also increment i in the case we added an extra element for division
            }
        }

        return result;
    }
    
    function initReviews(components) {
        // reviews are enabled, retrieve the first five service reviews
        $cnt = $('.reviews-section', components);
        if (currentSalesCode == null) {
            $cnt.hide();
            return;
        }
        var params = {
            salesCode: currentSalesCode,
            dealerPACode: currentPACode,
            pageSize: 5,
            pageNumber: 1,
            reviewType: 'sales',
            api_key: reviewsApiKey,
            sortBy: currentReviewSort,
            order: currentReviewOrder
        };
        var salesSelector = '.reviews-section .sections .reviews.sales ul';
        loadReviews.call($cnt, params, salesSelector).done(function() {
            // next, retrieve the first five sales reviews
            var serviceSelector = '.reviews-section .sections .reviews.service ul';
            params.reviewType = 'service';
            loadReviews.call($cnt, params, serviceSelector).done(function() {
                var cpoSelector = '.reviews-section .sections .reviews.cpo ul';
                var $cpoEl = $(cpoSelector, $cnt);
                if (showCPOReviews) {
                    // if the CPO reviews section is enabled, load those as well
                    params.reviewType = 'cpo';
                    loadReviews.call($cnt, params, cpoSelector).done(function() {
                        finishReviewsInit(components, $cnt, true);
                    });
                } else {
                    finishReviewsInit(components, $cnt, false);
                }
            });
        });
        
    }
    
    function finishReviewsInit(components, $cnt, isCPOEnabled) {
        var salesList = $('.sections .reviews.sales ul li', $cnt);
        var serviceList = $('.sections .reviews.service ul li', $cnt);
        if (isCPOEnabled) {
            var cpoList = $('.sections .reviews.cpo ul li', $cnt);
            if (salesList.length < 5 && serviceList.length < 5 && cpoList.length < 5) {
                $cnt.hide();
                return;
            }
        } else {
            if (salesList.length < 5 && serviceList.length < 5) {
                $cnt.hide();
                return;
            }
        }
        // if we've gotten here we have enough reviews to continue, we can initialize our tabbed navigation, view more button(s) and make our star ratings clickable
        $('.star-ratings', components).addClass('clickable');
        
        $('.tab-nav .tab-label', $cnt).on('click', function(){
            var $el = $(this);
            var id = $el.data('id');
            updateReviewsSection(id, $cnt);
        });
        
        $('.reviews .view-more', $cnt).on('click', function() {
            var $el = $(this);
            var $cnt = componentElement(this, '.reviews-section');
            var params = {
                salesCode: currentSalesCode,
                dealerPACode: currentPACode,
                pageSize: 5,
                api_key: reviewsApiKey,
                sortBy: currentReviewSort,
                order: currentReviewOrder
            };
            var selector = '.reviews-section .sections .reviews.sales ul';
            if ($el.hasClass('sales')) {
                salesReviewPage ++;
                params.pageNumber = salesReviewPage;
                params.reviewType = 'sales';
            } else if ($el.hasClass('service')) {
                serviceReviewPage ++;
                params.pageNumber = serviceReviewPage;
                params.reviewType = 'service';
                selector = '.reviews-section .sections .reviews.service ul';
            } else if ($el.hasClass('cpo')) {
                cpoReviewPage ++;
                params.pageNumber = cpoReviewPage;
                params.reviewType = 'cpo';
                selector = '.reviews-section .sections .reviews.cpo ul';
            }
            var $mainEl = componentElement($cnt);
            setBusy.call($mainEl, true);
            loadReviews.call($cnt, params, selector).done(function() {
                updateCurrentlyShowing($cnt);
                setBusy.call($mainEl, false);
            });
        });
        
        // check for owner context and show service reviews initially if applicable
        if (isOwnerContext && initialReviewsSection === 'service') {
            updateReviewsSection('service', $cnt);
        }
        
        // update our 'currently showing' text
        updateCurrentlyShowing($cnt);
        
        // if user has deeplinked to the reviews section, scroll the page
        if (showReviews) {
            document.getElementById('ratings-and-reviews').scrollIntoView();
        }
    }
    
    function updateReviewsSection(id, $cnt) {
        var $el = $('.tab-nav .tab-label.' + id, $cnt);
        var id = $el.data('id');
        if (!$el.hasClass('selected')) {
            $('.tab-nav .tab-label', $cnt).removeClass('selected');
            $('.tab-nav .tab-label', $cnt).attr('aria-selected', 'false');
            $el.addClass('selected');
            $el.attr('aria-selected', 'true');
            var sel = '.sections .reviews.' + id;
            $('.sections .reviews', $cnt).removeClass('selected');
            $(sel, $cnt).addClass('selected');
            updateCurrentlyShowing($cnt);
            updateMetricsSection(id, $cnt);

            if(reviewSortUpdated) {
                updateReviewSort(null, false);
            }
        }
    }
    
    function updateCurrentlyShowing($cnt) {
        $('.sections .heading .text p.current-display', $cnt).text($('.sections .reviews.selected', $cnt).data('currently-showing'));
    }

    function updateMetricsSection(sectionId, $cnt) {
        var sectionData = {
            '$section': sectionId || ''
        };
        $('[data-update-mtx-section]', $cnt).each(function() {
            var $el = $(this),
                currMtxData = $el.attr('data-fd-metrics-data'),
                newMtxData = {};
            if(currMtxData && typeof(currMtxData) != 'undefined') {
                currMtxData = JSON.parse(currMtxData);
                newMtxData = _.extend(newMtxData, currMtxData, sectionData);
            } else {
                newMtxData = _.extend(newMtxData, sectionData);
            }
            $el.attr('data-fd-metrics-data', JSON.stringify(newMtxData));
        });
    }
    
    function loadReviews(params, listSelector) {
        var $cnt = componentElement(this, '.reviews-section');
        var $listCnt = componentElement(this, listSelector);
        var vehicleInfoTplt = $cnt.data('vehicle-info-template');
        var def = $.Deferred();
        ngp.dealerReviews(params).done(function(resp) {
            var reviews = [].concat(resp.Reviews.Review);
            var metadata = resp.Meta;
            if(!reviews || reviews.length === 0) {
                def.reject(reviews);
                return;
            }
            
            if (metadata.TotalItems < 1) {
                // we have less than 5 total reviews, add 'not enough reviews' messaging and hide the view more button
                $('<li>' + notEnoughReviews + '</li>').appendTo($listCnt);
                var btnSel = '.sections .reviews.' + params.reviewType + ' .view-more';
                $(btnSel, $cnt).hide();
                var sel = '.sections .reviews.' + params.reviewType;
                if(reviewsShowingTpl) {
                    $(sel, $cnt).data('currently-showing', '');
                }
            } else if (reviews.length > 0) {
                _.each(reviews, function(reviewItem) {
                    if (typeof vehicleInfoTplt !== 'undefined') {
                        var vehicleYear = (reviewItem.VehicleYear) ? reviewItem.VehicleYear : '';
                        var vehicleMake = (reviewItem.VehicleMake) ? reviewItem.VehicleMake : '';
                        var vehicleModel = (reviewItem.VehicleModel) ? reviewItem.VehicleModel : '';
                        reviewItem.VehicleInfo = '';
                        if (vehicleMake !== '' && vehicleModel !== '') {
                            var vehicleTxt = vehicleMake + ' ' + vehicleModel;
                            reviewItem.VehicleInfo = vehicleInfoTplt.replace('{year}', vehicleYear).replace('{vehicle}', vehicleTxt);
                        }
                    }
                    reviewItem.isQuickLane = (reviewItem.TransactionCode && reviewItem.TransactionCode === "USA_RQM") ? true : false;
                    reviewItem.ratingPercentage = (reviewItem.Rating * 20) + '%';
                    reviewItem.timeSince = timeSince(new Date(reviewItem.CreatedAt));
                    reviewItem.timeSinceUpdated = timeSince(new Date(reviewItem.UpdatedAt));
                    reviewItem.hasResponse = (reviewItem.Response && reviewItem.Response !== 'null' && reviewItem.Response !== '');
                    var prm = { review: reviewItem, showQuicklaneTooltip: showQuicklaneTooltip };
                    var $reviewEl = $(templates.reviewItem(prm)).data('review', reviewItem);
                    $reviewEl.appendTo($listCnt);
                });
                var curr = metadata.Page.Number * metadata.Page.Size;
                var total = metadata.TotalItems;
                if (curr >= total) {
                    curr = total;
                    var btnSel = '.sections .reviews.' + params.reviewType + ' .view-more';
                    $(btnSel, $cnt).hide();
                }
                var sel = '.sections .reviews.' + params.reviewType;
                if(reviewsShowingTpl) {
                    $(sel, $cnt).data('currently-showing', reviewsShowingTpl.replace('{current}', curr).replace('{total}', total));
                }
            }
            
            def.resolve(reviews);
        }).fail(function(resp) {
            def.reject(resp);
        });
        return def.promise();
    }
    
    function timeSince(date) {
      var seconds = Math.floor((new Date() - date) / 1000);
      var interval = Math.floor(seconds / 31536000);

      interval = Math.floor(seconds / 86400);
      if (interval > 1) {
        return interval + " " + daysLabel;
      }
      interval = Math.floor(seconds / 3600);
      if (interval > 1) {
        return interval + " " + hoursLabel;
      }
      interval = Math.floor(seconds / 60);
      if (interval > 1) {
        return interval + " " + minutesLabel;
      }
      return Math.floor(seconds) + " " + secondsLabel;
    }
    
    function setBusy(isBusy) {
        $(this).find('.ford-busy').toggle(isBusy);
    }
    
    function updateReviewSort(newSort, updatedFlag) {
        if (newSort && typeof newSort !== 'undefined') {
            var sortVals = newSort.split('|');
            if(sortVals.length > 1) {
                currentReviewSort = sortVals[0];
                currentReviewOrder = sortVals[1];
            } else {
                currentReviewSort = newSort;
            }
        }
        if (currentReviewSort != null) {
            var $cnt = $('.reviews-section', components);
            var $selectedTab = $cnt.find('.tab-nav .tab-label.selected');
            var currentType = $selectedTab.data('id') || 'sales';
            var listSelector = '.reviews-section .sections .reviews.' + currentType +' ul';
            var params = {
                salesCode: currentSalesCode,
                dealerPACode: currentPACode,
                pageSize: 5,
                pageNumber: 1,
                reviewType: currentType,
                api_key: reviewsApiKey,
                sortBy: currentReviewSort,
                order: currentReviewOrder
            };
            var $mainEl = componentElement($cnt);
            setBusy.call($mainEl, true);
            $(listSelector, components).empty();
            loadReviews.call($cnt, params, listSelector).done(function() {
                updateCurrentlyShowing($cnt);
                reviewSortUpdated = (typeof(updatedFlag) !== 'undefined' && updatedFlag !== null) ? updatedFlag : true;
                setBusy.call($mainEl, false);
            });
        }
    }
    
    /*NZ - BRAND-11597 - these should no longer be needed since the logic around sorting was moved to the reviews
           service and doesn't need to be handled internally anymore.
    function sortByDate(a, b) {
        var dateA = new Date( $(a).data('timestamp') );
        var dateB = new Date( $(b).data('timestamp') );
        return (dateA > dateB) ? -1 : (dateA < dateB) ? 1 : 0;;
    }
    
    function sortByRating(a, b) {
        return +$(b).data('rating') - +$(a).data('rating');
    }*/
    
    function loadMapControl() {
        var def = $.Deferred();
        if(util.url.allowScript('6')) {
            if(mapControlLoaded) {
                def.resolve();
            } else {
                win._fgx_mapControlLoaded = function() {
                    mapControlLoaded = true;
                    def.resolve();
                    delete win._fgx_mapControlLoaded;
                };
                util.url.loadAsScript(ctx.settings.mapHost + '?callback=_fgx_mapControlLoaded')
                    .fail(function() {
                        def.reject();
                    });
            }
        } else {
            util.log('dealer details: Microsoft Map library not loaded due to privacy settings');
            def.reject();
        }
        return def.promise();
    }

    function createMap() {
        var $cnt = componentElement(this, '.location-aware');
        var map = $cnt.data('map');
        var dealers = $cnt.data('dealers');

        if(map || !dealers) {
            return;
        }
        loadMapControl().done(function() {
            var mapApi = Microsoft.Maps;
            map = new mapApi.Map(
                $cnt.find('.map')[0], {
                    credentials: ctx.settings.mapKey,
                    mapTypeId: Microsoft.Maps.MapTypeId.road,
                    enableSearchLogo: false,
                    enableClickableLogo: false,
                    enableInertia: true,
                    liteMode: false,
                    showCopyright: false,
                    showMapTypeSelector: false,
                    showLocateMeButton: false,
                    disableScrollWheelZoom: true,
                    disablePanning: false,
                    disableZooming: false
                }
            );

            var locations = [];
            var center = null;
            var setDealerState = function(dealer, selected) {
                dealer.selected = selected;
                var entityState =  (selected) ? 'selected' : 'none';
                dealer.pushpin.setOptions({
                    state: entityState,
                    icon: pushpinSvg,
                    textOffset: new Microsoft.Maps.Point(0, 10)
                });
            };

            _.each(dealers, function(dealer) {
                var location = new mapApi.Location(dealer.Latitude, dealer.Longitude);
                locations.push(location);
                if(dealer.selected) {
                    center = location;
                }
                
                var pushpin = new mapApi.Pushpin(location, {
                    width: 30,
                    height: 46,
                    anchor: new Microsoft.Maps.Point(15, 23)
                });
                
                dealer.pushpin = pushpin;
                setDealerState(dealer, true);
                map.entities.push(pushpin);
            });
            // set map bounds
            if(locations.length > 1) {
                map.setView({
                    bounds: mapApi.LocationRect.fromLocations(locations)
                });
            } else {
                map.setView({
                    center: locations[0],
                    zoom: 11
                });
            }
            if(center) {
                map.setView({
                    center: center
                });
            }
        });
    } 

})(window, jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.Overlay, FD.Brand.Context, FD.Brand.User, FD.Brand.Util, FD.Brand.NgpServices, FD.Brand.Dealer);
;(function($, brand, win, util) {

    brand.setInitHandler('[data-fgx-chat-links]', init);

    /////////////

    function init(components) {

        if(components.length === 0) {
            return;
        }

        // Setup a hover state for the CTAs
        var $cta = $('.item-cta', components);
        util.ctaHover($cta);

/*
        $('.item-cta', components).on('click', function(event) {
            event.stopPropagation();
            event.preventDefault();
            var url = $(this).attr("href");

            if(url) {
                openWin(url);
                var chatText = $(this).text();
                postfdanalytics.clickToChatMetricsCall(chatText);
            }
        });

        function openWin(link, label) {
            var b = Math.floor((Math.random() * 100) + 1);
            var params = "scrollbars=1,menubar=0,resizable=1";
            var label = label || "Chat";

            if(util.currentBreakpoint() !== 'gux-bkpt-sm') {
                params += ",width=850,height=500";
            }

            win.open(link, "_blank", label, b, params);
        }
*/
    }
})(jQuery, FD.Brand, window, FD.Brand.Util);

;(function($, brand) {

    brand.setInitHandler('[data-fgx-vehicle-tile]', init);

    /////////////

    function init(components) {

        var brand = window.FD.Brand;

        brand.Dig.resolve(components);

        //populate pricing
        components.each(function() {
            brand.Pricing.refresh(this);
        });
    }
})(jQuery, FD.Brand);
;(function($, brand) {


    brand.setInitHandler('[data-fgx-features-tile]', init);

    /////////////

    function init(components) {
        
        //Text should show the 'more' link if > 3 lines.
        //window.FD.Brand.Util.moreLessInit(components, false, 3, 1.25, '.ml-wrapper');
        //
        //$('.ml-wrapper', components).each(function() {
        //    var $wrap = $(this),
        //        $link = $wrap.children(".mllink"),
        //        $content = $wrap.children(".mltext");
        //        $link.on("click", function() {
        //            $content.toggleClass("mltext-more");
        //            $link.find("span.mlspanmore").toggle();
        //            $link.find("span.mlspanless").toggle();
        //            adjustMoreLessStyles($wrap, $content);
        //            return false;
        //        });
        //});


        components.each(function() {
            var $tile = $(this),
                $featData = $tile.find('.fi-feature-data'),
                categoryTitle = ($featData.find('.fi-category').text() || '').trim(),
                featTitle = ($featData.find('.fi-headline').text() || '').trim(),
                $moreToggle = $tile.find('.moreDesc'),
                $lessToggle = $tile.find('.lessDesc'),
                $desc = $tile.find('.description-more');
            if (categoryTitle || featTitle) {
                var mtxData = {
                    $$categoryTitle: categoryTitle,
                    $$featureTitle: featTitle
                };
                $featData.attr('data-fd-metrics-data', JSON.stringify(mtxData));
            }
            $moreToggle.click(function() {
                $desc.toggle();
                $(this).hide();
            });
            $lessToggle.click(function() {
                $desc.toggle();
                $moreToggle.show();
            });
        });
        
    }
    
    //function adjustMoreLessStyles(wrapper, content) {
    //    if (content.hasClass("mltext-more")) {
    //        var $featureTile = $(wrapper).closest('.fi-feature');
    //        var $totalHeight = $featureTile.height();
    //        var $contentHeightOffset =  $($featureTile).find('.fi-category').height() +
    //                                    $($featureTile).find('.fi-headline').height() +
    //                                    $($featureTile).find('.mllink').height() +
    //                                    $($featureTile).find('.mllink').height();
    //        if ((content.height() + $contentHeightOffset) > $totalHeight) {
    //            var $maxHeight = $totalHeight - $contentHeightOffset - 50;
    //            content.css('max-height', $maxHeight);
    //            content.css('overflow-y', 'scroll');
    //        }
    //    } else {
    //        content.scrollTop(0);
    //        content.css('max-height', '');
    //        content.css('overflow-y', 'hidden');
    //    }
    //}
    
})(jQuery, FD.Brand);

;(function($, brand) {

    brand.setInitHandler('[data-fgx-features-category-card]', init);

    /////////////

    function init(components) {

        components.each(function() {
            var $featureItemCount = $(this).find(".featuresTile").length;
            $(this).find('.fi-count-num').html($featureItemCount - 1);
        });
        
        // simulating rollover / rollout behaviour on focusin and focusout for accessibility
        $(".featuresTile.fi-startcard", components).on('focusin', function(ev) {
            $(".featuresTile.fi-startcard", components).removeClass('hover');
            $(".featuresTile .fi-feature", components).removeClass('hover');
            $(this).addClass('hover');
        });
        $(".featuresTile .fi-feature", components).on('focusin', function(ev) {
            $(".featuresTile.fi-startcard", components).removeClass('hover');
            $(".featuresTile .fi-feature", components).removeClass('hover');
            $(this).addClass('hover');
        });
        $(".featuresTile.fi-startcard", components).on('focusout', function(ev) {
            $(this).removeClass('hover');
        });
        $(".featuresTile .fi-feature", components).on('focusout', function(ev) {
            $(this).removeClass('hover');
        });

        brand.Metrics.setInherited({
            container: components,
            inheritList: [{
                selector: '.fi-cta, .fi-cta-invisible',
                containerAttr: 'data-fd-metrics-feature-tile-click-inherit',
                childAttr: 'data-fd-metrics-click'
            }]
        });
    }

})(jQuery, FD.Brand);


;(function($, brand) {

    brand.setInitHandler('[data-fgx-vr-player-slide]', init);

    /////////////

    function init(components) {
        if(components.length === 0) {
            return;
        }

        $('.moreDesc', components).on('click', function() {
            var $wrapper = $(this).closest('.ml-wrapper');
            $wrapper.find('.description-more').toggle();
            $(this).hide();
            $wrapper.find('.lessDesc').focus();
        });
        $('.lessDesc', components).on('click', function() {
            var $wrapper = $(this).closest('.ml-wrapper');
            $wrapper.find('.description-more').toggle();
            $wrapper.find('.moreDesc').show().focus();
        });
    }

})(jQuery, FD.Brand);
;(function($, _, brand, win) {
    var mql;

    brand.setInitHandler('[data-fgx-two-column-billboard]', init);

    /////////////

    function init(components) {
        var CAROUSEL_ID_PREFIX = 'two-column-billboard-carousel-';

        mql = window.matchMedia('(min-width: 992px)');

        components.each(function(idx) {
            var $el = $(this),
                $carousel = $el.find('.column-right.carousel');

            if ($el.hasClass('hasCarousel')) {
                initCarouselAttrs($carousel, CAROUSEL_ID_PREFIX + idx);
                brand.Util.carousel.swipe($carousel[0], swipe);

                $el.on('slid.bs.carousel', function(ev) {
                    var $carousel = $(ev.relatedTarget).closest('.carousel'),
                        $slide = $carousel.find('.tcb-carousel-item.item.active');

                    updatePaginationLabel($carousel, $slide);
                    updateInactiveArrows($carousel, $slide);
                    $slide.focus();
                });
            }

            brand.Pricing.refresh(this);
        });

        // carousel arrows adjust for keyboard focus (avoids pushing the image over when tabbing to arrows)
        $(components)
            .on('focusin', function() {
                $(this).find('.carousel-arrows').css('right', '0px');
            }).on('focusout', function() {
                $(this).find('.carousel-arrows').css('right', '');
            });

        $('.carousel-indicators.global-indicators li > span', components)
            .on('focusin', function() {
                $(this).closest('li').addClass('fgx-focused');
            }).on('focusout', function() {
                $(this).closest('li').removeClass('fgx-focused');
            });

        $('.carousel-arrows .carousel-next, .carousel-arrows .carousel-previous', components).click(function() {
            var $carousel = $(this).closest('.carousel'),
                dir = ($(this).hasClass('carousel-previous')) ? 'prev' : 'next';

            if (canScroll($carousel, dir)) {
                scrollAction($carousel, dir);
            }
        });

        brand.Dig.resolve($('.tcb-carousel-item', components));

    }

    function initCarouselAttrs($carousel, id) {
        if (!$carousel || $carousel.length == 0) {
            return;
        }

        $carousel.attr('id', id);

        $carousel.find('[data-tcb-carousel-action-elm]').each(function() {
            $(this).attr('data-target', '#' + id);
        });

        updatePaginationLabel($carousel, null, true);
    }

    //Callback function of the hammer swipe listeners.
    //pass in the element, direction
    function swipe(elm, dir, ev) {
        // only perform the swipe if the screen is smaller than 768px wide OR if the device is touch capable.
        if(!mql.matches || (brand.Util.env.touch())) {
            if (canScroll($(elm), dir)) {
                $(elm).carousel(dir);
                scrollAction($(elm), dir);
            }

            //NZ: NGBS3-5177: Triggering a body click on swipe to close open tooltips.
            $('body').trigger('click');
        }
    }

    function updatePaginationLabel($carousel, $slide, initialize) {
        var pageInfo = $carousel.find('.pagination-info');
        var pageInfoTemplate = pageInfo.data('label-template');
        if(pageInfoTemplate) {
            if (initialize && ($slide == null || typeof($slide) == 'undefined')) {
                $slide = $carousel.find('.tcb-carousel-item.item').first();
            }
            pageInfo.text(pageInfoTemplate.replace('{current}', ($slide.data('slide-id') + 1)).replace('{total}', $carousel.data('total-slides')));
            if (initialize) {
                pageInfo.attr('aria-hidden', 'false');
            }
        }
    }

    function canScroll($carousel, dir) {
        var canScroll = true,
            $activeSlide = $carousel.find('.tcb-carousel-item.item.active'),
            activeIndex = (parseInt($activeSlide.data('slide-id'), 10) + 1),
            totalSlides = parseInt($carousel.data('total-slides'), 10);
        switch(dir) {
            case 'next':
                if (activeIndex === totalSlides) {
                    canScroll = false;
                }
                break;
            case 'prev':
                if (activeIndex === 1) {
                    canScroll = false;
                }
                break;
        }
        return canScroll;
    }

    function updateInactiveArrows($carousel, $slide) {
        if (!$carousel || !$slide) {
            return;
        }
        var activeIndex = (parseInt($slide.data('slide-id'), 10) + 1),
            totalSlides = parseInt($carousel.data('total-slides'), 10),
            $nextArrow = $carousel.find('.carousel-arrows .carousel-next'),
            $prevArrow = $carousel.find('.carousel-arrows .carousel-previous');

        $nextArrow.toggleClass('inactive', (activeIndex === totalSlides));
        $prevArrow.toggleClass('inactive', (activeIndex === 1));
    }


    //Common Metrics
    function scrollAction($carousel, dir) {
        var mtxData = {
            '$$carouselScrollDirection': (dir == 'prev') ? 'left' : 'right'
        };
        brand.Metrics.handler.direct($carousel.attr('data-fd-metrics-scroll'), mtxData);
    }

})(jQuery, FD.Brand.lodash, FD.Brand, window);
;(function($, brand) {

    brand.setInitHandler('[data-fgx-model-billboard-slide]', init);

    /////////////

    function init(components) {
        brand.Dig.resolve($('.billboard-img', components));
        components.each(function() {
            brand.Pricing.refresh(this);
        });
    }

})(jQuery, FD.Brand);
;(function($, _, brand, user, ctx, util, inventory) {

    brand.setInitHandler('[data-fgx-billboard-homepage-slide]', init);

    /////////////

    function init(components) {
        var locationData = user && user.location.current(),
            INV_COUNT_PARAMS = {
                zipcode: locationData && locationData.postalCode,
                make: ctx && ctx.make,
                'return': 'countOnly'
            },
            invLinkFound = false;

        components.each(function() {
            brand.Pricing.refresh(this);
            handleInventoryCount(this);
        });
        
        brand.MediaOverlay.link(components);

        if(invLinkFound) {
            // Only subscribe to the user.location topic if an inventory link has been found.
            // On update we need to update the postalcode in our data, then make another call to local inventory counts.
            user.location.subscribe(function() {
                if(INV_COUNT_PARAMS) {
                    INV_COUNT_PARAMS.zipcode = user.location.current().postalCode;
                }
                components.each(function() {
                    handleInventoryCount(this);
                });
            }, true);
        }

        function handleInventoryCount(el) {
            var $el = $(el),
                $invCountLinks = $el.find('[data-fgx-has-inv-count-placeholder]');

            if($invCountLinks && $invCountLinks.length > 0) {
                var invCountParamStr = $el.data('fgxInvCountParams'),
                    invCountParams = (invCountParamStr && typeof(invCountParamStr) != 'undefined') ? util.str.toObject(invCountParamStr, '|') : null;

                if(invCountParams) {
                    invLinkFound = true;
                    var invCountData = _.extend({}, invCountParams, INV_COUNT_PARAMS);

                    getInventoryCount(invCountData).done(function(resp) {
                        handleGetInventoryCountSuccess(resp, $invCountLinks, invCountData, $el);
                    }).fail(function(resp) {
                        hideInventoryCountLinks($invCountLinks, $el);
                    });
                }
            }
        }

        function getInventoryCount(params) {
            var def = $.Deferred();
            inventory.dealerLot(params).done(function(resp) {
                if(resp) {
                    def.resolve(resp);
                } else {
                    def.reject(resp);
                }
            }).fail(function(resp) {
                def.reject(resp);
            });
            return def.promise();
        }

        function handleGetInventoryCountSuccess(resp, $links, data, $slide) {
            if(!$links || $links.length == 0) {
                return;
            }

            if(resp && resp.data) {
                var exactCount = resp.data && resp.data.exactMatchesCount;
                if(exactCount > 0) {
                    var linkContextData = {};

                    if(exactCount > 100) {
                        exactCount = '100+';
                    }

                    if(data) {
                        if(data.selectTrim) {
                            linkContextData.trim = data.selectTrim;
                            linkContextData.trimId = data.selectTrim;
                        }

                        var radius = (data.Radius) ? data.Radius : ((data.radius) ? data.radius : null);
                        if(radius) {
                            linkContextData.radius = radius;
                        }
                    }

                    if($slide && $slide.length > 0) {
                        $slide.toggleClass('btm-spacer-m', true);
                    }

                    $links.each(function() {
                        var $elm = $(this),
                            $templateEl = $elm.find('[data-fgx-cta-text-template]'),
                            template = $templateEl.data('fgxCtaTextTemplate') || '',
                            text = template.replace('{invCount}', exactCount),
                            currLinkContext = $elm.attr('data-link-context'),
                            linkContext = (currLinkContext && typeof(currLinkContext) != 'undefined') ? $.parseJSON(currLinkContext) : {};

                        if(!_.isEmpty(linkContextData)) {
                            var linkData = _.extend({}, linkContext, linkContextData);
                            $elm.attr('data-link-context', JSON.stringify(linkData));
                        }

                        $templateEl.html(text);
                        $elm.removeClass('hidden');
                    });
                } else {
                    hideInventoryCountLinks($invCountLinks, $slide);
                }
            }
        }

        function hideInventoryCountLinks($links, $slide) {
            if(!$links || $links.length == 0) {
                return;
            }

            $links.each(function() {
                $(this).addClass('hidden');
            });

            if($slide && $slide.length > 0) {
                $slide.toggleClass('btm-spacer-m', false);
            }
        }
    }

})(jQuery, FD.Brand.lodash, FD.Brand, FD.Brand.User, FD.Brand.Context, FD.Brand.Util, FD.Brand.Inventory);

;(function($, _, brand, win, pos) {

    brand.setInitHandler('[data-fgx-billboard-container]', init);

    /////////////

    function init(components) {
        var _inlineVideosOnPage = false;
        var _currMediaKey = '';
        var mql = window.matchMedia('(min-width: 992px)'); //NGBS3-4480: was 768px before.
        var tabMql = window.matchMedia('(min-width: 768px) and (max-width: 991px)');
        tabMql.addListener(handleResize);
        handleResize(tabMql);
        var mqlPhone = window.matchMedia('(max-width: 767px)');
        mqlPhone.addListener(handlePositionedResize);

        var positionedBB = {},
            POSITIONED_BB_BASE_CLASS = "fgx-positioned-bb-",
            POSITIONED_SLIDE_BASE_CLASS = "fgx-positioned-slide-";

        var _bcpIndex = 0;
        var BCP_BASE_ID = "fgx-bc-player-container-bb-";
        var _bcpInstances = {};

        components.each(function(count) {

            var billboardCount = $(this).find('.billboard-slide.item').length,
                _this = $(this);

            if(billboardCount > 1) {
                var index = 0,
                    last = billboardCount - 1,
                    containsVideo = false,
                    meatballPrefix = _this.data('meatballPrefix'),
                    hasIndicatorOverride = false;
                //Add a next-slide and prev-slide attribute to each slide
                $(this).find('.billboard-slide.item').each(function() {
                    var $slide = $(this);
                    switch(index) {
                        case 0:
                            $slide.attr({
                                'data-next-slide': index + 1,
                                'data-slide-id': index,
                                'data-prev-slide': billboardCount - 1,
                                'data-total-slides': billboardCount
                            });

                            if($slide.hasClass('m-cta-below-image')) {
                                _this.addClass('contains-cta-below-image');
                            }
                            break;
                        case last:
                            $slide.attr({
                                'data-next-slide': 0,
                                'data-slide-id': index,
                                'data-prev-slide': index - 1,
                                'data-total-slides': billboardCount
                            });
                            break;
                        default:
                            $slide.attr({
                                'data-next-slide': index + 1,
                                'data-slide-id': index,
                                'data-prev-slide': index - 1,
                                'data-total-slides': billboardCount
                            });
                            break;
                    }

                    if($slide.hasClass('fgx-brand-video')) {
                        containsVideo = true;
                        _inlineVideosOnPage = true;

                        if ($slide.hasClass('inline-video-bc')) {
                            setupInlineVideo($slide);
                        }
                    }
                    if ($slide.is('[data-fd-indicator-style-override]')) {
                        hasIndicatorOverride = true;

                        if (index === 0) {
                            // Update the indicator styling if the first slide has an override set
                            updateIndicatorStyling(_this, $slide);
                        }
                    }
                    index++;
                });

                var $arrows = $(this).find('.carousel-arrows');
                $arrows.addClass('shown');

                //Add the indicators
                var $el = $(this).find('ol.carousel-indicators');
                $el.empty();
                for(var i = 0; i < billboardCount; i++) {
                    var cls = (i === 0) ? 'active' : '';
                    var slideNum = i + 1;
                    var label = meatballPrefix + ' ' + slideNum;
                    $el.append('<li data-slide-to="' + i + '" class="' + cls + '"><span class="fgx-brand-sr-text" aria-label="' + label + '" tabindex="0" role="button" data-fgx-keypress="true"></span></li>');
                }
                $el.addClass('shown');
                _this.addClass('bb-has-indicators');
                FD.Brand.Util.carousel.swipe(this, swipe);
                if(containsVideo) {
                    $(this).on('slide.bs.carousel', function(ev) {
                        var activeEl = $(this).find('.billboard-slide.item.active');
                        if(activeEl.hasClass('fgx-brand-video')) {
                            if (activeEl.hasClass('inline-video-bc')) {
                                var videoInst = getBcpInstanceFromComponent(activeEl);
                                if (videoInst) {
                                    videoInst.pause(true);
                                }
                            }
                        }
                    });
                }

                $(this).on('slid.bs.carousel', function(ev) {
                    preloadImage(_this);
                    var $slide = $(ev.relatedTarget);
                    var hasInlineBcVideo = false;
                    var hideInlineBcVideoOnMbl = false;
                    if($slide.hasClass('fgx-brand-video')) {
                        if ($slide.hasClass('inline-video-bc')) {
                            var videoInst = getBcpInstanceFromComponent($slide);
                            if (videoInst) {
                                videoInst.loadInitialStateForBP();
                            }
                            hasInlineBcVideo = true;
                            hideInlineBcVideoOnMbl = $slide.hasClass('hide-video-on-mobile');
                        }
                    }
                    _this.toggleClass('contains-inline-video-bc', hasInlineBcVideo && !hideInlineBcVideoOnMbl);
                    _this.toggleClass('contains-inline-video-bc-dsk', hasInlineBcVideo && hideInlineBcVideoOnMbl);
                    _this.toggleClass('contains-cta-below-image', $(ev.relatedTarget).hasClass('m-cta-below-image'));

                    if (hasIndicatorOverride) {
                        updateIndicatorStyling(_this, $slide);
                    }
                    _this.data('isSliding', false);
                });

                if(_this.hasClass('autoplay')) {
                    updateAutoPlayState(_this);
                }

                updatePaginationLabel(_this, null, true);
            }

            //Add the 'active' class to the first slide
            var $firstSlide = $(this).find('.billboard-slide.item').first();
            $firstSlide.addClass('active');
            $(this).find('.placeholder_img').first().hide();

            //Disable autoscrolling if not enabled by author
            if(!$(this).hasClass('autoplay')) {
                $(this).carousel({interval: false});
            } else {
                var globalArrowsLen = $(this).find('.carousel-arrows.global-arrows').length;

                if(billboardCount > 1 && globalArrowsLen > 0) {
                    $(this).carousel();
                } else {
                    $(this).carousel({interval: false});
                }
            }
            brand.Pricing.refresh(this);

            if($firstSlide.hasClass('fgx-brand-video')) {
                _inlineVideosOnPage = true;

                if ($firstSlide.hasClass('inline-video-bc')) {
                    if (billboardCount <= 1) {
                        // NZ - Setup the videoWrapper here if it hasn't been setup before.
                        setupInlineVideo($firstSlide);
                    } else {
                        //Set the proper inline-bc-video class on the container for the first slide.
                        _this.addClass(($firstSlide.hasClass('hide-video-on-mobile')) ? 'contains-inline-video-bc-dsk' : 'contains-inline-video-bc');
                    }

                    var videoInst = getBcpInstanceFromComponent($firstSlide);
                    if (videoInst) {
                        videoInst.loadInitialStateForBP();
                    }

                    if($firstSlide.hasClass('m-cta-below-image')) {
                        if($firstSlide.hasClass('hide-video-on-mobile') && mqlPhone.matches) {
                            hideLoaderForImage(_this, $firstSlide);
                        } else if (videoInst) {
                            if (videoInst.initialized) {
                                _this.find('.image-loader-svg').first().hide();
                            } else {
                                videoInst.subscribeTopic('loaded', function(data) {
                                    _this.find('.image-loader-svg').first().hide();
                                }, true);
                            }
                        }
                    }
                }
            } else {
                if($firstSlide.hasClass('m-cta-below-image')) {
                    hideLoaderForImage(_this, $firstSlide);
                }
            }

            var $staticSlides = $(this).find('.billboard-slide.static');
            if($staticSlides.length >= 1) {
                var offset = 0;
                $staticSlides.each(function() {
                    var slideId = billboardCount + offset;
                    $(this).attr({
                        'data-slide-id': slideId
                    });
                    offset++;

                    var $moreToggle = $(this).find('.moreDesc');
                    var $lessToggle = $(this).find('.lessDesc');
                    var $desc = $(this).find('.description-more');
                    $moreToggle.click(function() {
                        $desc.toggle();
                        $(this).hide();
                        $lessToggle.focus();
                    });
                    $lessToggle.click(function() {
                        $desc.toggle();
                        $moreToggle.show();
                        $moreToggle.focus();
                    });
                });

                $(this).addClass('fgx-brand-contains-static-slide');
            }

            var slides = {};
            slides = pos.items.setup(this, POSITIONED_SLIDE_BASE_CLASS, ".billboard-slide");

            if(!$.isEmptyObject(slides)) {
                var billboardClass = POSITIONED_BB_BASE_CLASS + count;
                $(this).addClass(billboardClass);
                positionedBB[billboardClass] = slides;
            }

        });

        // Setup a hover state for any 'btn-primary' and 'btn-secondary' buttons
        var $cta = $('.billboard-cta > a.btn-primary', components);
        brand.Util.ctaHover($cta);
        // hover state for secondary CTA's, part of Ford CTA globalization
        if ( $('html').hasClass('fgx-brand-Ford') ) {
            var $ctaS = $('.billboard-cta > a.btn-secondary', components);
            brand.Util.ctaHover($ctaS);
        }

        function handleResize(mql) {
            if(mql.matches) {
                _currMediaKey = 'tablet';
            } else {
                var bp = brand.Util.currentBreakpoint();
                _currMediaKey = (bp === 'gux-bkpt-sm') ? 'mobile' : 'desktop';
            }
            updateInlineVideoDisplay(_currMediaKey, false);
        }

        function hideLoaderForImage($container, $slide) {
            var $img = $slide.find('.billboard-img img');

            if(!($img.hasClass('lazyloaded') || $img.hasClass('lazyloading'))) {
                $img.one('load', function() {
                    $container.find('.image-loader-svg').first().hide();
                });
            } else {
                $container.find('.image-loader-svg').first().hide();
            }
        }

        function updateInlineVideoDisplay(mediaKey, fromScroll) {
            if(!_inlineVideosOnPage) {
                return;
            }

            // Implementation for new BCP inline videos.
            _.each(_bcpInstances, function(inst) {
                if (mediaKey === 'mobile') {
                    if (inst.shownOnMobile()) {
                        updateVideoForBP(inst);
                    } else if (!fromScroll) {
                        if (inst.initialized) {
                            inst.pause();
                        }
                    }
                } else {
                    updateVideoForBP(inst);
                }
            });
        }

        function updateVideoForBP(_inst) {
            if (_inst) {
                _inst.loadInViewport().done(function(inst) {
                    if (inst && inst.initialized) {
                        if (inst.autoplayEnabledOnBP() && inst.isVisible() && !inst.isManuallyPaused()) {
                            if(inst.slideItem.hasClass('active')) {
                                inst.play(true);
                            }
                        }
                    }
                });
            }
        }

        function getBcpInstanceFromComponent($slide) {
            if (!$slide || $slide.length === 0) {
                return null;
            }

            var instanceId = $slide.find('.inline-video-container').attr('id'),
                videoInst = _bcpInstances[instanceId] || null;
            return videoInst;
        }

        function handlePositionedResize(mqlPhone) {
            if(mqlPhone.matches) {
                pos.items.update('mobile', positionedBB);
            } else {
                pos.items.update('desktop', positionedBB);
            }
        }

        //Callback function of the hammer swipe listeners.
        //pass in the element, direction
        function swipe(elm, dir, ev) {
            // only perform the swipe if the screen is smaller than 768px wide OR if the device is touch capable.
            if(!mql.matches || (brand.Util.env.touch())) {
                var slide = $(elm).find(".billboard-slide.item.active"),
                    direction = dir + 'Slide',
                    nextId = slide.data(direction);

                //NZ: NGBS3-5177: Triggering a body click on swipe to close open tooltips.
                $('body').trigger('click');

                startSlide(elm, dir, nextId);
                //$(elm).carousel(nextId);

                $(elm).find('.image-loader-svg').first().hide();
            }
        }

        function preloadImage(elm) {
            if(!elm || !elm.length) {
                return;
            }

            var billboardCount = elm.find('.billboard-slide.item').length;

            if(billboardCount <= 1) {
                return;
            }

            var currSlide = elm.find('.billboard-slide.item.active'),
                nextId = currSlide.data('nextSlide'),
                nextSlide = elm.find('*[data-slide-id="'+ nextId +'"]');

            if(nextSlide.length) {
                var nsImage = nextSlide.find('.billboard-img img');
                if(!nsImage.hasClass('lazypreload') && !nsImage.hasClass('lazyloaded') && !nsImage.hasClass('lazyloading')) {
                    nsImage.addClass('lazypreload');
                }
            }
        }

        function startSlide(elm, dir, nextId) {
            try {
                var isSliding = $(elm).data('isSliding');
                if(!isSliding || isSliding === 'false') {
                    $(elm).data('isSliding', true);
                    var nextSlide = $(elm).find('.billboard-slide.item[data-slide-id="'+nextId+'"]');
                    $(elm).data('bs.carousel').slide(dir, nextSlide);
                    // update aria pagination info alert
                    updatePaginationLabel($(elm), nextSlide);
                }
            } catch(e) {
                //If there is a problem calling the slide function directly then just use the id to be safe.
                $(elm).carousel(nextId);
            }

            //Common Metrics
            scrollAction.call(elm);
        }


        function updatePaginationLabel($carousel, $slide, initialize) {
            var pageInfo = $carousel.find('.pagination-info');
            var pageInfoTemplate = pageInfo.data('label-template');
            if(pageInfoTemplate) {
                if (initialize && ($slide == null || typeof($slide) == 'undefined')) {
                    $slide = $carousel.find('.billboard-slide.item').first();
                }
                pageInfo.text(pageInfoTemplate.replace('{current}', ($slide.data('slide-id') + 1)).replace('{total}', $slide.data('total-slides')));
                if (initialize) {
                    pageInfo.attr('aria-hidden', 'false');
                }
            }
        }

        function updateAutoPlayState($el) {
            if(!$el || $el.length === 0) {
                return;
            }
            if(!brand.Util.inViewport($el)) {
                if(!$el.hasClass('fgx-is-paused')) {
                    $el.carousel('pause');
                    $el.addClass('fgx-is-paused');
                }
            } else {
                if($el.hasClass('fgx-is-paused')) {
                    $el.carousel('cycle');
                    $el.removeClass('fgx-is-paused');
                }
            }
        }

        function setupInlineVideo($el) {
            if (!$el || $el.length === 0) {
                return;
            }
            var inlineId = BCP_BASE_ID + ++_bcpIndex,
                $vidContainer = $el.find('.inline-video-container'),
                data = {
                    id: inlineId,
                    fgxInstanceId: inlineId,
                    slideItem: $el,
                    videoContainer: $vidContainer,
                    type: 'brightcove',
                    displayType: 'inline',
                    settings: {
                        muted: true,
                        loop: !!($vidContainer.is('[data-fgx-loop]')),
                        playsinline: true
                    },
                    bcpConfig: {
                        playIndex: 0,
                        videos: [{'videoId': $vidContainer.attr('data-fgx-video-id') || ''}]
                    },
                    brandConfig: {
                        index: 0,
                        count: 1
                    }
                };
            $vidContainer.attr('id', inlineId);

            var videoInstance = brand.Video.videoItem.create(data);

            _bcpInstances[inlineId] = videoInstance;

            // apply the fgx-allow-pointer-ev class to global disclosure links so they can be clicked if authored.
            $el.find('.billboard-content sup[data-vdm-disc]').each(function() {
                $(this).addClass('fgx-allow-pointer-ev');
            });
            $el.find('.billboard-content a[href^=\'#disc\']').each(function() {
                $(this).addClass('fgx-allow-pointer-ev');
            });
        }

        function updateIndicatorStyling($carousel, $slide) {
            var newIndicatorStyle = ($slide.is('[data-fd-indicator-style-override]')) ? $slide.attr('data-fd-indicator-style-override') : $carousel.attr('data-fd-indicator-style-default');
            var currIndicatorStyle = $carousel.attr('data-fd-indicator-style-current') || '';
            if (newIndicatorStyle && newIndicatorStyle !== currIndicatorStyle) {
                $carousel.toggleClass(currIndicatorStyle, false).toggleClass(newIndicatorStyle, true);
                $carousel.attr('data-fd-indicator-style-current', newIndicatorStyle);
            }
        }


        $('.carousel-arrows.global-arrows .carousel-next, .carousel-arrows.global-arrows .carousel-previous', components).click(function() {
            var billboardCarousel = $(this).parent().parent('.billboard-container'),
                slide = billboardCarousel.find(".billboard-slide.item.active"),
                dir = ($(this).hasClass('carousel-previous')) ? 'prev' : 'next',
                nextId = slide.data(dir+"Slide");

            $(billboardCarousel).find('.image-loader-svg').first().hide();
            startSlide(billboardCarousel, dir, nextId);
            //billboardCarousel.carousel(nextId);
            //billboardCarousel.carousel(dir);
        });

        //Slide the carousel when the indicators are clicked
        $('.carousel-indicators.global-indicators li', components).click(function() {
            var nextId = $(this).data("slideTo");
            var billboardCarousel = $(this).parent().parent('.billboard-container');
            var nextSlide = billboardCarousel.find('.billboard-slide.item[data-slide-id="'+nextId+'"]');
            billboardCarousel.find('.image-loader-svg').first().hide();

            var focusNextSlide = function () {
                nextSlide.focus();
            }
            // Set a listener for the slid.bs.carousel event so we can be sure the nextSlide is visible before focusing it.
            billboardCarousel.off('slid.bs.carousel', focusNextSlide).one('slid.bs.carousel', focusNextSlide);

            billboardCarousel.carousel(nextId);
            // update aria pagination info alert
            updatePaginationLabel(billboardCarousel, nextSlide);

            //Metrics - POC
            scrollAction.call(this);
        });

        $('.carousel-indicators.global-indicators li > span', components)
            .on('focusin', function() {
                $(this).closest('li').addClass('fgx-focused');
            }).on('focusout', function() {
                $(this).closest('li').removeClass('fgx-focused');
            });


        //Hover the cta when the mouse enters the full link element.
        $('.billboard-content .full-slide-link', components).hover(function() {
            $(this).closest('.content-wrapper').addClass('hover');
            $(this).closest('.content-wrapper').find('a.btn-primary').each(function() {
                //dont want to block swapColors if .default-hover detected on Lincoln, so separate cases
                if ( !$('html').hasClass('fgx-brand-Lincoln') && !$(this).hasClass('default-hover') ) {
                    brand.Util.swapColors.call(this);
                }
            });
        },function() {
            $(this).closest('.content-wrapper').removeClass('hover');
            $(this).closest('.content-wrapper').find('a.btn-primary').each(function() {
                //dont want to block swapColors if .default-hover detected on Lincoln, so separate cases
                if ( !$('html').hasClass('fgx-brand-Lincoln') && !$(this).hasClass('default-hover') ) {
                    brand.Util.swapColors.call(this);
                }
            });
        });

        function _onScroll() {
            if(_inlineVideosOnPage) {
                if(_currMediaKey === '') {
                    var bp = brand.Util.currentBreakpoint();
                    _currMediaKey = (bp === 'gux-bkpt-sm') ? 'mobile' : ((bp === 'gux-bkpt-med') ? 'tablet' : 'desktop');
                }
                updateInlineVideoDisplay(_currMediaKey, true);
            }

            components.each(function() {
                var _this = $(this),
                    billboardCount = _this.find('.billboard-slide.item').length;

                //preloadImage(_this);
                if(!_this.hasClass('autoplay') || billboardCount <= 1) {
                    return;
                }

                updateAutoPlayState(_this);
            });
        }

        // Deeplink Functionality for initial page load.
        var anchorId = window.location.hash;
        if (anchorId) {
            // process hash
            try {
                var selector = '[data-link-key=\'' + anchorId.substr(1) + '\']';
                var anchorSlide = $(selector, components);
                if (anchorSlide.length) {
                    var index = anchorSlide.attr('data-slide-id');
                    var meatballSelector = '.carousel-indicators li[data-slide-to=' + index + ']';
                    var meatball = $(meatballSelector, components);
                    meatball.trigger('click');
                }
            } catch(e) {}
        }

        $(win).scroll(_.debounce(_onScroll, 100));
        //_onScroll();

        //Metrics - POC
        function scrollAction() {
            brand.Metrics.handler.direct($(this).closest('[data-fgx-billboard-container]').attr('data-fd-metrics-scroll'));
        }
    }
})(jQuery, FD.Brand.lodash, FD.Brand, window, FD.Brand.Position);


;(function($, brand, disclosures) {

    brand.setInitHandler('[data-fgx-vehicle-attributes]', init);

    /////////////

    function init(components) {

        components.each(function() {
            var _this = this;

            var disclosureStyle = $(_this).data('disclosure-color');
            var disclosureColor = null;
            if (disclosureStyle !== '' && disclosureStyle !== undefined) {
                disclosureColor = disclosureStyle.split(':')[1].replace(';', '');
                setDisclosureColor($(_this), disclosureColor);
            }

            // populate pricing on initial location resolution and also if it changes.
            brand.User.location.subscribe(function() {
                FD.Brand.Pricing.refresh(_this, true).done(function(templates) {
                    var $monthlyPriceEl = $(_this).find('.price.monthly-price'),
                        $monthlyPriceLabel = $monthlyPriceEl.find('.monthly-price-label'),
                        $monthlyPriceValue = $monthlyPriceEl.find('.price-value'),
                        priceDetail = $monthlyPriceValue.data('pricing');

                    // MG: NGBS3-5007 - changed to always show i-ball and always point to SPC
                    // if(priceDetail && priceDetail.offerType && (priceDetail.offerType === 'lease' || priceDetail.offerType === 'finance')) {
                    //     var offerLink = (priceDetail.offerType === 'lease') ? "#$incentives" : "#$spc";
                    //     $monthlyPriceLabel.siblings("a.icon-info").attr("href", offerLink).removeClass("hidden");
                    //     $monthlyPriceEl.removeClass("hidden");
                    // }
                    if(priceDetail && priceDetail.offerType) {
                        //NZ: NGBS3-5229 - reinstated check of offerType before displaying the 'i'-ball so its only displayed when monthly price is displayed.
                        if(priceDetail.offerType === 'lease' || priceDetail.offerType === 'finance') {
                            $monthlyPriceEl.find('.icon-info').attr('href', '#$spc').removeClass('hidden');
                            $monthlyPriceEl.find('.icon-info').removeAttr('aria-hidden');
                            // Ensure the monthlyPrice disclosure color is updated properly
                            setDisclosureColor($monthlyPriceEl, disclosureColor);
                            // Make the monthlyPrice disclosure accessible
                            disclosures.updateDisclosures($monthlyPriceEl);
    					}
                        $monthlyPriceEl.removeClass('hidden');
    				}
                });
            });
        });

        function setDisclosureColor($container, color) {
            if (!$container || $container.length === 0 || !color) {
                return;
            }
            $('sup', $container).each(function(){
                $(this).css('color', color);
            });
        }

    }
})(jQuery, FD.Brand, FD.Brand.Disclosures);

/*
$(function () {




  var adjustSectionHeights_d = _.debounce(adjustSectionHeights, 50)
  function adjustSectionHeights() {
    var maxHeight = Math.max.apply(null, $(".vehicle-attributes .section").map(function () {
      return $(this).height();
    }).get());

    if ($(window).width() >= 1200) {
      $(".vehicle-attributes .section").height(maxHeight);
    } else {
      $(".vehicle-attributes .section").css("height", "");
    }
  }



  var ngpIncentivesService = (function () {
    var serviceInterface = {
      specialOffers: specialOffers
    };
    return serviceInterface;

    function specialOffers(make, nameplate, year, postalCode, geoKey, planType) {
      // QA doesn't appear to have any lease campaigns, so use production for testing
      var serviceUrl = "//" + common.ngpServiceBaseUrl() + "/incentives/SpecialOffers.json";
      serviceUrl += "?" + "appContext=ngbs_sploffr" + "&make=" + make + "&model=" + nameplate + "&year=" + year;
      if (planType) {
        serviceUrl += "&planType=" + planType;
      }
      if (geoKey) {
        serviceUrl += "&geoKey=" + geoKey;
      } else if (postalCode) {
        serviceUrl += "&postalCode=" + postalCode;
      }

      var deferred = $.Deferred();
      $.getJSON(serviceUrl, {format: "json"}).then(function (data, status, jqXHR) {
        deferred.resolve(data, status, jqXHR);
      });

      return deferred.promise();
    }
  })();


        adjustSectionHeights();

        $(window).resize(adjustSectionHeights_d);

        // US only (do not check for lease campaigns if we are in a canadian locale)
        // if we are nameplate aligned call incentives service to search for lease campaign (NOTE: if we aruwe don't need to make this call; don't check for lease if trim aligned)
        if (common.getLocale() === common.LOCALE_EN_US) {
          if (common.trim() === undefined){
            checkForSpecialOffers(_finalprice.data.ConfigToken);
          } else {
            //bypass special offers
            $(".vehicle-attributes").addClass("ngp-offers-loaded");
            checkforCalculator(_finalprice.data.ConfigToken);
          }
        } else {
          //bypass special offers
          $(".vehicle-attributes").addClass("ngp-offers-loaded");
          checkforCalculator(_finalprice.data.ConfigToken);
        }

      });

  // US only (do not check for lease campaigns if we are in a canadian locale)
  // if we are nameplate aligned call incentives service to search for lease campaign (NOTE: if we aruwe don't need to make this call; don't check for lease if trim aligned)
    // if there is a lease campaign, use that pricing info instead of special payment calculator info.
      // to find lease campaigns
        // check "Response > Nameplate > Groups, etc.." for lease campaigns, if none,
        // check "Response > Nameplate > Trims, etc.." for lease campaigns; match against the trim that was selected for the Starting at Price. The "Trim" element in the response has a name field
          // you can use to match against the  trim name
          // find all the campaigns with "CampaignType" of "Extract Lease - NO 800#", of these, select the campaign with the lowest
          // "SequenceNumber"
    // todo: replace function parameters with appropriate dynamic values

    function checkForSpecialOffers(configToken){

      ngpIncentivesService.specialOffers(common.make(), common.nameplate(), common.year(), common.zip(), null, userPricingPlanUtility.getPlanType())
        .done(function (data, status, jqXHR) {
          // console.log("Lease Campaign")
          // todo: follow the rules outlined above in the comments

          // todo: this should be the trim name selected during Starting at price calculation
          var campaign;

          if (data) {
            // todo: follow the above comments to select the appropriate lease campaign
            if (data.Response.Nameplate.Groups !== ""){
              //Groups
              var _filteredGroup = _.filter(data.Response.Nameplate.Groups.Group, function(o){
                if (o.Campaign){
                  return (o.Campaign.CampaignType === "Extract Lease - NO 800#");
                }
                return false;
              });

              campaign = _.reduce(_filteredGroup, function(low, n) {
                if (n.SequenceNumber < low.SequenceNumber || low.data === null){
                  return {
                    "payment": n.Campaign.Payment,
                    "term": n.Campaign.Term,
                    "downPayment": n.Campaign.CashDueAtSigning,
                    "SequenceNumber": n.Campaign.SequenceNumber,
                    "data": n
                  };
                }
                return low;

              }, {"payment": "$0", "term": "0", "downPayment": "0", "SequenceNumber": "0", data: null});

            } else if (data.Response.Nameplate.Trims !== "") {
              //Trims

              campaign = _.reduce(data.Response.Nameplate.Trims.Trim, function(low, n) {
                var _filteredGroup = _.filter(n.Groups.Group,  function(o){
                    if (o.Campaign){
                      return (o.Campaign.CampaignType === "Extract Lease - NO 800#");
                    }
                    return false;
                  }),
                  newlow = _.reduce(_filteredGroup, function(low, n) {
                    if (n.SequenceNumber < low.SequenceNumber || low.data === null){
                      if (n.Campaign){
                        return {
                          "payment": n.Campaign.Payment,
                          "term": n.Campaign.Term,
                          "downPayment": n.Campaign.CashDueAtSigning,
                          "SequenceNumber": n.Campaign.SequenceNumber,
                          "data": n.Campaign
                        };
                      }
                    }
                    return low;

                  }, low);


                if (_.size(_filteredGroup)){
                  if (newlow.SequenceNumber < low.SequenceNumber || low.data === null){
                    return newlow;
                  }
                  return low;
                }

                return low;


              }, {"payment": "$0", "term": "0", "downPayment": "0", "SequenceNumber": "0", data: null});
            }
          }

          $(".vehicle-attributes").addClass("ngp-offers-loaded");

          if (campaign.data){
            // if we are in the US and have a lease campaigns
            $(".vehicle-attributes .price-time-price").html(campaign.payment);
            $(".vehicle-attributes .price-time-apr").html(campaign.data.APRRate + "%");
            $(".vehicle-attributes .price-details-terms").html(campaign.term + " month lease");
            $(".vehicle-attributes .price-details-downpayment").html(campaign.downPayment);
            adjustSectionHeights();

            specialOffer = true;

            //   bypass calculator
            $(".vehicle-attributes").addClass("calc-loaded");
          } else {
            checkforCalculator(configToken);
          }
        });
    }
  updateVehicleAttributes();
});
*/




;(function($, brand, util) {

    brand.setInitHandler('[data-fgx-single-item-accordion]', init);

    /////////////

    function init(components) {

        if(components.length == 0) {
            return;
        }

        $('.accordion-heading', components).on('click', function() {
            util.accordion.update($(this), components, ".accordion-heading", ".accordion-content", false, trackAccordionToggleClick);
            $(this).focus();
        });
        
        /**
         * Will C. - Callback method which allows metrics events to be handled after the accordion sections have been handled.
         * Not having this logic in a callback was causing odd race conditions where metrics were only being fired in certain scenarios.
         **/
        function trackAccordionToggleClick() {
            var $el = $(this);
            if ($el.hasClass('open')) {
                //Common Metrics
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-open'),
                    $el
                );
            }
        }
    }
})(jQuery, FD.Brand, FD.Brand.Util);
;(function($, brand, media, util, discLib) {

    brand.setInitHandler('[data-fgx-features-specs-accordion]', init);

    /////////////

    function init(components) {
        
        var imageClickAction = components.attr('data-fd-metrics-image-click');
        var videoClickAction = components.attr('data-fd-metrics-video-click');
        var infoClickAction = components.attr('data-fd-metrics-info-click');

        $('.specs-accordion-toggle', components).on('click', function() {
            util.accordion.update(
            	$(this),
	            components,
	            '.specs-accordion-toggle',
	            '.specs-accordion-content',
	            false,
	            function() {
            		var $el = $(this);
		            // new metrics
		            if ($el.hasClass('open')) {
			            FD.Brand.Metrics.handler.direct(
				            $(this).attr('data-fd-metrics-open'), this
			            );
		            }
            });
            $(this).focus();
        });

        $('.spec-unit-toggle', components).on('click', function() {
            var $el = $(this);
            var $container = $el.closest('.specs-accordion-content');

            if($container.hasClass('metric-shown')) {
                $container.removeClass('metric-shown').addClass('imperial-shown');
            } else {
                $container.removeClass('imperial-shown').addClass('metric-shown');
            }
        });
        
        $('.fm-trigger.wrap-icon', components).each(function(){
            var type = $(this).attr('data-fd-metrics-item-type');
            if (type === 'image') {
                $(this).attr('data-fd-metrics-click', imageClickAction);
            } else if (type === 'video') {
                $(this).attr('data-fd-metrics-click', videoClickAction);
            } else if (type === 'info') {
                $(this).attr('data-fd-metrics-click', infoClickAction);
            }
        });

        media.link(components);

        // NZ - BRAND-15021 - Need to remove attributes of the data-vdm-disc elements that are added as part of the
        // accessibility label within the wrap-icon elements. Without this, the visually hidden versions of these
        // disclosures are still part of the tab order and can still be triggered.
        discLib.setInitListener('[data-fgx-features-specs-accordion]', function() {
            $('.fm-trigger.wrap-icon sup[data-vdm-disc]', components).each(function(){
                var $el = $(this);
                $el.attr('tabindex', '-1');
                $el.removeAttr('data-fgx-keypress');
                $el.removeAttr('role');
                var ariaLabel = $el.attr('aria-label') || '';
                if (ariaLabel) {
                    // NZ - move the aria-label to the text of the node because NVDA will no longer announce the
                    // aria-label of a span element (like the disclosures) once the button role has been removed.
                    $el.text(ariaLabel);
                }
            });
        });

    }
})(jQuery, FD.Brand, FD.Brand.MediaOverlay, FD.Brand.Util, FD.Brand.Disclosures);

;(function($, brand, util) {

    brand.setInitHandler('[data-fgx-content-accordion]', init);

    /////////////

    function init(components) {

        var activeAnchor = null;
        var initialized = false;
        var disableDeeplinks = false;
        
        if (components.length > 0) {
            $('.content-accordion-toggle', components).on('click', function() { handleAccordionToggleClick.call(this, disableDeeplinks); $(this).focus();});
            
            var $deeplinkDisableEl = $('.content-accordion-toggle', components).closest('[data-fgx-disable-child-deeplink]');
            if($deeplinkDisableEl && $deeplinkDisableEl.length > 0) {
                disableDeeplinks = true;
            }

            // monitor hash changes
            if(window.addEventListener) {
                window.addEventListener('hashchange', anchorCheck);
            } else {
                // IE8 fallback
                window.onhashchange = anchorCheck;
            }
            anchorCheck();
        }
        function anchorCheck() {
            if (!disableDeeplinks) {
                var anchorId = window.location.hash;
                if (anchorId) {
                    // process hash
                    if(activeAnchor === anchorId.substr(1)) {
                        return;
                    }
                    var toggle = $(anchorId).find(".content-accordion-toggle");
                    if (toggle && toggle.length > 0) {
                        handleAccordionToggleClick.call(toggle);
                        initialized = true;
                    }
                } else {
                    // init the first section to open
                    if (!initialized) {
                        handleAccordionToggleClick.call($('.content-accordion-toggle', components).first(), true);
                        initialized = true;
                    }
                }
            } else {
                // we've skipped our deeplink initialization, but still need to set the initialized flag to 'true' so our metrics fire properly.
                initialized = true;
            }
        }
        function manageSections($el, skipHashUpdate) {
            if (!initialized) {
                util.accordion.update($el, components, ".content-accordion-toggle", ".accordion-content", skipHashUpdate);
            } else {
                util.accordion.update($el, components, ".content-accordion-toggle", ".accordion-content", skipHashUpdate, trackAccordionToggleClick);
            }
            if (!initialized && !skipHashUpdate) {
                // this should only happen if we have an anchor on our first load.
                $el.focus();
            }
        }

        function handleAccordionToggleClick(skipHashUpdate) {
            var $el = $(this);
            var elId = $el.closest('section').attr('id');
            var anchorId = window.location.hash;
            var skipHashUpdate = (skipHashUpdate) ? true : false;

            if (anchorId.substr(1) !== elId && !skipHashUpdate) {
                window.location.hash = elId;
            } else {
                manageSections($el, skipHashUpdate);
            }
        }
        
        /**
         * Will C. - Callback method which allows metrics events to be handled after the accordion sections have been handled.
         * Not having this logic in a callback was causing odd race conditions where metrics were only being fired in certain scenarios.
         **/
        function trackAccordionToggleClick() {
            var $el = $(this);
            // new metrics
            if ($el.hasClass('open')) {
                FD.Brand.Metrics.handler.direct(
                    $(this).attr('data-fd-metrics-open'),
                    $el
                );
            }
        }
    }
})(jQuery, FD.Brand, FD.Brand.Util);

